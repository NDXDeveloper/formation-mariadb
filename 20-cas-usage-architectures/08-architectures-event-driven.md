ðŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 20.8 MariaDB dans les Architectures Event-Driven

> **Niveau** : AvancÃ©  
> **DurÃ©e estimÃ©e** : 4-5 heures  
> **PrÃ©requis** : Section 20.2 (Microservices), Chapitre 13 (RÃ©plication), notions de messaging (Kafka, RabbitMQ)

## ðŸŽ¯ Objectifs d'apprentissage

Ã€ l'issue de cette section, vous serez capable de :

- Comprendre les principes des architectures event-driven et leur intÃ©rÃªt
- IntÃ©grer MariaDB comme source d'Ã©vÃ©nements via Change Data Capture (CDC)
- Configurer Debezium pour capturer les changements en temps rÃ©el
- Concevoir des pipelines de donnÃ©es Ã©vÃ©nementielles avec Kafka
- ImplÃ©menter les patterns Outbox, Event Sourcing et CQRS avec MariaDB
- Construire des systÃ¨mes rÃ©actifs et dÃ©couplÃ©s Ã  grande Ã©chelle

---

## Introduction

Les **architectures Event-Driven** (EDA) reprÃ©sentent un paradigme oÃ¹ les systÃ¨mes communiquent via des Ã©vÃ©nements plutÃ´t que par des appels directs. Un Ã©vÃ©nement reprÃ©sente un fait qui s'est produit : "Commande crÃ©Ã©e", "Paiement validÃ©", "Stock mis Ã  jour".

MariaDB s'intÃ¨gre naturellement dans ces architectures grÃ¢ce Ã  son **binary log** qui capture tous les changements de donnÃ©es, permettant de transformer la base de donnÃ©es en une source d'Ã©vÃ©nements fiable via le **Change Data Capture (CDC)**.

### Pourquoi Event-Driven ?

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ARCHITECTURE TRADITIONNELLE VS EVENT-DRIVEN             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  ARCHITECTURE TRADITIONNELLE (Request/Response)                            â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                           â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    POST /order    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    HTTP    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  Client â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ Orders  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚Inventoryâ”‚          â”‚
â”‚  â”‚         â”‚                   â”‚ Service â”‚            â”‚ Service â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â”‚
â”‚                                     â”‚                      â”‚               â”‚
â”‚                                     â”‚ HTTP                 â”‚ HTTP          â”‚
â”‚                                     â–¼                      â–¼               â”‚
â”‚                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚                               â”‚ Payment â”‚            â”‚Shipping â”‚           â”‚
â”‚                               â”‚ Service â”‚            â”‚ Service â”‚           â”‚
â”‚                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                            â”‚
â”‚  ProblÃ¨mes :                                                               â”‚
â”‚  âŒ Couplage fort (A doit connaÃ®tre B)                                     â”‚
â”‚  âŒ Cascade de pannes (si B down, A Ã©choue)                                â”‚
â”‚  âŒ Latence cumulÃ©e (A attend B qui attend C)                              â”‚
â”‚  âŒ Difficile Ã  scaler indÃ©pendamment                                      â”‚
â”‚                                                                            â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                            â”‚
â”‚  ARCHITECTURE EVENT-DRIVEN                                                 â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                                 â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    POST /order    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚  â”‚  Client â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚ Orders  â”‚                                 â”‚
â”‚  â”‚         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ Service â”‚                                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    202 Accepted   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                     â”‚                                      â”‚
â”‚                                     â”‚ Publish "OrderCreated"               â”‚
â”‚                                     â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         EVENT BUS (Kafka)                           â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚   Topic: orders.created                                             â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚   â”‚ Event: {order_id: 123, customer: "Alice", items: [...]}      â”‚  â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                    â”‚                    â”‚                        â”‚
â”‚         â”‚ Subscribe          â”‚ Subscribe          â”‚ Subscribe              â”‚
â”‚         â–¼                    â–¼                    â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  Inventory  â”‚      â”‚   Payment   â”‚      â”‚  Shipping   â”‚                 â”‚
â”‚  â”‚   Service   â”‚      â”‚   Service   â”‚      â”‚   Service   â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                            â”‚
â”‚  Avantages :                                                               â”‚
â”‚  âœ… DÃ©couplage (producteur ignore les consommateurs)                       â”‚
â”‚  âœ… RÃ©silience (consommateurs indÃ©pendants)                                â”‚
â”‚  âœ… ScalabilitÃ© (ajout de consommateurs sans impact)                       â”‚
â”‚  âœ… Audit trail (Ã©vÃ©nements persistÃ©s)                                     â”‚
â”‚  âœ… Replay possible (rejouer l'historique)                                 â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Le rÃ´le de MariaDB dans l'Event-Driven

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MARIADB COMME SOURCE D'Ã‰VÃ‰NEMENTS                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  MariaDB possÃ¨de nativement un mÃ©canisme de capture des changements :      â”‚
â”‚  le BINARY LOG (binlog)                                                    â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         MariaDB Server                              â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  Application                                                        â”‚   â”‚
â”‚  â”‚      â”‚                                                              â”‚   â”‚
â”‚  â”‚      â”‚ INSERT INTO orders (customer, amount) VALUES ('Alice', 99.99)â”‚   â”‚
â”‚  â”‚      â–¼                                                              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚                      InnoDB Engine                            â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  1. Ã‰criture dans le redo log                                 â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  2. Ã‰criture dans le binlog                                   â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  3. Commit                                                    â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                â”‚                                    â”‚   â”‚
â”‚  â”‚                                â–¼                                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚                    Binary Log (mysql-bin.000001)              â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                               â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  Position 4:      Format Description Event                    â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  Position 123:    GTID Event (1-1-1)                          â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  Position 200:    Query Event (BEGIN)                         â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  Position 280:    Table Map Event (orders)                    â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  Position 350:    Write Rows Event                            â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                   â”œâ”€â”€ order_id: 1001                          â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                   â”œâ”€â”€ customer: "Alice"                       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                   â””â”€â”€ amount: 99.99                           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  Position 450:    XID Event (COMMIT)                          â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                               â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                â”‚                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                   â”‚                                        â”‚
â”‚                                   â”‚ CDC (Debezium, Maxwell, etc.)          â”‚
â”‚                                   â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         Kafka / Event Bus                           â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  Topic: dbserver.inventory.orders                                   â”‚   â”‚
â”‚  â”‚  {                                                                  â”‚   â”‚
â”‚  â”‚    "before": null,                                                  â”‚   â”‚
â”‚  â”‚    "after": {"order_id": 1001, "customer": "Alice", "amount": 99.99},   â”‚
â”‚  â”‚    "op": "c",                                                       â”‚   â”‚
â”‚  â”‚    "ts_ms": 1702648800000                                           â”‚   â”‚
â”‚  â”‚  }                                                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                            â”‚
â”‚  Le binlog transforme MariaDB en source d'Ã©vÃ©nements sans modification     â”‚
â”‚  du code applicatif !                                                      â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Patterns Event-Driven avec MariaDB

### Vue d'ensemble des patterns

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PATTERNS EVENT-DRIVEN AVEC MARIADB                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  1. CHANGE DATA CAPTURE (CDC)                                              â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                              â”‚
â”‚  Capture les changements du binlog et les publie comme Ã©vÃ©nements          â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    binlog     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    events   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ MariaDB â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚Debezium â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  Kafka  â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚                                                                            â”‚
â”‚  2. OUTBOX PATTERN                                                         â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                                         â”‚
â”‚  Garantit la cohÃ©rence entre la DB et les Ã©vÃ©nements publiÃ©s               â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Transaction atomique :                                             â”‚   â”‚
â”‚  â”‚  1. INSERT INTO orders ...                                          â”‚   â”‚
â”‚  â”‚  2. INSERT INTO outbox (event_type, payload) ...                    â”‚   â”‚
â”‚  â”‚  COMMIT                                                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                â”‚                                                           â”‚
â”‚                â”‚ CDC sur table outbox                                      â”‚
â”‚                â–¼                                                           â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚
â”‚          â”‚  Kafka  â”‚                                                       â”‚
â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                       â”‚
â”‚                                                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚                                                                            â”‚
â”‚  3. EVENT SOURCING                                                         â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                                         â”‚
â”‚  Stocke tous les Ã©vÃ©nements, l'Ã©tat est calculÃ© par replay                 â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  events table (append-only)                                         â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚ id â”‚ aggregate_id â”‚ event_type      â”‚ payload        â”‚ ts      â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ 1  â”‚ order-123    â”‚ OrderCreated    â”‚ {items:...}    â”‚ 10:00   â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ 2  â”‚ order-123    â”‚ PaymentReceived â”‚ {amount:99}    â”‚ 10:05   â”‚ â”‚   â”‚
â”‚  â”‚  â”‚ 3  â”‚ order-123    â”‚ OrderShipped    â”‚ {tracking:...} â”‚ 11:00   â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                            â”‚
â”‚  Ã‰tat actuel = replay(events.where(aggregate_id = 'order-123'))            â”‚
â”‚                                                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚
â”‚                                                                            â”‚
â”‚  4. CQRS (Command Query Responsibility Segregation)                        â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                        â”‚
â”‚  SÃ©pare les modÃ¨les d'Ã©criture et de lecture                               â”‚
â”‚                                                                            â”‚
â”‚       Commands                              Queries                        â”‚
â”‚          â”‚                                     â”‚                           â”‚
â”‚          â–¼                                     â–¼                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚Write Model  â”‚â”€â”€â”€â”€â”€ Events â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ Read Model  â”‚                     â”‚
â”‚  â”‚(Normalized) â”‚       (CDC)           â”‚(Denormalized)                     â”‚
â”‚  â”‚  InnoDB     â”‚                       â”‚ ColumnStore â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Architecture CDC avec Debezium

### Vue d'ensemble

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ARCHITECTURE CDC DEBEZIUM + MARIADB                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         Applications                                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚   â”‚
â”‚  â”‚  â”‚  Orders   â”‚  â”‚ Inventory â”‚  â”‚  Payments â”‚  â”‚ Shipping  â”‚         â”‚   â”‚
â”‚  â”‚  â”‚  Service  â”‚  â”‚  Service  â”‚  â”‚  Service  â”‚  â”‚  Service  â”‚         â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚   â”‚
â”‚  â”‚        â”‚                                                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                                                                â”‚
â”‚           â”‚ SQL (INSERT, UPDATE, DELETE)                                   â”‚
â”‚           â–¼                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         MariaDB Cluster                             â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚   â”‚
â”‚  â”‚  â”‚   Primary   â”‚  â”‚   Replica   â”‚  â”‚   Replica   â”‚                  â”‚   â”‚
â”‚  â”‚  â”‚   (RW)      â”‚â”€â”€â”‚    (RO)     â”‚â”€â”€â”‚    (RO)     â”‚                  â”‚   â”‚
â”‚  â”‚  â”‚             â”‚  â”‚             â”‚  â”‚  + Debezium â”‚â—„â”€â”€ CDC Source    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                  â”‚   â”‚
â”‚  â”‚                                           â”‚                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                              â”‚                             â”‚
â”‚                                              â”‚ Binlog streaming            â”‚
â”‚                                              â–¼                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      Kafka Connect Cluster                          â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚              Debezium MariaDB Connector                       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                               â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Se connecte comme un replica MariaDB                       â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Lit le binlog en temps rÃ©el                                â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Convertit les row events en JSON                           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Publie vers Kafka                                          â”‚  â”‚   â”‚
â”‚  â”‚  â”‚                                                               â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  Config:                                                      â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - database.hostname: mariadb-replica-cdc                     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - database.include.list: inventory                           â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - table.include.list: inventory.orders,inventory.products    â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                  â”‚                                         â”‚
â”‚                                  â”‚ Produce events                          â”‚
â”‚                                  â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         Apache Kafka                                â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  Topics:                                                            â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚   â”‚
â”‚  â”‚  â”‚ dbserver.inventory.orders        (INSERT/UPDATE/DELETE)     â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ dbserver.inventory.products      (INSERT/UPDATE/DELETE)     â”‚    â”‚   â”‚
â”‚  â”‚  â”‚ dbserver.inventory.customers     (INSERT/UPDATE/DELETE)     â”‚    â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  Schema Registry (Avro/JSON Schema)                                 â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                  â”‚                                         â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚              â”‚                   â”‚                   â”‚                     â”‚
â”‚              â–¼                   â–¼                   â–¼                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   Analytics       â”‚ â”‚    Search         â”‚ â”‚   Notifications   â”‚         â”‚
â”‚  â”‚   (ColumnStore)   â”‚ â”‚   (Elasticsearch) â”‚ â”‚   (Email/Push)    â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Configuration MariaDB pour CDC

```ini
# /etc/mysql/mariadb.conf.d/cdc.cnf
# Configuration optimisÃ©e pour Change Data Capture

[mysqld]
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# BINARY LOG - Essentiel pour CDC
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Activer le binlog
log_bin = mysql-bin
log_bin_index = mysql-bin.index

# Format ROW obligatoire pour CDC (capture les valeurs avant/aprÃ¨s)
binlog_format = ROW

# Image complÃ¨te des lignes (avant ET aprÃ¨s pour UPDATE)
binlog_row_image = FULL

# MÃ©tadonnÃ©es enrichies (noms de colonnes dans les events)
binlog_row_metadata = FULL

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# GTID - Simplifie le tracking de position
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

gtid_domain_id = 1
gtid_strict_mode = ON
log_slave_updates = ON

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# RÃ‰TENTION - Garder assez d'historique pour recovery
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# RÃ©tention des binlogs (7 jours pour permettre le rattrapage)
expire_logs_days = 7
max_binlog_size = 1G

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PERFORMANCE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Sync binlog Ã  chaque commit (durabilitÃ©)
sync_binlog = 1

# Mais on peut rÃ©duire la frÃ©quence pour les performances
# sync_binlog = 100  # Sync tous les 100 commits

# Compression des events binlog (rÃ©duit I/O et trafic CDC)
# ðŸ†• MariaDB 10.6+
log_bin_compress = ON
log_bin_compress_min_len = 256

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# UTILISATEUR CDC (privilÃ¨ges minimaux)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# CrÃ©er dans MariaDB :
# CREATE USER 'debezium'@'%' IDENTIFIED BY 'secure_password';
# GRANT SELECT, RELOAD, SHOW DATABASES, REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO 'debezium'@'%';
# GRANT SELECT ON performance_schema.* TO 'debezium'@'%';
```

### Configuration Debezium

```json
{
  "name": "mariadb-inventory-connector",
  "config": {
    "connector.class": "io.debezium.connector.mariadb.MariaDbConnector",
    "tasks.max": "1",
    
    "database.hostname": "mariadb-cdc.internal",
    "database.port": "3306",
    "database.user": "debezium",
    "database.password": "${secrets:mariadb/debezium:password}",
    "database.server.id": "184054",
    
    "topic.prefix": "dbserver",
    
    "database.include.list": "inventory",
    "table.include.list": "inventory.orders,inventory.order_items,inventory.products,inventory.customers",
    
    "include.schema.changes": "true",
    "include.query": "false",
    
    "snapshot.mode": "initial",
    "snapshot.locking.mode": "minimal",
    
    "gtid.source.includes": "1",
    
    "schema.history.internal.kafka.bootstrap.servers": "kafka:9092",
    "schema.history.internal.kafka.topic": "schema-changes.inventory",
    
    "key.converter": "io.confluent.connect.avro.AvroConverter",
    "key.converter.schema.registry.url": "http://schema-registry:8081",
    "value.converter": "io.confluent.connect.avro.AvroConverter",
    "value.converter.schema.registry.url": "http://schema-registry:8081",
    
    "transforms": "route,unwrap",
    "transforms.route.type": "org.apache.kafka.connect.transforms.RegexRouter",
    "transforms.route.regex": "([^.]+)\\.([^.]+)\\.([^.]+)",
    "transforms.route.replacement": "events.$3",
    "transforms.unwrap.type": "io.debezium.transforms.ExtractNewRecordState",
    "transforms.unwrap.drop.tombstones": "false",
    "transforms.unwrap.delete.handling.mode": "rewrite",
    
    "heartbeat.interval.ms": "10000",
    "heartbeat.action.query": "INSERT INTO inventory.debezium_heartbeat (ts) VALUES (NOW()) ON DUPLICATE KEY UPDATE ts=NOW()",
    
    "errors.log.enable": "true",
    "errors.log.include.messages": "true",
    "errors.tolerance": "all",
    "errors.deadletterqueue.topic.name": "dlq.inventory",
    "errors.deadletterqueue.context.headers.enable": "true"
  }
}
```

### Format des Ã©vÃ©nements Debezium

```json
{
  "schema": { ... },
  "payload": {
    "before": null,
    "after": {
      "order_id": 1001,
      "customer_id": 42,
      "order_date": 1702648800000,
      "status": "PENDING",
      "total_amount": "99.99",
      "shipping_address": "123 Main St, Paris",
      "created_at": 1702648800000000,
      "updated_at": 1702648800000000
    },
    "source": {
      "version": "2.4.0.Final",
      "connector": "mariadb",
      "name": "dbserver",
      "ts_ms": 1702648800123,
      "snapshot": "false",
      "db": "inventory",
      "table": "orders",
      "server_id": 1,
      "gtid": "1-1-1234",
      "file": "mysql-bin.000042",
      "pos": 12345,
      "row": 0
    },
    "op": "c",
    "ts_ms": 1702648800456,
    "transaction": {
      "id": "file=mysql-bin.000042,pos=12000",
      "total_order": 1,
      "data_collection_order": 1
    }
  }
}
```

| Champ | Description |
|-------|-------------|
| `before` | Ã‰tat avant la modification (null pour INSERT) |
| `after` | Ã‰tat aprÃ¨s la modification (null pour DELETE) |
| `op` | OpÃ©ration : `c` (create), `u` (update), `d` (delete), `r` (read/snapshot) |
| `source` | MÃ©tadonnÃ©es de la source (position binlog, GTID, etc.) |
| `ts_ms` | Timestamp du traitement par Debezium |

---

## Pattern Outbox

Le pattern Outbox garantit la cohÃ©rence entre les modifications de donnÃ©es et la publication d'Ã©vÃ©nements, en utilisant une transaction atomique.

### ImplÃ©mentation

```sql
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- PATTERN OUTBOX - SCHÃ‰MA
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Table mÃ©tier
CREATE TABLE orders (
    order_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    customer_id BIGINT NOT NULL,
    status ENUM('PENDING', 'CONFIRMED', 'SHIPPED', 'DELIVERED', 'CANCELLED') DEFAULT 'PENDING',
    total_amount DECIMAL(12,2) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    INDEX idx_customer (customer_id),
    INDEX idx_status (status)
) ENGINE=InnoDB;

-- Table Outbox (capturÃ©e par CDC)
CREATE TABLE outbox (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    
    -- Routing
    aggregate_type VARCHAR(100) NOT NULL,  -- Ex: "Order", "Customer"
    aggregate_id VARCHAR(100) NOT NULL,    -- Ex: "order-1001"
    
    -- Event
    event_type VARCHAR(100) NOT NULL,      -- Ex: "OrderCreated", "OrderShipped"
    payload JSON NOT NULL,                  -- DonnÃ©es de l'Ã©vÃ©nement
    
    -- MÃ©tadonnÃ©es
    created_at TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP(6),
    
    -- Pour le cleanup aprÃ¨s publication
    INDEX idx_created (created_at)
) ENGINE=InnoDB;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- PROCÃ‰DURE DE CRÃ‰ATION DE COMMANDE AVEC OUTBOX
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DELIMITER //

CREATE PROCEDURE create_order(
    IN p_customer_id BIGINT,
    IN p_total_amount DECIMAL(12,2),
    IN p_items JSON
)
BEGIN
    DECLARE v_order_id BIGINT;
    DECLARE v_event_payload JSON;
    
    -- Transaction atomique : ordre + Ã©vÃ©nement
    START TRANSACTION;
    
    -- 1. CrÃ©er la commande
    INSERT INTO orders (customer_id, status, total_amount)
    VALUES (p_customer_id, 'PENDING', p_total_amount);
    
    SET v_order_id = LAST_INSERT_ID();
    
    -- 2. InsÃ©rer les items (si table sÃ©parÃ©e)
    -- INSERT INTO order_items ... 
    
    -- 3. CrÃ©er l'Ã©vÃ©nement dans l'outbox
    SET v_event_payload = JSON_OBJECT(
        'order_id', v_order_id,
        'customer_id', p_customer_id,
        'total_amount', p_total_amount,
        'items', p_items,
        'status', 'PENDING',
        'timestamp', UNIX_TIMESTAMP(NOW(6)) * 1000
    );
    
    INSERT INTO outbox (aggregate_type, aggregate_id, event_type, payload)
    VALUES ('Order', CONCAT('order-', v_order_id), 'OrderCreated', v_event_payload);
    
    COMMIT;
    
    SELECT v_order_id AS order_id;
END //

-- ProcÃ©dure pour changer le statut avec Ã©vÃ©nement
CREATE PROCEDURE update_order_status(
    IN p_order_id BIGINT,
    IN p_new_status VARCHAR(20),
    IN p_metadata JSON
)
BEGIN
    DECLARE v_old_status VARCHAR(20);
    DECLARE v_event_type VARCHAR(100);
    DECLARE v_event_payload JSON;
    
    START TRANSACTION;
    
    -- RÃ©cupÃ©rer l'ancien statut
    SELECT status INTO v_old_status FROM orders WHERE order_id = p_order_id FOR UPDATE;
    
    -- Mettre Ã  jour
    UPDATE orders SET status = p_new_status WHERE order_id = p_order_id;
    
    -- DÃ©terminer le type d'Ã©vÃ©nement
    SET v_event_type = CASE p_new_status
        WHEN 'CONFIRMED' THEN 'OrderConfirmed'
        WHEN 'SHIPPED' THEN 'OrderShipped'
        WHEN 'DELIVERED' THEN 'OrderDelivered'
        WHEN 'CANCELLED' THEN 'OrderCancelled'
        ELSE CONCAT('OrderStatusChanged_', p_new_status)
    END;
    
    -- CrÃ©er l'Ã©vÃ©nement
    SET v_event_payload = JSON_OBJECT(
        'order_id', p_order_id,
        'old_status', v_old_status,
        'new_status', p_new_status,
        'metadata', p_metadata,
        'timestamp', UNIX_TIMESTAMP(NOW(6)) * 1000
    );
    
    INSERT INTO outbox (aggregate_type, aggregate_id, event_type, payload)
    VALUES ('Order', CONCAT('order-', p_order_id), v_event_type, v_event_payload);
    
    COMMIT;
END //

DELIMITER ;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- UTILISATION
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- CrÃ©er une commande (atomique : order + event)
CALL create_order(
    42,  -- customer_id
    99.99,  -- total
    '[{"product_id": 101, "qty": 2}, {"product_id": 102, "qty": 1}]'
);

-- Mettre Ã  jour le statut
CALL update_order_status(1001, 'CONFIRMED', '{"confirmed_by": "system"}');
```

### Configuration Debezium pour Outbox

```json
{
  "name": "outbox-connector",
  "config": {
    "connector.class": "io.debezium.connector.mariadb.MariaDbConnector",
    "database.hostname": "mariadb.internal",
    "database.port": "3306",
    "database.user": "debezium",
    "database.password": "${secrets:mariadb/debezium:password}",
    "topic.prefix": "app",
    
    "table.include.list": "inventory.outbox",
    
    "tombstones.on.delete": "false",
    
    "transforms": "outbox",
    "transforms.outbox.type": "io.debezium.transforms.outbox.EventRouter",
    "transforms.outbox.table.fields.additional.placement": "event_type:header:eventType",
    "transforms.outbox.table.field.event.key": "aggregate_id",
    "transforms.outbox.table.field.event.type": "event_type",
    "transforms.outbox.table.field.event.payload": "payload",
    "transforms.outbox.route.by.field": "aggregate_type",
    "transforms.outbox.route.topic.replacement": "events.${routedByValue}"
  }
}
```

Avec cette configuration, les Ã©vÃ©nements de la table outbox sont automatiquement routÃ©s vers des topics Kafka basÃ©s sur `aggregate_type` :
- `OrderCreated` â†’ `events.Order`
- `CustomerUpdated` â†’ `events.Customer`

---

## Pattern Event Sourcing

### ImplÃ©mentation complÃ¨te

```sql
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- EVENT SOURCING - SCHÃ‰MA
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Event Store (append-only)
CREATE TABLE events (
    event_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    
    -- Aggregate identification
    aggregate_type VARCHAR(100) NOT NULL,
    aggregate_id VARCHAR(100) NOT NULL,
    
    -- Versioning (pour optimistic locking)
    version INT NOT NULL,
    
    -- Event data
    event_type VARCHAR(100) NOT NULL,
    payload JSON NOT NULL,
    metadata JSON,
    
    -- Timestamps
    created_at TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP(6),
    
    -- Contrainte d'unicitÃ© pour le versioning optimiste
    UNIQUE KEY uk_aggregate_version (aggregate_type, aggregate_id, version),
    
    -- Index pour les requÃªtes courantes
    INDEX idx_aggregate (aggregate_type, aggregate_id, version),
    INDEX idx_type_time (event_type, created_at),
    INDEX idx_created (created_at)
) ENGINE=InnoDB
  ROW_FORMAT=COMPRESSED
  COMMENT='Event Store - Append Only';

-- Snapshots (optimisation pour Ã©viter de rejouer tous les Ã©vÃ©nements)
CREATE TABLE snapshots (
    aggregate_type VARCHAR(100) NOT NULL,
    aggregate_id VARCHAR(100) NOT NULL,
    version INT NOT NULL,
    state JSON NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    PRIMARY KEY (aggregate_type, aggregate_id),
    INDEX idx_version (aggregate_type, aggregate_id, version)
) ENGINE=InnoDB;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- FONCTIONS EVENT SOURCING
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

DELIMITER //

-- Ajouter un Ã©vÃ©nement avec vÃ©rification de version (optimistic locking)
CREATE FUNCTION append_event(
    p_aggregate_type VARCHAR(100),
    p_aggregate_id VARCHAR(100),
    p_expected_version INT,
    p_event_type VARCHAR(100),
    p_payload JSON,
    p_metadata JSON
) RETURNS BIGINT
DETERMINISTIC
MODIFIES SQL DATA
BEGIN
    DECLARE v_current_version INT;
    DECLARE v_new_event_id BIGINT;
    
    -- RÃ©cupÃ©rer la version actuelle
    SELECT COALESCE(MAX(version), 0) INTO v_current_version
    FROM events
    WHERE aggregate_type = p_aggregate_type AND aggregate_id = p_aggregate_id;
    
    -- VÃ©rifier la version attendue (optimistic concurrency)
    IF v_current_version != p_expected_version THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Concurrency conflict: version mismatch';
    END IF;
    
    -- InsÃ©rer l'Ã©vÃ©nement
    INSERT INTO events (aggregate_type, aggregate_id, version, event_type, payload, metadata)
    VALUES (p_aggregate_type, p_aggregate_id, v_current_version + 1, p_event_type, p_payload, p_metadata);
    
    SET v_new_event_id = LAST_INSERT_ID();
    
    RETURN v_new_event_id;
END //

-- RÃ©cupÃ©rer tous les Ã©vÃ©nements d'un agrÃ©gat
CREATE PROCEDURE get_events(
    IN p_aggregate_type VARCHAR(100),
    IN p_aggregate_id VARCHAR(100),
    IN p_from_version INT
)
BEGIN
    SELECT event_id, version, event_type, payload, metadata, created_at
    FROM events
    WHERE aggregate_type = p_aggregate_type
      AND aggregate_id = p_aggregate_id
      AND version > COALESCE(p_from_version, 0)
    ORDER BY version ASC;
END //

-- Sauvegarder un snapshot
CREATE PROCEDURE save_snapshot(
    IN p_aggregate_type VARCHAR(100),
    IN p_aggregate_id VARCHAR(100),
    IN p_version INT,
    IN p_state JSON
)
BEGIN
    INSERT INTO snapshots (aggregate_type, aggregate_id, version, state)
    VALUES (p_aggregate_type, p_aggregate_id, p_version, p_state)
    ON DUPLICATE KEY UPDATE
        version = p_version,
        state = p_state,
        created_at = CURRENT_TIMESTAMP;
END //

-- RÃ©cupÃ©rer le snapshot le plus rÃ©cent
CREATE PROCEDURE get_snapshot(
    IN p_aggregate_type VARCHAR(100),
    IN p_aggregate_id VARCHAR(100)
)
BEGIN
    SELECT version, state, created_at
    FROM snapshots
    WHERE aggregate_type = p_aggregate_type
      AND aggregate_id = p_aggregate_id;
END //

DELIMITER ;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- EXEMPLE : ORDER AGGREGATE
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- CrÃ©er une commande (version 0 â†’ 1)
SELECT append_event(
    'Order',
    'order-1001',
    0,  -- Version attendue (0 = nouveau)
    'OrderCreated',
    JSON_OBJECT(
        'customer_id', 42,
        'items', JSON_ARRAY(
            JSON_OBJECT('product_id', 101, 'quantity', 2, 'price', 29.99),
            JSON_OBJECT('product_id', 102, 'quantity', 1, 'price', 39.99)
        ),
        'total', 99.97
    ),
    JSON_OBJECT('user_id', 'user-123', 'ip', '192.168.1.1')
);

-- Ajouter un item (version 1 â†’ 2)
SELECT append_event(
    'Order',
    'order-1001',
    1,
    'ItemAdded',
    JSON_OBJECT('product_id', 103, 'quantity', 1, 'price', 19.99),
    JSON_OBJECT('user_id', 'user-123')
);

-- Confirmer la commande (version 2 â†’ 3)
SELECT append_event(
    'Order',
    'order-1001',
    2,
    'OrderConfirmed',
    JSON_OBJECT('confirmed_at', NOW()),
    JSON_OBJECT('user_id', 'system')
);

-- RÃ©cupÃ©rer l'historique complet
CALL get_events('Order', 'order-1001', 0);
```

---

## Pattern CQRS

### Architecture complÃ¨te

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CQRS AVEC MARIADB + COLUMNSTORE                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                           â”‚
â”‚                              Applications                                 â”‚
â”‚                                  â”‚                                        â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚              â”‚                                       â”‚                    â”‚
â”‚         Commands                                 Queries                  â”‚
â”‚      (Create, Update)                        (Read, Search)               â”‚
â”‚              â”‚                                       â”‚                    â”‚
â”‚              â–¼                                       â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   Command Handler     â”‚               â”‚    Query Handler      â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚              â”‚                                       â”‚                    â”‚
â”‚              â–¼                                       â–¼                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚    WRITE MODEL        â”‚               â”‚    READ MODEL         â”‚        â”‚
â”‚  â”‚    (InnoDB)           â”‚               â”‚    (ColumnStore)      â”‚        â”‚
â”‚  â”‚                       â”‚               â”‚                       â”‚        â”‚
â”‚  â”‚  orders               â”‚               â”‚  orders_view          â”‚        â”‚
â”‚  â”‚  â”œâ”€â”€ order_id (PK)    â”‚               â”‚  â”œâ”€â”€ order_id         â”‚        â”‚
â”‚  â”‚  â”œâ”€â”€ customer_id (FK) â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â–º   â”‚  â”œâ”€â”€ customer_name    â”‚        â”‚
â”‚  â”‚  â”œâ”€â”€ status           â”‚     CDC       â”‚  â”œâ”€â”€ customer_email   â”‚        â”‚
â”‚  â”‚  â””â”€â”€ total            â”‚   (Debezium)  â”‚  â”œâ”€â”€ status           â”‚        â”‚
â”‚  â”‚                       â”‚               â”‚  â”œâ”€â”€ total            â”‚        â”‚
â”‚  â”‚  customers            â”‚               â”‚  â”œâ”€â”€ item_count       â”‚        â”‚
â”‚  â”‚  â”œâ”€â”€ customer_id (PK) â”‚               â”‚  â”œâ”€â”€ product_names    â”‚        â”‚
â”‚  â”‚  â”œâ”€â”€ name             â”‚               â”‚  â””â”€â”€ created_at       â”‚        â”‚
â”‚  â”‚  â””â”€â”€ email            â”‚               â”‚                       â”‚        â”‚
â”‚  â”‚                       â”‚               â”‚  (DÃ©normalisÃ©,        â”‚        â”‚
â”‚  â”‚  order_items          â”‚               â”‚   optimisÃ© lectures)  â”‚        â”‚
â”‚  â”‚  â”œâ”€â”€ item_id (PK)     â”‚               â”‚                       â”‚        â”‚
â”‚  â”‚  â”œâ”€â”€ order_id (FK)    â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  â”‚  â””â”€â”€ product_id (FK)  â”‚                                                â”‚
â”‚  â”‚                       â”‚                                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â”‚                                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ImplÃ©mentation

```sql
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- WRITE MODEL (InnoDB - NormalisÃ©, optimisÃ© pour transactions)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE DATABASE write_model;
USE write_model;

CREATE TABLE customers (
    customer_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    email VARCHAR(255) UNIQUE NOT NULL,
    name VARCHAR(200) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB;

CREATE TABLE orders (
    order_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    customer_id BIGINT NOT NULL,
    status ENUM('PENDING', 'CONFIRMED', 'SHIPPED', 'DELIVERED', 'CANCELLED') DEFAULT 'PENDING',
    total_amount DECIMAL(12,2) NOT NULL,
    shipping_address TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    FOREIGN KEY (customer_id) REFERENCES customers(customer_id)
) ENGINE=InnoDB;

CREATE TABLE order_items (
    item_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    order_id BIGINT NOT NULL,
    product_id BIGINT NOT NULL,
    product_name VARCHAR(200) NOT NULL,
    quantity INT NOT NULL,
    unit_price DECIMAL(10,2) NOT NULL,
    
    FOREIGN KEY (order_id) REFERENCES orders(order_id)
) ENGINE=InnoDB;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- READ MODEL (ColumnStore - DÃ©normalisÃ©, optimisÃ© pour requÃªtes)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

CREATE DATABASE read_model;
USE read_model;

-- Vue matÃ©rialisÃ©e des commandes (mise Ã  jour par CDC)
CREATE TABLE orders_view (
    order_id BIGINT NOT NULL,
    
    -- DonnÃ©es client (dÃ©normalisÃ©es)
    customer_id BIGINT NOT NULL,
    customer_name VARCHAR(200),
    customer_email VARCHAR(255),
    
    -- DonnÃ©es commande
    status VARCHAR(20),
    total_amount DECIMAL(12,2),
    shipping_address TEXT,
    
    -- AgrÃ©gations prÃ©-calculÃ©es
    item_count INT,
    product_names TEXT,  -- Liste des produits, ex: "Laptop, Mouse, Keyboard"
    
    -- Timestamps
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    last_sync_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    PRIMARY KEY (order_id)
) ENGINE=Columnstore;

-- AgrÃ©gations par client
CREATE TABLE customer_stats_view (
    customer_id BIGINT PRIMARY KEY,
    customer_name VARCHAR(200),
    customer_email VARCHAR(255),
    
    total_orders INT DEFAULT 0,
    total_spent DECIMAL(14,2) DEFAULT 0,
    avg_order_value DECIMAL(10,2) DEFAULT 0,
    first_order_date TIMESTAMP,
    last_order_date TIMESTAMP,
    
    last_sync_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=Columnstore;

-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- SYNCHRONISATION (Via CDC Consumer - exemple Python/Kafka)
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Alternative : Triggers pour synchro simple (moins scalable)
USE write_model;

DELIMITER //

CREATE TRIGGER trg_order_sync_insert
AFTER INSERT ON orders
FOR EACH ROW
BEGIN
    DECLARE v_customer_name VARCHAR(200);
    DECLARE v_customer_email VARCHAR(255);
    
    SELECT name, email INTO v_customer_name, v_customer_email
    FROM customers WHERE customer_id = NEW.customer_id;
    
    INSERT INTO read_model.orders_view 
        (order_id, customer_id, customer_name, customer_email, status, 
         total_amount, shipping_address, item_count, created_at, updated_at)
    VALUES
        (NEW.order_id, NEW.customer_id, v_customer_name, v_customer_email,
         NEW.status, NEW.total_amount, NEW.shipping_address, 0, 
         NEW.created_at, NEW.updated_at);
END //

CREATE TRIGGER trg_order_sync_update
AFTER UPDATE ON orders
FOR EACH ROW
BEGIN
    UPDATE read_model.orders_view
    SET status = NEW.status,
        total_amount = NEW.total_amount,
        shipping_address = NEW.shipping_address,
        updated_at = NEW.updated_at,
        last_sync_at = CURRENT_TIMESTAMP
    WHERE order_id = NEW.order_id;
END //

CREATE TRIGGER trg_order_item_sync
AFTER INSERT ON order_items
FOR EACH ROW
BEGIN
    UPDATE read_model.orders_view
    SET item_count = item_count + 1,
        product_names = CONCAT(COALESCE(product_names, ''), 
                               IF(product_names IS NULL OR product_names = '', '', ', '),
                               NEW.product_name),
        last_sync_at = CURRENT_TIMESTAMP
    WHERE order_id = NEW.order_id;
END //

DELIMITER ;
```

---

## IntÃ©gration avec Apache Kafka

### Architecture complÃ¨te

```yaml
# docker-compose-kafka-mariadb.yml
version: '3.8'

services:
  # MariaDB
  mariadb:
    image: mariadb:11.8
    environment:
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}
      MARIADB_DATABASE: inventory
    volumes:
      - ./config/mariadb-cdc.cnf:/etc/mysql/mariadb.conf.d/cdc.cnf
      - mariadb-data:/var/lib/mysql
    ports:
      - "3306:3306"
    networks:
      - kafka-network

  # Zookeeper
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - kafka-network

  # Kafka
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
    networks:
      - kafka-network

  # Schema Registry
  schema-registry:
    image: confluentinc/cp-schema-registry:7.5.0
    depends_on:
      - kafka
    ports:
      - "8081:8081"
    environment:
      SCHEMA_REGISTRY_HOST_NAME: schema-registry
      SCHEMA_REGISTRY_KAFKASTORE_BOOTSTRAP_SERVERS: kafka:29092
    networks:
      - kafka-network

  # Kafka Connect (Debezium)
  kafka-connect:
    image: debezium/connect:2.4
    depends_on:
      - kafka
      - mariadb
    ports:
      - "8083:8083"
    environment:
      BOOTSTRAP_SERVERS: kafka:29092
      GROUP_ID: debezium-connect
      CONFIG_STORAGE_TOPIC: connect-configs
      OFFSET_STORAGE_TOPIC: connect-offsets
      STATUS_STORAGE_TOPIC: connect-status
      KEY_CONVERTER: io.confluent.connect.avro.AvroConverter
      VALUE_CONVERTER: io.confluent.connect.avro.AvroConverter
      KEY_CONVERTER_SCHEMA_REGISTRY_URL: http://schema-registry:8081
      VALUE_CONVERTER_SCHEMA_REGISTRY_URL: http://schema-registry:8081
    networks:
      - kafka-network

  # Kafka UI (monitoring)
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    ports:
      - "8080:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: local
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
      KAFKA_CLUSTERS_0_SCHEMAREGISTRY: http://schema-registry:8081
      KAFKA_CLUSTERS_0_KAFKACONNECT_0_NAME: debezium
      KAFKA_CLUSTERS_0_KAFKACONNECT_0_ADDRESS: http://kafka-connect:8083
    networks:
      - kafka-network

volumes:
  mariadb-data:

networks:
  kafka-network:
    driver: bridge
```

### Consumer Kafka en Python

```python
#!/usr/bin/env python3
"""
kafka_consumer.py
Consommateur Kafka pour les Ã©vÃ©nements CDC MariaDB
"""

from confluent_kafka import Consumer, KafkaError, KafkaException
from confluent_kafka.schema_registry import SchemaRegistryClient
from confluent_kafka.schema_registry.avro import AvroDeserializer
from confluent_kafka.serialization import SerializationContext, MessageField
import json
import logging
import mariadb
from typing import Dict, Any, Optional

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


class CDCEventProcessor:
    """Processeur d'Ã©vÃ©nements CDC Debezium"""
    
    def __init__(self, read_model_config: Dict[str, Any]):
        self.conn = mariadb.connect(**read_model_config)
        self.cursor = self.conn.cursor()
    
    def process_order_event(self, event: Dict[str, Any]):
        """Traiter un Ã©vÃ©nement de commande"""
        
        op = event.get('op')
        after = event.get('after')
        before = event.get('before')
        
        if op == 'c':  # Create
            self._handle_order_created(after)
        elif op == 'u':  # Update
            self._handle_order_updated(before, after)
        elif op == 'd':  # Delete
            self._handle_order_deleted(before)
        elif op == 'r':  # Read (snapshot)
            self._handle_order_created(after)
    
    def _handle_order_created(self, data: Dict[str, Any]):
        """GÃ©rer la crÃ©ation d'une commande"""
        
        # RÃ©cupÃ©rer les infos client
        self.cursor.execute(
            "SELECT name, email FROM write_model.customers WHERE customer_id = %s",
            (data['customer_id'],)
        )
        customer = self.cursor.fetchone()
        
        # InsÃ©rer dans le read model
        self.cursor.execute("""
            INSERT INTO read_model.orders_view 
            (order_id, customer_id, customer_name, customer_email, status, 
             total_amount, shipping_address, item_count, created_at, updated_at)
            VALUES (%s, %s, %s, %s, %s, %s, %s, 0, %s, %s)
            ON DUPLICATE KEY UPDATE
                status = VALUES(status),
                total_amount = VALUES(total_amount),
                updated_at = VALUES(updated_at)
        """, (
            data['order_id'],
            data['customer_id'],
            customer[0] if customer else None,
            customer[1] if customer else None,
            data['status'],
            data['total_amount'],
            data.get('shipping_address'),
            data['created_at'],
            data['updated_at']
        ))
        
        self.conn.commit()
        logger.info(f"Order {data['order_id']} synced to read model")
    
    def _handle_order_updated(self, before: Dict, after: Dict):
        """GÃ©rer la mise Ã  jour d'une commande"""
        
        self.cursor.execute("""
            UPDATE read_model.orders_view
            SET status = %s,
                total_amount = %s,
                shipping_address = %s,
                updated_at = %s,
                last_sync_at = CURRENT_TIMESTAMP
            WHERE order_id = %s
        """, (
            after['status'],
            after['total_amount'],
            after.get('shipping_address'),
            after['updated_at'],
            after['order_id']
        ))
        
        self.conn.commit()
        logger.info(f"Order {after['order_id']} updated in read model")
    
    def _handle_order_deleted(self, data: Dict):
        """GÃ©rer la suppression d'une commande"""
        
        # Soft delete ou suppression selon la stratÃ©gie
        self.cursor.execute(
            "DELETE FROM read_model.orders_view WHERE order_id = %s",
            (data['order_id'],)
        )
        
        self.conn.commit()
        logger.info(f"Order {data['order_id']} deleted from read model")
    
    def close(self):
        self.cursor.close()
        self.conn.close()


def main():
    # Configuration
    kafka_config = {
        'bootstrap.servers': 'localhost:9092',
        'group.id': 'read-model-sync',
        'auto.offset.reset': 'earliest',
        'enable.auto.commit': False
    }
    
    read_model_config = {
        'host': 'localhost',
        'port': 3306,
        'user': 'sync_user',
        'password': 'sync_password',
        'database': 'read_model'
    }
    
    # CrÃ©er le consumer
    consumer = Consumer(kafka_config)
    processor = CDCEventProcessor(read_model_config)
    
    # Souscrire aux topics
    topics = [
        'dbserver.inventory.orders',
        'dbserver.inventory.order_items',
        'dbserver.inventory.customers'
    ]
    consumer.subscribe(topics)
    
    logger.info(f"Subscribed to topics: {topics}")
    
    try:
        while True:
            msg = consumer.poll(timeout=1.0)
            
            if msg is None:
                continue
            
            if msg.error():
                if msg.error().code() == KafkaError._PARTITION_EOF:
                    continue
                else:
                    raise KafkaException(msg.error())
            
            # DÃ©coder l'Ã©vÃ©nement
            try:
                event = json.loads(msg.value().decode('utf-8'))
                topic = msg.topic()
                
                logger.debug(f"Received event from {topic}: {event.get('op')}")
                
                # Router vers le bon handler
                if 'orders' in topic:
                    processor.process_order_event(event)
                # Ajouter d'autres handlers...
                
                # Commit aprÃ¨s traitement rÃ©ussi
                consumer.commit(asynchronous=False)
                
            except Exception as e:
                logger.error(f"Error processing message: {e}")
                # Selon la stratÃ©gie : retry, DLQ, ou skip
                
    except KeyboardInterrupt:
        logger.info("Shutting down...")
    finally:
        consumer.close()
        processor.close()


if __name__ == '__main__':
    main()
```

---

## Monitoring et observabilitÃ©

### MÃ©triques CDC

```sql
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
-- MONITORING CDC ET EVENT-DRIVEN
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Table de mÃ©triques CDC
CREATE TABLE cdc_metrics (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    metric_name VARCHAR(100) NOT NULL,
    metric_value DECIMAL(20,4),
    labels JSON,
    recorded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    INDEX idx_name_time (metric_name, recorded_at)
) ENGINE=InnoDB;

-- MÃ©triques binlog
INSERT INTO cdc_metrics (metric_name, metric_value, labels)
SELECT 
    'binlog_position',
    CAST(SUBSTRING_INDEX(File, '.', -1) AS DECIMAL) * 1000000000 + Position,
    JSON_OBJECT('file', File)
FROM (SHOW MASTER STATUS) AS ms;

-- Taille des binlogs
INSERT INTO cdc_metrics (metric_name, metric_value)
SELECT 
    'binlog_total_size_bytes',
    SUM(File_size)
FROM information_schema.FILES
WHERE FILE_TYPE = 'BINARY LOG';

-- Lag Debezium (heartbeat table)
CREATE TABLE debezium_heartbeat (
    id INT PRIMARY KEY DEFAULT 1,
    ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) ENGINE=InnoDB;

-- Vue de monitoring
CREATE VIEW v_cdc_health AS
SELECT 
    -- Binlog health
    (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS 
     WHERE VARIABLE_NAME = 'Binlog_commits') AS binlog_commits,
    (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS 
     WHERE VARIABLE_NAME = 'Binlog_group_commits') AS binlog_group_commits,
    
    -- Replication threads (Debezium se connecte comme replica)
    (SELECT COUNT(*) FROM information_schema.PROCESSLIST 
     WHERE COMMAND = 'Binlog Dump' OR COMMAND = 'Binlog Dump GTID') AS cdc_connections,
    
    -- Heartbeat lag
    (SELECT TIMESTAMPDIFF(SECOND, ts, NOW()) FROM debezium_heartbeat) AS heartbeat_lag_seconds,
    
    -- Outbox backlog
    (SELECT COUNT(*) FROM outbox WHERE created_at > DATE_SUB(NOW(), INTERVAL 1 HOUR)) AS outbox_events_1h,
    
    NOW() AS checked_at;

SELECT * FROM v_cdc_health;
```

### Alertes Prometheus

```yaml
# prometheus-cdc-alerts.yaml
groups:
  - name: cdc-mariadb
    rules:
      # Lag CDC Ã©levÃ©
      - alert: CDCLagHigh
        expr: debezium_connector_lag_seconds > 60
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "CDC lag > 60 seconds"
          description: "Debezium connector {{ $labels.connector }} is {{ $value }}s behind"

      # Connector down
      - alert: DebeziumConnectorDown
        expr: debezium_connector_status != 1
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Debezium connector is down"
          
      # Binlog retention warning
      - alert: BinlogRetentionLow
        expr: mysql_binlog_files_count < 3
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Low binlog retention"
          description: "Only {{ $value }} binlog files available"

      # Outbox backlog
      - alert: OutboxBacklogHigh
        expr: mysql_table_rows{table="outbox"} > 10000
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Outbox table backlog > 10K events"

      # Consumer lag Kafka
      - alert: KafkaConsumerLagHigh
        expr: kafka_consumer_group_lag > 100000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Kafka consumer lag > 100K messages"
```

---

## Ã‰tude de cas : Plateforme E-commerce Event-Driven

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Ã‰TUDE DE CAS : E-COMMERCE EVENT-DRIVEN                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                            â”‚
â”‚  Contexte :                                                                â”‚
â”‚  â€¢ 50K commandes/jour, pics Ã  500/seconde                                  â”‚
â”‚  â€¢ 15 microservices (Orders, Inventory, Payments, Shipping, etc.)          â”‚
â”‚  â€¢ Besoin d'audit trail complet                                            â”‚
â”‚  â€¢ Analytics temps rÃ©el                                                    â”‚
â”‚  â€¢ Migration depuis architecture monolithique                              â”‚
â”‚                                                                            â”‚
â”‚  Architecture retenue :                                                    â”‚
â”‚                                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         API Gateway                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                  â”‚                                         â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚         â”‚                        â”‚                        â”‚                â”‚
â”‚         â–¼                        â–¼                        â–¼                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   Orders    â”‚          â”‚  Inventory  â”‚          â”‚  Payments   â”‚         â”‚
â”‚  â”‚   Service   â”‚          â”‚   Service   â”‚          â”‚   Service   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚         â”‚                        â”‚                        â”‚                â”‚
â”‚         â–¼                        â–¼                        â–¼                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  MariaDB    â”‚          â”‚  MariaDB    â”‚          â”‚  MariaDB    â”‚         â”‚
â”‚  â”‚  (Orders)   â”‚          â”‚ (Inventory) â”‚          â”‚ (Payments)  â”‚         â”‚
â”‚  â”‚  + Outbox   â”‚          â”‚  + Outbox   â”‚          â”‚  + Outbox   â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚         â”‚                        â”‚                        â”‚                â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                  â”‚                                         â”‚
â”‚                           CDC (Debezium)                                   â”‚
â”‚                                  â”‚                                         â”‚
â”‚                                  â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                         Apache Kafka                                â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  Topics :                                                           â”‚   â”‚
â”‚  â”‚  â€¢ events.orders        (OrderCreated, OrderConfirmed, etc.)        â”‚   â”‚
â”‚  â”‚  â€¢ events.inventory     (StockReserved, StockReleased, etc.)        â”‚   â”‚
â”‚  â”‚  â€¢ events.payments      (PaymentReceived, PaymentFailed, etc.)      â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                  â”‚                                         â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚         â”‚                        â”‚                        â”‚                â”‚
â”‚         â–¼                        â–¼                        â–¼                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  Shipping   â”‚          â”‚  Analytics  â”‚          â”‚   Search    â”‚         â”‚
â”‚  â”‚  Service    â”‚          â”‚   Service   â”‚          â”‚   Service   â”‚         â”‚
â”‚  â”‚             â”‚          â”‚             â”‚          â”‚             â”‚         â”‚
â”‚  â”‚  MariaDB    â”‚          â”‚ ColumnStore â”‚          â”‚Elasticsearchâ”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                            â”‚
â”‚  DÃ©cisions clÃ©s :                                                          â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•                                                           â”‚
â”‚                                                                            â”‚
â”‚  1. Pattern Outbox pour garantir cohÃ©rence DB + Events                     â”‚
â”‚     â†’ Pas de dual-write, transaction atomique                              â”‚
â”‚                                                                            â”‚
â”‚  2. CDC Debezium sur tables Outbox uniquement                              â”‚
â”‚     â†’ Filtrage prÃ©cis, pas de bruit des tables internes                    â”‚
â”‚     â†’ Events mÃ©tier explicites (pas des changements de colonnes)           â”‚
â”‚                                                                            â”‚
â”‚  3. Kafka comme event bus central                                          â”‚
â”‚     â†’ DÃ©couplage total entre producteurs et consommateurs                  â”‚
â”‚     â†’ Replay possible pour reconstruire des projections                    â”‚
â”‚     â†’ Retention 7 jours pour debugging                                     â”‚
â”‚                                                                            â”‚
â”‚  4. CQRS pour analytics                                                    â”‚
â”‚     â†’ Write model InnoDB normalisÃ© (OLTP)                                  â”‚
â”‚     â†’ Read model ColumnStore dÃ©normalisÃ© (OLAP)                            â”‚
â”‚     â†’ Sync via consommateur Kafka dÃ©diÃ©                                    â”‚
â”‚                                                                            â”‚
â”‚  MÃ©triques atteintes :                                                     â”‚
â”‚  â€¢ Latence event propagation : P99 < 500ms                                 â”‚
â”‚  â€¢ Throughput : 2000 events/seconde soutenu                                â”‚
â”‚  â€¢ DisponibilitÃ© : 99.95% (chaque service indÃ©pendant)                     â”‚
â”‚  â€¢ Audit : 100% des changements tracÃ©s                                     â”‚
â”‚  â€¢ Recovery : Replay complet possible en 4h                                â”‚
â”‚                                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… Points clÃ©s Ã  retenir

- **Le binlog MariaDB** est la fondation du CDC â€” configurer `binlog_format=ROW` et `binlog_row_image=FULL`
- **Debezium** transforme le binlog en Ã©vÃ©nements Kafka sans modification du code applicatif
- **Le pattern Outbox** garantit la cohÃ©rence entre la base de donnÃ©es et les Ã©vÃ©nements publiÃ©s
- **Event Sourcing** stocke l'historique complet, permettant l'audit et le replay
- **CQRS** sÃ©pare les modÃ¨les d'Ã©criture et de lecture pour optimiser chaque workload
- **Kafka** offre durabilitÃ©, replay et dÃ©couplage â€” essentiel pour les architectures event-driven Ã  grande Ã©chelle
- **Utiliser un replica dÃ©diÃ©** pour le CDC afin de ne pas impacter la production
- **Monitoring du lag CDC** est critique â€” alerter si > 60 secondes

---

## ðŸ”— Ressources et rÃ©fÃ©rences

- [ðŸ“– Debezium MariaDB Connector](https://debezium.io/documentation/reference/stable/connectors/mariadb.html)
- [ðŸ“– MariaDB Binary Log](https://mariadb.com/kb/en/binary-log/)
- [ðŸ“– Outbox Pattern - Debezium](https://debezium.io/blog/2019/02/19/reliable-microservices-data-exchange-with-the-outbox-pattern/)
- [ðŸ“– Event Sourcing - Martin Fowler](https://martinfowler.com/eaaDev/EventSourcing.html)
- [ðŸ“– CQRS Pattern](https://docs.microsoft.com/en-us/azure/architecture/patterns/cqrs)
- [ðŸ“– Apache Kafka Documentation](https://kafka.apache.org/documentation/)

---

## âž¡ï¸ Sections suivantes

Cette section se dÃ©cline en deux sous-sections dÃ©taillÃ©es :

| Section | Titre | Focus |
|---------|-------|-------|
| 20.8.1 | [CDC (Change Data Capture)](./08.1-cdc.md) | Configuration avancÃ©e, Maxwell, comparaison des outils |
| 20.8.2 | [IntÃ©gration Kafka](./08.2-integration-kafka.md) | Kafka Streams, ksqlDB, patterns avancÃ©s |

â­ï¸ [CDC (Change Data Capture)](/20-cas-usage-architectures/08.1-cdc.md)
