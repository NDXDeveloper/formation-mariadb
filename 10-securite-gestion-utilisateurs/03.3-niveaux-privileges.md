üîù Retour au [Sommaire](/SOMMAIRE.md)

# 10.3.3 Privil√®ges globaux, base, table, colonne

> **Niveau** : Avanc√©
> **Dur√©e estim√©e** : 2 heures
> **Pr√©requis** : Sections 10.3.1 (GRANT) et 10.3.2 (REVOKE)

## üéØ Objectifs d'apprentissage

√Ä l'issue de cette section, vous serez capable de :
- Comprendre en profondeur la hi√©rarchie des privil√®ges MariaDB
- Ma√Ætriser les r√®gles de pr√©c√©dence et d'√©valuation des privil√®ges
- Concevoir des mod√®les de s√©curit√© optimaux par niveau de privil√®ge
- Diagnostiquer et r√©soudre les probl√®mes de permissions complexes
- Impl√©menter des strat√©gies de granularit√© adapt√©es √† diff√©rents cas d'usage

---

## Introduction

MariaDB impl√©mente un syst√®me de privil√®ges **hi√©rarchique √† 5 niveaux**, du plus g√©n√©ral au plus granulaire. Cette architecture permet un contr√¥le fin des acc√®s tout en maintenant la simplicit√© d'administration pour les cas courants.

La compr√©hension de cette hi√©rarchie et de ses r√®gles d'√©valuation est fondamentale pour :
- Concevoir des mod√®les de s√©curit√© robustes
- Optimiser les performances d'authentification
- √âviter les failles de s√©curit√© dues √† des pr√©c√©dences inattendues
- Simplifier l'audit et la maintenance

üí° **Principe cl√©** : MariaDB √©value les privil√®ges du **plus sp√©cifique au plus g√©n√©ral**, avec une logique bool√©enne OR : si un privil√®ge est accord√© √† n'importe quel niveau, il est effectif.

---

## Hi√©rarchie compl√®te des privil√®ges

### Vue d'ensemble

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  1. Niveau GLOBAL (*.*)                 ‚îÇ  ‚Üê Plus g√©n√©ral
‚îÇ     ‚îî‚îÄ Tous les serveurs, toutes bases  ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ  2. Niveau DATABASE (db.*)              ‚îÇ
‚îÇ     ‚îî‚îÄ Toutes tables d'une base         ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ  3. Niveau TABLE (db.table)             ‚îÇ
‚îÇ     ‚îî‚îÄ Une table sp√©cifique             ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ  4. Niveau COLUMN (db.table.col)        ‚îÇ
‚îÇ     ‚îî‚îÄ Colonnes sp√©cifiques             ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ  5. Niveau ROUTINE (PROCEDURE/FUNCTION) ‚îÇ  ‚Üê Plus granulaire
‚îÇ     ‚îî‚îÄ Proc√©dures/fonctions stock√©es    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Tables de stockage des privil√®ges

| Niveau | Table syst√®me | Scope | Priorit√© √©valuation |
|--------|--------------|-------|---------------------|
| Global | `mysql.user` (mysql.global_priv) | `*.*` | 1 (premi√®re) |
| Base | `mysql.db` | `database.*` | 2 |
| Table | `mysql.tables_priv` | `database.table` | 3 |
| Colonne | `mysql.columns_priv` | `database.table.column` | 4 |
| Routine | `mysql.procs_priv` | `PROCEDURE/FUNCTION` | 5 (derni√®re) |

---

## 1. Niveau Global (*.*)

### Caract√©ristiques

Le niveau global s'applique √† **toutes les bases de donn√©es** du serveur, y compris celles cr√©√©es ult√©rieurement.

```sql
-- Syntaxe
GRANT privilege_type ON *.* TO 'user'@'host';
```

### Privil√®ges typiquement globaux

Certains privil√®ges n'ont de sens qu'au niveau global :

| Privil√®ge | Description | Raison |
|-----------|-------------|--------|
| **SUPER** | Op√©rations privil√©gi√©es | Contr√¥le serveur entier |
| **RELOAD** | FLUSH, refresh | Serveur global |
| **SHUTDOWN** | Arr√™ter le serveur | Serveur global |
| **PROCESS** | Voir tous les processus | Serveur global |
| **REPLICATION SLAVE** | R√©plication | Configuration serveur |
| **REPLICATION CLIENT** | Status r√©plication | Monitoring global |
| **CREATE USER** | G√©rer utilisateurs | S√©curit√© globale |
| **SHOW DATABASES** | Lister toutes bases | Serveur global |
| **FILE** | LOAD DATA, SELECT INTO | Syst√®me de fichiers |

üÜï **Nouveaux privil√®ges globaux MariaDB 11.8** :

| Privil√®ge 11.8 | Description | Cas d'usage |
|----------------|-------------|-------------|
| **BACKUP ADMIN** | Op√©rations de sauvegarde | Mariabackup, BACKUP STAGE |
| **BINLOG ADMIN** | Gestion binary logs | Purge, configuration binlog |
| **BINLOG ENCRYPTION ADMIN** | Chiffrement binlog | S√©curit√© binlog |
| **CONNECTION ADMIN** | Bypass max_connections | Admin d'urgence |
| **READ_ONLY ADMIN** | Bypass read_only | Maintenance en read_only |
| **SLAVE MONITOR** | Monitoring r√©plication | Monitoring sans SUPER |

### Exemples d'utilisation

```sql
-- Super-administrateur (√©viter en production)
GRANT ALL PRIVILEGES ON *.* TO 'root'@'localhost' WITH GRANT OPTION;

-- DBA avec privil√®ges administratifs cibl√©s (11.8+)
GRANT SUPER, RELOAD, PROCESS, CREATE USER, BACKUP ADMIN
    ON *.*
    TO 'dba_admin'@'localhost';

-- Compte de sauvegarde optimis√© (11.8)
GRANT BACKUP ADMIN, RELOAD, LOCK TABLES, PROCESS
    ON *.*
    TO 'mariabackup'@'localhost';

-- Monitoring sans privil√®ges excessifs (11.8)
GRANT PROCESS, SLAVE MONITOR, REPLICATION CLIENT
    ON *.*
    TO 'monitoring'@'monitoring-server%';

-- Lecture globale (data warehouse)
GRANT SELECT ON *.* TO 'readonly_global'@'etl-server%';
```

‚ö†Ô∏è **Attention** : Les privil√®ges globaux sont **tr√®s puissants** et persistent m√™me si vous supprimez une base et la recr√©ez. Utilisez-les avec parcimonie.

### Impact sur les bases futures

```sql
-- Un utilisateur avec SELECT global
GRANT SELECT ON *.* TO 'auditor'@'%';

-- Cr√©ation d'une nouvelle base
CREATE DATABASE new_sensitive_db;

-- L'utilisateur a automatiquement SELECT sur new_sensitive_db !
-- Aucun GRANT suppl√©mentaire n√©cessaire
```

üí° **Meilleure pratique** : Pr√©f√©rez les privil√®ges au niveau base pour limiter l'exposition aux futures bases de donn√©es.

---

## 2. Niveau Database (database.*)

### Caract√©ristiques

Privil√®ges sur **toutes les tables** d'une base sp√©cifique, existantes et futures.

```sql
-- Syntaxe
GRANT privilege_type ON database_name.* TO 'user'@'host';
```

### Privil√®ges applicables

Tous les privil√®ges DML et DDL standards :
- **DML** : SELECT, INSERT, UPDATE, DELETE
- **DDL** : CREATE, ALTER, DROP, INDEX
- **Autres** : LOCK TABLES, CREATE TEMPORARY TABLES, REFERENCES, EXECUTE

### Exemples d'utilisation

```sql
-- Application web standard
GRANT SELECT, INSERT, UPDATE, DELETE
    ON webapp_db.*
    TO 'webapp_user'@'app-servers%';

-- D√©veloppeur sur base de d√©veloppement
GRANT ALL PRIVILEGES
    ON dev_db.*
    TO 'developer'@'%';

-- Analyste en lecture seule
GRANT SELECT
    ON analytics_db.*
    TO 'analyst'@'bi-tools%';

-- Application avec proc√©dures stock√©es
GRANT SELECT, INSERT, UPDATE, DELETE, EXECUTE
    ON app_db.*
    TO 'app_user'@'%';
```

### Pattern : S√©paration par environnement

```sql
-- D√©veloppement : privil√®ges √©tendus
GRANT ALL PRIVILEGES ON myapp_dev.* TO 'dev_team'@'%';

-- Staging : lecture/√©criture, pas de DDL
GRANT SELECT, INSERT, UPDATE, DELETE, EXECUTE
    ON myapp_staging.*
    TO 'dev_team'@'%';

-- Production : application uniquement, pas d'acc√®s direct
GRANT SELECT, INSERT, UPDATE, DELETE, EXECUTE
    ON myapp_prod.*
    TO 'app_production'@'app-servers%';
-- dev_team n'a AUCUN privil√®ge sur myapp_prod
```

### Wildcards dans les noms de bases

```sql
-- Toutes les bases commen√ßant par "test_"
GRANT ALL PRIVILEGES ON `test_%`.* TO 'tester'@'%';

-- Attention : le caract√®re '%' doit √™tre √©chapp√© avec des backticks
GRANT SELECT ON `my\_db`.* TO 'user'@'%';  -- Underscore litt√©ral
```

‚ö†Ô∏è **Pi√®ge** : Les wildcards dans les noms de bases sont √©valu√©s √† la connexion. Les bases cr√©√©es apr√®s ne correspondent pas automatiquement au pattern.

---

## 3. Niveau Table (database.table)

### Caract√©ristiques

Privil√®ges sur **une table sp√©cifique** au sein d'une base.

```sql
-- Syntaxe
GRANT privilege_type ON database_name.table_name TO 'user'@'host';
```

### Privil√®ges applicables

- **DML** : SELECT, INSERT, UPDATE, DELETE
- **DDL** : ALTER, DROP, INDEX, CREATE (pour cette table uniquement)
- **Autres** : REFERENCES, TRIGGER

### Cas d'usage : Granularit√© par table

```sql
-- Acc√®s diff√©renci√© par sensibilit√©
-- Table publique : lecture pour tous
GRANT SELECT ON company_db.departments TO 'public_app'@'%';

-- Table sensible : lecture restreinte
GRANT SELECT ON company_db.salaries TO 'hr_manager'@'hr-subnet%';

-- Table de configuration : lecture seule
GRANT SELECT ON app_db.config TO 'app_user'@'%';

-- Table de logs : insertion seule (pas de modification/suppression)
GRANT INSERT ON app_db.audit_log TO 'app_user'@'%';
```

### Pattern : Lecture/√âcriture s√©par√©es

```sql
-- R√©plicas en lecture : acc√®s lecture sur toutes les tables
GRANT SELECT ON orders_db.* TO 'app_reader'@'replica%';

-- Primary en √©criture : toutes op√©rations sauf sur tables sensibles
GRANT SELECT, INSERT, UPDATE, DELETE ON orders_db.* TO 'app_writer'@'primary%';

-- Table d'audit : insertion uniquement, m√™me pour app_writer
REVOKE UPDATE, DELETE ON orders_db.audit_trail FROM 'app_writer'@'primary%';
GRANT INSERT ON orders_db.audit_trail TO 'app_writer'@'primary%';
```

### Combinaison avec privil√®ges de base

```sql
-- Privil√®ge de base par d√©faut
GRANT SELECT ON sales_db.* TO 'sales_viewer'@'%';

-- Exception pour une table sensible
REVOKE SELECT ON sales_db.commission_rates FROM 'sales_viewer'@'%';

-- Ordre d'√©valuation :
-- 1. MariaDB v√©rifie sales_db.* ‚Üí SELECT accord√©
-- 2. MariaDB v√©rifie sales_db.commission_rates ‚Üí SELECT r√©voqu√©
-- R√©sultat : REVOKE au niveau table √âCRASE le GRANT au niveau base
```

‚ö†Ô∏è **Attention** : Un REVOKE au niveau table **ne peut pas** annuler un GRANT au niveau global. Il faut d'abord REVOKE au niveau global.

---

## 4. Niveau Colonne (database.table.column)

### Caract√©ristiques

Le niveau **le plus granulaire** pour les donn√©es tabulaires : privil√®ges sur des colonnes sp√©cifiques.

```sql
-- Syntaxe
GRANT privilege_type (column_list) ON database.table TO 'user'@'host';
```

### Privil√®ges support√©s au niveau colonne

Seuls **SELECT, INSERT, UPDATE** supportent la granularit√© colonne :

| Privil√®ge | Support colonne | Exemples |
|-----------|----------------|----------|
| SELECT | ‚úÖ Oui | `SELECT (col1, col2)` |
| INSERT | ‚úÖ Oui | `INSERT (col1, col2)` |
| UPDATE | ‚úÖ Oui | `UPDATE (col1, col2)` |
| DELETE | ‚ùå Non | S'applique √† la ligne enti√®re |
| ALTER | ‚ùå Non | S'applique √† la table |

### Cas d'usage : Masquage de donn√©es sensibles

```sql
-- Donn√©es RH : acc√®s limit√© aux colonnes non-sensibles
CREATE TABLE hr.employees (
    employee_id INT PRIMARY KEY,
    first_name VARCHAR(50),
    last_name VARCHAR(50),
    email VARCHAR(100),
    department VARCHAR(50),
    salary DECIMAL(10,2),        -- SENSIBLE
    bonus DECIMAL(10,2),          -- SENSIBLE
    ssn CHAR(11),                 -- TR√àS SENSIBLE
    performance_rating INT
);

-- Manager : tout sauf salaire, bonus, SSN
GRANT SELECT (employee_id, first_name, last_name, email,
              department, performance_rating)
    ON hr.employees
    TO 'manager'@'%';

-- RH : tout sauf SSN
GRANT SELECT (employee_id, first_name, last_name, email,
              department, salary, bonus, performance_rating)
    ON hr.employees
    TO 'hr_staff'@'%';

-- Paie : acc√®s complet
GRANT SELECT ON hr.employees TO 'payroll_admin'@'%';
```

### Pattern : Colonnes modifiables vs lecture seule

```sql
-- Utilisateur peut lire toutes les colonnes
GRANT SELECT ON app_db.users TO 'support_agent'@'%';

-- Mais modifier uniquement certains champs
GRANT UPDATE (phone, email, address)
    ON app_db.users
    TO 'support_agent'@'%';

-- Pas de UPDATE sur username, password_hash, created_at, etc.
```

### Limitations et performance

```sql
-- V√©rifier les privil√®ges colonnes accord√©s
SELECT * FROM mysql.columns_priv
WHERE user = 'username' AND table_name = 'employees';

-- R√©sultat :
-- +------+----+-------+-----------+-------------+-------------------+
-- | Host | Db | User  | Table_name| Column_name | Column_priv       |
-- +------+----+-------+-----------+-------------+-------------------+
-- | %    | hr | mgr   | employees | first_name  | Select            |
-- | %    | hr | mgr   | employees | last_name   | Select            |
-- | %    | hr | mgr   | employees | department  | Select,Update     |
-- +------+----+-------+-----------+-------------+-------------------+
```

‚ö†Ô∏è **Limitations importantes** :

1. **Pr√©c√©dence** : Un privil√®ge SELECT au niveau table/base/global √©crase les restrictions colonnes
2. **Performance** : Nombreuses entr√©es dans `mysql.columns_priv` peuvent ralentir l'authentification
3. **Complexit√©** : Difficile √† maintenir pour des tables avec beaucoup de colonnes

üí° **Alternative recommand√©e** : Utilisez des **vues** pour le masquage de donn√©es, plus maintenables et performantes :

```sql
-- Vue pour les managers (colonnes limit√©es)
CREATE VIEW hr.employees_manager_view AS
SELECT employee_id, first_name, last_name, email,
       department, performance_rating
FROM hr.employees;

-- Privil√®ge simple sur la vue
GRANT SELECT ON hr.employees_manager_view TO 'manager'@'%';

-- Pas de privil√®ges sur la table de base
-- REVOKE ALL ON hr.employees FROM 'manager'@'%';
```

---

## 5. Niveau Routine (PROCEDURE/FUNCTION)

### Caract√©ristiques

Privil√®ges sur l'**ex√©cution** de proc√©dures stock√©es et fonctions.

```sql
-- Syntaxe
GRANT EXECUTE ON {PROCEDURE | FUNCTION} db.routine_name TO 'user'@'host';

-- Toutes les routines d'une base
GRANT EXECUTE ON db.* TO 'user'@'host';
```

### EXECUTE : Le privil√®ge cl√©

```sql
-- Fonction de calcul m√©tier
CREATE FUNCTION sales.calculate_discount(amount DECIMAL(10,2))
RETURNS DECIMAL(10,2)
DETERMINISTIC
BEGIN
    RETURN amount * 0.1;
END;

-- Autoriser l'application √† utiliser la fonction
GRANT EXECUTE ON FUNCTION sales.calculate_discount TO 'app_user'@'%';

-- Proc√©dure complexe
CREATE PROCEDURE orders.process_order(IN order_id INT)
SQL SECURITY DEFINER
BEGIN
    -- Logique m√©tier complexe
    -- Modifications de plusieurs tables
END;

-- L'application peut ex√©cuter sans privil√®ges directs sur les tables
GRANT EXECUTE ON PROCEDURE orders.process_order TO 'app_user'@'%';
```

### SQL SECURITY : DEFINER vs INVOKER

Deux modes d'ex√©cution avec implications s√©curit√© importantes :

```sql
-- Mode DEFINER (par d√©faut) : s'ex√©cute avec les privil√®ges du cr√©ateur
CREATE PROCEDURE admin_db.sensitive_operation()
SQL SECURITY DEFINER
BEGIN
    -- S'ex√©cute avec les privil√®ges du DEFINER
    DELETE FROM admin_db.logs WHERE created_at < DATE_SUB(NOW(), INTERVAL 90 DAY);
END;

-- L'utilisateur app_user peut ex√©cuter SANS avoir DELETE sur admin_db.logs
GRANT EXECUTE ON PROCEDURE admin_db.sensitive_operation TO 'app_user'@'%';

-- Mode INVOKER : s'ex√©cute avec les privil√®ges de l'appelant
CREATE PROCEDURE user_db.get_my_data()
SQL SECURITY INVOKER
BEGIN
    -- S'ex√©cute avec les privil√®ges de l'utilisateur qui appelle
    SELECT * FROM user_db.my_table;
END;

-- L'utilisateur doit avoir SELECT sur user_db.my_table
```

| Mode | Privil√®ges utilis√©s | Cas d'usage | Risque |
|------|---------------------|-------------|--------|
| **DEFINER** | Cr√©ateur de la routine | Encapsulation, s√©curit√© | √âl√©vation de privil√®ges |
| **INVOKER** | Utilisateur appelant | Flexibilit√© | D√©pendance aux privil√®ges |

üí° **Pattern de s√©curit√©** : Utilisez DEFINER pour encapsuler des op√©rations sensibles, mais auditez r√©guli√®rement les routines DEFINER pour √©viter les √©l√©vations de privil√®ges non intentionnelles.

### Exemple : API de donn√©es avec privil√®ges minimaux

```sql
-- Table sensible : aucun acc√®s direct
CREATE TABLE company.sensitive_data (
    id INT PRIMARY KEY,
    confidential_info TEXT
);

-- Proc√©dure d'acc√®s contr√¥l√©
CREATE PROCEDURE company.get_authorized_data(IN user_id INT)
SQL SECURITY DEFINER
BEGIN
    -- V√©rifications d'autorisation
    IF (SELECT is_authorized FROM company.users WHERE id = user_id) THEN
        SELECT confidential_info
        FROM company.sensitive_data
        WHERE authorized_user_id = user_id;
    ELSE
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = 'Access denied';
    END IF;
END;

-- L'application n'a QUE le droit d'ex√©cuter la proc√©dure
GRANT EXECUTE ON PROCEDURE company.get_authorized_data TO 'app_user'@'%';

-- Aucun privil√®ge direct sur les tables
-- REVOKE ALL ON company.sensitive_data FROM 'app_user'@'%';
-- REVOKE ALL ON company.users FROM 'app_user'@'%';
```

---

## R√®gles de pr√©c√©dence et d'√©valuation

### Logique d'√©valuation

MariaDB utilise une logique **bool√©enne OR** : si un privil√®ge est accord√© √† **n'importe quel niveau**, il est effectif.

```
Privil√®ge accord√© = Global OR Database OR Table OR Column
```

### Ordre de v√©rification

1. **Privil√®ges globaux** (`mysql.user`)
2. **Privil√®ges de base** (`mysql.db`)
3. **Privil√®ges de table** (`mysql.tables_priv`)
4. **Privil√®ges de colonne** (`mysql.columns_priv`)
5. **Privil√®ges de routine** (`mysql.procs_priv`)

‚ö†Ô∏è **R√®gle critique** : Un privil√®ge √† un niveau sup√©rieur **ne peut PAS √™tre annul√©** par un REVOKE √† un niveau inf√©rieur.

### Sc√©narios d'√©valuation

#### Sc√©nario 1 : Privil√®ge global √©crase tout

```sql
-- Privil√®ge global
GRANT SELECT ON *.* TO 'user'@'%';

-- Tentative de restriction au niveau table
REVOKE SELECT ON secret_db.passwords FROM 'user'@'%';
-- ‚ö†Ô∏è INEFFICACE : le privil√®ge global persiste

-- Solution : r√©voquer au niveau global d'abord
REVOKE SELECT ON *.* FROM 'user'@'%';
-- Puis accorder au niveau n√©cessaire
GRANT SELECT ON public_db.* TO 'user'@'%';
```

#### Sc√©nario 2 : Privil√®ge de base + exception table

```sql
-- Acc√®s lecture √† toute la base
GRANT SELECT ON app_db.* TO 'user'@'%';

-- Tentative de bloquer une table
REVOKE SELECT ON app_db.secrets FROM 'user'@'%';
-- ‚ö†Ô∏è INEFFICACE : le privil√®ge de base persiste

-- Solution correcte : vues ou re-design
-- Option 1 : D√©placer la table sensible dans une autre base
CREATE DATABASE sensitive_db;
ALTER TABLE app_db.secrets RENAME TO sensitive_db.secrets;
-- user n'a pas de privil√®ge sur sensitive_db

-- Option 2 : R√©voquer au niveau base et re-GRANT table par table
REVOKE SELECT ON app_db.* FROM 'user'@'%';
GRANT SELECT ON app_db.table1 TO 'user'@'%';
GRANT SELECT ON app_db.table2 TO 'user'@'%';
-- ... (fastidieux)
```

#### Sc√©nario 3 : Privil√®ges colonnes avec table

```sql
-- Privil√®ge sur certaines colonnes
GRANT SELECT (col1, col2) ON db.table TO 'user'@'%';

-- Ajout d'un privil√®ge table
GRANT SELECT ON db.table TO 'user'@'%';
-- ‚úÖ R√©sultat : l'utilisateur peut maintenant SELECT * (toutes colonnes)

-- Le privil√®ge colonne est "absorb√©" par le privil√®ge table
```

### Matrice de pr√©c√©dence

| Niveau accord√© | Niveau r√©voqu√© | R√©sultat |
|----------------|----------------|----------|
| Global | Base | ‚ùå R√©vocation inefficace |
| Global | Table | ‚ùå R√©vocation inefficace |
| Global | Colonne | ‚ùå R√©vocation inefficace |
| Base | Table | ‚ùå R√©vocation inefficace |
| Base | Colonne | ‚ùå R√©vocation inefficace |
| Table | Colonne | ‚ùå R√©vocation inefficace |
| Table | Table | ‚úÖ R√©vocation effective |
| Base | Base | ‚úÖ R√©vocation effective |

üí° **R√®gle d'or** : Pour r√©voquer efficacement, agissez toujours au **m√™me niveau** ou √† un **niveau sup√©rieur** que le GRANT.

---

## Strat√©gies d'organisation des privil√®ges

### Strat√©gie 1 : Moindre privil√®ge par d√©faut

```sql
-- ‚ùå MAUVAIS : Trop permissif
GRANT ALL PRIVILEGES ON *.* TO 'app_user'@'%';

-- ‚úÖ BON : Minimal et cibl√©
-- Niveau base pour l'application
GRANT SELECT, INSERT, UPDATE, DELETE ON app_db.* TO 'app_user'@'%';

-- Niveau table pour exceptions
GRANT INSERT ON app_db.audit_log TO 'app_user'@'%';
REVOKE UPDATE, DELETE ON app_db.audit_log FROM 'app_user'@'%';

-- Niveau routine pour logique m√©tier
GRANT EXECUTE ON app_db.* TO 'app_user'@'%';
```

### Strat√©gie 2 : S√©paration lecture/√©criture

```sql
-- Utilisateurs lecture seule
CREATE ROLE readonly_role;
GRANT SELECT ON app_db.* TO readonly_role;

-- Utilisateurs lecture/√©criture
CREATE ROLE readwrite_role;
GRANT SELECT, INSERT, UPDATE, DELETE ON app_db.* TO readwrite_role;

-- Assignation
GRANT readonly_role TO 'analyst'@'%';
GRANT readwrite_role TO 'app_writer'@'%';
```

### Strat√©gie 3 : Pyramide invers√©e (moins courant)

```sql
-- Privil√®ge global par d√©faut
GRANT SELECT ON *.* TO 'global_reader'@'%';

-- Exceptions au niveau base (tr√®s rare, g√©n√©ralement d√©conseill√©)
REVOKE SELECT ON secret_db.* FROM 'global_reader'@'%';
-- ‚ö†Ô∏è Cela ne fonctionne PAS avec les r√®gles de pr√©c√©dence !

-- Alternative correcte : ne pas accorder globalement
GRANT SELECT ON public_db1.* TO 'limited_reader'@'%';
GRANT SELECT ON public_db2.* TO 'limited_reader'@'%';
-- Pas de privil√®ge sur secret_db
```

### Strat√©gie 4 : Utilisation de vues pour la granularit√©

```sql
-- Au lieu de privil√®ges colonnes complexes
-- ‚ùå Complexe :
GRANT SELECT (col1, col2, col3) ON db.table TO 'user'@'%';
GRANT UPDATE (col2, col3) ON db.table TO 'user'@'%';

-- ‚úÖ Simple avec vue :
CREATE VIEW db.user_view AS
SELECT col1, col2, col3 FROM db.table;

GRANT SELECT, UPDATE ON db.user_view TO 'user'@'%';

-- Vue updatable automatiquement si crit√®res respect√©s
-- (une seule table, pas de GROUP BY, etc.)
```

---

## Audit et diagnostic

### Identifier le niveau effectif d'un privil√®ge

```sql
-- V√©rifier tous les niveaux pour un utilisateur
-- Niveau global
SELECT user, host, Select_priv, Insert_priv, Update_priv, Delete_priv
FROM mysql.user
WHERE user = 'username' AND host = 'hostname';

-- Niveau base
SELECT db, Select_priv, Insert_priv, Update_priv, Delete_priv
FROM mysql.db
WHERE user = 'username' AND host = 'hostname';

-- Niveau table
SELECT db, table_name, table_priv
FROM mysql.tables_priv
WHERE user = 'username' AND host = 'hostname';

-- Niveau colonne
SELECT db, table_name, column_name, column_priv
FROM mysql.columns_priv
WHERE user = 'username' AND host = 'hostname';

-- Niveau routine
SELECT db, routine_name, routine_type, proc_priv
FROM mysql.procs_priv
WHERE user = 'username' AND host = 'hostname';
```

### Script d'audit complet

```sql
-- Vue consolid√©e des privil√®ges d'un utilisateur
CREATE VIEW security_audit.user_privilege_summary AS
SELECT
    'GLOBAL' AS level,
    '*.*' AS scope,
    u.user,
    u.host,
    CONCAT_WS(',',
        IF(u.Select_priv='Y', 'SELECT', NULL),
        IF(u.Insert_priv='Y', 'INSERT', NULL),
        IF(u.Update_priv='Y', 'UPDATE', NULL),
        IF(u.Delete_priv='Y', 'DELETE', NULL),
        IF(u.Create_priv='Y', 'CREATE', NULL),
        IF(u.Drop_priv='Y', 'DROP', NULL),
        IF(u.Reload_priv='Y', 'RELOAD', NULL),
        IF(u.Shutdown_priv='Y', 'SHUTDOWN', NULL),
        IF(u.Process_priv='Y', 'PROCESS', NULL),
        IF(u.File_priv='Y', 'FILE', NULL),
        IF(u.Grant_priv='Y', 'GRANT', NULL),
        IF(u.Super_priv='Y', 'SUPER', NULL)
    ) AS privileges
FROM mysql.user u
WHERE u.user NOT IN ('', 'root', 'mariadb.sys')

UNION ALL

SELECT
    'DATABASE' AS level,
    CONCAT(d.db, '.*') AS scope,
    d.user,
    d.host,
    CONCAT_WS(',',
        IF(d.Select_priv='Y', 'SELECT', NULL),
        IF(d.Insert_priv='Y', 'INSERT', NULL),
        IF(d.Update_priv='Y', 'UPDATE', NULL),
        IF(d.Delete_priv='Y', 'DELETE', NULL),
        IF(d.Create_priv='Y', 'CREATE', NULL),
        IF(d.Drop_priv='Y', 'DROP', NULL)
    ) AS privileges
FROM mysql.db d
WHERE d.user NOT IN ('', 'root')

UNION ALL

SELECT
    'TABLE' AS level,
    CONCAT(t.db, '.', t.table_name) AS scope,
    t.user,
    t.host,
    t.table_priv AS privileges
FROM mysql.tables_priv t

UNION ALL

SELECT
    'COLUMN' AS level,
    CONCAT(c.db, '.', c.table_name, '.', c.column_name) AS scope,
    c.user,
    c.host,
    c.column_priv AS privileges
FROM mysql.columns_priv c;

-- Utilisation
SELECT * FROM security_audit.user_privilege_summary
WHERE user = 'app_user'
ORDER BY
    CASE level
        WHEN 'GLOBAL' THEN 1
        WHEN 'DATABASE' THEN 2
        WHEN 'TABLE' THEN 3
        WHEN 'COLUMN' THEN 4
    END,
    scope;
```

### D√©tecter les conflits de privil√®ges

```sql
-- Utilisateurs avec privil√®ges globaux ET sp√©cifiques (redondance)
SELECT u.user, u.host, 'Global + Database' AS conflict_type
FROM mysql.user u
INNER JOIN mysql.db d ON u.user = d.user AND u.host = d.host
WHERE u.Select_priv = 'Y' AND d.Select_priv = 'Y';

-- R√©sultat : redondance (le privil√®ge global suffit)
```

---

## Optimisation des performances

### Impact sur l'authentification

```sql
-- Mesurer le temps de v√©rification des privil√®ges
SET profiling = 1;

-- Connexion et requ√™te
-- (dans une autre session)
-- mysql -u testuser -p

SELECT * FROM test_db.test_table LIMIT 1;

-- Analyser
SHOW PROFILES;
SHOW PROFILE FOR QUERY 1;

-- V√©rifier le nombre d'entr√©es dans les tables de privil√®ges
SELECT
    (SELECT COUNT(*) FROM mysql.db) AS db_grants,
    (SELECT COUNT(*) FROM mysql.tables_priv) AS table_grants,
    (SELECT COUNT(*) FROM mysql.columns_priv) AS column_grants;
```

### Recommandations de performance

1. **Privil√©gier les niveaux hauts** : Base > Table > Colonne
2. **Limiter les wildcards** : Privil√®ges explicites plus rapides
3. **√âviter les colonnes_priv excessifs** : Utiliser des vues
4. **Regrouper avec des r√¥les** : R√©duire le nombre d'entr√©es

```sql
-- ‚ùå LENT : 100 utilisateurs √ó 50 tables = 5000 entr√©es
GRANT SELECT ON db.table1 TO 'user1'@'%';
GRANT SELECT ON db.table2 TO 'user1'@'%';
-- ... r√©p√©t√© pour 100 utilisateurs

-- ‚úÖ RAPIDE : 1 r√¥le + 100 assignations = 151 entr√©es
CREATE ROLE db_reader;
GRANT SELECT ON db.* TO db_reader;
GRANT db_reader TO 'user1'@'%', 'user2'@'%', ... 'user100'@'%';
```

---

## ‚úÖ Points cl√©s √† retenir

- MariaDB utilise une **hi√©rarchie √† 5 niveaux** : Global > Database > Table > Colonne > Routine
- Les privil√®ges sont √©valu√©s avec une **logique OR** : si accord√© √† n'importe quel niveau, il est effectif
- Un privil√®ge √† un **niveau sup√©rieur ne peut PAS √™tre r√©voqu√©** par un REVOKE √† niveau inf√©rieur
- Les **nouveaux privil√®ges granulaires 11.8** (BACKUP ADMIN, BINLOG ADMIN, etc.) remplacent SUPER pour la s√©paration des responsabilit√©s
- **Privil√©gier les vues** aux privil√®ges colonnes pour la maintenabilit√© et les performances
- Les **routines DEFINER** permettent l'encapsulation et l'√©l√©vation contr√¥l√©e de privil√®ges
- **Auditez r√©guli√®rement** les privil√®ges avec les tables `mysql.*` et vues syst√®me
- **Optimisez** en utilisant les r√¥les et en privil√©giant les niveaux hauts (base vs table/colonne)

---

## üîó Ressources et r√©f√©rences

- [üìñ Documentation officielle - Privilege Hierarchy](https://mariadb.com/kb/en/grant/#privilege-levels)
- [üìñ MariaDB Privilege System](https://mariadb.com/kb/en/grant/#overview)
- [üìñ System Tables - Privilege Tables](https://mariadb.com/kb/en/the-mysql-database-tables/)
- [üìñ SQL Security DEFINER vs INVOKER](https://mariadb.com/kb/en/create-procedure/#sql-security)
- [üìñ MariaDB 11.8 - Nouveaux privil√®ges granulaires](https://mariadb.com/kb/en/mariadb-1180-release-notes/)

---

## ‚û°Ô∏è Section suivante

**10.4 [R√¥les (CREATE ROLE, SET ROLE, DEFAULT ROLE)](/10-securite-gestion-utilisateurs/04-roles.md)** : Simplifiez la gestion des privil√®ges avec les r√¥les MariaDB, r√©duisez la complexit√© administrative et am√©liorez la s√©curit√©.

‚è≠Ô∏è [R√¥les (CREATE ROLE, SET ROLE, DEFAULT ROLE)](/10-securite-gestion-utilisateurs/04-roles.md)
