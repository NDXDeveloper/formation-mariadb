üîù Retour au [Sommaire](/SOMMAIRE.md)

# 10.7.1 Configuration serveur SSL

> **Niveau** : Avanc√©
> **Dur√©e estim√©e** : 2.5 heures
> **Pr√©requis** : Connaissance de base de SSL/TLS, OpenSSL

## üéØ Objectifs d'apprentissage

√Ä l'issue de cette section, vous serez capable de :
- G√©n√©rer des certificats SSL/TLS pour MariaDB (CA, serveur, client)
- Configurer le chiffrement SSL c√¥t√© serveur
- Forcer l'utilisation de SSL pour les connexions
- Comprendre et appliquer les nouveaut√©s TLS de MariaDB 11.8
- Diagnostiquer et r√©soudre les probl√®mes de connexion SSL
- Mettre en ≈ìuvre les meilleures pratiques de s√©curit√© TLS en production

---

## Introduction

Le chiffrement **SSL/TLS** (Secure Sockets Layer / Transport Layer Security) prot√®ge les communications entre les clients et le serveur MariaDB contre :
- ‚úÖ **L'√©coute clandestine** (*eavesdropping*) : Interception du trafic r√©seau
- ‚úÖ **L'alt√©ration des donn√©es** (*tampering*) : Modification des requ√™tes/r√©ponses en transit
- ‚úÖ **L'usurpation d'identit√©** (*spoofing*) : Connexion √† un faux serveur

üÜï **MariaDB 11.8** : TLS est d√©sormais **activ√© par d√©faut** si des certificats sont pr√©sents, renfor√ßant la s√©curit√© out-of-the-box.

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              Communication SSL/TLS S√©curis√©e                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                               ‚îÇ
‚îÇ  Client ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Tunnel SSL/TLS chiffr√© ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ Serveur  ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  Protection :                                                 ‚îÇ
‚îÇ  ‚Ä¢ Confidentialit√© (chiffrement AES-256)                      ‚îÇ
‚îÇ  ‚Ä¢ Int√©grit√© (signatures)                                     ‚îÇ
‚îÇ  ‚Ä¢ Authentification (certificats X.509)                       ‚îÇ
‚îÇ                                                               ‚îÇ
‚îÇ  Sans SSL :                                                   ‚îÇ
‚îÇ  Client ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Donn√©es en clair (DANGER !) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ Serveur‚îÇ
‚îÇ                                                               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

‚ö†Ô∏è **Production** : SSL/TLS est **obligatoire** pour tout serveur accessible via le r√©seau (hors localhost).

---

## Concepts SSL/TLS pour MariaDB

### Hi√©rarchie des certificats

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Certificat CA (Root)                ‚îÇ
‚îÇ              (Certificate Authority)                 ‚îÇ
‚îÇ         ‚Ä¢ Auto-sign√© OU autorit√© reconnue            ‚îÇ
‚îÇ         ‚Ä¢ Signe les certificats serveur/client       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚îÇ
        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚îÇ                        ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Certificat Serveur ‚îÇ  ‚îÇ Certificat Client ‚îÇ
‚îÇ  ‚Ä¢ CN = hostname   ‚îÇ  ‚îÇ  ‚Ä¢ CN = username  ‚îÇ
‚îÇ  ‚Ä¢ Sign√© par CA    ‚îÇ  ‚îÇ  ‚Ä¢ Sign√© par CA   ‚îÇ
‚îÇ  ‚Ä¢ Serveur pr√©sente‚îÇ  ‚îÇ  ‚Ä¢ Client pr√©sente‚îÇ
‚îÇ    aux clients     ‚îÇ  ‚îÇ    au serveur     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Composants n√©cessaires

| Fichier | R√¥le | Requis | Stockage |
|---------|------|--------|----------|
| **CA certificate** (ca-cert.pem) | Certificat de l'autorit√© de certification | ‚úÖ Oui | Serveur + Clients |
| **Server certificate** (server-cert.pem) | Certificat du serveur MariaDB | ‚úÖ Oui | Serveur uniquement |
| **Server key** (server-key.pem) | Cl√© priv√©e du serveur | ‚úÖ Oui | Serveur uniquement (secret) |
| **Client certificate** (client-cert.pem) | Certificat du client (optionnel) | ‚ö†Ô∏è Pour auth cert | Client uniquement |
| **Client key** (client-key.pem) | Cl√© priv√©e du client (optionnel) | ‚ö†Ô∏è Pour auth cert | Client uniquement (secret) |

---

## G√©n√©ration des certificats

### Option 1 : Certificats auto-sign√©s (d√©veloppement/test)

#### √âtape 1 : Cr√©er une CA (Certificate Authority)

```bash
# R√©pertoire pour les certificats
sudo mkdir -p /etc/mysql/ssl
cd /etc/mysql/ssl

# G√©n√©rer la cl√© priv√©e de la CA (4096 bits)
sudo openssl genrsa 4096 > ca-key.pem

# G√©n√©rer le certificat CA auto-sign√© (valide 3650 jours = 10 ans)
sudo openssl req -new -x509 -nodes -days 3650 \
    -key ca-key.pem \
    -out ca-cert.pem \
    -subj "/C=FR/ST=IDF/L=Paris/O=MyCompany/OU=Database/CN=MariaDB-CA"

# R√©sultat : ca-key.pem (cl√© priv√©e CA) + ca-cert.pem (certificat CA)
```

üí° **Param√®tres du subject** :
- C = Country (FR)
- ST = State (Ile-de-France)
- L = Locality (Paris)
- O = Organization (MyCompany)
- OU = Organizational Unit (Database)
- CN = Common Name (MariaDB-CA)

#### √âtape 2 : Cr√©er le certificat serveur

```bash
# G√©n√©rer la cl√© priv√©e du serveur
sudo openssl genrsa 4096 > server-key.pem

# Cr√©er une demande de signature (CSR)
sudo openssl req -new -key server-key.pem -out server-req.pem \
    -subj "/C=FR/ST=IDF/L=Paris/O=MyCompany/OU=Database/CN=mariadb-server.example.com"
#                                                              ‚Üë
#                                          IMPORTANT : CN = hostname du serveur

# Signer le certificat serveur avec la CA
sudo openssl x509 -req -in server-req.pem \
    -days 3650 \
    -CA ca-cert.pem \
    -CAkey ca-key.pem \
    -set_serial 01 \
    -out server-cert.pem

# Nettoyer le CSR (plus n√©cessaire)
sudo rm server-req.pem

# R√©sultat : server-key.pem (cl√© priv√©e) + server-cert.pem (certificat)
```

‚ö†Ô∏è **Critique** : Le **CN** (Common Name) du certificat serveur **doit correspondre** au hostname utilis√© pour se connecter.

#### √âtape 3 : Cr√©er le certificat client (optionnel)

```bash
# G√©n√©rer la cl√© priv√©e du client
sudo openssl genrsa 4096 > client-key.pem

# Cr√©er une demande de signature
sudo openssl req -new -key client-key.pem -out client-req.pem \
    -subj "/C=FR/ST=IDF/L=Paris/O=MyCompany/OU=Database/CN=mariadb-client"

# Signer le certificat client avec la CA
sudo openssl x509 -req -in client-req.pem \
    -days 3650 \
    -CA ca-cert.pem \
    -CAkey ca-key.pem \
    -set_serial 02 \
    -out client-cert.pem

# Nettoyer
sudo rm client-req.pem

# R√©sultat : client-key.pem + client-cert.pem
```

#### √âtape 4 : S√©curiser les permissions

```bash
# Permissions strictes pour les cl√©s priv√©es
sudo chmod 400 ca-key.pem server-key.pem client-key.pem

# Propri√©taire mysql pour les fichiers serveur
sudo chown mysql:mysql ca-cert.pem server-cert.pem server-key.pem

# Permissions lecture pour les certificats publics
sudo chmod 444 ca-cert.pem server-cert.pem client-cert.pem

# V√©rifier
ls -l /etc/mysql/ssl/
# -r-------- 1 root  root  3272 Dec 13 10:00 ca-key.pem
# -r--r--r-- 1 mysql mysql 1956 Dec 13 10:00 ca-cert.pem
# -r-------- 1 mysql mysql 3272 Dec 13 10:00 server-key.pem
# -r--r--r-- 1 mysql mysql 1956 Dec 13 10:00 server-cert.pem
# -r-------- 1 root  root  3272 Dec 13 10:00 client-key.pem
# -r--r--r-- 1 root  root  1956 Dec 13 10:00 client-cert.pem
```

### Option 2 : Let's Encrypt (production)

Pour les serveurs accessibles publiquement, utilisez Let's Encrypt pour des certificats reconnus :

```bash
# Installer Certbot
sudo apt-get install -y certbot

# Obtenir un certificat (DNS-01 ou HTTP-01 challenge)
sudo certbot certonly --standalone -d mariadb.example.com

# Certificats g√©n√©r√©s dans :
# /etc/letsencrypt/live/mariadb.example.com/
# - fullchain.pem (CA + certificat serveur)
# - privkey.pem (cl√© priv√©e)
# - cert.pem (certificat serveur uniquement)
# - chain.pem (CA uniquement)

# Cr√©er des liens symboliques pour MariaDB
sudo ln -s /etc/letsencrypt/live/mariadb.example.com/fullchain.pem /etc/mysql/ssl/server-cert.pem
sudo ln -s /etc/letsencrypt/live/mariadb.example.com/privkey.pem /etc/mysql/ssl/server-key.pem
sudo ln -s /etc/letsencrypt/live/mariadb.example.com/chain.pem /etc/mysql/ssl/ca-cert.pem

# Permissions
sudo chown mysql:mysql /etc/mysql/ssl/*.pem
```

‚ö†Ô∏è **Renouvellement** : Les certificats Let's Encrypt expirent tous les 90 jours. Configurez le renouvellement automatique (voir section d√©di√©e).

### V√©rifier les certificats g√©n√©r√©s

```bash
# V√©rifier le certificat CA
openssl x509 -in /etc/mysql/ssl/ca-cert.pem -text -noout
# Subject: C=FR, ST=IDF, L=Paris, O=MyCompany, OU=Database, CN=MariaDB-CA
# Validity
#     Not Before: Dec 13 10:00:00 2025 GMT
#     Not After : Dec 10 10:00:00 2035 GMT

# V√©rifier le certificat serveur
openssl x509 -in /etc/mysql/ssl/server-cert.pem -text -noout
# Subject: C=FR, ST=IDF, L=Paris, O=MyCompany, OU=Database, CN=mariadb-server.example.com
# Issuer: C=FR, ST=IDF, L=Paris, O=MyCompany, OU=Database, CN=MariaDB-CA

# V√©rifier que le certificat serveur est sign√© par la CA
openssl verify -CAfile /etc/mysql/ssl/ca-cert.pem /etc/mysql/ssl/server-cert.pem
# /etc/mysql/ssl/server-cert.pem: OK
```

---

## Configuration MariaDB serveur

### Configuration my.cnf

```ini
# /etc/mysql/my.cnf ou /etc/mysql/mariadb.conf.d/50-server.cnf
[mysqld]

# ===== SSL/TLS Configuration =====

# Activer SSL (par d√©faut depuis 11.8 si certificats pr√©sents)
ssl = 1

# Certificat de l'autorit√© de certification
ssl_ca = /etc/mysql/ssl/ca-cert.pem

# Certificat du serveur
ssl_cert = /etc/mysql/ssl/server-cert.pem

# Cl√© priv√©e du serveur
ssl_key = /etc/mysql/ssl/server-key.pem

# Protocoles TLS autoris√©s (s√©curit√© moderne)
# TLSv1.2 et TLSv1.3 uniquement (TLSv1.0 et TLSv1.1 obsol√®tes)
tls_version = TLSv1.2,TLSv1.3

# Algorithmes de chiffrement (ciphersuites)
# Liste s√©curis√©e compatible 2025
ssl_cipher = ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384

# üÜï MariaDB 11.8 : Forcer SSL pour toutes les connexions
# (Sauf localhost via socket Unix)
require_secure_transport = ON

# Optionnel : V√©rifier les certificats clients
# ssl_verify_server_cert = ON
```

üí° **Ciphersuites recommand√©es 2025** :
- **ECDHE** : √âchange de cl√©s avec perfect forward secrecy
- **AES-GCM** : Chiffrement authentifi√© moderne
- **CHACHA20-POLY1305** : Alternative performante sur mobile
- ‚ùå **√âviter** : DES, 3DES, RC4, MD5 (cass√©s ou obsol√®tes)

### Configuration minimale (d√©veloppement)

```ini
# Configuration minimale SSL
[mysqld]
ssl_ca   = /etc/mysql/ssl/ca-cert.pem
ssl_cert = /etc/mysql/ssl/server-cert.pem
ssl_key  = /etc/mysql/ssl/server-key.pem
```

### Red√©marrer MariaDB

```bash
# Red√©marrer pour appliquer la configuration
sudo systemctl restart mariadb

# V√©rifier le statut
sudo systemctl status mariadb

# V√©rifier les logs pour d'√©ventuelles erreurs SSL
sudo tail -f /var/log/mysql/error.log | grep -i ssl
```

---

## V√©rification de la configuration SSL

### V√©rifier que SSL est actif

```sql
-- Se connecter au serveur
mysql -u root -p

-- V√©rifier les variables SSL
SHOW VARIABLES LIKE '%ssl%';

-- Variables importantes :
-- have_ssl: YES (SSL disponible)
-- ssl_ca: /etc/mysql/ssl/ca-cert.pem
-- ssl_cert: /etc/mysql/ssl/server-cert.pem
-- ssl_key: /etc/mysql/ssl/server-key.pem

-- V√©rifier les protocoles TLS
SHOW VARIABLES LIKE 'tls_version';
-- tls_version: TLSv1.2,TLSv1.3

-- V√©rifier les ciphersuites
SHOW VARIABLES LIKE 'ssl_cipher';
-- ssl_cipher: ECDHE-ECDSA-AES128-GCM-SHA256:...

-- üÜï V√©rifier require_secure_transport (11.8)
SHOW VARIABLES LIKE 'require_secure_transport';
-- require_secure_transport: ON
```

### V√©rifier les informations de connexion SSL

```sql
-- Informations SSL de la session courante
SHOW STATUS LIKE 'Ssl%';

-- Variables importantes :
-- Ssl_cipher: ECDHE-RSA-AES256-GCM-SHA384
-- Ssl_version: TLSv1.3
-- Ssl_session_cache_mode: SERVER
```

### Test de connexion client avec SSL

```bash
# Connexion avec SSL
mysql -u root -p \
    --ssl-ca=/etc/mysql/ssl/ca-cert.pem \
    --ssl-mode=REQUIRED

# V√©rifier dans la session MySQL
mysql> \s
# SSL: Cipher in use is ECDHE-RSA-AES256-GCM-SHA384

# Ou avec query
mysql> SHOW STATUS LIKE 'Ssl_cipher';
-- +---------------+-----------------------------+
-- | Variable_name | Value                       |
-- +---------------+-----------------------------+
-- | Ssl_cipher    | ECDHE-RSA-AES256-GCM-SHA384 |
-- +---------------+-----------------------------+
```

---

## Forcer SSL pour les utilisateurs

### REQUIRE SSL (obligatoire pour l'utilisateur)

```sql
-- Cr√©er un utilisateur avec SSL obligatoire
CREATE USER 'secure_user'@'%'
    IDENTIFIED BY 'SecureP@ss123'
    REQUIRE SSL;

-- Modifier un utilisateur existant
ALTER USER 'existing_user'@'%'
    REQUIRE SSL;

-- V√©rifier
SELECT user, host, ssl_type
FROM mysql.user
WHERE user = 'secure_user';
-- ssl_type: ANY (SSL requis, tout type de certificat accept√©)
```

### REQUIRE X509 (certificat client obligatoire)

```sql
-- Utilisateur doit pr√©senter un certificat client valide
CREATE USER 'cert_user'@'%'
    IDENTIFIED BY 'P@ssw0rd'
    REQUIRE X509;

-- ssl_type: X509 (certificat client requis)
```

### REQUIRE SUBJECT (certificat avec subject sp√©cifique)

```sql
-- Utilisateur doit pr√©senter un certificat avec subject exact
CREATE USER 'specific_user'@'%'
    IDENTIFIED BY 'P@ssw0rd'
    REQUIRE SUBJECT '/C=FR/ST=IDF/L=Paris/O=MyCompany/OU=Database/CN=mariadb-client';

-- ssl_type: SPECIFIED
-- ssl_cipher: (vide)
-- x509_issuer: (vide)
-- x509_subject: /C=FR/ST=IDF/L=Paris/O=MyCompany/OU=Database/CN=mariadb-client
```

### REQUIRE ISSUER (certificat sign√© par CA sp√©cifique)

```sql
-- Certificat doit √™tre sign√© par une CA sp√©cifique
CREATE USER 'ca_user'@'%'
    IDENTIFIED BY 'P@ssw0rd'
    REQUIRE ISSUER '/C=FR/ST=IDF/L=Paris/O=MyCompany/OU=Database/CN=MariaDB-CA';
```

### REQUIRE CIPHER (algorithme de chiffrement sp√©cifique)

```sql
-- Forcer un algorithme de chiffrement sp√©cifique
CREATE USER 'strong_cipher_user'@'%'
    IDENTIFIED BY 'P@ssw0rd'
    REQUIRE CIPHER 'ECDHE-RSA-AES256-GCM-SHA384';
```

### Combinaison de contraintes

```sql
-- Combinaison de plusieurs contraintes
CREATE USER 'ultra_secure_user'@'%'
    IDENTIFIED BY 'P@ssw0rd'
    REQUIRE SSL AND CIPHER 'ECDHE-RSA-AES256-GCM-SHA384'
    AND SUBJECT '/C=FR/ST=IDF/L=Paris/O=MyCompany/OU=Database/CN=admin-client';
```

### üÜï MariaDB 11.8 : require_secure_transport global

```sql
-- Forcer SSL pour TOUS les utilisateurs (sauf localhost)
SET GLOBAL require_secure_transport = ON;

-- Persister dans my.cnf
```

```ini
# my.cnf
[mysqld]
require_secure_transport = ON
```

üí° **Diff√©rence** :
- `REQUIRE SSL` par utilisateur : Granulaire, sp√©cifique √† chaque compte
- `require_secure_transport` global : S'applique √† tous, sauf exceptions (socket Unix)

---

## Bonnes pratiques de s√©curit√© SSL

### 1. Protocoles TLS modernes uniquement

```ini
# my.cnf
[mysqld]
# ‚ùå MAUVAIS : Autoriser TLSv1.0 et TLSv1.1 (obsol√®tes, vuln√©rables)
# tls_version = TLSv1.0,TLSv1.1,TLSv1.2,TLSv1.3

# ‚úÖ BON : TLSv1.2 et TLSv1.3 uniquement
tls_version = TLSv1.2,TLSv1.3
```

### 2. Ciphersuites s√©curis√©es

```ini
# ‚úÖ BON : Liste de ciphersuites modernes
ssl_cipher = ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305

# ‚ùå √âVITER : Ciphersuites faibles ou obsol√®tes
# - DES, 3DES (cl√©s courtes)
# - RC4 (cass√©)
# - MD5 (collisions)
# - Export ciphers (tr√®s faibles)
```

### 3. Cl√©s RSA de 2048 bits minimum

```bash
# ‚ùå MAUVAIS : Cl√© 1024 bits (trop faible)
# openssl genrsa 1024 > server-key.pem

# ‚úÖ BON : Cl√© 4096 bits (recommand√© 2025)
openssl genrsa 4096 > server-key.pem

# OU : Courbes elliptiques (alternative performante)
openssl ecparam -genkey -name secp384r1 -out server-ec-key.pem
```

### 4. Renouvellement r√©gulier des certificats

```bash
#!/bin/bash
# renew_ssl_certs.sh
# Renouveler les certificats avant expiration (90 jours avant)

CERT_FILE="/etc/mysql/ssl/server-cert.pem"
DAYS_BEFORE_EXPIRY=90

# V√©rifier la date d'expiration
EXPIRY_DATE=$(openssl x509 -in "$CERT_FILE" -noout -enddate | cut -d= -f2)
EXPIRY_EPOCH=$(date -d "$EXPIRY_DATE" +%s)
CURRENT_EPOCH=$(date +%s)
DAYS_LEFT=$(( ($EXPIRY_EPOCH - $CURRENT_EPOCH) / 86400 ))

if [ $DAYS_LEFT -lt $DAYS_BEFORE_EXPIRY ]; then
    echo "Certificate expires in $DAYS_LEFT days. Renewing..."

    # Renouveler avec Let's Encrypt
    sudo certbot renew

    # Red√©marrer MariaDB
    sudo systemctl reload mariadb

    echo "Certificate renewed successfully."
else
    echo "Certificate valid for $DAYS_LEFT days. No renewal needed."
fi
```

```bash
# Automatiser avec cron (v√©rification quotidienne)
sudo crontab -e
# 0 2 * * * /usr/local/bin/renew_ssl_certs.sh >> /var/log/ssl-renewal.log 2>&1
```

### 5. Audit SSL p√©riodique

```sql
-- Script d'audit SSL
SELECT
    user,
    host,
    ssl_type,
    ssl_cipher,
    x509_issuer,
    x509_subject
FROM mysql.user
WHERE ssl_type != ''
ORDER BY ssl_type, user;

-- Utilisateurs sans SSL requis (potentiel risque)
SELECT user, host
FROM mysql.user
WHERE ssl_type = ''
  AND host != 'localhost'
  AND user NOT IN ('root', 'mariadb.sys', '');
```

### 6. Monitoring des connexions SSL

```sql
-- V√©rifier les connexions actives
SELECT
    id,
    user,
    host,
    db,
    command,
    time,
    state
FROM information_schema.processlist
ORDER BY time DESC;

-- Statistiques SSL
SHOW STATUS LIKE 'Ssl%';
-- Ssl_accepts: 1234 (connexions SSL accept√©es)
-- Ssl_finished_accepts: 1230 (handshakes r√©ussis)
-- Ssl_client_connects: 1230 (connexions clientes SSL)
-- Ssl_cipher_list: ... (algorithmes disponibles)
```

---

## D√©pannage SSL

### Probl√®me 1 : "SSL connection error"

```bash
# Sympt√¥me
mysql -u user -p --ssl-mode=REQUIRED
# ERROR 2026 (HY000): SSL connection error: error:...

# Diagnostic 1 : V√©rifier les certificats serveur
sudo ls -l /etc/mysql/ssl/
# V√©rifier que tous les fichiers existent et ont les bonnes permissions

# Diagnostic 2 : V√©rifier les logs
sudo tail -f /var/log/mysql/error.log | grep -i ssl

# Diagnostic 3 : Tester avec OpenSSL
openssl s_client -connect mariadb-server.example.com:3306 -starttls mysql
# Affiche les d√©tails de la connexion SSL

# Causes courantes :
# - Certificat expir√©
# - CN ne correspond pas au hostname
# - Permissions incorrectes sur server-key.pem
# - Certificat non sign√© par la CA
```

### Probl√®me 2 : "Certificate verification failed"

```bash
# Sympt√¥me
mysql -u user -p \
    --ssl-ca=/path/to/ca-cert.pem \
    --ssl-mode=VERIFY_CA
# ERROR 2026 (HY000): SSL connection error: certificate verification failed

# Diagnostic : V√©rifier la cha√Æne de certificats
openssl verify -CAfile /etc/mysql/ssl/ca-cert.pem /etc/mysql/ssl/server-cert.pem
# /etc/mysql/ssl/server-cert.pem: OK

# Si erreur : "unable to get local issuer certificate"
# ‚Üí Le certificat serveur n'est pas sign√© par la CA fournie

# Solution : R√©g√©n√©rer le certificat serveur avec la bonne CA
```

### Probl√®me 3 : "Hostname mismatch"

```bash
# Sympt√¥me
mysql -u user -p -h 192.168.1.100 --ssl-mode=VERIFY_IDENTITY
# ERROR 2026 (HY000): SSL connection error: hostname mismatch

# Cause : Le CN du certificat serveur ne correspond pas √† l'h√¥te de connexion
# Certificat CN: mariadb-server.example.com
# Connexion √† : 192.168.1.100 (IP)

# Solution 1 : Se connecter avec le hostname exact
mysql -u user -p -h mariadb-server.example.com --ssl-mode=VERIFY_IDENTITY

# Solution 2 : Utiliser --ssl-mode=VERIFY_CA (v√©rifie CA mais pas hostname)
mysql -u user -p -h 192.168.1.100 --ssl-mode=VERIFY_CA

# Solution 3 : R√©g√©n√©rer le certificat avec SAN (Subject Alternative Names)
```

### Probl√®me 4 : Performance d√©grad√©e

```bash
# Sympt√¥me : Connexions lentes avec SSL

# Diagnostic : Mesurer le temps de handshake
time mysql -u user -p -h server --ssl-mode=REQUIRED -e "SELECT 1"
# Comparer avec sans SSL

# Causes possibles :
# - Cl√© RSA trop longue (8192 bits) ‚Üí Utiliser 4096 bits
# - Ciphersuite faible (DHE sans PFS) ‚Üí Utiliser ECDHE
# - Session cache d√©sactiv√©

# Solution : Activer SSL session cache
```

```ini
# my.cnf
[mysqld]
ssl_session_cache_mode = SERVER
ssl_session_cache_timeout = 300  # 5 minutes
```

### Probl√®me 5 : Certificat expir√©

```bash
# V√©rifier l'expiration
openssl x509 -in /etc/mysql/ssl/server-cert.pem -noout -dates
# notBefore=Dec 13 10:00:00 2025 GMT
# notAfter=Dec 10 10:00:00 2035 GMT

# Si expir√© : R√©g√©n√©rer les certificats
# (voir section G√©n√©ration des certificats)

# Recharger sans red√©marrage (MariaDB 10.4+)
mysql -u root -p -e "ALTER INSTANCE RELOAD TLS"
```

---

## Modes SSL client

| Mode | Comportement | V√©rification |
|------|--------------|--------------|
| **DISABLED** | Pas de SSL (m√™me si serveur le supporte) | ‚ùå Aucune |
| **PREFERRED** | SSL si disponible, sinon en clair | ‚ö†Ô∏è Opportuniste |
| **REQUIRED** | SSL obligatoire | ‚úÖ Chiffrement |
| **VERIFY_CA** | SSL + v√©rifier CA | ‚úÖ Chiffrement + CA |
| **VERIFY_IDENTITY** | SSL + v√©rifier CA + hostname | ‚úÖ Chiffrement + CA + CN |

```bash
# DISABLED : Pas de SSL
mysql -u user -p --ssl-mode=DISABLED

# PREFERRED : SSL si disponible (par d√©faut)
mysql -u user -p

# REQUIRED : SSL obligatoire
mysql -u user -p --ssl-mode=REQUIRED

# VERIFY_CA : V√©rifier la CA
mysql -u user -p \
    --ssl-ca=/etc/mysql/ssl/ca-cert.pem \
    --ssl-mode=VERIFY_CA

# VERIFY_IDENTITY : V√©rifier CA + hostname
mysql -u user -p \
    --ssl-ca=/etc/mysql/ssl/ca-cert.pem \
    --ssl-mode=VERIFY_IDENTITY
```

üí° **Production** : Utilisez toujours `VERIFY_IDENTITY` pour la s√©curit√© maximale.

---

## üÜï Nouveaut√©s MariaDB 11.8

### 1. TLS activ√© par d√©faut

```ini
# MariaDB 11.8 : Si des certificats SSL sont pr√©sents,
# TLS est automatiquement activ√© (pas besoin de ssl=1)

# Ancienne version (< 11.8)
[mysqld]
ssl = 1  # Obligatoire pour activer SSL
ssl_ca = /etc/mysql/ssl/ca-cert.pem
ssl_cert = /etc/mysql/ssl/server-cert.pem
ssl_key = /etc/mysql/ssl/server-key.pem

# MariaDB 11.8+
[mysqld]
# ssl = 1  ‚Üê Plus n√©cessaire !
ssl_ca = /etc/mysql/ssl/ca-cert.pem
ssl_cert = /etc/mysql/ssl/server-cert.pem
ssl_key = /etc/mysql/ssl/server-key.pem
```

### 2. require_secure_transport par d√©faut recommand√©

```ini
# üÜï Nouvelle recommandation : Forcer SSL pour toutes connexions
[mysqld]
require_secure_transport = ON

# Exceptions : localhost via socket Unix (non affect√©)
```

### 3. Support TLSv1.3 am√©lior√©

```ini
# MariaDB 11.8 : Support natif et optimis√© de TLSv1.3
[mysqld]
tls_version = TLSv1.3  # TLSv1.3 uniquement pour s√©curit√© maximale

# Ou combinaison TLSv1.2 + TLSv1.3 pour compatibilit√©
tls_version = TLSv1.2,TLSv1.3
```

### 4. Ciphersuites TLS 1.3

```ini
# TLS 1.3 utilise des ciphersuites diff√©rentes (plus s√©curis√©es)
[mysqld]
tls_version = TLSv1.3

# Ciphersuites TLS 1.3 (configur√©es s√©par√©ment)
tls_ciphersuites = TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256
```

---

## Checklist de production

### Avant la mise en production

- [ ] Certificats g√©n√©r√©s avec cl√©s 4096 bits minimum
- [ ] Certificat serveur CN correspond au hostname
- [ ] Permissions fichiers correctes (400 pour cl√©s priv√©es)
- [ ] TLS 1.2 et 1.3 uniquement (pas de TLS 1.0/1.1)
- [ ] Ciphersuites s√©curis√©es configur√©es
- [ ] `require_secure_transport = ON` activ√©
- [ ] Utilisateurs externes avec `REQUIRE SSL`
- [ ] Tests de connexion SSL r√©ussis
- [ ] Renouvellement automatique configur√© (Let's Encrypt)
- [ ] Monitoring SSL en place
- [ ] Documentation des proc√©dures d'urgence

### Monitoring continu

```sql
-- Script de monitoring quotidien
-- 1. V√©rifier expiration certificats (alerte 30 jours avant)
-- 2. V√©rifier connexions SSL actives
-- 3. Auditer utilisateurs sans SSL requis
-- 4. Analyser les erreurs SSL dans les logs
```

---

## ‚úÖ Points cl√©s √† retenir

- **SSL/TLS** prot√®ge contre l'√©coute, l'alt√©ration et l'usurpation d'identit√©
- **3 composants** : CA certificate, Server certificate + key
- **G√©n√©ration** : OpenSSL pour auto-sign√©, Let's Encrypt pour production publique
- **Configuration** : my.cnf avec ssl_ca, ssl_cert, ssl_key, tls_version, ssl_cipher
- **üÜï MariaDB 11.8** : TLS activ√© par d√©faut si certificats pr√©sents, `require_secure_transport` recommand√©
- **Forcer SSL** : `REQUIRE SSL` par utilisateur OU `require_secure_transport` global
- **TLS modernes** : TLSv1.2 et TLSv1.3 uniquement (bannir TLSv1.0/1.1)
- **Ciphersuites** : ECDHE + AES-GCM ou CHACHA20-POLY1305
- **Permissions critiques** : Cl√©s priv√©es en 400, propri√©taire mysql
- **Renouvellement** : Automatiser avec Let's Encrypt (90 jours) ou scripts cron

---

## üîó Ressources et r√©f√©rences

- [üìñ Documentation officielle - Using TLS/SSL](https://mariadb.com/kb/en/secure-connections-overview/)
- [üìñ SSL Configuration Parameters](https://mariadb.com/kb/en/ssltls-system-variables/)
- [üìñ MariaDB 11.8 Release Notes - TLS Enhancements](https://mariadb.com/kb/en/mariadb-1180-release-notes/)
- [üìñ OpenSSL documentation](https://www.openssl.org/docs/)
- [üìñ Let's Encrypt](https://letsencrypt.org/docs/)
- [Blog : SSL/TLS Best Practices for MariaDB](https://mariadb.org/ssl-tls-best-practices/)

---

## ‚û°Ô∏è Section suivante

**10.7.2 [Certificats et CA](/10-securite-gestion-utilisateurs/07.2-certificats-ca.md)** : Approfondissez la gestion des certificats, les cha√Ænes de confiance, les SAN (Subject Alternative Names) et l'int√©gration avec des PKI d'entreprise.

‚è≠Ô∏è [Certificats et CA](/10-securite-gestion-utilisateurs/07.2-certificats-ca.md)
