üîù Retour au [Sommaire](/SOMMAIRE.md)

# 10.7.2 Certificats et CA

> **Niveau** : Avanc√©
> **Dur√©e estim√©e** : 2.5 heures
> **Pr√©requis** : Section 10.7.1 (Configuration serveur SSL), connaissance PKI et X.509

## üéØ Objectifs d'apprentissage

√Ä l'issue de cette section, vous serez capable de :
- Comprendre en profondeur la structure des certificats X.509
- G√©rer des cha√Ænes de certificats complexes (Root CA, Intermediate CA)
- Configurer des Subject Alternative Names (SAN) pour multi-domaines
- Int√©grer MariaDB avec une PKI d'entreprise existante
- Impl√©menter des strat√©gies de rotation et r√©vocation de certificats
- Diagnostiquer les probl√®mes de cha√Æne de certificats

---

## Introduction

Les **certificats X.509** et les **Certificate Authorities (CA)** forment l'infrastructure de cl√©s publiques (PKI - Public Key Infrastructure) qui sous-tend SSL/TLS. Une compr√©hension approfondie de leur structure et gestion est essentielle pour :

- ‚úÖ S√©curiser les communications MariaDB en production
- ‚úÖ Int√©grer MariaDB dans l'infrastructure de s√©curit√© d'entreprise
- ‚úÖ G√©rer le cycle de vie des certificats (cr√©ation, renouvellement, r√©vocation)
- ‚úÖ R√©soudre les probl√®mes complexes de validation de certificats

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              Hi√©rarchie PKI (Public Key Infrastructure)     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                             ‚îÇ
‚îÇ  Root CA (Autorit√© racine)                                  ‚îÇ
‚îÇ  ‚Ä¢ Auto-sign√©e                                              ‚îÇ
‚îÇ  ‚Ä¢ Stock√©e hors ligne (air-gapped)                          ‚îÇ
‚îÇ  ‚Ä¢ Dur√©e de vie : 10-20 ans                                 ‚îÇ
‚îÇ          ‚Üì                                                  ‚îÇ
‚îÇ  Intermediate CA (Autorit√© interm√©diaire)                   ‚îÇ
‚îÇ  ‚Ä¢ Sign√©e par Root CA                                       ‚îÇ
‚îÇ  ‚Ä¢ Utilis√©e pour signer les certificats d'entit√©            ‚îÇ
‚îÇ  ‚Ä¢ Dur√©e de vie : 3-5 ans                                   ‚îÇ
‚îÇ          ‚Üì                                                  ‚îÇ
‚îÇ  End-Entity Certificates (Certificats serveur/client)       ‚îÇ
‚îÇ  ‚Ä¢ Sign√©s par Intermediate CA                               ‚îÇ
‚îÇ  ‚Ä¢ MariaDB Server, MariaDB Clients                          ‚îÇ
‚îÇ  ‚Ä¢ Dur√©e de vie : 1-2 ans                                   ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  Avantages hi√©rarchie :                                     ‚îÇ
‚îÇ  ‚Ä¢ S√©curit√© : Root CA hors ligne                            ‚îÇ
‚îÇ  ‚Ä¢ R√©vocation : Intermediate CA r√©vocable sans affecter Root‚îÇ
‚îÇ  ‚Ä¢ D√©l√©gation : Intermediate CA pour d√©partements           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Structure d'un certificat X.509

### Anatomie d'un certificat

```bash
# Examiner un certificat en d√©tail
openssl x509 -in server-cert.pem -text -noout

# Sortie (simplifi√©) :
```

```
Certificate:
    Data:
        Version: 3 (0x2)                           ‚Üê Version X.509
        Serial Number: 1 (0x1)                     ‚Üê Num√©ro unique
        Signature Algorithm: sha256WithRSAEncryption
        Issuer: C=FR, ST=IDF, O=MyCompany, CN=MariaDB-CA    ‚Üê √âmetteur (CA)
        Validity
            Not Before: Dec 13 10:00:00 2025 GMT   ‚Üê Date d√©but validit√©
            Not After : Dec 10 10:00:00 2035 GMT   ‚Üê Date fin validit√©
        Subject: C=FR, ST=IDF, O=MyCompany, CN=mariadb-server.example.com  ‚Üê Titulaire
        Subject Public Key Info:                   ‚Üê Cl√© publique
            Public Key Algorithm: rsaEncryption
                RSA Public-Key: (4096 bit)
        X509v3 extensions:                         ‚Üê Extensions
            X509v3 Subject Alternative Name:       ‚Üê SAN (multi-domaines)
                DNS:mariadb-server.example.com
                DNS:mariadb.example.com
                IP Address:192.168.1.100
            X509v3 Key Usage: critical
                Digital Signature, Key Encipherment
            X509v3 Extended Key Usage:
                TLS Web Server Authentication
    Signature Algorithm: sha256WithRSAEncryption  ‚Üê Signature de la CA
         ab:cd:ef:12:...
```

### Champs cl√©s

| Champ | Description | Importance |
|-------|-------------|------------|
| **Subject** | Identit√© du titulaire (DN) | CN doit correspondre au hostname |
| **Issuer** | Identit√© de la CA √©mettrice | Cha√Æne de confiance |
| **Validity** | P√©riode de validit√© | Renouvellement avant expiration |
| **Public Key** | Cl√© publique RSA/ECDSA | Taille minimum 2048 bits |
| **Signature** | Signature de la CA | V√©rification authenticit√© |
| **SAN** | Noms alternatifs (extension) | Multi-domaines, IP |
| **Key Usage** | Utilisation autoris√©e | Digital Signature, Key Encipherment |

### Distinguished Name (DN)

Le **DN** (Distinguished Name) identifie de mani√®re unique le titulaire ou l'√©metteur :

```
Subject DN: /C=FR/ST=IDF/L=Paris/O=MyCompany/OU=Database/CN=mariadb-server.example.com

Composants :
‚Ä¢ C  = Country (FR)
‚Ä¢ ST = State/Province (Ile-de-France)
‚Ä¢ L  = Locality (Paris)
‚Ä¢ O  = Organization (MyCompany)
‚Ä¢ OU = Organizational Unit (Database)
‚Ä¢ CN = Common Name (mariadb-server.example.com) ‚Üê Le plus critique
```

üí° **CN (Common Name)** : Doit correspondre **exactement** au hostname utilis√© pour se connecter au serveur MariaDB.

---

## Cha√Ænes de certificats (Certificate Chains)

### Concept de cha√Æne de confiance

Une **cha√Æne de certificats** est une s√©quence ordonn√©e de certificats o√π chacun signe le suivant, remontant jusqu'√† un certificat racine de confiance.

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Cha√Æne de confiance                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                             ‚îÇ
‚îÇ  1. Root CA Certificate (auto-sign√©)                        ‚îÇ
‚îÇ     Issuer: CN=Root CA                                      ‚îÇ
‚îÇ     Subject: CN=Root CA                                     ‚îÇ
‚îÇ          ‚Üì signe                                            ‚îÇ
‚îÇ  2. Intermediate CA Certificate                             ‚îÇ
‚îÇ     Issuer: CN=Root CA                                      ‚îÇ
‚îÇ     Subject: CN=Intermediate CA                             ‚îÇ
‚îÇ          ‚Üì signe                                            ‚îÇ
‚îÇ  3. Server Certificate                                      ‚îÇ
‚îÇ     Issuer: CN=Intermediate CA                              ‚îÇ
‚îÇ     Subject: CN=mariadb-server.example.com                  ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  Validation par le client :                                 ‚îÇ
‚îÇ  ‚Ä¢ Client a Root CA dans son truststore                     ‚îÇ
‚îÇ  ‚Ä¢ Serveur envoie [Server Cert + Intermediate Cert]         ‚îÇ
‚îÇ  ‚Ä¢ Client v√©rifie : Server Cert ‚Üê Intermediate ‚Üê Root CA    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Cr√©er une hi√©rarchie CA compl√®te

#### √âtape 1 : Root CA (autorit√© racine)

```bash
# Cr√©er le r√©pertoire pour la Root CA
mkdir -p /root/ca
cd /root/ca

# Structure de r√©pertoires
mkdir certs crl newcerts private
chmod 700 private
touch index.txt
echo 1000 > serial

# Configuration OpenSSL pour Root CA
cat > openssl-root-ca.cnf <<EOF
[ ca ]
default_ca = CA_default

[ CA_default ]
dir               = /root/ca
certs             = \$dir/certs
crl_dir           = \$dir/crl
new_certs_dir     = \$dir/newcerts
database          = \$dir/index.txt
serial            = \$dir/serial
RANDFILE          = \$dir/private/.rand

private_key       = \$dir/private/ca-key.pem
certificate       = \$dir/certs/ca-cert.pem

crlnumber         = \$dir/crlnumber
crl               = \$dir/crl/ca-crl.pem
crl_extensions    = crl_ext
default_crl_days  = 30

default_md        = sha256

name_opt          = ca_default
cert_opt          = ca_default
default_days      = 3650
preserve          = no
policy            = policy_strict

[ policy_strict ]
countryName             = match
stateOrProvinceName     = match
organizationName        = match
organizationalUnitName  = optional
commonName              = supplied
emailAddress            = optional

[ req ]
default_bits        = 4096
distinguished_name  = req_distinguished_name
string_mask         = utf8only
default_md          = sha256
x509_extensions     = v3_ca

[ req_distinguished_name ]
countryName                     = Country Name (2 letter code)
stateOrProvinceName             = State or Province Name
localityName                    = Locality Name
0.organizationName              = Organization Name
organizationalUnitName          = Organizational Unit Name
commonName                      = Common Name
emailAddress                    = Email Address

[ v3_ca ]
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid:always,issuer
basicConstraints = critical, CA:true
keyUsage = critical, digitalSignature, cRLSign, keyCertSign
EOF

# G√©n√©rer la cl√© priv√©e Root CA (4096 bits)
openssl genrsa -aes256 -out private/ca-key.pem 4096
# Entrer un mot de passe fort (√† stocker en lieu s√ªr)

chmod 400 private/ca-key.pem

# G√©n√©rer le certificat Root CA auto-sign√© (20 ans)
openssl req -config openssl-root-ca.cnf \
      -key private/ca-key.pem \
      -new -x509 -days 7300 -sha256 -extensions v3_ca \
      -out certs/ca-cert.pem \
      -subj "/C=FR/ST=IDF/L=Paris/O=MyCompany/OU=Security/CN=MyCompany Root CA"

chmod 444 certs/ca-cert.pem

# V√©rifier le certificat Root CA
openssl x509 -noout -text -in certs/ca-cert.pem
```

‚ö†Ô∏è **S√©curit√© Root CA** : La cl√© priv√©e de la Root CA doit √™tre stock√©e **hors ligne** (air-gapped) et prot√©g√©e par un mot de passe fort. Ne jamais la mettre sur un serveur connect√© au r√©seau.

#### √âtape 2 : Intermediate CA (autorit√© interm√©diaire)

```bash
# Cr√©er le r√©pertoire pour l'Intermediate CA
mkdir -p /root/ca/intermediate
cd /root/ca/intermediate

mkdir certs crl csr newcerts private
chmod 700 private
touch index.txt
echo 1000 > serial
echo 1000 > crlnumber

# Configuration OpenSSL pour Intermediate CA
cat > openssl-intermediate-ca.cnf <<EOF
[ ca ]
default_ca = CA_default

[ CA_default ]
dir               = /root/ca/intermediate
certs             = \$dir/certs
crl_dir           = \$dir/crl
new_certs_dir     = \$dir/newcerts
database          = \$dir/index.txt
serial            = \$dir/serial
RANDFILE          = \$dir/private/.rand

private_key       = \$dir/private/intermediate-key.pem
certificate       = \$dir/certs/intermediate-cert.pem

crlnumber         = \$dir/crlnumber
crl               = \$dir/crl/intermediate-crl.pem
crl_extensions    = crl_ext
default_crl_days  = 30

default_md        = sha256

name_opt          = ca_default
cert_opt          = ca_default
default_days      = 1825  # 5 ans
preserve          = no
policy            = policy_loose

[ policy_loose ]
countryName             = optional
stateOrProvinceName     = optional
localityName            = optional
organizationName        = optional
organizationalUnitName  = optional
commonName              = supplied
emailAddress            = optional

[ req ]
default_bits        = 4096
distinguished_name  = req_distinguished_name
string_mask         = utf8only
default_md          = sha256

[ req_distinguished_name ]
countryName                     = Country Name (2 letter code)
stateOrProvinceName             = State or Province Name
localityName                    = Locality Name
0.organizationName              = Organization Name
organizationalUnitName          = Organizational Unit Name
commonName                      = Common Name
emailAddress                    = Email Address

[ v3_intermediate_ca ]
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid:always,issuer
basicConstraints = critical, CA:true, pathlen:0
keyUsage = critical, digitalSignature, cRLSign, keyCertSign

[ server_cert ]
basicConstraints = CA:FALSE
nsCertType = server
nsComment = "MariaDB Server Certificate"
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid,issuer:always
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth
EOF

# G√©n√©rer la cl√© priv√©e Intermediate CA
openssl genrsa -aes256 -out private/intermediate-key.pem 4096

chmod 400 private/intermediate-key.pem

# Cr√©er la demande de signature (CSR) pour Intermediate CA
openssl req -config openssl-intermediate-ca.cnf \
      -new -sha256 \
      -key private/intermediate-key.pem \
      -out csr/intermediate-csr.pem \
      -subj "/C=FR/ST=IDF/L=Paris/O=MyCompany/OU=Security/CN=MyCompany Intermediate CA"

# Signer le certificat Intermediate avec Root CA
cd /root/ca
openssl ca -config openssl-root-ca.cnf \
      -extensions v3_intermediate_ca \
      -days 1825 -notext -md sha256 \
      -in intermediate/csr/intermediate-csr.pem \
      -out intermediate/certs/intermediate-cert.pem

chmod 444 intermediate/certs/intermediate-cert.pem

# V√©rifier le certificat Intermediate
openssl x509 -noout -text -in intermediate/certs/intermediate-cert.pem

# V√©rifier la cha√Æne de certificats
openssl verify -CAfile certs/ca-cert.pem \
      intermediate/certs/intermediate-cert.pem
# intermediate/certs/intermediate-cert.pem: OK
```

#### √âtape 3 : Certificat serveur MariaDB

```bash
cd /root/ca/intermediate

# G√©n√©rer la cl√© priv√©e du serveur
openssl genrsa -out private/mariadb-server-key.pem 4096

chmod 400 private/mariadb-server-key.pem

# Cr√©er la CSR du serveur
openssl req -config openssl-intermediate-ca.cnf \
      -key private/mariadb-server-key.pem \
      -new -sha256 -out csr/mariadb-server-csr.pem \
      -subj "/C=FR/ST=IDF/L=Paris/O=MyCompany/OU=Database/CN=mariadb-server.example.com"

# Signer le certificat serveur avec Intermediate CA
openssl ca -config openssl-intermediate-ca.cnf \
      -extensions server_cert \
      -days 730 -notext -md sha256 \
      -in csr/mariadb-server-csr.pem \
      -out certs/mariadb-server-cert.pem

chmod 444 certs/mariadb-server-cert.pem

# V√©rifier la cha√Æne compl√®te
openssl verify -CAfile ../certs/ca-cert.pem \
      -untrusted certs/intermediate-cert.pem \
      certs/mariadb-server-cert.pem
# certs/mariadb-server-cert.pem: OK
```

#### √âtape 4 : Cr√©er le bundle de certificats (chain file)

```bash
# Cr√©er le bundle : Server + Intermediate
cat certs/mariadb-server-cert.pem \
    certs/intermediate-cert.pem \
    > certs/mariadb-server-chain.pem

# Le bundle contient (dans l'ordre) :
# 1. Certificat du serveur
# 2. Certificat Intermediate CA

# V√©rifier le bundle
openssl verify -CAfile ../certs/ca-cert.pem certs/mariadb-server-chain.pem
```

#### √âtape 5 : D√©ployer sur MariaDB

```bash
# Copier les fichiers sur le serveur MariaDB
sudo cp /root/ca/intermediate/certs/mariadb-server-chain.pem /etc/mysql/ssl/server-cert.pem
sudo cp /root/ca/intermediate/private/mariadb-server-key.pem /etc/mysql/ssl/server-key.pem
sudo cp /root/ca/certs/ca-cert.pem /etc/mysql/ssl/ca-cert.pem

# Permissions
sudo chown mysql:mysql /etc/mysql/ssl/*
sudo chmod 400 /etc/mysql/ssl/server-key.pem
sudo chmod 444 /etc/mysql/ssl/server-cert.pem /etc/mysql/ssl/ca-cert.pem
```

```ini
# my.cnf
[mysqld]
ssl_ca   = /etc/mysql/ssl/ca-cert.pem
ssl_cert = /etc/mysql/ssl/server-cert.pem
ssl_key  = /etc/mysql/ssl/server-key.pem
```

---

## Subject Alternative Names (SAN)

### Pourquoi utiliser SAN ?

Les **Subject Alternative Names** permettent √† un seul certificat de couvrir **plusieurs noms de domaine et adresses IP** :

```
Certificat avec SAN :
  Subject: CN=mariadb-server.example.com

  X509v3 Subject Alternative Name:
    DNS:mariadb-server.example.com    ‚Üê Hostname principal
    DNS:mariadb.example.com           ‚Üê Alias DNS
    DNS:db.example.com                ‚Üê Autre alias
    DNS:mariadb-prod.internal         ‚Üê Nom interne
    IP Address:192.168.1.100          ‚Üê IPv4
    IP Address:10.0.0.50              ‚Üê IPv4 interne
    IP Address:2001:db8::1            ‚Üê IPv6

Connexions accept√©es :
‚Ä¢ mysql -h mariadb-server.example.com --ssl-mode=VERIFY_IDENTITY ‚úÖ
‚Ä¢ mysql -h mariadb.example.com --ssl-mode=VERIFY_IDENTITY        ‚úÖ
‚Ä¢ mysql -h 192.168.1.100 --ssl-mode=VERIFY_IDENTITY              ‚úÖ
```

### Cr√©er un certificat avec SAN

```bash
# Cr√©er un fichier de configuration SAN
cat > san.cnf <<EOF
[req]
default_bits = 4096
distinguished_name = req_distinguished_name
req_extensions = v3_req
prompt = no

[req_distinguished_name]
C = FR
ST = IDF
L = Paris
O = MyCompany
OU = Database
CN = mariadb-server.example.com

[v3_req]
keyUsage = keyEncipherment, dataEncipherment
extendedKeyUsage = serverAuth
subjectAltName = @alt_names

[alt_names]
DNS.1 = mariadb-server.example.com
DNS.2 = mariadb.example.com
DNS.3 = db.example.com
DNS.4 = mariadb-prod.internal
IP.1 = 192.168.1.100
IP.2 = 10.0.0.50
IP.3 = 2001:db8::1
EOF

# G√©n√©rer la cl√© priv√©e
openssl genrsa -out mariadb-san-key.pem 4096

# Cr√©er la CSR avec SAN
openssl req -new -key mariadb-san-key.pem \
      -out mariadb-san-csr.pem \
      -config san.cnf

# Signer avec l'Intermediate CA
cd /root/ca/intermediate

# Modifier openssl-intermediate-ca.cnf pour copier les extensions
# Ajouter : copy_extensions = copy

openssl ca -config openssl-intermediate-ca.cnf \
      -extensions v3_req \
      -extfile /path/to/san.cnf \
      -days 730 -notext -md sha256 \
      -in /path/to/mariadb-san-csr.pem \
      -out certs/mariadb-san-cert.pem

# V√©rifier les SAN
openssl x509 -in certs/mariadb-san-cert.pem -text -noout | grep -A 10 "Subject Alternative Name"
```

üí° **Best practice** : Utilisez toujours SAN m√™me avec un seul domaine, car le CN (Common Name) est d√©pr√©ci√© dans les navigateurs modernes (depuis 2017).

---

## Int√©gration PKI d'entreprise

### Sc√©nario : Int√©gration avec Microsoft AD CS

**Microsoft Active Directory Certificate Services (AD CS)** est la PKI d'entreprise courante.

#### √âtape 1 : Exporter le certificat Root CA d'AD CS

```powershell
# Sur le serveur AD CS (Windows PowerShell)
# Exporter le certificat Root CA
certutil -ca.cert C:\temp\ad-root-ca.cer

# Transf√©rer sur le serveur MariaDB (Linux)
```

```bash
# Sur le serveur MariaDB (Linux)
# Convertir DER vers PEM si n√©cessaire
openssl x509 -inform DER -in ad-root-ca.cer -out ad-root-ca.pem

# Installer le certificat Root CA
sudo cp ad-root-ca.pem /etc/mysql/ssl/ca-cert.pem
sudo chmod 444 /etc/mysql/ssl/ca-cert.pem
```

#### √âtape 2 : Demander un certificat serveur via AD CS

**Option A : Interface web AD CS**

1. Acc√©der √† `https://ca-server.example.com/certsrv`
2. Demander un certificat > Requ√™te avanc√©e
3. Coller la CSR g√©n√©r√©e sur Linux
4. T√©l√©charger le certificat au format Base64

**Option B : Ligne de commande (certreq)**

```bash
# Sur le serveur MariaDB (Linux)
# G√©n√©rer la cl√© et CSR
openssl req -new -newkey rsa:4096 -nodes \
      -keyout /etc/mysql/ssl/server-key.pem \
      -out mariadb-server.csr \
      -subj "/C=US/ST=State/L=City/O=MyCompany/OU=IT/CN=mariadb-server.example.com"

# Transf√©rer mariadb-server.csr vers Windows
```

```powershell
# Sur le serveur AD CS (Windows)
# Soumettre la CSR
certreq -submit -attrib "CertificateTemplate:WebServer" mariadb-server.csr

# T√©l√©charger le certificat √©mis (format Base64)
# Transf√©rer vers le serveur MariaDB
```

```bash
# Sur le serveur MariaDB (Linux)
sudo cp issued-cert.cer /etc/mysql/ssl/server-cert.pem
```

#### √âtape 3 : Configuration MariaDB avec AD CS

```ini
# my.cnf
[mysqld]
ssl_ca   = /etc/mysql/ssl/ca-cert.pem         # Root CA d'AD CS
ssl_cert = /etc/mysql/ssl/server-cert.pem      # Certificat √©mis par AD CS
ssl_key  = /etc/mysql/ssl/server-key.pem       # Cl√© priv√©e
```

### Int√©gration avec HashiCorp Vault

```bash
# Utiliser Vault comme PKI
# 1. Activer le moteur PKI dans Vault
vault secrets enable pki

# 2. Configurer la Root CA
vault write pki/root/generate/internal \
    common_name="My Company Root CA" \
    ttl=87600h

# 3. G√©n√©rer un certificat pour MariaDB
vault write pki/issue/mariadb-role \
    common_name="mariadb-server.example.com" \
    ttl="8760h" \
    format=pem > mariadb-cert.json

# Extraire les certificats
jq -r '.data.certificate' mariadb-cert.json > /etc/mysql/ssl/server-cert.pem
jq -r '.data.private_key' mariadb-cert.json > /etc/mysql/ssl/server-key.pem
jq -r '.data.ca_chain[]' mariadb-cert.json > /etc/mysql/ssl/ca-cert.pem

# Permissions
sudo chown mysql:mysql /etc/mysql/ssl/*
sudo chmod 400 /etc/mysql/ssl/server-key.pem
```

---

## Rotation et renouvellement de certificats

### Strat√©gie de rotation

```bash
#!/bin/bash
# rotate-mariadb-certs.sh
# Rotation automatique des certificats MariaDB

CERT_FILE="/etc/mysql/ssl/server-cert.pem"
KEY_FILE="/etc/mysql/ssl/server-key.pem"
CA_FILE="/etc/mysql/ssl/ca-cert.pem"
BACKUP_DIR="/etc/mysql/ssl/backup"
DAYS_BEFORE_EXPIRY=30

# V√©rifier la date d'expiration
EXPIRY_DATE=$(openssl x509 -in "$CERT_FILE" -noout -enddate | cut -d= -f2)
EXPIRY_EPOCH=$(date -d "$EXPIRY_DATE" +%s)
CURRENT_EPOCH=$(date +%s)
DAYS_LEFT=$(( ($EXPIRY_EPOCH - $CURRENT_EPOCH) / 86400 ))

if [ $DAYS_LEFT -lt $DAYS_BEFORE_EXPIRY ]; then
    echo "Certificate expires in $DAYS_LEFT days. Rotating..."

    # Backup des certificats actuels
    mkdir -p "$BACKUP_DIR"
    cp "$CERT_FILE" "$BACKUP_DIR/server-cert-$(date +%Y%m%d).pem"
    cp "$KEY_FILE" "$BACKUP_DIR/server-key-$(date +%Y%m%d).pem"

    # G√©n√©rer une nouvelle CSR
    openssl req -new -key "$KEY_FILE" -out /tmp/server.csr \
        -subj "/C=FR/ST=IDF/L=Paris/O=MyCompany/OU=Database/CN=mariadb-server.example.com"

    # Signer avec l'Intermediate CA (√† adapter selon votre PKI)
    # Option 1 : Let's Encrypt
    # certbot renew

    # Option 2 : PKI interne
    # openssl ca -config ca.cnf -in /tmp/server.csr -out "$CERT_FILE"

    # Option 3 : AD CS (API)
    # curl -X POST https://ca-server/api/issue -d @/tmp/server.csr > "$CERT_FILE"

    # Recharger MariaDB sans red√©marrage (10.4+)
    mysql -u root -p -e "ALTER INSTANCE RELOAD TLS"

    echo "Certificate rotated successfully."

    # Notifier (email, Slack, etc.)
    echo "MariaDB certificate rotated" | mail -s "Certificate Renewal" admin@example.com
else
    echo "Certificate valid for $DAYS_LEFT days. No rotation needed."
fi

# Nettoyer les anciens backups (> 1 an)
find "$BACKUP_DIR" -name "*.pem" -mtime +365 -delete
```

### Renouvellement avec Let's Encrypt

```bash
# Cr√©er un hook post-renouvellement
cat > /etc/letsencrypt/renewal-hooks/deploy/mariadb-reload.sh <<'EOF'
#!/bin/bash
# Hook ex√©cut√© apr√®s renouvellement Let's Encrypt

# Copier les nouveaux certificats
cp /etc/letsencrypt/live/mariadb.example.com/fullchain.pem /etc/mysql/ssl/server-cert.pem
cp /etc/letsencrypt/live/mariadb.example.com/privkey.pem /etc/mysql/ssl/server-key.pem

# Permissions
chown mysql:mysql /etc/mysql/ssl/*.pem
chmod 400 /etc/mysql/ssl/server-key.pem

# Recharger MariaDB
mysql -u root -p"$(cat /root/.mysql_root_password)" -e "ALTER INSTANCE RELOAD TLS"

# Log
echo "$(date): MariaDB certificates reloaded" >> /var/log/mariadb-cert-renewal.log
EOF

chmod +x /etc/letsencrypt/renewal-hooks/deploy/mariadb-reload.sh

# Tester le renouvellement
certbot renew --dry-run
```

---

## R√©vocation de certificats

### Certificate Revocation List (CRL)

```bash
# G√©n√©rer une CRL (Certificate Revocation List)
cd /root/ca/intermediate

# R√©voquer un certificat
openssl ca -config openssl-intermediate-ca.cnf \
      -revoke certs/mariadb-compromised-cert.pem \
      -crl_reason keyCompromise

# G√©n√©rer la CRL
openssl ca -config openssl-intermediate-ca.cnf \
      -gencrl -out crl/intermediate-crl.pem

# Publier la CRL (HTTP/FTP)
sudo cp crl/intermediate-crl.pem /var/www/html/crl/

# Configurer MariaDB pour v√©rifier la CRL
```

```ini
# my.cnf
[mysqld]
ssl_ca   = /etc/mysql/ssl/ca-cert.pem
ssl_cert = /etc/mysql/ssl/server-cert.pem
ssl_key  = /etc/mysql/ssl/server-key.pem

# Activer la v√©rification CRL
ssl_crl = /etc/mysql/ssl/crl/intermediate-crl.pem
```

‚ö†Ô∏è **Performance** : La v√©rification CRL peut impacter les performances. Pr√©f√©rez OCSP pour les grandes infrastructures.

### OCSP (Online Certificate Status Protocol)

OCSP offre une v√©rification en temps r√©el de l'√©tat des certificats (plus moderne que CRL).

```bash
# Configurer un r√©pondeur OCSP
openssl ocsp -index /root/ca/intermediate/index.txt \
      -port 2560 \
      -rsigner /root/ca/intermediate/certs/intermediate-cert.pem \
      -rkey /root/ca/intermediate/private/intermediate-key.pem \
      -CA /root/ca/certs/ca-cert.pem \
      -text

# Tester OCSP
openssl ocsp -CAfile /etc/mysql/ssl/ca-cert.pem \
      -url http://ocsp.example.com:2560 \
      -resp_text \
      -issuer /root/ca/intermediate/certs/intermediate-cert.pem \
      -cert /etc/mysql/ssl/server-cert.pem
```

üí° **Note** : MariaDB ne supporte pas nativement OCSP stapling. La v√©rification OCSP doit √™tre effectu√©e c√¥t√© client ou via un reverse proxy.

---

## Bonnes pratiques de gestion CA

### 1. Hi√©rarchie √† plusieurs niveaux

```
‚úÖ BON : Hi√©rarchie √† 3 niveaux
Root CA (hors ligne, 20 ans)
  ‚Üì
Intermediate CA (semi-offline, 5 ans)
  ‚Üì
Server/Client Certificates (online, 1-2 ans)

‚ùå MAUVAIS : Root CA signe directement les certificats serveurs
Root CA (online)
  ‚Üì
Server Certificates
```

### 2. S√©paration des cl√©s

```bash
# ‚úÖ BON : Cl√©s priv√©es s√©par√©es pour chaque certificat
server-key.pem       # 4096 bits RSA
client-key.pem       # 4096 bits RSA
intermediate-key.pem # 4096 bits RSA, prot√©g√©e par mot de passe
root-ca-key.pem      # 4096 bits RSA, stock√©e hors ligne

# ‚ùå MAUVAIS : R√©utiliser la m√™me cl√© priv√©e
shared-key.pem  # Utilis√©e pour serveur ET client (risque √©lev√©)
```

### 3. Dur√©e de vie appropri√©e

| Type de certificat | Dur√©e recommand√©e | Justification |
|--------------------|-------------------|---------------|
| **Root CA** | 10-20 ans | Rarement modifi√©, distribution co√ªteuse |
| **Intermediate CA** | 3-5 ans | Balance s√©curit√©/maintenance |
| **Server** | 1-2 ans | Rotation r√©guli√®re, limite exposition |
| **Client** | 1 an | Rotation fr√©quente, utilisateurs mobiles |

### 4. Stockage s√©curis√©

```bash
# Root CA : HSM (Hardware Security Module) ou offline storage
# Cl√© jamais accessible via r√©seau

# Intermediate CA : Serveur d√©di√©, acc√®s restreint
sudo chmod 400 /root/ca/intermediate/private/intermediate-key.pem
sudo chown root:root /root/ca/intermediate/private/intermediate-key.pem

# Logs d'acc√®s
sudo auditctl -w /root/ca/intermediate/private/intermediate-key.pem -p rwa -k ca_key_access
```

### 5. Audit et conformit√©

```bash
# V√©rifier tous les certificats √©mis
cd /root/ca/intermediate
cat index.txt

# Format : status expiry_date serial subject
# V	261213100000Z	1000	unknown	/C=FR/ST=IDF/O=MyCompany/CN=mariadb-server.example.com
# R	261213100000Z	20251214100000Z,keyCompromise	1001	unknown	/C=FR/.../CN=compromised

# G√©n√©rer un rapport
awk -F'\t' '{print $1, $4, $6}' index.txt | column -t
```

---

## Diagnostic et d√©pannage

### Probl√®me 1 : Cha√Æne de certificats incompl√®te

```bash
# Sympt√¥me
mysql -u user -p --ssl-mode=VERIFY_CA
# ERROR 2026: SSL connection error: unable to get local issuer certificate

# Diagnostic : V√©rifier la cha√Æne
openssl s_client -connect mariadb-server.example.com:3306 -starttls mysql
# depth=0 C=FR, ST=IDF, O=MyCompany, CN=mariadb-server.example.com
# verify error:num=20:unable to get local issuer certificate
# ‚Üë Le certificat Intermediate n'est pas envoy√© par le serveur

# Solution : Cr√©er un bundle avec la cha√Æne compl√®te
cat server-cert.pem intermediate-cert.pem > server-chain.pem

# Configurer MariaDB avec le bundle
```

```ini
# my.cnf
[mysqld]
ssl_cert = /etc/mysql/ssl/server-chain.pem  # Bundle complet
```

### Probl√®me 2 : Certificat expir√© dans la cha√Æne

```bash
# V√©rifier chaque certificat de la cha√Æne
openssl storeutl -noout -text -certs /etc/mysql/ssl/server-chain.pem

# V√©rifier les dates
openssl x509 -in /etc/mysql/ssl/ca-cert.pem -noout -dates
# notAfter=Dec 10 10:00:00 2025 GMT ‚Üê Expir√© !

# Solution : Renouveler le certificat expir√© dans la hi√©rarchie
```

### Probl√®me 3 : SAN non reconnu

```bash
# Sympt√¥me
mysql -h 192.168.1.100 --ssl-mode=VERIFY_IDENTITY
# ERROR 2026: SSL connection error: hostname mismatch

# Diagnostic : V√©rifier les SAN
openssl x509 -in /etc/mysql/ssl/server-cert.pem -text -noout | grep -A 5 "Subject Alternative Name"
# X509v3 Subject Alternative Name:
#     DNS:mariadb-server.example.com
# ‚Üë Pas d'IP Address !

# Solution : R√©g√©n√©rer le certificat avec SAN incluant l'IP
# (voir section SAN ci-dessus)
```

---

## ‚úÖ Points cl√©s √† retenir

- **Certificat X.509** : Structure standard avec Subject, Issuer, Validity, Public Key, Signature, Extensions
- **Cha√Æne de certificats** : Root CA ‚Üí Intermediate CA ‚Üí Server Certificate (validation par remont√©e)
- **Hi√©rarchie PKI** : Root CA hors ligne, Intermediate CA pour signature, s√©paration s√©curit√©/op√©rationnel
- **SAN (Subject Alternative Names)** : Multi-domaines et IPs dans un seul certificat
- **PKI d'entreprise** : Int√©gration avec AD CS, HashiCorp Vault, ou CA internes
- **Rotation** : Automatiser le renouvellement 30-90 jours avant expiration
- **R√©vocation** : CRL (liste de r√©vocation) ou OCSP (v√©rification temps r√©el)
- **Dur√©e de vie** : Root CA 10-20 ans, Intermediate 3-5 ans, Server 1-2 ans
- **Stockage s√©curis√©** : Root CA hors ligne (HSM), cl√©s priv√©es prot√©g√©es (chmod 400)
- **Bundle de certificats** : Serveur doit envoyer sa cha√Æne compl√®te (server + intermediate)

---

## üîó Ressources et r√©f√©rences

- [üìñ RFC 5280 - X.509 Certificate and CRL Profile](https://tools.ietf.org/html/rfc5280)
- [üìñ OpenSSL Certificate Authority](https://jamielinux.com/docs/openssl-certificate-authority/)
- [üìñ MariaDB SSL/TLS Documentation](https://mariadb.com/kb/en/secure-connections-overview/)
- [üìñ Let's Encrypt Documentation](https://letsencrypt.org/docs/)
- [üìñ Microsoft AD CS Documentation](https://learn.microsoft.com/en-us/windows-server/identity/ad-cs/)
- [Blog : Best Practices for Certificate Management](https://mariadb.org/certificate-management-best-practices/)

---

## ‚û°Ô∏è Section suivante

**10.7.3 [TLS par d√©faut depuis 11.8](/10-securite-gestion-utilisateurs/07.3-tls-defaut-11-8.md)** üÜï : D√©couvrez les changements majeurs de MariaDB 11.8 concernant TLS, l'activation automatique, les nouvelles configurations par d√©faut et l'impact sur les d√©ploiements existants.

‚è≠Ô∏è [TLS par d√©faut depuis 11.8](/10-securite-gestion-utilisateurs/07.3-tls-defaut-11-8.md)
