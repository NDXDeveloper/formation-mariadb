ğŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 10.8.1 Server Audit Plugin

> **Niveau** : AvancÃ©
> **DurÃ©e estimÃ©e** : 2 heures
> **PrÃ©requis** : Connaissance de base des logs systÃ¨me, notions de conformitÃ©

## ğŸ¯ Objectifs d'apprentissage

Ã€ l'issue de cette section, vous serez capable de :
- Installer et configurer le Server Audit Plugin de MariaDB
- Auditer les connexions, requÃªtes et Ã©vÃ©nements critiques
- Filtrer et optimiser l'audit pour la performance
- IntÃ©grer les logs d'audit avec des systÃ¨mes SIEM
- Mettre en conformitÃ© avec les rÃ©glementations (PCI-DSS, HIPAA, RGPD)
- Diagnostiquer et rÃ©soudre les problÃ¨mes d'audit

---

## Introduction

Le **Server Audit Plugin** est le plugin d'audit officiel de MariaDB, permettant d'enregistrer l'activitÃ© du serveur pour :

- âœ… **ConformitÃ© rÃ©glementaire** : PCI-DSS, HIPAA, SOX, RGPD, ISO 27001
- âœ… **DÃ©tection d'intrusion** : ActivitÃ©s suspectes, tentatives d'accÃ¨s non autorisÃ©es
- âœ… **Investigation forensique** : TraÃ§abilitÃ© complÃ¨te des opÃ©rations
- âœ… **Monitoring de sÃ©curitÃ©** : Identification des comportements anormaux
- âœ… **Audit interne** : ContrÃ´le des accÃ¨s et opÃ©rations sensibles

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Server Audit Plugin - Architecture            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Client â”€â”€â”€â”€â”€â”€â–º MariaDB Server                              â”‚
â”‚                     â”‚                                       â”‚
â”‚                     â”œâ”€â”€â–º Server Audit Plugin                â”‚
â”‚                     â”‚         â†“                             â”‚
â”‚                     â”‚    [Filtrage]                         â”‚
â”‚                     â”‚         â†“                             â”‚
â”‚                     â”‚    [Formatage]                        â”‚
â”‚                     â”‚         â†“                             â”‚
â”‚                     â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚                     â”‚    â”‚  Logs Audit â”‚                    â”‚
â”‚                     â”‚    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                     â”‚           â†“                           â”‚
â”‚                     â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚                     â”‚    â”‚ FILE: audit.log  â”‚               â”‚
â”‚                     â”‚    â”‚ SYSLOG           â”‚               â”‚
â”‚                     â”‚    â”‚ JSON format      â”‚               â”‚
â”‚                     â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                     â”‚             â†“                         â”‚
â”‚                     â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚                     â”‚    â”‚ SIEM / Splunk  â”‚                 â”‚
â”‚                     â”‚    â”‚ ELK Stack      â”‚                 â”‚
â”‚                     â”‚    â”‚ Graylog        â”‚                 â”‚
â”‚                     â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

ğŸ’¡ **Alternative** : MySQL Enterprise Audit Plugin (commercial) vs MariaDB Server Audit (gratuit, open-source).

---

## Installation et activation

### VÃ©rifier la disponibilitÃ©

```sql
-- Lister les plugins d'audit disponibles
SHOW PLUGINS;

-- Rechercher spÃ©cifiquement le plugin audit
SELECT * FROM information_schema.PLUGINS
WHERE PLUGIN_NAME LIKE '%audit%';
```

### Installer le plugin

```sql
-- Installer le Server Audit Plugin
INSTALL SONAME 'server_audit';

-- VÃ©rifier l'installation
SHOW PLUGINS WHERE Name = 'SERVER_AUDIT';
-- +-------------+--------+--------------------+------------------+---------+
-- | Name        | Status | Type               | Library          | License |
-- +-------------+--------+--------------------+------------------+---------+
-- | SERVER_AUDIT| ACTIVE | AUDIT              | server_audit.so  | GPL     |
-- +-------------+--------+--------------------+------------------+---------+
```

### Configuration persistante

```ini
# my.cnf / mariadb.cnf
[mysqld]

# Charger le plugin au dÃ©marrage
plugin-load-add = server_audit.so

# Ou avec plugin_load (syntaxe alternative)
# plugin_load = server_audit=server_audit.so
```

```bash
# RedÃ©marrer MariaDB
sudo systemctl restart mariadb

# VÃ©rifier que le plugin est chargÃ©
mysql -u root -p -e "SHOW PLUGINS WHERE Name = 'SERVER_AUDIT';"
```

---

## Configuration de base

### Activer l'audit

```sql
-- Activer le logging
SET GLOBAL server_audit_logging = ON;

-- VÃ©rifier l'Ã©tat
SHOW VARIABLES LIKE 'server_audit_logging';
-- +----------------------+-------+
-- | Variable_name        | Value |
-- +----------------------+-------+
-- | server_audit_logging | ON    |
-- +----------------------+-------+
```

### Configuration dans my.cnf

```ini
# my.cnf - Configuration Server Audit
[mysqld]

# === Plugin Audit ===
plugin-load-add = server_audit.so

# === Activation ===
server_audit_logging = ON

# === Emplacement du fichier de log ===
# Par dÃ©faut : datadir/server_audit.log
server_audit_file_path = /var/log/mysql/audit.log

# === Rotation des logs ===
server_audit_file_rotate_size = 1000000000  # 1 GB
server_audit_file_rotations = 9             # Garder 9 fichiers

# === Format de sortie ===
server_audit_output_type = FILE  # FILE ou SYSLOG

# === Ã‰vÃ©nements Ã  auditer ===
server_audit_events = CONNECT,QUERY,TABLE

# === Utilisateurs Ã  inclure (vide = tous) ===
# server_audit_incl_users =

# === Utilisateurs Ã  exclure ===
server_audit_excl_users = root,mariadb.sys

# === Logging des requÃªtes ===
server_audit_query_log_limit = 1024  # Taille max des requÃªtes loguÃ©es
```

---

## Types d'Ã©vÃ©nements

### Ã‰vÃ©nements disponibles

| Ã‰vÃ©nement | Description | Cas d'usage |
|-----------|-------------|-------------|
| **CONNECT** | Connexions et dÃ©connexions | Audit des accÃ¨s, dÃ©tection intrusions |
| **QUERY** | Toutes les requÃªtes SQL | Investigation forensique, conformitÃ© |
| **TABLE** | AccÃ¨s aux tables spÃ©cifiques | Audit donnÃ©es sensibles (RGPD) |
| **QUERY_DDL** | CREATE, ALTER, DROP | Audit changements de schÃ©ma |
| **QUERY_DML** | SELECT, INSERT, UPDATE, DELETE | Audit modifications de donnÃ©es |
| **QUERY_DCL** | GRANT, REVOKE | Audit gestion des privilÃ¨ges |

### Configuration par type d'Ã©vÃ©nement

```sql
-- Auditer uniquement les connexions
SET GLOBAL server_audit_events = 'CONNECT';

-- Auditer connexions et requÃªtes DDL
SET GLOBAL server_audit_events = 'CONNECT,QUERY_DDL';

-- Auditer tous les Ã©vÃ©nements
SET GLOBAL server_audit_events = 'CONNECT,QUERY,TABLE';

-- DÃ©sactiver l'audit de certains Ã©vÃ©nements
SET GLOBAL server_audit_events = 'CONNECT,QUERY_DDL,QUERY_DML,QUERY_DCL';
-- (exclut TABLE)
```

### Exemples d'Ã©vÃ©nements loggÃ©s

```bash
# CONNECT event
20251213 10:00:00,mariadb-server,john.doe,192.168.1.100,1234,CONNECT,mydb,,0

# QUERY event
20251213 10:00:01,mariadb-server,john.doe,192.168.1.100,1234,QUERY,mydb,'SELECT * FROM users WHERE id = 123',0

# QUERY_DDL event
20251213 10:00:02,mariadb-server,admin,localhost,1235,QUERY,mydb,'CREATE TABLE audit_trail (id INT)',0

# QUERY_DML event
20251213 10:00:03,mariadb-server,app_user,192.168.1.50,1236,QUERY,mydb,'UPDATE orders SET status = "shipped" WHERE id = 456',0

# Format : timestamp,server_id,user,host,connection_id,event_type,database,query,status
```

---

## Filtrage avancÃ©

### Filtrer par utilisateur

```sql
-- Auditer uniquement certains utilisateurs
SET GLOBAL server_audit_incl_users = 'admin,auditor,sensitive_app';

-- Exclure certains utilisateurs
SET GLOBAL server_audit_excl_users = 'monitoring,backup_user,mariadb.sys';

-- Combiner inclusion et exclusion
-- (inclusion a prioritÃ© sur exclusion)
SET GLOBAL server_audit_incl_users = 'admin';
SET GLOBAL server_audit_excl_users = 'root';
-- RÃ©sultat : Seul 'admin' est auditÃ©
```

ğŸ’¡ **Astuce** : Laisser vide `server_audit_incl_users` pour auditer tous les utilisateurs (sauf ceux exclus).

### Filtrer par base de donnÃ©es

```sql
-- Auditer uniquement certaines bases
-- Note : Pas de variable native pour cela
-- Solution : Utiliser les tables et Ã©vÃ©nements TABLE

-- Auditer l'accÃ¨s Ã  des tables spÃ©cifiques
SET GLOBAL server_audit_events = 'TABLE';
-- Puis configurer les tables Ã  auditer (voir section ci-dessous)
```

### Filtrer par type de requÃªte

```sql
-- Auditer uniquement les DDL (CREATE, ALTER, DROP)
SET GLOBAL server_audit_events = 'QUERY_DDL';

-- Auditer DDL + DML (modifications de donnÃ©es)
SET GLOBAL server_audit_events = 'QUERY_DDL,QUERY_DML';

-- Auditer tout sauf les SELECT (performance)
SET GLOBAL server_audit_events = 'CONNECT,QUERY_DDL,QUERY_DML,QUERY_DCL';
-- (exclut les SELECT massifs qui peuvent surcharger les logs)
```

### Limiter la taille des requÃªtes loguÃ©es

```sql
-- Limiter Ã  1024 caractÃ¨res (dÃ©faut)
SET GLOBAL server_audit_query_log_limit = 1024;

-- Augmenter pour les requÃªtes complexes
SET GLOBAL server_audit_query_log_limit = 4096;

-- 0 = pas de limite (attention aux performances)
SET GLOBAL server_audit_query_log_limit = 0;
```

âš ï¸ **Performance** : Des requÃªtes trÃ¨s longues (INSERT massifs, etc.) peuvent gÃ©nÃ©rer d'Ã©normes logs. Limitez raisonnablement.

---

## Formats de sortie

### FILE (fichier)

```ini
# my.cnf
[mysqld]
server_audit_output_type = FILE
server_audit_file_path = /var/log/mysql/audit.log

# Rotation automatique
server_audit_file_rotate_size = 1000000000  # 1 GB
server_audit_file_rotations = 9             # 9 rotations (10 fichiers max)
```

**Format du fichier** :

```
# audit.log (CSV-like)
timestamp,server_id,user,host,connection_id,event_type,database,query,status

20251213 10:00:00,mariadb-server,john.doe,192.168.1.100,1234,CONNECT,mydb,,0
20251213 10:00:01,mariadb-server,john.doe,192.168.1.100,1234,QUERY,mydb,'SELECT * FROM users',0
```

### SYSLOG

```ini
# my.cnf
[mysqld]
server_audit_output_type = SYSLOG

# FacilitÃ© syslog (LOG_USER par dÃ©faut)
server_audit_syslog_facility = LOG_LOCAL0

# PrioritÃ© syslog
server_audit_syslog_priority = LOG_INFO

# Identifiant syslog
server_audit_syslog_ident = mariadb_audit
```

**Configuration rsyslog** :

```bash
# /etc/rsyslog.d/30-mariadb-audit.conf
# Rediriger les logs MariaDB audit vers un fichier dÃ©diÃ©

local0.*    /var/log/mysql/audit-syslog.log

# Ou vers un serveur syslog centralisÃ©
# local0.*    @@syslog-server.example.com:514
```

```bash
# RedÃ©marrer rsyslog
sudo systemctl restart rsyslog
```

### JSON (via formatage externe)

Le plugin n'exporte pas nativement en JSON, mais vous pouvez le convertir :

```bash
#!/bin/bash
# csv-to-json.sh
# Convertir audit.log en JSON pour SIEM

tail -f /var/log/mysql/audit.log | while read line; do
    IFS=',' read -r timestamp server user host conn_id event db query status <<< "$line"

    cat <<EOF | jq -c .
{
  "timestamp": "$timestamp",
  "server": "$server",
  "user": "$user",
  "host": "$host",
  "connection_id": "$conn_id",
  "event": "$event",
  "database": "$db",
  "query": $query,
  "status": "$status"
}
EOF
done >> /var/log/mysql/audit.json
```

---

## Rotation des logs

### Rotation automatique (intÃ©grÃ©e)

```sql
-- Configurer la rotation
SET GLOBAL server_audit_file_rotate_size = 1073741824;  -- 1 GB
SET GLOBAL server_audit_file_rotations = 9;              -- 9 rotations

-- VÃ©rifier
SHOW VARIABLES LIKE 'server_audit_file%';
```

**Fichiers gÃ©nÃ©rÃ©s** :

```
/var/log/mysql/audit.log       # Fichier actif
/var/log/mysql/audit.log.1     # Rotation 1
/var/log/mysql/audit.log.2     # Rotation 2
...
/var/log/mysql/audit.log.9     # Rotation 9 (plus ancien)

# Lorsque audit.log atteint 1 GB :
# audit.log â†’ audit.log.1
# audit.log.1 â†’ audit.log.2
# ...
# audit.log.9 â†’ supprimÃ©
```

### Rotation externe (logrotate)

```bash
# /etc/logrotate.d/mariadb-audit
/var/log/mysql/audit.log {
    daily
    rotate 30
    missingok
    notifempty
    compress
    delaycompress
    sharedscripts
    postrotate
        # Forcer la rotation dans MariaDB
        mysql -u root -p"$(cat /root/.mysql_root_password)" -e "SET GLOBAL server_audit_file_rotate_now = ON;" 2>/dev/null || true
    endscript
}
```

### Rotation manuelle

```sql
-- Forcer la rotation immÃ©diatement
SET GLOBAL server_audit_file_rotate_now = ON;

-- Le fichier actuel devient audit.log.1
-- Un nouveau audit.log est crÃ©Ã©
```

---

## Performance et impact

### Impact sur les performances

| Configuration | Impact | Use Case |
|---------------|--------|----------|
| **CONNECT uniquement** | Minimal (~1-2%) | Production haute performance |
| **CONNECT + QUERY_DDL** | Faible (~3-5%) | Production standard |
| **CONNECT + QUERY** | Moyen (~10-15%) | Environnement de conformitÃ© |
| **CONNECT + QUERY + TABLE** | Ã‰levÃ© (~20-30%) | Investigation forensique temporaire |

### Optimisations

```sql
-- 1. Limiter les Ã©vÃ©nements
SET GLOBAL server_audit_events = 'CONNECT,QUERY_DDL';
-- (Ã©viter QUERY et TABLE en production)

-- 2. Exclure les utilisateurs non critiques
SET GLOBAL server_audit_excl_users = 'monitoring,backup,nagios';

-- 3. Limiter la taille des requÃªtes
SET GLOBAL server_audit_query_log_limit = 512;

-- 4. Utiliser SYSLOG plutÃ´t que FILE (buffering)
SET GLOBAL server_audit_output_type = 'SYSLOG';

-- 5. Rotation frÃ©quente pour Ã©viter fichiers Ã©normes
SET GLOBAL server_audit_file_rotate_size = 104857600;  -- 100 MB
```

### Monitoring de l'impact

```sql
-- VÃ©rifier les statistiques d'audit
SHOW STATUS LIKE 'server_audit%';

-- Variables importantes :
-- server_audit_writes : Nombre d'Ã©critures dans le log
-- server_audit_writes_failed : Ã‰critures Ã©chouÃ©es (problÃ¨me de performance !)

-- Comparer les performances avant/aprÃ¨s activation
SHOW STATUS LIKE 'Questions';
SHOW STATUS LIKE 'Queries';
```

---

## ConformitÃ© rÃ©glementaire

### PCI-DSS (Payment Card Industry)

**Exigences** : Auditer tous les accÃ¨s aux donnÃ©es de cartes de crÃ©dit.

```sql
-- Configuration PCI-DSS
SET GLOBAL server_audit_events = 'CONNECT,QUERY,TABLE';
SET GLOBAL server_audit_incl_users = '';  -- Tous les utilisateurs
SET GLOBAL server_audit_excl_users = '';  -- Aucune exclusion

-- Conserver les logs 1 an minimum
-- (gestion externe via archivage)
```

```ini
# my.cnf - PCI-DSS
[mysqld]
server_audit_logging = ON
server_audit_events = CONNECT,QUERY,TABLE
server_audit_output_type = SYSLOG
server_audit_syslog_facility = LOG_LOCAL0

# Forwarding vers SIEM pour conservation long terme
```

### HIPAA (Healthcare)

**Exigences** : TraÃ§abilitÃ© complÃ¨te des accÃ¨s aux donnÃ©es de santÃ© (PHI).

```sql
-- Configuration HIPAA
SET GLOBAL server_audit_events = 'CONNECT,QUERY,TABLE';

-- Auditer uniquement les utilisateurs accÃ©dant aux donnÃ©es PHI
SET GLOBAL server_audit_incl_users = 'doctor_app,nurse_app,admin_portal';

-- Logs immuables (WORM - Write Once Read Many)
-- Utiliser un systÃ¨me de fichiers en lecture seule ou SIEM avec rÃ©tention
```

### RGPD (GDPR)

**Exigences** : Tracer les accÃ¨s aux donnÃ©es personnelles, droit Ã  l'oubli.

```sql
-- Configuration RGPD
SET GLOBAL server_audit_events = 'CONNECT,QUERY_DML,TABLE';

-- Auditer l'accÃ¨s aux tables contenant des donnÃ©es personnelles
-- (via filtrage applicatif ou SIEM)

-- GÃ©nÃ©rer des rapports d'accÃ¨s pour les demandes RGPD
```

**RequÃªte d'audit RGPD** :

```bash
# GÃ©nÃ©rer un rapport des accÃ¨s Ã  un utilisateur spÃ©cifique
grep -i "john.doe@example.com" /var/log/mysql/audit.log > gdpr_report_john_doe.txt

# Ou avec awk pour formater
awk -F',' '/john\.doe@example\.com/ {print $1, $3, $7, $8}' /var/log/mysql/audit.log
```

### SOX (Sarbanes-Oxley)

**Exigences** : Audit des modifications de donnÃ©es financiÃ¨res.

```sql
-- Configuration SOX
SET GLOBAL server_audit_events = 'CONNECT,QUERY_DDL,QUERY_DML';

-- Auditer les utilisateurs accÃ©dant aux donnÃ©es financiÃ¨res
SET GLOBAL server_audit_incl_users = 'finance_app,accounting_user,cfo_dashboard';

-- Conservation 7 ans (archivage externe)
```

---

## IntÃ©gration SIEM

### Splunk

```bash
# Configurer Splunk Universal Forwarder
# /opt/splunkforwarder/etc/system/local/inputs.conf

[monitor:///var/log/mysql/audit.log]
disabled = false
index = mariadb_audit
sourcetype = mariadb:audit
source = mariadb-server-01

# RedÃ©marrer Splunk Forwarder
/opt/splunkforwarder/bin/splunk restart
```

**Recherche Splunk** :

```
index=mariadb_audit event=CONNECT status!=0
| stats count by user, host
| sort -count
```

### ELK Stack (Elasticsearch, Logstash, Kibana)

```ruby
# /etc/logstash/conf.d/mariadb-audit.conf
input {
  file {
    path => "/var/log/mysql/audit.log"
    start_position => "beginning"
    type => "mariadb-audit"
  }
}

filter {
  csv {
    columns => ["timestamp", "server", "user", "host", "connection_id", "event", "database", "query", "status"]
    separator => ","
  }

  date {
    match => ["timestamp", "yyyyMMdd HH:mm:ss"]
    target => "@timestamp"
  }

  mutate {
    convert => {
      "connection_id" => "integer"
      "status" => "integer"
    }
  }
}

output {
  elasticsearch {
    hosts => ["localhost:9200"]
    index => "mariadb-audit-%{+YYYY.MM.dd}"
  }
}
```

### Graylog

```bash
# Envoyer via SYSLOG vers Graylog
# my.cnf
[mysqld]
server_audit_output_type = SYSLOG
server_audit_syslog_facility = LOG_LOCAL0

# rsyslog
# /etc/rsyslog.d/30-mariadb-graylog.conf
local0.* @graylog-server.example.com:514
```

---

## Analyses et rapports

### RequÃªtes SQL d'analyse

```sql
-- Top 10 utilisateurs par nombre de connexions
-- (nÃ©cessite parsing externe des logs)

-- Exemple avec table temporaire
CREATE TEMPORARY TABLE audit_summary AS
SELECT user, host, COUNT(*) AS connection_count
FROM parsed_audit_logs
WHERE event = 'CONNECT'
GROUP BY user, host
ORDER BY connection_count DESC
LIMIT 10;
```

### Scripts d'analyse Bash

```bash
#!/bin/bash
# analyze-audit.sh
# Analyse des logs d'audit MariaDB

AUDIT_LOG="/var/log/mysql/audit.log"

echo "=== Rapport d'Audit MariaDB ==="
echo ""

echo "1. Top 10 utilisateurs (connexions)"
awk -F',' '$6 == "CONNECT" {print $3}' "$AUDIT_LOG" | sort | uniq -c | sort -rn | head -10

echo ""
echo "2. Connexions Ã©chouÃ©es (status != 0)"
awk -F',' '$6 == "CONNECT" && $9 != "0" {print $1, $3, $4}' "$AUDIT_LOG"

echo ""
echo "3. RequÃªtes DDL (CREATE, ALTER, DROP)"
grep -i "QUERY_DDL\|CREATE\|ALTER\|DROP" "$AUDIT_LOG" | wc -l

echo ""
echo "4. ActivitÃ© par heure"
awk -F',' '{split($1, dt, " "); split(dt[2], tm, ":"); print tm[1]}' "$AUDIT_LOG" | sort | uniq -c

echo ""
echo "5. Bases de donnÃ©es les plus accÃ©dÃ©es"
awk -F',' '$7 != "" {print $7}' "$AUDIT_LOG" | sort | uniq -c | sort -rn | head -10
```

### Dashboard exemple (Grafana + Loki)

```yaml
# promtail-config.yml
clients:
  - url: http://loki:3100/loki/api/v1/push

positions:
  filename: /tmp/positions.yaml

scrape_configs:
  - job_name: mariadb-audit
    static_configs:
      - targets:
          - localhost
        labels:
          job: mariadb
          __path__: /var/log/mysql/audit.log
    pipeline_stages:
      - regex:
          expression: '^(?P<timestamp>\d{8} \d{2}:\d{2}:\d{2}),(?P<server>[^,]+),(?P<user>[^,]+),(?P<host>[^,]+),(?P<conn_id>\d+),(?P<event>[^,]+),(?P<database>[^,]*),(?P<query>.*),(?P<status>\d+)$'
      - labels:
          user:
          event:
          database:
```

---

## Bonnes pratiques

### 1. SÃ©parer les logs d'audit du datadir

```ini
# my.cnf
[mysqld]
# âŒ MAUVAIS : Logs dans le datadir
# server_audit_file_path = /var/lib/mysql/audit.log

# âœ… BON : Logs dans un rÃ©pertoire dÃ©diÃ©
server_audit_file_path = /var/log/mysql/audit.log

# Avantages :
# - Facilite la sauvegarde sÃ©parÃ©e
# - Ã‰vite de remplir le datadir
# - Permissions diffÃ©rentes possibles
```

### 2. Chiffrer les logs d'audit

```bash
# Chiffrer les logs archivÃ©s
gpg --symmetric --cipher-algo AES256 audit.log.1

# Ou avec OpenSSL
openssl enc -aes-256-cbc -salt -in audit.log.1 -out audit.log.1.enc

# Supprimer l'original
shred -u audit.log.1
```

### 3. Archivage long terme

```bash
#!/bin/bash
# archive-audit-logs.sh
# Archivage des logs d'audit > 90 jours

AUDIT_DIR="/var/log/mysql"
ARCHIVE_DIR="/backup/mysql-audit"
RETENTION_DAYS=90

# Compresser et archiver
find "$AUDIT_DIR" -name "audit.log.*" -mtime +$RETENTION_DAYS -exec gzip {} \;
find "$AUDIT_DIR" -name "audit.log.*.gz" -mtime +$RETENTION_DAYS -exec mv {} "$ARCHIVE_DIR" \;

# Chiffrer les archives
find "$ARCHIVE_DIR" -name "*.gz" -mtime +$RETENTION_DAYS -exec gpg --symmetric --cipher-algo AES256 {} \;
find "$ARCHIVE_DIR" -name "*.gz.gpg" -exec rm -f {}.gz \;

# Logs
echo "$(date): Audit logs archived" >> /var/log/audit-archive.log
```

### 4. Monitoring de l'espace disque

```bash
# Alerter si l'espace disque audit > 80%
#!/bin/bash
AUDIT_DIR="/var/log/mysql"
THRESHOLD=80

USAGE=$(df "$AUDIT_DIR" | tail -1 | awk '{print $5}' | sed 's/%//')

if [ "$USAGE" -gt "$THRESHOLD" ]; then
    echo "WARNING: Audit logs disk usage: ${USAGE}%" | mail -s "MariaDB Audit Alert" admin@example.com
fi
```

### 5. Tester rÃ©guliÃ¨rement la restauration

```bash
# VÃ©rifier que les logs sont lisibles et non corrompus
# Test mensuel
zcat /backup/mysql-audit/audit.log.*.gz | head -100

# VÃ©rifier l'intÃ©gritÃ© des fichiers chiffrÃ©s
gpg --decrypt audit.log.1.gz.gpg > /dev/null 2>&1
if [ $? -eq 0 ]; then
    echo "Audit log integrity: OK"
else
    echo "Audit log integrity: FAILED" | mail -s "Audit Integrity Alert" admin@example.com
fi
```

---

## DÃ©pannage

### ProblÃ¨me 1 : Logs non crÃ©Ã©s

```bash
# SymptÃ´me
# Aucun fichier audit.log crÃ©Ã©

# Diagnostic 1 : VÃ©rifier que le plugin est actif
mysql -u root -p -e "SHOW PLUGINS WHERE Name = 'SERVER_AUDIT';"

# Diagnostic 2 : VÃ©rifier la configuration
mysql -u root -p -e "SHOW VARIABLES LIKE 'server_audit%';"

# Diagnostic 3 : VÃ©rifier les permissions
ls -l /var/log/mysql/
# Le rÃ©pertoire doit Ãªtre accessible en Ã©criture par mysql

sudo chown mysql:mysql /var/log/mysql
sudo chmod 755 /var/log/mysql

# Diagnostic 4 : VÃ©rifier les logs d'erreur
sudo tail -f /var/log/mysql/error.log | grep -i audit
```

### ProblÃ¨me 2 : Fichier de log trop volumineux

```bash
# SymptÃ´me
# audit.log atteint plusieurs GB rapidement

# Solution 1 : RÃ©duire les Ã©vÃ©nements auditÃ©s
mysql -u root -p
SET GLOBAL server_audit_events = 'CONNECT,QUERY_DDL';

# Solution 2 : RÃ©duire la taille de rotation
SET GLOBAL server_audit_file_rotate_size = 104857600;  -- 100 MB

# Solution 3 : Exclure les utilisateurs non critiques
SET GLOBAL server_audit_excl_users = 'monitoring,backup,nagios';

# Solution 4 : Limiter la taille des requÃªtes
SET GLOBAL server_audit_query_log_limit = 256;
```

### ProblÃ¨me 3 : Performance dÃ©gradÃ©e

```bash
# SymptÃ´me
# Ralentissement du serveur aprÃ¨s activation de l'audit

# Diagnostic : VÃ©rifier les Ã©critures Ã©chouÃ©es
mysql -u root -p -e "SHOW STATUS LIKE 'server_audit_writes%';"
# server_audit_writes_failed > 0 â†’ ProblÃ¨me d'I/O

# Solution 1 : Utiliser SYSLOG (buffering)
SET GLOBAL server_audit_output_type = 'SYSLOG';

# Solution 2 : DÃ©placer les logs sur un disque plus rapide (SSD)
# my.cnf
# server_audit_file_path = /fast-disk/mysql/audit.log

# Solution 3 : RÃ©duire les Ã©vÃ©nements auditÃ©s
SET GLOBAL server_audit_events = 'CONNECT';
```

### ProblÃ¨me 4 : Logs corrompus

```bash
# SymptÃ´me
# Parsing des logs Ã©choue, lignes mal formatÃ©es

# Diagnostic : VÃ©rifier l'intÃ©gritÃ©
tail -100 /var/log/mysql/audit.log

# Cause possible : Rotation pendant une Ã©criture

# Solution 1 : Forcer la rotation manuelle
SET GLOBAL server_audit_file_rotate_now = ON;

# Solution 2 : Augmenter la taille de rotation
SET GLOBAL server_audit_file_rotate_size = 2147483648;  -- 2 GB

# Solution 3 : DÃ©sactiver/rÃ©activer le plugin
SET GLOBAL server_audit_logging = OFF;
# Attendre quelques secondes
SET GLOBAL server_audit_logging = ON;
```

---

## âœ… Points clÃ©s Ã  retenir

- **Server Audit Plugin** : Plugin d'audit officiel MariaDB (gratuit, open-source)
- **Ã‰vÃ©nements** : CONNECT, QUERY, TABLE, QUERY_DDL, QUERY_DML, QUERY_DCL
- **Formats de sortie** : FILE (CSV-like) ou SYSLOG (intÃ©gration SIEM)
- **Rotation automatique** : ConfigurÃ©e via `server_audit_file_rotate_size` et `server_audit_file_rotations`
- **Filtrage** : Par utilisateur (`incl_users`, `excl_users`), par Ã©vÃ©nement
- **Performance** : Impact 1-30% selon configuration (CONNECT minimal, QUERY+TABLE Ã©levÃ©)
- **ConformitÃ©** : PCI-DSS, HIPAA, RGPD, SOX - conservation 1-7 ans
- **SIEM** : IntÃ©gration Splunk, ELK, Graylog pour analyse centralisÃ©e
- **Bonnes pratiques** : Logs sÃ©parÃ©s du datadir, chiffrement, archivage, monitoring espace disque
- **Optimisation** : Limiter Ã©vÃ©nements, exclure utilisateurs non critiques, utiliser SYSLOG

---

## ğŸ”— Ressources et rÃ©fÃ©rences

- [ğŸ“– Documentation officielle - Server Audit Plugin](https://mariadb.com/kb/en/mariadb-audit-plugin/)
- [ğŸ“– Server Audit Plugin Options and Variables](https://mariadb.com/kb/en/mariadb-audit-plugin-options-and-system-variables/)
- [ğŸ“– PCI-DSS Compliance Guide](https://www.pcisecuritystandards.org/)
- [ğŸ“– HIPAA Compliance Requirements](https://www.hhs.gov/hipaa/)
- [ğŸ“– GDPR/RGPD Documentation](https://gdpr.eu/)
- [Blog : Auditing Best Practices for MariaDB](https://mariadb.org/audit-best-practices/)

---


â­ï¸ [Audit de connexions et requÃªtes](/10-securite-gestion-utilisateurs/08.2-audit-connexions-requetes.md)
