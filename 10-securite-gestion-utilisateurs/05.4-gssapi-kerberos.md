üîù Retour au [Sommaire](/SOMMAIRE.md)

# 10.5.4 GSSAPI/Kerberos

> **Niveau** : Avanc√©
> **Dur√©e estim√©e** : 3 heures
> **Pr√©requis** : Sections 10.5.3 (PAM et LDAP), connaissance de Kerberos et Active Directory

## üéØ Objectifs d'apprentissage

√Ä l'issue de cette section, vous serez capable de :
- Comprendre les principes de GSSAPI et Kerberos pour l'authentification
- Configurer le plugin GSSAPI pour MariaDB
- Impl√©menter le Single Sign-On (SSO) avec Active Directory ou MIT Kerberos
- Int√©grer MariaDB dans une infrastructure Kerberos existante
- Diagnostiquer et r√©soudre les probl√®mes d'authentification Kerberos
- Mettre en ≈ìuvre les bonnes pratiques de s√©curit√© pour Kerberos

---

## Introduction

**GSSAPI** (Generic Security Services Application Program Interface) est une API standardis√©e (RFC 2743) qui permet aux applications d'utiliser diff√©rents m√©canismes d'authentification de mani√®re transparente. **Kerberos** (RFC 4120) est le m√©canisme d'authentification le plus couramment utilis√© avec GSSAPI.

L'authentification Kerberos pour MariaDB offre :
- ‚úÖ **Single Sign-On (SSO)** : Les utilisateurs s'authentifient une fois au niveau du syst√®me d'exploitation
- ‚úÖ **S√©curit√© renforc√©e** : Authentification mutuelle (client ‚Üî serveur)
- ‚úÖ **Int√©gration Active Directory** : Utilise l'infrastructure Kerberos d'AD
- ‚úÖ **Pas de transmission de mots de passe** : Tickets Kerberos uniquement
- ‚úÖ **Audit centralis√©** : Logs Kerberos consolid√©s

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              Architecture Kerberos + MariaDB                ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                             ‚îÇ
‚îÇ  1. Client obtient TGT (Ticket-Granting Ticket)             ‚îÇ
‚îÇ     du KDC (Key Distribution Center)                        ‚îÇ
‚îÇ         ‚Üì                                                   ‚îÇ
‚îÇ  2. Client demande Service Ticket pour MariaDB              ‚îÇ
‚îÇ         ‚Üì                                                   ‚îÇ
‚îÇ  3. Client se connecte √† MariaDB avec Service Ticket        ‚îÇ
‚îÇ         ‚Üì                                                   ‚îÇ
‚îÇ  4. MariaDB valide le ticket aupr√®s du KDC                  ‚îÇ
‚îÇ         ‚Üì                                                   ‚îÇ
‚îÇ  5. Authentification r√©ussie (SSO)                          ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  Avantages :                                                ‚îÇ
‚îÇ  ‚úÖ Pas de mot de passe transmis                            ‚îÇ
‚îÇ  ‚úÖ Authentification mutuelle                               ‚îÇ
‚îÇ  ‚úÖ Session unique (SSO)                                    ‚îÇ
‚îÇ  ‚úÖ Expiration automatique des tickets                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Concepts fondamentaux de Kerberos

### Composants Kerberos

| Composant | R√¥le | √âquivalent AD |
|-----------|------|---------------|
| **KDC** (Key Distribution Center) | Serveur d'authentification central | Domain Controller |
| **Principal** | Identit√© Kerberos (user@REALM) | User/Computer account |
| **Realm** | Domaine Kerberos | AD Domain (EXAMPLE.COM) |
| **TGT** (Ticket-Granting Ticket) | Ticket initial apr√®s login | Session ticket |
| **Service Ticket** | Ticket pour acc√©der √† un service | Service Ticket |
| **Keytab** | Fichier contenant les cl√©s principales | Service account credentials |

### Flux d'authentification Kerberos

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Client  ‚îÇ         ‚îÇ   KDC    ‚îÇ          ‚îÇ MariaDB  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚îÇ                   ‚îÇ                     ‚îÇ
      ‚îÇ 1. AS-REQ         ‚îÇ                     ‚îÇ
      ‚îÇ  (demande TGT)    ‚îÇ                     ‚îÇ
      ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ                     ‚îÇ
      ‚îÇ                   ‚îÇ                     ‚îÇ
      ‚îÇ 2. AS-REP (TGT)   ‚îÇ                     ‚îÇ
      ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ                     ‚îÇ
      ‚îÇ                   ‚îÇ                     ‚îÇ
      ‚îÇ 3. TGS-REQ        ‚îÇ                     ‚îÇ
      ‚îÇ  (demande ticket  ‚îÇ                     ‚îÇ
      ‚îÇ   pour MariaDB)   ‚îÇ                     ‚îÇ
      ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ                     ‚îÇ
      ‚îÇ                   ‚îÇ                     ‚îÇ
      ‚îÇ 4. TGS-REP        ‚îÇ                     ‚îÇ
      ‚îÇ  (Service Ticket) ‚îÇ                     ‚îÇ
      ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ                     ‚îÇ
      ‚îÇ                   ‚îÇ                     ‚îÇ
      ‚îÇ 5. AP-REQ (Service Ticket)              ‚îÇ
      ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
      ‚îÇ                   ‚îÇ                     ‚îÇ
      ‚îÇ                   ‚îÇ 6. Validation       ‚îÇ
      ‚îÇ                   ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
      ‚îÇ                   ‚îÇ                     ‚îÇ
      ‚îÇ                   ‚îÇ 7. OK               ‚îÇ
      ‚îÇ                   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
      ‚îÇ                   ‚îÇ                     ‚îÇ
      ‚îÇ 8. AP-REP (authentification mutuelle)   ‚îÇ
      ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
      ‚îÇ                   ‚îÇ                     ‚îÇ
      ‚îÇ 9. Connexion SQL √©tablie                ‚îÇ
      ‚îÇ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê>‚îÇ
      ‚îÇ                   ‚îÇ                     ‚îÇ
```

üí° **Vocabulaire** :
- **AS-REQ/REP** : Authentication Service Request/Reply
- **TGS-REQ/REP** : Ticket-Granting Service Request/Reply
- **AP-REQ/REP** : Application Request/Reply

---

## Installation et configuration

### V√©rifier la disponibilit√© du plugin

```sql
-- Lister les plugins d'authentification
SHOW PLUGINS WHERE Name LIKE '%gssapi%';

-- Installer si n√©cessaire
INSTALL SONAME 'auth_gssapi';

-- V√©rifier
SELECT PLUGIN_NAME, PLUGIN_STATUS, PLUGIN_LIBRARY
FROM information_schema.PLUGINS
WHERE PLUGIN_NAME = 'gssapi';

-- R√©sultat attendu :
-- PLUGIN_NAME: gssapi
-- PLUGIN_STATUS: ACTIVE
-- PLUGIN_TYPE: AUTHENTICATION
-- PLUGIN_LIBRARY: auth_gssapi.so
```

### Pr√©requis syst√®me

```bash
# Installer les biblioth√®ques Kerberos
# Debian/Ubuntu
sudo apt-get update
sudo apt-get install -y krb5-user libkrb5-dev libsasl2-modules-gssapi-mit

# RHEL/CentOS/Rocky
sudo yum install -y krb5-workstation krb5-libs cyrus-sasl-gssapi

# V√©rifier l'installation
klist -V
# Kerberos 5 version 1.19.2

kinit --version
# kinit (Heimdal 7.7.0)
```

---

## Configuration Kerberos client

### Fichier /etc/krb5.conf

Configuration pour MIT Kerberos (ou Active Directory) :

```ini
# /etc/krb5.conf
# Configuration Kerberos pour MariaDB

[libdefaults]
    # Realm par d√©faut (MAJUSCULES obligatoires)
    default_realm = EXAMPLE.COM

    # Dur√©e de vie des tickets
    ticket_lifetime = 24h
    renew_lifetime = 7d

    # Forwarding de tickets (pour SSO)
    forwardable = true
    proxiable = true

    # DNS pour localisation KDC
    dns_lookup_realm = true
    dns_lookup_kdc = true

    # Algorithmes de chiffrement (s√©curit√© moderne)
    default_tgs_enctypes = aes256-cts-hmac-sha1-96 aes128-cts-hmac-sha1-96
    default_tkt_enctypes = aes256-cts-hmac-sha1-96 aes128-cts-hmac-sha1-96
    permitted_enctypes = aes256-cts-hmac-sha1-96 aes128-cts-hmac-sha1-96

    # Logging (debug)
    # default = FILE:/var/log/krb5libs.log

[realms]
    EXAMPLE.COM = {
        # KDC (Key Distribution Center)
        kdc = dc1.example.com:88
        kdc = dc2.example.com:88  # Redondance

        # Admin server
        admin_server = dc1.example.com:749

        # Active Directory
        default_domain = example.com
    }

[domain_realm]
    # Mapping domaines DNS ‚Üí Realm Kerberos
    .example.com = EXAMPLE.COM
    example.com = EXAMPLE.COM

    # Sous-domaines
    .subdomain.example.com = EXAMPLE.COM

[logging]
    # Logs pour debug (d√©sactiver en production)
    # default = FILE:/var/log/krb5libs.log
    # kdc = FILE:/var/log/krb5kdc.log
    # admin_server = FILE:/var/log/kadmind.log
```

‚ö†Ô∏è **Important** : Le nom du realm doit √™tre en **MAJUSCULES** (convention Kerberos).

### Tester la configuration Kerberos

```bash
# Obtenir un TGT (Ticket-Granting Ticket)
kinit john.doe@EXAMPLE.COM
# Password for john.doe@EXAMPLE.COM: *****

# V√©rifier les tickets
klist
# Ticket cache: FILE:/tmp/krb5cc_1000
# Default principal: john.doe@EXAMPLE.COM
#
# Valid starting     Expires            Service principal
# 12/13/25 10:00:00  12/13/25 20:00:00  krbtgt/EXAMPLE.COM@EXAMPLE.COM
#     renew until 12/20/25 10:00:00

# D√©truire les tickets (logout)
kdestroy

# V√©rifier que les tickets sont supprim√©s
klist
# klist: No credentials cache found
```

---

## Configuration MariaDB Server

### Cr√©er un principal de service pour MariaDB

#### Avec MIT Kerberos

```bash
# Sur le serveur KDC
# Cr√©er le principal de service
kadmin.local
kadmin: addprinc -randkey mariadb/mariadb-server.example.com@EXAMPLE.COM

# Exporter le keytab
kadmin: ktadd -k /tmp/mariadb.keytab mariadb/mariadb-server.example.com@EXAMPLE.COM

# Quitter
kadmin: quit

# Transf√©rer le keytab sur le serveur MariaDB (s√©curis√©)
scp /tmp/mariadb.keytab mariadb-server.example.com:/etc/mysql/mariadb.keytab

# Nettoyer
rm /tmp/mariadb.keytab
```

#### Avec Active Directory

```powershell
# Sur un Domain Controller Windows
# PowerShell

# Cr√©er un compte de service
New-ADUser -Name "mariadb-service" `
    -SamAccountName "mariadb-service" `
    -UserPrincipalName "mariadb/mariadb-server.example.com@EXAMPLE.COM" `
    -AccountPassword (ConvertTo-SecureString "ComplexP@ss123!" -AsPlainText -Force) `
    -Enabled $true `
    -PasswordNeverExpires $true

# Mapper le SPN (Service Principal Name)
setspn -A mariadb/mariadb-server.example.com EXAMPLE\mariadb-service
setspn -A mariadb/mariadb-server.example.com:3306 EXAMPLE\mariadb-service

# G√©n√©rer le keytab
ktpass -out C:\temp\mariadb.keytab `
    -princ mariadb/mariadb-server.example.com@EXAMPLE.COM `
    -mapUser mariadb-service@EXAMPLE.COM `
    -pass ComplexP@ss123! `
    -crypto AES256-SHA1 `
    -ptype KRB5_NT_PRINCIPAL

# Transf√©rer sur le serveur MariaDB
```

### Configurer le keytab sur MariaDB

```bash
# Sur le serveur MariaDB
# Copier le keytab dans le r√©pertoire MariaDB
sudo cp mariadb.keytab /etc/mysql/mariadb.keytab

# Permissions critiques (lecture uniquement par mysql)
sudo chown mysql:mysql /etc/mysql/mariadb.keytab
sudo chmod 400 /etc/mysql/mariadb.keytab

# V√©rifier le keytab
sudo -u mysql klist -k /etc/mysql/mariadb.keytab
# Keytab name: FILE:/etc/mysql/mariadb.keytab
# KVNO Principal
# ---- -------------------------
#    2 mariadb/mariadb-server.example.com@EXAMPLE.COM

# Tester l'authentification avec le keytab
sudo -u mysql kinit -k -t /etc/mysql/mariadb.keytab mariadb/mariadb-server.example.com@EXAMPLE.COM

sudo -u mysql klist
# Valid starting     Expires            Service principal
# 12/13/25 10:00:00  12/13/25 20:00:00  krbtgt/EXAMPLE.COM@EXAMPLE.COM
```

‚ö†Ô∏è **S√©curit√© critique** : Le keytab contient des cl√©s secr√®tes. Permissions 400 obligatoires.

### Configuration my.cnf

```ini
# my.cnf / mariadb.cnf
[mysqld]

# Plugin GSSAPI
plugin-load-add = auth_gssapi.so

# Configuration Kerberos
gssapi_keytab_path = /etc/mysql/mariadb.keytab
gssapi_principal_name = mariadb/mariadb-server.example.com@EXAMPLE.COM

# Realm par d√©faut (optionnel si krb5.conf est configur√©)
# gssapi_realm = EXAMPLE.COM

# Mode debug (d√©sactiver en production)
# log_warnings = 3
```

### Red√©marrer MariaDB

```bash
# Red√©marrer pour charger la configuration
sudo systemctl restart mariadb

# V√©rifier que le plugin est actif
mysql -u root -p -e "SHOW PLUGINS WHERE Name = 'gssapi';"

# V√©rifier les logs
sudo tail -f /var/log/mysql/error.log | grep -i gssapi
```

---

## Cr√©ation d'utilisateurs GSSAPI

### Utilisateur avec principal Kerberos

```sql
-- Cr√©er un utilisateur authentifi√© via GSSAPI
CREATE USER 'john.doe'@'%'
    IDENTIFIED VIA gssapi
    AS 'john.doe@EXAMPLE.COM';
--                ‚Üë
--                Principal Kerberos complet

-- V√©rifier
SHOW CREATE USER 'john.doe'@'%';
-- CREATE USER `john.doe`@`%` IDENTIFIED VIA gssapi AS 'john.doe@EXAMPLE.COM'

-- Accorder des privil√®ges
GRANT SELECT, INSERT, UPDATE, DELETE ON app_db.*
    TO 'john.doe'@'%';
```

### Utilisateur sans realm sp√©cifi√© (utilise le realm par d√©faut)

```sql
-- Utilisateur avec realm par d√©faut
CREATE USER 'jane.smith'@'%'
    IDENTIFIED VIA gssapi
    AS 'jane.smith';
-- MariaDB ajoutera automatiquement @EXAMPLE.COM (realm par d√©faut)

-- √âquivalent √† :
CREATE USER 'jane.smith'@'%'
    IDENTIFIED VIA gssapi
    AS 'jane.smith@EXAMPLE.COM';
```

### Mapping de plusieurs principals

```sql
-- Utilisateur avec plusieurs identit√©s Kerberos possibles
CREATE USER 'admin'@'%'
    IDENTIFIED VIA gssapi
    AS 'admin@EXAMPLE.COM';

-- Ou utiliser des comptes proxy
CREATE USER ''@'%'
    IDENTIFIED VIA gssapi;
-- Tous les principals Kerberos valides

CREATE USER 'kerberos_proxy'@'%';
GRANT PROXY ON 'kerberos_proxy'@'%' TO ''@'%';

GRANT SELECT ON analytics_db.* TO 'kerberos_proxy'@'%';
```

---

## Connexion client avec GSSAPI

### Configuration client Kerberos

```bash
# Sur la machine cliente
# 1. Configurer /etc/krb5.conf (identique au serveur)

# 2. Obtenir un TGT
kinit john.doe@EXAMPLE.COM
# Password: *****

# V√©rifier le ticket
klist
# Default principal: john.doe@EXAMPLE.COM
# Valid starting     Expires            Service principal
# 12/13/25 10:00:00  12/13/25 20:00:00  krbtgt/EXAMPLE.COM@EXAMPLE.COM
```

### Connexion MariaDB avec SSO

```bash
# Connexion SANS mot de passe (SSO via Kerberos)
mysql --user=john.doe --host=mariadb-server.example.com

# Ou avec param√®tre explicite
mysql --user=john.doe \
      --host=mariadb-server.example.com \
      --plugin-dir=/usr/lib/mysql/plugin

# V√©rification apr√®s connexion
MariaDB> SELECT USER(), CURRENT_USER();
-- +--------------------+---------------+
-- | USER()             | CURRENT_USER()|
-- +--------------------+---------------+
-- | john.doe@client-ip | john.doe@%    |
-- +--------------------+---------------+
```

üí° **Single Sign-On** : Aucun mot de passe demand√© ! L'authentification se fait via le ticket Kerberos.

### Configuration application (exemple JDBC)

```java
// Java avec JDBC
import java.sql.*;
import java.util.Properties;

public class KerberosConnection {
    public static void main(String[] args) {
        String url = "jdbc:mariadb://mariadb-server.example.com:3306/app_db";

        Properties props = new Properties();
        props.setProperty("user", "john.doe");
        props.setProperty("useSSL", "true");
        props.setProperty("useFractionalSeconds", "true");

        // Activer GSSAPI/Kerberos
        props.setProperty("gssapiAuth", "true");
        props.setProperty("jaasConfig", "/path/to/jaas.conf");

        try (Connection conn = DriverManager.getConnection(url, props)) {
            System.out.println("Connected with Kerberos SSO!");
            // Requ√™tes SQL...
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }
}
```

```ini
# jaas.conf
MariaDbJdbc {
  com.sun.security.auth.module.Krb5LoginModule required
  useTicketCache=true
  renewTGT=true
  doNotPrompt=true;
};
```

### Configuration Python

```python
# Python avec mysql-connector-python
import mysql.connector

# Configuration Kerberos
config = {
    'host': 'mariadb-server.example.com',
    'database': 'app_db',
    'user': 'john.doe',
    'auth_plugin': 'mysql_clear_password',  # Avec GSSAPI
    'use_pure': True,
    'ssl_disabled': False,
}

# Connexion (SSO via ticket Kerberos)
conn = mysql.connector.connect(**config)
cursor = conn.cursor()

cursor.execute("SELECT USER(), CURRENT_USER()")
print(cursor.fetchone())

cursor.close()
conn.close()
```

---

## Int√©gration Active Directory

### Configuration compl√®te AD

```ini
# /etc/krb5.conf pour Active Directory
[libdefaults]
    default_realm = CORP.EXAMPLE.COM

    # Compatibilit√© AD
    dns_lookup_realm = true
    dns_lookup_kdc = true

    # Algorithmes support√©s par AD
    default_tgs_enctypes = aes256-cts-hmac-sha1-96 rc4-hmac
    default_tkt_enctypes = aes256-cts-hmac-sha1-96 rc4-hmac
    permitted_enctypes = aes256-cts-hmac-sha1-96 rc4-hmac

    # Horloge (critique avec AD)
    clockskew = 300  # 5 minutes

    ticket_lifetime = 10h
    renew_lifetime = 7d
    forwardable = true

[realms]
    CORP.EXAMPLE.COM = {
        kdc = dc1.corp.example.com:88
        kdc = dc2.corp.example.com:88
        admin_server = dc1.corp.example.com:749
        default_domain = corp.example.com
    }

[domain_realm]
    .corp.example.com = CORP.EXAMPLE.COM
    corp.example.com = CORP.EXAMPLE.COM
```

### Synchronisation horaire (NTP obligatoire)

```bash
# Kerberos est tr√®s sensible aux d√©calages d'heure
# Installer NTP
sudo apt-get install -y ntp ntpdate

# Configurer NTP avec les DCs AD
sudo vi /etc/ntp.conf
# server dc1.corp.example.com prefer
# server dc2.corp.example.com

# Synchroniser imm√©diatement
sudo ntpdate dc1.corp.example.com

# Activer et d√©marrer NTP
sudo systemctl enable ntp
sudo systemctl start ntp

# V√©rifier la synchronisation
ntpq -p
#      remote           refid      st t when poll reach   delay   offset  jitter
# ==============================================================================
# *dc1.corp.exampl .LOCL.           1 u   64   64  377    0.123   -0.001   0.005
```

‚ö†Ô∏è **Critique** : Un d√©calage horaire > 5 minutes (clockskew) cause l'√©chec de l'authentification Kerberos.

### Tester l'int√©gration AD

```bash
# Obtenir un ticket depuis AD
kinit john.doe@CORP.EXAMPLE.COM
# Password: *****

# V√©rifier le ticket
klist
# Default principal: john.doe@CORP.EXAMPLE.COM

# Lister les SPNs du serveur MariaDB
setspn -L mariadb-service
# Registered ServicePrincipalNames for CN=mariadb-service,...:
#     mariadb/mariadb-server.corp.example.com
#     mariadb/mariadb-server.corp.example.com:3306

# Connexion MariaDB
mysql -u john.doe -h mariadb-server.corp.example.com
# Authentification SSO r√©ussie !
```

---

## S√©curit√© et bonnes pratiques

### 1. Protection du keytab

```bash
# Permissions strictes
sudo chown mysql:mysql /etc/mysql/mariadb.keytab
sudo chmod 400 /etc/mysql/mariadb.keytab

# SELinux (si activ√©)
sudo chcon -t mysqld_etc_t /etc/mysql/mariadb.keytab

# Audit des acc√®s
sudo auditctl -w /etc/mysql/mariadb.keytab -p rwa -k mariadb_keytab_access

# V√©rifier les logs
sudo ausearch -k mariadb_keytab_access
```

### 2. Rotation du keytab

```bash
#!/bin/bash
# rotate_mariadb_keytab.sh

# Cr√©er un nouveau keytab avec KVNO +1
kadmin.local -q "ktadd -k /tmp/mariadb_new.keytab mariadb/mariadb-server.example.com@EXAMPLE.COM"

# Fusionner avec l'ancien (pour transition)
ktutil
ktutil: read_kt /etc/mysql/mariadb.keytab
ktutil: read_kt /tmp/mariadb_new.keytab
ktutil: write_kt /etc/mysql/mariadb_merged.keytab
ktutil: quit

# Remplacer
sudo mv /etc/mysql/mariadb_merged.keytab /etc/mysql/mariadb.keytab
sudo chown mysql:mysql /etc/mysql/mariadb.keytab
sudo chmod 400 /etc/mysql/mariadb.keytab

# Red√©marrer MariaDB
sudo systemctl restart mariadb

# Nettoyer
sudo rm /tmp/mariadb_new.keytab

echo "Keytab rotated successfully"
```

### 3. SSL/TLS avec Kerberos

```sql
-- Forcer SSL m√™me avec Kerberos (d√©fense en profondeur)
CREATE USER 'john.doe'@'%'
    IDENTIFIED VIA gssapi AS 'john.doe@EXAMPLE.COM'
    REQUIRE SSL;

-- V√©rifier
SHOW CREATE USER 'john.doe'@'%';
```

```ini
# my.cnf
[mysqld]
require_secure_transport = ON  # SSL obligatoire pour toutes connexions
```

### 4. Expiration des tickets

```bash
# Renouveler automatiquement les tickets (cron)
# /etc/cron.hourly/renew-kerberos-ticket

#!/bin/bash
# Renouveler le ticket si proche de l'expiration
TICKET_REMAINING=$(klist | grep "krbtgt" | awk '{print $4" "$5}')

if [ -n "$TICKET_REMAINING" ]; then
    # Renouveler
    kinit -R || kinit -k -t /etc/mysql/mariadb.keytab mariadb/mariadb-server.example.com@EXAMPLE.COM
fi
```

### 5. Audit centralis√©

```sql
-- Activer l'audit MariaDB
INSTALL SONAME 'server_audit';

SET GLOBAL server_audit_logging = ON;
SET GLOBAL server_audit_events = 'CONNECT,QUERY';
SET GLOBAL server_audit_incl_users = 'john.doe,jane.smith';

-- Filtrer les connexions GSSAPI
SELECT event_time, user_host, connection_id, command_type
FROM mysql.general_log
WHERE argument LIKE '%gssapi%'
ORDER BY event_time DESC
LIMIT 100;
```

### 6. Compte d'urgence local

```sql
-- Toujours avoir un compte local en cas de panne Kerberos
CREATE USER 'emergency_admin'@'localhost'
    IDENTIFIED VIA ed25519
    USING PASSWORD('EmergencyP@ss123!');

GRANT ALL PRIVILEGES ON *.*
    TO 'emergency_admin'@'localhost'
    WITH GRANT OPTION;

-- Documenter dans la proc√©dure d'urgence
```

---

## Cas d'usage production

### Sc√©nario 1 : Entreprise avec AD (SSO complet)

```sql
-- 5000 employ√©s dans Active Directory
-- Besoin : Acc√®s MariaDB pour analystes (200 personnes)

-- 1. Cr√©er groupe AD "MariaDB-Analysts"
-- 2. Ajouter 200 personnes au groupe

-- 3. Dans MariaDB : mapping de groupe via proxy
CREATE USER ''@'%'
    IDENTIFIED VIA gssapi;

CREATE USER 'analyst_proxy'@'%';

GRANT PROXY ON 'analyst_proxy'@'%' TO ''@'%';

GRANT SELECT ON analytics_db.* TO 'analyst_proxy'@'%';

-- R√©sultat : SSO pour tous les membres du groupe AD
-- Pas de gestion de mots de passe MariaDB
```

### Sc√©nario 2 : Infrastructure multi-datacenter

```sql
-- Plusieurs datacenters avec Kerberos cross-realm
-- DC1 : REALM1.EXAMPLE.COM
-- DC2 : REALM2.EXAMPLE.COM

-- Configuration krb5.conf avec cross-realm trust
-- [capaths]
--     REALM1.EXAMPLE.COM = {
--         REALM2.EXAMPLE.COM = .
--     }
--     REALM2.EXAMPLE.COM = {
--         REALM1.EXAMPLE.COM = .
--     }

-- Utilisateur de REALM1 peut acc√©der √† MariaDB dans REALM2
CREATE USER 'john.doe'@'%'
    IDENTIFIED VIA gssapi
    AS 'john.doe@REALM1.EXAMPLE.COM';

-- Cross-realm automatique
```

### Sc√©nario 3 : Conformit√© et tra√ßabilit√©

```sql
-- Exigence : Tra√ßabilit√© nominative pour audit (SOX, HIPAA)

-- Utilisateurs nominatifs Kerberos
CREATE USER 'auditor1@EXAMPLE.COM'@'%'
    IDENTIFIED VIA gssapi
    AS 'auditor1@EXAMPLE.COM'
    REQUIRE SSL;

CREATE USER 'auditor2@EXAMPLE.COM'@'%'
    IDENTIFIED VIA gssapi
    AS 'auditor2@EXAMPLE.COM'
    REQUIRE SSL;

-- Audit centralis√©
SET GLOBAL server_audit_logging = ON;
SET GLOBAL server_audit_events = 'CONNECT,QUERY,TABLE';
SET GLOBAL server_audit_incl_users = 'auditor1@EXAMPLE.COM,auditor2@EXAMPLE.COM';

-- Logs Kerberos + MariaDB ‚Üí SIEM
SET GLOBAL server_audit_output_type = 'SYSLOG';
```

---

## D√©pannage

### Probl√®me 1 : "Clock skew too great"

```bash
# Sympt√¥me
kinit john.doe@EXAMPLE.COM
# kinit: Clock skew too great while getting initial credentials

# Diagnostic
date
# Wed Dec 13 10:05:00 UTC 2025

# Sur le KDC/DC
ssh dc1.example.com date
# Wed Dec 13 10:15:00 UTC 2025
# ‚Üë D√©calage de 10 minutes !

# Solution
sudo ntpdate dc1.example.com
sudo systemctl restart ntp

# V√©rifier
ntpq -p
```

### Probl√®me 2 : "Server not found in Kerberos database"

```bash
# Sympt√¥me
mysql -u john.doe -h mariadb-server.example.com
# ERROR: Server not found in Kerberos database

# Diagnostic : Le SPN n'existe pas
# V√©rifier le keytab
sudo -u mysql klist -k /etc/mysql/mariadb.keytab

# V√©rifier le principal dans AD/KDC
kadmin.local
kadmin: listprincs mariadb*
# mariadb/mariadb-server.example.com@EXAMPLE.COM

# Si absent ‚Üí recr√©er le principal
kadmin: addprinc -randkey mariadb/mariadb-server.example.com@EXAMPLE.COM
kadmin: ktadd -k /tmp/new.keytab mariadb/mariadb-server.example.com@EXAMPLE.COM

# Remplacer le keytab
sudo mv /tmp/new.keytab /etc/mysql/mariadb.keytab
sudo chown mysql:mysql /etc/mysql/mariadb.keytab
sudo chmod 400 /etc/mysql/mariadb.keytab

# Red√©marrer MariaDB
sudo systemctl restart mariadb
```

### Probl√®me 3 : "No valid credentials"

```bash
# Sympt√¥me
mysql -u john.doe -h mariadb-server.example.com
# ERROR: No valid Kerberos credentials

# Diagnostic : Pas de TGT
klist
# klist: No credentials cache found

# Solution : Obtenir un TGT
kinit john.doe@EXAMPLE.COM

# V√©rifier
klist
# Valid starting     Expires            Service principal
# 12/13/25 10:00:00  12/13/25 20:00:00  krbtgt/EXAMPLE.COM@EXAMPLE.COM

# R√©essayer la connexion
mysql -u john.doe -h mariadb-server.example.com
```

### Probl√®me 4 : "Cannot resolve network address"

```bash
# Sympt√¥me
kinit -k -t /etc/mysql/mariadb.keytab mariadb/mariadb-server.example.com@EXAMPLE.COM
# kinit: Cannot resolve network address for KDC in realm EXAMPLE.COM

# Diagnostic : DNS ou /etc/krb5.conf incorrect
nslookup dc1.example.com
# Server: 8.8.8.8
# Non-authoritative answer:
# Name: dc1.example.com
# Address: 192.168.1.10

# V√©rifier /etc/krb5.conf
cat /etc/krb5.conf | grep -A 5 "\[realms\]"

# Corriger si n√©cessaire
sudo vi /etc/krb5.conf
# [realms]
#     EXAMPLE.COM = {
#         kdc = dc1.example.com:88  ‚Üê V√©rifier
#     }
```

### Probl√®me 5 : Debug mode

```sql
-- Activer le debug MariaDB
SET GLOBAL log_warnings = 4;

-- Red√©marrer avec verbose logging
```

```bash
# Debug Kerberos c√¥t√© client
export KRB5_TRACE=/tmp/krb5_trace.log

kinit john.doe@EXAMPLE.COM

cat /tmp/krb5_trace.log
# [12345] 1702467600.123456: Getting initial credentials for john.doe@EXAMPLE.COM
# [12345] 1702467600.234567: Sending request to KDC...
# ...
```

---

## Comparaison avec autres plugins

| Crit√®re | ed25519 | PAM/LDAP | GSSAPI/Kerberos |
|---------|---------|----------|-----------------|
| **SSO** | ‚ùå Non | ‚ö†Ô∏è Partiel | ‚úÖ‚úÖ Oui (natif) |
| **Authentification mutuelle** | ‚ùå Non | ‚ùå Non | ‚úÖ Oui |
| **Complexit√© d√©ploiement** | ‚úÖ Simple | ‚ö†Ô∏è Moyenne | ‚ùå √âlev√©e |
| **D√©pendances** | ‚úÖ Aucune | ‚ö†Ô∏è PAM/LDAP server | ‚ùå KDC, keytab, NTP |
| **Performance** | ‚úÖ‚úÖ Excellente | ‚úÖ Bonne | ‚úÖ Bonne |
| **R√©silience** | ‚úÖ‚úÖ Locale | ‚ö†Ô∏è D√©pend backend | ‚ùå D√©pend KDC |
| **Transmission password** | ‚ö†Ô∏è Hash | ‚ö†Ô∏è Credential | ‚úÖ Jamais (ticket) |
| **Expiration auto** | ‚ùå Manuel | ‚ö†Ô∏è Selon backend | ‚úÖ Ticket expire |
| **Int√©gration AD** | ‚ùå Non | ‚úÖ Via PAM | ‚úÖ‚úÖ Native |
| **Audit centralis√©** | ‚ùå Local | ‚úÖ Possible | ‚úÖ‚úÖ Native |
| **Cas d'usage optimal** | Cloud, autonome | Linux enterprise | AD/Kerberos enterprise |

### Recommandations

**Utiliser GSSAPI/Kerberos si** :
- ‚úÖ Infrastructure Kerberos/AD d√©j√† en place
- ‚úÖ Besoin de SSO (Single Sign-On)
- ‚úÖ Conformit√© exige authentification nominative centralis√©e
- ‚úÖ Environnement Windows/AD dominant

**√âviter GSSAPI/Kerberos si** :
- ‚ùå Pas de Kerberos existant (complexit√© d'installation)
- ‚ùå Environnement cloud avec haute dynamicit√©
- ‚ùå Petite √©quipe sans expertise Kerberos
- ‚ùå Besoin de simplicit√© maximale

**Hybride recommand√©** :
```sql
-- Utilisateurs AD : GSSAPI/Kerberos (SSO)
CREATE USER 'john.doe@EXAMPLE.COM'@'%'
    IDENTIFIED VIA gssapi
    AS 'john.doe@EXAMPLE.COM';

-- Applications : ed25519 (simple, robuste)
CREATE USER 'app_service'@'app-servers%'
    IDENTIFIED VIA ed25519
    USING PASSWORD('AppP@ss2025');

-- Compte d'urgence : ed25519 local
CREATE USER 'emergency'@'localhost'
    IDENTIFIED VIA ed25519
    USING PASSWORD('EmergencyP@ss!');
```

---

## ‚úÖ Points cl√©s √† retenir

- **GSSAPI** est une API standard, **Kerberos** est le m√©canisme d'authentification
- **SSO natif** : Utilisateurs s'authentifient une fois au niveau OS
- **Aucun mot de passe transmis** : Authentification par tickets Kerberos
- **Authentification mutuelle** : Client et serveur se valident mutuellement
- **Keytab critique** : Permissions 400, rotation r√©guli√®re obligatoire
- **NTP obligatoire** : Synchronisation horaire < 5 minutes (clockskew)
- **Int√©gration AD** : SPN, compatibilit√© algorithmes de chiffrement
- **Compte d'urgence local** : Toujours avoir un fallback ed25519
- **Complexit√© √©lev√©e** : Expertise Kerberos requise, nombreuses d√©pendances
- **Production enterprise** : Id√©al pour grandes organisations avec AD/Kerberos mature

---

## üîó Ressources et r√©f√©rences

- [üìñ Documentation officielle - GSSAPI plugin](https://mariadb.com/kb/en/authentication-plugin-gssapi/)
- [üìñ RFC 4120 - The Kerberos Network Authentication Service (V5)](https://tools.ietf.org/html/rfc4120)
- [üìñ RFC 2743 - Generic Security Service Application Program Interface](https://tools.ietf.org/html/rfc2743)
- [üìñ MIT Kerberos documentation](https://web.mit.edu/kerberos/krb5-latest/doc/)
- [üìñ Active Directory and Kerberos](https://learn.microsoft.com/en-us/windows-server/security/kerberos/kerberos-authentication-overview)
- [Blog : Implementing SSO with Kerberos](https://mariadb.org/kerberos-sso-best-practices/)

---

## ‚û°Ô∏è Section suivante

**10.6 [Plugin d'authentification PARSEC](/10-securite-gestion-utilisateurs/06-plugin-parsec.md)** üÜï : D√©couvrez le nouveau plugin d'authentification PARSEC de MariaDB 11.8, con√ßu pour les environnements s√©curis√©s avec support HSM (Hardware Security Module).

‚è≠Ô∏è [Plugin d'authentification PARSEC](/10-securite-gestion-utilisateurs/06-plugin-parsec.md)
