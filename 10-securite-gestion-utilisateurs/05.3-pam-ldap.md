üîù Retour au [Sommaire](/SOMMAIRE.md)

# 10.5.3 PAM et LDAP

> **Niveau** : Avanc√©
> **Dur√©e estim√©e** : 2.5 heures
> **Pr√©requis** : Sections 10.5.1 (mysql_native_password), 10.5.2 (ed25519), connaissance de PAM/LDAP

## üéØ Objectifs d'apprentissage

√Ä l'issue de cette section, vous serez capable de :
- Comprendre les diff√©rences entre authentification PAM et LDAP
- Configurer l'authentification PAM pour MariaDB sur Linux
- Int√©grer MariaDB avec Active Directory et OpenLDAP
- Impl√©menter une authentification centralis√©e d'entreprise
- Diagnostiquer et r√©soudre les probl√®mes d'authentification externe
- Mettre en ≈ìuvre les bonnes pratiques de s√©curit√© pour l'authentification centralis√©e

---

## Introduction

**PAM** (Pluggable Authentication Modules) et **LDAP** (Lightweight Directory Access Protocol) permettent d'int√©grer MariaDB dans l'infrastructure d'authentification existante de l'entreprise, offrant une **gestion centralis√©e** des identit√©s et des privil√®ges.

Ces plugins sont particuli√®rement adapt√©s aux environnements d'entreprise o√π :
- Les utilisateurs sont d√©j√† g√©r√©s dans Active Directory ou OpenLDAP
- La conformit√© exige une authentification centralis√©e (SOX, HIPAA, PCI-DSS)
- Le SSO (Single Sign-On) est requis
- L'audit centralis√© est n√©cessaire

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Authentification Centralis√©e               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                             ‚îÇ
‚îÇ  MariaDB ‚îÄ‚îÄ‚ñ∫ PAM ‚îÄ‚îÄ‚ñ∫ LDAP/AD ‚îÄ‚îÄ‚ñ∫ Directory Service          ‚îÇ
‚îÇ              ‚îÇ                                              ‚îÇ
‚îÇ              ‚îî‚îÄ‚îÄ‚ñ∫ Local System (/etc/passwd, /etc/shadow)   ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  Avantages :                                                ‚îÇ
‚îÇ  ‚úÖ Gestion centralis√©e des utilisateurs                    ‚îÇ
‚îÇ  ‚úÖ Politique de mots de passe unifi√©e                      ‚îÇ
‚îÇ  ‚úÖ Audit centralis√©                                        ‚îÇ
‚îÇ  ‚úÖ R√©vocation imm√©diate (d√©sactivation AD ‚Üí MariaDB)       ‚îÇ
‚îÇ  ‚úÖ SSO possible (avec Kerberos/GSSAPI)                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## Diff√©rences PAM vs LDAP

### Comparaison conceptuelle

| Aspect | PAM | LDAP |
|--------|-----|------|
| **Type** | Framework d'authentification | Protocole d'annuaire |
| **Scope** | Syst√®me local ‚Üí backend configurable | Connexion directe √† annuaire |
| **Flexibilit√©** | ‚úÖ Tr√®s √©lev√©e (multi-backend) | ‚ö†Ô∏è LDAP uniquement |
| **Configuration** | PAM stack (fichiers /etc/pam.d/) | Param√®tres LDAP (serveur, DN, etc.) |
| **D√©pendances** | libpam, modules PAM | libldap, serveur LDAP |
| **Cas d'usage** | Auth syst√®me Linux, multi-source | Auth Active Directory, OpenLDAP |

### Quand utiliser PAM vs LDAP

**Utiliser PAM quand** :
- ‚úÖ Infrastructure Linux existante avec PAM configur√©
- ‚úÖ Besoin de flexibilit√© (LDAP + fallback local, multi-factor, etc.)
- ‚úÖ Int√©gration avec syst√®me de s√©curit√© Linux (SELinux, AppArmor)
- ‚úÖ D√©j√† utilis√© pour SSH, sudo, etc.

**Utiliser LDAP quand** :
- ‚úÖ Environnement Active Directory Windows
- ‚úÖ OpenLDAP comme source unique de v√©rit√©
- ‚úÖ Pas de PAM configur√© ou trop complexe
- ‚úÖ Migration depuis autre SGBD avec LDAP

üí° **Best practice** : PAM est g√©n√©ralement pr√©f√©r√© car il peut utiliser LDAP en backend tout en offrant plus de flexibilit√©.

---

## Plugin PAM

### Architecture et fonctionnement

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Client  ‚îÇ              ‚îÇ MariaDB  ‚îÇ              ‚îÇ   PAM    ‚îÇ
‚îÇ          ‚îÇ              ‚îÇ  Server  ‚îÇ              ‚îÇ  Stack   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
      ‚îÇ                        ‚îÇ                         ‚îÇ
      ‚îÇ 1. Connection request  ‚îÇ                         ‚îÇ
      ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ                         ‚îÇ
      ‚îÇ                        ‚îÇ                         ‚îÇ
      ‚îÇ                        ‚îÇ 2. Call PAM             ‚îÇ
      ‚îÇ                        ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ>‚îÇ
      ‚îÇ                        ‚îÇ                         ‚îÇ
      ‚îÇ                        ‚îÇ                         ‚îÇ 3. Execute PAM modules
      ‚îÇ                        ‚îÇ                         ‚îÇ    (pam_ldap, pam_unix, etc.)
      ‚îÇ                        ‚îÇ                         ‚îÇ
      ‚îÇ                        ‚îÇ 4. Return auth result   ‚îÇ
      ‚îÇ                        ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ
      ‚îÇ                        ‚îÇ                         ‚îÇ
      ‚îÇ 5. Grant/Deny access   ‚îÇ                         ‚îÇ
      ‚îÇ<‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ                         ‚îÇ
      ‚îÇ                        ‚îÇ                         ‚îÇ
```

### Installation du plugin

```sql
-- V√©rifier la disponibilit√©
SHOW PLUGINS WHERE Name LIKE '%pam%';

-- Installer si n√©cessaire (g√©n√©ralement d√©j√† compil√©)
INSTALL SONAME 'auth_pam';

-- V√©rifier l'installation
SELECT * FROM information_schema.PLUGINS
WHERE PLUGIN_NAME = 'pam';

-- R√©sultat attendu :
-- PLUGIN_NAME: pam
-- PLUGIN_STATUS: ACTIVE
-- PLUGIN_TYPE: AUTHENTICATION
-- PLUGIN_LIBRARY: auth_pam.so
```

### Configuration syst√®me PAM

#### Cr√©er un service PAM pour MariaDB

```bash
# Cr√©er /etc/pam.d/mariadb
sudo vi /etc/pam.d/mariadb
```

**Configuration basique (authentification syst√®me locale)** :

```bash
# /etc/pam.d/mariadb
# Authentification Unix standard (contre /etc/shadow)

auth       required     pam_unix.so
account    required     pam_unix.so
```

**Configuration avec LDAP** :

```bash
# /etc/pam.d/mariadb
# Authentification LDAP avec fallback local

# Tentative LDAP d'abord
auth       sufficient   pam_ldap.so
# Si LDAP √©choue, essayer local
auth       required     pam_unix.so

account    sufficient   pam_ldap.so
account    required     pam_unix.so
```

**Configuration avanc√©e (avec logging et restrictions)** :

```bash
# /etc/pam.d/mariadb
# Production-grade avec audit

# Logging
auth       optional     pam_echo.so file=/var/log/mariadb-pam.log

# Time-based access (exemple : heures bureau uniquement)
auth       required     pam_time.so

# LDAP primary
auth       [success=1 default=ignore] pam_ldap.so
# Local fallback
auth       requisite    pam_unix.so
# Deny by default
auth       required     pam_deny.so

account    sufficient   pam_ldap.so
account    required     pam_unix.so

# Session logging
session    optional     pam_lastlog.so
```

‚ö†Ô∏è **Permissions critiques** :

```bash
# Fichier de configuration PAM doit √™tre prot√©g√©
sudo chmod 644 /etc/pam.d/mariadb
sudo chown root:root /etc/pam.d/mariadb

# V√©rifier les permissions
ls -l /etc/pam.d/mariadb
# -rw-r--r-- 1 root root 256 Dec 13 10:00 /etc/pam.d/mariadb
```

### Configuration LDAP pour PAM

```bash
# /etc/ldap.conf ou /etc/pam_ldap.conf
# Configuration du backend LDAP

# Serveur LDAP
uri ldap://ldap.example.com:389
uri ldaps://ldap.example.com:636  # Pr√©f√©r√© (SSL)

# Base DN
base dc=example,dc=com

# Bind DN pour la recherche (compte service)
binddn cn=mariadb-service,ou=services,dc=example,dc=com
bindpw SecureServicePassword123

# SSL/TLS (OBLIGATOIRE en production)
ssl start_tls
tls_cacertfile /etc/ssl/certs/ca-certificates.crt
tls_reqcert demand

# Recherche utilisateurs
pam_login_attribute uid
pam_filter objectClass=posixAccount

# Timeout
bind_timelimit 10
timelimit 10
```

üí° **S√©curit√©** : Le fichier `ldap.conf` contient des credentials ‚Üí prot√©gez-le :

```bash
sudo chmod 600 /etc/ldap.conf
sudo chown root:root /etc/ldap.conf
```

### Cr√©ation d'utilisateurs PAM dans MariaDB

```sql
-- Utilisateur authentifi√© via PAM (service mariadb)
CREATE USER 'john.doe'@'%'
    IDENTIFIED VIA pam
    USING 'mariadb';
--                  ‚Üë
--                  Nom du service PAM (/etc/pam.d/mariadb)

-- Utilisateur PAM avec service alternatif
CREATE USER 'admin_user'@'localhost'
    IDENTIFIED VIA pam
    USING 'mariadb-admin';
-- N√©cessite /etc/pam.d/mariadb-admin

-- V√©rifier
SHOW CREATE USER 'john.doe'@'%';
-- CREATE USER `john.doe`@`%` IDENTIFIED VIA pam USING 'mariadb'
```

### Mapping utilisateurs PAM

MariaDB peut mapper des utilisateurs PAM vers des comptes MariaDB :

```sql
-- Table de mapping (MariaDB 10.4+)
-- Permet de mapper user1 PAM ‚Üí user1_db MariaDB

CREATE USER ''@'%'
    IDENTIFIED VIA pam USING 'mariadb';
-- Utilisateur anonyme avec PAM = tous les utilisateurs PAM

-- Cr√©er un compte proxy
CREATE USER 'pam_proxy'@'%' IDENTIFIED BY '';

-- Mapper les utilisateurs PAM vers le proxy
GRANT PROXY ON 'pam_proxy'@'%' TO ''@'%';

-- Privil√®ges sur le compte proxy
GRANT SELECT, INSERT, UPDATE, DELETE ON app_db.*
    TO 'pam_proxy'@'%';

-- R√©sultat : tous les utilisateurs PAM authentifi√©s obtiennent les privil√®ges de pam_proxy
```

üí° **Cas d'usage** : Utile quand vous avez de nombreux utilisateurs LDAP/AD et ne voulez pas cr√©er un compte MariaDB pour chacun.

---

## Plugin LDAP

### Installation et activation

```sql
-- Plugin LDAP simple (MariaDB 10.6+)
INSTALL SONAME 'auth_ldap_simple';

-- V√©rifier
SELECT PLUGIN_NAME, PLUGIN_STATUS, PLUGIN_LIBRARY
FROM information_schema.PLUGINS
WHERE PLUGIN_NAME LIKE '%ldap%';

-- Configuration globale LDAP
SET GLOBAL ldap_host = 'ldap.example.com';
SET GLOBAL ldap_port = 389;  -- Ou 636 pour LDAPS
SET GLOBAL ldap_base_dn = 'dc=example,dc=com';
SET GLOBAL ldap_bind_dn = 'cn=mariadb-service,ou=services,dc=example,dc=com';
SET GLOBAL ldap_bind_password = 'ServicePassword123';

-- Activer TLS (OBLIGATOIRE en production)
SET GLOBAL ldap_tls = 1;
SET GLOBAL ldap_tls_ca_path = '/etc/ssl/certs';
```

### Configuration dans my.cnf

```ini
# my.cnf / mariadb.cnf
[mysqld]

# Plugin LDAP
plugin-load-add = auth_ldap_simple.so

# Configuration LDAP
ldap_host = ldap.example.com
ldap_port = 636  # LDAPS
ldap_base_dn = dc=example,dc=com
ldap_bind_dn = cn=mariadb-service,ou=services,dc=example,dc=com
ldap_bind_password = ServicePassword123

# S√©curit√©
ldap_tls = 1
ldap_tls_ca_path = /etc/ssl/certs
ldap_tls_cert_file = /etc/ssl/certs/mariadb-ldap.crt
ldap_tls_key_file = /etc/ssl/private/mariadb-ldap.key

# Recherche
ldap_search_filter = (uid=%s)
ldap_user_search_attr = uid

# Timeout
ldap_timeout = 10
```

### Cr√©ation d'utilisateurs LDAP

```sql
-- Utilisateur authentifi√© directement via LDAP
CREATE USER 'john.doe'@'%'
    IDENTIFIED VIA ldap_simple;

-- MariaDB cherchera uid=john.doe dans l'annuaire LDAP

-- Utilisateur avec DN sp√©cifique
CREATE USER 'admin'@'%'
    IDENTIFIED VIA ldap_simple
    AS 'cn=admin,ou=admins,dc=example,dc=com';
```

---

## Int√©gration Active Directory

### Configuration pour AD

Active Directory est un cas particulier de LDAP avec ses propres particularit√©s.

#### Configuration PAM pour AD

```bash
# /etc/pam.d/mariadb
# Authentification Active Directory via PAM + SSSD

auth       required     pam_sss.so
account    required     pam_sss.so
```

```bash
# /etc/sssd/sssd.conf
# Configuration SSSD pour AD

[sssd]
domains = example.com
services = nss, pam
config_file_version = 2

[domain/example.com]
id_provider = ad
auth_provider = ad
access_provider = ad

# AD Server
ad_server = dc1.example.com
ad_domain = example.com
ad_hostname = mariadb-server.example.com

# Kerberos
krb5_realm = EXAMPLE.COM
krb5_server = dc1.example.com

# Recherche utilisateurs
ldap_user_search_base = ou=Users,dc=example,dc=com
ldap_group_search_base = ou=Groups,dc=example,dc=com

# Cache
cache_credentials = true

# TLS
ldap_id_use_start_tls = true
ldap_tls_cacert = /etc/ssl/certs/ca-bundle.crt
```

```bash
# Permissions SSSD
sudo chmod 600 /etc/sssd/sssd.conf
sudo chown root:root /etc/sssd/sssd.conf

# Red√©marrer SSSD
sudo systemctl restart sssd

# Tester l'authentification
id john.doe@example.com
# uid=1234567890(john.doe@example.com) gid=...
```

#### Configuration LDAP direct pour AD

```ini
# my.cnf
[mysqld]

# Active Directory LDAP
ldap_host = dc1.example.com
ldap_port = 636  # LDAPS obligatoire
ldap_base_dn = dc=example,dc=com

# Compte service AD
ldap_bind_dn = cn=mariadb-svc,ou=Service Accounts,dc=example,dc=com
ldap_bind_password = ADServicePassword123!

# Attributs AD
ldap_search_filter = (&(objectClass=user)(sAMAccountName=%s))
ldap_user_search_attr = sAMAccountName

# Groupes AD (optionnel)
ldap_group_search_attr = memberOf
ldap_group_search_filter = (cn=MariaDB-Users)

# TLS
ldap_tls = 1
ldap_tls_ca_path = /etc/ssl/certs
```

### Utilisateurs AD dans MariaDB

```sql
-- Format UPN (User Principal Name)
CREATE USER 'john.doe@example.com'@'%'
    IDENTIFIED VIA pam
    USING 'mariadb';

-- Ou format sAMAccountName
CREATE USER 'jdoe'@'%'
    IDENTIFIED VIA ldap_simple;

-- Groupe AD (via proxy)
CREATE USER 'AD\MariaDB-Users'@'%'
    IDENTIFIED VIA pam
    USING 'mariadb';

-- Mapper tous les membres du groupe
CREATE USER 'db_user_proxy'@'%';
GRANT PROXY ON 'db_user_proxy'@'%' TO 'AD\MariaDB-Users'@'%';
GRANT SELECT ON app_db.* TO 'db_user_proxy'@'%';
```

---

## S√©curit√© et bonnes pratiques

### 1. SSL/TLS obligatoire

```ini
# my.cnf - LDAP avec TLS obligatoire
[mysqld]
ldap_tls = 1
ldap_tls_require_cert = demand  # V√©rifier le certificat

# Connexions MariaDB avec SSL aussi
require_secure_transport = ON
```

```sql
-- Forcer SSL pour utilisateurs PAM/LDAP
CREATE USER 'john.doe'@'%'
    IDENTIFIED VIA pam USING 'mariadb'
    REQUIRE SSL;
```

### 2. Compte service d√©di√©

```ldap
# Dans LDAP/AD : cr√©er un compte service d√©di√©
dn: cn=mariadb-service,ou=services,dc=example,dc=com
objectClass: simpleSecurityObject
objectClass: organizationalRole
cn: mariadb-service
userPassword: {SSHA}...
description: Service account for MariaDB LDAP authentication

# Permissions minimales :
# - Lecture uniquement
# - Acc√®s √† ou=Users uniquement
# - Pas de privil√®ges admin
```

### 3. Monitoring et audit

```sql
-- Activer l'audit des authentifications
INSTALL SONAME 'server_audit';

SET GLOBAL server_audit_logging = ON;
SET GLOBAL server_audit_events = 'CONNECT,FAILED_CONNECT';
SET GLOBAL server_audit_incl_users = 'john.doe,jane.smith';

-- Logs centralis√©s (syslog)
SET GLOBAL server_audit_output_type = 'SYSLOG';
```

```bash
# Analyser les logs d'authentification PAM
sudo tail -f /var/log/auth.log | grep mariadb

# Ou avec journalctl
sudo journalctl -u mariadb -f | grep -i pam
```

### 4. Fallback et r√©silience

```bash
# /etc/pam.d/mariadb
# Fallback local si LDAP indisponible

auth       [success=done new_authtok_reqd=done default=ignore] pam_ldap.so
auth       requisite    pam_unix.so nullok_secure
auth       optional     pam_permit.so

# Si LDAP down, authentification locale fonctionne
```

```sql
-- Compte d'urgence local (en dehors de PAM/LDAP)
CREATE USER 'emergency_admin'@'localhost'
    IDENTIFIED VIA ed25519
    USING PASSWORD('EmergencyP@ss123!');

GRANT ALL PRIVILEGES ON *.*
    TO 'emergency_admin'@'localhost'
    WITH GRANT OPTION;

-- Documenter et prot√©ger ce compte
```

### 5. Limitation des tentatives

```bash
# /etc/pam.d/mariadb
# Protection contre brute-force

auth       required     pam_faillock.so preauth deny=5 unlock_time=600
auth       sufficient   pam_ldap.so
auth       [default=die] pam_faillock.so authfail
auth       sufficient   pam_unix.so
auth       required     pam_deny.so

account    required     pam_faillock.so
```

### 6. Rotation des credentials service

```bash
#!/bin/bash
# rotate_ldap_service_password.sh

# Nouveau mot de passe
NEW_PASSWORD=$(openssl rand -base64 24)

# Mise √† jour dans LDAP/AD
ldappasswd -H ldaps://ldap.example.com \
    -D "cn=admin,dc=example,dc=com" \
    -w AdminPassword \
    -s "$NEW_PASSWORD" \
    "cn=mariadb-service,ou=services,dc=example,dc=com"

# Mise √† jour dans MariaDB
mysql -u root -p <<EOF
SET GLOBAL ldap_bind_password = '$NEW_PASSWORD';
EOF

# Mise √† jour dans my.cnf (pour persistance)
sudo sed -i "s/^ldap_bind_password = .*/ldap_bind_password = $NEW_PASSWORD/" /etc/mysql/my.cnf

# Log
echo "$(date): LDAP service password rotated" >> /var/log/mariadb-security.log
```

---

## Cas d'usage production

### Sc√©nario 1 : Entreprise avec Active Directory

```sql
-- Configuration : 1000 employ√©s dans AD
-- Besoin : Acc√®s MariaDB pour √©quipe data (50 personnes)

-- 1. Cr√©er groupe AD "MariaDB-Analysts"
-- 2. Ajouter les 50 personnes au groupe

-- 3. Dans MariaDB : mapping de groupe
CREATE USER ''@'%'
    IDENTIFIED VIA pam USING 'mariadb';

CREATE USER 'analyst_proxy'@'%';

GRANT PROXY ON 'analyst_proxy'@'%' TO ''@'%';

GRANT SELECT ON analytics_db.* TO 'analyst_proxy'@'%';

-- R√©sultat : Tous les membres de MariaDB-Analysts peuvent se connecter
-- Ajout/retrait dans AD ‚Üí effet imm√©diat dans MariaDB
```

### Sc√©nario 2 : Multi-tenant SaaS

```sql
-- Chaque client a son propre annuaire LDAP
-- Besoin : Isolation par tenant

-- Tenant A
CREATE USER 'tenant_a_user'@'tenant-a%'
    IDENTIFIED VIA ldap_simple;

SET GLOBAL ldap_host = 'ldap.tenant-a.com';
GRANT SELECT ON tenant_a_db.* TO 'tenant_a_user'@'tenant-a%';

-- Tenant B
CREATE USER 'tenant_b_user'@'tenant-b%'
    IDENTIFIED VIA ldap_simple;

SET GLOBAL ldap_host = 'ldap.tenant-b.com';
GRANT SELECT ON tenant_b_db.* TO 'tenant_b_user'@'tenant-b%';

-- Note : Configuration complexe, envisager des instances s√©par√©es
```

### Sc√©nario 3 : Conformit√© et audit

```sql
-- Exigence : Tra√ßabilit√© compl√®te des acc√®s

-- 1. Utilisateurs nominatifs (pas de comptes partag√©s)
CREATE USER 'john.doe@example.com'@'%'
    IDENTIFIED VIA pam USING 'mariadb'
    REQUIRE SSL;

-- 2. Audit centralis√©
SET GLOBAL server_audit_logging = ON;
SET GLOBAL server_audit_events = 'CONNECT,QUERY,TABLE';
SET GLOBAL server_audit_incl_users = 'john.doe@example.com,jane.smith@example.com';

-- 3. Logs vers SIEM
SET GLOBAL server_audit_output_type = 'SYSLOG';
SET GLOBAL server_audit_syslog_facility = 'LOG_LOCAL0';

-- 4. R√©vocation imm√©diate
-- D√©sactiver dans AD ‚Üí acc√®s MariaDB r√©voqu√© instantan√©ment
```

---

## D√©pannage

### Probl√®me 1 : "Access denied" avec PAM

```bash
# Diagnostic
# 1. V√©rifier que le plugin PAM est actif
mysql -u root -p -e "SHOW PLUGINS WHERE Name = 'pam';"

# 2. Tester PAM en dehors de MariaDB
sudo pamtester mariadb john.doe authenticate
# Si √©chec ‚Üí probl√®me de configuration PAM

# 3. V√©rifier les logs
sudo tail -f /var/log/auth.log

# 4. Tester l'utilisateur syst√®me
id john.doe
# Si "no such user" ‚Üí utilisateur n'existe pas dans le syst√®me

# 5. V√©rifier le service PAM
cat /etc/pam.d/mariadb

# 6. Debug MariaDB
mysql -u root -p
SET GLOBAL log_warnings = 3;
# R√©essayer la connexion, examiner error log
```

### Probl√®me 2 : LDAP timeout

```sql
-- Sympt√¥me : Connexions lentes ou timeouts

-- V√©rifier la connectivit√© LDAP
SELECT @@ldap_host, @@ldap_port;

-- Tester depuis le serveur MariaDB
```

```bash
# Test LDAP direct
ldapsearch -x -H ldaps://ldap.example.com:636 \
    -D "cn=mariadb-service,ou=services,dc=example,dc=com" \
    -w ServicePassword \
    -b "dc=example,dc=com" \
    "(uid=john.doe)"

# Si timeout ‚Üí probl√®me r√©seau/firewall
# V√©rifier :
# - Firewall : port 389/636 ouvert
# - DNS : r√©solution de ldap.example.com
# - Certificats SSL : validit√©
```

```sql
-- Augmenter les timeouts
SET GLOBAL ldap_timeout = 30;  -- 30 secondes
```

### Probl√®me 3 : Certificat SSL/TLS invalide

```bash
# Sympt√¥me : "TLS/SSL error" dans logs

# V√©rifier le certificat du serveur LDAP
openssl s_client -connect ldap.example.com:636 -showcerts

# Importer le CA dans le truststore MariaDB
sudo cp ldap-ca.crt /etc/ssl/certs/
sudo update-ca-certificates

# V√©rifier la configuration
```

```ini
# my.cnf
ldap_tls_ca_path = /etc/ssl/certs
ldap_tls_require_cert = demand  # ou allow pour debug (pas en prod)
```

### Probl√®me 4 : Mapping utilisateurs ne fonctionne pas

```sql
-- V√©rifier le mapping proxy
SHOW GRANTS FOR ''@'%';
-- Doit inclure : GRANT PROXY ON 'proxy_user'@'%' TO ''@'%'

-- V√©rifier l'utilisateur proxy
SHOW GRANTS FOR 'proxy_user'@'%';

-- Tester manuellement
SELECT USER(), CURRENT_USER();
-- USER() = utilisateur PAM/LDAP
-- CURRENT_USER() = utilisateur proxy mapp√©
```

---

## Comparaison avec ed25519

| Crit√®re | ed25519 | PAM | LDAP |
|---------|---------|-----|------|
| **Gestion centralis√©e** | ‚ùå Non | ‚úÖ Oui (via backend) | ‚úÖ Oui |
| **SSO** | ‚ùå Non | ‚úÖ Possible | ‚ö†Ô∏è Limit√© |
| **R√©vocation imm√©diate** | ‚ùå Manuel | ‚úÖ Oui (via backend) | ‚úÖ Oui |
| **Complexit√©** | ‚úÖ Simple | ‚ö†Ô∏è Moyenne | ‚ö†Ô∏è Moyenne |
| **D√©pendances** | ‚úÖ Aucune | ‚ö†Ô∏è PAM + backend | ‚ö†Ô∏è Serveur LDAP |
| **Performance** | ‚úÖ‚úÖ Excellente | ‚úÖ Bonne | ‚ö†Ô∏è D√©pend du r√©seau |
| **R√©silience** | ‚úÖ‚úÖ Locale | ‚ö†Ô∏è D√©pend backend | ‚ùå D√©pend serveur |
| **Audit centralis√©** | ‚ùå Non | ‚úÖ Oui | ‚úÖ Oui |
| **Cas d'usage** | Autonome, cloud | Entreprise Linux | Entreprise AD/LDAP |

### Recommandations

- **Petites √©quipes, cloud** : ed25519
- **Entreprise avec AD/LDAP existant** : PAM ou LDAP
- **Environnement Linux mature** : PAM
- **Pure Windows/AD** : LDAP ou PAM+SSSD
- **Haute disponibilit√© critique** : ed25519 + fallback PAM

---

## ‚úÖ Points cl√©s √† retenir

- **PAM** = Framework flexible, utilise divers backends (LDAP, Unix, Kerberos, etc.)
- **LDAP** = Connexion directe √† annuaire LDAP/Active Directory
- **Authentification centralis√©e** : Gestion unifi√©e des identit√©s, r√©vocation imm√©diate
- **SSL/TLS obligatoire** : Pour LDAP et connexions MariaDB (s√©curit√© r√©seau)
- **Compte service d√©di√©** : Privil√®ges minimaux pour les requ√™tes LDAP
- **Fallback local** : Compte d'urgence ed25519 pour r√©silience
- **Mapping utilisateurs** : Proxy accounts pour simplifier la gestion
- **Active Directory** : Utiliser PAM+SSSD ou LDAP direct
- **Audit centralis√©** : Logs PAM + MariaDB audit plugin
- **Performance** : D√©pend de la latence r√©seau LDAP (caching recommand√©)

---

## üîó Ressources et r√©f√©rences

- [üìñ Documentation officielle - PAM plugin](https://mariadb.com/kb/en/authentication-plugin-pam/)
- [üìñ Documentation officielle - LDAP plugin](https://mariadb.com/kb/en/authentication-plugin-ldap/)
- [üìñ Linux PAM documentation](http://www.linux-pam.org/Linux-PAM-html/)
- [üìñ OpenLDAP documentation](https://www.openldap.org/doc/)
- [üìñ Active Directory LDAP](https://learn.microsoft.com/en-us/previous-versions/windows/desktop/ldap/active-directory-ldap)
- [Blog : Enterprise authentication with PAM](https://mariadb.org/pam-authentication-best-practices/)

---

## ‚û°Ô∏è Section suivante

**10.5.4 [GSSAPI/Kerberos](/10-securite-gestion-utilisateurs/05.4-gssapi-kerberos.md)** : D√©couvrez l'authentification Kerberos pour le Single Sign-On (SSO) d'entreprise avec MariaDB.

‚è≠Ô∏è [GSSAPI/Kerberos](/10-securite-gestion-utilisateurs/05.4-gssapi-kerberos.md)
