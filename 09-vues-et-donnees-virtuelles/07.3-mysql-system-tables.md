üîù Retour au [Sommaire](/SOMMAIRE.md)

# 9.7.3 mysql (System Tables)

> **Niveau** : Interm√©diaire √† Avanc√©
> **Dur√©e estim√©e** : 2-2.5 heures
> **Pr√©requis** : Sections 9.7, 9.7.1 et 9.7.2, administration MariaDB

## üéØ Objectifs d'apprentissage

√Ä l'issue de cette section, vous serez capable de :

- Comprendre l'organisation des tables syst√®me de la base mysql
- Auditer les utilisateurs et leurs privil√®ges via les tables syst√®me
- Identifier les diff√©rences entre mysql.* et INFORMATION_SCHEMA
- G√©rer la configuration du serveur via les tables syst√®me
- Comprendre les tables de r√©plication et de logs
- Appliquer les bonnes pratiques de s√©curit√© pour les tables syst√®me
- Cr√©er des requ√™tes d'audit avanc√©es
- Diagnostiquer les probl√®mes de privil√®ges
- Comprendre quand utiliser GRANT/REVOKE vs manipulation directe

---

## Introduction

### Qu'est-ce que la base mysql ?

La base de donn√©es **mysql** est une base de donn√©es syst√®me sp√©ciale cr√©√©e automatiquement lors de l'installation de MariaDB. Contrairement √† **INFORMATION_SCHEMA** et **PERFORMANCE_SCHEMA** (qui sont des bases virtuelles), **mysql** contient des **tables physiques r√©elles** stock√©es sur disque.

```sql
-- mysql est une vraie base de donn√©es
USE mysql;

-- Lister toutes les tables syst√®me
SHOW TABLES;
-- Plus de 30 tables
-- user, db, tables_priv, columns_priv, procs_priv
-- plugin, servers, time_zone, help_topic
-- ...
```

### R√¥le de la base mysql

La base **mysql** stocke :

1. **Authentification et autorisation** : Utilisateurs et leurs privil√®ges
2. **Configuration** : Param√®tres du serveur, plugins
3. **Donn√©es fonctionnelles** : Fuseaux horaires, aide en ligne
4. **R√©plication** : Configuration des serveurs de r√©plication
5. **Logs** : Historique des requ√™tes lentes (si activ√©)

### Diff√©rences cl√©s : mysql vs INFORMATION_SCHEMA

| Aspect | mysql | INFORMATION_SCHEMA |
|--------|-------|-------------------|
| **Type** | Tables physiques sur disque | Vues virtuelles en m√©moire |
| **Portabilit√©** | Format MariaDB sp√©cifique | Standard SQL (portable) |
| **Modification** | Modifiable (avec pr√©cautions) | Lecture seule uniquement |
| **Contenu** | Configuration serveur, users | M√©tadonn√©es structurelles |
| **Usage** | Administration syst√®me | Interrogation de structure |
| **Sauvegarde** | Inclus dans mysqldump | Jamais sauvegard√© |

‚ö†Ô∏è **Important** : Les tables mysql contiennent des donn√©es critiques. Toute modification incorrecte peut **bloquer l'acc√®s au serveur** ou cr√©er des **failles de s√©curit√©**.

---

## Tables de gestion des utilisateurs

### mysql.user : Table principale des utilisateurs

La table **user** contient tous les comptes utilisateurs et leurs **privil√®ges globaux** (applicables √† toutes les bases de donn√©es).

```sql
-- Structure de mysql.user (simplifi√©)
DESC mysql.user;

-- Colonnes principales (plus de 50 colonnes au total) :
-- Host : H√¥te autoris√© (%, localhost, IP, etc.)
-- User : Nom d'utilisateur
-- Password/authentication_string : Hash du mot de passe
-- Select_priv, Insert_priv, Update_priv, Delete_priv : Privil√®ges DML
-- Create_priv, Drop_priv, Alter_priv : Privil√®ges DDL
-- Grant_priv : Peut donner ses privil√®ges √† d'autres
-- Super_priv : Privil√®ges administratifs
-- Process_priv : Voir tous les processus
-- Reload_priv : FLUSH, RESET
-- Shutdown_priv : Arr√™ter le serveur
-- File_priv : LOAD DATA INFILE, SELECT INTO OUTFILE
-- Show_db_priv : SHOW DATABASES
-- Repl_slave_priv, Repl_client_priv : R√©plication
-- Create_user_priv : CREATE USER, DROP USER
-- max_questions, max_updates, max_connections : Limites de ressources
-- ssl_type, ssl_cipher, x509_issuer, x509_subject : Configuration SSL
-- plugin : Plugin d'authentification (mysql_native_password, etc.)
```

**Requ√™te 1 : Lister tous les utilisateurs**

```sql
SELECT
    Host,
    User,
    Select_priv,
    Insert_priv,
    Update_priv,
    Delete_priv,
    Create_priv,
    Drop_priv,
    Grant_priv,
    Super_priv
FROM mysql.user
ORDER BY User, Host;

-- Vue d'ensemble des utilisateurs et privil√®ges globaux
```

**Requ√™te 2 : Utilisateurs avec privil√®ges Super (administrateurs)**

```sql
SELECT
    CONCAT(User, '@', Host) AS compte,
    Super_priv,
    Grant_priv,
    Create_user_priv,
    Reload_priv,
    Shutdown_priv,
    Process_priv,
    File_priv
FROM mysql.user
WHERE Super_priv = 'Y'
   OR Grant_priv = 'Y'
ORDER BY User;

-- Ces utilisateurs ont des privil√®ges dangereux
```

**Requ√™te 3 : Utilisateurs avec acc√®s depuis n'importe o√π ('%')**

```sql
SELECT
    User,
    Host,
    authentication_string,
    plugin
FROM mysql.user
WHERE Host = '%'
ORDER BY User;

-- Risque de s√©curit√© : acc√®s depuis n'importe quelle IP
```

**Requ√™te 4 : Utilisateurs sans mot de passe**

```sql
SELECT
    CONCAT(User, '@', Host) AS compte_sans_mdp
FROM mysql.user
WHERE authentication_string = ''
   OR authentication_string IS NULL
ORDER BY User;

-- CRITIQUE : comptes sans protection
```

**Requ√™te 5 : Analyse des plugins d'authentification**

```sql
SELECT
    plugin AS methode_auth,
    COUNT(*) AS nb_utilisateurs,
    GROUP_CONCAT(CONCAT(User, '@', Host) SEPARATOR ', ') AS utilisateurs
FROM mysql.user
GROUP BY plugin
ORDER BY nb_utilisateurs DESC;

-- Voir quels types d'authentification sont utilis√©s
-- mysql_native_password, unix_socket, pam, etc.
```

### mysql.db : Privil√®ges par base de donn√©es

La table **db** contient les privil√®ges accord√©s au niveau d'une **base de donn√©es sp√©cifique**.

```sql
-- Structure de mysql.db
DESC mysql.db;

-- Colonnes principales :
-- Host : H√¥te autoris√©
-- Db : Nom de la base (peut contenir % comme wildcard)
-- User : Nom d'utilisateur
-- Select_priv, Insert_priv, Update_priv, Delete_priv
-- Create_priv, Drop_priv, Alter_priv
-- Index_priv, References_priv
-- Create_tmp_table_priv, Lock_tables_priv
-- Create_view_priv, Show_view_priv
-- Create_routine_priv, Alter_routine_priv, Execute_priv
-- Event_priv, Trigger_priv
```

**Requ√™te pratique : Privil√®ges par base et utilisateur**

```sql
SELECT
    User,
    Host,
    Db,
    Select_priv,
    Insert_priv,
    Update_priv,
    Delete_priv,
    Create_priv,
    Drop_priv
FROM mysql.db
WHERE Db = 'production_db'
ORDER BY User, Host;

-- Qui a acc√®s √† production_db ?
```

### mysql.tables_priv : Privil√®ges par table

La table **tables_priv** stocke les privil√®ges accord√©s sur des **tables sp√©cifiques**.

```sql
-- Structure de mysql.tables_priv
DESC mysql.tables_priv;

-- Colonnes principales :
-- Host, Db, User : Identifiant du compte
-- Table_name : Nom de la table
-- Grantor : Qui a accord√© le privil√®ge
-- Timestamp : Quand le privil√®ge a √©t√© accord√©
-- Table_priv : Privil√®ges table (SET: Select, Insert, Update, etc.)
-- Column_priv : Privil√®ges colonnes (si granularit√© colonne)
```

**Requ√™te pratique : Privil√®ges sp√©cifiques sur les tables**

```sql
SELECT
    CONCAT(User, '@', Host) AS compte,
    Db,
    Table_name,
    Table_priv,
    Column_priv,
    Grantor,
    Timestamp
FROM mysql.tables_priv
WHERE Db = 'production_db'
ORDER BY Table_name, User;
```

### mysql.columns_priv : Privil√®ges par colonne

La table **columns_priv** contient les privil√®ges au niveau des **colonnes individuelles** (granularit√© maximale).

```sql
-- Structure de mysql.columns_priv
DESC mysql.columns_priv;

-- Colonnes principales :
-- Host, Db, User, Table_name : Identification
-- Column_name : Nom de la colonne
-- Timestamp : Date d'attribution
-- Column_priv : Privil√®ges (SET: Select, Insert, Update, References)
```

**Requ√™te pratique : Privil√®ges au niveau colonne**

```sql
SELECT
    CONCAT(User, '@', Host) AS compte,
    Db,
    Table_name,
    Column_name,
    Column_priv,
    Timestamp
FROM mysql.columns_priv
WHERE Db = 'production_db'
ORDER BY Table_name, Column_name, User;

-- Privil√®ges tr√®s granulaires (peu fr√©quent)
```

### mysql.procs_priv : Privil√®ges sur proc√©dures/fonctions

```sql
-- Privil√®ges sur les routines stock√©es
SELECT
    CONCAT(User, '@', Host) AS compte,
    Db,
    Routine_name,
    Routine_type,  -- FUNCTION ou PROCEDURE
    Proc_priv,     -- Execute, Alter Routine, Grant
    Grantor,
    Timestamp
FROM mysql.procs_priv
WHERE Db = 'production_db'
ORDER BY Routine_name, User;
```

---

## Audit complet des privil√®ges

### Requ√™te compl√®te : Tous les privil√®ges d'un utilisateur

```sql
-- Vue d'ensemble compl√®te des privil√®ges pour 'app_user'@'%'
SET @target_user = 'app_user';
SET @target_host = '%';

-- 1. Privil√®ges globaux
SELECT
    'GLOBAL' AS niveau,
    '*.*' AS objet,
    CONCAT_WS(', ',
        IF(Select_priv='Y', 'SELECT', NULL),
        IF(Insert_priv='Y', 'INSERT', NULL),
        IF(Update_priv='Y', 'UPDATE', NULL),
        IF(Delete_priv='Y', 'DELETE', NULL),
        IF(Create_priv='Y', 'CREATE', NULL),
        IF(Drop_priv='Y', 'DROP', NULL),
        IF(Grant_priv='Y', 'GRANT', NULL),
        IF(Super_priv='Y', 'SUPER', NULL),
        IF(Process_priv='Y', 'PROCESS', NULL),
        IF(Reload_priv='Y', 'RELOAD', NULL)
    ) AS privileges
FROM mysql.user
WHERE User = @target_user AND Host = @target_host

UNION ALL

-- 2. Privil√®ges par base
SELECT
    'DATABASE' AS niveau,
    CONCAT(Db, '.*') AS objet,
    CONCAT_WS(', ',
        IF(Select_priv='Y', 'SELECT', NULL),
        IF(Insert_priv='Y', 'INSERT', NULL),
        IF(Update_priv='Y', 'UPDATE', NULL),
        IF(Delete_priv='Y', 'DELETE', NULL),
        IF(Create_priv='Y', 'CREATE', NULL),
        IF(Drop_priv='Y', 'DROP', NULL)
    ) AS privileges
FROM mysql.db
WHERE User = @target_user AND Host = @target_host

UNION ALL

-- 3. Privil√®ges par table
SELECT
    'TABLE' AS niveau,
    CONCAT(Db, '.', Table_name) AS objet,
    Table_priv AS privileges
FROM mysql.tables_priv
WHERE User = @target_user AND Host = @target_host

UNION ALL

-- 4. Privil√®ges par colonne
SELECT
    'COLUMN' AS niveau,
    CONCAT(Db, '.', Table_name, '.', Column_name) AS objet,
    Column_priv AS privileges
FROM mysql.columns_priv
WHERE User = @target_user AND Host = @target_host

ORDER BY
    FIELD(niveau, 'GLOBAL', 'DATABASE', 'TABLE', 'COLUMN'),
    objet;

-- Audit complet √† 4 niveaux
```

### Comparer privil√®ges GRANT vs tables mysql

```sql
-- M√©thode 1 : Utiliser SHOW GRANTS (recommand√©, plus lisible)
SHOW GRANTS FOR 'app_user'@'%';

-- M√©thode 2 : Interroger directement mysql.* (pour scripts automatis√©s)
-- Voir la requ√™te ci-dessus

-- R√©sultat : doit √™tre identique
-- SHOW GRANTS est plus facile √† lire
-- mysql.* est plus facile √† parser/scripter
```

---

## Configuration et plugins

### mysql.plugin : Plugins install√©s

```sql
-- Lister tous les plugins actifs
SELECT
    name AS plugin_name,
    dl AS library_file,
    load_option  -- ON, OFF, FORCE, FORCE_PLUS_PERMANENT
FROM mysql.plugin
ORDER BY name;

-- Exemples de plugins :
-- auth_socket, query_cache, audit_log, etc.
```

**Installation/d√©sinstallation de plugins** :

```sql
-- Installer un plugin (m√©thode recommand√©e)
INSTALL PLUGIN auth_pam SONAME 'auth_pam.so';

-- D√©sinstaller un plugin
UNINSTALL PLUGIN auth_pam;

-- ‚ö†Ô∏è Ne PAS modifier mysql.plugin directement
-- Utiliser INSTALL/UNINSTALL PLUGIN
```

### mysql.servers : Serveurs f√©d√©r√©s

```sql
-- Configuration des serveurs distants (FEDERATED storage engine)
SELECT
    Server_name,
    Host,
    Db,
    Username,
    Port,
    Socket,
    Wrapper,  -- mysql, mariadb
    Owner
FROM mysql.servers;

-- Permet de cr√©er des tables qui pointent vers un serveur distant
```

### mysql.event : √âv√©nements planifi√©s

```sql
-- Liste des √©v√©nements (scheduler)
SELECT
    db AS database_name,
    name AS event_name,
    definer AS creator,
    status,  -- ENABLED, DISABLED, SLAVESIDE_DISABLED
    on_completion,  -- PRESERVE, NOT PRESERVE
    execute_at AS run_once_at,
    interval_value,
    interval_field,  -- SECOND, MINUTE, HOUR, DAY, WEEK, MONTH, YEAR
    starts,
    ends,
    last_executed,
    comment
FROM mysql.event
WHERE db = 'production_db'
ORDER BY name;

-- √âv√©nements planifi√©s (√©quivalent de cron)
```

---

## Donn√©es fonctionnelles

### mysql.time_zone* : Fuseaux horaires

MariaDB stocke les informations de fuseaux horaires dans plusieurs tables :

```sql
-- Tables de fuseaux horaires
-- mysql.time_zone
-- mysql.time_zone_name
-- mysql.time_zone_transition
-- mysql.time_zone_transition_type
-- mysql.time_zone_leap_second

-- Lister les fuseaux disponibles
SELECT
    Name AS timezone_name
FROM mysql.time_zone_name
ORDER BY Name
LIMIT 20;

-- Exemples : Europe/Paris, America/New_York, UTC, etc.
```

**Charger les donn√©es de fuseaux horaires** :

```bash
# Sur Linux, charger depuis le syst√®me
mysql_tzinfo_to_sql /usr/share/zoneinfo | mysql -u root -p mysql

# V√©rifier
mysql> SELECT COUNT(*) FROM mysql.time_zone_name;
-- Devrait retourner plusieurs centaines
```

### mysql.help_* : Syst√®me d'aide

```sql
-- Tables d'aide en ligne
-- mysql.help_topic
-- mysql.help_category
-- mysql.help_keyword
-- mysql.help_relation

-- Rechercher dans l'aide
SELECT
    name AS topic,
    description
FROM mysql.help_topic
WHERE name LIKE '%SELECT%'
   OR description LIKE '%SELECT%'
LIMIT 5;

-- Utilis√© par la commande HELP dans mysql client
-- mysql> HELP SELECT;
```

---

## Tables de r√©plication

### mysql.gtid_slave_pos : Position GTID

```sql
-- Position de r√©plication avec GTID (Global Transaction ID)
SELECT
    domain_id,
    sub_id,
    server_id,
    seq_no
FROM mysql.gtid_slave_pos;

-- Utilis√© pour la r√©plication bas√©e sur GTID
```

### mysql.slave_master_info et mysql.slave_relay_log_info

```sql
-- Informations sur le serveur ma√Ætre (si ce serveur est un esclave)
-- Ces tables remplacent les anciens fichiers master.info et relay-log.info

-- Configuration ma√Ætre
SELECT
    Host,
    Port,
    Master_log_name,
    Master_log_pos,
    User_name
FROM mysql.slave_master_info;

-- Position dans le relay log
SELECT
    Relay_log_name,
    Relay_log_pos,
    Master_log_name,
    Master_log_pos
FROM mysql.slave_relay_log_info;
```

---

## Tables de logs

### mysql.general_log : Log g√©n√©ral (si activ√©)

```sql
-- Historique de toutes les connexions et requ√™tes
-- ‚ö†Ô∏è Tr√®s volumineux, √† utiliser avec pr√©caution

-- Activer le log g√©n√©ral (pour debug uniquement)
SET GLOBAL general_log = 'ON';
SET GLOBAL log_output = 'TABLE';  -- Stocker dans mysql.general_log

-- Consulter les derni√®res requ√™tes
SELECT
    event_time,
    user_host,
    thread_id,
    server_id,
    command_type,
    LEFT(argument, 100) AS query_preview
FROM mysql.general_log
ORDER BY event_time DESC
LIMIT 50;

-- Vider le log
TRUNCATE TABLE mysql.general_log;

-- D√©sactiver (recommand√© en production)
SET GLOBAL general_log = 'OFF';
```

### mysql.slow_log : Log des requ√™tes lentes

```sql
-- Requ√™tes d√©passant long_query_time
-- Alternative plus l√©g√®re que general_log

-- Configurer
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 2;  -- Requ√™tes > 2 secondes
SET GLOBAL log_output = 'TABLE';

-- Consulter les requ√™tes lentes
SELECT
    start_time,
    user_host,
    query_time,
    lock_time,
    rows_sent,
    rows_examined,
    db,
    LEFT(sql_text, 100) AS query_preview
FROM mysql.slow_log
ORDER BY query_time DESC
LIMIT 20;

-- Requ√™tes les plus lentes enregistr√©es
```

---

## Bonnes pratiques et s√©curit√©

### ‚ö†Ô∏è R√®gles critiques de manipulation

#### 1. NE JAMAIS modifier directement mysql.user/db/tables_priv

```sql
-- ‚ùå MAUVAIS : Modification directe
UPDATE mysql.user
SET Super_priv = 'Y'
WHERE User = 'app_user';
-- DANGEREUX : les changements ne sont pas valid√©s correctement

-- ‚úÖ BON : Utiliser GRANT
GRANT SUPER ON *.* TO 'app_user'@'%';
-- Les privil√®ges sont valid√©s et appliqu√©s imm√©diatement
```

**Pourquoi ne pas modifier directement ?**

1. **Pas de validation** : MariaDB ne v√©rifie pas la coh√©rence
2. **Pas d'effet imm√©diat** : N√©cessite `FLUSH PRIVILEGES`
3. **Risque d'erreur** : Format complexe, facile de se tromper
4. **Pas d'historique** : Aucune trace dans les logs
5. **Failles de s√©curit√©** : Peut cr√©er des incoh√©rences

#### 2. Si modification directe absolument n√©cessaire

```sql
-- 1. Faire une sauvegarde
CREATE TABLE mysql.user_backup AS SELECT * FROM mysql.user;

-- 2. Faire la modification (exemple : changer le host)
UPDATE mysql.user
SET Host = '10.0.1.%'
WHERE User = 'app_user' AND Host = '10.0.0.%';

-- 3. OBLIGATOIRE : Recharger les privil√®ges
FLUSH PRIVILEGES;

-- Sans FLUSH PRIVILEGES, les changements ne sont pas pris en compte !
```

#### 3. V√©rifier les privil√®ges apr√®s modification

```sql
-- V√©rifier avec SHOW GRANTS
SHOW GRANTS FOR 'app_user'@'10.0.1.%';

-- Tester la connexion
-- mysql -u app_user -p -h 10.0.1.50
```

### Audit de s√©curit√©

**Requ√™te 1 : Comptes √† risque**

```sql
SELECT
    CONCAT(User, '@', Host) AS compte,
    'Super privil√®ge' AS risque,
    'HIGH' AS severite
FROM mysql.user
WHERE Super_priv = 'Y'
  AND User NOT IN ('root')

UNION ALL

SELECT
    CONCAT(User, '@', Host) AS compte,
    'Pas de mot de passe' AS risque,
    'CRITICAL' AS severite
FROM mysql.user
WHERE (authentication_string = '' OR authentication_string IS NULL)
  AND User != ''

UNION ALL

SELECT
    CONCAT(User, '@', Host) AS compte,
    'Acc√®s depuis partout (%)' AS risque,
    'MEDIUM' AS severite
FROM mysql.user
WHERE Host = '%'
  AND User NOT LIKE 'repl%'

UNION ALL

SELECT
    CONCAT(User, '@', Host) AS compte,
    'Privil√®ge FILE' AS risque,
    'HIGH' AS severite
FROM mysql.user
WHERE File_priv = 'Y'

ORDER BY
    FIELD(severite, 'CRITICAL', 'HIGH', 'MEDIUM', 'LOW'),
    compte;

-- Liste des comptes n√©cessitant une attention
```

**Requ√™te 2 : Utilisateurs inactifs (√† supprimer)**

```sql
-- Utilisateurs qui n'existent pas dans INFORMATION_SCHEMA
-- (n'ont jamais √©t√© utilis√©s ou n'existent plus en pratique)
SELECT
    CONCAT(User, '@', Host) AS compte_inutilise,
    Create_priv,
    Drop_priv,
    Super_priv
FROM mysql.user
WHERE User NOT IN (
    SELECT DISTINCT GRANTEE
    FROM INFORMATION_SCHEMA.USER_PRIVILEGES
    WHERE GRANTEE != "''"
)
  AND User != ''
ORDER BY User;

-- Candidats √† la suppression avec DROP USER
```

**Requ√™te 3 : Privil√®ges excessifs**

```sql
-- Utilisateurs avec trop de privil√®ges globaux
SELECT
    CONCAT(User, '@', Host) AS compte,
    CONCAT_WS(', ',
        IF(Select_priv='Y', 'SELECT', NULL),
        IF(Insert_priv='Y', 'INSERT', NULL),
        IF(Update_priv='Y', 'UPDATE', NULL),
        IF(Delete_priv='Y', 'DELETE', NULL),
        IF(Create_priv='Y', 'CREATE', NULL),
        IF(Drop_priv='Y', 'DROP', NULL),
        IF(Super_priv='Y', 'SUPER', NULL),
        IF(Grant_priv='Y', 'GRANT', NULL)
    ) AS privileges_globaux,
    (Select_priv='Y') + (Insert_priv='Y') + (Update_priv='Y') +
    (Delete_priv='Y') + (Create_priv='Y') + (Drop_priv='Y') +
    (Super_priv='Y') + (Grant_priv='Y') AS nb_privileges
FROM mysql.user
WHERE User NOT IN ('root', 'mariadb.sys')
  AND (Select_priv='Y' OR Insert_priv='Y' OR Update_priv='Y' OR Delete_priv='Y')
ORDER BY nb_privileges DESC;

-- Utilisateurs applicatifs avec privil√®ges globaux = mauvaise pratique
-- Devrait utiliser privil√®ges au niveau base de donn√©es
```

---

## Sauvegarde et restauration

### Sauvegarder les tables mysql

```bash
# Sauvegarder toutes les tables mysql
mysqldump -u root -p mysql > mysql_backup.sql

# Sauvegarder uniquement les utilisateurs et privil√®ges
mysqldump -u root -p mysql user db tables_priv columns_priv procs_priv > privileges_backup.sql

# Sauvegarder avec mysqldump --all-databases inclut automatiquement mysql
mysqldump -u root -p --all-databases > full_backup.sql
```

### Restaurer les privil√®ges

```bash
# Restaurer
mysql -u root -p mysql < privileges_backup.sql

# Puis recharger
mysql -u root -p -e "FLUSH PRIVILEGES;"
```

‚ö†Ô∏è **Attention** : Apr√®s restauration de mysql.user, il faut imp√©rativement faire `FLUSH PRIVILEGES`.

---

## G√©n√©ration de scripts d'administration

### G√©n√©rer des GRANT statements √† partir de mysql.*

```sql
-- Recr√©er les GRANT pour un utilisateur
SELECT CONCAT(
    'GRANT ',
    REPLACE(
        CONCAT_WS(', ',
            IF(Select_priv='Y', 'SELECT', NULL),
            IF(Insert_priv='Y', 'INSERT', NULL),
            IF(Update_priv='Y', 'UPDATE', NULL),
            IF(Delete_priv='Y', 'DELETE', NULL),
            IF(Create_priv='Y', 'CREATE', NULL),
            IF(Drop_priv='Y', 'DROP', NULL),
            IF(Grant_priv='Y', 'GRANT OPTION', NULL)
        ),
        ', , ', ', '
    ),
    ' ON ',
    QUOTE(Db), '.*',
    ' TO ',
    QUOTE(User), '@', QUOTE(Host),
    ';'
) AS grant_statement
FROM mysql.db
WHERE User = 'app_user'
  AND Host = '%';

-- G√©n√©rer les statements GRANT pour migration ou documentation
```

### G√©n√©rer des CREATE USER

```sql
SELECT CONCAT(
    'CREATE USER IF NOT EXISTS ',
    QUOTE(User), '@', QUOTE(Host),
    ' IDENTIFIED BY ''<PASSWORD>'';'
) AS create_user_statement
FROM mysql.user
WHERE User NOT IN ('root', 'mariadb.sys', '')
  AND User NOT LIKE 'mysql.%'
ORDER BY User;

-- Script de cr√©ation des utilisateurs (mots de passe √† remplir)
```

---

## Cas d'usage pratiques

### Cas 1 : Migrer un utilisateur vers un nouveau host

```sql
-- Situation : app_user@'10.0.0.%' doit devenir app_user@'10.0.1.%'

-- M√©thode 1 : GRANT + DROP (recommand√©e)
-- 1. Cr√©er le nouveau compte avec les m√™mes privil√®ges
SHOW GRANTS FOR 'app_user'@'10.0.0.%';
-- Copier les GRANT et remplacer le host
GRANT SELECT, INSERT, UPDATE, DELETE ON production_db.*
TO 'app_user'@'10.0.1.%' IDENTIFIED BY 'same_password';

-- 2. Supprimer l'ancien
DROP USER 'app_user'@'10.0.0.%';

-- M√©thode 2 : UPDATE mysql.user (si absolument n√©cessaire)
UPDATE mysql.user
SET Host = '10.0.1.%'
WHERE User = 'app_user' AND Host = '10.0.0.%';

UPDATE mysql.db
SET Host = '10.0.1.%'
WHERE User = 'app_user' AND Host = '10.0.0.%';

FLUSH PRIVILEGES;
```

### Cas 2 : Audit apr√®s compromission suspect√©e

```sql
-- 1. Lister tous les utilisateurs avec Super
SELECT CONCAT(User, '@', Host) AS comptes_admin
FROM mysql.user
WHERE Super_priv = 'Y'
ORDER BY User;

-- 2. V√©rifier les connexions r√©centes (si general_log activ√©)
SELECT DISTINCT user_host
FROM mysql.general_log
WHERE event_time > DATE_SUB(NOW(), INTERVAL 24 HOUR)
  AND command_type = 'Connect'
ORDER BY event_time DESC;

-- 3. Chercher les modifications de privil√®ges r√©centes
SELECT
    CONCAT(User, '@', Host) AS compte,
    Timestamp AS derniere_modif_privileges
FROM mysql.tables_priv
WHERE Timestamp > DATE_SUB(NOW(), INTERVAL 7 DAY)
ORDER BY Timestamp DESC;

-- 4. V√©rifier les comptes sans mot de passe (urgence)
SELECT CONCAT(User, '@', Host) AS compte_vulnerable
FROM mysql.user
WHERE (authentication_string = '' OR authentication_string IS NULL)
  AND User != '';

-- 5. R√©voquer et changer les mots de passe si n√©cessaire
-- ALTER USER 'suspect_user'@'%' IDENTIFIED BY 'new_strong_password';
```

### Cas 3 : Copier les privil√®ges d'un user √† un autre

```sql
-- Copier tous les privil√®ges de app_user@'%' vers app_user_backup@'%'

-- 1. Copier les privil√®ges globaux
INSERT INTO mysql.user (Host, User, Password, Select_priv, Insert_priv, ...)
SELECT '%', 'app_user_backup', Password, Select_priv, Insert_priv, ...
FROM mysql.user
WHERE User = 'app_user' AND Host = '%';

-- 2. Copier les privil√®ges par base
INSERT INTO mysql.db (Host, Db, User, Select_priv, Insert_priv, ...)
SELECT '%', Db, 'app_user_backup', Select_priv, Insert_priv, ...
FROM mysql.db
WHERE User = 'app_user' AND Host = '%';

-- 3. Copier les privil√®ges par table
INSERT INTO mysql.tables_priv (Host, Db, User, Table_name, Grantor, Table_priv, Column_priv)
SELECT '%', Db, 'app_user_backup', Table_name, Grantor, Table_priv, Column_priv
FROM mysql.tables_priv
WHERE User = 'app_user' AND Host = '%';

-- 4. OBLIGATOIRE
FLUSH PRIVILEGES;

-- V√©rifier
SHOW GRANTS FOR 'app_user_backup'@'%';
```

---

## Requ√™tes d'administration courantes

### 1. Trouver les bases accessibles par un utilisateur

```sql
SELECT DISTINCT Db AS databases_accessibles
FROM mysql.db
WHERE User = 'app_user'
  AND Host = '%'
  AND (Select_priv = 'Y' OR Insert_priv = 'Y' OR Update_priv = 'Y')
ORDER BY Db;
```

### 2. Lister les utilisateurs ayant acc√®s √† une base sp√©cifique

```sql
SELECT
    CONCAT(User, '@', Host) AS compte,
    CONCAT_WS(', ',
        IF(Select_priv='Y', 'SELECT', NULL),
        IF(Insert_priv='Y', 'INSERT', NULL),
        IF(Update_priv='Y', 'UPDATE', NULL),
        IF(Delete_priv='Y', 'DELETE', NULL)
    ) AS privileges
FROM mysql.db
WHERE Db = 'production_db'
ORDER BY User;
```

### 3. Trouver les doublons de comptes

```sql
-- Plusieurs entr√©es pour le m√™me User (hosts diff√©rents)
SELECT
    User,
    COUNT(*) AS nb_hosts,
    GROUP_CONCAT(Host ORDER BY Host) AS hosts
FROM mysql.user
WHERE User != ''
GROUP BY User
HAVING COUNT(*) > 1
ORDER BY nb_hosts DESC;

-- Utile pour nettoyer les comptes en double
```

### 4. Analyser la complexit√© des mots de passe (longueur du hash)

```sql
SELECT
    CONCAT(User, '@', Host) AS compte,
    plugin AS methode_auth,
    LENGTH(authentication_string) AS hash_length,
    CASE
        WHEN LENGTH(authentication_string) = 0 THEN 'PAS DE MOT DE PASSE'
        WHEN LENGTH(authentication_string) = 41 THEN 'MySQL native (SHA1)'
        WHEN LENGTH(authentication_string) = 43 THEN 'SHA256'
        ELSE 'Autre'
    END AS type_hash
FROM mysql.user
WHERE User != ''
ORDER BY hash_length ASC;

-- Mots de passe vides = critique
-- Hash courts = anciennes m√©thodes moins s√©curis√©es
```

---

## ‚úÖ Points cl√©s √† retenir

- La base **mysql** contient des **tables physiques** (pas des vues virtuelles)
- **mysql.user** : Comptes et privil√®ges globaux
- **mysql.db** : Privil√®ges par base de donn√©es
- **mysql.tables_priv** et **mysql.columns_priv** : Privil√®ges granulaires
- **TOUJOURS utiliser GRANT/REVOKE** plut√¥t que modifier mysql.* directement
- Si modification directe : **FLUSH PRIVILEGES obligatoire** apr√®s
- **Sauvegarder mysql.user** avant toute modification critique
- Tables de logs (**general_log, slow_log**) : √† utiliser avec pr√©caution (volumineuses)
- Tables de r√©plication (**gtid_slave_pos**) : critiques pour la r√©plication
- Audit de s√©curit√© : v√©rifier comptes sans MDP, Super_priv, Host='%'
- **mysql** est inclus dans les sauvegardes mysqldump --all-databases
- Diff√©rence cl√© : **mysql** = configuration syst√®me, **INFORMATION_SCHEMA** = structure bases

---

## üîó Ressources et r√©f√©rences

### Documentation officielle MariaDB
- [üìñ The mysql Database Tables](https://mariadb.com/kb/en/the-mysql-database-tables/) - Vue d'ensemble
- [üìñ mysql.user Table](https://mariadb.com/kb/en/mysqluser-table/) - Table des utilisateurs
- [üìñ Grant Tables](https://mariadb.com/kb/en/grant-tables/) - Toutes les tables de privil√®ges
- [üìñ FLUSH PRIVILEGES](https://mariadb.com/kb/en/flush/#flush-privileges) - Documentation FLUSH

### Bonnes pratiques
- [üìñ Account Management](https://mariadb.com/kb/en/account-management-sql-commands/) - GRANT, CREATE USER, etc.
- [üìñ Password Validation Plugin](https://mariadb.com/kb/en/password-validation-plugin/) - Validation des MDP

---

## ‚û°Ô∏è Prochaines √©tapes

Vous avez maintenant compl√©t√© le **Chapitre 9 : Vues et Donn√©es Virtuelles** ! üéâ

Vous ma√Ætrisez :
- ‚úÖ Cr√©ation et gestion des vues (ALGORITHM, SQL SECURITY)
- ‚úÖ Vues mat√©rialis√©es (alternatives avec tables de cache et EVENTs)
- ‚úÖ Vues updatable et WITH CHECK OPTION
- ‚úÖ S√©curit√© avec les vues (masquage de donn√©es)
- ‚úÖ Performance (MERGE vs TEMPTABLE)
- ‚úÖ Vues syst√®me (INFORMATION_SCHEMA, PERFORMANCE_SCHEMA, mysql)

**Prochains chapitres sugg√©r√©s** :
- **Chapitre 10** : Optimisation des performances et indexation avanc√©e
- **Chapitre 11** : Transactions et isolation (ACID, niveaux d'isolation)
- **Chapitre 12** : R√©plication et haute disponibilit√©

---


‚è≠Ô∏è [S√©curit√© et Gestion des Utilisateurs](/10-securite-gestion-utilisateurs/README.md)
