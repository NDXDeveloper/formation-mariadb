üîù Retour au [Sommaire](/SOMMAIRE.md)

# 11.1.2 Ordre de lecture des fichiers

> **Niveau** : Avanc√© (DBA/Administrateur Syst√®me)  
> **Dur√©e estim√©e** : 1 heure  
> **Pr√©requis** : 11.1.1 - Structure my.cnf/my.ini, connaissances syst√®me Linux/Windows

## üéØ Objectifs d'apprentissage

√Ä l'issue de cette section, vous serez capable de :
- Ma√Ætriser l'ordre exact de lecture des fichiers de configuration par MariaDB
- Comprendre les m√©canismes de pr√©c√©dence et d'√©crasement des valeurs
- Utiliser efficacement `!include` et `!includedir` pour une configuration modulaire
- D√©boguer les probl√®mes de configuration li√©s √† l'ordre de chargement
- Mettre en place des strat√©gies multi-environnements (dev, staging, production)
- Appliquer les meilleures pratiques pour la gestion des configurations complexes

---

## Introduction

L'un des aspects les plus critiques et souvent mal compris de l'administration MariaDB est **l'ordre dans lequel les fichiers de configuration sont lus**. Une mauvaise compr√©hension peut entra√Æner des configurations ineffectives, des param√®tres non appliqu√©s, ou pire, des serveurs qui ne d√©marrent pas avec les param√®tres attendus.

MariaDB suit une **s√©quence pr√©cise et pr√©dictible** pour charger les configurations. Comprendre cette s√©quence est essentiel pour :
- üéØ Garantir que vos param√®tres sont r√©ellement appliqu√©s
- üîß D√©boguer les probl√®mes de configuration
- üìÅ Organiser des configurations complexes en production
- üåç G√©rer plusieurs environnements efficacement

‚ö†Ô∏è **R√®gle d'or** : En cas de conflit, **le dernier param√®tre lu l'emporte**. C'est le principe fondamental √† garder en t√™te.

---

## Ordre de lecture standard sur Linux/Unix

### S√©quence de recherche par d√©faut

MariaDB recherche et charge les fichiers de configuration dans cet ordre strict :

```
1. /etc/my.cnf
2. /etc/mysql/my.cnf
3. $MYSQL_HOME/my.cnf
4. [defaults-extra-file]  (si sp√©cifi√© avec --defaults-extra-file)
5. ~/.my.cnf               (fichier personnel de l'utilisateur)
6. ~/.mylogin.cnf          (fichier de login chiffr√©)
```

üí° **Important** : Tous les fichiers ne sont pas n√©cessairement pr√©sents. MariaDB lit ceux qui existent et ignore silencieusement les autres.

### D√©tail de chaque emplacement

#### 1. /etc/my.cnf
**Configuration syst√®me globale**

```bash
# Emplacement : /etc/my.cnf
# Propri√©taire : root:root
# Permissions : 644 ou 640
# Usage : Configuration de base du syst√®me
```

- Premier fichier lu
- G√©n√©ralement utilis√© pour les param√®tres globaux syst√®me
- Affecte tous les utilisateurs et tous les services MySQL/MariaDB
- Sur certaines distributions (Debian/Ubuntu), ce fichier peut √™tre un lien symbolique

```ini
# /etc/my.cnf - Configuration globale minimale
[client-server]
socket = /var/run/mysqld/mysqld.sock

!includedir /etc/mysql/conf.d/
!includedir /etc/mysql/mariadb.conf.d/
```

#### 2. /etc/mysql/my.cnf
**Configuration MariaDB principale**

```bash
# Emplacement : /etc/mysql/my.cnf
# Usage : Configuration principale MariaDB
# Distribution : Debian, Ubuntu, et d√©riv√©s
```

Sur les distributions bas√©es Debian :
- Ce fichier est souvent le **principal point d'entr√©e**
- Contient g√©n√©ralement des directives `!includedir`
- Permet une organisation modulaire

```ini
# /etc/mysql/my.cnf (Debian/Ubuntu typique)
# The MariaDB configuration file

!includedir /etc/mysql/conf.d/
!includedir /etc/mysql/mariadb.conf.d/
```

#### 3. $MYSQL_HOME/my.cnf
**Configuration sp√©cifique √† l'instance**

```bash
# Variable d'environnement MYSQL_HOME
# Exemple : export MYSQL_HOME=/opt/mariadb/instance1
```

Rarement utilis√© en production classique, mais tr√®s utile pour :
- **Multi-instances** : Plusieurs serveurs MariaDB sur la m√™me machine
- **Tests** : Environnements de d√©veloppement isol√©s
- **Containers** : Configurations sp√©cifiques par container

Exemple multi-instance :

```bash
# Instance 1
export MYSQL_HOME=/opt/mariadb/instance1
/usr/sbin/mysqld &

# Instance 2
export MYSQL_HOME=/opt/mariadb/instance2
/usr/sbin/mysqld &
```

```ini
# /opt/mariadb/instance1/my.cnf
[mysqld]
port = 3306
datadir = /var/lib/mysql_instance1

# /opt/mariadb/instance2/my.cnf
[mysqld]
port = 3307
datadir = /var/lib/mysql_instance2
```

#### 4. --defaults-extra-file
**Fichier de configuration suppl√©mentaire explicite**

```bash
# Sp√©cifi√© au d√©marrage
mysqld --defaults-extra-file=/etc/mysql/production-overrides.cnf
```

- Permet d'ajouter une couche de configuration **sans modifier les fichiers existants**
- Tr√®s utile pour :
  - D√©ploiements automatis√©s (Ansible, Terraform)
  - Configurations temporaires
  - Overrides sp√©cifiques environnement

```ini
# /etc/mysql/production-overrides.cnf
[mysqld]
# Overrides sp√©cifiques production
max_connections = 2000
innodb_buffer_pool_size = 128G
```

‚ö†Ô∏è **Attention** : Ce fichier est lu **apr√®s** tous les fichiers standards mais **avant** `~/.my.cnf`

#### 5. ~/.my.cnf
**Configuration personnelle de l'utilisateur**

```bash
# Emplacement : /home/username/.my.cnf
# Propri√©taire : username:username
# Permissions : 600 (STRICT - sinon ignor√©)
```

- Fichier personnel de chaque utilisateur Unix/Linux
- **S√©curit√© critique** : Si permissions != 600, MariaDB ignore le fichier avec un warning
- Typiquement utilis√© pour :
  - Credentials clients (‚ö†Ô∏è √† √©viter, pr√©f√©rer `.mylogin.cnf`)
  - Pr√©f√©rences utilisateur (prompt, pager, etc.)

```ini
# ~/.my.cnf
[client]
user = john
password = SecretPassword123  # ‚ö†Ô∏è D√©pr√©ci√© - utiliser .mylogin.cnf

[mysql]
prompt = "\\u@\\h [\\d]>\\_"
pager = less -n -i -S
```

üí° **Meilleure pratique** : Utiliser `mysql_config_editor` pour stocker les credentials de mani√®re s√©curis√©e.

```bash
# Cr√©er un login-path s√©curis√©
mysql_config_editor set --login-path=client \
  --host=localhost --user=john --password

# Credentials stock√©s chiffr√©s dans ~/.mylogin.cnf
```

#### 6. ~/.mylogin.cnf
**Fichier de login chiffr√©**

- Cr√©√© automatiquement par `mysql_config_editor`
- Contenu **chiffr√©** (non lisible en clair)
- S√©curit√© renforc√©e pour les credentials
- Format binaire propri√©taire

```bash
# Utilisation
mysql --login-path=client

# Lister les login-paths configur√©s
mysql_config_editor print --all
```

---

## Ordre de lecture sur Windows

### S√©quence Windows standard

```
1. %WINDIR%\my.ini
2. %WINDIR%\my.cnf
3. C:\my.ini
4. C:\my.cnf
5. BASEDIR\my.ini          (r√©pertoire d'installation MariaDB)
6. BASEDIR\my.cnf
7. [defaults-extra-file]   (si sp√©cifi√©)
8. %APPDATA%\MySQL\.mylogin.cnf
```

### Emplacements typiques Windows

```
C:\ProgramData\MySQL\MySQL Server 11.8\my.ini
C:\Program Files\MariaDB 11.8\data\my.ini
```

üí° **Conseil Windows** : Utiliser le service MariaDB/MySQL pour voir le fichier de configuration actif :

```powershell
# PowerShell : V√©rifier le service
Get-Service -Name "MariaDB" | Select-Object *

# Voir le fichier de config utilis√©
sc qc MariaDB
```

---

## M√©canismes !include et !includedir

### !includedir : Inclusion de r√©pertoires

La directive `!includedir` permet de charger **tous les fichiers `.cnf`** d'un r√©pertoire.

#### Syntaxe et comportement

```ini
# Dans my.cnf principal
[mysqld]
!includedir /etc/mysql/conf.d/
!includedir /etc/mysql/mariadb.conf.d/
```

**R√®gles importantes** :

1. **Extension .cnf obligatoire** : Seuls les fichiers `*.cnf` sont lus
2. **Ordre alphab√©tique** : Les fichiers sont lus par ordre alphab√©tique (d'o√π l'importance de la num√©rotation)
3. **R√©cursion** : Non r√©cursif (ne lit pas les sous-r√©pertoires)
4. **Sections** : Les sections `[mysqld]`, `[client]`, etc. doivent √™tre pr√©sentes dans chaque fichier

#### Exemple d'organisation modulaire

```
/etc/mysql/mariadb.conf.d/
‚îú‚îÄ‚îÄ 10-base.cnf          # Charg√© en 1er
‚îú‚îÄ‚îÄ 20-innodb.cnf        # Charg√© en 2√®me
‚îú‚îÄ‚îÄ 30-replication.cnf   # Charg√© en 3√®me
‚îú‚îÄ‚îÄ 40-performance.cnf   # Charg√© en 4√®me
‚îú‚îÄ‚îÄ 50-security.cnf      # Charg√© en 5√®me
‚îî‚îÄ‚îÄ 99-custom.cnf        # Charg√© en dernier (override tout)
```

üí° **Convention de nommage** :
- **10-** : Configuration de base
- **20-** : Moteurs de stockage
- **30-** : R√©plication
- **40-** : Performance
- **50-** : S√©curit√©
- **90+** : Overrides et customisations

```ini
# 10-base.cnf
[mysqld]
user = mysql
port = 3306
socket = /var/run/mysqld/mysqld.sock

# 20-innodb.cnf
[mysqld]
innodb_buffer_pool_size = 8G
innodb_log_file_size = 2G

# 99-custom.cnf - OVERRIDE innodb_buffer_pool_size
[mysqld]
innodb_buffer_pool_size = 16G  # √âcrase la valeur de 20-innodb.cnf
```

**R√©sultat final** : `innodb_buffer_pool_size = 16G` (dernier lu = gagnant)

### !include : Inclusion de fichiers individuels

Permet d'inclure un fichier sp√©cifique (n'importe quelle extension).

```ini
# my.cnf principal
[mysqld]
!include /etc/mysql/custom/special-config.txt
!include /etc/mysql/custom/another-file.conf
```

‚ö†Ô∏è **Diff√©rence avec !includedir** :
- `!include` : Fichier unique, n'importe quelle extension
- `!includedir` : Tous les `*.cnf` du r√©pertoire, ordre alphab√©tique

---

## Pr√©c√©dence et r√©solution des conflits

### Principe fondamental : "Last Wins"

Quand une m√™me option appara√Æt plusieurs fois :

```ini
# Fichier 1 : /etc/my.cnf
[mysqld]
max_connections = 100

# Fichier 2 : /etc/mysql/my.cnf (lu apr√®s)
[mysqld]
max_connections = 500

# Fichier 3 : ~/.my.cnf (lu en dernier)
[mysqld]
max_connections = 1000
```

**Valeur finale** : `max_connections = 1000` (dernier fichier lu)

### Strat√©gie de r√©solution

```
Priorit√© (du moins prioritaire au plus prioritaire) :
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
1. /etc/my.cnf                    ‚¨áÔ∏è Moins prioritaire
2. /etc/mysql/my.cnf
3. $MYSQL_HOME/my.cnf
4. --defaults-extra-file
5. ~/.my.cnf                      ‚¨ÜÔ∏è Plus prioritaire
```

### Cas pratique : Configuration multicouche

**Sc√©nario** : Serveur production avec overrides

```ini
# Couche 1 : /etc/my.cnf (base syst√®me)
[mysqld]
max_connections = 151            # D√©faut MariaDB
innodb_buffer_pool_size = 128M   # D√©faut MariaDB
port = 3306

# Couche 2 : /etc/mysql/mariadb.conf.d/50-server.cnf
[mysqld]
max_connections = 500            # ‚úÖ Override syst√®me
innodb_buffer_pool_size = 8G     # ‚úÖ Override syst√®me
bind-address = 0.0.0.0

# Couche 3 : /etc/mysql/mariadb.conf.d/99-production.cnf
[mysqld]
innodb_buffer_pool_size = 32G    # ‚úÖ Override production
max_connections = 2000           # ‚úÖ Override production
```

**Configuration finale effective** :
```
max_connections = 2000
innodb_buffer_pool_size = 32G
port = 3306
bind-address = 0.0.0.0
```

---

## D√©bogage de l'ordre de lecture

### M√©thode 1 : --help --verbose

La commande la plus fiable pour voir l'ordre de lecture :

```bash
mysqld --help --verbose | head -n 30
```

Sortie typique :

```
Default options are read from the following files in the given order:
/etc/my.cnf /etc/mysql/my.cnf ~/.my.cnf

The following groups are read: mysqld server mysqld-11.8 mariadb mariadb-11.8 client-server galera
```

üí° **Interpr√©tation** :
- **Files in the given order** : Ordre exact de lecture
- **Groups are read** : Sections lues (toutes les sections applicables)

### M√©thode 2 : V√©rifier les valeurs charg√©es

```bash
# Voir toutes les variables avec leurs valeurs actuelles
mysqld --verbose --help | grep -A 5 "^Variables"

# Filtrer une variable sp√©cifique
mysqld --verbose --help 2>/dev/null | grep "^max-connections"
```

### M√©thode 3 : my_print_defaults

Outil d√©di√© au d√©bogage des configurations :

```bash
# Voir toutes les options pour [mysqld]
my_print_defaults mysqld

# Voir options pour plusieurs sections
my_print_defaults mysqld server mariadb

# Sp√©cifier des fichiers de config explicites
my_print_defaults --defaults-file=/etc/mysql/my.cnf mysqld
```

Exemple de sortie :

```
--user=mysql
--port=3306
--socket=/var/run/mysqld/mysqld.sock
--innodb-buffer-pool-size=32G
--max-connections=2000
```

### M√©thode 4 : Tracer avec strace (Linux avanc√©)

Pour un diagnostic approfondi :

```bash
# Tracer les fichiers ouverts par mysqld
strace -e trace=open,openat mysqld 2>&1 | grep -E "\.cnf|\.ini"
```

R√©sultat :

```
openat(AT_FDCWD, "/etc/my.cnf", O_RDONLY) = 3
openat(AT_FDCWD, "/etc/mysql/my.cnf", O_RDONLY) = 3
openat(AT_FDCWD, "/etc/mysql/mariadb.conf.d/50-server.cnf", O_RDONLY) = 3
```

---

## Options en ligne de commande

### Override total : --defaults-file

Force l'utilisation d'**un seul** fichier de configuration, ignorant tous les autres :

```bash
# Ignore tous les fichiers standards
mysqld --defaults-file=/path/to/specific.cnf

# Aucun autre fichier ne sera lu
```

‚ö†Ô∏è **Attention** : Tr√®s dangereux en production, car ignore m√™me les configurations syst√®me critiques.

**Cas d'usage l√©gitime** :
- Tests isol√©s
- Benchmarking avec config sp√©cifique
- Containers Docker avec config custom

```bash
# Docker : config isol√©e
docker run -d \
  -v /my/custom/my.cnf:/etc/mysql/my.cnf:ro \
  mariadb:11.8 \
  --defaults-file=/etc/mysql/my.cnf
```

### Ajout de configuration : --defaults-extra-file

Ajoute un fichier **suppl√©mentaire** sans ignorer les autres :

```bash
# Lit tous les fichiers standards + le fichier extra
mysqld --defaults-extra-file=/etc/mysql/production-extras.cnf
```

‚úÖ **Recommand√© pour** :
- Overrides production sans modifier les fichiers standards
- D√©ploiements automatis√©s
- Configurations d'environnement (staging, prod)

```bash
# Ansible / Systemd override
[Service]
ExecStart=/usr/sbin/mysqld --defaults-extra-file=/etc/mysql/env-production.cnf
```

### No defaults : --no-defaults

Ignore **tous** les fichiers de configuration :

```bash
# D√©marre avec uniquement les param√®tres par d√©faut compil√©s
mysqld --no-defaults
```

**Cas d'usage** :
- D√©bogage extr√™me (√©liminer toute interf√©rence)
- Recovery mode
- Diagnostic de probl√®mes de config

---

## Strat√©gies multi-environnements

### Approche 1 : Fichiers s√©par√©s par environnement

Structure recommand√©e pour CI/CD :

```
/etc/mysql/
‚îú‚îÄ‚îÄ my.cnf                      # Base commune
‚îú‚îÄ‚îÄ conf.d/
‚îÇ   ‚îú‚îÄ‚îÄ 10-common.cnf          # Commun √† tous les envs
‚îÇ   ‚îú‚îÄ‚îÄ 20-innodb.cnf          # InnoDB base
‚îÇ   ‚îî‚îÄ‚îÄ 30-logging.cnf         # Logging base
‚îî‚îÄ‚îÄ environments/
    ‚îú‚îÄ‚îÄ development.cnf
    ‚îú‚îÄ‚îÄ staging.cnf
    ‚îî‚îÄ‚îÄ production.cnf
```

D√©marrage avec systemd :

```ini
# /etc/systemd/system/mariadb.service.d/environment.conf
[Service]
ExecStart=
ExecStart=/usr/sbin/mysqld --defaults-extra-file=/etc/mysql/environments/production.cnf
```

```bash
# Recharger systemd
systemctl daemon-reload
systemctl restart mariadb
```

### Approche 2 : Liens symboliques

```bash
# Lien vers config d'environnement
ln -sf /etc/mysql/environments/production.cnf /etc/mysql/conf.d/99-environment.cnf

# Changement d'environnement
ln -sf /etc/mysql/environments/staging.cnf /etc/mysql/conf.d/99-environment.cnf
systemctl restart mariadb
```

### Approche 3 : Variables d'environnement avec templates

Utilisation de variables dans les fichiers de config (limit√©) :

```ini
# /etc/mysql/templated.cnf
[mysqld]
# Utiliser des valeurs calcul√©es au d√©marrage
innodb_buffer_pool_size = ${INNODB_BUFFER_POOL_SIZE}
max_connections = ${MAX_CONNECTIONS}
```

Avec systemd :

```ini
# /etc/systemd/system/mariadb.service.d/environment.conf
[Service]
Environment="INNODB_BUFFER_POOL_SIZE=32G"
Environment="MAX_CONNECTIONS=2000"
```

‚ö†Ô∏è **Limitation** : MariaDB ne supporte pas nativement les variables d'environnement dans my.cnf. N√©cessite un preprocessing (sed, envsubst, etc.)

### Approche 4 : Configuration dynamique Ansible/Terraform

```yaml
# Ansible playbook
- name: Deploy MariaDB configuration
  template:
    src: my.cnf.j2
    dest: /etc/mysql/mariadb.conf.d/50-server.cnf
  vars:
    environment: "{{ deploy_env }}"  # dev, staging, prod
    innodb_buffer_pool_size: "{{ buffer_pool_sizes[deploy_env] }}"
```

```jinja2
{# my.cnf.j2 #}
[mysqld]
{% if environment == 'production' %}
max_connections = 2000
innodb_buffer_pool_size = {{ innodb_buffer_pool_size }}
{% elif environment == 'staging' %}
max_connections = 500
innodb_buffer_pool_size = 8G
{% else %}
max_connections = 100
innodb_buffer_pool_size = 1G
{% endif %}
```

---

## Bonnes pratiques de gestion

### 1. Principe de hi√©rarchie claire

```
Base (syst√®me) ‚Üí Sp√©cifique (application) ‚Üí Override (environnement)
```

```
/etc/my.cnf                     # Syst√®me (minimal)
  ‚Üì
/etc/mysql/conf.d/*.cnf         # Commun application
  ‚Üì
/etc/mysql/mariadb.conf.d/*.cnf # Sp√©cifique MariaDB
  ‚Üì
99-environment.cnf              # Override final
```

### 2. Convention de nommage stricte

```
10-network.cnf          # Infrastructure
20-innodb.cnf           # Moteurs
30-replication.cnf      # HA
40-performance.cnf      # Tuning
50-security.cnf         # S√©curit√©
60-logging.cnf          # Logs
90-custom.cnf           # Customisations
99-override.cnf         # Overrides finaux
```

### 3. Commentaires et documentation

Chaque fichier devrait avoir un header explicite :

```ini
#
# 40-performance.cnf
#
# Description : Optimisations performance OLTP
# Environnement : Production 64GB RAM, 16 cores, SSD NVMe
# Auteur : DBA Team
# Derni√®re modification : 2025-12-13
# Version MariaDB : 11.8 LTS
#

[mysqld]
# Buffer Pool : 60% RAM disponible
innodb_buffer_pool_size = 40G

# Thread Pool (voir 11.10 Thread Pool)
thread_handling = pool-of-threads
thread_pool_size = 16
```

### 4. Versioning Git

```bash
# Initialiser le repo
cd /etc/mysql
git init
git add .
git commit -m "Initial MariaDB 11.8 configuration"

# Apr√®s chaque modification
git diff                        # Voir les changements
git add mariadb.conf.d/40-performance.cnf
git commit -m "Increase buffer pool to 40G for production load"

# Rollback si probl√®me
git log --oneline
git checkout HEAD~1 mariadb.conf.d/40-performance.cnf
systemctl restart mariadb
```

### 5. Validation pr√©-d√©ploiement

```bash
#!/bin/bash
# validate-config.sh

echo "=== Validating MariaDB configuration ==="

# 1. Syntax check
echo "Checking syntax..."
mysqld --verbose --help > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "‚ùå Syntax error in configuration"
    exit 1
fi

# 2. Display effective values
echo "Effective configuration:"
my_print_defaults mysqld | grep -E "(buffer_pool_size|max_connections)"

# 3. Check critical parameters
BUFFER_POOL=$(my_print_defaults mysqld | grep buffer-pool-size | cut -d= -f2)
echo "InnoDB Buffer Pool: $BUFFER_POOL"

echo "‚úÖ Configuration valid"
```

---

## Cas d'usage avanc√©s

### Configuration Galera Cluster

Organisation pour cluster 3 n≈ìuds :

```
/etc/mysql/
‚îú‚îÄ‚îÄ my.cnf                              # Minimal
‚îú‚îÄ‚îÄ conf.d/
‚îÇ   ‚îú‚îÄ‚îÄ 10-base.cnf                    # Commun √† tous les n≈ìuds
‚îÇ   ‚îú‚îÄ‚îÄ 20-innodb.cnf                  # InnoDB commun
‚îÇ   ‚îî‚îÄ‚îÄ 30-galera-common.cnf           # Galera commun
‚îî‚îÄ‚îÄ node-specific/
    ‚îú‚îÄ‚îÄ node1.cnf                       # Sp√©cifique node1
    ‚îú‚îÄ‚îÄ node2.cnf                       # Sp√©cifique node2
    ‚îî‚îÄ‚îÄ node3.cnf                       # Sp√©cifique node3
```

```ini
# 30-galera-common.cnf
[galera]
wsrep_on = ON
wsrep_provider = /usr/lib/galera/libgalera_smm.so
wsrep_cluster_name = "production_cluster"
wsrep_cluster_address = "gcomm://node1,node2,node3"
wsrep_sst_method = mariabackup

# node1.cnf
[galera]
wsrep_node_name = "node1"
wsrep_node_address = "192.168.1.11"
server-id = 1
```

D√©ploiement avec Ansible :

```yaml
- name: Deploy node-specific Galera config
  copy:
    src: "node-specific/{{ inventory_hostname }}.cnf"
    dest: /etc/mysql/conf.d/99-node-specific.cnf
```

### Container Docker avec config custom

```dockerfile
FROM mariadb:11.8

# Copier configurations modulaires
COPY docker-config/10-base.cnf /etc/mysql/mariadb.conf.d/
COPY docker-config/20-innodb.cnf /etc/mysql/mariadb.conf.d/
COPY docker-config/30-docker-specific.cnf /etc/mysql/mariadb.conf.d/
```

```yaml
# docker-compose.yml
version: '3.8'
services:
  mariadb:
    image: mariadb:11.8
    volumes:
      - ./config/docker.cnf:/etc/mysql/conf.d/zz-docker.cnf:ro
      - mariadb_data:/var/lib/mysql
```

### Kubernetes ConfigMap

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: mariadb-config
data:
  custom.cnf: |
    [mysqld]
    max_connections = 1000
    innodb_buffer_pool_size = 8G

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mariadb
spec:
  template:
    spec:
      containers:
      - name: mariadb
        image: mariadb:11.8
        volumeMounts:
        - name: config
          mountPath: /etc/mysql/mariadb.conf.d/99-k8s.cnf
          subPath: custom.cnf
      volumes:
      - name: config
        configMap:
          name: mariadb-config
```

---

## Erreurs courantes et r√©solution

### Erreur 1 : Configuration non appliqu√©e

**Sympt√¥me** : Param√®tre dans `my.cnf` mais `SHOW VARIABLES` montre une valeur diff√©rente

**Diagnostic** :

```bash
# 1. V√©rifier l'ordre de lecture
mysqld --help --verbose | head -n 30

# 2. V√©rifier quelle valeur est r√©ellement charg√©e
my_print_defaults mysqld | grep innodb_buffer_pool_size

# 3. V√©rifier dans quel fichier le param√®tre est d√©fini
grep -r "innodb_buffer_pool_size" /etc/mysql/
```

**Causes possibles** :
- Param√®tre √©cras√© par un fichier lu plus tard
- Section incorrecte (`[mysqld]` vs `[client]`)
- Faute de frappe dans le nom du param√®tre
- Variable statique n√©cessitant un red√©marrage

### Erreur 2 : Permissions incorrectes sur ~/.my.cnf

**Sympt√¥me** : Warning au d√©marrage du client

```
Warning: World-writable config file '/home/user/.my.cnf' is ignored
```

**Solution** :

```bash
chmod 600 ~/.my.cnf
chown $USER:$USER ~/.my.cnf
```

### Erreur 3 : Fichier !includedir non lu

**Sympt√¥me** : Fichiers dans `/etc/mysql/conf.d/` ignor√©s

**Causes** :
- Extension != `.cnf`
- R√©pertoire absent
- Permissions insuffisantes

```bash
# V√©rifier
ls -la /etc/mysql/conf.d/*.cnf

# V√©rifier les permissions
find /etc/mysql -name "*.cnf" -ls
```

### Erreur 4 : Conflit entre options

**Sympt√¥me** : Comportement inattendu d√ª √† des valeurs contradictoires

```ini
# Fichier A
[mysqld]
innodb_flush_log_at_trx_commit = 1  # S√©curit√© maximale

# Fichier B (lu apr√®s)
[mysqld]
innodb_flush_log_at_trx_commit = 0  # Performance maximale
```

**Solution** : Audit complet

```bash
# Voir toutes les d√©finitions de cette variable
grep -r "innodb_flush_log_at_trx_commit" /etc/mysql/

# Voir la valeur finale
my_print_defaults mysqld | grep flush_log_at_trx_commit
```

---

## Checklist de validation

Avant tout red√©marrage en production :

```bash
#!/bin/bash
# pre-restart-validation.sh

echo "=== MariaDB Configuration Pre-Restart Validation ==="

# 1. Syntax validation
echo -n "1. Syntax check... "
if mysqld --verbose --help > /dev/null 2>&1; then
    echo "‚úÖ OK"
else
    echo "‚ùå FAILED"
    exit 1
fi

# 2. Critical parameters check
echo "2. Critical parameters:"
my_print_defaults mysqld | grep -E "(innodb_buffer_pool_size|max_connections|port|datadir)"

# 3. File permissions check
echo -n "3. Checking file permissions... "
find /etc/mysql -name "*.cnf" -type f ! -perm 644 -o ! -perm 640 | grep -q .
if [ $? -eq 0 ]; then
    echo "‚ö†Ô∏è  Warning: Non-standard permissions found"
else
    echo "‚úÖ OK"
fi

# 4. Configuration files read order
echo "4. Configuration read order:"
mysqld --help --verbose 2>/dev/null | grep -A 1 "Default options"

# 5. Git status (if versioned)
if [ -d /etc/mysql/.git ]; then
    echo "5. Git status:"
    cd /etc/mysql && git status --short
fi

echo ""
echo "=== Validation Complete ==="
echo "Proceed with restart? (yes/no)"
read CONFIRM

if [ "$CONFIRM" == "yes" ]; then
    echo "Restarting MariaDB..."
    systemctl restart mariadb
    systemctl status mariadb
else
    echo "Restart aborted"
fi
```

---

## ‚úÖ Points cl√©s √† retenir

- **Ordre de lecture** : MariaDB suit une s√©quence pr√©cise et pr√©dictable (`/etc/my.cnf` ‚Üí `/etc/mysql/my.cnf` ‚Üí `~/.my.cnf`)
- **Last wins** : En cas de conflit, le dernier param√®tre lu l'emporte (principe fondamental)
- **!includedir** : Charge tous les `*.cnf` par ordre alphab√©tique (d'o√π l'importance du pr√©fixe num√©rique)
- **!include** : Charge un fichier sp√©cifique, n'importe quelle extension
- **--defaults-file** : Force l'utilisation d'un seul fichier (ignore tout le reste)
- **--defaults-extra-file** : Ajoute un fichier suppl√©mentaire sans ignorer les autres
- **Permissions** : `~/.my.cnf` doit √™tre en mode 600 sinon il est ignor√©
- **Debugging** : Utiliser `mysqld --help --verbose` et `my_print_defaults` pour diagnostiquer
- **Organisation** : Pr√©f√©rer une approche modulaire avec num√©rotation (10-, 20-, 30-..., 99-)
- **Production** : Toujours valider avec `mysqld --help --verbose` avant red√©marrage

---

## üîó Ressources et r√©f√©rences

- [üìñ Documentation officielle : Option Files](https://mariadb.com/kb/en/configuring-mariadb-with-option-files/)
- [üìñ Documentation officielle : my_print_defaults](https://mariadb.com/kb/en/my_print_defaults/)
- [üìñ Documentation officielle : mysql_config_editor](https://mariadb.com/kb/en/mysql_config_editor/)
- [üìñ Server System Variables](https://mariadb.com/kb/en/server-system-variables/)
- [Blog : Understanding MariaDB Configuration Files](https://mariadb.org/understanding-configuration/)

---

## ‚û°Ô∏è Section suivante

**11.1.3 - Include et configuration modulaire** : Approfondissement des techniques d'organisation modulaire pour des configurations complexes, patterns avanc√©s pour multi-datacenter et strat√©gies de templating.

‚è≠Ô∏è [Include et configuration modulaire](/11-administration-configuration/01.3-include-modulaire.md)
