üîù Retour au [Sommaire](/SOMMAIRE.md)

# 11.5.1 Configuration binlog

> **Niveau** : Avanc√© (DBA/Administrateur Syst√®me)  
> **Dur√©e estim√©e** : 2 heures  
> **Pr√©requis** : 11.4 - Gestion des logs, concepts de r√©plication, administration avanc√©e

## üéØ Objectifs d'apprentissage

√Ä l'issue de cette section, vous serez capable de :
- Configurer et activer le binary logging de mani√®re optimale
- Choisir le bon format de binlog selon le cas d'usage (STATEMENT, ROW, MIXED)
- G√©rer la rotation et la purge des binary logs
- Optimiser les performances du binary logging
- Impl√©menter des strat√©gies de r√©tention appropri√©es
- Utiliser le binlog pour la r√©plication et le point-in-time recovery
- Monitorer et troubleshooter les probl√®mes li√©s au binlog
- Appliquer les bonnes pratiques de production

---

## Introduction

Le **binary log** (binlog) est un ensemble de fichiers qui enregistrent toutes les modifications apport√©es aux donn√©es (INSERT, UPDATE, DELETE, DDL). C'est un composant **fondamental** de l'architecture MariaDB.

### Utilit√© du binary log

| Usage | Description | Criticit√© |
|-------|-------------|-----------|
| **R√©plication** | Propagation des changements vers replicas | üî¥ Critique |
| **Point-in-Time Recovery** | Restauration √† un instant T pr√©cis | üî¥ Critique |
| **Audit** | Tra√ßabilit√© des modifications | üü° Important |
| **Change Data Capture** | Streaming vers syst√®mes externes | üü° Important |

üí° **Important** : Le binary log est **obligatoire** pour la r√©plication. Si vous avez des replicas, le binlog doit √™tre activ√© sur le primary.

### Diff√©rence avec autres logs

```
Error log       ‚Üí Probl√®mes serveur (pas les requ√™tes)
Slow query log  ‚Üí Requ√™tes lentes (lecture+√©criture)
General log     ‚Üí TOUTES les requ√™tes (overhead √©lev√©)
Binary log      ‚Üí Modifications de donn√©es uniquement (DML+DDL)
```

---

## Configuration de base

### Activation dans my.cnf

```ini
# /etc/mysql/mariadb.conf.d/50-server.cnf

[mysqld]
# === Binary Log Configuration ===

# Activer binary logging
log_bin = /var/log/mysql/mysql-bin

# OU simplement (fichier dans datadir)
# log_bin = mysql-bin

# Index des fichiers binlog
log_bin_index = /var/log/mysql/mysql-bin.index

# Format du binlog (STATEMENT, ROW, MIXED)
binlog_format = ROW

# Taille maximale d'un fichier binlog (d√©faut: 1GB)
max_binlog_size = 1G

# Nombre de jours de r√©tention (0 = infini)
expire_logs_days = 7

# Synchronisation sur disque (durabilit√©)
sync_binlog = 1

# Server ID unique (OBLIGATOIRE pour r√©plication)
server_id = 1
```

‚ö†Ô∏è **Attention** : Modification de `log_bin` n√©cessite un **red√©marrage** du serveur.

### V√©rification de l'activation

```sql
-- V√©rifier que binlog est activ√©
SHOW VARIABLES LIKE 'log_bin';
-- log_bin = ON ‚úÖ

-- Voir tous les param√®tres binlog
SHOW VARIABLES LIKE '%binlog%';
SHOW VARIABLES LIKE '%log_bin%';

-- Liste des fichiers binlog actuels
SHOW BINARY LOGS;
```

R√©sultat typique :

```
+------------------+-----------+-----------+
| Log_name         | File_size | Encrypted |
+------------------+-----------+-----------+
| mysql-bin.000001 | 177       | No        |
| mysql-bin.000002 | 234567890 | No        |
| mysql-bin.000003 | 156789123 | No        |
+------------------+-----------+-----------+
```

### Variables syst√®me importantes

```sql
-- Configuration active
SELECT
    @@global.log_bin AS binlog_enabled,
    @@global.log_bin_basename AS binlog_path,
    @@global.binlog_format AS format,
    @@global.max_binlog_size AS max_size,
    @@global.expire_logs_days AS retention_days,
    @@global.sync_binlog AS sync_binlog,
    @@global.server_id AS server_id;
```

---

## Formats de binary log

### STATEMENT : Format bas√© sur requ√™tes

**Principe** : Enregistre la requ√™te SQL telle quelle.

```sql
-- Requ√™te ex√©cut√©e
UPDATE users SET last_login = NOW() WHERE id = 42;

-- Dans le binlog (format STATEMENT)
UPDATE users SET last_login = NOW() WHERE id = 42;
```

**Avantages** :
- ‚úÖ Fichiers binlog compacts (requ√™te unique m√™me si 1M rows affect√©es)
- ‚úÖ Lisible pour les humains
- ‚úÖ Moins d'I/O disque

**Inconv√©nients** :
- ‚ùå Fonctions non-d√©terministes (NOW(), UUID(), RAND()) posent probl√®me
- ‚ùå Risque d'incoh√©rence sur replicas
- ‚ùå Triggers peuvent donner r√©sultats diff√©rents

**Exemple de probl√®me** :

```sql
-- Sur primary √† 14:00:00
UPDATE orders SET created_at = NOW() WHERE id = 123;
-- created_at = '2025-12-13 14:00:00'

-- Sur replica rejou√©e √† 14:00:05
-- created_at = '2025-12-13 14:00:05'  ‚ö†Ô∏è DIFF√âRENT !
```

### ROW : Format bas√© sur lignes

**Principe** : Enregistre les changements ligne par ligne (avant/apr√®s).

```sql
-- Requ√™te ex√©cut√©e
UPDATE users SET status = 'active' WHERE country = 'FR';
-- Affecte 50000 lignes

-- Dans le binlog (format ROW) - simplifi√©
### UPDATE users
### WHERE id = 1
### SET status = 'active'
### UPDATE users
### WHERE id = 2
### SET status = 'active'
### ... (50000 lignes)
```

**Avantages** :
- ‚úÖ **D√©terministe** : R√©sultat identique sur tous les replicas
- ‚úÖ Pas de probl√®me avec fonctions non-d√©terministes
- ‚úÖ Point-in-time recovery pr√©cis
- ‚úÖ Change Data Capture facile

**Inconv√©nients** :
- ‚ùå Fichiers binlog plus volumineux
- ‚ùå Plus d'I/O disque
- ‚ùå Moins lisible pour les humains

**Configuration recommand√©e** :

```ini
[mysqld]
binlog_format = ROW

# Optimisation : logger uniquement colonnes modifi√©es
binlog_row_image = MINIMAL  # Options: FULL, MINIMAL, NOBLOB
```

**binlog_row_image** :

| Valeur | Contenu | Taille binlog | Use case |
|--------|---------|---------------|----------|
| **FULL** | Toutes les colonnes | Grande | D√©faut, compatible |
| **MINIMAL** | Colonnes modifi√©es seulement | **Optimale** | Production recommand√© |
| **NOBLOB** | Tout sauf BLOB/TEXT | Moyenne | Si peu de BLOBs |

### MIXED : Format hybride

**Principe** : STATEMENT par d√©faut, ROW si requ√™te non-d√©terministe.

```sql
-- Requ√™te d√©terministe ‚Üí STATEMENT
UPDATE users SET active = 1 WHERE id = 42;

-- Requ√™te non-d√©terministe ‚Üí ROW
UPDATE users SET token = UUID() WHERE role = 'admin';
```

**Avantages** :
- ‚úÖ √âquilibre entre taille et s√©curit√©
- ‚úÖ MariaDB choisit automatiquement

**Inconv√©nients** :
- ‚ùå Complexit√© accrue
- ‚ùå Moins pr√©visible

### Comparaison et recommandations

| Crit√®re | STATEMENT | ROW | MIXED |
|---------|-----------|-----|-------|
| **Taille binlog** | Petit | Grand | Moyen |
| **D√©terminisme** | ‚ùå Non | ‚úÖ Oui | ‚úÖ Oui |
| **Performance** | √âlev√©e | Moyenne | Moyenne-√âlev√©e |
| **Lisibilit√©** | Haute | Basse | Variable |
| **CDC/Streaming** | Limit√© | ‚úÖ Excellent | Bon |
| **PITR pr√©cision** | Moyenne | ‚úÖ Haute | Haute |

**Recommandation production** :

```ini
[mysqld]
# ‚úÖ ROW = Standard moderne recommand√©
binlog_format = ROW
binlog_row_image = MINIMAL  # Optimisation taille
```

üí° **ROW** est le format par d√©faut depuis MariaDB 10.2.4 et est recommand√© pour tous les nouveaux d√©ploiements.

---

## Emplacement et nommage

### Structure des fichiers binlog

```
/var/log/mysql/
‚îú‚îÄ‚îÄ mysql-bin.000001      # Premier fichier binlog
‚îú‚îÄ‚îÄ mysql-bin.000002      # Deuxi√®me (apr√®s rotation)
‚îú‚îÄ‚îÄ mysql-bin.000003      # Troisi√®me
‚îú‚îÄ‚îÄ mysql-bin.000004      # Actuel
‚îî‚îÄ‚îÄ mysql-bin.index       # Index (liste des fichiers)
```

**Fichier index** :

```bash
cat /var/log/mysql/mysql-bin.index

# Contenu :
/var/log/mysql/mysql-bin.000001
/var/log/mysql/mysql-bin.000002
/var/log/mysql/mysql-bin.000003
/var/log/mysql/mysql-bin.000004
```

### Nomenclature recommand√©e

```ini
# Option 1 : Nom par d√©faut dans datadir
[mysqld]
log_bin = mysql-bin

# Option 2 : Emplacement d√©di√© avec nom explicite
[mysqld]
log_bin = /var/log/mysql/mariadb-bin

# Option 3 : Inclure hostname (multi-serveurs)
[mysqld]
log_bin = /var/log/mysql/$(hostname)-bin
```

### S√©paration des binlogs sur partition d√©di√©e

**Recommandation production** : Binlogs sur partition s√©par√©e

```bash
# Cr√©er partition d√©di√©e
sudo mkdir -p /binlogs
sudo chown mysql:mysql /binlogs

# Monter partition (exemple)
# /dev/sdb1 sur /binlogs

# my.cnf
# log_bin = /binlogs/mysql-bin
```

**Avantages** :
- ‚úÖ Performances I/O isol√©es
- ‚úÖ Pas d'impact sur datadir si binlog remplit disque
- ‚úÖ Facilite monitoring espace disque
- ‚úÖ Possibilit√© d'utiliser stockage optimis√© pour √©critures s√©quentielles

---

## Rotation des binary logs

### D√©clenchement automatique de la rotation

La rotation cr√©e un nouveau fichier binlog dans ces cas :

1. **Taille maximale atteinte** (`max_binlog_size`)
2. **Red√©marrage du serveur**
3. **Commande FLUSH LOGS**
4. **Changement de binlog_format**

```sql
-- Forcer rotation manuelle
FLUSH BINARY LOGS;

-- V√©rifier
SHOW BINARY LOGS;
-- Un nouveau fichier devrait appara√Ætre
```

### Configuration max_binlog_size

```ini
[mysqld]
# Taille maximale par fichier binlog
max_binlog_size = 1G  # D√©faut et recommand√©

# Autres valeurs possibles
# max_binlog_size = 512M  # Si rotation fr√©quente souhait√©e
# max_binlog_size = 2G    # Si moins de fichiers souhait√©s
```

üí° **Best practice** : Garder la valeur par d√©faut (1GB) sauf besoin sp√©cifique.

**Rotation fr√©quente** (fichiers plus petits) :
- ‚úÖ Purge granulaire plus facile
- ‚úÖ Gestion plus simple
- ‚ùå Plus de fichiers √† g√©rer

**Rotation moins fr√©quente** (fichiers plus gros) :
- ‚úÖ Moins de fichiers
- ‚ùå Purge moins granulaire
- ‚ùå Plus difficile √† manipuler

---

## Purge et r√©tention

### expire_logs_days : Purge automatique

```ini
[mysqld]
# Purger binlogs > 7 jours automatiquement
expire_logs_days = 7

# Variantes
# expire_logs_days = 3   # Environnement dev
# expire_logs_days = 14  # Production avec backup quotidien
# expire_logs_days = 30  # Conformit√©/audit
# expire_logs_days = 0   # PAS de purge auto (‚ö†Ô∏è g√©rer manuellement)
```

‚ö†Ô∏è **ATTENTION** : `expire_logs_days = 0` signifie **AUCUNE purge automatique**. Les binlogs s'accumuleront ind√©finiment !

### Purge manuelle

```sql
-- Voir tous les binlogs
SHOW BINARY LOGS;

-- Purger tous les binlogs avant un fichier sp√©cifique
PURGE BINARY LOGS TO 'mysql-bin.000010';

-- Purger binlogs avant une date
PURGE BINARY LOGS BEFORE '2025-12-01 00:00:00';

-- Purger binlogs > 7 jours
PURGE BINARY LOGS BEFORE DATE_SUB(NOW(), INTERVAL 7 DAY);

-- Purger TOUS les binlogs (‚ö†Ô∏è DANGER si r√©plication active)
RESET MASTER;
```

‚ö†Ô∏è **DANGER avec RESET MASTER** :
- Supprime **tous** les binlogs
- **Casse la r√©plication** si replicas actifs
- √Ä utiliser uniquement si :
  - Aucun replica actif
  - OU reconfiguration compl√®te de la r√©plication

### Strat√©gie de purge en production

```sql
-- Script de purge s√©curis√© pour primary avec replicas
-- Garder les binlogs n√©cessaires aux replicas

-- 1. V√©rifier position de chaque replica
SHOW SLAVE HOSTS;

-- 2. Sur chaque replica, v√©rifier position
SHOW SLAVE STATUS\G
-- Noted : Master_Log_File et Read_Master_Log_Pos

-- 3. Purger uniquement les binlogs lus par TOUS les replicas
-- Ne PAS purger le binlog actuel du replica le plus en retard

-- Exemple : Si replica le plus lent est sur mysql-bin.000015
-- Purger seulement jusqu'√† mysql-bin.000014
PURGE BINARY LOGS TO 'mysql-bin.000014';
```

### Script automatis√© de purge s√©curis√©e

```bash
#!/bin/bash
# safe-purge-binlogs.sh

# Trouver le binlog le plus ancien encore utilis√© par un replica
OLDEST_BINLOG=$(mysql -N -e "
    SELECT MIN(Master_Log_File)
    FROM information_schema.SLAVE_STATUS
    WHERE Master_Log_File IS NOT NULL
")

if [ -n "$OLDEST_BINLOG" ]; then
    echo "Oldest binlog in use by replicas: $OLDEST_BINLOG"
    echo "Purging binlogs before $OLDEST_BINLOG"

    mysql -e "PURGE BINARY LOGS TO '$OLDEST_BINLOG';"

    echo "Purge complete"
else
    echo "No replicas detected or no binlog info"
    echo "Purging binlogs older than 7 days"

    mysql -e "PURGE BINARY LOGS BEFORE DATE_SUB(NOW(), INTERVAL 7 DAY);"
fi

# V√©rifier binlogs restants
mysql -e "SHOW BINARY LOGS;"
```

---

## Synchronisation et durabilit√©

### sync_binlog : Garantie ACID

```ini
[mysqld]
# Synchronisation sur disque
sync_binlog = 1  # Recommand√© pour ACID complet

# Alternatives (moins s√ªres mais plus rapides)
# sync_binlog = 0  # OS d√©cide (DANGER : perte donn√©es possible)
# sync_binlog = 100  # Sync toutes les 100 transactions (compromis)
```

**Comportement** :

| sync_binlog | Comportement | Durabilit√© | Performance |
|-------------|--------------|------------|-------------|
| **0** | OS d√©cide quand √©crire | ‚ùå Faible | ‚ö° Maximale |
| **1** | Sync apr√®s chaque transaction | ‚úÖ **Maximale** | üêå Plus lente |
| **N (>1)** | Sync toutes les N transactions | ‚ö†Ô∏è Moyenne | üöÄ Bonne |

**Recommandation** :

```ini
# Production critique (banking, paiements)
sync_binlog = 1
innodb_flush_log_at_trx_commit = 1  # Coh√©rence InnoDB + binlog

# Production standard
sync_binlog = 1  # Toujours recommand√©

# Dev/Test uniquement
# sync_binlog = 0  # Performance max, risque perte donn√©es acceptable
```

üí° **Best practice** : `sync_binlog = 1` en production pour garantir qu'aucune transaction n'est perdue en cas de crash.

---

## Compression des binary logs

### binlog_compress (MariaDB 10.2+)

```ini
[mysqld]
# Activer compression binlog
binlog_compress = ON

# Niveau compression (1-9, d√©faut 6)
binlog_compress_min_len = 256  # Compresser si > 256 bytes
```

**Avantages** :
- ‚úÖ R√©duction taille binlog (~50-70%)
- ‚úÖ Moins d'I/O r√©seau pour r√©plication
- ‚úÖ √âconomie espace disque

**Inconv√©nients** :
- ‚ùå L√©ger overhead CPU
- ‚ùå Binlogs moins lisibles avec mysqlbinlog

**Recommandation** :

```sql
-- V√©rifier si activ√©
SHOW VARIABLES LIKE 'binlog_compress%';

-- Activer dynamiquement
SET GLOBAL binlog_compress = ON;

-- Persister
SET PERSIST binlog_compress = ON;
```

---

## Binlog et r√©plication

### Configuration Primary (Master)

```ini
# /etc/mysql/mariadb.conf.d/50-server.cnf

[mysqld]
# === Binary Log for Replication ===

# Server ID unique (OBLIGATOIRE)
server_id = 1

# Activer binlog
log_bin = /var/log/mysql/mysql-bin

# Format ROW recommand√©
binlog_format = ROW
binlog_row_image = MINIMAL

# R√©tention selon besoins replicas
expire_logs_days = 7

# Durabilit√©
sync_binlog = 1

# Compression (optionnel)
binlog_compress = ON

# Ne pas logger certaines bases syst√®me (optionnel)
binlog_ignore_db = information_schema
binlog_ignore_db = performance_schema
binlog_ignore_db = mysql
```

### Configuration Replica (Slave)

```ini
[mysqld]
# Server ID unique (DIFFERENT du primary)
server_id = 2

# Relay log
relay_log = /var/log/mysql/relay-bin
relay_log_index = /var/log/mysql/relay-bin.index

# Aussi binlog si cascade ou future promotion
log_bin = /var/log/mysql/mysql-bin
log_slave_updates = ON  # Logger les updates re√ßues

# Read-only (s√©curit√©)
read_only = ON
super_read_only = ON
```

### V√©rification de la r√©plication

```sql
-- Sur Primary
SHOW MASTER STATUS;

+------------------+----------+--------------+------------------+
| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+------------------+----------+--------------+------------------+
| mysql-bin.000004 | 157      |              |                  |
+------------------+----------+--------------+------------------+

-- Sur Replica
SHOW SLAVE STATUS\G

-- Champs importants :
-- Master_Log_File: mysql-bin.000004
-- Read_Master_Log_Pos: 157
-- Slave_IO_Running: Yes
-- Slave_SQL_Running: Yes
-- Seconds_Behind_Master: 0
```

---

## Point-in-Time Recovery (PITR)

### Extraction du contenu binlog

```bash
# Voir contenu d'un binlog (format texte)
mysqlbinlog /var/log/mysql/mysql-bin.000004

# Avec timestamps lisibles
mysqlbinlog --base64-output=DECODE-ROWS -v /var/log/mysql/mysql-bin.000004

# Filtrer par base de donn√©es
mysqlbinlog --database=ecommerce /var/log/mysql/mysql-bin.000004

# Filtrer par p√©riode
mysqlbinlog --start-datetime="2025-12-13 10:00:00" \
            --stop-datetime="2025-12-13 14:00:00" \
            /var/log/mysql/mysql-bin.000004
```

### Sc√©nario de recovery complet

**Situation** : Erreur humaine √† 14:30, besoin de restaurer √† 14:29:00

```bash
#!/bin/bash
# point-in-time-recovery.sh

# 1. Restaurer backup de la nuit (00:00)
mysql < /backup/full-backup-2025-12-13-00h00.sql

# 2. Appliquer binlogs jusqu'√† l'instant avant l'erreur
mysqlbinlog --start-datetime="2025-12-13 00:00:00" \
            --stop-datetime="2025-12-13 14:29:00" \
            /var/log/mysql/mysql-bin.000* | mysql

# 3. V√©rifier
mysql -e "SELECT NOW(), 'Recovery complete' AS status;"

# 4. Optionnel : Appliquer manuellement transactions valides apr√®s 14:29
# (si certaines transactions apr√®s l'erreur doivent √™tre conserv√©es)
```

### PITR avec position exacte

```bash
# Si timestamp insuffisant, utiliser positions binlog

# Trouver position exacte
mysqlbinlog /var/log/mysql/mysql-bin.000015 | grep -A 5 -B 5 "problematic query"
# Note position : 12345678

# Recovery jusqu'√† position - 1
mysqlbinlog --start-position=0 \
            --stop-position=12345677 \
            /var/log/mysql/mysql-bin.000015 | mysql
```

---

## Monitoring et m√©triques

### M√©triques importantes

```sql
-- Espace disque utilis√© par binlogs
SELECT
    ROUND(SUM(file_size)/1024/1024/1024, 2) AS total_gb
FROM information_schema.BINARY_LOG_FILES;

-- Nombre de fichiers binlog
SELECT COUNT(*) AS binlog_count
FROM information_schema.BINARY_LOG_FILES;

-- Binlog le plus ancien
SELECT file_name,
       FROM_UNIXTIME(file_modified_time) AS created_date,
       ROUND(file_size/1024/1024, 2) AS size_mb
FROM information_schema.BINARY_LOG_FILES
ORDER BY file_name
LIMIT 1;

-- Taux de croissance
SHOW GLOBAL STATUS LIKE 'Binlog_cache%';
```

### Script de monitoring

```bash
#!/bin/bash
# monitor-binlog.sh

BINLOG_DIR="/var/log/mysql"
ALERT_THRESHOLD_GB=50

# Calculer taille totale
TOTAL_SIZE_GB=$(du -sh $BINLOG_DIR | awk '{print $1}' | sed 's/G//')

echo "=== Binary Log Monitoring ==="
echo "Total size: ${TOTAL_SIZE_GB}GB"

# Nombre de fichiers
FILE_COUNT=$(mysql -N -e "SELECT COUNT(*) FROM information_schema.BINARY_LOG_FILES")
echo "File count: $FILE_COUNT"

# Binlog actuel
CURRENT_BINLOG=$(mysql -N -e "SHOW MASTER STATUS" | awk '{print $1}')
echo "Current binlog: $CURRENT_BINLOG"

# Alert si > seuil
if (( $(echo "$TOTAL_SIZE_GB > $ALERT_THRESHOLD_GB" | bc -l) )); then
    echo "‚ö†Ô∏è  WARNING: Binlog size exceeds ${ALERT_THRESHOLD_GB}GB"
    echo "Consider purging old binlogs"
fi
```

### Int√©gration Prometheus

```yaml
# mysqld_exporter expose ces m√©triques
mysql_global_status_binlog_cache_disk_use
mysql_global_status_binlog_cache_use
mysql_global_variables_max_binlog_size

# Alertes Prometheus
groups:
  - name: binlog_alerts
    rules:
      - alert: BinlogDiskUsageHigh
        expr: sum(mysql_binlog_file_size_bytes) / 1024 / 1024 / 1024 > 100
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "Binary logs using > 100GB"
```

---

## Performance et optimisation

### Binlog cache

```ini
[mysqld]
# Taille du cache binlog par transaction
binlog_cache_size = 32K  # D√©faut, g√©n√©ralement suffisant

# Si nombreuses transactions volumineuses
# binlog_cache_size = 1M

# Surveiller
# SHOW GLOBAL STATUS LIKE 'Binlog_cache%';
```

**M√©triques √† surveiller** :

```sql
SHOW GLOBAL STATUS LIKE 'Binlog_cache%';

-- Binlog_cache_disk_use : Nombre de transactions ayant d√©bord√© le cache
-- Binlog_cache_use : Nombre de transactions utilisant le cache

-- Si Binlog_cache_disk_use > 1% de Binlog_cache_use
-- ‚Üí Augmenter binlog_cache_size
```

### Optimisation I/O

```ini
[mysqld]
# Partition d√©di√©e pour binlogs (best practice)
log_bin = /binlogs/mysql-bin

# Compression pour r√©duire I/O
binlog_compress = ON

# Format ROW avec MINIMAL pour r√©duire taille
binlog_format = ROW
binlog_row_image = MINIMAL

# Sync optimal
sync_binlog = 1  # Ne pas modifier pour performance

# Taille fichier optimale
max_binlog_size = 1G
```

### Impact sur les performances

**Overhead typique** :

```
sync_binlog = 0  : ~2% overhead
sync_binlog = 1  : ~5-10% overhead (mais ACID complet)
sync_binlog = 100: ~3% overhead (compromis)
```

**Benchmark** :

```bash
# Sans binlog
[mysqld]
skip-log-bin

# Test avec sysbench
# ‚Üí Baseline: 10000 TPS

# Avec binlog (sync_binlog = 1)
[mysqld]
log_bin = mysql-bin
sync_binlog = 1

# Test avec sysbench
# ‚Üí Avec binlog: 9000-9500 TPS (-5 √† -10%)
```

üí° L'overhead est **acceptable** vu les b√©n√©fices (r√©plication, PITR, audit).

---

## S√©curit√©

### Chiffrement des binary logs

```ini
[mysqld]
# Activer chiffrement binlog (MariaDB 10.1.7+)
encrypt_binlog = ON

# Plugin de chiffrement
plugin_load_add = file_key_management

# Fichier de cl√©s
file_key_management_filename = /etc/mysql/encryption/keyfile.enc
```

### Permissions fichiers binlog

```bash
# Binlogs doivent √™tre accessibles uniquement par mysql
ls -la /var/log/mysql/mysql-bin.*
# -rw------- 1 mysql mysql

# Si permissions incorrectes
sudo chown mysql:mysql /var/log/mysql/mysql-bin.*
sudo chmod 600 /var/log/mysql/mysql-bin.*
```

---

## Troubleshooting

### Probl√®me 1 : Binlogs remplissent le disque

```bash
# Diagnostic
df -h /var/log/mysql
# 95% utilis√© ‚ö†Ô∏è

du -sh /var/log/mysql/mysql-bin.*
# Identifier les gros fichiers

# Solution imm√©diate
mysql -e "PURGE BINARY LOGS BEFORE DATE_SUB(NOW(), INTERVAL 1 DAY);"

# Solution p√©renne
vim /etc/mysql/mariadb.conf.d/50-server.cnf
# expire_logs_days = 3  # R√©duire r√©tention
```

### Probl√®me 2 : Binlog corrompu

```bash
# Sympt√¥me
mysqlbinlog /var/log/mysql/mysql-bin.000123
# ERROR: Error in Log_event::read_log_event()

# Solution : Identifier et isoler
# 1. Trouver dernier binlog valide
mysqlbinlog --verify-binlog-checksum /var/log/mysql/mysql-bin.000122
# OK

# 2. Sur replica, skip le binlog corrompu
CHANGE MASTER TO MASTER_LOG_FILE='mysql-bin.000124', MASTER_LOG_POS=4;
START SLAVE;

# 3. Sur primary, archiver et purger le binlog corrompu
mv /var/log/mysql/mysql-bin.000123 /backup/corrupted/
PURGE BINARY LOGS TO 'mysql-bin.000124';
```

### Probl√®me 3 : R√©plication cass√©e apr√®s purge

```sql
-- Sympt√¥me sur replica
SHOW SLAVE STATUS\G
-- Last_IO_Error: Got fatal error 1236 from master when reading data from binary log:
--   'Could not find first log file name in binary log index file'

-- Cause : Binlog purg√© trop t√¥t sur primary

-- Solution : Resynchroniser depuis backup
-- 1. Backup r√©cent du primary
-- 2. Restaurer sur replica
-- 3. Reconfigurer r√©plication depuis nouvelle position
```

---

## Bonnes pratiques

### 1. Toujours activer en production

```ini
# ‚úÖ BON
[mysqld]
log_bin = /var/log/mysql/mysql-bin
server_id = 1

# ‚ùå MAUVAIS
# skip-log-bin
```

### 2. Utiliser format ROW

```ini
[mysqld]
binlog_format = ROW
binlog_row_image = MINIMAL
```

### 3. Configuration durabilit√©

```ini
[mysqld]
sync_binlog = 1
innodb_flush_log_at_trx_commit = 1
```

### 4. Purge automatique configur√©e

```ini
[mysqld]
expire_logs_days = 7  # Adapter selon besoins
```

### 5. Monitoring espace disque

```bash
# Alerte si > 80%
df -h /var/log/mysql | awk 'NR==2 {print $5}' | sed 's/%//'
```

### 6. Partition d√©di√©e

```bash
# Binlogs sur partition s√©par√©e
/dev/sdb1 on /binlogs
```

### 7. Backup des binlogs

```bash
# Copier binlogs vers stockage externe
rsync -av /var/log/mysql/mysql-bin.* backup-server:/backup/binlogs/
```

---

## ‚úÖ Points cl√©s √† retenir

- **Binlog obligatoire** : Pour r√©plication et PITR
- **Format ROW** : Standard moderne recommand√© (d√©terministe)
- **sync_binlog = 1** : Durabilit√© ACID compl√®te en production
- **expire_logs_days** : Configurer r√©tention automatique (7-14 jours typique)
- **Partition d√©di√©e** : Isoler I/O et √©viter saturation datadir
- **binlog_row_image = MINIMAL** : Optimiser taille binlog
- **Purge s√©curis√©e** : Ne jamais purger binlogs encore utilis√©s par replicas
- **Monitoring** : Surveiller taille totale et espace disque
- **PITR** : Binlogs essentiels pour recovery pr√©cis
- **server_id unique** : OBLIGATOIRE pour r√©plication

---

## üîó Ressources et r√©f√©rences

- [üìñ Documentation officielle : Binary Log](https://mariadb.com/kb/en/binary-log/)
- [üìñ Documentation officielle : mysqlbinlog](https://mariadb.com/kb/en/mysqlbinlog/)
- [üìñ Replication](https://mariadb.com/kb/en/replication/)
- [üìñ Point-in-Time Recovery](https://mariadb.com/kb/en/point-in-time-recovery/)
- [üìñ Binary Log Formats](https://mariadb.com/kb/en/binary-log-formats/)
- [Blog : Binary Log Best Practices](https://mariadb.org/binlog-configuration/)

---

## ‚û°Ô∏è Section suivante

**11.5.2 - Formats binlog (STATEMENT, ROW, MIXED)** : Exploration approfondie des diff√©rences entre formats, cas d'usage sp√©cifiques, impact sur r√©plication et CDC, et strat√©gies de migration entre formats.

‚è≠Ô∏è [Formats : STATEMENT, ROW, MIXED](/11-administration-configuration/05.2-formats-binlog.md)
