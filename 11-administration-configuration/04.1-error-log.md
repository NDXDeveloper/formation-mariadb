üîù Retour au [Sommaire](/SOMMAIRE.md)

# 11.4.1 Error log

> **Niveau** : Avanc√© (DBA/Administrateur Syst√®me)  
> **Dur√©e estim√©e** : 1.5 heures  
> **Pr√©requis** : 11.1 - Configuration, notions Linux/Windows, administration syst√®me

## üéØ Objectifs d'apprentissage

√Ä l'issue de cette section, vous serez capable de :
- Configurer et g√©rer efficacement l'error log MariaDB
- Analyser et interpr√©ter les messages d'erreur pour le troubleshooting
- Mettre en place un syst√®me de rotation et d'archivage automatis√©
- Utiliser les diff√©rents niveaux de verbosit√© selon les besoins
- Int√©grer l'error log dans une strat√©gie de monitoring et d'alerting
- Diagnostiquer rapidement les probl√®mes critiques via l'error log
- Appliquer les bonnes pratiques de gestion des logs en production

---

## Introduction

L'**error log** est le fichier de log le plus important de MariaDB. Il enregistre :

- üö® **√âv√©nements critiques** : Crashes, corruption, erreurs fatales
- üîß **D√©marrage/arr√™t** : Informations de d√©marrage, configuration charg√©e
- ‚ö†Ô∏è **Avertissements** : Probl√®mes non critiques mais n√©cessitant attention
- üìä **Messages informatifs** : √âv√©nements normaux selon la verbosit√© configur√©e
- üîê **Probl√®mes de s√©curit√©** : Tentatives d'acc√®s non autoris√©es, erreurs d'authentification

üí° **Importance** : L'error log est souvent le **premier endroit √† consulter** lors de tout probl√®me MariaDB. Une bonne ma√Ætrise de ce log est essentielle pour tout DBA.

---

## Configuration de base

### Emplacement par d√©faut

| Syst√®me | Emplacement par d√©faut |
|---------|------------------------|
| **Linux/Unix** | `/var/log/mysql/error.log` ou `/var/lib/mysql/hostname.err` |
| **Windows** | `C:\ProgramData\MySQL\MySQL Server X.X\Data\hostname.err` |
| **Docker** | Souvent redirig√© vers stdout/stderr |

### Configuration dans my.cnf

```ini
# /etc/mysql/mariadb.conf.d/50-server.cnf

[mysqld]
# === Error Log Configuration ===

# Emplacement du fichier error log
log_error = /var/log/mysql/error.log

# Niveau de verbosit√© (1-3)
# 1 = Errors only
# 2 = Errors + Warnings (d√©faut recommand√©)
# 3 = Errors + Warnings + Notes (tr√®s verbeux)
log_error_verbosity = 2

# Horodatage dans les messages (mariadb 10.1+)
log_timestamps = SYSTEM  # Options: UTC, SYSTEM

# Buffer de log (performance)
# log_error_services = 'log_filter_internal; log_sink_internal'

[mysqld_safe]
# Configuration error log pour mysqld_safe (wrapper)
log_error = /var/log/mysql/error.log
syslog  # Optionnel : envoyer aussi vers syslog
```

### V√©rifier la configuration active

```sql
-- Emplacement actuel de l'error log
SHOW VARIABLES LIKE 'log_error';

-- Niveau de verbosit√©
SHOW VARIABLES LIKE 'log_error_verbosity';

-- Format horodatage
SHOW VARIABLES LIKE 'log_timestamps';
```

R√©sultat typique :

```
+---------------------+-------------------------+
| Variable_name       | Value                   |
+---------------------+-------------------------+
| log_error           | /var/log/mysql/error.log|
| log_error_verbosity | 2                       |
| log_timestamps      | SYSTEM                  |
+---------------------+-------------------------+
```

---

## Niveaux de verbosit√©

### log_error_verbosity = 1 (Errors only)

**Usage** : Production haute performance, monitoring externalis√©

```ini
[mysqld]
log_error_verbosity = 1
```

**Contenu** : Uniquement les erreurs critiques

```
2025-12-13 10:15:32 [ERROR] InnoDB: Cannot allocate memory for the buffer pool
2025-12-13 10:15:32 [ERROR] Plugin 'InnoDB' init function returned error.
2025-12-13 10:15:32 [ERROR] Aborting
```

‚úÖ **Avantages** :
- Fichier log minimal, peu d'I/O
- Focus sur les probl√®mes r√©els
- Performance optimale

‚ùå **Inconv√©nients** :
- Manque de contexte pour diagnostics
- Perte d'informations d'avertissement importantes

### log_error_verbosity = 2 (Errors + Warnings) - RECOMMAND√â

**Usage** : Production standard, bon √©quilibre

```ini
[mysqld]
log_error_verbosity = 2  # D√©faut MariaDB 11.8
```

**Contenu** : Erreurs + avertissements

```
2025-12-13 10:15:30 [Note] Server socket created on IP: '0.0.0.0'.
2025-12-13 10:15:30 [Warning] 'user' entry 'root@localhost' ignored in --skip-name-resolve mode.
2025-12-13 10:15:31 [Note] InnoDB: Buffer pool size: 8589934592 bytes (8192 MB)
2025-12-13 10:15:32 [Warning] IP address '192.168.1.100' could not be resolved
2025-12-13 10:15:35 [ERROR] Access denied for user 'backup'@'192.168.1.50'
```

‚úÖ **Avantages** :
- Bon √©quilibre information/performance
- Avertissements permettent action pr√©ventive
- Contexte suffisant pour la plupart des diagnostics

üí° **Recommandation** : C'est le niveau recommand√© pour la production.

### log_error_verbosity = 3 (Errors + Warnings + Notes)

**Usage** : Debugging, troubleshooting, environnements de d√©veloppement

```ini
[mysqld]
log_error_verbosity = 3
```

**Contenu** : Erreurs + avertissements + notes d√©taill√©es

```
2025-12-13 10:15:30 [Note] /usr/sbin/mysqld: ready for connections.
2025-12-13 10:15:30 [Note] Version: '11.8.0-MariaDB'  socket: '/var/run/mysqld/mysqld.sock'  port: 3306
2025-12-13 10:15:31 [Note] InnoDB: 128 out of 128 rollback segments are active.
2025-12-13 10:15:31 [Note] InnoDB: Creating shared tablespace for temporary tables
2025-12-13 10:15:32 [Note] Reading of all Master_info entries succeeded
2025-12-13 10:15:32 [Note] Added new Master_info '' to hash table
2025-12-13 10:15:33 [Note] Slave SQL thread initialized, starting replication
```

‚ö†Ô∏è **Attention** : Fichier log volumineux, impact I/O non n√©gligeable.

**Usage temporaire** :

```sql
-- Activer temporairement pour debugging
SET GLOBAL log_error_verbosity = 3;

-- Investigation...

-- Revenir au niveau normal
SET GLOBAL log_error_verbosity = 2;
```

---

## Structure et format des messages

### Format standard

```
YYYY-MM-DD HH:MM:SS [LEVEL] [Component] Message details
```

Exemple d√©taill√© :

```
2025-12-13 14:32:15 [Warning] [InnoDB] Page [page id: space=0, page number=3] in the doublewrite buffer is not within space bounds: page [page id: space=4, page number=307]
‚îÇ                   ‚îÇ         ‚îÇ        ‚îÇ
‚îÇ                   ‚îÇ         ‚îÇ        ‚îî‚îÄ Message d√©taill√©
‚îÇ                   ‚îÇ         ‚îî‚îÄ Composant (InnoDB, Repl, etc.)
‚îÇ                   ‚îî‚îÄ Niveau (ERROR, Warning, Note)
‚îî‚îÄ Timestamp (format selon log_timestamps)
```

### Niveaux de gravit√©

| Niveau | Signification | Action requise | Exemple |
|--------|---------------|----------------|---------|
| **[ERROR]** | Erreur critique | Imm√©diate | Cannot start InnoDB |
| **[Warning]** | Probl√®me potentiel | Planifi√©e | Deprecated syntax |
| **[Note]** | Information | Monitoring | Server ready for connections |

### Composants fr√©quents

```
[InnoDB]        ‚Üí Moteur de stockage InnoDB
[Server]        ‚Üí Serveur MariaDB g√©n√©ral
[Repl]          ‚Üí R√©plication
[Galera]        ‚Üí Galera Cluster
[Plugin]        ‚Üí Plugins (audit, auth, etc.)
[Event]         ‚Üí Event Scheduler
```

---

## Messages critiques et leur signification

### Probl√®mes au d√©marrage

#### 1. Impossible d'allouer le buffer pool

```
[ERROR] InnoDB: Cannot allocate memory for the buffer pool
[ERROR] Plugin 'InnoDB' init function returned error.
[ERROR] Aborting
```

**Cause** : `innodb_buffer_pool_size` trop grand pour RAM disponible

**Solution** :

```bash
# V√©rifier RAM disponible
free -h

# Ajuster dans my.cnf (g√©n√©ralement 60-70% de RAM)
vim /etc/mysql/mariadb.conf.d/50-server.cnf
# innodb_buffer_pool_size = 8G  # Au lieu de 64G

systemctl restart mariadb
```

#### 2. Port d√©j√† utilis√©

```
[ERROR] Can't start server: Bind on TCP/IP port: Address already in use
[ERROR] Do you already have another mysqld server running on port: 3306 ?
[ERROR] Aborting
```

**Diagnostic** :

```bash
# V√©rifier quel processus utilise le port
sudo lsof -i :3306
# OU
sudo netstat -tlnp | grep 3306

# Si c'est un autre mysqld, le stopper
sudo systemctl stop mariadb

# Si c'est un autre processus, changer le port MariaDB
```

#### 3. Corruption du log InnoDB

```
[ERROR] InnoDB: The log sequence number in the ibdata files is higher than the log sequence number in the ib_logfiles
[ERROR] InnoDB: Database was not shut down normally!
[ERROR] InnoDB: Starting crash recovery.
```

**Action** : Laisser InnoDB effectuer le crash recovery automatiquement.

```bash
# Ne PAS supprimer les fichiers ib_logfile manuellement
# Laisser MariaDB faire le recovery

# Si le recovery √©choue de fa√ßon r√©p√©t√©e :
# 1. Backup imm√©diat si possible
# 2. Tenter force recovery (dernier recours)
```

### Probl√®mes de s√©curit√©

#### 1. Tentatives d'acc√®s refus√©es

```
[Warning] Access denied for user 'root'@'192.168.1.100' (using password: YES)
[Warning] Access denied for user 'admin'@'10.0.0.50' (using password: NO)
```

**Action** :

```sql
-- V√©rifier les tentatives r√©p√©t√©es (possible attaque)
-- Impl√©menter fail2ban ou bloquer l'IP

-- Auditer les utilisateurs
SELECT user, host, password_expired, account_locked
FROM mysql.user
WHERE user = 'root';
```

#### 2. Configuration SSL/TLS manquante

```
[Warning] Failed to set up SSL because of the following SSL library error: SSL context is not usable without certificate and private key
```

**Solution** :

```bash
# G√©n√©rer certificats ou d√©sactiver SSL si non n√©cessaire
vim /etc/mysql/mariadb.conf.d/50-server.cnf
# Commenter les lignes ssl-* si SSL non souhait√©
# OU
# Configurer correctement les certificats
```

### Probl√®mes de r√©plication

```
[ERROR] Slave SQL: Could not execute Update_rows event on table db.table;
        Can't find record in 'table', Error_code: 1032
[Warning] Slave: Can't find record in 'table' Error_code: 1032
[ERROR] Error running query, slave SQL thread aborted.
```

**Diagnostic et r√©solution** :

```sql
-- Sur le replica
SHOW SLAVE STATUS\G

-- Identifier l'erreur exacte
-- Last_SQL_Errno: 1032
-- Last_SQL_Error: Can't find record in 'table'

-- Options selon gravit√© :
-- 1. Skip l'erreur (si acceptable)
SET GLOBAL sql_slave_skip_counter = 1;
START SLAVE;

-- 2. Resynchroniser depuis backup si corruption
```

---

## Analyse et troubleshooting

### Commandes de consultation

#### Afficher les derni√®res lignes

```bash
# Les 50 derni√®res lignes
tail -50 /var/log/mysql/error.log

# Suivre en temps r√©el
tail -f /var/log/mysql/error.log

# Avec horodatage relatif
tail -f /var/log/mysql/error.log | while read line; do echo "$(date '+%T') $line"; done
```

#### Rechercher des erreurs sp√©cifiques

```bash
# Toutes les erreurs critiques
grep -i "\[error\]" /var/log/mysql/error.log

# Erreurs des derni√®res 24h
grep "$(date -d '1 day ago' '+%Y-%m-%d')" /var/log/mysql/error.log | grep -i error

# Compter les erreurs par type
grep -i "\[error\]" /var/log/mysql/error.log | awk '{print $4}' | sort | uniq -c | sort -rn

# Warnings sp√©cifiques InnoDB
grep -i "\[warning\].*innodb" /var/log/mysql/error.log
```

#### Analyser les patterns

```bash
# Script d'analyse basique
#!/bin/bash
# error-log-analysis.sh

LOG_FILE="/var/log/mysql/error.log"
REPORT_FILE="/tmp/error-log-report-$(date +%Y%m%d).txt"

echo "=== MariaDB Error Log Analysis ===" > $REPORT_FILE
echo "Generated: $(date)" >> $REPORT_FILE
echo "" >> $REPORT_FILE

# Comptage par niveau
echo "=== Errors by Level ===" >> $REPORT_FILE
grep -E "\[(ERROR|Warning|Note)\]" $LOG_FILE | \
  awk '{print $3}' | sed 's/\[//;s/\]//' | sort | uniq -c | sort -rn >> $REPORT_FILE

echo "" >> $REPORT_FILE

# Top 10 erreurs fr√©quentes
echo "=== Top 10 Most Frequent Errors ===" >> $REPORT_FILE
grep "\[ERROR\]" $LOG_FILE | \
  awk '{for(i=4;i<=NF;i++) printf "%s ", $i; print ""}' | \
  sed 's/[0-9]\+/N/g' | sort | uniq -c | sort -rn | head -10 >> $REPORT_FILE

echo "" >> $REPORT_FILE

# Erreurs par composant
echo "=== Errors by Component ===" >> $REPORT_FILE
grep "\[ERROR\]" $LOG_FILE | \
  awk '{print $4}' | sed 's/\[//;s/\]//' | sort | uniq -c | sort -rn >> $REPORT_FILE

cat $REPORT_FILE
```

### Outils d'analyse avanc√©s

#### Logwatch

```bash
# Installation
sudo apt-get install logwatch  # Debian/Ubuntu
sudo yum install logwatch       # RHEL/CentOS

# Configuration pour MariaDB
sudo vim /etc/logwatch/conf/services/mysql.conf

# Ex√©cution manuelle
sudo logwatch --service mysql --range today --detail high
```

#### pt-error-log (Percona Toolkit)

```bash
# Installation
wget percona.com/get/percona-toolkit.tar.gz
tar xzf percona-toolkit.tar.gz
cd percona-toolkit-*/
perl Makefile.PL
make install

# Analyse du error log
pt-mysql-summary /var/log/mysql/error.log

# Regroupement par pattern
pt-query-digest --type errorlog /var/log/mysql/error.log
```

---

## Performance Schema : error_log table

MariaDB 11.8 introduit `performance_schema.error_log` pour interroger l'error log via SQL.

### Activation

```ini
# my.cnf
[mysqld]
performance_schema = ON
```

### Requ√™tes sur l'error log

```sql
-- Derni√®res erreurs
SELECT logged,
       error_code,
       subsystem,
       data
FROM performance_schema.error_log
WHERE prio = 'ERROR'
ORDER BY logged DESC
LIMIT 20;

-- Erreurs des derni√®res 24h
SELECT logged,
       error_code,
       subsystem,
       LEFT(data, 100) AS message_preview
FROM performance_schema.error_log
WHERE logged >= DATE_SUB(NOW(), INTERVAL 24 HOUR)
  AND prio = 'ERROR'
ORDER BY logged DESC;

-- Comptage par type d'erreur
SELECT subsystem,
       error_code,
       COUNT(*) AS occurrences,
       MIN(logged) AS first_seen,
       MAX(logged) AS last_seen
FROM performance_schema.error_log
WHERE prio = 'ERROR'
  AND logged >= DATE_SUB(NOW(), INTERVAL 7 DAY)
GROUP BY subsystem, error_code
ORDER BY occurrences DESC;

-- Warnings InnoDB
SELECT logged, data
FROM performance_schema.error_log
WHERE subsystem = 'InnoDB'
  AND prio = 'Warning'
ORDER BY logged DESC
LIMIT 10;
```

### Surveillance automatis√©e

```sql
-- Cr√©er une vue pour monitoring
CREATE OR REPLACE VIEW v_critical_errors AS
SELECT logged,
       error_code,
       subsystem,
       data
FROM performance_schema.error_log
WHERE prio = 'ERROR'
  AND logged >= DATE_SUB(NOW(), INTERVAL 1 HOUR)
ORDER BY logged DESC;

-- Utilisation dans monitoring
SELECT COUNT(*) AS critical_errors_last_hour
FROM v_critical_errors;
```

---

## Rotation et archivage

### Rotation manuelle

```bash
#!/bin/bash
# rotate-error-log.sh

LOG_FILE="/var/log/mysql/error.log"
ARCHIVE_DIR="/var/log/mysql/archive"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

# Cr√©er r√©pertoire d'archive
mkdir -p $ARCHIVE_DIR

# Renommer le fichier actuel
mv $LOG_FILE $ARCHIVE_DIR/error.log.$TIMESTAMP

# Signaler √† MariaDB de cr√©er un nouveau fichier
mysqladmin flush-logs

# Compresser l'ancien fichier
gzip $ARCHIVE_DIR/error.log.$TIMESTAMP

# Supprimer les archives > 90 jours
find $ARCHIVE_DIR -name "error.log.*.gz" -mtime +90 -delete

echo "Error log rotated successfully"
```

### Rotation avec logrotate (Recommand√©)

```bash
# /etc/logrotate.d/mysql-server
/var/log/mysql/error.log {
    daily                    # Rotation quotidienne
    rotate 30                # Garder 30 jours
    missingok                # OK si fichier absent
    notifempty               # Ne pas rotater si vide
    compress                 # Compresser les archives
    delaycompress            # Compresser J-1 (pas imm√©diatement)
    sharedscripts            # Ex√©cuter postrotate une seule fois
    postrotate
        # Flush logs pour cr√©er nouveau fichier
        if [ -x /usr/bin/mysqladmin ]; then
            /usr/bin/mysqladmin --defaults-file=/etc/mysql/debian.cnf \
                                flush-logs > /dev/null 2>&1 || true
        fi
    endscript
}
```

Test manuel :

```bash
# Tester la configuration
sudo logrotate -d /etc/logrotate.d/mysql-server

# Forcer rotation imm√©diate
sudo logrotate -f /etc/logrotate.d/mysql-server

# V√©rifier
ls -lh /var/log/mysql/
```

### Rotation via systemd timer

```ini
# /etc/systemd/system/mysql-log-rotate.service
[Unit]
Description=Rotate MariaDB error log
After=mariadb.service

[Service]
Type=oneshot
ExecStart=/usr/local/bin/rotate-error-log.sh
User=root
```

```ini
# /etc/systemd/system/mysql-log-rotate.timer
[Unit]
Description=Daily MariaDB error log rotation

[Timer]
OnCalendar=daily
Persistent=true

[Install]
WantedBy=timers.target
```

```bash
# Activer
sudo systemctl daemon-reload
sudo systemctl enable mysql-log-rotate.timer
sudo systemctl start mysql-log-rotate.timer

# V√©rifier
sudo systemctl list-timers mysql-log-rotate.timer
```

---

## Int√©gration avec syslog

### Configuration pour envoyer vers syslog

```ini
# /etc/mysql/mariadb.conf.d/50-server.cnf

[mysqld_safe]
syslog
# OU sp√©cifier une facility
syslog-tag=mysqld
```

Red√©marrer :

```bash
sudo systemctl restart mariadb
```

### Configuration rsyslog

```bash
# /etc/rsyslog.d/mysql.conf

# Capturer les logs MariaDB
:programname, isequal, "mysqld" /var/log/mysql/error-syslog.log

# Envoyer les erreurs critiques √† un serveur distant
:programname, isequal, "mysqld" @@log-server.example.com:514
& stop  # Ne pas logger localement en double
```

Red√©marrer rsyslog :

```bash
sudo systemctl restart rsyslog
```

### Avantages syslog

- ‚úÖ Centralisation des logs (multi-serveurs)
- ‚úÖ Corr√©lation avec logs syst√®me
- ‚úÖ Parsing et alerting centralis√©s
- ‚úÖ Backup automatique hors serveur base

---

## Monitoring et alerting

### Script de surveillance basique

```bash
#!/bin/bash
# monitor-error-log.sh

LOG_FILE="/var/log/mysql/error.log"
STATE_FILE="/var/tmp/error-log-monitor.state"
ALERT_EMAIL="dba@example.com"

# Cr√©er state file si inexistant
touch $STATE_FILE

# Obtenir derni√®re position
LAST_POS=$(cat $STATE_FILE 2>/dev/null || echo 0)

# Nouvelles erreurs depuis derni√®re v√©rification
NEW_ERRORS=$(tail -c +$LAST_POS $LOG_FILE | grep -i "\[ERROR\]")

if [ -n "$NEW_ERRORS" ]; then
    # Compter erreurs
    ERROR_COUNT=$(echo "$NEW_ERRORS" | wc -l)

    # Envoyer alerte
    echo "MariaDB Critical Errors Detected" | \
    mail -s "[ALERT] $ERROR_COUNT new MariaDB errors on $(hostname)" \
         -a "Content-Type: text/plain; charset=utf-8" \
         $ALERT_EMAIL <<EOF
Hostname: $(hostname)
Time: $(date)
New errors: $ERROR_COUNT

Recent errors:
$NEW_ERRORS

Full log: $LOG_FILE
EOF
fi

# Sauvegarder nouvelle position
stat -c%s $LOG_FILE > $STATE_FILE
```

Cron job :

```bash
# V√©rifier toutes les 5 minutes
*/5 * * * * /usr/local/bin/monitor-error-log.sh
```

### Int√©gration Prometheus/Grafana

```bash
# Exporter pour mysqld_exporter
# Les erreurs sont expos√©es via performance_schema

# Installation mysqld_exporter
wget https://github.com/prometheus/mysqld_exporter/releases/download/v0.15.0/mysqld_exporter-0.15.0.linux-amd64.tar.gz
tar xzf mysqld_exporter-*.tar.gz
sudo mv mysqld_exporter /usr/local/bin/

# Configuration
sudo vim /etc/systemd/system/mysqld_exporter.service
```

```ini
[Unit]
Description=MySQL Exporter
After=mariadb.service

[Service]
Type=simple
ExecStart=/usr/local/bin/mysqld_exporter \
  --config.my-cnf=/etc/mysql/mysqld_exporter.cnf \
  --collect.perf_schema.eventsstatements \
  --collect.perf_schema.file_events \
  --collect.info_schema.processlist

[Install]
WantedBy=multi-user.target
```

### Requ√™te Prometheus

```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'mariadb'
    static_configs:
      - targets: ['localhost:9104']
```

Requ√™te PromQL :

```promql
# Taux d'erreurs par minute
rate(mysql_global_status_errors[5m])

# Alertes sur seuil
mysql_global_status_errors > 10
```

### R√®gle d'alerte Prometheus

```yaml
# alerts.yml
groups:
  - name: mariadb_errors
    interval: 60s
    rules:
      - alert: MariaDBHighErrorRate
        expr: rate(mysql_global_status_errors[5m]) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High error rate on {{ $labels.instance }}"
          description: "Error rate is {{ $value }} errors/sec"

      - alert: MariaDBCriticalError
        expr: increase(mysql_global_status_aborted_connects[5m]) > 10
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Critical errors detected on {{ $labels.instance }}"
```

---

## Bonnes pratiques

### 1. Toujours configurer un emplacement explicite

```ini
# ‚ùå Mauvais : Laisser le d√©faut (varie selon distribution)
[mysqld]
# log_error = (non d√©fini)

# ‚úÖ Bon : Sp√©cifier explicitement
[mysqld]
log_error = /var/log/mysql/error.log
```

### 2. Utiliser le bon niveau de verbosit√©

```ini
# Production
log_error_verbosity = 2  # Errors + Warnings

# D√©veloppement/Staging
log_error_verbosity = 3  # Tr√®s verbeux

# Production haute performance avec monitoring externe
log_error_verbosity = 1  # Errors only
```

### 3. Impl√©menter rotation automatique

```bash
# logrotate pour √©viter fichiers gigantesques
# Configuration dans /etc/logrotate.d/mysql-server
```

### 4. Surveiller proactivement

```bash
# Monitoring automatis√©
# Alerting sur patterns d'erreur
# Dashboard Grafana
```

### 5. Permissions appropri√©es

```bash
# Error log accessible uniquement par mysql et root
sudo chown mysql:mysql /var/log/mysql/error.log
sudo chmod 640 /var/log/mysql/error.log

# R√©pertoire
sudo chown mysql:adm /var/log/mysql
sudo chmod 750 /var/log/mysql
```

### 6. Backup r√©gulier des logs

```bash
#!/bin/bash
# backup-logs.sh

BACKUP_DIR="/backup/mysql-logs"
DATE=$(date +%Y%m)

mkdir -p $BACKUP_DIR/$DATE
cp /var/log/mysql/error.log* $BACKUP_DIR/$DATE/

# Upload vers stockage distant (S3, etc.)
# aws s3 sync $BACKUP_DIR s3://mybucket/mysql-logs/
```

### 7. Documentation des erreurs r√©currentes

```bash
# Cr√©er knowledge base
cat > /var/log/mysql/ERROR-RUNBOOK.md <<'EOF'
# MariaDB Error Runbook

## [ERROR] Cannot allocate memory for buffer pool
**Cause**: innodb_buffer_pool_size trop √©lev√©
**Solution**: R√©duire dans my.cnf, red√©marrer
**Pr√©vention**: Dimensionner √† 60-70% RAM

## [Warning] IP address could not be resolved
**Cause**: DNS lent ou skip-name-resolve pas activ√©
**Solution**: Activer skip-name-resolve
**Impact**: Minime, mais ralentit connexions
EOF
```

---

## Troubleshooting avanc√©

### Probl√®me : Fichier error.log absent

```bash
# V√©rifier configuration
mysql -e "SHOW VARIABLES LIKE 'log_error';"

# Si vide ou incorrect, sp√©cifier dans my.cnf
sudo vim /etc/mysql/mariadb.conf.d/50-server.cnf
# [mysqld]
# log_error = /var/log/mysql/error.log

# Cr√©er r√©pertoire si n√©cessaire
sudo mkdir -p /var/log/mysql
sudo chown mysql:mysql /var/log/mysql

# Red√©marrer
sudo systemctl restart mariadb
```

### Probl√®me : Fichier error.log gigantesque

```bash
# V√©rifier taille
du -h /var/log/mysql/error.log
# 15G  /var/log/mysql/error.log  ‚ö†Ô∏è

# Identifier le probl√®me
grep -i "\[error\]" /var/log/mysql/error.log | tail -100

# Si verbosit√© trop haute
mysql -e "SET GLOBAL log_error_verbosity = 2;"

# Rotation imm√©diate
sudo logrotate -f /etc/logrotate.d/mysql-server

# Si log flood (erreur r√©p√©t√©e)
# 1. Identifier et corriger la cause racine
# 2. Temporairement, tronquer le log (avec pr√©caution)
sudo systemctl stop mariadb
sudo mv /var/log/mysql/error.log /var/log/mysql/error.log.old
sudo systemctl start mariadb
```

### Probl√®me : Permissions incorrectes

```bash
# Sympt√¥me
tail /var/log/mysql/error.log
# tail: cannot open '/var/log/mysql/error.log' for reading: Permission denied

# Solution
sudo chown mysql:mysql /var/log/mysql/error.log
sudo chmod 640 /var/log/mysql/error.log

# V√©rifier
ls -l /var/log/mysql/error.log
# -rw-r----- 1 mysql mysql 12345 Dec 13 15:30 /var/log/mysql/error.log
```

---

## Checklist op√©rationnelle

### Au d√©marrage du serveur

- [ ] V√©rifier que l'error log est cr√©√© et accessible
- [ ] Consulter les 50 premi√®res lignes pour erreurs de d√©marrage
- [ ] V√©rifier la charge de la configuration (`[Note] ... ready for connections`)
- [ ] S'assurer qu'aucune erreur InnoDB n'est pr√©sente

### Quotidiennement

- [ ] V√©rifier les nouvelles erreurs critiques
- [ ] Surveiller la taille du fichier error.log
- [ ] V√©rifier les warnings r√©p√©t√©s
- [ ] S'assurer que la rotation fonctionne

### Hebdomadairement

- [ ] Analyser les patterns d'erreur
- [ ] V√©rifier l'espace disque logs
- [ ] Revoir les archives compress√©es
- [ ] Mettre √† jour la documentation (runbook)

### Mensuellement

- [ ] Audit complet des erreurs du mois
- [ ] V√©rifier backup des logs
- [ ] Nettoyer archives anciennes (> 90 jours)
- [ ] Revoir les r√®gles d'alerting

---

## Scripts utiles

### 1. R√©sum√© quotidien error log

```bash
#!/bin/bash
# daily-error-summary.sh

LOG="/var/log/mysql/error.log"
TODAY=$(date +%Y-%m-%d)

echo "=== MariaDB Error Log Summary - $TODAY ==="
echo ""

# Erreurs critiques
echo "Critical Errors:"
grep "$TODAY.*\[ERROR\]" $LOG | wc -l

# Warnings
echo "Warnings:"
grep "$TODAY.*\[Warning\]" $LOG | wc -l

# Top 5 erreurs
echo ""
echo "Top 5 Error Patterns:"
grep "$TODAY.*\[ERROR\]" $LOG | \
  sed 's/[0-9]\+/N/g' | sort | uniq -c | sort -rn | head -5

# InnoDB sp√©cifique
echo ""
echo "InnoDB Errors:"
grep "$TODAY.*InnoDB.*\[ERROR\]" $LOG | wc -l
```

### 2. Alerting sur pattern sp√©cifique

```bash
#!/bin/bash
# alert-on-pattern.sh

LOG="/var/log/mysql/error.log"
PATTERN="$1"  # Ex: "Out of memory"
EMAIL="dba@example.com"

# V√©rifier pattern depuis derni√®re heure
MATCHES=$(grep "$(date -d '1 hour ago' '+%Y-%m-%d %H').*$PATTERN" $LOG)

if [ -n "$MATCHES" ]; then
    echo "Pattern '$PATTERN' detected in error log" | \
    mail -s "[ALERT] MariaDB Error Pattern Detected" $EMAIL <<EOF
Pattern: $PATTERN
Occurrences in last hour: $(echo "$MATCHES" | wc -l)

Details:
$MATCHES
EOF
fi
```

---

## ‚úÖ Points cl√©s √† retenir

- **Error log = Premier diagnostic** : Toujours consulter en cas de probl√®me
- **Verbosit√©** : Niveau 2 (Errors + Warnings) recommand√© pour production
- **Emplacement explicite** : Toujours d√©finir `log_error` dans my.cnf
- **Rotation obligatoire** : Utiliser logrotate pour √©viter fichiers gigantesques
- **Permissions** : 640 (mysql:mysql) pour s√©curit√©
- **Monitoring** : Automatiser surveillance et alerting (Prometheus, scripts)
- **Performance Schema** : Utiliser `performance_schema.error_log` pour requ√™tes SQL
- **Syslog** : Envisager pour centralisation multi-serveurs
- **Backup** : Archiver logs pour audit et conformit√©
- **Documentation** : Maintenir runbook des erreurs courantes

---

## üîó Ressources et r√©f√©rences

- [üìñ Documentation officielle : Error Log](https://mariadb.com/kb/en/error-log/)
- [üìñ Documentation officielle : log_error_verbosity](https://mariadb.com/kb/en/server-system-variables/#log_error_verbosity)
- [üìñ Performance Schema error_log table](https://mariadb.com/kb/en/performance-schema-error_log-table/)
- [üìñ Logrotate](https://linux.die.net/man/8/logrotate)
- [Blog : MariaDB Error Log Best Practices](https://mariadb.org/error-log-management/)

---

## ‚û°Ô∏è Section suivante

**11.4.2 - Slow query log** : Configuration et analyse du slow query log pour identifier et optimiser les requ√™tes lentes, utilisation de pt-query-digest, et strat√©gies de performance tuning.

‚è≠Ô∏è [Slow query log](/11-administration-configuration/04.2-slow-query-log.md)
