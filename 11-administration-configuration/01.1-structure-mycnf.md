ğŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 11.1.1 my.cnf / my.ini : Structure et sections

> **Niveau** : AvancÃ© (DBA/Administrateur SystÃ¨me)  
> **DurÃ©e estimÃ©e** : 1.5 heures  
> **PrÃ©requis** : Connaissance de base de MariaDB, notions d'administration systÃ¨me Linux/Windows

## ğŸ¯ Objectifs d'apprentissage

Ã€ l'issue de cette section, vous serez capable de :
- Comprendre la structure complÃ¨te des fichiers de configuration MariaDB
- Identifier et utiliser correctement les diffÃ©rentes sections du fichier
- MaÃ®triser la syntaxe et les conventions de configuration
- Organiser efficacement vos paramÃ¨tres de configuration
- Appliquer les bonnes pratiques de structuration pour un environnement de production

---

## Introduction

Le fichier de configuration MariaDB est le cÅ“ur du paramÃ©trage du serveur. Sa structure bien dÃ©finie permet de configurer non seulement le serveur lui-mÃªme (`mysqld`), mais aussi les diffÃ©rents outils clients (`mysql`, `mysqldump`, `mariabackup`, etc.). Une comprÃ©hension approfondie de ce fichier est **essentielle** pour tout administrateur de bases de donnÃ©es.

### Nomenclature selon le systÃ¨me d'exploitation

| SystÃ¨me | Fichier principal | Emplacement par dÃ©faut |
|---------|-------------------|------------------------|
| **Linux/Unix** | `my.cnf` | `/etc/mysql/my.cnf` ou `/etc/my.cnf` |
| **Windows** | `my.ini` | `C:\ProgramData\MySQL\MySQL Server X.X\my.ini` |
| **macOS** | `my.cnf` | `/usr/local/etc/my.cnf` (Homebrew) |

ğŸ’¡ **Conseil** : Sur Linux, MariaDB recherche les fichiers de configuration dans un ordre spÃ©cifique. Utilisez `mysqld --help --verbose | grep -A 1 "Default options"` pour voir l'ordre de lecture sur votre systÃ¨me.

---

## Structure gÃ©nÃ©rale du fichier

### Format INI standard

Le fichier de configuration MariaDB suit le format INI classique :

```ini
# Commentaire sur une ligne
; Commentaire alternatif (moins courant)

[section]
option = valeur
option2 = "valeur avec espaces"
option3  # Option boolÃ©enne (Ã©quivaut Ã  option3 = 1)
```

### RÃ¨gles syntaxiques fondamentales

1. **Sections** : DÃ©limitÃ©es par `[nom_section]`
2. **Options** : Forme `clÃ© = valeur` ou simplement `clÃ©` pour les boolÃ©ens
3. **Commentaires** : PrÃ©cÃ©dÃ©s de `#` ou `;`
4. **Espaces** : IgnorÃ©s autour du signe `=`
5. **Casse** : GÃ©nÃ©ralement insensible, mais convention en minuscules
6. **ContinuitÃ©** : Impossible de continuer sur plusieurs lignes (une option = une ligne)

âš ï¸ **Attention** : Les espaces dans les valeurs nÃ©cessitent des guillemets doubles :
```ini
# Correct
datadir = "/var/lib/mysql/data with spaces"

# Incorrect (sera tronquÃ© Ã  /var/lib/mysql/data)
datadir = /var/lib/mysql/data with spaces
```

---

## Les sections principales

### 1. [mysqld] - Configuration du serveur

**La section la plus importante**. Elle contient tous les paramÃ¨tres du serveur MariaDB lui-mÃªme.

```ini
[mysqld]
# ParamÃ¨tres systÃ¨me
user = mysql
port = 3306
socket = /var/run/mysqld/mysqld.sock
datadir = /var/lib/mysql

# Performance et mÃ©moire
innodb_buffer_pool_size = 8G
innodb_log_file_size = 2G
max_connections = 500
table_open_cache = 4000

# CaractÃ¨res et collations (nouveautÃ© 11.8)
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

# Binary logging
log_bin = mysql-bin
binlog_format = ROW
expire_logs_days = 7

# SÃ©curitÃ©
skip-name-resolve
local_infile = 0
```

ğŸ’¡ **NouveautÃ© MariaDB 11.8** : `utf8mb4` est maintenant le charset par dÃ©faut avec la collation UCA 14.0.0, offrant un meilleur support Unicode.

### 2. [client] - Configuration globale des clients

S'applique Ã  **tous** les programmes clients MariaDB (`mysql`, `mysqldump`, `mysqlcheck`, etc.).

```ini
[client]
port = 3306
socket = /var/run/mysqld/mysqld.sock
default-character-set = utf8mb4

# ParamÃ¨tres SSL/TLS pour tous les clients
ssl-ca = /etc/mysql/ssl/ca-cert.pem
ssl-cert = /etc/mysql/ssl/client-cert.pem
ssl-key = /etc/mysql/ssl/client-key.pem
```

ğŸ†• **TLS par dÃ©faut depuis 11.8** : MariaDB encourage fortement l'utilisation de TLS. Configurer SSL dans `[client]` garantit que tous les outils utilisent des connexions chiffrÃ©es.

### 3. [mysql] - Client en ligne de commande

Configuration spÃ©cifique au client `mysql` (interface CLI).

```ini
[mysql]
# Interface utilisateur
prompt = "\\u@\\h [\\d]>\\_"
no-auto-rehash
pager = less -n -i -S

# SÃ©curitÃ© : dÃ©sactiver les commandes system dangereuses
# safe-updates

# Historique
max_allowed_packet = 1G
```

ğŸ’¡ **Astuce** : Le prompt personnalisÃ© affiche `utilisateur@hÃ´te [base]> ` pour faciliter l'identification du contexte.

### 4. [mysqldump] / [mariadb-dump] - Sauvegarde logique

```ini
[mysqldump]
quick
quote-names
max_allowed_packet = 1G
single-transaction
routines
triggers
events

# CompatibilitÃ© et sÃ©curitÃ©
set-gtid-purged = OFF  # Pour Ã©viter les conflits GTID
column-statistics = 0   # DÃ©sactiver les stats (peut poser pb)
```

âš ï¸ **Important** : `single-transaction` est **crucial** pour des sauvegardes cohÃ©rentes sur InnoDB sans verrouiller les tables.

### 5. [mysqld_safe] - Wrapper de dÃ©marrage

UtilisÃ© principalement sur Linux pour dÃ©marrer `mysqld` de maniÃ¨re sÃ©curisÃ©e.

```ini
[mysqld_safe]
log-error = /var/log/mysql/error.log
pid-file = /var/run/mysqld/mysqld.pid

# Limites systÃ¨me
open-files-limit = 65535
nice = 0

# RedÃ©marrage automatique en cas de crash
# (comportement par dÃ©faut, mais peut Ãªtre explicitÃ©)
```

### 6. [mariabackup] - Sauvegarde physique

ğŸ†• **Support BACKUP STAGE dans 11.8** amÃ©liore la cohÃ©rence des sauvegardes.

```ini
[mariabackup]
# Optimisations parallÃ¨les
parallel = 4
compress
compress-threads = 4

# Limites rÃ©seau
throttle = 100  # MB/s

# Emplacement temporaire
tmpdir = /var/tmp/mariabackup
```

### 7. [galera] - Configuration Galera Cluster

Pour les environnements haute disponibilitÃ© avec rÃ©plication synchrone.

```ini
[galera]
wsrep_on = ON
wsrep_provider = /usr/lib/galera/libgalera_smm.so
wsrep_cluster_address = "gcomm://node1,node2,node3"
wsrep_cluster_name = "production_cluster"
wsrep_node_address = "192.168.1.10"
wsrep_node_name = "node1"
wsrep_sst_method = mariabackup

# Performance
wsrep_slave_threads = 4
innodb_autoinc_lock_mode = 2
```

### 8. Sections moins courantes mais utiles

```ini
[mysqlcheck]
# Maintenance automatisÃ©e
auto-repair
optimize

[mysqladmin]
# Administration rapide
connect_timeout = 5

[mysqlimport]
# Import de donnÃ©es
local
lock-tables = FALSE
```

---

## Organisation et structuration avancÃ©e

### Approche modulaire recommandÃ©e

Pour les environnements de production, une approche **modulaire** est fortement recommandÃ©e :

```ini
# /etc/mysql/my.cnf (fichier principal)
[mysqld]
# Chargement de configurations modulaires
!includedir /etc/mysql/conf.d/
!includedir /etc/mysql/mariadb.conf.d/
```

Structure de rÃ©pertoires suggÃ©rÃ©e :

```
/etc/mysql/
â”œâ”€â”€ my.cnf                          # Fichier principal minimal
â”œâ”€â”€ conf.d/                         # Configurations partagÃ©es MySQL/MariaDB
â”‚   â”œâ”€â”€ 00-common.cnf              # ParamÃ¨tres communs
â”‚   â””â”€â”€ 99-custom.cnf              # Personnalisations
â””â”€â”€ mariadb.conf.d/                # Configurations spÃ©cifiques MariaDB
    â”œâ”€â”€ 10-server.cnf              # Configuration serveur
    â”œâ”€â”€ 20-innodb.cnf              # ParamÃ¨tres InnoDB
    â”œâ”€â”€ 30-replication.cnf         # RÃ©plication
    â”œâ”€â”€ 40-performance.cnf         # Tuning performance
    â”œâ”€â”€ 50-security.cnf            # SÃ©curitÃ©
    â””â”€â”€ 60-monitoring.cnf          # Monitoring
```

### Exemple de fichier modulaire : 20-innodb.cnf

```ini
#
# Configuration InnoDB - MariaDB 11.8 LTS
# Production OLTP optimisÃ© pour 64GB RAM
#

[mysqld]
# === Moteur InnoDB ===

# Buffer Pool (60-70% de la RAM pour serveur dÃ©diÃ©)
innodb_buffer_pool_size = 40G
innodb_buffer_pool_instances = 8

# Logs de transaction
innodb_log_file_size = 2G
innodb_log_buffer_size = 256M
innodb_flush_log_at_trx_commit = 1  # SÃ©curitÃ© ACID maximale

# I/O et threading
innodb_io_capacity = 2000          # Pour SSD
innodb_io_capacity_max = 4000
innodb_read_io_threads = 8
innodb_write_io_threads = 8

# Flush et checkpointing
innodb_flush_method = O_DIRECT     # Ã‰vite double buffering
innodb_adaptive_flushing = ON
innodb_max_dirty_pages_pct = 75

# ğŸ†• NouveautÃ© 11.8 : Construction d'index efficace
innodb_alter_copy_bulk = ON

# File per table (standard moderne)
innodb_file_per_table = ON

# Purge et undo logs
innodb_purge_threads = 4
innodb_undo_log_truncate = ON
innodb_max_undo_log_size = 1G
```

ğŸ’¡ **Bonnes pratiques** :
- **Nommage numÃ©rotÃ©** : Permet de contrÃ´ler l'ordre de chargement (10-, 20-, 30-...)
- **Un thÃ¨me par fichier** : Facilite la maintenance et le versioning
- **Commentaires explicites** : Documenter le "pourquoi" des choix

---

## Conventions et bonnes pratiques

### 1. Nommage des options

MariaDB accepte plusieurs formes pour la mÃªme option :

```ini
# Toutes ces formes sont Ã©quivalentes :
innodb-buffer-pool-size = 8G
innodb_buffer_pool_size = 8G
InnodbBufferPoolSize = 8G

# Convention recommandÃ©e : snake_case avec underscores
innodb_buffer_pool_size = 8G
```

### 2. UnitÃ©s de mesure

```ini
# MÃ©moire
innodb_buffer_pool_size = 8G        # G = Gigabytes
key_buffer_size = 512M              # M = Megabytes
read_buffer_size = 2097152          # Octets (2MB)

# Temps
connect_timeout = 10                # Secondes
wait_timeout = 28800                # Secondes (8 heures)
lock_wait_timeout = 50              # Secondes

# Pourcentages
innodb_max_dirty_pages_pct = 75     # 75%
```

### 3. Options boolÃ©ennes

```ini
# Trois formes Ã©quivalentes pour activer :
skip-name-resolve
skip-name-resolve = 1
skip-name-resolve = ON

# Trois formes Ã©quivalentes pour dÃ©sactiver :
# skip-name-resolve = 0
# skip-name-resolve = OFF
# (ou simplement commenter/supprimer la ligne)
```

### 4. Chemins et fichiers

```ini
# Utiliser des chemins absolus pour Ã©viter toute ambiguÃ¯tÃ©
datadir = /var/lib/mysql
log_error = /var/log/mysql/error.log
socket = /var/run/mysqld/mysqld.sock

# Sous Windows, utiliser des slashes ou des backslashes doublÃ©s
datadir = C:/ProgramData/MySQL/Data
# OU
datadir = C:\\ProgramData\\MySQL\\Data
```

---

## ParamÃ¨tres essentiels par catÃ©gorie

### Configuration minimale viable (production)

```ini
[mysqld]
# === IdentitÃ© et rÃ©seau ===
port = 3306
bind-address = 0.0.0.0              # Ou IP spÃ©cifique pour sÃ©curitÃ©
socket = /var/run/mysqld/mysqld.sock

# === DonnÃ©es ===
datadir = /var/lib/mysql
tmpdir = /tmp

# === CaractÃ¨res (11.8 defaults) ===
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

# === SÃ©curitÃ© ===
skip-name-resolve                   # Ã‰vite les rÃ©solutions DNS
local_infile = 0                    # DÃ©sactive LOAD DATA LOCAL
require_secure_transport = ON       # ğŸ†• Force TLS (11.8)

# === Performance de base ===
max_connections = 500
table_open_cache = 4000
innodb_buffer_pool_size = 8G

# === Logging ===
log_error = /var/log/mysql/error.log
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2

# === Binary logs (rÃ©plication/backup) ===
log_bin = /var/log/mysql/mysql-bin
binlog_format = ROW
expire_logs_days = 7
sync_binlog = 1

# === TIMESTAMP 2106 ===
# ğŸ†• Extension automatique dans 11.8 (rÃ©sout Y2038)
# Aucune configuration spÃ©ciale nÃ©cessaire
```

---

## Validation et dÃ©bogage de la configuration

### VÃ©rifier la syntaxe sans dÃ©marrer le serveur

```bash
# Valider la configuration
mysqld --verbose --help | head -n 20

# Voir les options par dÃ©faut
mysqld --no-defaults --verbose --help | grep -A 2 "^Variables"

# Tester avec un fichier spÃ©cifique
mysqld --defaults-file=/etc/mysql/my.cnf --verbose --help
```

### Identifier quelle valeur est utilisÃ©e

```sql
-- Une fois le serveur dÃ©marrÃ©
SHOW VARIABLES LIKE 'innodb_buffer_pool_size';
SHOW VARIABLES WHERE Variable_name REGEXP 'charset|collation';
```

### Voir les fichiers de configuration lus au dÃ©marrage

```bash
# Voir l'ordre de lecture
mysql --help | grep -A 1 "Default options"
# RÃ©sultat typique :
# /etc/my.cnf /etc/mysql/my.cnf ~/.my.cnf
```

ğŸ’¡ **Astuce dÃ©bogage** : Si une valeur ne semble pas prise en compte :
1. VÃ©rifier la section (`[mysqld]` pour le serveur, `[client]` pour les clients)
2. VÃ©rifier la syntaxe (espaces, guillemets)
3. VÃ©rifier l'ordre de chargement (fichiers `!include` Ã©crasent les prÃ©cÃ©dents)
4. Confirmer que la variable est dynamique ou nÃ©cessite un redÃ©marrage

---

## Gestion des variables dynamiques vs statiques

Certaines options peuvent Ãªtre modifiÃ©es sans redÃ©marrage :

```ini
# Variable DYNAMIQUE (changeable en runtime)
max_connections = 1000
# Peut Ãªtre modifiÃ© avec : SET GLOBAL max_connections = 1500;

# Variable STATIQUE (nÃ©cessite redÃ©marrage)
innodb_buffer_pool_size = 16G
# Impossible Ã  changer sans redÃ©marrer mysqld
```

Pour connaÃ®tre le type d'une variable :

```sql
SELECT VARIABLE_NAME, VARIABLE_SCOPE
FROM INFORMATION_SCHEMA.SYSTEM_VARIABLES
WHERE VARIABLE_NAME = 'max_connections';
```

âš ï¸ **Important** : Les modifications dynamiques avec `SET GLOBAL` sont **perdues au redÃ©marrage**. Toujours mettre Ã  jour le fichier `my.cnf` pour persister les changements.

---

## SÃ©curisation du fichier de configuration

### Permissions recommandÃ©es

```bash
# Linux : propriÃ©taire mysql, lecture seule
chown mysql:mysql /etc/mysql/my.cnf
chmod 640 /etc/mysql/my.cnf

# VÃ©rification
ls -la /etc/mysql/my.cnf
# Devrait afficher : -rw-r----- 1 mysql mysql
```

### Gestion des mots de passe

âŒ **Ã€ Ã‰VITER** : Stocker des mots de passe en clair dans `my.cnf`

```ini
# DANGEREUX - NE PAS FAIRE
[client]
user = backup_user
password = MonMotDePasse123
```

âœ… **RecommandÃ©** : Utiliser `.my.cnf` personnel avec permissions strictes

```bash
# Dans le home de l'utilisateur : ~/.my.cnf
chmod 600 ~/.my.cnf
```

```ini
# ~/.my.cnf
[client]
user = backup_user
password = MonMotDePasse123
```

Ou mieux encore : utiliser `mysql_config_editor` (stockage chiffrÃ©)

```bash
mysql_config_editor set --login-path=backup \
  --host=localhost --user=backup_user --password
# Demande le mot de passe de maniÃ¨re interactive
```

---

## Template complet annotÃ© pour production

```ini
#
# MariaDB 11.8 LTS - Configuration Production
# Environnement : OLTP, 64GB RAM, SSD NVMe, 16 CPU cores
# DerniÃ¨re modification : 2025-12-13
#

[client]
port = 3306
socket = /var/run/mysqld/mysqld.sock
default-character-set = utf8mb4

# TLS pour tous les clients (11.8 recommandation)
ssl-ca = /etc/mysql/ssl/ca-cert.pem
ssl-verify-server-cert

[mysqld]
#
# === IDENTITÃ‰ ET RÃ‰SEAU ===
#
user = mysql
port = 3306
bind-address = 0.0.0.0
socket = /var/run/mysqld/mysqld.sock
pid-file = /var/run/mysqld/mysqld.pid

#
# === CHEMINS DE DONNÃ‰ES ===
#
datadir = /var/lib/mysql
tmpdir = /var/tmp/mysql
secure_file_priv = /var/lib/mysql-files/

#
# === CHARSET ET COLLATIONS (11.8 defaults) ===
#
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci
# UCA 14.0.0 est utilisÃ© par dÃ©faut dans 11.8

#
# === SÃ‰CURITÃ‰ ===
#
skip-name-resolve
local_infile = 0
symbolic-links = 0
require_secure_transport = ON  # Force TLS

#
# === CONNEXIONS ===
#
max_connections = 500
max_connect_errors = 1000000
connect_timeout = 10
wait_timeout = 28800
interactive_timeout = 28800

#
# === CACHE ET BUFFERS ===
#
table_open_cache = 4000
table_definition_cache = 2000
open_files_limit = 65535

#
# === INNODB - BUFFER POOL ===
#
innodb_buffer_pool_size = 40G           # 60-70% RAM
innodb_buffer_pool_instances = 8
innodb_buffer_pool_chunk_size = 128M

#
# === INNODB - LOGS ===
#
innodb_log_file_size = 2G
innodb_log_buffer_size = 256M
innodb_flush_log_at_trx_commit = 1      # ACID strict
innodb_log_group_home_dir = /var/lib/mysql

#
# === INNODB - I/O ===
#
innodb_io_capacity = 2000               # SSD NVMe
innodb_io_capacity_max = 4000
innodb_flush_method = O_DIRECT
innodb_read_io_threads = 8
innodb_write_io_threads = 8
innodb_alter_copy_bulk = ON             # ğŸ†• 11.8

#
# === INNODB - AUTRES ===
#
innodb_file_per_table = ON
innodb_autoinc_lock_mode = 2
innodb_adaptive_hash_index = ON
innodb_purge_threads = 4
innodb_thread_concurrency = 0           # Auto

#
# === THREAD POOL (Performance Enterprise) ===
#
thread_handling = pool-of-threads
thread_pool_size = 16                   # = nombre de CPU cores
thread_pool_max_threads = 2000
thread_pool_stall_limit = 500

#
# === QUERY CACHE (DÃ‰SACTIVÃ‰ - deprecated) ===
#
query_cache_type = 0
query_cache_size = 0

#
# === LOGGING - ERROR ===
#
log_error = /var/log/mysql/error.log
log_warnings = 2

#
# === LOGGING - SLOW QUERY ===
#
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2
log_queries_not_using_indexes = 0

#
# === BINARY LOGS ===
#
server-id = 1
log_bin = /var/log/mysql/mysql-bin
binlog_format = ROW
binlog_row_image = MINIMAL
sync_binlog = 1
expire_logs_days = 7
max_binlog_size = 1G

#
# === RÃ‰PLICATION (si applicable) ===
#
# gtid_domain_id = 1
# gtid_strict_mode = ON
# read_only = OFF

#
# === MODES SQL ===
#
sql_mode = STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION

#
# === CONTRÃ”LE ESPACE TEMPORAIRE (11.8) ===
#
# ğŸ†• Nouvelles options pour limiter l'usage disque temporaire
max_tmp_space_usage = 10G
max_total_tmp_space_usage = 50G

#
# === TIMESTAMP 2106 SUPPORT ===
#
# ğŸ†• Extension automatique dans 11.8 - Y2038 rÃ©solu
# Aucune configuration supplÃ©mentaire nÃ©cessaire

[mysqldump]
quick
quote-names
max_allowed_packet = 1G
single-transaction
routines
triggers
events

[mysql]
no-auto-rehash
show-warnings
prompt = "\\u@\\h [\\d]>\\_"

[mariabackup]
parallel = 4
compress
compress-threads = 4
```

---

## âœ… Points clÃ©s Ã  retenir

- **Structure INI** : Le fichier `my.cnf` / `my.ini` suit un format simple avec sections `[nom]` et options `clÃ© = valeur`
- **Section [mysqld]** : La plus importante, configure le serveur MariaDB lui-mÃªme
- **Approche modulaire** : Utiliser `!includedir` pour organiser la configuration en plusieurs fichiers thÃ©matiques (production best practice)
- **Nommage** : Convention `snake_case` avec underscores (`innodb_buffer_pool_size`)
- **NouveautÃ©s 11.8** : UTF8MB4 par dÃ©faut, TLS encouragÃ©, support TIMESTAMP 2106, contrÃ´le espace temporaire
- **Validation** : Toujours tester avec `mysqld --verbose --help` avant de redÃ©marrer en production
- **SÃ©curitÃ©** : Permissions 640, jamais de mots de passe en clair dans my.cnf partagÃ©
- **Variables dynamiques** : Modifications `SET GLOBAL` perdues au redÃ©marrage, toujours persister dans le fichier

---

## ğŸ”— Ressources et rÃ©fÃ©rences

- [ğŸ“– Documentation officielle : Server System Variables](https://mariadb.com/kb/en/server-system-variables/)
- [ğŸ“– Documentation officielle : Configuring MariaDB with Option Files](https://mariadb.com/kb/en/configuring-mariadb-with-option-files/)
- [ğŸ“– MariaDB 11.8 Release Notes](https://mariadb.com/kb/en/mariadb-11-8-0-release-notes/)
- [ğŸ“– Server System Variable Reference](https://mariadb.com/kb/en/server-system-variable-reference/)
- [Blog : Best practices for my.cnf configuration](https://mariadb.org/mariadb-configuration-best-practices/)

---

## â¡ï¸ Section suivante

**11.1.2 - Ordre de lecture des fichiers** : DÃ©couvrez comment MariaDB dÃ©termine quel fichier de configuration charger et dans quel ordre, ainsi que les stratÃ©gies pour gÃ©rer plusieurs environnements (dÃ©veloppement, staging, production).

â­ï¸ [Ordre de lecture des fichiers](/11-administration-configuration/01.2-ordre-lecture.md)
