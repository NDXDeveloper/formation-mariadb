üîù Retour au [Sommaire](/SOMMAIRE.md)

# 11.1.3 Include et configuration modulaire

> **Niveau** : Avanc√© (DBA/Architecte Syst√®me)  
> **Dur√©e estim√©e** : 2 heures  
> **Pr√©requis** : 11.1.1 - Structure my.cnf, 11.1.2 - Ordre de lecture, exp√©rience administration syst√®me

## üéØ Objectifs d'apprentissage

√Ä l'issue de cette section, vous serez capable de :
- Concevoir une architecture de configuration modulaire √©volutive et maintenable
- Impl√©menter des patterns avanc√©s d'organisation pour environnements complexes
- G√©rer efficacement des configurations multi-datacenter et multi-environnement
- Automatiser la g√©n√©ration et validation de configurations avec IaC (Infrastructure as Code)
- Appliquer les meilleures pratiques d'entreprise pour la gestion des configurations
- Mettre en place une strat√©gie de templating et versioning pour configurations MariaDB

---

## Introduction

Dans les environnements de production modernes, la gestion des configurations MariaDB devient rapidement complexe lorsqu'on doit g√©rer :
- üè¢ **Plusieurs environnements** (dev, staging, production, DR)
- üåç **Multi-datacenter** avec configurations g√©ographiques sp√©cifiques
- üîÑ **R√©plication et clustering** avec des r√¥les diff√©rents (primary, replica, Galera nodes)
- üìä **Workloads vari√©s** (OLTP, OLAP, mixte)
- üöÄ **Scalabilit√©** et √©volution des besoins

Une approche **modulaire et structur√©e** n'est plus une option mais une **n√©cessit√©**. Cette section pr√©sente les patterns et strat√©gies √©prouv√©s en production pour ma√Ætriser cette complexit√©.

üí° **Philosophie** : "Configuration as Code" - Vos fichiers de configuration doivent √™tre trait√©s comme du code : versionn√©, test√©, document√© et d√©ploy√© de mani√®re reproductible.

---

## Architectures de configuration modulaire

### Pattern 1 : Organisation par couches (Layered Configuration)

**Principe** : S√©parer la configuration en couches logiques, chacune ayant une responsabilit√© sp√©cifique.

```
Configuration Layers
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Layer 1: Base/Default       ‚Üí Param√®tres syst√®me de base
Layer 2: Engine-Specific    ‚Üí InnoDB, MyISAM, ColumnStore
Layer 3: Workload Type      ‚Üí OLTP, OLAP, Mixed
Layer 4: Infrastructure     ‚Üí Network, Storage, Security
Layer 5: Environment        ‚Üí Dev, Staging, Production
Layer 6: Node-Specific      ‚Üí Param√®tres uniques par serveur
Layer 7: Override/Custom    ‚Üí Overrides temporaires
```

#### Structure de r√©pertoires

```
/etc/mysql/
‚îú‚îÄ‚îÄ my.cnf                                  # Point d'entr√©e minimal
‚îÇ
‚îú‚îÄ‚îÄ layers/
‚îÇ   ‚îú‚îÄ‚îÄ 10-base/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 10-system.cnf                  # user, port, socket, datadir
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 20-charset.cnf                 # üÜï utf8mb4 + UCA 14.0.0
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ 30-paths.cnf                   # tmpdir, secure_file_priv
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ 20-engines/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 10-innodb-base.cnf            # InnoDB config de base
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 20-innodb-buffer.cnf          # Buffer pool
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 30-innodb-io.cnf              # I/O et flushing
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 40-innodb-logs.cnf            # Redo/undo logs
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ 50-aria.cnf                    # Moteur Aria (syst√®me)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ 30-workload/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ oltp.cnf                       # Optimisations OLTP
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ olap.cnf                       # Optimisations OLAP
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ mixed.cnf                      # Workload mixte
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ 40-infrastructure/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 10-network.cnf                 # Connexions, timeouts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 20-security.cnf                # TLS, privileges
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 30-storage.cnf                 # Limites disque
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ 40-monitoring.cnf              # Performance Schema
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ 50-environment/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ development.cnf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ staging.cnf
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ production.cnf
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ 60-replication/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ primary.cnf                    # Configuration primary
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ replica.cnf                    # Configuration replica
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ galera.cnf                     # Galera Cluster
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ 70-node-specific/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ node-db01.cnf                  # Sp√©cifique db01
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ node-db02.cnf                  # Sp√©cifique db02
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ node-db03.cnf                  # Sp√©cifique db03
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ 99-overrides/
‚îÇ       ‚îú‚îÄ‚îÄ hotfix.cnf                     # Corrections temporaires
‚îÇ       ‚îî‚îÄ‚îÄ custom.cnf                     # Customisations sp√©ciales
‚îÇ
‚îî‚îÄ‚îÄ active/
    ‚îî‚îÄ‚îÄ current-config.cnf ‚Üí ../layers/...  # Lien symbolique actif
```

#### Fichier my.cnf principal (minimal)

```ini
#
# MariaDB 11.8 LTS - Configuration Entry Point
# Architecture: Layered Modular Configuration
# Last updated: 2025-12-13
#

[client-server]
# Socket commun client/server
socket = /var/run/mysqld/mysqld.sock

[mysqld]
# === Layer 1: Base ===
!includedir /etc/mysql/layers/10-base/

# === Layer 2: Storage Engines ===
!includedir /etc/mysql/layers/20-engines/

# === Layer 3: Workload (link to active workload) ===
!include /etc/mysql/active/workload.cnf

# === Layer 4: Infrastructure ===
!includedir /etc/mysql/layers/40-infrastructure/

# === Layer 5: Environment (link to active environment) ===
!include /etc/mysql/active/environment.cnf

# === Layer 6: Replication Role (if applicable) ===
!include /etc/mysql/active/replication-role.cnf

# === Layer 7: Node Specific ===
!include /etc/mysql/active/node-specific.cnf

# === Layer 8: Overrides (loaded last) ===
!includedir /etc/mysql/layers/99-overrides/

[client]
!includedir /etc/mysql/layers/10-base/

[mysqldump]
!includedir /etc/mysql/layers/40-infrastructure/
```

üí° **Avantage** : Modification d'un aspect = modification d'un seul fichier, sans risque d'impacter les autres couches.

---

### Pattern 2 : Configuration par r√¥le (Role-Based Configuration)

**Principe** : Organisation bas√©e sur le r√¥le du serveur dans l'infrastructure.

```
/etc/mysql/
‚îú‚îÄ‚îÄ my.cnf
‚îú‚îÄ‚îÄ roles/
‚îÇ   ‚îú‚îÄ‚îÄ primary/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.cnf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ binlog.cnf
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ gtid.cnf
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ replica/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.cnf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ relay-log.cnf
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ read-only.cnf
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ galera-node/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.cnf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ wsrep.cnf
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ certification.cnf
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ analytics/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.cnf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ columnstore.cnf
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ query-timeout.cnf
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ backup-server/
‚îÇ       ‚îú‚îÄ‚îÄ base.cnf
‚îÇ       ‚îî‚îÄ‚îÄ mariabackup.cnf
‚îÇ
‚îî‚îÄ‚îÄ current-role -> roles/primary/  # Lien symbolique
```

#### Exemple : Configuration Primary

```ini
# /etc/mysql/roles/primary/base.cnf
[mysqld]
# === Primary Role - Base Configuration ===

# Identifiant unique du serveur
server-id = 101

# Read-write mode (pas de read_only)
read_only = OFF

# Logging pour r√©plication
log_bin = /var/log/mysql/mysql-bin
binlog_format = ROW
sync_binlog = 1
expire_logs_days = 7

# GTID pour faciliter le failover
gtid_domain_id = 1
gtid_strict_mode = ON

# Durabilit√© ACID maximale
innodb_flush_log_at_trx_commit = 1
```

#### Exemple : Configuration Replica

```ini
# /etc/mysql/roles/replica/base.cnf
[mysqld]
# === Replica Role - Base Configuration ===

# Identifiant unique du serveur
server-id = 201

# Mode lecture seule (critique pour r√©plica)
read_only = ON
super_read_only = ON  # M√™me les SUPER users en lecture seule

# Relay log
relay_log = /var/log/mysql/relay-bin
relay_log_recovery = ON

# GTID
gtid_strict_mode = ON

# Semi-synchronous replication (optionnel)
plugin_load_add = semisync_slave.so
rpl_semi_sync_slave_enabled = ON

# Durabilit√© r√©duite acceptable sur replica
innodb_flush_log_at_trx_commit = 2
sync_binlog = 0
```

üí° **D√©ploiement** : Lors du provisioning, un simple lien symbolique active le bon r√¥le.

```bash
# Provisionner un nouveau primary
ln -sf /etc/mysql/roles/primary /etc/mysql/current-role
systemctl restart mariadb

# Convertir en replica
rm /etc/mysql/current-role
ln -sf /etc/mysql/roles/replica /etc/mysql/current-role
systemctl restart mariadb
```

---

### Pattern 3 : Configuration par environnement (Environment-Based)

**Principe** : Param√®tres adapt√©s √† chaque environnement avec override progressif.

```
/etc/mysql/
‚îú‚îÄ‚îÄ my.cnf
‚îú‚îÄ‚îÄ common/                     # Configuration commune √† tous
‚îÇ   ‚îú‚îÄ‚îÄ 10-base.cnf
‚îÇ   ‚îú‚îÄ‚îÄ 20-innodb.cnf
‚îÇ   ‚îî‚îÄ‚îÄ 30-security.cnf
‚îÇ
‚îî‚îÄ‚îÄ environments/
    ‚îú‚îÄ‚îÄ development/
    ‚îÇ   ‚îú‚îÄ‚îÄ overrides.cnf       # Moins de m√©moire, plus de logs
    ‚îÇ   ‚îî‚îÄ‚îÄ debug.cnf           # Options de debug
    ‚îÇ
    ‚îú‚îÄ‚îÄ staging/
    ‚îÇ   ‚îú‚îÄ‚îÄ overrides.cnf       # Config similaire √† prod
    ‚îÇ   ‚îî‚îÄ‚îÄ testing.cnf         # Outils de test
    ‚îÇ
    ‚îú‚îÄ‚îÄ production/
    ‚îÇ   ‚îú‚îÄ‚îÄ overrides.cnf       # Performance maximale
    ‚îÇ   ‚îú‚îÄ‚îÄ ha.cnf              # Haute disponibilit√©
    ‚îÇ   ‚îî‚îÄ‚îÄ monitoring.cnf      # Monitoring production
    ‚îÇ
    ‚îî‚îÄ‚îÄ dr/                     # Disaster Recovery
        ‚îú‚îÄ‚îÄ overrides.cnf
        ‚îî‚îÄ‚îÄ replication.cnf
```

#### Exemple : Development

```ini
# /etc/mysql/environments/development/overrides.cnf
[mysqld]
# === Development Environment ===

# M√©moire r√©duite (laptop/VM)
innodb_buffer_pool_size = 1G
max_connections = 50

# Logs d√©taill√©s pour debugging
log_error_verbosity = 3
slow_query_log = 1
long_query_time = 0.5           # Capture requ√™tes > 500ms
log_queries_not_using_indexes = 1
general_log = 1                 # ‚ö†Ô∏è Performance impact, dev uniquement

# S√©curit√© all√©g√©e
require_secure_transport = OFF  # Pas de TLS obligatoire en dev
local_infile = 1                # Autoris√© en dev

# Mode SQL permissif pour compatibilit√© tests
sql_mode = STRICT_TRANS_TABLES
```

#### Exemple : Production

```ini
# /etc/mysql/environments/production/overrides.cnf
[mysqld]
# === Production Environment ===

# M√©moire maximale (serveur d√©di√© 128GB)
innodb_buffer_pool_size = 96G
innodb_buffer_pool_instances = 16
max_connections = 2000

# Logs minimaux (performance)
log_error_verbosity = 2
slow_query_log = 1
long_query_time = 2             # Capture requ√™tes > 2s
log_queries_not_using_indexes = 0
general_log = 0                 # ‚ö†Ô∏è Jamais en production

# S√©curit√© maximale
require_secure_transport = ON   # üÜï TLS obligatoire (11.8 best practice)
local_infile = 0

# Mode SQL strict
sql_mode = STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION

# üÜï Contr√¥le espace temporaire (MariaDB 11.8)
max_tmp_space_usage = 50G
max_total_tmp_space_usage = 200G

# Thread Pool pour haute concurrence
thread_handling = pool-of-threads
thread_pool_size = 32
thread_pool_max_threads = 5000
```

---

### Pattern 4 : Configuration par datacenter (Multi-DC)

**Principe** : Gestion de configurations sp√©cifiques √† chaque datacenter g√©ographique.

```
/etc/mysql/
‚îú‚îÄ‚îÄ my.cnf
‚îú‚îÄ‚îÄ global/                     # Param√®tres globaux toutes r√©gions
‚îÇ   ‚îî‚îÄ‚îÄ base.cnf
‚îÇ
‚îî‚îÄ‚îÄ datacenters/
    ‚îú‚îÄ‚îÄ dc-paris/
    ‚îÇ   ‚îú‚îÄ‚îÄ network.cnf         # IPs, bind-address sp√©cifiques
    ‚îÇ   ‚îú‚îÄ‚îÄ storage.cnf         # Paths sp√©cifiques DC
    ‚îÇ   ‚îî‚îÄ‚îÄ replication.cnf     # Topologie r√©plication Paris
    ‚îÇ
    ‚îú‚îÄ‚îÄ dc-frankfurt/
    ‚îÇ   ‚îú‚îÄ‚îÄ network.cnf
    ‚îÇ   ‚îú‚îÄ‚îÄ storage.cnf
    ‚îÇ   ‚îî‚îÄ‚îÄ replication.cnf
    ‚îÇ
    ‚îî‚îÄ‚îÄ dc-london/
        ‚îú‚îÄ‚îÄ network.cnf
        ‚îú‚îÄ‚îÄ storage.cnf
        ‚îî‚îÄ‚îÄ replication.cnf
```

#### Exemple : DC Paris

```ini
# /etc/mysql/datacenters/dc-paris/network.cnf
[mysqld]
# === Datacenter: Paris ===

# Bind sur IP interne du DC
bind-address = 10.1.10.15

# Hostname pour r√©plication
report_host = db01.paris.example.com

# Timezone du datacenter
default_time_zone = '+01:00'  # CET/CEST

# Serveur ID range: Paris = 100-199
server-id = 101
```

#### Exemple : R√©plication inter-DC

```ini
# /etc/mysql/datacenters/dc-paris/replication.cnf
[mysqld]
# === R√©plication multi-datacenter ===

# GTID pour failover inter-DC
gtid_domain_id = 1  # Paris
log_slave_updates = ON

# Binary logs pour r√©plication vers autres DCs
log_bin = /var/log/mysql/mysql-bin
expire_logs_days = 14  # R√©tention plus longue pour latence WAN

# Semi-synchronous uniquement au sein du DC
# Asynchronous vers autres DCs (latence WAN)
rpl_semi_sync_master_timeout = 10000  # 10s
```

---

## Strat√©gies d'activation et de switchover

### M√©thode 1 : Liens symboliques (Simple et efficace)

```bash
#!/bin/bash
# switch-environment.sh

ENVIRONMENT=$1  # dev, staging, production

if [ -z "$ENVIRONMENT" ]; then
    echo "Usage: $0 {dev|staging|production}"
    exit 1
fi

# Cr√©er le lien symbolique vers l'environnement
ln -sf /etc/mysql/environments/${ENVIRONMENT}/overrides.cnf \
       /etc/mysql/active/environment.cnf

echo "Switched to ${ENVIRONMENT} environment"
echo "Restart MariaDB to apply: systemctl restart mariadb"

# Validation
echo ""
echo "Effective configuration after restart:"
my_print_defaults mysqld | grep -E "(buffer_pool_size|max_connections)"
```

Usage :

```bash
# Basculer en staging
./switch-environment.sh staging
systemctl restart mariadb

# Basculer en production
./switch-environment.sh production
systemctl restart mariadb
```

### M√©thode 2 : Variables d'environnement systemd

```ini
# /etc/systemd/system/mariadb.service.d/environment.conf
[Service]
Environment="MARIADB_ENV=production"
Environment="MARIADB_DC=paris"
Environment="MARIADB_ROLE=primary"
```

Avec preprocessing :

```bash
#!/bin/bash
# generate-config.sh

ENVIRONMENT=${MARIADB_ENV:-development}
DC=${MARIADB_DC:-default}
ROLE=${MARIADB_ROLE:-standalone}

# G√©n√©rer configuration active
cat > /etc/mysql/active/generated.cnf <<EOF
# Generated configuration
# Environment: ${ENVIRONMENT}
# Datacenter: ${DC}
# Role: ${ROLE}

!include /etc/mysql/environments/${ENVIRONMENT}/overrides.cnf
!include /etc/mysql/datacenters/dc-${DC}/network.cnf
!include /etc/mysql/roles/${ROLE}/base.cnf
EOF
```

```ini
# /etc/systemd/system/mariadb.service.d/config-generator.conf
[Service]
ExecStartPre=/usr/local/bin/generate-config.sh
```

### M√©thode 3 : Templating avec envsubst

```ini
# /etc/mysql/templates/production.cnf.template
[mysqld]
# === Production Template ===

innodb_buffer_pool_size = ${INNODB_BUFFER_POOL_SIZE}
max_connections = ${MAX_CONNECTIONS}
server-id = ${SERVER_ID}
bind-address = ${BIND_ADDRESS}
```

Script de g√©n√©ration :

```bash
#!/bin/bash
# deploy-config.sh

# Variables d'environnement (ou depuis fichier .env)
export INNODB_BUFFER_POOL_SIZE="96G"
export MAX_CONNECTIONS="2000"
export SERVER_ID="101"
export BIND_ADDRESS="10.1.10.15"

# G√©n√©rer la configuration finale
envsubst < /etc/mysql/templates/production.cnf.template \
         > /etc/mysql/conf.d/50-production.cnf

echo "Configuration generated successfully"
```

---

## Patterns avanc√©s d'organisation

### Pattern : Configuration Matrix (Environment √ó Role)

Pour des infrastructures avec plusieurs dimensions :

```
Environments √ó Roles Matrix
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           ‚îÇ Primary ‚îÇ Replica ‚îÇ Galera ‚îÇ Analytics    ‚îÇ
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
Dev        ‚îÇ  ‚úì      ‚îÇ  ‚úì      ‚îÇ  ‚úó     ‚îÇ  ‚úó           ‚îÇ
Staging    ‚îÇ  ‚úì      ‚îÇ  ‚úì      ‚îÇ  ‚úì     ‚îÇ  ‚úó           ‚îÇ
Production ‚îÇ  ‚úì      ‚îÇ  ‚úì      ‚îÇ  ‚úì     ‚îÇ  ‚úì           ‚îÇ
DR         ‚îÇ  ‚úì      ‚îÇ  ‚úì      ‚îÇ  ‚úó     ‚îÇ  ‚úó           ‚îÇ
```

Structure :

```
/etc/mysql/
‚îú‚îÄ‚îÄ matrix/
‚îÇ   ‚îú‚îÄ‚îÄ dev-primary/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ config.cnf
‚îÇ   ‚îú‚îÄ‚îÄ dev-replica/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ config.cnf
‚îÇ   ‚îú‚îÄ‚îÄ staging-primary/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ config.cnf
‚îÇ   ‚îú‚îÄ‚îÄ staging-replica/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ config.cnf
‚îÇ   ‚îú‚îÄ‚îÄ staging-galera/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ config.cnf
‚îÇ   ‚îú‚îÄ‚îÄ production-primary/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ config.cnf
‚îÇ   ‚îú‚îÄ‚îÄ production-replica/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ config.cnf
‚îÇ   ‚îú‚îÄ‚îÄ production-galera/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ config.cnf
‚îÇ   ‚îî‚îÄ‚îÄ production-analytics/
‚îÇ       ‚îî‚îÄ‚îÄ config.cnf
‚îÇ
‚îî‚îÄ‚îÄ current -> matrix/production-primary/
```

### Pattern : Feature Flags

Activation/d√©sactivation de fonctionnalit√©s via configuration modulaire :

```
/etc/mysql/
‚îú‚îÄ‚îÄ features/
‚îÇ   ‚îú‚îÄ‚îÄ available/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ssl-strict.cnf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ query-cache.cnf         # D√©pr√©ci√©
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ audit-logging.cnf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ slow-query-log.cnf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ performance-schema.cnf
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ thread-pool.cnf
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ enabled/                    # Liens symboliques
‚îÇ       ‚îú‚îÄ‚îÄ ssl-strict.cnf -> ../available/ssl-strict.cnf
‚îÇ       ‚îú‚îÄ‚îÄ audit-logging.cnf -> ../available/audit-logging.cnf
‚îÇ       ‚îî‚îÄ‚îÄ thread-pool.cnf -> ../available/thread-pool.cnf
```

Activation/d√©sactivation :

```bash
# Activer une feature
ln -sf /etc/mysql/features/available/performance-schema.cnf \
       /etc/mysql/features/enabled/performance-schema.cnf

# D√©sactiver une feature
rm /etc/mysql/features/enabled/slow-query-log.cnf
```

Fichier my.cnf :

```ini
[mysqld]
!includedir /etc/mysql/features/enabled/
```

### Pattern : Version-Specific Overrides

Pour g√©rer plusieurs versions MariaDB :

```
/etc/mysql/
‚îú‚îÄ‚îÄ versions/
‚îÇ   ‚îú‚îÄ‚îÄ 10.11/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ overrides.cnf
‚îÇ   ‚îú‚îÄ‚îÄ 11.4/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ overrides.cnf
‚îÇ   ‚îî‚îÄ‚îÄ 11.8/
‚îÇ       ‚îú‚îÄ‚îÄ overrides.cnf
‚îÇ       ‚îú‚îÄ‚îÄ utf8mb4-uca14.cnf      # üÜï Nouvelles collations
‚îÇ       ‚îî‚îÄ‚îÄ vector-support.cnf     # üÜï MariaDB Vector
‚îÇ
‚îî‚îÄ‚îÄ current-version -> versions/11.8/
```

```ini
# /etc/mysql/versions/11.8/overrides.cnf
[mysqld]
# === MariaDB 11.8 LTS Specific ===

# üÜï UTF8MB4 par d√©faut avec UCA 14.0.0
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

# üÜï TIMESTAMP √©tendu jusqu'√† 2106 (Y2038 r√©solu)
# Aucune configuration n√©cessaire, automatique en 11.8

# üÜï Contr√¥le espace temporaire
max_tmp_space_usage = 50G
max_total_tmp_space_usage = 200G

# üÜï Construction d'index optimis√©e
innodb_alter_copy_bulk = ON

# üÜï Cost optimizer am√©lior√© pour SSD
# Utilise automatiquement les nouvelles heuristiques
```

---

## Automation avec Infrastructure as Code

### Ansible : D√©ploiement configuration modulaire

```yaml
# playbook-mariadb-config.yml
---
- name: Deploy MariaDB modular configuration
  hosts: mariadb_servers
  become: yes

  vars:
    mariadb_environment: "{{ lookup('env', 'DEPLOY_ENV') | default('staging') }}"
    mariadb_role: "{{ hostvars[inventory_hostname].mariadb_role }}"
    mariadb_datacenter: "{{ hostvars[inventory_hostname].datacenter }}"

  tasks:
    - name: Create configuration directories
      file:
        path: "{{ item }}"
        state: directory
        owner: mysql
        group: mysql
        mode: '0755'
      loop:
        - /etc/mysql/layers
        - /etc/mysql/active
        - /etc/mysql/environments
        - /etc/mysql/roles
        - /etc/mysql/datacenters

    - name: Deploy base configuration layers
      copy:
        src: "layers/{{ item }}"
        dest: "/etc/mysql/layers/{{ item }}"
        owner: mysql
        group: mysql
        mode: '0644'
      loop:
        - 10-base/
        - 20-engines/
        - 40-infrastructure/
      notify: validate configuration

    - name: Deploy environment-specific configuration
      template:
        src: "environments/{{ mariadb_environment }}.cnf.j2"
        dest: "/etc/mysql/environments/{{ mariadb_environment }}/overrides.cnf"
        owner: mysql
        group: mysql
        mode: '0644'
      notify: validate configuration

    - name: Deploy role-specific configuration
      template:
        src: "roles/{{ mariadb_role }}.cnf.j2"
        dest: "/etc/mysql/roles/{{ mariadb_role }}/base.cnf"
        owner: mysql
        group: mysql
        mode: '0644'
      notify: validate configuration

    - name: Activate configurations via symlinks
      file:
        src: "{{ item.src }}"
        dest: "{{ item.dest }}"
        state: link
      loop:
        - src: "/etc/mysql/environments/{{ mariadb_environment }}/overrides.cnf"
          dest: "/etc/mysql/active/environment.cnf"
        - src: "/etc/mysql/roles/{{ mariadb_role }}/base.cnf"
          dest: "/etc/mysql/active/role.cnf"
      notify:
        - validate configuration
        - restart mariadb

    - name: Deploy datacenter-specific configuration
      template:
        src: "datacenters/{{ mariadb_datacenter }}.cnf.j2"
        dest: "/etc/mysql/datacenters/{{ mariadb_datacenter }}/network.cnf"
        owner: mysql
        group: mysql
        mode: '0644'
      when: mariadb_datacenter is defined
      notify: validate configuration

  handlers:
    - name: validate configuration
      command: mysqld --verbose --help
      register: config_check
      failed_when: config_check.rc != 0
      changed_when: false

    - name: restart mariadb
      systemd:
        name: mariadb
        state: restarted
```

Template Jinja2 pour environnement :

```jinja2
{# environments/production.cnf.j2 #}
[mysqld]
# === Production Environment - {{ inventory_hostname }} ===
# Deployed: {{ ansible_date_time.iso8601 }}

# Memory configuration
innodb_buffer_pool_size = {{ (ansible_memtotal_mb * 0.7) | int }}M
max_connections = {{ mariadb_max_connections | default(2000) }}

# Security
require_secure_transport = ON
local_infile = 0

# üÜï MariaDB 11.8 - Contr√¥le espace temporaire
max_tmp_space_usage = {{ mariadb_tmp_space | default('50G') }}
max_total_tmp_space_usage = {{ mariadb_total_tmp_space | default('200G') }}

# Performance
thread_handling = pool-of-threads
thread_pool_size = {{ ansible_processor_vcpus }}
```

### Terraform : Gestion configurations cloud

```hcl
# main.tf
resource "local_file" "mariadb_config" {
  for_each = var.mariadb_servers

  filename = "/tmp/mariadb-configs/${each.key}/my.cnf"

  content = templatefile("${path.module}/templates/my.cnf.tpl", {
    environment     = each.value.environment
    role            = each.value.role
    server_id       = each.value.server_id
    buffer_pool_gb  = each.value.memory_gb * 0.7
    max_connections = each.value.max_connections
    datacenter      = each.value.datacenter
  })

  file_permission = "0644"
}

# Upload to servers
resource "null_resource" "deploy_config" {
  for_each = var.mariadb_servers

  triggers = {
    config_hash = local_file.mariadb_config[each.key].content_md5
  }

  provisioner "file" {
    source      = local_file.mariadb_config[each.key].filename
    destination = "/etc/mysql/my.cnf"

    connection {
      type = "ssh"
      host = each.value.ip_address
      user = "admin"
    }
  }

  provisioner "remote-exec" {
    inline = [
      "sudo mysqld --verbose --help > /dev/null",  # Validate
      "sudo systemctl restart mariadb"
    ]

    connection {
      type = "ssh"
      host = each.value.ip_address
      user = "admin"
    }
  }
}
```

### Helm Chart (Kubernetes)

```yaml
# values.yaml
mariadb:
  architecture: replication

  primary:
    configuration: |-
      [mysqld]
      server-id = 1
      log_bin = mysql-bin
      binlog_format = ROW

      innodb_buffer_pool_size = {{ .Values.primary.resources.limits.memory | replace "Gi" "G" }}
      max_connections = {{ .Values.primary.maxConnections }}

      # üÜï MariaDB 11.8
      character-set-server = utf8mb4
      collation-server = utf8mb4_unicode_ci
      max_tmp_space_usage = 10G

  secondary:
    configuration: |-
      [mysqld]
      server-id = 2
      read_only = ON
      super_read_only = ON

      relay_log = relay-bin
      relay_log_recovery = ON

      innodb_buffer_pool_size = {{ .Values.secondary.resources.limits.memory | replace "Gi" "G" }}
      max_connections = {{ .Values.secondary.maxConnections }}

# templates/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "mariadb.fullname" . }}-configuration
data:
  my.cnf: |
{{ .Values.mariadb.primary.configuration | indent 4 }}
```

---

## Validation et testing de configurations

### Script de validation complet

```bash
#!/bin/bash
# config-validator.sh - Validation avanc√©e configuration MariaDB

set -e

MYSQL_CONFIG_DIR="/etc/mysql"
VALIDATION_LOG="/var/log/mysql/config-validation.log"

echo "=== MariaDB Configuration Validation ===" | tee -a $VALIDATION_LOG
echo "Date: $(date)" | tee -a $VALIDATION_LOG
echo "" | tee -a $VALIDATION_LOG

# 1. Syntax validation
echo "1. Checking syntax..." | tee -a $VALIDATION_LOG
if mysqld --verbose --help > /dev/null 2>&1; then
    echo "   ‚úÖ Syntax valid" | tee -a $VALIDATION_LOG
else
    echo "   ‚ùå Syntax error detected" | tee -a $VALIDATION_LOG
    mysqld --verbose --help 2>&1 | tail -20 | tee -a $VALIDATION_LOG
    exit 1
fi

# 2. File permissions check
echo "" | tee -a $VALIDATION_LOG
echo "2. Checking file permissions..." | tee -a $VALIDATION_LOG
PERM_ISSUES=$(find $MYSQL_CONFIG_DIR -name "*.cnf" -type f \
  \( ! -perm 644 -a ! -perm 640 -a ! -perm 600 \) 2>/dev/null)

if [ -z "$PERM_ISSUES" ]; then
    echo "   ‚úÖ All permissions correct" | tee -a $VALIDATION_LOG
else
    echo "   ‚ö†Ô∏è  Permission issues found:" | tee -a $VALIDATION_LOG
    echo "$PERM_ISSUES" | tee -a $VALIDATION_LOG
fi

# 3. Circular include detection
echo "" | tee -a $VALIDATION_LOG
echo "3. Checking for circular includes..." | tee -a $VALIDATION_LOG
# Simple check - could be enhanced with graph analysis
INCLUDE_COUNT=$(grep -r "^!include" $MYSQL_CONFIG_DIR | wc -l)
echo "   Found $INCLUDE_COUNT include directives" | tee -a $VALIDATION_LOG

# 4. Critical parameters validation
echo "" | tee -a $VALIDATION_LOG
echo "4. Validating critical parameters..." | tee -a $VALIDATION_LOG

# Buffer pool size
BUFFER_POOL=$(my_print_defaults mysqld | grep innodb-buffer-pool-size | cut -d= -f2)
echo "   innodb_buffer_pool_size: $BUFFER_POOL" | tee -a $VALIDATION_LOG

# Max connections
MAX_CONN=$(my_print_defaults mysqld | grep max-connections | cut -d= -f2)
echo "   max_connections: $MAX_CONN" | tee -a $VALIDATION_LOG

# Server ID (important pour r√©plication)
SERVER_ID=$(my_print_defaults mysqld | grep server-id | cut -d= -f2)
if [ -n "$SERVER_ID" ]; then
    echo "   server-id: $SERVER_ID ‚úÖ" | tee -a $VALIDATION_LOG
else
    echo "   ‚ö†Ô∏è  server-id not set (required for replication)" | tee -a $VALIDATION_LOG
fi

# 5. üÜï MariaDB 11.8 specific checks
echo "" | tee -a $VALIDATION_LOG
echo "5. MariaDB 11.8 specific validation..." | tee -a $VALIDATION_LOG

# UTF8MB4 default
CHARSET=$(my_print_defaults mysqld | grep character-set-server | cut -d= -f2)
if [ "$CHARSET" = "utf8mb4" ]; then
    echo "   ‚úÖ utf8mb4 configured as default" | tee -a $VALIDATION_LOG
else
    echo "   ‚ÑπÔ∏è  charset: $CHARSET (recommended: utf8mb4)" | tee -a $VALIDATION_LOG
fi

# Contr√¥le espace temporaire
TMP_SPACE=$(my_print_defaults mysqld | grep max-tmp-space-usage | cut -d= -f2)
if [ -n "$TMP_SPACE" ]; then
    echo "   ‚úÖ max_tmp_space_usage configured: $TMP_SPACE" | tee -a $VALIDATION_LOG
fi

# 6. Conflict detection
echo "" | tee -a $VALIDATION_LOG
echo "6. Checking for conflicting parameters..." | tee -a $VALIDATION_LOG

# Exemple : query_cache (d√©pr√©ci√©)
QUERY_CACHE=$(my_print_defaults mysqld | grep query-cache-type | cut -d= -f2)
if [ "$QUERY_CACHE" != "0" ] && [ -n "$QUERY_CACHE" ]; then
    echo "   ‚ö†Ô∏è  query_cache_type is set (deprecated, should be 0)" | tee -a $VALIDATION_LOG
fi

# 7. Generate configuration report
echo "" | tee -a $VALIDATION_LOG
echo "7. Configuration summary:" | tee -a $VALIDATION_LOG
echo "   Files read order:" | tee -a $VALIDATION_LOG
mysqld --help --verbose 2>/dev/null | grep -A 1 "Default options" | tee -a $VALIDATION_LOG

# 8. Comparison with previous version (if available)
if [ -f /etc/mysql/backup/previous-config.txt ]; then
    echo "" | tee -a $VALIDATION_LOG
    echo "8. Changes since last validation:" | tee -a $VALIDATION_LOG
    diff -u /etc/mysql/backup/previous-config.txt \
        <(my_print_defaults mysqld) | tee -a $VALIDATION_LOG || true
fi

# Save current config for next comparison
mkdir -p /etc/mysql/backup
my_print_defaults mysqld > /etc/mysql/backup/previous-config.txt

echo "" | tee -a $VALIDATION_LOG
echo "=== Validation Complete ===" | tee -a $VALIDATION_LOG
echo "Full log: $VALIDATION_LOG"
```

### Tests unitaires des configurations

```bash
#!/bin/bash
# config-tests.sh - Unit tests pour configurations

test_buffer_pool_size() {
    local buffer_pool=$(my_print_defaults mysqld | grep innodb-buffer-pool-size | cut -d= -f2)
    local min_size="1G"

    if [[ "$buffer_pool" =~ ^[0-9]+G$ ]]; then
        local size_gb=${buffer_pool%G}
        if [ "$size_gb" -ge 1 ]; then
            echo "‚úÖ PASS: buffer_pool_size >= $min_size"
            return 0
        fi
    fi
    echo "‚ùå FAIL: buffer_pool_size < $min_size"
    return 1
}

test_binlog_enabled() {
    local log_bin=$(my_print_defaults mysqld | grep -c "^--log-bin")

    if [ "$log_bin" -gt 0 ]; then
        echo "‚úÖ PASS: Binary logging enabled"
        return 0
    else
        echo "‚ùå FAIL: Binary logging not enabled"
        return 1
    fi
}

test_utf8mb4_default() {
    local charset=$(my_print_defaults mysqld | grep character-set-server | cut -d= -f2)

    if [ "$charset" = "utf8mb4" ]; then
        echo "‚úÖ PASS: utf8mb4 is default charset (11.8)"
        return 0
    else
        echo "‚ö†Ô∏è  WARN: charset is $charset, recommended: utf8mb4"
        return 1
    fi
}

# Run all tests
echo "=== Configuration Unit Tests ==="
FAILED=0

test_buffer_pool_size || ((FAILED++))
test_binlog_enabled || ((FAILED++))
test_utf8mb4_default || ((FAILED++))

echo ""
if [ $FAILED -eq 0 ]; then
    echo "All tests passed ‚úÖ"
    exit 0
else
    echo "$FAILED test(s) failed ‚ùå"
    exit 1
fi
```

---

## Documentation et versioning

### G√©n√©ration automatique de documentation

```bash
#!/bin/bash
# generate-config-docs.sh

OUTPUT_FILE="/var/www/docs/mariadb-config-$(date +%Y%m%d).md"

cat > $OUTPUT_FILE <<'EOF'
# MariaDB Configuration Documentation

**Generated:** $(date)
**MariaDB Version:** $(mysqld --version)

## Active Configuration Files

Files read in order:
```
EOF

mysqld --help --verbose 2>/dev/null | grep -A 5 "Default options" >> $OUTPUT_FILE

cat >> $OUTPUT_FILE <<'EOF'
```

## Effective Configuration

### Critical Parameters

| Parameter | Value | Source |
|-----------|-------|--------|
EOF

# Ajouter les param√®tres critiques
for param in innodb_buffer_pool_size max_connections server-id; do
    value=$(my_print_defaults mysqld | grep "^--$param=" | cut -d= -f2)
    # Trouver le fichier source (simplifi√©)
    source=$(grep -r "^$param" /etc/mysql/ 2>/dev/null | head -1 | cut -d: -f1)
    echo "| $param | $value | ${source##*/} |" >> $OUTPUT_FILE
done

cat >> $OUTPUT_FILE <<'EOF'

## Configuration Layers

EOF

# Lister tous les fichiers de configuration
find /etc/mysql -name "*.cnf" -type f | sort | while read file; do
    echo "### $file" >> $OUTPUT_FILE
    echo '```ini' >> $OUTPUT_FILE
    cat "$file" >> $OUTPUT_FILE
    echo '```' >> $OUTPUT_FILE
    echo "" >> $OUTPUT_FILE
done

echo "Documentation generated: $OUTPUT_FILE"
```

### Git hooks pour validation

```bash
#!/bin/bash
# .git/hooks/pre-commit

echo "Validating MariaDB configuration before commit..."

# Copier les fichiers staged vers un r√©pertoire temporaire
TMPDIR=$(mktemp -d)
git diff --cached --name-only --diff-filter=ACM | grep '\.cnf$' | while read file; do
    mkdir -p "$TMPDIR/$(dirname $file)"
    git show ":$file" > "$TMPDIR/$file"
done

# Valider la syntaxe
if [ -d "$TMPDIR/etc/mysql" ]; then
    mysqld --defaults-file="$TMPDIR/etc/mysql/my.cnf" --verbose --help > /dev/null 2>&1

    if [ $? -ne 0 ]; then
        echo "‚ùå Configuration validation failed!"
        rm -rf "$TMPDIR"
        exit 1
    else
        echo "‚úÖ Configuration validation passed"
    fi
fi

rm -rf "$TMPDIR"
exit 0
```

### Changelog automatique

```bash
#!/bin/bash
# update-changelog.sh

CHANGELOG="/etc/mysql/CHANGELOG.md"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

# D√©tecter les changements
CHANGES=$(git diff HEAD~1 --name-only -- '*.cnf' 2>/dev/null)

if [ -n "$CHANGES" ]; then
    echo "## $TIMESTAMP" >> $CHANGELOG
    echo "" >> $CHANGELOG
    echo "**Changed files:**" >> $CHANGELOG
    echo "$CHANGES" | sed 's/^/- /' >> $CHANGELOG
    echo "" >> $CHANGELOG

    # Ajouter le diff des param√®tres critiques
    echo "**Parameter changes:**" >> $CHANGELOG
    my_print_defaults mysqld > /tmp/current-config
    diff -u /etc/mysql/backup/previous-config.txt /tmp/current-config | \
        grep '^[+-]--' | sed 's/^/  /' >> $CHANGELOG
    echo "" >> $CHANGELOG
fi
```

---

## Bonnes pratiques de production

### 1. Principe DRY (Don't Repeat Yourself)

‚ùå **√Ä √©viter** : Duplication de param√®tres

```ini
# development.cnf
[mysqld]
socket = /var/run/mysqld/mysqld.sock
datadir = /var/lib/mysql
innodb_buffer_pool_size = 1G

# staging.cnf
[mysqld]
socket = /var/run/mysqld/mysqld.sock  # ‚ùå Dupliqu√©
datadir = /var/lib/mysql              # ‚ùå Dupliqu√©
innodb_buffer_pool_size = 8G
```

‚úÖ **Recommand√©** : Factoriser les √©l√©ments communs

```ini
# common/base.cnf
[mysqld]
socket = /var/run/mysqld/mysqld.sock
datadir = /var/lib/mysql

# development.cnf
!include /etc/mysql/common/base.cnf
[mysqld]
innodb_buffer_pool_size = 1G

# staging.cnf
!include /etc/mysql/common/base.cnf
[mysqld]
innodb_buffer_pool_size = 8G
```

### 2. Commentaires exhaustifs

```ini
#
# 40-performance.cnf
#
# Description : Configuration performance pour workload OLTP
# Environment : Production
# Server specs: 128GB RAM, 32 cores, NVMe SSD
# Target QPS  : 50000
# Last review : 2025-12-13
# Reviewer    : DBA Team
# Change log  : See /etc/mysql/CHANGELOG.md
#

[mysqld]
# Buffer Pool: 70% of RAM (90GB pour 128GB total)
# Rationale: Maximiser le cache tout en laissant RAM pour OS et connexions
innodb_buffer_pool_size = 90G

# Buffer Pool Instances: 1 instance per 8GB recommended
# 90GB / 8 = 11.25 ‚Üí arrondi √† 12 instances
innodb_buffer_pool_instances = 12

# Thread Pool: 1-2 threads per CPU core pour OLTP
# 32 cores ‚Üí 32 threads
# Ajust√© apr√®s benchmarking pour ce workload sp√©cifique
thread_pool_size = 32
```

### 3. Versioning s√©mantique pour configurations

```
/etc/mysql/
‚îú‚îÄ‚îÄ versions/
‚îÇ   ‚îú‚îÄ‚îÄ v1.0.0/  # Configuration initiale
‚îÇ   ‚îú‚îÄ‚îÄ v1.1.0/  # Ajout thread pool
‚îÇ   ‚îú‚îÄ‚îÄ v1.2.0/  # Optimisations buffer pool
‚îÇ   ‚îú‚îÄ‚îÄ v2.0.0/  # Migration MariaDB 11.8
‚îÇ   ‚îî‚îÄ‚îÄ current -> v2.0.0/
```

### 4. Immutabilit√© et rollback

```bash
#!/bin/bash
# deploy-config-version.sh

VERSION=$1
BACKUP_DIR="/etc/mysql/backups"

if [ -z "$VERSION" ]; then
    echo "Usage: $0 <version>"
    exit 1
fi

# Backup de la config actuelle
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
mkdir -p "$BACKUP_DIR"
tar -czf "$BACKUP_DIR/config-backup-$TIMESTAMP.tar.gz" /etc/mysql/

# D√©ployer la nouvelle version
ln -sfn "/etc/mysql/versions/$VERSION" /etc/mysql/current

# Valider
if mysqld --verbose --help > /dev/null 2>&1; then
    echo "‚úÖ Version $VERSION deployed successfully"
    systemctl restart mariadb
else
    echo "‚ùå Validation failed, rolling back"
    # Restaurer depuis backup
    tar -xzf "$BACKUP_DIR/config-backup-$TIMESTAMP.tar.gz" -C /
    systemctl restart mariadb
    exit 1
fi
```

### 5. Tests de non-r√©gression

```bash
#!/bin/bash
# regression-tests.sh

# Sauvegarder l'√©tat actuel
BEFORE=$(mktemp)
mysql -e "SHOW VARIABLES" > "$BEFORE"

# Appliquer nouvelle configuration
systemctl restart mariadb
sleep 5

# Comparer
AFTER=$(mktemp)
mysql -e "SHOW VARIABLES" > "$AFTER"

# V√©rifier que les param√®tres critiques n'ont pas chang√© involontairement
CRITICAL_PARAMS="innodb_buffer_pool_size max_connections server_id"

for param in $CRITICAL_PARAMS; do
    before_val=$(grep "^$param" "$BEFORE" | awk '{print $2}')
    after_val=$(grep "^$param" "$AFTER" | awk '{print $2}')

    if [ "$before_val" != "$after_val" ]; then
        echo "‚ö†Ô∏è  $param changed: $before_val ‚Üí $after_val"
    fi
done

rm "$BEFORE" "$AFTER"
```

---

## ‚úÖ Points cl√©s √† retenir

- **Architecture modulaire** : Organiser les configurations en couches logiques (base, engine, workload, environment, overrides)
- **Patterns √©prouv√©s** : Utiliser des patterns adapt√©s (layered, role-based, environment-based, multi-DC)
- **Liens symboliques** : M√©thode simple et efficace pour activer/d√©sactiver des configurations
- **!includedir ordre alphab√©tique** : Pr√©fixer les fichiers avec des num√©ros (10-, 20-, 30-...) pour contr√¥ler l'ordre
- **DRY principle** : Factoriser les √©l√©ments communs, √©viter la duplication
- **Validation syst√©matique** : Toujours valider avec `mysqld --verbose --help` avant d√©ploiement
- **Versioning Git** : Traiter la configuration comme du code (commit, tag, rollback)
- **Documentation** : Commenter exhaustivement le "pourquoi" des choix
- **IaC** : Automatiser avec Ansible, Terraform, Helm pour reproductibilit√©
- **Tests** : Unit tests, validation de syntaxe, tests de non-r√©gression
- **Immutabilit√©** : Versions immuables avec capacit√© de rollback rapide
- **MariaDB 11.8** : Profiter des nouveaut√©s (utf8mb4, contr√¥le tmp space, optimisations)

---

## üîó Ressources et r√©f√©rences

- [üìñ Documentation officielle : Option Files](https://mariadb.com/kb/en/configuring-mariadb-with-option-files/)
- [üìñ MariaDB Server System Variables](https://mariadb.com/kb/en/server-system-variables/)
- [üìñ Best Practices for Configuration Management](https://mariadb.org/configuration-management/)
- [GitHub : Exemple configurations modulaires](https://github.com/mariadb-corporation/mariadb-docker)
- [Blog : Infrastructure as Code pour bases de donn√©es](https://mariadb.com/blog/database-infrastructure-as-code/)
- [Ansible Galaxy : mariadb-role](https://galaxy.ansible.com/search?keywords=mariadb)

---

## ‚û°Ô∏è Section suivante

**11.2 - Variables syst√®me et de session** : Exploration approfondie des variables MariaDB, gestion dynamique vs statique, scopes (GLOBAL, SESSION), et impact sur les performances et le comportement du serveur.

‚è≠Ô∏è [Variables syst√®me et de session](/11-administration-configuration/02-variables-systeme-session.md)
