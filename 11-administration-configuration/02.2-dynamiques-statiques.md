üîù Retour au [Sommaire](/SOMMAIRE.md)

# 11.2.2 Variables dynamiques vs statiques

> **Niveau** : Avanc√© (DBA/Architecte Syst√®me)  
> **Dur√©e estim√©e** : 2 heures  
> **Pr√©requis** : 11.2.1 - SHOW VARIABLES et SET, exp√©rience administration MariaDB

## üéØ Objectifs d'apprentissage

√Ä l'issue de cette section, vous serez capable de :
- Distinguer clairement les variables dynamiques et statiques
- Identifier rapidement si une variable n√©cessite un red√©marrage
- Planifier et ex√©cuter des modifications de variables statiques en production
- Minimiser les temps d'arr√™t lors des changements de configuration
- Comprendre l'impact des modifications sur la disponibilit√© et les performances
- Utiliser les strat√©gies appropri√©es pour chaque type de variable
- G√©rer les migrations de configuration avec z√©ro ou minimum de downtime

---

## Introduction

La distinction entre variables **dynamiques** et **statiques** est **fondamentale** pour l'administration MariaDB en production. Cette compr√©hension permet de :

- üéØ **Planifier** les maintenances appropri√©es
- ‚ö° **R√©agir rapidement** aux probl√®mes de performance
- üõ°Ô∏è **Minimiser** les temps d'arr√™t
- üìä **Anticiper** l'impact des changements

### D√©finitions

| Type | D√©finition | Modification | Impact |
|------|------------|--------------|---------|
| **Dynamique** | Variable modifiable en runtime avec `SET GLOBAL` | Sans red√©marrage | Imm√©diat, aucun downtime |
| **Statique** | Variable en lecture seule, d√©finie au d√©marrage | Red√©marrage requis | Downtime n√©cessaire |

‚ö†Ô∏è **Point critique** : Une erreur courante est de tenter de modifier une variable statique avec `SET GLOBAL`, ce qui √©choue et peut causer de la confusion lors du troubleshooting.

---

## Variables dynamiques : Modification sans red√©marrage

### Caract√©ristiques

Les variables dynamiques offrent une **flexibilit√© maximale** :

- ‚úÖ Modifiables avec `SET GLOBAL` sans interruption de service
- ‚úÖ Effet imm√©diat (ou quasi-imm√©diat selon la variable)
- ‚úÖ Aucun downtime requis
- ‚úÖ Possibilit√© de rollback instantan√©
- ‚ö†Ô∏è Modification non persistante sauf si `SET PERSIST` ou modification de `my.cnf`

### V√©rification du caract√®re dynamique

```sql
-- M√©thode 1 : INFORMATION_SCHEMA
SELECT VARIABLE_NAME,
       VARIABLE_SCOPE,
       IS_DYNAMIC,
       DEFAULT_VALUE,
       VARIABLE_TYPE
FROM information_schema.SYSTEM_VARIABLES
WHERE VARIABLE_NAME = 'max_connections';
```

R√©sultat :

```
+------------------+----------------+------------+---------------+---------------+
| VARIABLE_NAME    | VARIABLE_SCOPE | IS_DYNAMIC | DEFAULT_VALUE | VARIABLE_TYPE |
+------------------+----------------+------------+---------------+---------------+
| max_connections  | GLOBAL         | YES        | 151           | UNSIGNED INT  |
+------------------+----------------+------------+---------------+---------------+
```

```sql
-- M√©thode 2 : Tester directement
SET GLOBAL max_connections = 1000;
-- Si succ√®s ‚Üí dynamique
-- Si erreur "read only variable" ‚Üí statique
```

### Cat√©gories de variables dynamiques importantes

#### 1. Performance et m√©moire (dynamiques)

```sql
-- Connexions et threading
SHOW VARIABLES WHERE Variable_name IN (
  'max_connections',              -- ‚úÖ Dynamique
  'thread_cache_size',            -- ‚úÖ Dynamique
  'table_open_cache',             -- ‚úÖ Dynamique
  'table_definition_cache'        -- ‚úÖ Dynamique
);

-- Thread Pool (11.8)
SHOW VARIABLES WHERE Variable_name LIKE 'thread_pool%';
-- thread_pool_size               -- ‚úÖ Dynamique
-- thread_pool_max_threads        -- ‚úÖ Dynamique
-- thread_pool_stall_limit        -- ‚úÖ Dynamique
```

**Exemple de modification** :

```sql
-- Augmenter max_connections en cas de pic de charge
SET GLOBAL max_connections = 2000;

-- V√©rifier
SELECT @@GLOBAL.max_connections;
-- 2000

-- Persister pour survivre au red√©marrage
SET PERSIST max_connections = 2000;
```

#### 2. Logging et debugging (dynamiques)

```sql
-- Activer/d√©sactiver les logs sans red√©marrage
SHOW VARIABLES WHERE Variable_name IN (
  'slow_query_log',               -- ‚úÖ Dynamique
  'general_log',                  -- ‚úÖ Dynamique
  'log_queries_not_using_indexes',-- ‚úÖ Dynamique
  'long_query_time',              -- ‚úÖ Dynamique
  'log_error_verbosity'           -- ‚úÖ Dynamique
);
```

**Cas d'usage** : Debugging sans downtime

```sql
-- Activer slow query log temporairement pour investigation
SET GLOBAL slow_query_log = ON;
SET GLOBAL long_query_time = 1;
SET GLOBAL log_queries_not_using_indexes = ON;

-- Apr√®s investigation
SET GLOBAL slow_query_log = OFF;
SET GLOBAL log_queries_not_using_indexes = OFF;
```

#### 3. S√©curit√© (mixte : certaines dynamiques)

```sql
-- Variables de s√©curit√© modifiables √† chaud
SHOW VARIABLES WHERE Variable_name IN (
  'require_secure_transport',     -- ‚úÖ Dynamique (11.8)
  'max_connect_errors',           -- ‚úÖ Dynamique
  'max_password_errors'           -- ‚úÖ Dynamique
);
```

‚ö†Ô∏è **Attention** : Certaines variables de s√©curit√© critiques sont statiques pour des raisons de coh√©rence.

#### 4. InnoDB dynamiques

```sql
-- Variables InnoDB modifiables sans red√©marrage
SELECT VARIABLE_NAME, VARIABLE_VALUE
FROM information_schema.GLOBAL_VARIABLES
WHERE VARIABLE_NAME LIKE 'innodb%'
  AND VARIABLE_NAME IN (
    SELECT VARIABLE_NAME
    FROM information_schema.SYSTEM_VARIABLES
    WHERE IS_DYNAMIC = 'YES'
  )
ORDER BY VARIABLE_NAME;
```

**Exemples importants** :

```sql
SHOW VARIABLES WHERE Variable_name IN (
  'innodb_adaptive_hash_index',     -- ‚úÖ Dynamique
  'innodb_adaptive_flushing',       -- ‚úÖ Dynamique
  'innodb_io_capacity',             -- ‚úÖ Dynamique
  'innodb_io_capacity_max',         -- ‚úÖ Dynamique
  'innodb_max_dirty_pages_pct',    -- ‚úÖ Dynamique
  'innodb_thread_concurrency',     -- ‚úÖ Dynamique
  'innodb_purge_threads',          -- ‚úÖ Dynamique (certaines versions)
  'innodb_alter_copy_bulk'         -- ‚úÖ Dynamique (11.8)
);
```

#### 5. R√©plication (dynamiques)

```sql
-- Variables de r√©plication modifiables √† chaud
SHOW VARIABLES WHERE Variable_name IN (
  'slave_parallel_threads',        -- ‚úÖ Dynamique
  'slave_parallel_mode',           -- ‚úÖ Dynamique
  'rpl_semi_sync_master_timeout',  -- ‚úÖ Dynamique
  'sync_binlog',                   -- ‚úÖ Dynamique
  'expire_logs_days'               -- ‚úÖ Dynamique
);
```

#### 6. Nouveaut√©s MariaDB 11.8 (dynamiques)

```sql
-- üÜï Contr√¥le espace temporaire (11.8) - DYNAMIQUES
SHOW VARIABLES WHERE Variable_name IN (
  'max_tmp_space_usage',           -- ‚úÖ Dynamique
  'max_total_tmp_space_usage'      -- ‚úÖ Dynamique
);

-- Exemple d'ajustement √† chaud
SET GLOBAL max_tmp_space_usage = 10737418240;  -- 10GB
SET GLOBAL max_total_tmp_space_usage = 53687091200;  -- 50GB
```

### Strat√©gie de modification pour variables dynamiques

```sql
-- 1. Sauvegarder la valeur actuelle
SET @old_value := @@GLOBAL.max_connections;

-- 2. Documenter le changement
-- Ajouter un commentaire dans un fichier de log ou syst√®me de ticketing

-- 3. Appliquer le changement
SET GLOBAL max_connections = 1500;

-- 4. Valider
SELECT @@GLOBAL.max_connections;

-- 5. Monitoring pendant 24-48h
-- Surveiller les m√©triques de performance

-- 6. Si OK, persister
SET PERSIST max_connections = 1500;
-- OU modifier my.cnf pour approche plus traditionnelle

-- 7. En cas de probl√®me, rollback imm√©diat
-- SET GLOBAL max_connections = @old_value;
```

---

## Variables statiques : Red√©marrage requis

### Caract√©ristiques

Les variables statiques n√©cessitent une **planification rigoureuse** :

- ‚ùå Non modifiables avec `SET GLOBAL`
- üîÑ Red√©marrage obligatoire pour application
- üìã Planification maintenance n√©cessaire
- ‚è±Ô∏è Downtime incompressible
- üéØ Impact potentiel sur la disponibilit√©

### Variables statiques critiques

#### 1. M√©moire et structure InnoDB (statiques)

```sql
-- Variables m√©moire InnoDB - TOUTES STATIQUES
SELECT VARIABLE_NAME, VARIABLE_VALUE
FROM information_schema.GLOBAL_VARIABLES
WHERE VARIABLE_NAME IN (
  'innodb_buffer_pool_size',       -- ‚ùå Statique (CRITIQUE)
  'innodb_buffer_pool_instances',  -- ‚ùå Statique
  'innodb_buffer_pool_chunk_size', -- ‚ùå Statique
  'innodb_log_file_size',          -- ‚ùå Statique
  'innodb_log_buffer_size'         -- ‚ùå Statique
)
ORDER BY VARIABLE_NAME;
```

**V√©rification** :

```sql
-- Tentative de modification (√©chouera)
SET GLOBAL innodb_buffer_pool_size = 17179869184;
-- ERROR 1238 (HY000): Variable 'innodb_buffer_pool_size' is a read only variable
```

üí° **Impact** : `innodb_buffer_pool_size` est probablement la variable la plus critique √† dimensionner correctement d√®s le d√©part, car sa modification n√©cessite un red√©marrage.

#### 2. Chemins et emplacements (statiques)

```sql
-- Chemins syst√®me - TOUS STATIQUES
SHOW VARIABLES WHERE Variable_name IN (
  'datadir',                       -- ‚ùå Statique
  'tmpdir',                        -- ‚ùå Statique
  'socket',                        -- ‚ùå Statique
  'pid_file',                      -- ‚ùå Statique
  'basedir',                       -- ‚ùå Statique
  'plugin_dir',                    -- ‚ùå Statique
  'log_bin_basename',              -- ‚ùå Statique
  'relay_log_basename'             -- ‚ùå Statique
);
```

‚ö†Ô∏è **Danger** : Modifier ces chemins sans pr√©paration ad√©quate peut emp√™cher le serveur de red√©marrer.

#### 3. Identit√© et r√©seau (statiques)

```sql
-- Configuration r√©seau et identit√© - STATIQUES
SHOW VARIABLES WHERE Variable_name IN (
  'port',                          -- ‚ùå Statique
  'bind_address',                  -- ‚ùå Statique
  'server_id',                     -- ‚ùå Statique (r√©plication)
  'hostname'                       -- ‚ùå Statique
);
```

**Impact r√©plication** : Modifier `server_id` n√©cessite un red√©marrage et peut n√©cessiter une reconfiguration de la r√©plication.

#### 4. Moteurs de stockage (statiques)

```sql
-- Configuration moteurs - STATIQUES
SHOW VARIABLES WHERE Variable_name IN (
  'default_storage_engine',        -- ‚ùå Statique (d√©faut session, mais global statique)
  'innodb_file_per_table',         -- ‚ùå Statique (affecte nouvelles tables)
  'innodb_page_size',              -- ‚ùå Statique (CRITIQUE - d√©finit au bootstrap)
  'innodb_undo_tablespaces'        -- ‚ùå Statique
);
```

‚ö†Ô∏è **CRITIQUE** : `innodb_page_size` ne peut √™tre chang√© qu'en r√©initialisant compl√®tement le datadir.

#### 5. Performance critiques (statiques)

```sql
-- Variables performance n√©cessitant red√©marrage
SHOW VARIABLES WHERE Variable_name IN (
  'key_buffer_size',               -- ‚ùå Statique (MyISAM)
  'query_cache_size',              -- ‚ùå Statique (d√©pr√©ci√©, devrait √™tre 0)
  'thread_stack'                   -- ‚ùå Statique
);
```

#### 6. Character sets par d√©faut (statiques au niveau serveur)

```sql
-- üÜï MariaDB 11.8 - Character sets par d√©faut
SHOW VARIABLES WHERE Variable_name IN (
  'character_set_server',          -- ‚ùå Statique (d√©faut serveur)
  'collation_server'               -- ‚ùå Statique (d√©faut serveur)
);

-- Note : Ces variables peuvent √™tre modifi√©es SESSION/par base/par table
-- Mais le d√©faut SERVEUR est statique
```

üí° **MariaDB 11.8** : `utf8mb4` avec `utf8mb4_unicode_ci` (UCA 14.0.0) est maintenant le d√©faut, mais modifier ce d√©faut serveur n√©cessite red√©marrage.

### Strat√©gie de modification pour variables statiques

#### √âtape 1 : Planification

```bash
# Documentation de la planification
cat > /var/log/mysql/maintenance-plan-2025-12-15.md <<EOF
# Maintenance MariaDB - Augmentation Buffer Pool

**Date planifi√©e** : 2025-12-15 02:00 UTC (fen√™tre de 1h)
**DBA** : John Doe
**Ticket** : OPS-5678

## Changements
- innodb_buffer_pool_size: 32G ‚Üí 64G
- innodb_buffer_pool_instances: 8 ‚Üí 16

## Raison
Augmentation de la charge, analyse montre 85% d'utilisation buffer pool

## Impact
- Downtime estim√© : 2-5 minutes
- Applications affect√©es : API Production, Dashboard
- Notification : √âquipes dev, ops, support

## Proc√©dure
1. Backup configuration actuelle
2. Modifier my.cnf
3. Valider syntaxe
4. Red√©marrer MariaDB
5. Valider d√©marrage et m√©triques
6. Rollback plan si probl√®me

## Tests pr√©alables
- Test√© sur staging le 2025-12-10
- Temps de red√©marrage observ√© : 3 minutes
- Aucune erreur d√©tect√©e

## Rollback plan
Si probl√®me : restaurer ancienne config et red√©marrer (5 min suppl√©mentaires)
EOF
```

#### √âtape 2 : Backup configuration

```bash
#!/bin/bash
# backup-config.sh

BACKUP_DIR="/var/backups/mysql/config"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

# Cr√©er r√©pertoire de backup
mkdir -p "$BACKUP_DIR"

# Backup configuration active
cp /etc/mysql/my.cnf "$BACKUP_DIR/my.cnf.$TIMESTAMP"
cp -r /etc/mysql/mariadb.conf.d "$BACKUP_DIR/mariadb.conf.d.$TIMESTAMP"

# Backup variables actuelles
mysql -e "SHOW GLOBAL VARIABLES" > "$BACKUP_DIR/variables.$TIMESTAMP.txt"

# Cr√©er script de rollback
cat > "$BACKUP_DIR/rollback.$TIMESTAMP.sh" <<'ROLLBACK'
#!/bin/bash
echo "Rolling back to configuration from $TIMESTAMP"
cp /var/backups/mysql/config/my.cnf.$TIMESTAMP /etc/mysql/my.cnf
cp -r /var/backups/mysql/config/mariadb.conf.d.$TIMESTAMP/* /etc/mysql/mariadb.conf.d/
systemctl restart mariadb
echo "Rollback complete"
ROLLBACK

chmod +x "$BACKUP_DIR/rollback.$TIMESTAMP.sh"

echo "‚úÖ Backup created in $BACKUP_DIR"
```

#### √âtape 3 : Modification configuration

```bash
# Modifier la configuration
vim /etc/mysql/mariadb.conf.d/50-server.cnf
```

```ini
# /etc/mysql/mariadb.conf.d/50-server.cnf

[mysqld]
# === InnoDB Buffer Pool ===
# Modifi√© le 2025-12-15 par John Doe (OPS-5678)
# Ancienne valeur : 32G
# Nouvelle valeur : 64G
innodb_buffer_pool_size = 64G

# Modifi√© en cons√©quence
# Ancienne valeur : 8
# Nouvelle valeur : 16
innodb_buffer_pool_instances = 16
```

#### √âtape 4 : Validation syntaxe

```bash
#!/bin/bash
# validate-config.sh

echo "Validating MariaDB configuration..."

# Test syntaxe
mysqld --verbose --help > /dev/null 2>&1

if [ $? -eq 0 ]; then
    echo "‚úÖ Configuration syntax is valid"

    # Afficher les nouvelles valeurs qui seront charg√©es
    echo ""
    echo "New values that will be loaded:"
    mysqld --verbose --help 2>/dev/null | grep -E "(innodb_buffer_pool_size|innodb_buffer_pool_instances)" | head -2

    exit 0
else
    echo "‚ùå Configuration syntax error!"
    echo "Check /var/log/mysql/error.log for details"
    exit 1
fi
```

#### √âtape 5 : Red√©marrage avec monitoring

```bash
#!/bin/bash
# restart-with-monitoring.sh

# Fonction pour v√©rifier le d√©marrage
check_startup() {
    local max_wait=300  # 5 minutes max
    local elapsed=0

    while [ $elapsed -lt $max_wait ]; do
        if mysqladmin ping >/dev/null 2>&1; then
            return 0
        fi
        sleep 2
        elapsed=$((elapsed + 2))
    done
    return 1
}

echo "=== MariaDB Restart avec monitoring ==="
echo "Start time: $(date)"

# M√©triques pr√©-red√©marrage
echo ""
echo "Pre-restart metrics:"
mysql -e "SHOW GLOBAL STATUS LIKE 'Uptime';"
mysql -e "SHOW GLOBAL STATUS LIKE 'Threads_connected';"

# Red√©marrer
echo ""
echo "Restarting MariaDB..."
systemctl restart mariadb

# Attendre d√©marrage
echo "Waiting for MariaDB to start..."
if check_startup; then
    echo "‚úÖ MariaDB started successfully"

    # Validation post-d√©marrage
    echo ""
    echo "Post-restart validation:"

    # V√©rifier nouvelles valeurs
    mysql -e "SELECT @@innodb_buffer_pool_size / 1024 / 1024 / 1024 AS buffer_pool_gb;"
    mysql -e "SELECT @@innodb_buffer_pool_instances AS buffer_pool_instances;"

    # V√©rifier log d'erreur
    echo ""
    echo "Last 20 lines of error log:"
    tail -20 /var/log/mysql/error.log

    # V√©rifier connectivit√©
    mysql -e "SELECT 'Connection OK' AS status;"

    echo ""
    echo "End time: $(date)"
    echo "‚úÖ Restart completed successfully"
    exit 0
else
    echo "‚ùå MariaDB failed to start!"
    echo "Check /var/log/mysql/error.log"
    echo ""
    echo "Initiating rollback..."
    /var/backups/mysql/config/rollback.*.sh
    exit 1
fi
```

#### √âtape 6 : Validation post-red√©marrage

```sql
-- Script de validation post-red√©marrage
-- validation.sql

-- 1. V√©rifier que les nouvelles valeurs sont charg√©es
SELECT 'Buffer Pool Size Check' AS test,
       @@innodb_buffer_pool_size / 1024 / 1024 / 1024 AS actual_gb,
       64 AS expected_gb,
       CASE
         WHEN @@innodb_buffer_pool_size / 1024 / 1024 / 1024 = 64
         THEN '‚úÖ PASS'
         ELSE '‚ùå FAIL'
       END AS status;

SELECT 'Buffer Pool Instances Check' AS test,
       @@innodb_buffer_pool_instances AS actual,
       16 AS expected,
       CASE
         WHEN @@innodb_buffer_pool_instances = 16
         THEN '‚úÖ PASS'
         ELSE '‚ùå FAIL'
       END AS status;

-- 2. V√©rifier le statut InnoDB
SHOW ENGINE INNODB STATUS\G

-- 3. V√©rifier qu'il n'y a pas d'erreurs critiques
SELECT COUNT(*) AS error_count
FROM performance_schema.error_log
WHERE logged >= DATE_SUB(NOW(), INTERVAL 10 MINUTE)
  AND error_code IN ('MY-000000', 'MY-013183');  -- Erreurs critiques

-- 4. Tester une requ√™te simple
SELECT 'Database operational' AS status, NOW() AS timestamp;
```

---

## Comparaison d√©taill√©e : Dynamique vs Statique

### Tableau r√©capitulatif

| Crit√®re | Variables Dynamiques | Variables Statiques |
|---------|---------------------|---------------------|
| **Modification** | `SET GLOBAL variable = value` | Modification `my.cnf` + red√©marrage |
| **Downtime** | Aucun | Oui (2-10 minutes typiquement) |
| **Effet** | Imm√©diat | Au prochain d√©marrage |
| **Rollback** | Instantan√© | N√©cessite nouveau red√©marrage |
| **Persistance** | Utiliser `SET PERSIST` ou `my.cnf` | Automatique via `my.cnf` |
| **Risque** | Faible (rollback facile) | Moyen (erreur config peut emp√™cher d√©marrage) |
| **Planification** | Optionnelle | Obligatoire (fen√™tre maintenance) |
| **Testing** | Test sur serveur live possible | N√©cessite environnement test |

### Impact sur la disponibilit√©

#### Variables dynamiques : HA-friendly

```sql
-- Sc√©nario : Cluster Galera 3 n≈ìuds
-- Modification rolling sans downtime global

-- Node 1
SET GLOBAL max_connections = 2000;

-- Node 2 (apr√®s v√©rification Node 1 OK)
SET GLOBAL max_connections = 2000;

-- Node 3 (apr√®s v√©rification Node 2 OK)
SET GLOBAL max_connections = 2000;

-- Downtime total : 0
-- Applications : Aucune interruption (basculement sur n≈ìuds actifs)
```

#### Variables statiques : Downtime required

```bash
# Sc√©nario : Modification innodb_buffer_pool_size sur Galera

# Option 1 : Rolling restart (downtime partiel)
# Node 1 : Modifier config + red√©marrage (5 min downtime node 1)
# Node 2 : Modifier config + red√©marrage (5 min downtime node 2)
# Node 3 : Modifier config + red√©marrage (5 min downtime node 3)
# Downtime total cluster : 0 (mais capacit√© r√©duite temporairement)

# Option 2 : Downtime complet (plus rapide)
# Arr√™t tous n≈ìuds ‚Üí Modification ‚Üí Red√©marrage
# Downtime total : 5-10 minutes
# Avantage : Plus simple, moins de risque de d√©synchronisation
```

---

## Cas particuliers et exceptions

### 1. Variables semi-dynamiques

Certaines variables sont "techniquement" modifiables mais avec des effets limit√©s ou diff√©r√©s.

```sql
-- Exemple : innodb_file_per_table
SHOW VARIABLES LIKE 'innodb_file_per_table';

-- Cette variable est modifiable dynamiquement
SET GLOBAL innodb_file_per_table = ON;

-- MAIS : Affecte uniquement les NOUVELLES tables
-- Les tables existantes conservent leur format
```

**Impact** : Modification appliqu√©e, mais effet progressif.

### 2. Variables avec effet diff√©r√©

```sql
-- Exemple : innodb_max_dirty_pages_pct
SET GLOBAL innodb_max_dirty_pages_pct = 50;

-- Effet : Progressif (flushing adapt√© graduellement)
-- Pas instantan√© comme max_connections
```

### 3. Variables n√©cessitant red√©marrage complet du cluster

```sql
-- Certaines variables Galera n√©cessitent red√©marrage coordonn√©
SHOW VARIABLES LIKE 'wsrep_cluster_address';
-- Statique : Modification n√©cessite red√©marrage de tous les n≈ìuds
```

### 4. Variables d√©pendantes

Certaines variables sont li√©es :

```sql
-- innodb_buffer_pool_size et innodb_buffer_pool_instances
-- Relation : instances ne peut pas exc√©der buffer_pool_size / 1GB

-- Si buffer_pool_size = 8GB
SET GLOBAL innodb_buffer_pool_instances = 16;
-- ‚ùå Impossible : Max 8 instances pour 8GB
```

---

## Strat√©gies de migration z√©ro-downtime

### Sc√©nario 1 : Augmenter buffer pool sans downtime (Galera)

```bash
#!/bin/bash
# rolling-buffer-pool-upgrade.sh

NODES=("node1" "node2" "node3")
NEW_BUFFER_POOL="64G"

for NODE in "${NODES[@]}"; do
    echo "=== Processing $NODE ==="

    # 1. V√©rifier que le cluster est sain
    ssh $NODE "mysql -e \"SHOW STATUS LIKE 'wsrep_cluster_size';\""

    # 2. Modifier configuration
    ssh $NODE "sed -i 's/innodb_buffer_pool_size.*/innodb_buffer_pool_size = $NEW_BUFFER_POOL/' /etc/mysql/mariadb.conf.d/50-server.cnf"

    # 3. Red√©marrer n≈ìud
    ssh $NODE "systemctl restart mariadb"

    # 4. Attendre que le n≈ìud rejoigne le cluster
    sleep 30
    ssh $NODE "mysql -e \"SHOW STATUS LIKE 'wsrep_local_state_comment';\" | grep Synced"

    if [ $? -eq 0 ]; then
        echo "‚úÖ $NODE upgraded and synced"
    else
        echo "‚ùå $NODE failed to sync! Aborting."
        exit 1
    fi

    # 5. Attendre stabilisation avant n≈ìud suivant
    sleep 60
done

echo "‚úÖ All nodes upgraded successfully"
```

### Sc√©nario 2 : Migration avec ProxySQL (Master-Replica)

```sql
-- Configuration ProxySQL pour basculement transparent

-- 1. Pr√©parer replica avec nouvelle config
-- Sur replica : modifier my.cnf avec innodb_buffer_pool_size = 64G
-- Red√©marrer replica (applications sur master, pas d'impact)

-- 2. V√©rifier que replica est √† jour
SHOW SLAVE STATUS\G

-- 3. Basculer traffic sur replica via ProxySQL
-- ProxySQL : Promouvoir replica en writer

-- 4. Modifier ancien master (maintenant reader)
-- Modifier my.cnf, red√©marrer (pas d'impact, traffic sur nouveau master)

-- 5. Reconfigurer r√©plication et rollback ProxySQL si souhait√©
```

---

## Monitoring et validation

### Monitoring pr√© et post modification

```sql
-- Script de monitoring √† ex√©cuter avant/apr√®s
CREATE TABLE IF NOT EXISTS config_changes_log (
    change_id INT AUTO_INCREMENT PRIMARY KEY,
    timestamp DATETIME DEFAULT CURRENT_TIMESTAMP,
    variable_name VARCHAR(64),
    old_value VARCHAR(1024),
    new_value VARCHAR(1024),
    is_dynamic BOOLEAN,
    changed_by VARCHAR(64),
    notes TEXT
);

-- Proc√©dure pour logger changement
DELIMITER $$
CREATE PROCEDURE log_config_change(
    IN p_variable VARCHAR(64),
    IN p_old_value VARCHAR(1024),
    IN p_new_value VARCHAR(1024),
    IN p_notes TEXT
)
BEGIN
    DECLARE v_is_dynamic BOOLEAN;

    SELECT IS_DYNAMIC = 'YES' INTO v_is_dynamic
    FROM information_schema.SYSTEM_VARIABLES
    WHERE VARIABLE_NAME = p_variable;

    INSERT INTO config_changes_log
        (variable_name, old_value, new_value, is_dynamic, changed_by, notes)
    VALUES
        (p_variable, p_old_value, p_new_value, v_is_dynamic, USER(), p_notes);
END$$
DELIMITER ;

-- Utilisation
CALL log_config_change(
    'max_connections',
    '500',
    '1000',
    'Increased due to Black Friday traffic spike - Ticket OPS-1234'
);
```

### V√©rification automatique post-restart

```bash
#!/bin/bash
# post-restart-check.sh

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo "=== Post-Restart Configuration Check ==="

# Fonction de test
test_variable() {
    local var_name=$1
    local expected_value=$2
    local actual_value=$(mysql -N -e "SELECT @@GLOBAL.$var_name;")

    if [ "$actual_value" == "$expected_value" ]; then
        echo -e "${GREEN}‚úÖ${NC} $var_name: $actual_value (expected: $expected_value)"
        return 0
    else
        echo -e "${RED}‚ùå${NC} $var_name: $actual_value (expected: $expected_value)"
        return 1
    fi
}

# Tests
FAILED=0

test_variable "innodb_buffer_pool_size" "68719476736" || ((FAILED++))  # 64GB
test_variable "innodb_buffer_pool_instances" "16" || ((FAILED++))
test_variable "max_connections" "2000" || ((FAILED++))

# V√©rifier erreurs r√©centes
echo ""
echo "=== Recent Errors ==="
mysql -e "SELECT logged, error_code, subsystem, data
          FROM performance_schema.error_log
          WHERE logged >= DATE_SUB(NOW(), INTERVAL 10 MINUTE)
          ORDER BY logged DESC
          LIMIT 10;"

# R√©sultat
echo ""
if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}All checks passed!${NC}"
    exit 0
else
    echo -e "${RED}$FAILED check(s) failed!${NC}"
    exit 1
fi
```

---

## Checklist de modification de variables

### Pour variables dynamiques

- [ ] Identifier la variable et confirmer qu'elle est dynamique
- [ ] Documenter la raison du changement (ticket, issue)
- [ ] Sauvegarder la valeur actuelle
- [ ] Tester sur environnement de staging si possible
- [ ] Appliquer avec `SET GLOBAL`
- [ ] Valider imm√©diatement
- [ ] Monitorer pendant 24-48h
- [ ] Si OK, persister avec `SET PERSIST` ou modifier `my.cnf`
- [ ] Documenter dans changelog

### Pour variables statiques

- [ ] Planifier fen√™tre de maintenance
- [ ] Notifier les √©quipes concern√©es
- [ ] Backup configuration actuelle
- [ ] Tester sur environnement de staging
- [ ] Documenter proc√©dure et rollback plan
- [ ] Pr√©parer script de validation
- [ ] Modifier `my.cnf`
- [ ] Valider syntaxe avec `mysqld --help --verbose`
- [ ] Red√©marrer MariaDB
- [ ] Valider d√©marrage et variables
- [ ] Ex√©cuter tests fonctionnels
- [ ] Monitorer m√©triques post-red√©marrage
- [ ] Documenter dans changelog

---

## Erreurs courantes et r√©solution

### Erreur 1 : Tentative de modification variable statique

```sql
SET GLOBAL innodb_buffer_pool_size = 68719476736;
-- ERROR 1238 (HY000): Variable 'innodb_buffer_pool_size' is a read only variable
```

**Solution** :

```bash
# 1. V√©rifier que la variable est bien statique
mysql -e "SELECT IS_DYNAMIC FROM information_schema.SYSTEM_VARIABLES
          WHERE VARIABLE_NAME = 'innodb_buffer_pool_size';"

# 2. Modifier my.cnf
vim /etc/mysql/mariadb.conf.d/50-server.cnf
# innodb_buffer_pool_size = 64G

# 3. Red√©marrer
systemctl restart mariadb
```

### Erreur 2 : Configuration invalide emp√™che d√©marrage

```bash
# Sympt√¥me : MariaDB ne d√©marre pas apr√®s modification
systemctl status mariadb
# ‚óè mariadb.service - MariaDB database server
#    Loaded: loaded
#    Active: failed

# Log d'erreur
tail -50 /var/log/mysql/error.log
# [ERROR] InnoDB: Cannot allocate 128GB for buffer pool
```

**Solution** :

```bash
# 1. Restaurer configuration pr√©c√©dente
cp /var/backups/mysql/config/my.cnf.20251213 /etc/mysql/my.cnf

# 2. Red√©marrer
systemctl restart mariadb

# 3. Corriger la configuration (valeur r√©aliste)
vim /etc/mysql/mariadb.conf.d/50-server.cnf
# innodb_buffer_pool_size = 64G  (pas 128G)

# 4. Valider AVANT red√©marrage
mysqld --verbose --help > /dev/null 2>&1 && echo "Config OK" || echo "Config ERROR"
```

### Erreur 3 : Valeur hors limites

```sql
SET GLOBAL max_connections = 1000000;
-- Query OK (mais valeur tronqu√©e √† la limite max)

SELECT @@GLOBAL.max_connections;
-- 100000  (limite syst√®me atteinte)
```

**Solution** : Conna√Ætre les limites syst√®me

```sql
-- V√©rifier les limites d'une variable
SELECT VARIABLE_NAME,
       MIN_VALUE,
       MAX_VALUE,
       DEFAULT_VALUE
FROM information_schema.SYSTEM_VARIABLES
WHERE VARIABLE_NAME = 'max_connections';
```

---

## Liste de r√©f√©rence rapide

### Variables dynamiques essentielles

```sql
-- Performance
max_connections                    -- ‚úÖ Dynamique
thread_cache_size                  -- ‚úÖ Dynamique
table_open_cache                   -- ‚úÖ Dynamique
thread_pool_size                   -- ‚úÖ Dynamique (11.8)

-- InnoDB
innodb_io_capacity                 -- ‚úÖ Dynamique
innodb_max_dirty_pages_pct         -- ‚úÖ Dynamique
innodb_adaptive_hash_index         -- ‚úÖ Dynamique
innodb_alter_copy_bulk             -- ‚úÖ Dynamique (11.8)

-- Logging
slow_query_log                     -- ‚úÖ Dynamique
general_log                        -- ‚úÖ Dynamique
long_query_time                    -- ‚úÖ Dynamique

-- R√©plication
sync_binlog                        -- ‚úÖ Dynamique
expire_logs_days                   -- ‚úÖ Dynamique

-- üÜï MariaDB 11.8
max_tmp_space_usage                -- ‚úÖ Dynamique
max_total_tmp_space_usage          -- ‚úÖ Dynamique
```

### Variables statiques essentielles

```sql
-- M√©moire InnoDB
innodb_buffer_pool_size            -- ‚ùå Statique
innodb_buffer_pool_instances       -- ‚ùå Statique
innodb_log_file_size               -- ‚ùå Statique
innodb_log_buffer_size             -- ‚ùå Statique

-- Chemins
datadir                            -- ‚ùå Statique
tmpdir                             -- ‚ùå Statique
socket                             -- ‚ùå Statique

-- R√©seau
port                               -- ‚ùå Statique
bind_address                       -- ‚ùå Statique

-- Identit√©
server_id                          -- ‚ùå Statique
hostname                           -- ‚ùå Statique

-- Structure
innodb_page_size                   -- ‚ùå Statique (CRITIQUE)

-- üÜï MariaDB 11.8 (d√©fauts serveur)
character_set_server               -- ‚ùå Statique
collation_server                   -- ‚ùå Statique
```

---

## ‚úÖ Points cl√©s √† retenir

- **Variables dynamiques** : Modifiables sans red√©marrage avec `SET GLOBAL`, aucun downtime
- **Variables statiques** : N√©cessitent modification `my.cnf` + red√©marrage obligatoire
- **V√©rification** : Utiliser `IS_DYNAMIC` dans `information_schema.SYSTEM_VARIABLES`
- **Persistance** : `SET GLOBAL` n'est pas persistant, utiliser `SET PERSIST` ou `my.cnf`
- **Planification** : Variables statiques n√©cessitent fen√™tre de maintenance et communication
- **Rollback** : Dynamiques = instantan√©, statiques = nouveau red√©marrage requis
- **Testing** : Toujours tester sur staging avant production
- **Documentation** : Logger tous les changements avec raison et contexte
- **Buffer Pool** : Variable la plus critique, statique, planifier soigneusement
- **MariaDB 11.8** : Nouvelles variables de contr√¥le temporaire sont dynamiques (flexibilit√©)
- **HA** : Variables dynamiques permettent rolling updates sans downtime global

---

## üîó Ressources et r√©f√©rences

- [üìñ Documentation officielle : Dynamic System Variables](https://mariadb.com/kb/en/dynamic-system-variables/)
- [üìñ Documentation officielle : Server System Variables](https://mariadb.com/kb/en/server-system-variables/)
- [üìñ INFORMATION_SCHEMA.SYSTEM_VARIABLES](https://mariadb.com/kb/en/information-schema-system_variables-table/)
- [üìñ SET Statement](https://mariadb.com/kb/en/set/)
- [üìñ MariaDB 11.8 Release Notes](https://mariadb.com/kb/en/mariadb-11-8-0-release-notes/)
- [Blog : Managing MariaDB Configuration Changes](https://mariadb.org/configuration-changes-best-practices/)

---

## ‚û°Ô∏è Section suivante

**11.3 - Modes SQL (sql_mode)** : Exploration approfondie des modes SQL MariaDB, leur impact sur le comportement du serveur, la compatibilit√© avec MySQL, et les meilleures pratiques pour choisir le bon mode selon le cas d'usage.

‚è≠Ô∏è [Modes SQL (sql_mode)](/11-administration-configuration/03-modes-sql.md)
