üîù Retour au [Sommaire](/SOMMAIRE.md)

# 11.4.3 General log

> **Niveau** : Avanc√© (DBA/Administrateur Syst√®me)  
> **Dur√©e estim√©e** : 1.5 heures  
> **Pr√©requis** : 11.4.1 - Error log, 11.4.2 - Slow query log, administration MariaDB

## üéØ Objectifs d'apprentissage

√Ä l'issue de cette section, vous serez capable de :
- Comprendre le r√¥le et les cas d'usage du general log
- Activer et d√©sactiver le general log de mani√®re s√©curis√©e
- Analyser le contenu du general log pour l'audit et le debugging
- Mesurer et minimiser l'impact sur les performances
- Utiliser des alternatives moins co√ªteuses (Performance Schema, audit plugin)
- Appliquer les bonnes pratiques pour √©viter les probl√®mes en production
- Impl√©menter des strat√©gies de filtrage pour r√©duire le volume de donn√©es
- G√©rer les aspects s√©curit√© et conformit√© li√©s au general log

---

## Introduction

Le **general log** enregistre **TOUTES** les requ√™tes ex√©cut√©es par le serveur MariaDB, qu'elles soient lentes ou rapides, avec ou sans erreur.

### Diff√©rence avec les autres logs

| Log | Contenu | Overhead | Usage |
|-----|---------|----------|-------|
| **Error log** | Erreurs, warnings, d√©marrages | Minimal (~0%) | Production permanente |
| **Slow query log** | Requ√™tes > seuil de temps | Tr√®s faible (~1%) | Production permanente |
| **General log** | TOUTES les requ√™tes | **TR√àS √âLEV√â (10-30%)** | Temporaire uniquement |
| **Binary log** | Modifications de donn√©es | Faible (2-5%) | Production (r√©plication) |

‚ö†Ô∏è **AVERTISSEMENT CRITIQUE** : Le general log a un **impact significatif sur les performances** et ne doit **JAMAIS** √™tre activ√© en permanence en production. Son usage est limit√© √† des p√©riodes courtes de debugging, audit ou investigation forensique.

### Cas d'usage l√©gitimes

1. üîç **Debugging applicatif** : Voir exactement quelles requ√™tes sont ex√©cut√©es
2. üîê **Audit de s√©curit√©** : Investigation apr√®s incident de s√©curit√©
3. üìä **Analyse de trafic** : Comprendre les patterns d'utilisation
4. üêõ **Troubleshooting complexe** : Diagnostiquer comportement inattendu
5. üìù **Conformit√©** : Audit trail pour certaines r√©glementations (temporaire)

üí° **R√®gle d'or** : Si vous devez activer le general log, planifiez comment et quand le d√©sactiver.

---

## Configuration

### Activation dans my.cnf (d√©marrage)

```ini
# /etc/mysql/mariadb.conf.d/50-server.cnf

[mysqld]
# === General Log Configuration ===

# ‚ö†Ô∏è NE PAS ACTIVER EN PRODUCTION PAR D√âFAUT
# D√©commenter uniquement pour debugging temporaire

# Activer general log
# general_log = 1

# Emplacement du fichier
# general_log_file = /var/log/mysql/general.log

# OU envoyer vers table (plus flexible mais encore plus lent)
# log_output = TABLE  # mysql.general_log
# log_output = FILE   # D√©faut, vers fichier
# log_output = FILE,TABLE  # Les deux
```

‚ö†Ô∏è **Important** : Si activ√© dans `my.cnf`, il sera actif **√† chaque d√©marrage**. Pr√©f√©rer l'activation dynamique.

### Activation dynamique (RECOMMAND√â)

```sql
-- V√©rifier l'√©tat actuel
SHOW VARIABLES LIKE 'general_log%';

-- R√©sultat :
+------------------+---------------------------+
| Variable_name    | Value                     |
+------------------+---------------------------+
| general_log      | OFF                       |
| general_log_file | /var/log/mysql/general.log|
+------------------+---------------------------+

-- Activer temporairement
SET GLOBAL general_log = ON;

-- Sp√©cifier l'emplacement si n√©cessaire
SET GLOBAL general_log_file = '/var/log/mysql/general-debug.log';

-- D√©finir la sortie (FILE ou TABLE)
SET GLOBAL log_output = 'FILE';  -- Recommand√© pour performance
-- OU
SET GLOBAL log_output = 'TABLE'; -- Plus lent mais requ√™table
```

### D√©sactivation (CRUCIAL)

```sql
-- TOUJOURS d√©sactiver apr√®s usage
SET GLOBAL general_log = OFF;

-- V√©rifier
SHOW VARIABLES LIKE 'general_log';
-- general_log = OFF ‚úÖ
```

üí° **Best practice** : Utiliser un script avec timeout automatique

```bash
#!/bin/bash
# enable-general-log-with-timeout.sh

DURATION=${1:-300}  # D√©faut 5 minutes

echo "Activating general log for $DURATION seconds..."
mysql -e "SET GLOBAL general_log = ON;"

# Attendre
sleep $DURATION

# D√©sactiver automatiquement
echo "Disabling general log..."
mysql -e "SET GLOBAL general_log = OFF;"

echo "General log disabled successfully"
```

Usage :

```bash
# Activer pour 60 secondes
./enable-general-log-with-timeout.sh 60
```

---

## Format et contenu du log

### Format FILE (fichier)

#### Structure standard

```
Time                 Id Command    Argument
2025-12-13 14:30:15  123 Connect   webapp@192.168.1.100 on ecommerce using TCP/IP
2025-12-13 14:30:15  123 Query     SELECT * FROM users WHERE id = 42
2025-12-13 14:30:16  123 Query     UPDATE users SET last_login = NOW() WHERE id = 42
2025-12-13 14:30:16  123 Quit
```

#### Champs d√©taill√©s

| Champ | Description | Exemple |
|-------|-------------|---------|
| **Time** | Timestamp de la requ√™te | 2025-12-13 14:30:15 |
| **Id** | Thread ID (connection) | 123 |
| **Command** | Type de commande | Connect, Query, Quit, Init DB |
| **Argument** | D√©tails de la commande | SELECT * FROM ... |

#### Types de commandes

```
Connect    ‚Üí Nouvelle connexion
Query      ‚Üí Requ√™te SQL
Quit       ‚Üí D√©connexion
Init DB    ‚Üí USE database
Field List ‚Üí SHOW COLUMNS FROM table
Prepare    ‚Üí Prepared statement
Execute    ‚Üí Ex√©cution prepared statement
Close stmt ‚Üí Fermeture prepared statement
```

#### Exemple complet de session

```
2025-12-13 14:30:00  125 Connect   root@localhost on  using Socket
2025-12-13 14:30:01  125 Query     SELECT DATABASE()
2025-12-13 14:30:02  125 Init DB   ecommerce
2025-12-13 14:30:03  125 Query     SHOW TABLES
2025-12-13 14:30:05  125 Query     SELECT * FROM products WHERE category = 'electronics'
2025-12-13 14:30:06  125 Query     SELECT COUNT(*) FROM orders WHERE user_id = 42
2025-12-13 14:30:07  125 Query     UPDATE cart SET quantity = 2 WHERE cart_id = 789
2025-12-13 14:30:08  125 Quit
```

### Format TABLE (mysql.general_log)

```sql
-- Structure de la table
DESC mysql.general_log;

+----------------+------------------+------+-----+-------------------+
| Field          | Type             | Null | Key | Default           |
+----------------+------------------+------+-----+-------------------+
| event_time     | timestamp(6)     | NO   |     | CURRENT_TIMESTAMP |
| user_host      | mediumtext       | NO   |     | NULL              |
| thread_id      | bigint unsigned  | NO   |     | NULL              |
| server_id      | int unsigned     | NO   |     | NULL              |
| command_type   | varchar(64)      | NO   |     | NULL              |
| argument       | mediumblob       | NO   |     | NULL              |
+----------------+------------------+------+-----+-------------------+

-- Consulter les derni√®res requ√™tes
SELECT event_time,
       user_host,
       thread_id,
       command_type,
       CONVERT(argument USING utf8mb4) AS query
FROM mysql.general_log
ORDER BY event_time DESC
LIMIT 20;
```

**Avantages TABLE** :
- ‚úÖ Requ√™table avec SQL
- ‚úÖ Filtrage puissant
- ‚úÖ Analyse en temps r√©el

**Inconv√©nients TABLE** :
- ‚ùå Overhead encore plus √©lev√©
- ‚ùå Croissance rapide de la table
- ‚ùå N√©cessite purge r√©guli√®re

---

## Impact sur les performances

### Mesure de l'overhead

```bash
#!/bin/bash
# benchmark-general-log-impact.sh

echo "=== General Log Performance Impact Benchmark ==="

# Fonction de benchmark
run_benchmark() {
    local label=$1
    echo ""
    echo "Running: $label"
    sysbench oltp_read_write \
        --mysql-host=localhost \
        --mysql-user=root \
        --mysql-db=test \
        --tables=10 \
        --table-size=10000 \
        --threads=16 \
        --time=60 \
        --report-interval=10 \
        run | grep "transactions:"
}

# Benchmark 1: Sans general log
mysql -e "SET GLOBAL general_log = OFF;"
run_benchmark "WITHOUT general_log"

sleep 5

# Benchmark 2: Avec general log (FILE)
mysql -e "SET GLOBAL general_log = ON; SET GLOBAL log_output = 'FILE';"
run_benchmark "WITH general_log (FILE)"

sleep 5

# Benchmark 3: Avec general log (TABLE)
mysql -e "SET GLOBAL log_output = 'TABLE';"
run_benchmark "WITH general_log (TABLE)"

# Cleanup
mysql -e "SET GLOBAL general_log = OFF;"

echo ""
echo "=== Benchmark Complete ==="
```

**R√©sultats typiques** :

```
WITHOUT general_log:      10,000 TPS
WITH general_log (FILE):   7,000 TPS  (-30% ‚ö†Ô∏è)
WITH general_log (TABLE):  6,000 TPS  (-40% üî¥)
```

### Facteurs aggravants l'overhead

1. **Volume de requ√™tes** : Plus de requ√™tes = plus d'overhead
2. **I/O disque** : Disque lent = impact amplifi√©
3. **log_output = TABLE** : Pire que FILE
4. **Requ√™tes courtes** : Overhead proportionnellement plus visible
5. **Concurrent connections** : Contention sur √©criture du log

---

## Analyse du general log

### Analyse basique avec grep/awk

```bash
# Compter les requ√™tes par type
grep "Query" /var/log/mysql/general.log | wc -l

# Top 10 requ√™tes les plus fr√©quentes
grep "Query" /var/log/mysql/general.log | \
  awk '{$1=$2=$3=""; print $0}' | \
  sed 's/[0-9]\+/N/g' | sed "s/'[^']*'/X/g" | \
  sort | uniq -c | sort -rn | head -10

# Requ√™tes par utilisateur
grep "Connect" /var/log/mysql/general.log | \
  awk '{print $5}' | cut -d@ -f1 | sort | uniq -c | sort -rn

# Requ√™tes par base de donn√©es
grep "Init DB" /var/log/mysql/general.log | \
  awk '{print $4}' | sort | uniq -c | sort -rn
```

### Filtrer par p√©riode de temps

```bash
# Requ√™tes d'une heure sp√©cifique
grep "2025-12-13 14:" /var/log/mysql/general.log

# Requ√™tes entre deux timestamps
awk '/2025-12-13 14:00:00/,/2025-12-13 15:00:00/' /var/log/mysql/general.log
```

### Analyse avec SQL (log_output = TABLE)

```sql
-- Top 10 utilisateurs par nombre de requ√™tes
SELECT user_host,
       command_type,
       COUNT(*) AS query_count
FROM mysql.general_log
WHERE command_type = 'Query'
GROUP BY user_host, command_type
ORDER BY query_count DESC
LIMIT 10;

-- Requ√™tes sur une table sp√©cifique
SELECT event_time,
       user_host,
       CONVERT(argument USING utf8mb4) AS query
FROM mysql.general_log
WHERE command_type = 'Query'
  AND CONVERT(argument USING utf8mb4) LIKE '%FROM users%'
ORDER BY event_time DESC
LIMIT 20;

-- Distribution des types de commandes
SELECT command_type,
       COUNT(*) AS count,
       ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM mysql.general_log), 2) AS percentage
FROM mysql.general_log
GROUP BY command_type
ORDER BY count DESC;

-- Requ√™tes par heure
SELECT DATE_FORMAT(event_time, '%Y-%m-%d %H:00') AS hour,
       COUNT(*) AS query_count
FROM mysql.general_log
WHERE command_type = 'Query'
GROUP BY hour
ORDER BY hour DESC
LIMIT 24;
```

### Script d'analyse avanc√©e

```bash
#!/bin/bash
# analyze-general-log.sh

LOG_FILE="/var/log/mysql/general.log"
REPORT_FILE="/tmp/general-log-report-$(date +%Y%m%d_%H%M%S).txt"

echo "=== General Log Analysis Report ===" > $REPORT_FILE
echo "Generated: $(date)" >> $REPORT_FILE
echo "" >> $REPORT_FILE

# 1. Statistiques globales
echo "=== Global Statistics ===" >> $REPORT_FILE
echo "Total entries: $(wc -l < $LOG_FILE)" >> $REPORT_FILE
echo "Total queries: $(grep -c "Query" $LOG_FILE)" >> $REPORT_FILE
echo "Total connections: $(grep -c "Connect" $LOG_FILE)" >> $REPORT_FILE
echo "" >> $REPORT_FILE

# 2. Top 10 requ√™tes
echo "=== Top 10 Most Frequent Query Patterns ===" >> $REPORT_FILE
grep "Query" $LOG_FILE | \
  awk '{$1=$2=$3=""; print $0}' | \
  sed 's/[0-9]\+/N/g' | sed "s/'[^']*'/X/g" | \
  sort | uniq -c | sort -rn | head -10 >> $REPORT_FILE
echo "" >> $REPORT_FILE

# 3. Connexions par utilisateur
echo "=== Connections by User ===" >> $REPORT_FILE
grep "Connect" $LOG_FILE | \
  awk '{print $5}' | cut -d@ -f1 | sort | uniq -c | sort -rn >> $REPORT_FILE
echo "" >> $REPORT_FILE

# 4. Bases de donn√©es utilis√©es
echo "=== Databases Accessed ===" >> $REPORT_FILE
grep "Init DB" $LOG_FILE | \
  awk '{print $4}' | sort | uniq -c | sort -rn >> $REPORT_FILE
echo "" >> $REPORT_FILE

# 5. Distribution temporelle (par heure)
echo "=== Query Distribution by Hour ===" >> $REPORT_FILE
awk '{print $1" "$2}' $LOG_FILE | cut -d: -f1 | sort | uniq -c >> $REPORT_FILE

cat $REPORT_FILE
```

---

## Cas d'usage sp√©cifiques

### 1. Debugging application : Identifier toutes les requ√™tes d'une session

**Sc√©nario** : Une fonction de l'application ne fonctionne pas correctement.

```sql
-- Activer general log
SET GLOBAL general_log = ON;
SET GLOBAL log_output = 'TABLE';

-- L'utilisateur reproduit le bug...
-- (par exemple, avec thread_id = 12345)

-- Consulter toutes les requ√™tes de cette session
SELECT event_time,
       CONVERT(argument USING utf8mb4) AS query
FROM mysql.general_log
WHERE thread_id = 12345
  AND command_type = 'Query'
ORDER BY event_time;

-- D√©sactiver
SET GLOBAL general_log = OFF;
```

### 2. Audit de s√©curit√© : Rechercher activit√© suspecte

**Sc√©nario** : Investigation apr√®s d√©tection d'activit√© suspecte.

```bash
# Rechercher DROP, DELETE, TRUNCATE
grep -E "DROP|DELETE|TRUNCATE" /var/log/mysql/general.log

# Rechercher acc√®s √† table sensible
grep "FROM sensitive_data" /var/log/mysql/general.log

# Identifier toutes les requ√™tes d'une IP suspecte
grep "192.168.1.100" /var/log/mysql/general.log
```

Avec log_output = TABLE :

```sql
SELECT event_time,
       user_host,
       CONVERT(argument USING utf8mb4) AS query
FROM mysql.general_log
WHERE command_type = 'Query'
  AND (
    CONVERT(argument USING utf8mb4) LIKE '%DROP%'
    OR CONVERT(argument USING utf8mb4) LIKE '%DELETE%'
    OR CONVERT(argument USING utf8mb4) LIKE '%sensitive_data%'
  )
ORDER BY event_time DESC;
```

### 3. Analyse de trafic : Pattern d'utilisation

**Sc√©nario** : Comprendre comment une application utilise la base de donn√©es.

```sql
-- Activer pour 1 heure pendant heures de pointe
SET GLOBAL general_log = ON;

-- ... attendre 1 heure ...

-- Analyser
SELECT
    SUBSTRING_INDEX(CONVERT(argument USING utf8mb4), ' ', 1) AS query_type,
    COUNT(*) AS count,
    ROUND(COUNT(*) * 100.0 / (SELECT COUNT(*) FROM mysql.general_log WHERE command_type = 'Query'), 2) AS percentage
FROM mysql.general_log
WHERE command_type = 'Query'
GROUP BY query_type
ORDER BY count DESC;

-- R√©sultat :
-- SELECT:  65%
-- UPDATE:  20%
-- INSERT:  10%
-- DELETE:   5%

SET GLOBAL general_log = OFF;
```

### 4. Investigation forensique : Reconstruction d'√©v√©nements

**Sc√©nario** : Donn√©es corrompues, besoin de retrouver qui/quand/comment.

```sql
-- Rechercher toutes les modifications sur une table sp√©cifique
SELECT event_time,
       user_host,
       thread_id,
       CONVERT(argument USING utf8mb4) AS query
FROM mysql.general_log
WHERE command_type = 'Query'
  AND CONVERT(argument USING utf8mb4) REGEXP '(UPDATE|DELETE|INSERT).*critical_table'
ORDER BY event_time;
```

---

## Gestion de la table mysql.general_log

### Purge r√©guli√®re (CRITIQUE)

```sql
-- V√©rifier la taille de la table
SELECT
    table_name,
    ROUND(data_length / 1024 / 1024, 2) AS data_mb,
    ROUND(index_length / 1024 / 1024, 2) AS index_mb,
    ROUND((data_length + index_length) / 1024 / 1024, 2) AS total_mb,
    table_rows
FROM information_schema.TABLES
WHERE table_schema = 'mysql'
  AND table_name = 'general_log';

-- Si trop volumineuse (> 1GB) :
-- D√©sactiver temporairement le log
SET GLOBAL general_log = OFF;

-- Purger
TRUNCATE TABLE mysql.general_log;

-- OU garder seulement les derni√®res 24h
DELETE FROM mysql.general_log
WHERE event_time < DATE_SUB(NOW(), INTERVAL 24 HOUR);
```

### Archivage avant purge

```sql
-- Cr√©er table archive
CREATE TABLE mysql.general_log_archive LIKE mysql.general_log;

-- Copier anciennes entr√©es
INSERT INTO mysql.general_log_archive
SELECT * FROM mysql.general_log
WHERE event_time < DATE_SUB(NOW(), INTERVAL 7 DAY);

-- Purger la table principale
DELETE FROM mysql.general_log
WHERE event_time < DATE_SUB(NOW(), INTERVAL 7 DAY);

-- Exporter l'archive si n√©cessaire
-- mysqldump mysql general_log_archive > general_log_archive.sql
```

### Automatisation de la purge

```sql
-- Cr√©er √©v√©nement de purge automatique (toutes les 6 heures)
CREATE EVENT IF NOT EXISTS purge_general_log
ON SCHEDULE EVERY 6 HOUR
DO
BEGIN
    -- Seulement si general_log est activ√©
    IF @@GLOBAL.general_log = 1 THEN
        DELETE FROM mysql.general_log
        WHERE event_time < DATE_SUB(NOW(), INTERVAL 1 DAY);
    END IF;
END;

-- Activer l'event scheduler si n√©cessaire
SET GLOBAL event_scheduler = ON;
```

---

## Alternatives moins co√ªteuses

### 1. Performance Schema (RECOMMAND√â)

**Overhead** : Faible (2-5%)

```sql
-- Activer instrumentation
UPDATE performance_schema.setup_instruments
SET ENABLED = 'YES', TIMED = 'YES'
WHERE NAME LIKE 'statement/%';

-- Activer consumers
UPDATE performance_schema.setup_consumers
SET ENABLED = 'YES'
WHERE NAME LIKE '%statement%';

-- Voir les requ√™tes r√©centes
SELECT event_name,
       sql_text,
       timer_wait/1000000000000 AS exec_time_sec,
       lock_time/1000000000000 AS lock_time_sec
FROM performance_schema.events_statements_history
ORDER BY timer_end DESC
LIMIT 20;
```

**Avantages** :
- ‚úÖ Overhead acceptable
- ‚úÖ Riche en m√©triques
- ‚úÖ Peut rester activ√© en production

### 2. Audit Plugin (pour conformit√©)

**Overhead** : Moyen (5-10%)

```sql
-- Installer plugin audit
INSTALL SONAME 'server_audit';

-- Configurer
SET GLOBAL server_audit_logging = ON;
SET GLOBAL server_audit_events = 'CONNECT,QUERY,TABLE';
SET GLOBAL server_audit_file_path = '/var/log/mysql/audit.log';

-- Filtrer par utilisateur
SET GLOBAL server_audit_incl_users = 'admin,webapp';

-- OU exclure certains utilisateurs
SET GLOBAL server_audit_excl_users = 'monitoring,backup';
```

**Avantages** :
- ‚úÖ Con√ßu pour audit long terme
- ‚úÖ Filtrage granulaire
- ‚úÖ Rotation automatique
- ‚úÖ Format structur√©

### 3. Binary log (pour modifications uniquement)

```sql
-- Le binary log capture INSERT, UPDATE, DELETE
-- Mais PAS les SELECT

-- Voir les √©v√©nements r√©cents
SHOW BINLOG EVENTS IN 'mysql-bin.000123' LIMIT 20;

-- Extraire en SQL lisible
mysqlbinlog /var/log/mysql/mysql-bin.000123 | less
```

**Avantages** :
- ‚úÖ Overhead faible
- ‚úÖ N√©cessaire pour r√©plication
- ‚úÖ Point-in-time recovery

**Limitations** :
- ‚ùå Ne capture pas les SELECT

### Tableau comparatif

| M√©thode | Overhead | SELECT | DML | DDL | Production | Use Case |
|---------|----------|--------|-----|-----|------------|----------|
| **General log** | 10-30% | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå | Debug court |
| **Perf Schema** | 2-5% | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Monitoring |
| **Audit plugin** | 5-10% | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Conformit√© |
| **Binary log** | 2-5% | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | R√©plication |
| **Slow query log** | <1% | ‚ö†Ô∏è | ‚ö†Ô∏è | ‚ùå | ‚úÖ | Performance |

---

## Bonnes pratiques

### 1. JAMAIS en production continue

```ini
# ‚ùå MAUVAIS : Activer par d√©faut
[mysqld]
general_log = 1

# ‚úÖ BON : D√©sactiv√© par d√©faut
[mysqld]
general_log = 0  # Ou comment√©
```

### 2. Activation temporaire uniquement

```bash
# Script avec dur√©e limit√©e
mysql -e "SET GLOBAL general_log = ON;"
sleep 300  # 5 minutes max
mysql -e "SET GLOBAL general_log = OFF;"
```

### 3. Pr√©f√©rer FILE √† TABLE

```sql
-- ‚úÖ Plus performant
SET GLOBAL log_output = 'FILE';

-- ‚ùå Beaucoup plus lent
SET GLOBAL log_output = 'TABLE';
```

### 4. Surveiller la taille du fichier

```bash
#!/bin/bash
# monitor-general-log-size.sh

MAX_SIZE_MB=1000
LOG_FILE="/var/log/mysql/general.log"

while true; do
    SIZE_MB=$(du -m "$LOG_FILE" 2>/dev/null | cut -f1)

    if [ "$SIZE_MB" -gt "$MAX_SIZE_MB" ]; then
        echo "‚ö†Ô∏è  General log size: ${SIZE_MB}MB (exceeds ${MAX_SIZE_MB}MB)"
        echo "Disabling general log..."
        mysql -e "SET GLOBAL general_log = OFF;"
        break
    fi

    sleep 60
done
```

### 5. Rotation imm√©diate apr√®s usage

```bash
# Apr√®s d√©sactivation
mysqladmin flush-logs
mv /var/log/mysql/general.log /var/log/mysql/general.log.$(date +%Y%m%d_%H%M%S)
gzip /var/log/mysql/general.log.*
```

### 6. Documenter l'activation

```sql
-- Cr√©er table de logging
CREATE TABLE IF NOT EXISTS admin.general_log_activations (
    id INT AUTO_INCREMENT PRIMARY KEY,
    activated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    activated_by VARCHAR(64),
    reason TEXT,
    duration_seconds INT,
    deactivated_at DATETIME
);

-- Logger l'activation
INSERT INTO admin.general_log_activations
    (activated_by, reason, duration_seconds)
VALUES
    (USER(), 'Debugging payment gateway issue', 300);

-- Mettre √† jour apr√®s d√©sactivation
UPDATE admin.general_log_activations
SET deactivated_at = NOW()
WHERE id = LAST_INSERT_ID();
```

### 7. Utiliser alternatives quand possible

```
Besoin de debugging SELECT ?
  ‚Üí Performance Schema

Besoin d'audit conformit√© ?
  ‚Üí Audit Plugin

Besoin de voir modifications donn√©es ?
  ‚Üí Binary Log

General log = DERNIER RECOURS
```

---

## S√©curit√© et conformit√©

### Protection des donn√©es sensibles

Le general log peut contenir **des donn√©es sensibles** :
- Mots de passe en clair (si pass√©s dans requ√™tes)
- Donn√©es personnelles (RGPD, CCPA)
- Secrets API, tokens
- Num√©ros de carte bancaire

```sql
-- ‚ö†Ô∏è DANGER : Mots de passe en clair dans le log
CREATE USER 'newuser'@'localhost' IDENTIFIED BY 'SuperSecret123';
-- Le general log contiendra "SuperSecret123" !

-- ‚úÖ MIEUX : √âviter de passer credentials dans requ√™tes logg√©es
```

### Permissions strictes

```bash
# Le fichier general log doit √™tre prot√©g√©
sudo chown mysql:mysql /var/log/mysql/general.log
sudo chmod 600 /var/log/mysql/general.log

# V√©rifier
ls -l /var/log/mysql/general.log
# -rw------- 1 mysql mysql
```

### Purge s√©curis√©e

```bash
# Suppression s√©curis√©e (overwrite)
shred -vfz -n 3 /var/log/mysql/general.log.old

# Ou au minimum
rm -P /var/log/mysql/general.log.old  # Sur certains syst√®mes
```

### Chiffrement des archives

```bash
# Chiffrer avant archivage
gzip /var/log/mysql/general.log.20251213
gpg --symmetric --cipher-algo AES256 /var/log/mysql/general.log.20251213.gz

# R√©sultat : general.log.20251213.gz.gpg (chiffr√©)
rm /var/log/mysql/general.log.20251213.gz  # Supprimer non chiffr√©
```

---

## Troubleshooting

### Probl√®me 1 : Performances d√©grad√©es apr√®s activation

```sql
-- Sympt√¥mes : TPS r√©duit de 30-40%

-- V√©rifier que general log est la cause
SHOW VARIABLES LIKE 'general_log';
-- general_log = ON  ‚Üê Coupable

-- Solution imm√©diate
SET GLOBAL general_log = OFF;

-- V√©rifier am√©lioration
SHOW GLOBAL STATUS LIKE 'Threads_running';
SHOW GLOBAL STATUS LIKE 'Questions';
```

### Probl√®me 2 : Fichier general log gigantesque

```bash
# V√©rifier taille
du -h /var/log/mysql/general.log
# 50G ‚ö†Ô∏è‚ö†Ô∏è‚ö†Ô∏è

# Solution 1 : D√©sactiver imm√©diatement
mysql -e "SET GLOBAL general_log = OFF;"

# Solution 2 : Rotation urgente
mysqladmin flush-logs
mv /var/log/mysql/general.log /var/log/mysql/general.log.emergency
gzip /var/log/mysql/general.log.emergency &

# Solution 3 : Si espace disque critique
# Tronquer (PERTE DE DONN√âES)
> /var/log/mysql/general.log
```

### Probl√®me 3 : Table mysql.general_log trop volumineuse

```sql
-- V√©rifier
SELECT ROUND((data_length + index_length) / 1024 / 1024, 2) AS size_mb
FROM information_schema.TABLES
WHERE table_schema = 'mysql' AND table_name = 'general_log';
-- 10240 MB (10GB) ‚ö†Ô∏è

-- D√©sactiver
SET GLOBAL general_log = OFF;

-- Purger
TRUNCATE TABLE mysql.general_log;

-- V√©rifier
-- Size devrait √™tre quasi 0
```

### Probl√®me 4 : Impossible de d√©sactiver

```sql
-- Tentative
SET GLOBAL general_log = OFF;
-- ERROR 1227 (42000): Access denied

-- V√©rifier privil√®ges
SHOW GRANTS;

-- Solution : Se connecter avec compte SUPER
mysql -u root -p
SET GLOBAL general_log = OFF;
```

---

## Scripts utiles

### Script complet d'activation contr√¥l√©e

```bash
#!/bin/bash
# controlled-general-log.sh

DURATION=${1:-300}  # D√©faut 5 minutes
MAX_SIZE_MB=500
LOG_FILE="/var/log/mysql/general.log"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

echo "=== Controlled General Log Activation ==="
echo "Duration: $DURATION seconds"
echo "Max size: ${MAX_SIZE_MB}MB"
echo ""

# Fonction de cleanup
cleanup() {
    echo ""
    echo "Disabling general log..."
    mysql -e "SET GLOBAL general_log = OFF;"

    # Rotation
    mysqladmin flush-logs
    if [ -f "$LOG_FILE" ]; then
        mv "$LOG_FILE" "${LOG_FILE}.${TIMESTAMP}"
        gzip "${LOG_FILE}.${TIMESTAMP}" &
        echo "Log archived to: ${LOG_FILE}.${TIMESTAMP}.gz"
    fi

    echo "General log disabled successfully"
}

# Trap pour garantir d√©sactivation
trap cleanup EXIT INT TERM

# Activer
echo "Activating general log..."
mysql -e "SET GLOBAL general_log = ON; SET GLOBAL log_output = 'FILE';"

# Monitoring avec timeout
START_TIME=$(date +%s)
while true; do
    ELAPSED=$(($(date +%s) - START_TIME))

    # V√©rifier timeout
    if [ $ELAPSED -ge $DURATION ]; then
        echo "Duration limit reached ($DURATION seconds)"
        break
    fi

    # V√©rifier taille
    if [ -f "$LOG_FILE" ]; then
        SIZE_MB=$(du -m "$LOG_FILE" | cut -f1)
        if [ "$SIZE_MB" -gt "$MAX_SIZE_MB" ]; then
            echo "‚ö†Ô∏è  Size limit reached (${SIZE_MB}MB > ${MAX_SIZE_MB}MB)"
            break
        fi

        echo -ne "\rElapsed: ${ELAPSED}s | Size: ${SIZE_MB}MB"
    fi

    sleep 5
done

# cleanup() sera appel√© automatiquement via trap
```

### Script d'analyse post-capture

```bash
#!/bin/bash
# analyze-captured-general-log.sh

LOG_FILE=${1:-"/var/log/mysql/general.log"}
REPORT_DIR="/var/reports/general-log"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

mkdir -p $REPORT_DIR

echo "=== Analyzing General Log: $LOG_FILE ==="

# Rapport global
cat > $REPORT_DIR/summary-$TIMESTAMP.txt <<EOF
=== General Log Analysis ===
Generated: $(date)
Log file: $LOG_FILE
File size: $(du -h "$LOG_FILE" | cut -f1)

=== Statistics ===
Total lines: $(wc -l < "$LOG_FILE")
Total queries: $(grep -c "Query" "$LOG_FILE")
Total connections: $(grep -c "Connect" "$LOG_FILE")

=== Top 20 Query Patterns ===
EOF

grep "Query" "$LOG_FILE" | \
  awk '{$1=$2=$3=""; print $0}' | \
  sed 's/[0-9]\+/N/g' | sed "s/'[^']*'/X/g" | \
  sort | uniq -c | sort -rn | head -20 >> $REPORT_DIR/summary-$TIMESTAMP.txt

echo ""
echo "Report saved to: $REPORT_DIR/summary-$TIMESTAMP.txt"
cat $REPORT_DIR/summary-$TIMESTAMP.txt
```

---

## Checklist op√©rationnelle

### Avant activation

- [ ] Confirmer que c'est n√©cessaire (alternatives √©valu√©es)
- [ ] D√©finir dur√©e maximale d'activation
- [ ] V√©rifier espace disque disponible (> 10GB recommand√©)
- [ ] Planifier fen√™tre de faible activit√© si possible
- [ ] Notifier l'√©quipe (impact performance)
- [ ] Pr√©parer script de d√©sactivation automatique

### Pendant activation

- [ ] Surveiller taille fichier/table en temps r√©el
- [ ] Monitorer impact performance (TPS, latence)
- [ ] V√©rifier espace disque r√©guli√®rement
- [ ] Avoir plan B si probl√®me critique

### Apr√®s d√©sactivation

- [ ] V√©rifier que general_log = OFF
- [ ] Rotation/archivage du fichier
- [ ] Compression des archives
- [ ] Analyse du log captur√©
- [ ] Purge de mysql.general_log si utilis√©
- [ ] Documentation des findings
- [ ] Suppression s√©curis√©e si donn√©es sensibles

---

## ‚úÖ Points cl√©s √† retenir

- **Overhead critique** : 10-30% impact performance, JAMAIS en production continue
- **Activation temporaire** : Maximum quelques minutes √† quelques heures
- **FILE > TABLE** : log_output = FILE est plus performant
- **Alternatives pr√©f√©rables** : Performance Schema, Audit Plugin pour la plupart des cas
- **S√©curit√©** : Le general log contient souvent des donn√©es sensibles
- **Purge obligatoire** : mysql.general_log cro√Æt tr√®s rapidement
- **Monitoring requis** : Surveiller taille et d√©sactiver automatiquement
- **Documentation** : Logger qui, quand, pourquoi le general log a √©t√© activ√©
- **Permissions strictes** : 600 sur fichier, accessible uniquement par mysql user
- **Script automatis√©** : Toujours utiliser timeout et monitoring de taille

---

## üîó Ressources et r√©f√©rences

- [üìñ Documentation officielle : General Query Log](https://mariadb.com/kb/en/general-query-log/)
- [üìñ Documentation officielle : log_output](https://mariadb.com/kb/en/server-system-variables/#log_output)
- [üìñ Performance Schema](https://mariadb.com/kb/en/performance-schema/)
- [üìñ Server Audit Plugin](https://mariadb.com/kb/en/mariadb-audit-plugin/)
- [Blog : General Log Best Practices](https://mariadb.org/general-log-usage/)
- [üìñ Binary Log](https://mariadb.com/kb/en/binary-log/)

---

## ‚û°Ô∏è Section suivante

**11.4.4 - Binary logs** : Configuration et gestion des binary logs pour la r√©plication, point-in-time recovery, formats (STATEMENT, ROW, MIXED), rotation et purge, et strat√©gies de r√©tention pour la haute disponibilit√©.

‚è≠Ô∏è [Binary logs et logs de transactions](/11-administration-configuration/05-binary-logs.md)
