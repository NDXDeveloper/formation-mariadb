üîù Retour au [Sommaire](/SOMMAIRE.md)

# 11.2.1 SHOW VARIABLES et SET

> **Niveau** : Avanc√© (DBA/Administrateur Syst√®me)  
> **Dur√©e estim√©e** : 1.5 heures  
> **Pr√©requis** : 11.1 - Fichiers de configuration, connaissances SQL de base

## üéØ Objectifs d'apprentissage

√Ä l'issue de cette section, vous serez capable de :
- Ma√Ætriser les commandes SHOW VARIABLES pour inspecter la configuration active
- Utiliser SET GLOBAL et SET SESSION pour modifier les variables en temps r√©el
- Comprendre la diff√©rence entre scopes GLOBAL et SESSION
- Identifier les variables dynamiques vs statiques
- Persister les modifications de mani√®re appropri√©e
- Diagnostiquer et corriger les probl√®mes de configuration en production
- Appliquer les bonnes pratiques de gestion des variables syst√®me

---

## Introduction

Les variables syst√®me MariaDB contr√¥lent pratiquement tous les aspects du comportement du serveur : performance, s√©curit√©, r√©plication, logging, etc. La capacit√© √† inspecter et modifier ces variables **en temps r√©el** est une comp√©tence fondamentale pour tout DBA.

Deux commandes sont au c≈ìur de cette gestion :
- **SHOW VARIABLES** : Inspecter les valeurs actuelles
- **SET** : Modifier les variables (temporairement ou de mani√®re persistante)

‚ö†Ô∏è **Important** : MariaDB 11.8 LTS comprend plus de **600 variables syst√®me**. Cette section vous donne les outils pour les g√©rer efficacement.

---

## La commande SHOW VARIABLES

### Syntaxe de base

```sql
-- Afficher toutes les variables (> 600 r√©sultats)
SHOW VARIABLES;

-- Afficher toutes les variables GLOBAL (scope serveur)
SHOW GLOBAL VARIABLES;

-- Afficher toutes les variables SESSION (scope connexion)
SHOW SESSION VARIABLES;
-- √âquivalent √† :
SHOW VARIABLES;  -- SESSION est le d√©faut
```

### Filtrage avec LIKE

```sql
-- Rechercher par pattern (% = wildcard)
SHOW VARIABLES LIKE 'innodb%';
SHOW VARIABLES LIKE '%buffer%';
SHOW VARIABLES LIKE 'max_connections';

-- Exemples pratiques
SHOW VARIABLES LIKE 'innodb_buffer_pool%';
SHOW VARIABLES LIKE 'character%';
SHOW VARIABLES LIKE '%timeout%';
```

**R√©sultat typique** :

```
+---------------------------------+----------------+
| Variable_name                   | Value          |
+---------------------------------+----------------+
| innodb_buffer_pool_chunk_size   | 134217728      |
| innodb_buffer_pool_instances    | 8              |
| innodb_buffer_pool_size         | 8589934592     |
+---------------------------------+----------------+
```

### Filtrage avec WHERE

Pour des recherches plus complexes, interroger `information_schema` :

```sql
-- Utiliser INFORMATION_SCHEMA pour filtrage avanc√©
SELECT VARIABLE_NAME, VARIABLE_VALUE
FROM information_schema.GLOBAL_VARIABLES
WHERE VARIABLE_NAME LIKE 'innodb%buffer%'
ORDER BY VARIABLE_NAME;

-- Variables contenant un pattern sp√©cifique
SELECT VARIABLE_NAME, VARIABLE_VALUE
FROM information_schema.GLOBAL_VARIABLES
WHERE VARIABLE_VALUE LIKE '%utf8%';

-- Variables avec valeur num√©rique > seuil
SELECT VARIABLE_NAME, VARIABLE_VALUE
FROM information_schema.GLOBAL_VARIABLES
WHERE VARIABLE_NAME LIKE '%timeout%'
  AND CAST(VARIABLE_VALUE AS UNSIGNED) > 60;
```

### SHOW GLOBAL vs SHOW SESSION

```sql
-- Variable GLOBAL (scope serveur, m√™me valeur pour tous)
SHOW GLOBAL VARIABLES LIKE 'max_connections';
-- R√©sultat : max_connections = 500

-- Variable SESSION (scope connexion, peut varier par session)
SHOW SESSION VARIABLES LIKE 'sql_mode';
-- R√©sultat : sql_mode = STRICT_TRANS_TABLES,...

-- Certaines variables n'existent qu'en GLOBAL
SHOW GLOBAL VARIABLES LIKE 'innodb_buffer_pool_size';
-- OK

SHOW SESSION VARIABLES LIKE 'innodb_buffer_pool_size';
-- R√©sultat vide (cette variable est GLOBAL uniquement)
```

üí° **Astuce** : Pour savoir si une variable est GLOBAL, SESSION, ou les deux :

```sql
SELECT VARIABLE_NAME, VARIABLE_SCOPE
FROM information_schema.SYSTEM_VARIABLES
WHERE VARIABLE_NAME = 'max_connections';
```

R√©sultat :

```
+------------------+----------------+
| VARIABLE_NAME    | VARIABLE_SCOPE |
+------------------+----------------+
| max_connections  | GLOBAL         |
+------------------+----------------+
```

---

## Les scopes de variables

### 1. Variables GLOBAL uniquement

Ces variables affectent le **serveur entier** et ne peuvent pas √™tre modifi√©es par session.

**Exemples typiques** :

```sql
-- Configuration m√©moire InnoDB
SHOW GLOBAL VARIABLES LIKE 'innodb_buffer_pool_size';

-- Limites serveur
SHOW GLOBAL VARIABLES LIKE 'max_connections';
SHOW GLOBAL VARIABLES LIKE 'table_open_cache';

-- Configuration r√©plication
SHOW GLOBAL VARIABLES LIKE 'server_id';
SHOW GLOBAL VARIABLES LIKE 'gtid_domain_id';

-- üÜï MariaDB 11.8 - Contr√¥le espace temporaire
SHOW GLOBAL VARIABLES LIKE 'max_tmp_space_usage';
SHOW GLOBAL VARIABLES LIKE 'max_total_tmp_space_usage';
```

‚ö†Ô∏è **Attention** : Ces variables n√©cessitent souvent un red√©marrage pour √™tre modifi√©es (variables statiques).

### 2. Variables SESSION uniquement

Ces variables affectent uniquement la **connexion courante**.

**Exemples typiques** :

```sql
-- Configuration SQL
SHOW SESSION VARIABLES LIKE 'sql_mode';
SHOW SESSION VARIABLES LIKE 'autocommit';

-- Buffers de session
SHOW SESSION VARIABLES LIKE 'sort_buffer_size';
SHOW SESSION VARIABLES LIKE 'read_buffer_size';

-- Options de requ√™te
SHOW SESSION VARIABLES LIKE 'sql_select_limit';
SHOW SESSION VARIABLES LIKE 'max_join_size';
```

### 3. Variables GLOBAL et SESSION (les deux)

Ces variables ont une valeur **par d√©faut globale** et peuvent √™tre **modifi√©es par session**.

**Exemples typiques** :

```sql
-- Configuration transaction
SHOW VARIABLES LIKE 'tx_isolation';
-- GLOBAL = d√©faut pour nouvelles connexions
-- SESSION = valeur pour cette connexion

-- Timeouts
SHOW VARIABLES LIKE 'wait_timeout';
SHOW VARIABLES LIKE 'interactive_timeout';

-- Character sets
SHOW VARIABLES LIKE 'character_set_client';
SHOW VARIABLES LIKE 'character_set_connection';
```

**Comportement** :

```sql
-- Valeur GLOBAL (d√©faut pour nouvelles connexions)
SHOW GLOBAL VARIABLES LIKE 'wait_timeout';
-- wait_timeout = 28800 (8 heures)

-- Valeur SESSION (cette connexion)
SHOW SESSION VARIABLES LIKE 'wait_timeout';
-- wait_timeout = 28800 (h√©rit√© du GLOBAL au moment de la connexion)

-- Modifier pour cette session uniquement
SET SESSION wait_timeout = 600;
SHOW SESSION VARIABLES LIKE 'wait_timeout';
-- wait_timeout = 600

-- Le GLOBAL n'a pas chang√©
SHOW GLOBAL VARIABLES LIKE 'wait_timeout';
-- wait_timeout = 28800 (inchang√©)
```

---

## La commande SET

### Syntaxe de base

```sql
-- Modifier une variable GLOBAL
SET GLOBAL variable_name = value;

-- Modifier une variable SESSION
SET SESSION variable_name = value;
SET @@SESSION.variable_name = value;

-- SESSION est le d√©faut (si scope non sp√©cifi√©)
SET variable_name = value;
-- √âquivalent √† : SET SESSION variable_name = value;
```

### SET GLOBAL : Modifications serveur

```sql
-- Augmenter le nombre maximum de connexions
SET GLOBAL max_connections = 1000;

-- Modifier le buffer pool (si dynamique)
-- ‚ö†Ô∏è Sur MariaDB 11.8, innodb_buffer_pool_size est toujours STATIQUE
-- N√©cessite red√©marrage, impossible avec SET

-- Activer le slow query log
SET GLOBAL slow_query_log = ON;
SET GLOBAL long_query_time = 2;

-- Modifier l'expiration des binary logs
SET GLOBAL expire_logs_days = 7;

-- üÜï MariaDB 11.8 - Contr√¥le espace temporaire (dynamique)
SET GLOBAL max_tmp_space_usage = 10737418240;  -- 10GB
```

‚ö†Ô∏è **Important** : Les modifications `SET GLOBAL` sont **perdues au red√©marrage** du serveur. Pour les rendre permanentes, modifier `my.cnf`.

### SET SESSION : Modifications connexion

```sql
-- Modifier le mode SQL pour cette session
SET SESSION sql_mode = 'STRICT_TRANS_TABLES,NO_ZERO_DATE';

-- D√©sactiver autocommit pour cette connexion
SET SESSION autocommit = 0;

-- Augmenter le buffer de tri pour requ√™te complexe
SET SESSION sort_buffer_size = 4194304;  -- 4MB

-- D√©finir le character set de la session
SET SESSION character_set_client = utf8mb4;
SET SESSION character_set_connection = utf8mb4;
SET SESSION character_set_results = utf8mb4;

-- Ou en une commande :
SET NAMES utf8mb4;  -- √âquivaut aux 3 SET ci-dessus
```

üí° **Cas d'usage** : Modifier temporairement le comportement pour une op√©ration sp√©cifique sans affecter les autres connexions.

### Syntaxe alternative avec @@

```sql
-- Syntaxe avec @@ (plus explicite)
SET @@GLOBAL.max_connections = 1000;
SET @@SESSION.sql_mode = 'STRICT_TRANS_TABLES';

-- Afficher la valeur avec SELECT
SELECT @@GLOBAL.max_connections;
SELECT @@SESSION.sql_mode;

-- Afficher les deux scopes
SELECT @@GLOBAL.wait_timeout AS global_timeout,
       @@SESSION.wait_timeout AS session_timeout;
```

---

## Variables dynamiques vs statiques

### Variables dynamiques

**D√©finition** : Peuvent √™tre modifi√©es avec `SET GLOBAL` **sans red√©marrage** du serveur.

**Exemples** :

```sql
-- Ces variables sont DYNAMIQUES
SET GLOBAL max_connections = 2000;              -- ‚úÖ Appliqu√© imm√©diatement
SET GLOBAL slow_query_log = ON;                 -- ‚úÖ Appliqu√© imm√©diatement
SET GLOBAL innodb_adaptive_hash_index = OFF;    -- ‚úÖ Appliqu√© imm√©diatement
SET GLOBAL thread_pool_size = 16;               -- ‚úÖ Appliqu√© imm√©diatement (11.8)
```

**V√©rification** :

```sql
SELECT VARIABLE_NAME, IS_DYNAMIC
FROM information_schema.SYSTEM_VARIABLES
WHERE VARIABLE_NAME IN ('max_connections', 'slow_query_log')
ORDER BY VARIABLE_NAME;
```

R√©sultat :

```
+------------------+------------+
| VARIABLE_NAME    | IS_DYNAMIC |
+------------------+------------+
| max_connections  | YES        |
| slow_query_log   | YES        |
+------------------+------------+
```

### Variables statiques

**D√©finition** : Ne peuvent **PAS** √™tre modifi√©es avec `SET GLOBAL`. N√©cessitent un **red√©marrage** du serveur.

**Exemples** :

```sql
-- Ces variables sont STATIQUES
SET GLOBAL innodb_buffer_pool_size = 17179869184;  -- ‚ùå Erreur !
SET GLOBAL datadir = '/new/path';                  -- ‚ùå Erreur !
SET GLOBAL port = 3307;                             -- ‚ùå Erreur !
```

**Message d'erreur typique** :

```
ERROR 1238 (HY000): Variable 'innodb_buffer_pool_size' is a read only variable
```

**Pour modifier une variable statique** :

1. Modifier `my.cnf`
2. Red√©marrer MariaDB

```ini
# /etc/mysql/mariadb.conf.d/50-server.cnf
[mysqld]
innodb_buffer_pool_size = 16G
```

```bash
sudo systemctl restart mariadb
```

### Liste des variables statiques critiques

```sql
-- Variables STATIQUES importantes (n√©cessitent red√©marrage)
SELECT VARIABLE_NAME
FROM information_schema.SYSTEM_VARIABLES
WHERE IS_DYNAMIC = 'NO'
  AND VARIABLE_NAME IN (
    'innodb_buffer_pool_size',
    'innodb_log_file_size',
    'datadir',
    'port',
    'socket',
    'server_id'
  )
ORDER BY VARIABLE_NAME;
```

üí° **MariaDB 11.8** : La plupart des variables sont maintenant dynamiques, mais les variables structurelles (m√©moire, chemins, identifiants) restent statiques.

---

## Persistance des modifications : SET PERSIST

### Probl√®me des modifications non persistantes

```sql
-- Modification temporaire (perdue au red√©marrage)
SET GLOBAL max_connections = 2000;

-- Au red√©marrage, la valeur revient √† celle de my.cnf
-- Si my.cnf dit max_connections = 500, apr√®s red√©marrage ‚Üí 500
```

### SET PERSIST (MariaDB 10.5+)

üÜï **Nouveaut√©** : `SET PERSIST` permet de modifier **et sauvegarder** une variable en une seule commande.

```sql
-- Modifier et persister dans un fichier de configuration
SET PERSIST max_connections = 2000;

-- √âquivalent √† :
-- 1. SET GLOBAL max_connections = 2000;  (effet imm√©diat)
-- 2. √âcrire dans /var/lib/mysql/mysql-auto.cnf (persistance)
```

**Fichier de persistance** : `/var/lib/mysql/mysql-auto.cnf`

```json
{
  "Version": 1,
  "mysql_dynamic_variables": {
    "max_connections": {
      "Value": "2000",
      "Metadata": {
        "Timestamp": 1702468800,
        "User": "root",
        "Host": "localhost"
      }
    }
  }
}
```

### SET PERSIST_ONLY

Pour les variables **statiques** (qui n√©cessitent un red√©marrage) :

```sql
-- Sauvegarder sans appliquer imm√©diatement (variable statique)
SET PERSIST_ONLY innodb_buffer_pool_size = 17179869184;  -- 16GB

-- La variable sera charg√©e au prochain red√©marrage
-- Aucun effet imm√©diat (variable statique)
```

### RESET PERSIST

Supprimer une variable persist√©e :

```sql
-- Supprimer max_connections du fichier de persistance
RESET PERSIST max_connections;

-- Supprimer TOUTES les variables persist√©es
RESET PERSIST;
```

### Voir les variables persist√©es

```sql
-- Variables actuellement persist√©es
SELECT * FROM performance_schema.persisted_variables;
```

‚ö†Ô∏è **Avertissement** : Le fichier `mysql-auto.cnf` est lu **apr√®s** `my.cnf`. Les valeurs persist√©es **√©crasent** celles de `my.cnf`.

**Ordre de priorit√©** :

```
my.cnf (fichier config)
  ‚Üì
mysql-auto.cnf (SET PERSIST)
  ‚Üì
Ligne de commande mysqld
```

---

## Techniques avanc√©es d'inspection

### 1. Comparer GLOBAL vs SESSION

```sql
-- Identifier les diff√©rences entre GLOBAL et SESSION
SELECT g.VARIABLE_NAME,
       g.VARIABLE_VALUE AS global_value,
       s.VARIABLE_VALUE AS session_value
FROM information_schema.GLOBAL_VARIABLES g
JOIN information_schema.SESSION_VARIABLES s
  ON g.VARIABLE_NAME = s.VARIABLE_NAME
WHERE g.VARIABLE_VALUE != s.VARIABLE_VALUE
ORDER BY g.VARIABLE_NAME;
```

**Cas d'usage** : Identifier les sessions avec des configurations atypiques.

### 2. Trouver les variables modifi√©es par rapport aux d√©fauts

```sql
-- Variables non-default (comparaison avec defaults compil√©s)
-- Note : N√©cessite de conna√Ætre les defaults ou utiliser un serveur de r√©f√©rence
SELECT VARIABLE_NAME, VARIABLE_VALUE
FROM information_schema.GLOBAL_VARIABLES
WHERE VARIABLE_NAME IN (
  'innodb_buffer_pool_size',
  'max_connections',
  'thread_pool_size'
)
ORDER BY VARIABLE_NAME;
```

### 3. Rechercher les variables li√©es √† une fonctionnalit√©

```sql
-- Toutes les variables InnoDB
SELECT VARIABLE_NAME, VARIABLE_VALUE, IS_DYNAMIC
FROM information_schema.SYSTEM_VARIABLES
WHERE VARIABLE_NAME LIKE 'innodb%'
ORDER BY VARIABLE_NAME;

-- Variables de r√©plication
SELECT VARIABLE_NAME, VARIABLE_VALUE
FROM information_schema.GLOBAL_VARIABLES
WHERE VARIABLE_NAME REGEXP '(gtid|binlog|relay|slave|replica)'
ORDER BY VARIABLE_NAME;

-- üÜï Variables MariaDB 11.8 sp√©cifiques
SELECT VARIABLE_NAME, VARIABLE_VALUE
FROM information_schema.GLOBAL_VARIABLES
WHERE VARIABLE_NAME IN (
  'max_tmp_space_usage',
  'max_total_tmp_space_usage',
  'character_set_server',
  'collation_server'
)
ORDER BY VARIABLE_NAME;
```

### 4. Audit de s√©curit√© via variables

```sql
-- Variables critiques de s√©curit√©
SELECT VARIABLE_NAME, VARIABLE_VALUE,
       CASE
         WHEN VARIABLE_VALUE = 'ON' THEN '‚úÖ S√©curis√©'
         WHEN VARIABLE_VALUE = 'OFF' THEN '‚ö†Ô∏è Attention'
         ELSE VARIABLE_VALUE
       END AS security_status
FROM information_schema.GLOBAL_VARIABLES
WHERE VARIABLE_NAME IN (
  'require_secure_transport',  -- üÜï TLS obligatoire (11.8)
  'local_infile',              -- Devrait √™tre OFF
  'skip_name_resolve',         -- Devrait √™tre ON
  'skip_networking'            -- ON si pas de r√©seau n√©cessaire
)
ORDER BY VARIABLE_NAME;
```

### 5. Variables li√©es aux nouveaut√©s 11.8

```sql
-- üÜï Character set et collation (utf8mb4 par d√©faut en 11.8)
SELECT VARIABLE_NAME, VARIABLE_VALUE
FROM information_schema.GLOBAL_VARIABLES
WHERE VARIABLE_NAME IN (
  'character_set_server',      -- Devrait √™tre utf8mb4
  'collation_server',          -- Devrait √™tre utf8mb4_unicode_ci (UCA 14.0.0)
  'character_set_database',
  'character_set_client',
  'character_set_connection'
)
ORDER BY VARIABLE_NAME;

-- üÜï Contr√¥le espace temporaire
SELECT VARIABLE_NAME,
       VARIABLE_VALUE,
       CAST(VARIABLE_VALUE AS UNSIGNED) / 1024 / 1024 / 1024 AS value_gb
FROM information_schema.GLOBAL_VARIABLES
WHERE VARIABLE_NAME IN (
  'max_tmp_space_usage',
  'max_total_tmp_space_usage',
  'tmpdir'
)
ORDER BY VARIABLE_NAME;

-- üÜï Thread Pool (performance am√©lior√©e en 11.8)
SELECT VARIABLE_NAME, VARIABLE_VALUE
FROM information_schema.GLOBAL_VARIABLES
WHERE VARIABLE_NAME LIKE 'thread_pool%'
ORDER BY VARIABLE_NAME;
```

---

## Cas d'usage pratiques en production

### Cas 1 : Urgence - Augmenter max_connections

**Sc√©nario** : Erreur "Too many connections" en production.

```sql
-- 1. V√©rifier la valeur actuelle
SHOW GLOBAL VARIABLES LIKE 'max_connections';
-- max_connections = 500

-- 2. V√©rifier le nombre de connexions actuelles
SHOW GLOBAL STATUS LIKE 'Threads_connected';
-- Threads_connected = 498

SHOW GLOBAL STATUS LIKE 'Max_used_connections';
-- Max_used_connections = 500  ‚ö†Ô∏è On a atteint la limite !

-- 3. Augmenter imm√©diatement (effet imm√©diat)
SET GLOBAL max_connections = 1000;

-- 4. Persister pour survivre au red√©marrage
SET PERSIST max_connections = 1000;
-- OU modifier my.cnf :
-- [mysqld]
-- max_connections = 1000

-- 5. V√©rifier
SHOW GLOBAL VARIABLES LIKE 'max_connections';
-- max_connections = 1000
```

### Cas 2 : Optimisation temporaire pour requ√™te lourde

**Sc√©nario** : Requ√™te analytique n√©cessitant plus de m√©moire temporairement.

```sql
-- Sauvegarder les valeurs actuelles
SET @old_sort_buffer = @@SESSION.sort_buffer_size;
SET @old_read_buffer = @@SESSION.read_rnd_buffer_size;

-- Augmenter pour cette session uniquement
SET SESSION sort_buffer_size = 8388608;        -- 8MB
SET SESSION read_rnd_buffer_size = 8388608;    -- 8MB
SET SESSION tmp_table_size = 67108864;         -- 64MB
SET SESSION max_heap_table_size = 67108864;    -- 64MB

-- Ex√©cuter la requ√™te lourde
SELECT /* requ√™te analytique complexe */;

-- Restaurer les valeurs originales (optionnel, session sera ferm√©e)
SET SESSION sort_buffer_size = @old_sort_buffer;
SET SESSION read_rnd_buffer_size = @old_read_buffer;
```

üí° **Avantage** : Aucun impact sur les autres sessions/utilisateurs.

### Cas 3 : Activer slow query log temporairement

**Sc√©nario** : D√©boguer un probl√®me de performance sans red√©marrage.

```sql
-- Activer le slow query log
SET GLOBAL slow_query_log = ON;
SET GLOBAL long_query_time = 1;  -- Capturer requ√™tes > 1 seconde
SET GLOBAL log_queries_not_using_indexes = ON;

-- Sp√©cifier le fichier de log (si n√©cessaire)
SET GLOBAL slow_query_log_file = '/var/log/mysql/slow-debug.log';

-- Apr√®s debugging, d√©sactiver
SET GLOBAL slow_query_log = OFF;
SET GLOBAL log_queries_not_using_indexes = OFF;
```

### Cas 4 : Modifier le mode SQL pour compatibilit√©

**Sc√©nario** : Application legacy n√©cessitant un mode SQL moins strict.

```sql
-- V√©rifier le mode actuel
SELECT @@GLOBAL.sql_mode;
-- STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION

-- Cr√©er un mode moins strict pour cette session
SET SESSION sql_mode = 'NO_ENGINE_SUBSTITUTION';

-- Ou globalement (temporaire)
SET GLOBAL sql_mode = 'NO_ENGINE_SUBSTITUTION';

-- Pour persistence
SET PERSIST sql_mode = 'NO_ENGINE_SUBSTITUTION';
```

‚ö†Ô∏è **Attention** : Modes SQL permissifs peuvent masquer des erreurs. √Ä utiliser avec pr√©caution.

### Cas 5 : Configuration UTF8MB4 pour nouvelle application

**Sc√©nario** : S'assurer que toutes les nouvelles connexions utilisent utf8mb4.

```sql
-- üÜï MariaDB 11.8 : utf8mb4 par d√©faut, mais v√©rifier
SHOW GLOBAL VARIABLES LIKE 'character_set%';
SHOW GLOBAL VARIABLES LIKE 'collation%';

-- Si n√©cessaire, forcer utf8mb4 globalement
SET GLOBAL character_set_server = utf8mb4;
SET GLOBAL collation_server = utf8mb4_unicode_ci;  -- UCA 14.0.0 en 11.8

-- Pour la session courante
SET NAMES utf8mb4 COLLATE utf8mb4_unicode_ci;

-- Persister
SET PERSIST character_set_server = utf8mb4;
SET PERSIST collation_server = utf8mb4_unicode_ci;
```

### Cas 6 : Monitoring et alerting sur seuils

**Sc√©nario** : V√©rifier si certaines limites sont atteintes.

```sql
-- Script de monitoring
SET @max_conn := (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_VARIABLES
                  WHERE VARIABLE_NAME = 'max_connections');
SET @current_conn := (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS
                      WHERE VARIABLE_NAME = 'Threads_connected');
SET @usage_pct := (@current_conn / @max_conn) * 100;

SELECT @max_conn AS max_connections,
       @current_conn AS current_connections,
       ROUND(@usage_pct, 2) AS usage_percentage,
       CASE
         WHEN @usage_pct > 90 THEN 'üî¥ CRITICAL'
         WHEN @usage_pct > 75 THEN 'üü† WARNING'
         ELSE 'üü¢ OK'
       END AS status;

-- Si critique, augmenter temporairement
-- SET GLOBAL max_connections = @max_conn * 1.5;
```

---

## Bonnes pratiques

### 1. Toujours documenter les changements

```sql
-- ‚ùå Mauvais : Changement non document√©
SET GLOBAL max_connections = 2000;

-- ‚úÖ Bon : Changement document√© avec commentaire et contexte
-- Date: 2025-12-13
-- Raison: Augmentation trafic Black Friday
-- Ticket: OPS-1234
-- DBA: john.doe
SET PERSIST max_connections = 2000;

-- Ajouter dans changelog ou git
-- echo "2025-12-13 - max_connections 500‚Üí2000 (Black Friday)" >> /var/log/mysql/config-changes.log
```

### 2. Tester avant d'appliquer en production

```bash
# Sur environnement de staging
mysql -e "SET GLOBAL max_connections = 2000; SHOW GLOBAL VARIABLES LIKE 'max_connections';"

# Observer le comportement pendant 24h
# Si OK, d√©ployer en production
```

### 3. Utiliser SET PERSIST pour la tra√ßabilit√©

```sql
-- SET PERSIST cr√©e un audit trail dans mysql-auto.cnf
SET PERSIST max_connections = 2000;

-- V√©rifier l'historique
SELECT * FROM performance_schema.persisted_variables;
```

### 4. Pr√©f√©rer my.cnf pour configuration stable

Pour les param√®tres de production stables :

```ini
# /etc/mysql/mariadb.conf.d/50-server.cnf
[mysqld]
max_connections = 2000
innodb_buffer_pool_size = 16G
```

**Raison** :
- ‚úÖ Versionnable avec Git
- ‚úÖ Lisible et documentable
- ‚úÖ Survit √† `RESET PERSIST`

### 5. Surveiller les modifications en temps r√©el

```sql
-- Cr√©er un trigger d'audit (si plugin disponible)
-- Ou logger via application monitoring

-- Script p√©riodique de v√©rification
CREATE EVENT check_critical_variables
ON SCHEDULE EVERY 1 HOUR
DO
  INSERT INTO config_audit_log
  SELECT NOW(), 'max_connections', VARIABLE_VALUE
  FROM information_schema.GLOBAL_VARIABLES
  WHERE VARIABLE_NAME = 'max_connections';
```

### 6. Rollback plan

Toujours avoir un plan de rollback :

```sql
-- Sauvegarder la valeur actuelle avant modification
SET @old_value := @@GLOBAL.max_connections;

-- Appliquer le changement
SET GLOBAL max_connections = 2000;

-- En cas de probl√®me, restaurer
-- SET GLOBAL max_connections = @old_value;
```

### 7. Validation post-modification

```sql
-- Apr√®s modification, v√©rifier
SET GLOBAL max_connections = 2000;

-- Validation
SELECT @@GLOBAL.max_connections AS expected_value,
       CASE
         WHEN @@GLOBAL.max_connections = 2000 THEN '‚úÖ OK'
         ELSE '‚ùå FAILED'
       END AS validation_status;

-- V√©rifier les logs d'erreur
-- tail -f /var/log/mysql/error.log
```

---

## Pi√®ges courants et r√©solution

### Pi√®ge 1 : Confusion GLOBAL vs SESSION

```sql
-- ‚ùå Erreur : Modifier SESSION au lieu de GLOBAL
SET SESSION max_connections = 2000;
-- ERROR 1229 (HY000): Variable 'max_connections' is a GLOBAL variable

-- ‚úÖ Correct
SET GLOBAL max_connections = 2000;
```

### Pi√®ge 2 : Variable statique

```sql
-- ‚ùå Tentative de modifier variable statique
SET GLOBAL innodb_buffer_pool_size = 17179869184;
-- ERROR 1238 (HY000): Variable 'innodb_buffer_pool_size' is a read only variable

-- ‚úÖ Solution : Modifier my.cnf et red√©marrer
```

### Pi√®ge 3 : Modification non persistante

```sql
-- ‚ùå Modification perdue au red√©marrage
SET GLOBAL slow_query_log = ON;
-- Red√©marrage ‚Üí slow_query_log revient √† OFF (si my.cnf = OFF)

-- ‚úÖ Solution 1 : SET PERSIST
SET PERSIST slow_query_log = ON;

-- ‚úÖ Solution 2 : Modifier my.cnf
-- [mysqld]
-- slow_query_log = ON
```

### Pi√®ge 4 : Valeur avec unit√© incorrecte

```sql
-- ‚ùå Unit√© incorrecte (octets attendus, pas GB)
SET GLOBAL innodb_log_buffer_size = 256M;
-- ERROR 1232 (42000): Incorrect argument type to variable 'innodb_log_buffer_size'

-- ‚úÖ Correct : Valeur en octets
SET GLOBAL innodb_log_buffer_size = 268435456;  -- 256MB en octets
```

üí° **Astuce** : Certaines variables acceptent des suffixes (K, M, G), d'autres non. V√©rifier la documentation.

```sql
-- Accepte suffixe
SET GLOBAL max_binlog_size = 1G;  -- OK

-- N'accepte pas suffixe
SET GLOBAL max_connections = 2K;  -- ERROR
```

### Pi√®ge 5 : mysql-auto.cnf √©crase my.cnf

```ini
# my.cnf
[mysqld]
max_connections = 500
```

```sql
-- SET PERSIST cr√©e mysql-auto.cnf avec priorit√© > my.cnf
SET PERSIST max_connections = 2000;
```

**R√©sultat** : `max_connections = 2000` (mysql-auto.cnf gagne)

**Solution** : Soit g√©rer tout par SET PERSIST, soit tout par my.cnf.

```sql
-- Pour supprimer l'override de mysql-auto.cnf
RESET PERSIST max_connections;
-- Red√©marrer pour charger la valeur de my.cnf
```

---

## Requ√™tes de r√©f√©rence rapide

### Cheat sheet SHOW VARIABLES

```sql
-- Toutes les variables
SHOW VARIABLES;

-- Variables globales uniquement
SHOW GLOBAL VARIABLES;

-- Variables de session uniquement
SHOW SESSION VARIABLES;

-- Recherche par pattern
SHOW VARIABLES LIKE 'innodb%';
SHOW VARIABLES LIKE '%buffer%';

-- Variables sp√©cifiques MariaDB 11.8
SHOW VARIABLES WHERE Variable_name IN (
  'max_tmp_space_usage',
  'character_set_server',
  'collation_server'
);
```

### Cheat sheet SET

```sql
-- Modifier globalement (toutes nouvelles connexions)
SET GLOBAL variable_name = value;

-- Modifier pour session courante uniquement
SET SESSION variable_name = value;
SET variable_name = value;  -- SESSION par d√©faut

-- Modifier et persister (MariaDB 10.5+)
SET PERSIST variable_name = value;

-- Persister sans appliquer imm√©diatement (variables statiques)
SET PERSIST_ONLY variable_name = value;

-- Supprimer une variable persist√©e
RESET PERSIST variable_name;
RESET PERSIST;  -- Toutes
```

### Requ√™tes d'introspection

```sql
-- Scope d'une variable
SELECT VARIABLE_NAME, VARIABLE_SCOPE, IS_DYNAMIC
FROM information_schema.SYSTEM_VARIABLES
WHERE VARIABLE_NAME = 'max_connections';

-- Variables modifi√©es (GLOBAL != SESSION)
SELECT g.VARIABLE_NAME, g.VARIABLE_VALUE AS global, s.VARIABLE_VALUE AS session
FROM information_schema.GLOBAL_VARIABLES g
JOIN information_schema.SESSION_VARIABLES s ON g.VARIABLE_NAME = s.VARIABLE_NAME
WHERE g.VARIABLE_VALUE != s.VARIABLE_VALUE;

-- Variables dynamiques InnoDB
SELECT VARIABLE_NAME, VARIABLE_VALUE
FROM information_schema.GLOBAL_VARIABLES
WHERE VARIABLE_NAME LIKE 'innodb%'
  AND VARIABLE_NAME IN (
    SELECT VARIABLE_NAME
    FROM information_schema.SYSTEM_VARIABLES
    WHERE IS_DYNAMIC = 'YES'
  );
```

---

## ‚úÖ Points cl√©s √† retenir

- **SHOW VARIABLES** : Inspecter les variables (GLOBAL, SESSION, ou les deux)
- **SET GLOBAL** : Modifier pour toutes les nouvelles connexions (effet imm√©diat, non persistant)
- **SET SESSION** : Modifier uniquement pour la connexion courante (effet imm√©diat, temporaire)
- **SET PERSIST** : Modifier et persister dans mysql-auto.cnf (MariaDB 10.5+)
- **Variables dynamiques** : Modifiables avec SET sans red√©marrage
- **Variables statiques** : N√©cessitent modification de my.cnf + red√©marrage
- **Scopes** : GLOBAL (serveur), SESSION (connexion), ou les deux
- **Priorit√©** : mysql-auto.cnf √©crase my.cnf
- **Persistance** : SET GLOBAL n'est PAS persistant, utiliser SET PERSIST ou my.cnf
- **Documentation** : Toujours documenter les changements en production
- **MariaDB 11.8** : utf8mb4 par d√©faut, nouvelles variables de contr√¥le espace temporaire

---

## üîó Ressources et r√©f√©rences

- [üìñ Documentation officielle : SHOW VARIABLES](https://mariadb.com/kb/en/show-variables/)
- [üìñ Documentation officielle : SET Statement](https://mariadb.com/kb/en/set/)
- [üìñ Documentation officielle : Server System Variables](https://mariadb.com/kb/en/server-system-variables/)
- [üìñ Documentation officielle : SET PERSIST](https://mariadb.com/kb/en/set/#set-persist)
- [üìñ INFORMATION_SCHEMA.SYSTEM_VARIABLES](https://mariadb.com/kb/en/information-schema-system_variables-table/)
- [üìñ MariaDB 11.8 Release Notes](https://mariadb.com/kb/en/mariadb-11-8-0-release-notes/)

---

## ‚û°Ô∏è Section suivante

**11.2.2 - Variables dynamiques vs statiques** : Exploration approfondie des diff√©rences entre variables dynamiques et statiques, strat√©gies de modification s√©curis√©e en production, et impact sur les performances et la disponibilit√©.

‚è≠Ô∏è [Variables dynamiques vs statiques](/11-administration-configuration/02.2-dynamiques-statiques.md)
