üîù Retour au [Sommaire](/SOMMAIRE.md)

# 14.2.3 Configuration et d√©ploiement

> **Niveau** : Expert  
> **Dur√©e estim√©e** : 6-8 heures  
> **Pr√©requis** : Architecture synchrone (14.2.1), Certification-based replication (14.2.2), Administration Linux, R√©seaux

## üéØ Objectifs d'apprentissage

√Ä l'issue de cette section, vous serez capable de :
- D√©ployer un cluster MariaDB Galera en production de A √† Z
- Configurer et optimiser tous les composants du cluster
- Bootstrapper un nouveau cluster et ajouter des n≈ìuds
- Mettre en place les m√©canismes de State Transfer (SST/IST)
- Impl√©menter des proc√©dures de maintenance et d'upgrade
- Diagnostiquer et r√©soudre les probl√®mes de d√©ploiement
- S√©curiser un cluster Galera en production

---

## Introduction

Le d√©ploiement d'un cluster MariaDB Galera en production n√©cessite une pr√©paration rigoureuse et une attention particuli√®re aux d√©tails. Contrairement √† une installation MariaDB standalone, Galera introduit des composants suppl√©mentaires (wsrep provider, group communication) et des contraintes sp√©cifiques (quorum, SST, network latency).

Cette section fournit un guide op√©rationnel complet pour d√©ployer un cluster Galera robuste, depuis la pr√©paration de l'infrastructure jusqu'√† la mise en production, en passant par tous les aspects de configuration, s√©curit√©, et monitoring.

**Architecture cible de cette section :**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              Production Galera Cluster (3 nodes)          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ
‚îÇ  ‚îÇ  galera-01   ‚îÇ  ‚îÇ  galera-02   ‚îÇ  ‚îÇ  galera-03   ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ              ‚îÇ  ‚îÇ              ‚îÇ  ‚îÇ              ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ MariaDB 11.8 ‚îÇ  ‚îÇ MariaDB 11.8 ‚îÇ  ‚îÇ MariaDB 11.8 ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ + Galera 4   ‚îÇ  ‚îÇ + Galera 4   ‚îÇ  ‚îÇ + Galera 4   ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ              ‚îÇ  ‚îÇ              ‚îÇ  ‚îÇ              ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ 10.0.1.11    ‚îÇ  ‚îÇ 10.0.1.12    ‚îÇ  ‚îÇ 10.0.1.13    ‚îÇ     ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ
‚îÇ         ‚îÇ                 ‚îÇ                 ‚îÇ             ‚îÇ
‚îÇ         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò             ‚îÇ
‚îÇ                           ‚îÇ                               ‚îÇ
‚îÇ                    Galera Cluster                         ‚îÇ
‚îÇ                  (Group Communication)                    ‚îÇ
‚îÇ                                                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                  ‚îÇ                  ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                    Application Layer
```

---

## Pr√©paration de l'infrastructure

### Pr√©requis mat√©riels et syst√®me

**Configuration mat√©rielle recommand√©e (par n≈ìud) :**

| Composant | Minimum | Recommand√© | Production haute charge |
|-----------|---------|------------|------------------------|
| **CPU** | 4 cores | 8 cores | 16+ cores |
| **RAM** | 8 GB | 16-32 GB | 64+ GB |
| **Storage** | SSD 100 GB | NVMe 500 GB | NVMe RAID10 1+ TB |
| **Network** | 1 Gbps | 10 Gbps | 10+ Gbps (low latency) |
| **IOPS** | 5,000+ | 20,000+ | 50,000+ |

**Configuration syst√®me :**

```bash
# OS recommand√©: Ubuntu 22.04 LTS, RHEL 9, Debian 12
cat /etc/os-release

# Kernel >= 5.15
uname -r

# Architecture 64-bit
uname -m  # doit retourner x86_64 ou aarch64
```

### Configuration r√©seau

**Exigences r√©seau critiques :**

```bash
# 1. Latence r√©seau entre n≈ìuds
# Objectif: < 1ms pour LAN, < 20ms pour WAN tol√©rable
ping -c 100 galera-02

# 2. Bande passante suffisante
# Test iperf entre n≈ìuds
# Sur galera-02:
iperf3 -s

# Sur galera-01:
iperf3 -c galera-02 -t 30
# Objectif: > 1 Gbps, id√©al > 10 Gbps

# 3. MTU configur√© (Jumbo Frames si possible)
ip link show | grep mtu
# Recommand√©: MTU 9000 pour r√©duire overhead
```

**Ports r√©seau Galera :**

| Port | Protocole | Usage | Requis |
|------|-----------|-------|--------|
| **3306** | TCP | MySQL/MariaDB | Oui |
| **4444** | TCP | State Snapshot Transfer (SST) | Oui |
| **4567** | TCP | Galera Cluster replication | Oui |
| **4567** | UDP | Galera Cluster multicast | Oui* |
| **4568** | TCP | Incremental State Transfer (IST) | Oui |

*UDP optionnel si utilisation multicast

**Configuration firewall (UFW - Ubuntu) :**

```bash
# Sur chaque n≈ìud Galera

# Autoriser SSH (administration)
ufw allow 22/tcp

# Autoriser MySQL (applications)
ufw allow from 10.0.1.0/24 to any port 3306

# Autoriser Galera entre n≈ìuds
# SST
ufw allow from 10.0.1.11 to any port 4444
ufw allow from 10.0.1.12 to any port 4444
ufw allow from 10.0.1.13 to any port 4444

# Cluster communication
ufw allow from 10.0.1.11 to any port 4567
ufw allow from 10.0.1.12 to any port 4567
ufw allow from 10.0.1.13 to any port 4567

# IST
ufw allow from 10.0.1.11 to any port 4568
ufw allow from 10.0.1.12 to any port 4568
ufw allow from 10.0.1.13 to any port 4568

# Activer firewall
ufw enable
```

**Configuration firewalld (RHEL/CentOS) :**

```bash
# Zone trusted pour n≈ìuds Galera
firewall-cmd --permanent --new-zone=galera
firewall-cmd --permanent --zone=galera --add-source=10.0.1.11/32
firewall-cmd --permanent --zone=galera --add-source=10.0.1.12/32
firewall-cmd --permanent --zone=galera --add-source=10.0.1.13/32

# Autoriser ports Galera
firewall-cmd --permanent --zone=galera --add-port=3306/tcp
firewall-cmd --permanent --zone=galera --add-port=4444/tcp
firewall-cmd --permanent --zone=galera --add-port=4567/tcp
firewall-cmd --permanent --zone=galera --add-port=4567/udp
firewall-cmd --permanent --zone=galera --add-port=4568/tcp

# Recharger
firewall-cmd --reload
```

### Configuration DNS et noms d'h√¥tes

```bash
# /etc/hosts sur chaque n≈ìud
cat << 'EOF' >> /etc/hosts
10.0.1.11    galera-01    galera-01.example.com
10.0.1.12    galera-02    galera-02.example.com
10.0.1.13    galera-03    galera-03.example.com
EOF

# V√©rifier r√©solution
ping -c 3 galera-02
ping -c 3 galera-03

# Configurer hostname (exemple sur galera-01)
hostnamectl set-hostname galera-01.example.com
```

### Optimisations syst√®me

**Kernel parameters (sysctl) :**

```bash
# /etc/sysctl.d/99-galera.conf
cat << 'EOF' > /etc/sysctl.d/99-galera.conf
# Network optimizations
net.core.rmem_max = 134217728
net.core.wmem_max = 134217728
net.ipv4.tcp_rmem = 4096 87380 134217728
net.ipv4.tcp_wmem = 4096 65536 134217728
net.core.netdev_max_backlog = 5000
net.ipv4.tcp_no_metrics_save = 1
net.ipv4.tcp_congestion_control = htcp

# Connection tracking
net.netfilter.nf_conntrack_max = 1048576
net.nf_conntrack_max = 1048576

# File descriptors
fs.file-max = 500000

# Swappiness (r√©duire swap usage)
vm.swappiness = 10
EOF

# Appliquer
sysctl -p /etc/sysctl.d/99-galera.conf
```

**Limits (ulimit) :**

```bash
# /etc/security/limits.d/99-galera.conf
cat << 'EOF' > /etc/security/limits.d/99-galera.conf
mysql soft nofile 65536
mysql hard nofile 65536
mysql soft nproc 65536
mysql hard nproc 65536
mysql soft memlock unlimited
mysql hard memlock unlimited
EOF
```

**D√©sactiver SELinux (ou configurer policies) :**

```bash
# Option 1: D√©sactiver (plus simple)
# /etc/selinux/config
SELINUX=disabled

# Reboot requis
reboot

# Option 2: Configurer SELinux pour Galera (recommand√© en production)
semanage port -a -t mysqld_port_t -p tcp 4444
semanage port -a -t mysqld_port_t -p tcp 4567
semanage port -a -t mysqld_port_t -p tcp 4568
semanage port -a -t mysqld_port_t -p udp 4567
```

---

## Installation de MariaDB et Galera

### Installation sur Ubuntu 22.04 LTS

```bash
# 1. Ajouter le repository MariaDB 11.8
curl -LsS https://r.mariadb.com/downloads/mariadb_repo_setup | \
    sudo bash -s -- --mariadb-server-version="mariadb-11.8"

# 2. Mettre √† jour les packages
apt update

# 3. Installer MariaDB + Galera
apt install -y \
    mariadb-server \
    mariadb-client \
    mariadb-backup \
    galera-4 \
    libmariadb3 \
    mariadb-common

# 4. V√©rifier les versions
mariadb --version
# mariadb  Ver 15.1 Distrib 11.8.x-MariaDB

# V√©rifier Galera
dpkg -l | grep galera
# galera-4    26.4.x    (version 4.x pour MariaDB 11.8)

# 5. Arr√™ter MariaDB (ne pas d√©marrer encore)
systemctl stop mariadb
systemctl disable mariadb  # D√©sactiver auto-start
```

### Installation sur RHEL/Rocky Linux 9

```bash
# 1. Ajouter repository MariaDB
cat << 'EOF' > /etc/yum.repos.d/MariaDB.repo
[mariadb]
name = MariaDB
baseurl = https://rpm.mariadb.org/11.8/rhel/$releasever/$basearch
module_hotfixes = 1
gpgkey = https://rpm.mariadb.org/RPM-GPG-KEY-MariaDB
gpgcheck = 1
EOF

# 2. Installer
dnf install -y \
    MariaDB-server \
    MariaDB-client \
    MariaDB-backup \
    galera-4 \
    MariaDB-common

# 3. V√©rifier
mariadb --version

# 4. Arr√™ter (ne pas d√©marrer)
systemctl stop mariadb
systemctl disable mariadb
```

### V√©rification de l'installation Galera

```bash
# V√©rifier pr√©sence du provider Galera
ls -lh /usr/lib64/galera/libgalera_smm.so
# ou sur Ubuntu:
ls -lh /usr/lib/galera/libgalera_smm.so

# V√©rifier version Galera
strings /usr/lib*/galera/libgalera_smm.so | grep -i "version"
```

---

## Configuration Galera - Fichier my.cnf

### Structure des fichiers de configuration

```bash
# MariaDB 11.8 utilise une structure modulaire
tree /etc/mysql
# /etc/mysql/
# ‚îú‚îÄ‚îÄ mariadb.cnf                   # Fichier principal
# ‚îú‚îÄ‚îÄ mariadb.conf.d/               # Configuration MariaDB
# ‚îÇ   ‚îú‚îÄ‚îÄ 50-server.cnf
# ‚îÇ   ‚îî‚îÄ‚îÄ 60-galera.cnf             # ‚Üê Configuration Galera (√† cr√©er)
# ‚îî‚îÄ‚îÄ conf.d/                        # Configuration custom
#     ‚îî‚îÄ‚îÄ mysql.cnf
```

### Configuration Galera compl√®te - galera-01

```ini
# /etc/mysql/mariadb.conf.d/60-galera.cnf
# Configuration pour galera-01 (10.0.1.11)

[mysqld]
#
# === Galera Cluster Configuration ===
#

# --- Basic Settings ---
user = mysql
pid-file = /run/mysqld/mysqld.pid
socket = /run/mysqld/mysqld.sock
basedir = /usr
datadir = /var/lib/mysql
tmpdir = /tmp

# Bind to all interfaces (ou IP sp√©cifique)
bind-address = 0.0.0.0

# --- Galera Required Settings ---
binlog_format = ROW
default_storage_engine = InnoDB
innodb_autoinc_lock_mode = 2
innodb_flush_log_at_trx_commit = 0  # Safe in Galera

# --- Galera Provider Configuration ---
wsrep_on = ON
wsrep_provider = /usr/lib/galera/libgalera_smm.so

# --- Cluster Connection ---
wsrep_cluster_address = "gcomm://10.0.1.11,10.0.1.12,10.0.1.13"
wsrep_cluster_name = "production_galera_cluster"

# --- Node Configuration ---
wsrep_node_address = "10.0.1.11"
wsrep_node_name = "galera-01"

# --- State Snapshot Transfer (SST) ---
wsrep_sst_method = mariabackup
wsrep_sst_auth = "sst_user:SST_P@ssw0rd_2024!"

# SST receive address (optionnel, utile si plusieurs NICs)
# wsrep_sst_receive_address = "10.0.1.11:4444"

# --- Replication Settings ---
wsrep_slave_threads = 8  # Nombre de threads pour apply (= CPU/2)

# --- Provider Options ---
wsrep_provider_options = "
    gcache.size=4G;
    gcache.page_size=1G;
    gcache.keep_pages_size=2G;
    gcs.fc_limit=256;
    gcs.fc_factor=0.9;
    gcs.fc_master_slave=YES;
    evs.keepalive_period=PT1S;
    evs.suspect_timeout=PT10S;
    evs.inactive_timeout=PT30S;
    evs.install_timeout=PT15S;
    evs.send_window=1024;
    evs.user_send_window=512;
    evs.auto_evict=10;
    cert.log_conflicts=YES
"

#
# === InnoDB Configuration ===
#

# --- Buffer Pool ---
innodb_buffer_pool_size = 24G  # 60-70% RAM disponible
innodb_buffer_pool_instances = 8
innodb_log_buffer_size = 64M

# --- Logs ---
innodb_log_file_size = 1G
innodb_log_files_in_group = 2

# --- I/O Configuration ---
innodb_io_capacity = 2000        # IOPS SSD standard
innodb_io_capacity_max = 4000
innodb_flush_method = O_DIRECT
innodb_read_io_threads = 8
innodb_write_io_threads = 8

# üÜï MariaDB 11.8: Construction index efficace
innodb_alter_copy_bulk = ON

# --- Misc InnoDB ---
innodb_file_per_table = ON
innodb_flush_neighbors = 0  # Disable pour SSD
innodb_doublewrite = ON     # Keep ON pour durabilit√©

#
# === General MariaDB Settings ===
#

# --- Connection ---
max_connections = 500
max_connect_errors = 100000
max_allowed_packet = 256M
connect_timeout = 10
interactive_timeout = 600
wait_timeout = 600

# --- Query Cache (deprecated, keep OFF) ---
query_cache_type = 0
query_cache_size = 0

# --- Temp Tables ---
tmp_table_size = 64M
max_heap_table_size = 64M

# üÜï MariaDB 11.8: Contr√¥le espace temporaire
max_tmp_space_usage = 10G
max_total_tmp_space_usage = 20G

# --- Thread Cache ---
thread_cache_size = 100
thread_stack = 256K

# --- Table Cache ---
table_open_cache = 4000
table_definition_cache = 2000

#
# === Character Set (MariaDB 11.8 defaults) ===
#

# üÜï UTF8MB4 par d√©faut depuis 11.8
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

#
# === Logging ===
#

# --- Error Log ---
log_error = /var/log/mysql/error.log
log_warnings = 2

# --- Slow Query Log ---
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2
log_slow_verbosity = query_plan,explain

# --- Binary Log (optionnel pour PITR) ---
log_bin = /var/log/mysql/mariadb-bin
log_bin_index = /var/log/mysql/mariadb-bin.index
expire_logs_days = 7
max_binlog_size = 500M
sync_binlog = 0  # Galera g√®re la durabilit√©

#
# === Security ===
#

# üÜï MariaDB 11.8: TLS par d√©faut
# D√©commenter si certificats configur√©s
# ssl_cert = /etc/mysql/ssl/server-cert.pem
# ssl_key = /etc/mysql/ssl/server-key.pem
# ssl_ca = /etc/mysql/ssl/ca-cert.pem
# require_secure_transport = ON

# --- Other Security ---
local_infile = 0
```

### Configuration pour galera-02 et galera-03

**Sur galera-02 (10.0.1.12) :**
```ini
# Changer uniquement ces lignes dans 60-galera.cnf:
wsrep_node_address = "10.0.1.12"
wsrep_node_name = "galera-02"
```

**Sur galera-03 (10.0.1.13) :**
```ini
# Changer uniquement ces lignes dans 60-galera.cnf:
wsrep_node_address = "10.0.1.13"
wsrep_node_name = "galera-03"
```

### Validation de la configuration

```bash
# Sur chaque n≈ìud, v√©rifier syntaxe
mysqld --verbose --help > /dev/null
echo $?  # Doit retourner 0

# V√©rifier permissions fichiers
chown -R mysql:mysql /var/lib/mysql
chown -R mysql:mysql /var/log/mysql
chmod 750 /var/lib/mysql
```

---

## Bootstrap du cluster

### Cr√©ation des utilisateurs SST

**Avant de bootstrapper, cr√©er l'utilisateur SST sur le premier n≈ìud :**

```sql
-- Sur galera-01, d√©marrer temporairement en standalone
-- (sans Galera pour √©viter erreur bootstrap)

-- Commenter temporairement wsrep_on dans my.cnf
# wsrep_on = OFF

-- D√©marrer MariaDB
sudo systemctl start mariadb

-- S√©curiser l'installation
sudo mysql_secure_installation

-- Se connecter
sudo mysql

-- Cr√©er utilisateur SST
CREATE USER 'sst_user'@'localhost' 
    IDENTIFIED BY 'SST_P@ssw0rd_2024!';

GRANT RELOAD, PROCESS, LOCK TABLES, REPLICATION CLIENT 
    ON *.* TO 'sst_user'@'localhost';

-- Utilisateur admin pour applications
CREATE USER 'admin'@'%' 
    IDENTIFIED BY 'Admin_P@ssw0rd_2024!';

GRANT ALL PRIVILEGES ON *.* TO 'admin'@'%' 
    WITH GRANT OPTION;

-- Utilisateur application (exemple)
CREATE USER 'app_user'@'10.0.1.%' 
    IDENTIFIED BY 'App_P@ssw0rd_2024!';

GRANT SELECT, INSERT, UPDATE, DELETE 
    ON application_db.* TO 'app_user'@'10.0.1.%';

FLUSH PRIVILEGES;

-- Arr√™ter MariaDB
sudo systemctl stop mariadb
```

**R√©activer Galera :**
```bash
# D√©commenter wsrep_on dans my.cnf
sed -i 's/# wsrep_on = OFF/wsrep_on = ON/' /etc/mysql/mariadb.conf.d/60-galera.cnf
```

### Bootstrap du premier n≈ìud (galera-01)

```bash
# Sur galera-01 UNIQUEMENT

# M√©thode 1: Utiliser galera_new_cluster (recommand√©)
sudo galera_new_cluster

# M√©thode 2: Bootstrap manuel
# sudo systemctl set-environment _WSREP_NEW_CLUSTER='--wsrep-new-cluster'
# sudo systemctl start mariadb
# sudo systemctl set-environment _WSREP_NEW_CLUSTER=''

# V√©rifier d√©marrage
sudo systemctl status mariadb

# V√©rifier √©tat Galera
sudo mysql -e "SHOW STATUS LIKE 'wsrep_cluster_size';"
# Doit afficher: wsrep_cluster_size = 1

# V√©rifier r√¥le Primary
sudo mysql -e "SHOW STATUS LIKE 'wsrep_cluster_status';"
# Doit afficher: wsrep_cluster_status = Primary

# Statut d√©taill√©
sudo mysql -e "SHOW STATUS LIKE 'wsrep_%';" | grep -E 'wsrep_cluster|wsrep_local|wsrep_ready'
```

**Output attendu du bootstrap :**
```
wsrep_cluster_conf_id         1
wsrep_cluster_size            1
wsrep_cluster_state_uuid      <UUID>
wsrep_cluster_status          Primary
wsrep_local_state_comment     Synced
wsrep_ready                   ON
```

üí° **Point critique** : Ne JAMAIS bootstrapper plusieurs n≈ìuds simultan√©ment. Cela cr√©erait plusieurs clusters s√©par√©s.

### Ajout du second n≈ìud (galera-02)

```bash
# Sur galera-02

# 1. S'assurer que wsrep_cluster_address contient les IPs
#    Configuration d√©j√† pr√©sente dans 60-galera.cnf

# 2. D√©marrer MariaDB normalement
sudo systemctl start mariadb

# 3. Monitoring du SST (State Snapshot Transfer)
# Sur galera-02, surveiller les logs
sudo tail -f /var/log/mysql/error.log

# Vous verrez:
# [Note] WSREP: Requesting state transfer: ...
# [Note] WSREP: Receiving IST: ...
# ou
# [Note] WSREP: Receiving SST: ...
# [Note] WSREP: SST complete, seqno: XXX
# [Note] WSREP: Synchronized with group, ready for connections

# 4. V√©rifier sur galera-01 que le cluster = 2
sudo mysql -e "SHOW STATUS LIKE 'wsrep_cluster_size';"
# wsrep_cluster_size = 2

# 5. V√©rifier sur galera-02
sudo mysql -e "SHOW STATUS LIKE 'wsrep_%';" | grep -E 'cluster_size|local_state_comment|ready'
```

### Ajout du troisi√®me n≈ìud (galera-03)

```bash
# Sur galera-03
# M√™me proc√©dure que galera-02

sudo systemctl start mariadb

# Attendre synchronisation
sudo tail -f /var/log/mysql/error.log

# V√©rifier cluster complet sur n'importe quel n≈ìud
sudo mysql -e "SHOW STATUS LIKE 'wsrep_cluster_size';"
# wsrep_cluster_size = 3
```

### V√©rification du cluster complet

```sql
-- Sur n'importe quel n≈ìud, requ√™te compl√®te de statut
SELECT 
    VARIABLE_NAME,
    VARIABLE_VALUE
FROM information_schema.GLOBAL_STATUS
WHERE VARIABLE_NAME IN (
    'wsrep_cluster_status',
    'wsrep_cluster_size',
    'wsrep_cluster_conf_id',
    'wsrep_local_state_comment',
    'wsrep_ready',
    'wsrep_connected',
    'wsrep_evs_state',
    'wsrep_gcomm_uuid'
)
ORDER BY VARIABLE_NAME;
```

**Output attendu (cluster healthy) :**
```
+---------------------------+--------------------------------------+
| VARIABLE_NAME             | VARIABLE_VALUE                       |
+---------------------------+--------------------------------------+
| wsrep_cluster_conf_id     | 3                                    |
| wsrep_cluster_size        | 3                                    |
| wsrep_cluster_status      | Primary                              |
| wsrep_connected           | ON                                   |
| wsrep_evs_state           | OPERATIONAL                          |
| wsrep_gcomm_uuid          | <UUID identique sur tous les n≈ìuds>  |
| wsrep_local_state_comment | Synced                               |
| wsrep_ready               | ON                                   |
+---------------------------+--------------------------------------+
```

### Test de r√©plication

```sql
-- Sur galera-01, cr√©er une base de test
CREATE DATABASE test_replication;
USE test_replication;

CREATE TABLE test (
    id INT AUTO_INCREMENT PRIMARY KEY,
    node VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

INSERT INTO test (node) VALUES ('galera-01');

-- Sur galera-02, v√©rifier r√©plication
USE test_replication;
SELECT * FROM test;
-- Doit afficher la ligne ins√©r√©e sur galera-01

INSERT INTO test (node) VALUES ('galera-02');

-- Sur galera-03, v√©rifier les deux insertions
USE test_replication;
SELECT * FROM test;
-- Doit afficher les 2 lignes

INSERT INTO test (node) VALUES ('galera-03');

-- Sur galera-01, v√©rifier toutes les insertions
SELECT * FROM test;
-- Doit afficher les 3 lignes

-- ‚úÖ R√©plication multi-master fonctionnelle!
```

---

## State Snapshot Transfer (SST)

### M√©thodes SST disponibles

| M√©thode | Outil | Bloquant | Vitesse | Usage recommand√© |
|---------|-------|----------|---------|------------------|
| **mariabackup** | Mariabackup | Non* | Rapide | **Production** (d√©faut) |
| mysqldump | mysqldump | Non | Lent | Petites BDD, debug |
| rsync | rsync | Oui | Moyen | Legacy |
| xtrabackup | Percona XtraBackup | Non* | Rapide | Alternative mariabackup |

*Bloquant seulement au d√©but (FTWRL courte)

### Configuration SST avec mariabackup (recommand√©)

```ini
# Dans 60-galera.cnf (d√©j√† configur√©)
wsrep_sst_method = mariabackup
wsrep_sst_auth = "sst_user:SST_P@ssw0rd_2024!"
```

**Options avanc√©es mariabackup :**

```ini
# Configuration SST d√©taill√©e
wsrep_sst_method = mariabackup

# Authentication
wsrep_sst_auth = "sst_user:SST_P@ssw0rd_2024!"

# Adresse de r√©ception (optionnel)
# Utile si plusieurs interfaces r√©seau
wsrep_sst_receive_address = "10.0.1.11:4444"

# Options mariabackup via variable syst√®me
# Parall√©lisme pour SST (plus rapide)
[sst]
transferfmt = /usr/bin/mariabackup --parallel=4 --compress --compress-threads=4
```

### Incremental State Transfer (IST)

L'IST est automatique si possible (n≈ìud dans gcache) :

```
Sc√©narios:

1. N≈ìud rejoint apr√®s courte absence:
   ‚îú‚îÄ Gcache contient tous les write-sets manquants
   ‚îî‚îÄ IST utilis√© (rapide, quelques secondes)

2. N≈ìud rejoint apr√®s longue absence:
   ‚îú‚îÄ Gcache ne contient pas tous les write-sets
   ‚îî‚îÄ SST utilis√© (lent, plusieurs minutes/heures)

Configuration gcache pour maximiser IST:
gcache.size = write_rate_MB/s * max_downtime_seconds * 1.5
```

**Monitoring IST vs SST :**

```sql
-- V√©rifier le range du gcache
SHOW STATUS LIKE 'wsrep_local_cached_downto';

-- Dernier seqno commit√©
SHOW STATUS LIKE 'wsrep_last_committed';

-- Si cached_downto proche de last_committed:
-- ‚Üí IST possible
-- Sinon:
-- ‚Üí SST n√©cessaire
```

### Troubleshooting SST

**Probl√®me : SST √©choue avec erreur authentication**

```bash
# V√©rifier utilisateur SST existe
sudo mysql -e "SELECT User, Host FROM mysql.user WHERE User='sst_user';"

# V√©rifier mot de passe dans my.cnf match
grep wsrep_sst_auth /etc/mysql/mariadb.conf.d/60-galera.cnf

# Recr√©er utilisateur si n√©cessaire
sudo mysql -e "DROP USER IF EXISTS 'sst_user'@'localhost';"
sudo mysql -e "CREATE USER 'sst_user'@'localhost' IDENTIFIED BY 'SST_P@ssw0rd_2024!';"
sudo mysql -e "GRANT RELOAD, PROCESS, LOCK TABLES, REPLICATION CLIENT ON *.* TO 'sst_user'@'localhost';"
```

**Probl√®me : SST timeout**

```bash
# Augmenter timeout dans wsrep_provider_options
wsrep_provider_options = "
    ...
    ist.recv_timeout=PT300S;     # 5 minutes au lieu de default 30s
    sst_timeout=PT3600S;         # 1 heure pour grosses BDD
    ...
"
```

---

## S√©curisation du cluster

### TLS/SSL pour Galera communication

üÜï **MariaDB 11.8 : TLS par d√©faut recommand√©**

**G√©n√©ration des certificats (auto-sign√©s pour test) :**

```bash
# Sur un n≈ìud, g√©n√©rer CA et certificats
mkdir -p /etc/mysql/ssl
cd /etc/mysql/ssl

# 1. Cr√©er CA
openssl genrsa 2048 > ca-key.pem
openssl req -new -x509 -nodes -days 3650 -key ca-key.pem -out ca-cert.pem \
    -subj "/C=FR/ST=Brittany/L=Domagne/O=Example/CN=Galera-CA"

# 2. Cr√©er certificat serveur pour chaque n≈ìud
# Pour galera-01:
openssl req -newkey rsa:2048 -days 3650 -nodes -keyout server-key.pem -out server-req.pem \
    -subj "/C=FR/ST=Brittany/L=Domagne/O=Example/CN=galera-01"

openssl rsa -in server-key.pem -out server-key.pem
openssl x509 -req -in server-req.pem -days 3650 -CA ca-cert.pem -CAkey ca-key.pem \
    -set_serial 01 -out server-cert.pem

# 3. Permissions
chown -R mysql:mysql /etc/mysql/ssl
chmod 600 /etc/mysql/ssl/*-key.pem
chmod 644 /etc/mysql/ssl/*-cert.pem

# 4. Copier ca-cert.pem et g√©n√©rer certificats pour galera-02 et galera-03
```

**Configuration SSL dans Galera :**

```ini
# Dans 60-galera.cnf

# SSL pour connexions client ‚Üí serveur
[mysqld]
ssl_cert = /etc/mysql/ssl/server-cert.pem
ssl_key = /etc/mysql/ssl/server-key.pem
ssl_ca = /etc/mysql/ssl/ca-cert.pem

# Forcer SSL pour utilisateurs (optionnel)
# require_secure_transport = ON

# SSL pour Galera replication
wsrep_provider_options = "
    ...
    socket.ssl_key=/etc/mysql/ssl/server-key.pem;
    socket.ssl_cert=/etc/mysql/ssl/server-cert.pem;
    socket.ssl_ca=/etc/mysql/ssl/ca-cert.pem;
    socket.ssl_cipher=AES128-SHA256;
    ...
"
```

**V√©rification SSL :**

```sql
-- V√©rifier SSL activ√©
SHOW VARIABLES LIKE 'have_ssl';
-- Value: YES

-- Statut connexion SSL
\s
-- SSL: Cipher in use is <cipher>

-- Forcer SSL pour un utilisateur
ALTER USER 'admin'@'%' REQUIRE SSL;
```

### Authentification avanc√©e

üÜï **MariaDB 11.8 : Plugin PARSEC disponible**

```sql
-- Installer plugin ed25519 (authentification moderne)
INSTALL SONAME 'auth_ed25519';

-- Cr√©er utilisateur avec ed25519
CREATE USER 'secure_admin'@'%' 
    IDENTIFIED VIA ed25519 
    USING PASSWORD('SecureP@ssw0rd2024!');

GRANT ALL PRIVILEGES ON *.* TO 'secure_admin'@'%';
```

### Audit et logging

```ini
# Dans my.cnf
[mysqld]
# Activer Server Audit Plugin
plugin_load_add = server_audit
server_audit_events = CONNECT,QUERY_DDL,QUERY_DML
server_audit_logging = ON
server_audit_file_path = /var/log/mysql/audit.log
server_audit_file_rotate_size = 100M
server_audit_file_rotations = 10
```

```sql
-- V√©rifier audit actif
SHOW GLOBAL VARIABLES LIKE 'server_audit%';
```

---

## Automatisation et systemd

### Service systemd personnalis√©

```bash
# /etc/systemd/system/galera.service
# Service wrapper pour Galera avec sanity checks

cat << 'EOF' > /etc/systemd/system/galera.service
[Unit]
Description=MariaDB Galera Cluster
After=network.target

[Service]
Type=notify
User=mysql
Group=mysql

# Pre-start checks
ExecStartPre=/usr/local/bin/galera-prestart-check.sh

# Start MariaDB
ExecStart=/usr/sbin/mysqld --defaults-file=/etc/mysql/mariadb.cnf

# Post-start verification
ExecStartPost=/usr/local/bin/galera-poststart-check.sh

# Graceful shutdown
ExecStop=/usr/bin/mysqladmin shutdown
TimeoutStopSec=300

Restart=on-failure
RestartSec=10

# Security
PrivateTmp=true
NoNewPrivileges=true

# Limits
LimitNOFILE=65536
LimitNPROC=65536

[Install]
WantedBy=multi-user.target
EOF
```

**Script pre-start :**

```bash
# /usr/local/bin/galera-prestart-check.sh
cat << 'EOF' > /usr/local/bin/galera-prestart-check.sh
#!/bin/bash
# Pre-start health checks for Galera

set -e

echo "[$(date)] Galera pre-start checks..."

# 1. V√©rifier fichiers de configuration
if [ ! -f /etc/mysql/mariadb.conf.d/60-galera.cnf ]; then
    echo "ERROR: Galera configuration not found"
    exit 1
fi

# 2. V√©rifier datadir
if [ ! -d /var/lib/mysql ]; then
    echo "ERROR: Datadir not found"
    exit 1
fi

# 3. V√©rifier permissions
if [ "$(stat -c '%U' /var/lib/mysql)" != "mysql" ]; then
    echo "ERROR: Incorrect datadir ownership"
    exit 1
fi

# 4. V√©rifier connectivit√© r√©seau aux autres n≈ìuds
for node in 10.0.1.11 10.0.1.12 10.0.1.13; do
    if ! ping -c 1 -W 2 $node > /dev/null 2>&1; then
        echo "WARNING: Cannot reach node $node"
    fi
done

echo "[$(date)] Pre-start checks completed"
exit 0
EOF

chmod +x /usr/local/bin/galera-prestart-check.sh
```

**Script post-start :**

```bash
# /usr/local/bin/galera-poststart-check.sh
cat << 'EOF' > /usr/local/bin/galera-poststart-check.sh
#!/bin/bash
# Post-start verification for Galera

set -e

echo "[$(date)] Galera post-start verification..."

# Attendre que MariaDB soit pr√™t
for i in {1..30}; do
    if mysqladmin ping > /dev/null 2>&1; then
        break
    fi
    sleep 1
done

# V√©rifier wsrep_ready
WSREP_READY=$(mysql -N -e "SHOW STATUS LIKE 'wsrep_ready';" | awk '{print $2}')
if [ "$WSREP_READY" != "ON" ]; then
    echo "ERROR: wsrep_ready is not ON"
    exit 1
fi

# V√©rifier cluster status
CLUSTER_STATUS=$(mysql -N -e "SHOW STATUS LIKE 'wsrep_cluster_status';" | awk '{print $2}')
if [ "$CLUSTER_STATUS" != "Primary" ]; then
    echo "WARNING: Cluster status is $CLUSTER_STATUS (not Primary)"
fi

echo "[$(date)] Post-start verification completed"
exit 0
EOF

chmod +x /usr/local/bin/galera-poststart-check.sh
```

**Activer le service :**

```bash
systemctl daemon-reload
systemctl enable galera.service

# Utilisation
systemctl start galera
systemctl status galera
```

---

## Monitoring et healthchecks

### Script de healthcheck complet

```bash
# /usr/local/bin/galera-healthcheck.sh
cat << 'EOF' > /usr/local/bin/galera-healthcheck.sh
#!/bin/bash
# Galera cluster health check script
# Exit 0 if healthy, 1 if unhealthy

# Configuration
MYSQL_USER="admin"
MYSQL_PASSWORD="Admin_P@ssw0rd_2024!"
MYSQL_HOST="localhost"

# Fonctions
check_mysql_running() {
    mysqladmin -u"$MYSQL_USER" -p"$MYSQL_PASSWORD" -h"$MYSQL_HOST" ping > /dev/null 2>&1
    return $?
}

check_wsrep_ready() {
    local ready=$(mysql -u"$MYSQL_USER" -p"$MYSQL_PASSWORD" -h"$MYSQL_HOST" -N -e \
        "SHOW STATUS LIKE 'wsrep_ready';" | awk '{print $2}')
    [ "$ready" = "ON" ]
    return $?
}

check_cluster_status() {
    local status=$(mysql -u"$MYSQL_USER" -p"$MYSQL_PASSWORD" -h"$MYSQL_HOST" -N -e \
        "SHOW STATUS LIKE 'wsrep_cluster_status';" | awk '{print $2}')
    [ "$status" = "Primary" ]
    return $?
}

check_node_state() {
    local state=$(mysql -u"$MYSQL_USER" -p"$MYSQL_PASSWORD" -h"$MYSQL_HOST" -N -e \
        "SHOW STATUS LIKE 'wsrep_local_state_comment';" | awk '{print $2}')
    [ "$state" = "Synced" ]
    return $?
}

check_recv_queue() {
    local queue=$(mysql -u"$MYSQL_USER" -p"$MYSQL_PASSWORD" -h"$MYSQL_HOST" -N -e \
        "SHOW STATUS LIKE 'wsrep_local_recv_queue';" | awk '{print $2}')
    # Alerte si > 100
    [ "$queue" -lt 100 ]
    return $?
}

# Main health check
main() {
    local exit_code=0
    
    if ! check_mysql_running; then
        echo "CRITICAL: MySQL not running"
        exit_code=1
    fi
    
    if ! check_wsrep_ready; then
        echo "CRITICAL: wsrep_ready is not ON"
        exit_code=1
    fi
    
    if ! check_cluster_status; then
        echo "CRITICAL: Cluster status is not Primary"
        exit_code=1
    fi
    
    if ! check_node_state; then
        echo "WARNING: Node state is not Synced"
        exit_code=1
    fi
    
    if ! check_recv_queue; then
        echo "WARNING: High recv queue"
        # Not critical, don't fail
    fi
    
    if [ $exit_code -eq 0 ]; then
        echo "OK: Node is healthy"
    fi
    
    return $exit_code
}

main
exit $?
EOF

chmod +x /usr/local/bin/galera-healthcheck.sh

# Test
/usr/local/bin/galera-healthcheck.sh
```

### Int√©gration avec load balancer

**HAProxy backend healthcheck :**

```bash
# HAProxy peut utiliser le script ci-dessus via xinetd

# 1. Installer xinetd
apt install -y xinetd

# 2. Cr√©er service mysqlchk
cat << 'EOF' > /etc/xinetd.d/mysqlchk
service mysqlchk
{
    disable = no
    flags = REUSE
    socket_type = stream
    port = 9200
    wait = no
    user = nobody
    server = /usr/local/bin/galera-healthcheck.sh
    log_on_failure += USERID
    only_from = 0.0.0.0/0
    per_source = UNLIMITED
}
EOF

# 3. Ajouter service dans /etc/services
echo "mysqlchk 9200/tcp # Galera Health Check" >> /etc/services

# 4. Restart xinetd
systemctl restart xinetd

# 5. Tester
nc localhost 9200
# Doit afficher: OK: Node is healthy
```

---

## ‚úÖ Points cl√©s √† retenir

- **Pr√©paration infrastructure** : Latence <1ms, 10Gbps r√©seau, SSD/NVMe, firewall configur√© pour ports 3306, 4444, 4567, 4568
- **Installation** : MariaDB 11.8 + Galera 4, configuration modulaire dans `/etc/mysql/mariadb.conf.d/60-galera.cnf`
- **Configuration requise** : `binlog_format=ROW`, `innodb_autoinc_lock_mode=2`, `innodb_flush_log_at_trx_commit=0` (safe dans Galera)
- **Bootstrap** : Un seul n≈ìud bootstrapp√© avec `galera_new_cluster`, jamais simultan√©ment sur plusieurs n≈ìuds
- **SST** : mariabackup recommand√© (non-bloquant), utilisateur `sst_user` requis avec privil√®ges `RELOAD, PROCESS, LOCK TABLES, REPLICATION CLIENT`
- **Gcache sizing** : `write_rate √ó max_downtime √ó 1.5`, critique pour IST vs SST
- **Monitoring essentiel** : `wsrep_cluster_status=Primary`, `wsrep_ready=ON`, `wsrep_local_state_comment=Synced`, `wsrep_cluster_size=3`
- **üÜï MariaDB 11.8** : TLS par d√©faut, `innodb_alter_copy_bulk`, UTF8MB4 default, contr√¥le espace temporaire
- **S√©curit√©** : SSL/TLS pour replication Galera, ed25519 auth, server_audit plugin
- **Automatisation** : systemd service avec pre/post-checks, healthcheck script pour load balancers
- **Validation** : Tests de r√©plication multi-directionnels, v√©rification quorum, IST/SST fonctionnel

---

## üîó Ressources et r√©f√©rences

### Documentation officielle
- [üìñ Getting Started with Galera Cluster](https://mariadb.com/kb/en/getting-started-with-mariadb-galera-cluster/)
- [üìñ Galera Cluster System Variables](https://mariadb.com/kb/en/galera-cluster-system-variables/)
- [üìñ State Snapshot Transfer](https://mariadb.com/kb/en/introduction-to-state-snapshot-transfers-ssts/)
- [üìñ Mariabackup Overview](https://mariadb.com/kb/en/mariabackup-overview/)

### Guides de d√©ploiement
- [Galera Cluster Deployment Guide](https://galeracluster.com/library/documentation/deployment.html)
- [MariaDB Galera Cluster Best Practices](https://mariadb.com/resources/blog/mariadb-galera-cluster-best-practices/)
- [Production-Ready Galera Configuration](https://severalnines.com/database-blog/production-ready-galera-cluster-configuration/)

### Outils
- [ClusterControl](https://severalnines.com/product/clustercontrol) - D√©ploiement et gestion Galera
- [Ansible Role for Galera](https://galaxy.ansible.com/bertvv/mariadb) - Automatisation d√©ploiement
- [Terraform Provider MariaDB](https://registry.terraform.io/providers/hashicorp/mysql/latest/docs) - IaC

---

## ‚û°Ô∏è Section suivante

**14.2.4 State transfers (SST, IST)** : Approfondissement des m√©canismes de transfert d'√©tat, optimisation des SST pour grosses bases de donn√©es, troubleshooting avanc√©, et strat√©gies de minimisation de l'impact sur la production.

---


‚è≠Ô∏è [State transfers (SST, IST)](/14-haute-disponibilite/02.4-state-transfers.md)
