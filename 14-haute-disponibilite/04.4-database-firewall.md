üîù Retour au [Sommaire](/SOMMAIRE.md)

# 14.4.4 Database Firewall

> **Niveau** : Expert  
> **Dur√©e estim√©e** : 4-5 heures  
> **Pr√©requis** : Query Routing (14.4.3), S√©curit√© MariaDB (10), RegEx, Architecture s√©curis√©e

## üéØ Objectifs d'apprentissage

√Ä l'issue de cette section, vous serez capable de :
- Impl√©menter un Database Firewall avec MaxScale
- Prot√©ger contre les injections SQL et attaques communes
- Configurer whitelist/blacklist de requ√™tes
- Mettre en place des limitations par utilisateur, IP et timing
- Auditer et logger les acc√®s sensibles
- Int√©grer avec des syst√®mes SIEM et alerting
- D√©ployer une d√©fense en profondeur (Defense in Depth)
- Monitorer et analyser les tentatives d'intrusion

---

## Introduction

Un **Database Firewall** est une couche de s√©curit√© qui inspecte et contr√¥le le trafic SQL entre les applications et les bases de donn√©es. MaxScale fournit des capacit√©s de firewall avanc√©es via plusieurs m√©canismes :

```
Architecture Database Firewall:

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Applications                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                 ‚îÇ
‚îÇ  ‚îÇ  App 1   ‚îÇ  ‚îÇ  App 2   ‚îÇ  ‚îÇ  App 3   ‚îÇ                 ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ             ‚îÇ             ‚îÇ
        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ    MaxScale Firewall    ‚îÇ
         ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
         ‚îÇ  ‚îÇ 1. SQL Injection ‚îÇ   ‚îÇ
         ‚îÇ  ‚îÇ    Detection     ‚îÇ   ‚îÇ
         ‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§   ‚îÇ
         ‚îÇ  ‚îÇ 2. Query Pattern ‚îÇ   ‚îÇ
         ‚îÇ  ‚îÇ    Matching      ‚îÇ   ‚îÇ
         ‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§   ‚îÇ
         ‚îÇ  ‚îÇ 3. Rate Limiting ‚îÇ   ‚îÇ
         ‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§   ‚îÇ
         ‚îÇ  ‚îÇ 4. Access Control‚îÇ   ‚îÇ
         ‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§   ‚îÇ
         ‚îÇ  ‚îÇ 5. Audit Logging ‚îÇ   ‚îÇ
         ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
         ‚îÇ    Backend Databases    ‚îÇ
         ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ
         ‚îÇ  ‚îÇ DB 1 ‚îÇ  ‚îÇ DB 2 ‚îÇ     ‚îÇ
         ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ DB 3 ‚îÇ     ‚îÇ
         ‚îÇ            ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

B√©n√©fices:
‚úÖ Protection contre injections SQL
‚úÖ Contr√¥le granulaire des requ√™tes
‚úÖ Audit et conformit√© (GDPR, SOC2, etc.)
‚úÖ Rate limiting anti-DoS
‚úÖ D√©tection d'anomalies
‚úÖ Z√©ro modification application
```

---

## Protection contre les injections SQL

### Vecteurs d'attaque communs

**Types d'injections SQL :**

```sql
-- 1. Union-based injection
SELECT * FROM users WHERE id = 1 
UNION SELECT username, password FROM admin_users;

-- 2. Boolean-based blind injection
SELECT * FROM products WHERE id = 1 AND 1=1;  -- True
SELECT * FROM products WHERE id = 1 AND 1=2;  -- False

-- 3. Time-based blind injection
SELECT * FROM users WHERE id = 1 AND SLEEP(5);

-- 4. Error-based injection
SELECT * FROM users WHERE id = 1' AND extractvalue(1,concat(0x7e,(SELECT @@version)))--

-- 5. Stacked queries
SELECT * FROM users; DROP TABLE users;--

-- 6. Comment-based bypass
SELECT * FROM users WHERE username = 'admin'--' AND password = 'x'

-- 7. Second-order injection
INSERT INTO logs (message) VALUES ('admin'' OR ''1''=''1');
-- Plus tard:
SELECT * FROM logs WHERE message = '[injection pr√©c√©dente]'
```

### Configuration anti-injection

**R√®gles regexfilter pour bloquer injections :**

```regex
# /etc/maxscale.d/sql_injection_rules.txt
# Database Firewall - SQL Injection Protection

# === Union-based injection ===
(?i).*UNION.*SELECT.*                                   deny    log=/var/log/maxscale/security.log
(?i).*UNION\s+ALL\s+SELECT.*                            deny    log=/var/log/maxscale/security.log

# === Comment-based bypass ===
.*;.*--.*                                                deny    log=/var/log/maxscale/security.log
.*\/\*.*\*\/.*                                          deny    log=/var/log/maxscale/security.log
.*#.*                                                    deny    log=/var/log/maxscale/security.log

# === Boolean injections ===
(?i).*\s+OR\s+1\s*=\s*1.*                               deny    log=/var/log/maxscale/security.log
(?i).*\s+OR\s+'1'\s*=\s*'1'.*                           deny    log=/var/log/maxscale/security.log
(?i).*\s+OR\s+'a'\s*=\s*'a'.*                           deny    log=/var/log/maxscale/security.log
(?i).*\s+AND\s+1\s*=\s*1.*(?!WHERE).*                   deny    log=/var/log/maxscale/security.log

# === Time-based injections ===
(?i).*SLEEP\s*\(.*                                       deny    log=/var/log/maxscale/security.log
(?i).*BENCHMARK\s*\(.*                                   deny    log=/var/log/maxscale/security.log
(?i).*WAIT\s+FOR\s+DELAY.*                              deny    log=/var/log/maxscale/security.log

# === Stacked queries ===
.*;.*DROP\s+TABLE.*                                      deny    log=/var/log/maxscale/security.log
.*;.*DELETE\s+FROM.*                                     deny    log=/var/log/maxscale/security.log
.*;.*INSERT\s+INTO.*                                     deny    log=/var/log/maxscale/security.log

# === Information disclosure ===
(?i).*extractvalue.*                                     deny    log=/var/log/maxscale/security.log
(?i).*updatexml.*                                        deny    log=/var/log/maxscale/security.log
(?i).*SELECT.*@@version.*                                deny    log=/var/log/maxscale/security.log
(?i).*SELECT.*USER\(\).*                                deny    log=/var/log/maxscale/security.log
(?i).*SELECT.*DATABASE\(\).*                            deny    log=/var/log/maxscale/security.log

# === System commands ===
(?i).*LOAD_FILE.*                                        deny    log=/var/log/maxscale/security.log
(?i).*INTO\s+OUTFILE.*                                   deny    log=/var/log/maxscale/security.log
(?i).*INTO\s+DUMPFILE.*                                  deny    log=/var/log/maxscale/security.log

# === Hex/Binary encoding bypass ===
.*0x[0-9a-fA-F]+.*                                       match   log=/var/log/maxscale/security.log
(?i).*CHAR\s*\(.*                                        match   log=/var/log/maxscale/security.log

# === Suspicious patterns ===
.*'.*'.*=.*'.*'.*                                        match   log=/var/log/maxscale/security.log
.*".*".*=.*".*".*                                        match   log=/var/log/maxscale/security.log
```

**Configuration MaxScale :**

```ini
# /etc/maxscale.cnf

[SQL-Injection-Filter]
type = filter
module = regexfilter
rules = /etc/maxscale.d/sql_injection_rules.txt

# Logging
log_match = true
log_nomatch = false

# Action sur match
strict_mode = true  # Bloque toutes injections d√©tect√©es

[Firewall-Service]
type = service
router = readwritesplit
servers = server1, server2, server3

user = maxscale_router
password = Router_P@ssw0rd_2024!

# Appliquer firewall
filters = SQL-Injection-Filter

# Listeners
[Firewall-Listener]
type = listener
service = Firewall-Service
protocol = MariaDBClient
port = 3306
address = 0.0.0.0
```

### Validation param√©trique

**Alternative : Whitelist des requ√™tes autoris√©es**

```ini
# /etc/maxscale.d/query_whitelist.txt
# Seulement ces patterns sont autoris√©s

# Login
^SELECT\s+\*\s+FROM\s+users\s+WHERE\s+username\s*=\s*\?.*       allow
^SELECT\s+id,\s*username,\s*email\s+FROM\s+users\s+WHERE\s+id\s*=\s*\?.*  allow

# CRUD operations
^INSERT\s+INTO\s+orders\s+\(.*\)\s+VALUES\s+\(.*\).*            allow
^UPDATE\s+products\s+SET\s+.*\s+WHERE\s+id\s*=\s*\?.*          allow
^DELETE\s+FROM\s+cart\s+WHERE\s+user_id\s*=\s*\?.*             allow

# Recherche
^SELECT\s+\*\s+FROM\s+products\s+WHERE\s+category\s*=\s*\?.*   allow
^SELECT\s+\*\s+FROM\s+products\s+WHERE\s+name\s+LIKE\s+\?.*    allow

# Tout le reste: DENY par d√©faut
.*                                                               deny   log=/var/log/maxscale/denied.log
```

üí° **Approche Whitelist vs Blacklist :**
- **Whitelist** (recommand√©) : Plus s√ªr, seulement patterns connus autoris√©s
- **Blacklist** : Plus flexible, bloque patterns dangereux connus
- **Hybride** : Whitelist pour production, blacklist pour d√©veloppement

---

## Contr√¥le d'acc√®s granulaire

### Limitation par utilisateur

**Configuration :**

```ini
# /etc/maxscale.d/user_restrictions.txt
# Restrictions par utilisateur

# Utilisateur readonly: Seulement SELECT
user=readonly_user query_type=SELECT                     allow
user=readonly_user query_type=(INSERT|UPDATE|DELETE)     deny   log=/var/log/maxscale/access_denied.log

# Utilisateur app: CRUD seulement
user=app_user query_type=(SELECT|INSERT|UPDATE|DELETE)   allow
user=app_user query_type=(CREATE|ALTER|DROP)             deny   log=/var/log/maxscale/ddl_denied.log

# Admin: Tout autoris√©
user=admin_user .*                                        allow  log=/var/log/maxscale/admin_access.log

# Analytics: Seulement SELECT sur tables analytics_*
user=analytics_user query=^SELECT.*FROM\s+analytics_.*   allow
user=analytics_user .*                                    deny
```

### Limitation par IP source

**Configuration IP-based restrictions :**

```ini
# /etc/maxscale.d/ip_restrictions.txt
# Access control par IP

# R√©seau interne: Acc√®s complet
source_ip=10.0.0.0/8 .*                                   allow

# R√©seau DMZ: Seulement lectures
source_ip=192.168.1.0/24 query_type=SELECT                allow
source_ip=192.168.1.0/24 query_type=(INSERT|UPDATE|DELETE) deny

# VPN: Acc√®s admin restreint
source_ip=172.16.0.0/16 user=admin_user .*                allow
source_ip=172.16.0.0/16 user!=admin_user query_type=SELECT allow
source_ip=172.16.0.0/16 user!=admin_user query_type=(INSERT|UPDATE|DELETE|CREATE|ALTER|DROP) deny

# Internet public: Bloqu√© par d√©faut
source_ip=0.0.0.0/0 .*                                    deny   log=/var/log/maxscale/public_access_attempt.log
```

**MaxScale avec filtres IP :**

```ini
[IP-Filter]
type = filter
module = regexfilter
rules = /etc/maxscale.d/ip_restrictions.txt

# Source IP tracking
track_source_ip = true

[Secure-Service]
type = service
router = readwritesplit
servers = server1, server2, server3
filters = IP-Filter, SQL-Injection-Filter
```

### Limitation temporelle

**Restrictions par horaires :**

```bash
# /usr/local/bin/maxscale-time-based-firewall.sh
# Firewall temporel (via cron)

#!/bin/bash
HOUR=$(date +%H)
DAY=$(date +%u)  # 1=Lundi, 7=Dimanche

# Heures ouvrables (8h-18h, Lun-Ven)
if [ $DAY -le 5 ] && [ $HOUR -ge 8 ] && [ $HOUR -lt 18 ]; then
    # Production normale
    cp /etc/maxscale.d/firewall_normal.txt /etc/maxscale.d/firewall_active.txt
    
# Week-end ou nuit
else
    # Mode restrictif
    cp /etc/maxscale.d/firewall_restricted.txt /etc/maxscale.d/firewall_active.txt
fi

# Reload rules
maxctrl call command regexfilter reload Firewall-Filter

# Log changement
echo "$(date): Firewall mode updated" >> /var/log/maxscale/firewall_schedule.log
```

**Crontab :**

```cron
# /etc/cron.d/maxscale-firewall-schedule
# V√©rifier et ajuster firewall toutes les heures
0 * * * * root /usr/local/bin/maxscale-time-based-firewall.sh
```

**R√®gles restrictives (nuit/week-end) :**

```regex
# /etc/maxscale.d/firewall_restricted.txt
# Mode restrictif (hors heures ouvrables)

# Seulement SELECT autoris√©
query_type=SELECT                                         allow

# Tout le reste bloqu√©
query_type=(INSERT|UPDATE|DELETE)                         deny   log=/var/log/maxscale/after_hours_write.log
query_type=(CREATE|ALTER|DROP)                            deny   log=/var/log/maxscale/after_hours_ddl.log

# Exception: Utilisateur batch autoris√©
user=batch_user .*                                        allow  log=/var/log/maxscale/batch_access.log
```

---

## Rate Limiting et protection DoS

### Limitation de requ√™tes par session

**Configuration throttling :**

```ini
# /etc/maxscale.cnf

[Throttle-Filter]
type = filter
module = throttlefilter

# Limites globales
max_qps = 1000                    # 1000 requ√™tes/seconde global
sampling_duration = 1000ms        # Fen√™tre de mesure

# Limites par utilisateur
throttling_duration = 10000ms     # Dur√©e throttling si d√©passement
max_qps_per_user = 100            # 100 req/s par utilisateur

# Limites par type de requ√™te
max_select_qps = 800              # Max SELECT/s
max_write_qps = 200               # Max INSERT/UPDATE/DELETE/s

# Action si d√©passement
throttle_action = delay           # Options: delay, reject
delay_duration = 1000ms           # D√©lai impos√©

# Logging
log_throttling = true
log_file = /var/log/maxscale/throttle.log

[Protected-Service]
type = service
router = readwritesplit
servers = server1, server2, server3
filters = Throttle-Filter, SQL-Injection-Filter
```

### Connection limiting

**Limiter connexions simultan√©es :**

```ini
[Connection-Limiter-Filter]
type = filter
module = maxscale-connection-limiter

# Limite globale
max_connections = 1000

# Limite par utilisateur
max_connections_per_user = 50

# Limite par IP source
max_connections_per_ip = 100

# Action si d√©passement
reject_excess_connections = true

# Message d'erreur
error_message = "Connection limit exceeded. Please try again later."

# Whitelist (pas de limite)
whitelist_users = admin_user,monitoring_user
whitelist_ips = 10.0.1.100,10.0.1.101  # Serveurs internes

[DoS-Protected-Service]
type = service
router = readwritesplit
servers = server1, server2, server3
filters = Connection-Limiter-Filter, Throttle-Filter
```

### D√©tection d'anomalies

**Pattern de d√©tection comportementale :**

```python
# /usr/local/bin/maxscale-anomaly-detector.py
# D√©tecteur d'anomalies bas√© sur analyse logs

import re
import time
from collections import defaultdict, deque
from datetime import datetime, timedelta

class AnomalyDetector:
    def __init__(self):
        self.query_history = defaultdict(lambda: deque(maxlen=100))
        self.user_baselines = {}
        
    def analyze_pattern(self, user, query, timestamp):
        """
        D√©tecte anomalies comportementales
        """
        # Stocker historique
        self.query_history[user].append({
            'query': query,
            'timestamp': timestamp
        })
        
        # Calculer baseline si suffisant d'historique
        if len(self.query_history[user]) >= 50:
            self.update_baseline(user)
        
        # D√©tecter anomalies
        anomalies = []
        
        # 1. Fr√©quence inhabituelle
        recent_queries = [q for q in self.query_history[user] 
                         if timestamp - q['timestamp'] < timedelta(minutes=5)]
        if len(recent_queries) > 100:  # >100 requ√™tes en 5min
            anomalies.append({
                'type': 'high_frequency',
                'severity': 'HIGH',
                'details': f'{len(recent_queries)} queries in 5 minutes'
            })
        
        # 2. Pattern inhabituel (query jamais vue)
        if not self.is_known_pattern(user, query):
            anomalies.append({
                'type': 'unknown_pattern',
                'severity': 'MEDIUM',
                'details': f'New query pattern: {query[:100]}'
            })
        
        # 3. Acc√®s inhabituel (heure inhabituelle)
        hour = timestamp.hour
        if hour not in self.get_normal_hours(user):
            anomalies.append({
                'type': 'unusual_time',
                'severity': 'MEDIUM',
                'details': f'Query at unusual hour: {hour}h'
            })
        
        return anomalies
    
    def update_baseline(self, user):
        """Mettre √† jour baseline comportemental"""
        # Calculer patterns normaux
        # (impl√©mentation simplifi√©e)
        pass
    
    def is_known_pattern(self, user, query):
        """V√©rifier si query pattern connu"""
        # Normaliser query (remplacer valeurs par ?)
        normalized = re.sub(r'\d+', '?', query)
        normalized = re.sub(r"'[^']*'", '?', normalized)
        
        # Chercher dans historique
        for hist_query in self.query_history[user]:
            hist_normalized = re.sub(r'\d+', '?', hist_query['query'])
            hist_normalized = re.sub(r"'[^']*'", '?', hist_normalized)
            if normalized == hist_normalized:
                return True
        return False
    
    def get_normal_hours(self, user):
        """Retourner heures normales pour user"""
        # Analyser historique pour d√©terminer heures habituelles
        hours = [q['timestamp'].hour for q in self.query_history[user]]
        # Retourner heures repr√©sentant >80% du trafic
        # (impl√©mentation simplifi√©e)
        return range(8, 18)  # 8h-18h par d√©faut

# Utilisation
detector = AnomalyDetector()

# Analyse query
anomalies = detector.analyze_pattern(
    user='app_user',
    query='SELECT * FROM users WHERE id = 123',
    timestamp=datetime.now()
)

if anomalies:
    for anomaly in anomalies:
        print(f"ANOMALY [{anomaly['severity']}]: {anomaly['type']} - {anomaly['details']}")
        # Envoyer alerte
```

---

## Audit et logging de s√©curit√©

### Configuration audit avanc√©

**Logging s√©lectif par criticit√© :**

```ini
# /etc/maxscale.d/audit_rules.txt
# Audit logging avec niveaux de criticit√©

# === CRITICAL: Modifications donn√©es sensibles ===
(?i)(INSERT|UPDATE|DELETE).*\s+(users|passwords|payment_methods|credit_cards).*  
    log=/var/log/maxscale/audit_critical.log   
    include_user=true 
    include_timestamp=true 
    include_source_ip=true

# === HIGH: Acc√®s donn√©es personnelles (GDPR) ===
(?i)SELECT.*(email|phone|address|ssn|passport).*  
    log=/var/log/maxscale/audit_pii.log   
    include_user=true 
    include_timestamp=true

# === MEDIUM: Modifications structure ===
(?i)(CREATE|ALTER|DROP)\s+(TABLE|DATABASE|INDEX).*  
    log=/var/log/maxscale/audit_ddl.log   
    include_user=true 
    include_timestamp=true

# === LOW: Acc√®s tables audit ===
(?i)SELECT.*FROM\s+audit_.*  
    log=/var/log/maxscale/audit_access.log   
    include_user=true

# === INFO: Requ√™tes admin ===
user=admin_user .*  
    log=/var/log/maxscale/admin_activity.log   
    include_timestamp=true 
    include_query=true
```

**Format de log structur√© (JSON) :**

```json
// /var/log/maxscale/audit_critical.log
{
  "timestamp": "2024-12-15T14:35:22.123Z",
  "level": "CRITICAL",
  "event_type": "data_modification",
  "user": "app_user",
  "source_ip": "10.0.1.50",
  "database": "production_db",
  "table": "users",
  "query_type": "UPDATE",
  "query": "UPDATE users SET password_hash = '...' WHERE id = 123",
  "rows_affected": 1,
  "server": "server1",
  "session_id": "abc123def456"
}
```

### Int√©gration SIEM

**Export vers Splunk/ELK/Datadog :**

```bash
# /usr/local/bin/maxscale-to-siem.sh
# Export logs MaxScale vers SIEM

#!/bin/bash
LOG_FILE="/var/log/maxscale/audit_critical.log"
SIEM_ENDPOINT="https://siem.example.com/api/events"
API_KEY="your-siem-api-key"

# Surveiller fichier avec inotify
inotifywait -m -e modify "$LOG_FILE" | while read -r directory event filename; do
    # Lire derni√®re ligne
    LAST_LINE=$(tail -n 1 "$LOG_FILE")
    
    # Envoyer √† SIEM
    curl -X POST "$SIEM_ENDPOINT" \
        -H "Authorization: Bearer $API_KEY" \
        -H "Content-Type: application/json" \
        -d "$LAST_LINE"
done
```

**Configuration Filebeat (ELK Stack) :**

```yaml
# /etc/filebeat/filebeat.yml
filebeat.inputs:
  - type: log
    enabled: true
    paths:
      - /var/log/maxscale/audit_*.log
      - /var/log/maxscale/security.log
    
    # Parse JSON
    json.keys_under_root: true
    json.add_error_key: true
    
    # Metadata
    fields:
      source: maxscale
      environment: production
      severity: security
    
    # Multiline pour stack traces
    multiline.pattern: '^{'
    multiline.negate: true
    multiline.match: after

output.elasticsearch:
  hosts: ["elasticsearch.example.com:9200"]
  index: "maxscale-security-%{+yyyy.MM.dd}"
  
  # Authentication
  username: "filebeat"
  password: "password"

# Processors
processors:
  - add_host_metadata: ~
  - add_cloud_metadata: ~
  - drop_fields:
      fields: ["agent", "ecs"]
```

### Alerting temps r√©el

**Configuration Alertmanager (Prometheus) :**

```yaml
# /etc/prometheus/rules/maxscale_security.yml
groups:
  - name: maxscale_security
    interval: 30s
    rules:
      # Alerte injection SQL d√©tect√©e
      - alert: SQLInjectionAttempt
        expr: increase(maxscale_security_denied_queries_total{reason="sql_injection"}[5m]) > 0
        for: 0m
        labels:
          severity: critical
          category: security
        annotations:
          summary: "SQL Injection attempt detected"
          description: "{{ $value }} SQL injection attempts in last 5 minutes from {{ $labels.source_ip }}"
      
      # Alerte acc√®s non autoris√©
      - alert: UnauthorizedAccess
        expr: increase(maxscale_security_denied_queries_total{reason="access_denied"}[5m]) > 10
        for: 2m
        labels:
          severity: high
          category: security
        annotations:
          summary: "Multiple unauthorized access attempts"
          description: "{{ $value }} access denied events from user {{ $labels.user }}"
      
      # Alerte DoS (trop de requ√™tes)
      - alert: PossibleDoSAttack
        expr: rate(maxscale_queries_total[1m]) > 10000
        for: 5m
        labels:
          severity: high
          category: availability
        annotations:
          summary: "Abnormally high query rate detected"
          description: "{{ $value }} queries per second (threshold: 10000)"
      
      # Alerte acc√®s hors heures
      - alert: AfterHoursAccess
        expr: |
          (hour() < 8 or hour() > 18) and 
          increase(maxscale_queries_total{user!="batch_user"}[5m]) > 0
        for: 0m
        labels:
          severity: medium
          category: security
        annotations:
          summary: "After-hours database access detected"
          description: "User {{ $labels.user }} accessing database outside business hours"
```

---

## Defense in Depth (D√©fense en profondeur)

### Architecture multi-couches

**Stack de s√©curit√© complet :**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Layer 7: Application                       ‚îÇ
‚îÇ  - Input validation                                         ‚îÇ
‚îÇ  - Parameterized queries                                    ‚îÇ
‚îÇ  - ORM security                                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Layer 6: Network Firewall                  ‚îÇ
‚îÇ  - IP filtering (iptables/nftables)                         ‚îÇ
‚îÇ  - Port restrictions                                        ‚îÇ
‚îÇ  - Rate limiting                                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Layer 5: MaxScale Firewall                 ‚îÇ
‚îÇ  - SQL injection detection                                  ‚îÇ
‚îÇ  - Query pattern matching                                   ‚îÇ
‚îÇ  - User/IP/Time restrictions                                ‚îÇ
‚îÇ  - Rate limiting                                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Layer 4: MariaDB Security                  ‚îÇ
‚îÇ  - User authentication (ed25519)                            ‚îÇ
‚îÇ  - Privileges (GRANT/REVOKE)                                ‚îÇ
‚îÇ  - SSL/TLS encryption                                       ‚îÇ
‚îÇ  - Server audit plugin                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Layer 3: OS Security                       ‚îÇ
‚îÇ  - SELinux/AppArmor                                         ‚îÇ
‚îÇ  - File permissions                                         ‚îÇ
‚îÇ  - Process isolation                                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Layer 2: Encryption at Rest                ‚îÇ
‚îÇ  - InnoDB encryption                                        ‚îÇ
‚îÇ  - Filesystem encryption (LUKS)                             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                      ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  Layer 1: Physical Security                 ‚îÇ
‚îÇ  - Datacenter access control                                ‚îÇ
‚îÇ  - Hardware security                                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Configuration compl√®te defense-in-depth

**MaxScale avec stack de filtres :**

```ini
# /etc/maxscale.cnf - Security Hardened Configuration

[maxscale]
threads = auto
admin_host = 127.0.0.1  # Admin seulement local
admin_secure_gui = true

#
# === Security Filters (ordre important!) ===
#

# 1. Connection limiter (premi√®re ligne de d√©fense)
[Connection-Limiter]
type = filter
module = maxscale-connection-limiter
max_connections = 1000
max_connections_per_user = 50
max_connections_per_ip = 100
reject_excess_connections = true

# 2. Rate limiter (anti-DoS)
[Rate-Limiter]
type = filter
module = throttlefilter
max_qps = 1000
max_qps_per_user = 100
throttle_action = delay
log_throttling = true

# 3. IP-based access control
[IP-ACL]
type = filter
module = regexfilter
rules = /etc/maxscale.d/ip_restrictions.txt
log_match = true

# 4. SQL Injection detector
[SQL-Injection-Detector]
type = filter
module = regexfilter
rules = /etc/maxscale.d/sql_injection_rules.txt
log_match = true

# 5. Query whitelist (strictest)
[Query-Whitelist]
type = filter
module = regexfilter
rules = /etc/maxscale.d/query_whitelist.txt
log_match = true

# 6. Audit logger
[Audit-Logger]
type = filter
module = regexfilter
rules = /etc/maxscale.d/audit_rules.txt
log_match = true

#
# === Service with full security stack ===
#
[Hardened-Service]
type = service
router = readwritesplit
servers = server1, server2, server3

user = maxscale_router
password = Router_P@ssw0rd_2024!

# Cha√Æne de filtres (ordre d'ex√©cution)
filters = Connection-Limiter, Rate-Limiter, IP-ACL, SQL-Injection-Detector, Query-Whitelist, Audit-Logger

# SSL/TLS obligatoire
ssl = required
ssl_cert = /etc/maxscale/ssl/server-cert.pem
ssl_key = /etc/maxscale/ssl/server-key.pem
ssl_ca = /etc/maxscale/ssl/ca-cert.pem

# Timeouts s√©curis√©s
connection_timeout = 60s
net_write_timeout = 30s

#
# === Listener avec SSL ===
#
[Hardened-Listener]
type = listener
service = Hardened-Service
protocol = MariaDBClient
port = 3306
address = 0.0.0.0

# SSL obligatoire
ssl = required
ssl_cert = /etc/maxscale/ssl/server-cert.pem
ssl_key = /etc/maxscale/ssl/server-key.pem
ssl_ca = /etc/maxscale/ssl/ca-cert.pem
ssl_version = TLSv1.2,TLSv1.3
```

---

## Monitoring et incident response

### Dashboard de s√©curit√©

**M√©triques Prometheus :**

```promql
# Tentatives d'injection SQL (5 minutes)
increase(maxscale_security_denied_queries_total{reason="sql_injection"}[5m])

# Taux de blocage (%)
(maxscale_security_denied_queries_total / maxscale_queries_total) * 100

# Top 10 utilisateurs bloqu√©s
topk(10, sum by (user) (increase(maxscale_security_denied_queries_total[1h])))

# Top 10 IPs suspectes
topk(10, sum by (source_ip) (increase(maxscale_security_denied_queries_total[1h])))

# Anomalies (requ√™tes/seconde inhabituelles)
rate(maxscale_queries_total[1m]) > 
  (avg_over_time(rate(maxscale_queries_total[1m])[1h]) * 3)
```

**Dashboard Grafana - Panels cl√©s :**

```json
{
  "dashboard": {
    "title": "MaxScale Security Dashboard",
    "panels": [
      {
        "title": "SQL Injection Attempts",
        "type": "graph",
        "targets": [
          {
            "expr": "increase(maxscale_security_denied_queries_total{reason='sql_injection'}[5m])"
          }
        ]
      },
      {
        "title": "Top Blocked Users",
        "type": "table",
        "targets": [
          {
            "expr": "topk(10, sum by (user) (increase(maxscale_security_denied_queries_total[1h])))"
          }
        ]
      },
      {
        "title": "Geographic Distribution of Attacks",
        "type": "geomap",
        "targets": [
          {
            "expr": "sum by (country) (increase(maxscale_security_denied_queries_total[1h]))"
          }
        ]
      },
      {
        "title": "Security Events Timeline",
        "type": "timeline",
        "targets": [
          {
            "expr": "maxscale_security_denied_queries_total"
          }
        ]
      }
    ]
  }
}
```

### Incident response playbook

**Proc√©dure r√©ponse √† incident :**

```bash
#!/bin/bash
# /usr/local/bin/maxscale-incident-response.sh
# Playbook automatique de r√©ponse √† incident

INCIDENT_TYPE=$1  # sql_injection, dos_attack, unauthorized_access
SEVERITY=$2       # low, medium, high, critical

log_incident() {
    echo "[$(date)] INCIDENT: $INCIDENT_TYPE (Severity: $SEVERITY)" >> /var/log/maxscale/incidents.log
}

# 1. Logger l'incident
log_incident

case $SEVERITY in
    critical)
        # Incident critique: Actions imm√©diates
        
        # Bloquer IP source si connue
        if [ -n "$SOURCE_IP" ]; then
            iptables -A INPUT -s $SOURCE_IP -j DROP
            echo "Blocked IP: $SOURCE_IP" >> /var/log/maxscale/incidents.log
        fi
        
        # Activer mode lockdown (seulement lecture)
        cp /etc/maxscale.d/firewall_lockdown.txt /etc/maxscale.d/firewall_active.txt
        maxctrl call command regexfilter reload Firewall-Filter
        
        # Alerter √©quipe s√©curit√©
        /usr/local/bin/send-alert.sh "CRITICAL SECURITY INCIDENT" "$INCIDENT_TYPE detected"
        
        # Cr√©er snapshot pour forensics
        mysqldump --all-databases > /var/backups/incident_$(date +%Y%m%d_%H%M%S).sql
        
        # Collecter logs
        tar -czf /var/backups/logs_$(date +%Y%m%d_%H%M%S).tar.gz \
            /var/log/maxscale/*.log \
            /var/log/mysql/*.log
        
        ;;
    
    high)
        # Incident haute s√©v√©rit√©
        
        # Activer logging verbose
        maxctrl alter service Hardened-Service log_debug true
        
        # Alerter √©quipe
        /usr/local/bin/send-alert.sh "HIGH SECURITY INCIDENT" "$INCIDENT_TYPE detected"
        
        # Restreindre temporairement
        # (exemple: rate limit plus strict)
        
        ;;
    
    medium)
        # Incident moyen
        
        # Logger et monitorer
        /usr/local/bin/send-alert.sh "MEDIUM SECURITY EVENT" "$INCIDENT_TYPE detected"
        
        ;;
    
    low)
        # Incident faible
        
        # Logging seulement
        echo "Low severity incident: $INCIDENT_TYPE" >> /var/log/maxscale/incidents.log
        
        ;;
esac
```

**R√®gles de lockdown (mode critique) :**

```regex
# /etc/maxscale.d/firewall_lockdown.txt
# Mode lockdown: Seulement lectures essentielles

# Seulement SELECT autoris√©
query_type=SELECT user=readonly_user                      allow

# Admin seulement depuis IP interne
source_ip=10.0.1.100 user=admin_user .*                   allow

# Tout le reste DENY
.*                                                         deny   log=/var/log/maxscale/lockdown_denied.log
```

---

## Conformit√© et r√©glementation

### GDPR (R√®glement G√©n√©ral sur la Protection des Donn√©es)

**Configuration audit GDPR :**

```ini
# /etc/maxscale.d/gdpr_audit.txt
# Audit acc√®s donn√©es personnelles (GDPR Art. 30)

# Logging acc√®s PII (Personally Identifiable Information)
(?i)SELECT.*(email|phone|address|birthdate|ssn|passport|credit_card).*  
    log=/var/log/maxscale/gdpr_access.log   
    include_user=true 
    include_timestamp=true 
    include_source_ip=true
    include_purpose=true

# Logging modifications PII
(?i)(INSERT|UPDATE|DELETE).*\s+(users|customers|contacts).*  
    log=/var/log/maxscale/gdpr_modifications.log   
    include_user=true 
    include_timestamp=true

# Logging exports de donn√©es (Art. 20 - Portabilit√©)
(?i)SELECT.*INTO\s+OUTFILE.*  
    log=/var/log/maxscale/gdpr_exports.log   
    include_user=true 
    include_timestamp=true
    alert=true  # Alerte imm√©diate

# Logging suppressions (Art. 17 - Droit √† l'oubli)
(?i)DELETE.*FROM\s+(users|customers).*  
    log=/var/log/maxscale/gdpr_deletions.log   
    include_user=true 
    include_timestamp=true
    include_justification=true
```

### SOC 2 / ISO 27001

**Contr√¥les d'acc√®s SOC 2 :**

```ini
# /etc/maxscale.d/soc2_controls.txt
# SOC 2 Type II - Access Controls

# CC6.1: Logical Access - Authentification forte
user=* source_ip!=10.0.0.0/8                              deny   log=/var/log/maxscale/external_access.log

# CC6.2: Autorisation bas√©e sur r√¥le
user=developer query_type=(CREATE|ALTER|DROP)             deny   log=/var/log/maxscale/unauthorized_ddl.log

# CC6.3: S√©paration des environnements
database=production user!=prod_user                        deny   log=/var/log/maxscale/env_violation.log

# CC6.6: Logging et monitoring
.*                                                         log=/var/log/maxscale/soc2_audit.log include_all=true

# CC7.2: D√©tection d'intrusion
# (G√©r√© par syst√®me d'analyse comportementale)
```

### PCI-DSS (Payment Card Industry)

**Contr√¥les PCI-DSS :**

```ini
# /etc/maxscale.d/pci_dss_controls.txt
# PCI-DSS v4.0 - Database Security

# Req 8: Authentification forte
# (G√©r√© au niveau MariaDB + MaxScale SSL)

# Req 10.2: Audit trail pour donn√©es cardholder
(?i)(SELECT|INSERT|UPDATE|DELETE).*\s+(credit_cards|payment_methods|transactions).*  
    log=/var/log/maxscale/pci_cardholder_access.log   
    include_user=true 
    include_timestamp=true 
    include_source_ip=true
    tamper_proof=true

# Req 10.3: Logging pour toutes modifications critiques
(?i)(INSERT|UPDATE|DELETE).*\s+(users|accounts|permissions).*  
    log=/var/log/maxscale/pci_critical_changes.log   
    include_user=true

# Req 11: Pr√©vention acc√®s non autoris√©
source_ip!=10.0.0.0/8 query_regex=.*(card|cvv|pan).*     deny   log=/var/log/maxscale/pci_violation.log
```

---

## ‚úÖ Points cl√©s √† retenir

- **Database Firewall** : Couche de s√©curit√© entre applications et bases de donn√©es, inspection et contr√¥le trafic SQL
- **Protection injections SQL** : D√©tection patterns UNION, boolean-based, time-based, stacked queries via regex
- **Contr√¥le granulaire** : Restrictions par utilisateur, IP source, horaires, type de requ√™te
- **Rate limiting** : Protection DoS avec throttling (max_qps), connection limiting, d√©tection anomalies
- **Audit et logging** : Logs structur√©s JSON, niveaux criticit√© (CRITICAL/HIGH/MEDIUM/LOW), export SIEM
- **Defense in Depth** : Architecture multi-couches (Application ‚Üí Network ‚Üí MaxScale ‚Üí MariaDB ‚Üí OS ‚Üí Encryption)
- **Whitelist vs Blacklist** : Whitelist plus s√ªr (seulement patterns connus), blacklist plus flexible
- **Conformit√©** : Support GDPR (audit PII), SOC 2 (access controls), PCI-DSS (cardholder data)
- **Incident response** : Playbook automatique, mode lockdown, alerting temps r√©el, forensics
- **Monitoring** : Dashboard Grafana s√©curit√©, m√©triques Prometheus, int√©gration SIEM (Splunk/ELK)
- **Stack de filtres** : Ordre important (Connection Limiter ‚Üí Rate Limiter ‚Üí IP ACL ‚Üí SQL Injection ‚Üí Whitelist ‚Üí Audit)
- **SSL/TLS** : Chiffrement obligatoire end-to-end, validation certificats, TLS 1.2+ seulement

---

## üîó Ressources et r√©f√©rences

### Documentation officielle MaxScale
- [üìñ RegexFilter Module](https://mariadb.com/kb/en/mariadb-maxscale-25-regex-filter/)
- [üìñ Database Firewall](https://mariadb.com/kb/en/maxscale-database-firewall/)
- [üìñ MaxScale Security](https://mariadb.com/docs/server/security/maxscale/)

### Standards de s√©curit√©
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [CWE-89: SQL Injection](https://cwe.mitre.org/data/definitions/89.html)
- [NIST Cybersecurity Framework](https://www.nist.gov/cyberframework)

### Conformit√© et r√©glementation
- [üìñ GDPR - Article 30 (Records)](https://gdpr-info.eu/art-30-gdpr/)
- [üìñ SOC 2 Controls](https://www.aicpa.org/soc-for-cybersecurity)
- [üìñ PCI-DSS v4.0](https://www.pcisecuritystandards.org/)

### Guides techniques
- [SQL Injection Prevention Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html)
- [Database Security Best Practices](https://mariadb.com/resources/blog/database-security-best-practices/)
- [Defense in Depth Strategy](https://csrc.nist.gov/glossary/term/defense_in_depth)

### Outils
- [SQLMap - SQL Injection Testing](https://sqlmap.org/)
- [Regex101 - Test regex patterns](https://regex101.com/)
- [OWASP ZAP - Security Testing](https://www.zaproxy.org/)

---

## ‚û°Ô∏è Chapitre suivant

**Partie 15 : Performance et Tuning** - M√©thodologie d'optimisation, configuration m√©moire, analyse requ√™tes lentes, partitionnement, benchmarking avec focus sur les am√©liorations MariaDB 11.8 (innodb_alter_copy_bulk, cost optimizer SSD).

---


‚è≠Ô∏è [MaxScale 25.01 : Nouvelles fonctionnalit√©s](/14-haute-disponibilite/05-maxscale-25-nouveautes.md)
