üîù Retour au [Sommaire](/SOMMAIRE.md)

# 14.2.4 State transfers (SST, IST)

> **Niveau** : Expert  
> **Dur√©e estim√©e** : 5-6 heures  
> **Pr√©requis** : Architecture Galera (14.2.1-14.2.3), Mariabackup (12.3), Administration syst√®mes

## üéØ Objectifs d'apprentissage

√Ä l'issue de cette section, vous serez capable de :
- Comprendre en profondeur les m√©canismes SST et IST
- Choisir la m√©thode SST optimale selon le contexte
- Optimiser les transferts d'√©tat pour bases de donn√©es volumineuses
- Monitorer et diagnostiquer les probl√®mes de state transfer
- Minimiser l'impact des SST sur la production
- Impl√©menter des strat√©gies de r√©cup√©ration rapide
- Configurer les param√®tres avanc√©s de gcache et IST

---

## Introduction

Les **State Transfers** sont les m√©canismes par lesquels un n≈ìud Galera se synchronise avec le cluster. Ces transferts sont critiques pour la haute disponibilit√© car ils d√©terminent :

- **La vitesse de r√©cup√©ration** d'un n≈ìud d√©faillant
- **L'impact sur la production** pendant la synchronisation
- **La fiabilit√©** de l'int√©gration d'un nouveau n≈ìud
- **La capacit√© de scaling** horizontal du cluster

Galera propose deux types de transferts d'√©tat :

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              STATE TRANSFER DECISION TREE                   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

N≈ìud rejoint le cluster
        ‚îÇ
        ‚îú‚îÄ Gcache contient tous les write-sets manquants?
        ‚îÇ
        ‚îú‚îÄ OUI ‚îÄ‚îÄ‚Üí IST (Incremental State Transfer)
        ‚îÇ          ‚îú‚îÄ Rapide (secondes √† minutes)
        ‚îÇ          ‚îú‚îÄ Pas de blocage du donneur
        ‚îÇ          ‚îî‚îÄ Transfert diff√©rentiel seulement
        ‚îÇ
        ‚îî‚îÄ NON ‚îÄ‚îÄ‚Üí SST (State Snapshot Transfer)
                   ‚îú‚îÄ Lent (minutes √† heures)
                   ‚îú‚îÄ Blocage partiel possible
                   ‚îî‚îÄ Copie compl√®te de la base
```

La ma√Ætrise de ces m√©canismes est essentielle pour maintenir un cluster Galera performant et r√©silient en production.

---

## Incremental State Transfer (IST)

### Principe et fonctionnement

L'IST est le m√©canisme de synchronisation **optimal** car il ne transf√®re que les transactions manquantes :

```
Scenario IST:

Timeline du cluster:
‚îú‚îÄ Seqno 1000 ‚îÄ Seqno 1500 ‚îÄ Seqno 2000 ‚îÄ Seqno 2500 (current)
                    ‚Üë                          ‚Üë
                    ‚îÇ                          ‚îÇ
                N≈ìud C d√©connect√©        N≈ìud C rejoint
                (last seqno: 1500)

IST transfert:
‚îú‚îÄ Write-sets de seqno 1501 √† 2500
‚îú‚îÄ Taille: ~1000 transactions seulement
‚îî‚îÄ Dur√©e: Quelques secondes √† quelques minutes
```

**Conditions pour IST :**

1. **Gcache du donneur** contient les write-sets manquants
2. **N≈ìud receveur** conna√Æt son dernier seqno appliqu√©
3. **UUID du cluster** identique (pas de r√©initialisation compl√®te)

### Gcache : Le cache permettant l'IST

**Structure du gcache :**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    GCACHE ARCHITECTURE                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ              Ring Buffer (m√©moire)                   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ WS-1 ‚îÇ WS-2 ‚îÇ WS-3 ‚îÇ WS-4 ‚îÇ WS-5 ‚îÇ ...  ‚îÇWS-N ‚îÇ   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ              gcache.mem_size (d√©faut 0)              ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                           ‚Üì                                ‚îÇ
‚îÇ                      Overflow vers                         ‚îÇ
‚îÇ                           ‚Üì                                ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ          Page Files (disque, fichiers fixes)         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ page-1.dat  ‚îÇ page-2.dat  ‚îÇ page-3.dat  ‚îÇ ...     ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ              gcache.page_size (d√©faut 128MB)         ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                           ‚Üì                                ‚îÇ
‚îÇ                      Si pages pleines                      ‚îÇ
‚îÇ                           ‚Üì                                ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ      Store File (disque, fichier unique extensible)  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  galera.cache (write-sets persist√©s)           ‚îÇ  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ              gcache.size (d√©faut 128MB)              ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îÇ                                                            ‚îÇ
‚îÇ  Total size = gcache.mem_size + (pages √ó page_size)        ‚îÇ
‚îÇ               + gcache.size                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Configuration gcache optimale :**

```ini
# /etc/mysql/mariadb.conf.d/60-galera.cnf
[galera]
wsrep_provider_options = "
    # === GCache Configuration ===
    
    # Taille totale du cache (prioritaire)
    gcache.size = 10G;
    
    # Taille des pages interm√©diaires
    gcache.page_size = 1G;
    
    # Pages √† conserver m√™me si purg√©es
    gcache.keep_pages_size = 5G;
    
    # Limite de r√©cup√©ration
    gcache.recover = yes;
    
    # Nom du fichier cache
    gcache.name = /var/lib/mysql/galera.cache;
    
    # Optionnel: cache m√©moire (meilleure performance)
    # gcache.mem_size = 512M;
"
```

**Formule de dimensionnement gcache.size :**

```
gcache.size = taux_ecriture_MB/s √ó downtime_max_acceptable_s √ó facteur_s√©curit√©

Exemples:

1. Workload l√©ger:
   - 2 MB/s √ó 600s (10min) √ó 2 = 2.4 GB
   ‚Üí Configurer: gcache.size = 3G

2. Workload moyen:
   - 10 MB/s √ó 1800s (30min) √ó 1.5 = 27 GB
   ‚Üí Configurer: gcache.size = 30G

3. Workload intense:
   - 50 MB/s √ó 3600s (1h) √ó 1.5 = 270 GB
   ‚Üí Configurer: gcache.size = 300G
```

üí° **Recommandation** : Allouer au moins 30 minutes de write-sets pour absorber les maintenances courtes.

### Monitoring de l'IST

**M√©triques critiques :**

```sql
-- Plage du gcache
-- Seqno le plus ancien dans le cache
SHOW STATUS LIKE 'wsrep_local_cached_downto';
-- wsrep_local_cached_downto: 1500

-- Dernier seqno commit√©
SHOW STATUS LIKE 'wsrep_last_committed';
-- wsrep_last_committed: 2500

-- Calcul de la fen√™tre IST
-- Fen√™tre = last_committed - cached_downto
-- Exemple: 2500 - 1500 = 1000 seqnos disponibles
```

**D√©terminer si IST sera possible :**

```sql
-- Sur le n≈ìud qui va rejoindre, v√©rifier son grastate.dat
-- (avant de red√©marrer)

-- Fichier: /var/lib/mysql/grastate.dat
cat /var/lib/mysql/grastate.dat
```

```yaml
# GALERA saved state
version: 2.1
uuid:    a1b2c3d4-e5f6-7890-abcd-ef1234567890
seqno:   1750
safe_to_bootstrap: 0
```

**Calcul de faisabilit√© IST :**

```bash
# Sur un n≈ìud donneur potentiel
CACHED_DOWNTO=$(mysql -N -e "SHOW STATUS LIKE 'wsrep_local_cached_downto';" | awk '{print $2}')
LAST_COMMITTED=$(mysql -N -e "SHOW STATUS LIKE 'wsrep_last_committed';" | awk '{print $2}')

# Seqno du n≈ìud receveur (depuis grastate.dat)
RECEIVER_SEQNO=1750

if [ $RECEIVER_SEQNO -ge $CACHED_DOWNTO ]; then
    echo "IST possible (receiver seqno $RECEIVER_SEQNO >= cached_downto $CACHED_DOWNTO)"
    MISSING_SEQNOS=$((LAST_COMMITTED - RECEIVER_SEQNO))
    echo "Write-sets √† transf√©rer: $MISSING_SEQNOS"
else
    echo "SST requis (receiver seqno $RECEIVER_SEQNO < cached_downto $CACHED_DOWNTO)"
fi
```

### Logs IST

**Identifier un IST dans les logs :**

```bash
# /var/log/mysql/error.log

# D√©but IST
[Note] WSREP: Requesting state transfer: success, donor: 1
[Note] WSREP: IST receiver addr using tcp://10.0.1.12:4568
[Note] WSREP: Prepared IST receiver for 1501-2500

# Progression IST
[Note] WSREP: Receiving IST: 250 writesets, seqnos 1501-1750
[Note] WSREP: Receiving IST: 500 writesets, seqnos 1501-2000
[Note] WSREP: Receiving IST: 1000 writesets, seqnos 1501-2500

# Fin IST
[Note] WSREP: IST received: a1b2c3d4-e5f6-7890-abcd-ef1234567890:2500
[Note] WSREP: 0.0 (galera-02): State transfer from 1 (galera-01) complete.
[Note] WSREP: Member 0.0 (galera-02) synced with group.
[Note] WSREP: Shifting JOINER -> JOINED (TO: 2500)
```

**Dur√©e typique IST :**

```
Facteurs influen√ßant la dur√©e:
- Nombre de write-sets: 1000 WS ‚Üí ~10-30 secondes
- Taille moyenne des WS: 10KB ‚Üí ~10MB total
- Bande passante r√©seau: 1 Gbps ‚Üí ~1 seconde transfert
- Latence r√©seau: 1ms ‚Üí n√©gligeable
- Apply parallelism: wsrep_slave_threads

Dur√©e IST = temps_transfert + temps_application

Exemple:
- 5000 write-sets de 50KB = 250MB
- R√©seau 10 Gbps = ~2 secondes transfert
- Application avec 4 threads = ~10 secondes
‚Üí IST total ‚âà 12-15 secondes
```

---

## State Snapshot Transfer (SST)

### Quand SST est d√©clench√©

**Sc√©narios d√©clenchant SST :**

1. **Nouveau n≈ìud** sans √©tat (datadir vide)
2. **N≈ìud absent** trop longtemps (seqno hors gcache)
3. **UUID cluster diff√©rent** (r√©initialisation)
4. **Corruption d√©tect√©e** (wsrep_recover √©chec)
5. **Demande manuelle** (`wsrep_sst_donor='manual'`)

### M√©thodes SST disponibles

| M√©thode | Outil | Donneur bloqu√© | Performance | Production | Compression |
|---------|-------|----------------|-------------|------------|-------------|
| **mariabackup** | Mariabackup | Non* | ‚ö°‚ö°‚ö° Rapide | ‚úÖ Recommand√© | ‚úÖ Oui |
| **rsync** | rsync | ‚úÖ Oui (FTWRL) | ‚ö°‚ö° Moyen | ‚ö†Ô∏è Legacy | ‚ùå Non |
| **mysqldump** | mysqldump | ‚ùå Non | ‚ö° Lent | ‚ùå Debug seulement | ‚ùå Non |
| **xtrabackup** | Percona XtraBackup | Non* | ‚ö°‚ö°‚ö° Rapide | ‚úÖ Alternative | ‚úÖ Oui |

*Blocage FTWRL tr√®s court (<1s) au d√©but seulement

### SST avec mariabackup (recommand√©)

**Configuration compl√®te :**

```ini
# /etc/mysql/mariadb.conf.d/60-galera.cnf
[mysqld]
# === SST Configuration ===

# M√©thode SST
wsrep_sst_method = mariabackup

# Authentication pour SST
wsrep_sst_auth = "sst_user:SST_SecureP@ssw0rd2024!"

# Adresse de r√©ception (optionnel)
wsrep_sst_receive_address = 10.0.1.12:4444

# Adresse du donneur pr√©f√©r√© (optionnel)
# wsrep_sst_donor = "galera-01,galera-03"

# === Mariabackup SST Options ===
[sst]
# Parall√©lisme (threads)
# Augmente vitesse pour grosses BDD
transferfmt = /usr/bin/mariabackup --parallel=8

# Compression (√©conomise bande passante)
compressor = 'pigz'
decompressor = 'pigz -d'

# Encryption (optionnel, si TLS insuffisant)
# encrypt = 1
# encrypt-algo = AES256

# Buffer size pour transfert
# streamfmt = tar
# tca = /etc/mysql/ssl/ca-cert.pem
# tcert = /etc/mysql/ssl/server-cert.pem
```

**Utilisateur SST (rappel) :**

```sql
-- Privil√®ges minimaux requis pour SST
CREATE USER 'sst_user'@'localhost' 
    IDENTIFIED BY 'SST_SecureP@ssw0rd2024!';

GRANT PROCESS, RELOAD, LOCK TABLES, REPLICATION CLIENT 
    ON *.* TO 'sst_user'@'localhost';

-- Pour mariabackup
GRANT BACKUP_ADMIN ON *.* TO 'sst_user'@'localhost';

FLUSH PRIVILEGES;
```

### Processus SST mariabackup d√©taill√©

**Timeline compl√®te :**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              SST MARIABACKUP PROCESS TIMELINE               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

DONNEUR (galera-01)                  RECEVEUR (galera-02)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

1. √âlection du donneur
   - Le cluster choisit un donneur
   - G√©n√©ralement le plus proche
   
2. Pause √©criture (FTWRL)            
   FLUSH TABLES WITH READ LOCK
   ‚Üì (< 1 seconde)
   
3. Snapshot InnoDB
   - mariabackup --backup
   - Copie fichiers .ibd
   - Capture LSN position
   
4. Rel√¢che FTWRL
   UNLOCK TABLES
   ‚Üì
   (Donneur continue normal ops)      ‚Üê Important: pas de blocage prolong√©
   
5. Streaming vers receveur ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí  6. R√©ception stream
   - Via port 4444                       - D√©compression si activ√©e
   - Compression si activ√©e              - √âcriture datadir
   - Encryption TLS optionnelle
   
7. Envoi metadata                        7. Application logs InnoDB
   - Position binlog                        - mariabackup --prepare
   - Galera GTID                            - Apply redo logs
   - Cluster UUID                           - Rollback uncommitted
   
8. Fin transfert ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Üí   8. V√©rification int√©grit√©
                                         - Checksum validation
                                         - Grastate.dat cr√©ation
                                      
                                      9. D√©marrage MariaDB
                                         - Rejoint cluster
                                         - √âtat: Joiner ‚Üí Joined ‚Üí Synced
                                      
                                     10. Rattrapage final (IST)
                                         - Write-sets pendant SST
                                         - Application diff√©rentielle
```

**Estimation dur√©e SST :**

```
Facteurs principaux:

1. Taille base de donn√©es: 500 GB
2. Vitesse r√©seau: 10 Gbps = 1.25 GB/s th√©orique
   - R√©el avec overhead: ~800 MB/s
3. Compression pigz: ratio ~3:1
   - Donn√©es transf√©r√©es: 500 GB / 3 = ~167 GB
4. Temps transfert: 167 GB / 0.8 GB/s = ~209 secondes = 3.5 minutes
5. Temps prepare (apply logs): ~2 minutes
6. Temps d√©marrage MariaDB: ~1 minute

Total SST: ~7-10 minutes pour 500 GB

Formule g√©n√©rale:
Dur√©e_SST = (Taille_DB / Compression_ratio) / Bandwidth_effective 
            + Temps_prepare + Temps_startup
```

### Optimisations SST pour grosses bases

**1. Parall√©lisme mariabackup :**

```ini
[sst]
# Utiliser tous les cores disponibles
# Serveur 16 cores ‚Üí parallel=16
transferfmt = /usr/bin/mariabackup --parallel=16 --compress --compress-threads=16
```

**2. Compression efficace avec pigz :**

```bash
# Installer pigz (parallel gzip)
apt install -y pigz

# Configuration
[sst]
compressor = 'pigz -p 8'  # 8 threads compression
decompressor = 'pigz -d -p 8'
```

**3. Utilisation de tmpfs pour prepare :**

```bash
# Monter tmpfs si RAM suffisante
# (√©vite I/O disque pendant prepare)

# /etc/fstab
tmpfs /mnt/sst-prepare tmpfs size=100G,mode=0700,uid=mysql,gid=mysql 0 0

# Monter
mount /mnt/sst-prepare

# Configuration mariabackup pour utiliser tmpfs
[sst]
# Option non standard, n√©cessite script custom
# Voir section suivante
```

**4. Script SST custom pour optimisations :**

```bash
# /usr/bin/wsrep_sst_mariabackup_optimized
# Script SST personnalis√© avec optimisations

#!/bin/bash
# Wrapper autour de wsrep_sst_mariabackup

# Variables d'environnement Galera disponibles:
# WSREP_SST_OPT_ROLE: 'donor' ou 'joiner'
# WSREP_SST_OPT_ADDR: Adresse du receveur
# WSREP_SST_OPT_DATA: Datadir

MARIABACKUP_BIN="/usr/bin/mariabackup"
PARALLEL_THREADS=16
COMPRESS_THREADS=16

if [ "$WSREP_SST_OPT_ROLE" = "donor" ]; then
    # Optimisations donneur
    nice -n -10 ionice -c2 -n0 \
        $MARIABACKUP_BIN \
        --backup \
        --parallel=$PARALLEL_THREADS \
        --compress \
        --compress-threads=$COMPRESS_THREADS \
        --stream=xbstream \
        --datadir="$WSREP_SST_OPT_DATA" | \
    pigz -p $COMPRESS_THREADS | \
    nc "$WSREP_SST_OPT_ADDR" 4444
    
elif [ "$WSREP_SST_OPT_ROLE" = "joiner" ]; then
    # Optimisations receveur
    nc -l 4444 | \
    pigz -d -p $COMPRESS_THREADS | \
    nice -n -10 ionice -c2 -n0 \
        $MARIABACKUP_BIN \
        --prepare \
        --parallel=$PARALLEL_THREADS \
        --target-dir="$WSREP_SST_OPT_DATA"
fi
```

üí° **Attention** : Les scripts SST customs n√©cessitent tests approfondis avant production.

### Monitoring SST

**M√©triques en temps r√©el :**

```bash
# Sur le receveur, surveiller progression
# 1. Taille datadir (croissante pendant SST)
watch -n 5 'du -sh /var/lib/mysql'

# 2. Trafic r√©seau (port 4444)
watch -n 1 'ss -tnp | grep :4444'

# 3. Processus mariabackup
watch -n 2 'ps aux | grep mariabackup'

# 4. Logs temps r√©el
tail -f /var/log/mysql/error.log | grep -E 'SST|WSREP'
```

**Logs SST d√©taill√©s :**

```bash
# /var/log/mysql/error.log - Exemple SST mariabackup

# D√©but SST sur receveur
[Note] WSREP: Requesting state transfer: success, donor: 0
[Note] WSREP: Receiving SST: ...
[Note] WSREP: SST method: mariabackup

# Sur donneur
[Note] WSREP: Running: 'wsrep_sst_mariabackup --role 'donor' --address '10.0.1.12:4444' ...'
[Note] WSREP-SST: Streaming the backup to joiner at 10.0.1.12:4444
[Note] WSREP-SST: Backup created in 120 seconds
[Note] WSREP-SST: Transferred 167.3 GB in 210 seconds = 815 MB/s

# Sur receveur
[Note] WSREP-SST: Receiving backup from donor
[Note] WSREP-SST: Preparing backup...
[Note] WSREP-SST: Completed on 10.0.1.12:4444
[Note] WSREP: SST complete, seqno: 12345
[Note] WSREP: 0.0 (galera-02): State transfer from 0 (galera-01) complete.
```

**Calcul du taux de transfert :**

```sql
-- Requ√™te pour extraire infos SST des logs
-- (n√©cessite parsing des logs)

-- Script bash pour calculer performance SST
grep "WSREP-SST: Transferred" /var/log/mysql/error.log | tail -1 | \
awk '{
    size=$3;
    unit=$4;
    time=$6;
    
    # Conversion en GB
    if (unit == "MB") size = size / 1024;
    
    # Calcul MB/s
    mbps = (size * 1024) / time;
    
    print "Transfer rate:", mbps, "MB/s"
}'
```

---

## S√©lection du donneur SST

### Algorithme de s√©lection

**Ordre de pr√©f√©rence par d√©faut :**

1. **wsrep_sst_donor** explicite (si configur√©)
2. **N≈ìud avec √©tat Synced** le plus proche (latence r√©seau)
3. **N≈ìud avec charge CPU la plus faible**
4. **Premier n≈ìud disponible** dans la liste

**Configuration du donneur pr√©f√©r√© :**

```ini
# /etc/mysql/mariadb.conf.d/60-galera.cnf
[mysqld]
# Liste ordonn√©e de donneurs pr√©f√©r√©s
wsrep_sst_donor = "galera-01,galera-03,galera-02"

# Explications:
# - Pr√©f√©rer galera-01 (n≈ìud d√©di√© backup)
# - Puis galera-03 (moins de charge applicative)
# - En dernier galera-02 (n≈ìud production critique)
```

**Strat√©gies de s√©lection avanc√©es :**

**1. N≈ìud d√©di√© SST (architecture recommand√©e) :**

```
Architecture 4 n≈ìuds:

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇgalera-01‚îÇ  ‚îÇgalera-02‚îÇ  ‚îÇgalera-03‚îÇ  ‚îÇgalera-04‚îÇ
‚îÇ  (RW)   ‚îÇ  ‚îÇ  (RW)   ‚îÇ  ‚îÇ  (RO)   ‚îÇ  ‚îÇ  (SST)  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚Üë            ‚Üë            ‚Üë             ‚Üë
    ‚îÇ            ‚îÇ            ‚îÇ             ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
              Galera Cluster
              
galera-04: N≈ìud d√©di√© SST
- Pas dans le load balancer
- Configuration optimis√©e pour backup
- Toujours disponible comme donneur
```

**2. Rotation des donneurs :**

```bash
# Script de rotation automatique des donneurs
# /usr/local/bin/rotate-sst-donor.sh

#!/bin/bash
# Rotation du donneur SST pour √©quilibrer la charge

NODES=("galera-01" "galera-02" "galera-03")
CURRENT_PRIMARY=0

# Fonction pour obtenir le donneur actuel
get_current_donor() {
    mysql -N -e "SHOW VARIABLES LIKE 'wsrep_sst_donor';" | awk '{print $2}'
}

# Rotation vers le n≈ìud suivant
rotate_donor() {
    NEXT_PRIMARY=$(( (CURRENT_PRIMARY + 1) % ${#NODES[@]} ))
    NEW_DONOR="${NODES[$NEXT_PRIMARY]}"
    
    echo "Rotating SST donor to: $NEW_DONOR"
    mysql -e "SET GLOBAL wsrep_sst_donor='$NEW_DONOR';"
    
    CURRENT_PRIMARY=$NEXT_PRIMARY
}

# Ex√©cuter rotation
rotate_donor
```

### Forcer un donneur sp√©cifique

```sql
-- Temporairement pour un n≈ìud sp√©cifique
SET GLOBAL wsrep_sst_donor = 'galera-01';

-- V√©rifier
SHOW VARIABLES LIKE 'wsrep_sst_donor';
```

---

## Troubleshooting SST/IST

### Probl√®mes courants et r√©solutions

**1. SST √©choue avec erreur "authentication failed"**

```bash
# Diagnostic
tail -100 /var/log/mysql/error.log | grep -i "authentication"

# ERROR: WSREP-SST: Authentication failed

# Solution 1: V√©rifier utilisateur SST
mysql -e "SELECT User, Host, authentication_string FROM mysql.user WHERE User='sst_user';"

# Solution 2: Recr√©er utilisateur
mysql <<EOF
DROP USER IF EXISTS 'sst_user'@'localhost';
CREATE USER 'sst_user'@'localhost' IDENTIFIED BY 'SST_SecureP@ssw0rd2024!';
GRANT PROCESS, RELOAD, LOCK TABLES, REPLICATION CLIENT, BACKUP_ADMIN ON *.* TO 'sst_user'@'localhost';
FLUSH PRIVILEGES;
EOF

# Solution 3: V√©rifier concordance my.cnf
grep wsrep_sst_auth /etc/mysql/mariadb.conf.d/60-galera.cnf
# Doit matcher: wsrep_sst_auth = "sst_user:SST_SecureP@ssw0rd2024!"

# Solution 4: Permissions fichiers
chown mysql:mysql /var/lib/mysql
chmod 750 /var/lib/mysql
```

**2. SST timeout**

```bash
# Logs
[ERROR] WSREP: SST timed out, seqno: -1

# Diagnostic
# 1. V√©rifier connexion r√©seau
ping -c 10 <donneur-ip>

# 2. V√©rifier port 4444 ouvert
nc -zv <donneur-ip> 4444

# 3. Augmenter timeout
# /etc/mysql/mariadb.conf.d/60-galera.cnf
wsrep_provider_options = "
    ist.recv_timeout = PT600S;      # 10 minutes
    sst.timeout = PT7200S;          # 2 heures pour tr√®s grosses BDD
"

# 4. V√©rifier espace disque receveur
df -h /var/lib/mysql
# Doit avoir au moins 2√ó la taille de la BDD

# 5. V√©rifier processus mariabackup
ps aux | grep mariabackup
# Si bloqu√© ‚Üí kill et red√©marrer SST
```

**3. IST demand√© mais SST ex√©cut√©**

```bash
# Sympt√¥me: Logs montrent SST alors que IST √©tait attendu
[Note] WSREP: Falling back to SST

# Diagnostic
# 1. V√©rifier seqno dans gcache
mysql -e "SHOW STATUS LIKE 'wsrep_local_cached_downto';"

# 2. V√©rifier seqno du receveur
cat /var/lib/mysql/grastate.dat | grep seqno

# Si seqno receveur < cached_downto ‚Üí SST normal

# Solution: Augmenter gcache.size
# Calcul besoin:
# gcache.size = taux_ecriture √ó downtime_max √ó 2
```

**4. SST corrompu (checksum failure)**

```bash
# Logs
[ERROR] WSREP-SST: Checksum verification failed

# Solution 1: Retry SST
systemctl restart mariadb

# Solution 2: Forcer SST complet en supprimant grastate.dat
systemctl stop mariadb
rm -f /var/lib/mysql/grastate.dat
systemctl start mariadb

# Solution 3: Bootstrap manuel si corruption cluster-wide
# (voir section recovery)
```

**5. Donneur bloqu√© pendant SST**

```bash
# Sympt√¥me: SHOW PROCESSLIST montre "Waiting for table flush"
# Avec m√©thode rsync (bloquante)

# Solution 1: Passer √† mariabackup (non-bloquant)
# /etc/mysql/mariadb.conf.d/60-galera.cnf
wsrep_sst_method = mariabackup

# Solution 2: Si SST en cours, attendre fin
# Monitoring:
watch -n 5 'mysql -e "SHOW PROCESSLIST" | grep -i flush'

# Solution 3: En dernier recours, kill SST
# (causera √©chec SST, mais d√©bloquera donneur)
pkill -9 -f wsrep_sst
```

---

## Strat√©gies de minimisation de l'impact

### 1. Pr√©chargement du gcache

**Technique du "gcache warming" :**

```bash
# Avant maintenance planifi√©e, augmenter temporairement gcache
# Pour maximiser chances IST au lieu de SST

# 1. Calculer besoin
DOWNTIME_MINUTES=60
WRITE_RATE_MBS=10
NEEDED_GB=$(( WRITE_RATE_MBS * DOWNTIME_MINUTES * 60 / 1024 ))

echo "Gcache needed: ${NEEDED_GB}GB"

# 2. Augmenter gcache (n√©cessite restart)
# my.cnf:
# gcache.size = 50G

# 3. Restart n≈ìud avec nouveau gcache
systemctl restart mariadb

# 4. Apr√®s maintenance, revenir √† taille normale
```

### 2. SST hors heures de pointe

```bash
# Planification SST avec at/cron

# Exemple: Ajouter nouveau n≈ìud √† 2h du matin
echo "systemctl start mariadb" | at 02:00

# Ou via cron pour maintenance r√©currente
# /etc/cron.d/galera-maintenance
0 2 * * 0 root /usr/local/bin/galera-weekly-maintenance.sh
```

### 3. Throttling r√©seau pendant SST

```bash
# Limiter bande passante SST pour ne pas saturer r√©seau
# (si SST pendant heures ouvr√©es n√©cessaire)

# Utiliser tc (traffic control)
# Limiter √† 500 Mbps sur port 4444

tc qdisc add dev eth0 root handle 1: htb default 12
tc class add dev eth0 parent 1: classid 1:1 htb rate 1000mbit
tc class add dev eth0 parent 1:1 classid 1:12 htb rate 500mbit
tc filter add dev eth0 protocol ip parent 1:0 prio 1 u32 \
    match ip sport 4444 0xffff flowid 1:12

# Supprimer apr√®s SST
tc qdisc del dev eth0 root
```

### 4. Monitoring proactif du gcache

```bash
# Script de monitoring gcache avec alertes
# /usr/local/bin/monitor-gcache.sh

#!/bin/bash
# Monitor Galera gcache et alerte si risque SST

THRESHOLD_PERCENT=70  # Alerter si > 70% gcache utilis√©

# R√©cup√©rer m√©triques
CACHED_DOWNTO=$(mysql -N -e "SHOW STATUS LIKE 'wsrep_local_cached_downto';" | awk '{print $2}')
LAST_COMMITTED=$(mysql -N -e "SHOW STATUS LIKE 'wsrep_last_committed';" | awk '{print $2}')

# Calculer utilisation gcache
GCACHE_RANGE=$((LAST_COMMITTED - CACHED_DOWNTO))

# Configuration gcache.size en seqnos (approximation)
# D√©pend du taux d'√©criture
# Exemple: 10G gcache ‚âà 50000 seqnos pour workload moyen
GCACHE_CAPACITY=50000

GCACHE_USAGE_PERCENT=$((GCACHE_RANGE * 100 / GCACHE_CAPACITY))

echo "Gcache usage: ${GCACHE_USAGE_PERCENT}%"

if [ $GCACHE_USAGE_PERCENT -gt $THRESHOLD_PERCENT ]; then
    # Alerte (mail, slack, pagerduty, etc.)
    echo "WARNING: Gcache usage high (${GCACHE_USAGE_PERCENT}%)" | \
        mail -s "Galera Gcache Alert" dba@example.com
fi

# M√©triques pour Prometheus
echo "galera_gcache_usage_percent ${GCACHE_USAGE_PERCENT}"
```

---

## Recovery et re-bootstrap apr√®s SST failure

### Proc√©dure de recovery compl√®te

**Sc√©nario : Cluster entier down apr√®s SST failures multiples**

```bash
# STEP 1: Identifier le n≈ìud le plus √† jour
# Sur chaque n≈ìud (si possible de d√©marrer temporairement)

for node in galera-01 galera-02 galera-03; do
    echo "=== $node ==="
    ssh $node "cat /var/lib/mysql/grastate.dat 2>/dev/null || echo 'No grastate.dat'"
done

# Exemple output:
# === galera-01 ===
# seqno: 2500
# === galera-02 ===
# seqno: 2480
# === galera-03 ===
# seqno: -1  (crashed)

# galera-01 a le seqno le plus √©lev√© ‚Üí bootstrap sur ce n≈ìud
```

**STEP 2: Bootstrap du n≈ìud le plus √† jour**

```bash
# Sur galera-01 (seqno le plus √©lev√©)

# 1. V√©rifier grastate.dat
cat /var/lib/mysql/grastate.dat

# 2. Si seqno = -1, forcer recovery
mysqld --wsrep-recover

# Output:
# WSREP: Recovered position: a1b2c3d4-e5f6-7890-abcd-ef1234567890:2500

# 3. Mettre √† jour grastate.dat avec le seqno r√©cup√©r√©
cat > /var/lib/mysql/grastate.dat <<EOF
# GALERA saved state
version: 2.1
uuid:    a1b2c3d4-e5f6-7890-abcd-ef1234567890
seqno:   2500
safe_to_bootstrap: 1
EOF

# 4. Bootstrap
galera_new_cluster

# 5. V√©rifier cluster status
mysql -e "SHOW STATUS LIKE 'wsrep_cluster_status';"
# Primary

mysql -e "SHOW STATUS LIKE 'wsrep_cluster_size';"
# 1
```

**STEP 3: Cleanup et ajout des autres n≈ìuds**

```bash
# Sur galera-02

# 1. Nettoyer datadir si SST corrompu
systemctl stop mariadb
rm -rf /var/lib/mysql/*
# ‚ö†Ô∏è ATTENTION: Supprime toutes les donn√©es locales

# 2. D√©marrer (d√©clenchera SST complet)
systemctl start mariadb

# 3. Monitoring SST
tail -f /var/log/mysql/error.log

# R√©p√©ter pour galera-03
```

### Safe-to-bootstrap flag

**Comprendre safe_to_bootstrap :**

```yaml
# /var/lib/mysql/grastate.dat

# safe_to_bootstrap: 0
# ‚Üí Ne PAS bootstrapper (donn√©es potentiellement obsol√®tes)

# safe_to_bootstrap: 1
# ‚Üí OK pour bootstrapper (donn√©es les plus r√©centes)
```

**Forcer safe_to_bootstrap (DANGER) :**

```bash
# Utiliser SEULEMENT si certain que ce n≈ìud a les donn√©es les plus r√©centes
sed -i 's/safe_to_bootstrap: 0/safe_to_bootstrap: 1/' /var/lib/mysql/grastate.dat
```

---

## M√©triques et monitoring production

### Dashboard Grafana pour SST/IST

**Requ√™tes Prometheus :**

```yaml
# prometheus.yml - mysqld_exporter metrics

scrape_configs:
  - job_name: 'galera'
    static_configs:
      - targets:
        - 'galera-01:9104'
        - 'galera-02:9104'
        - 'galera-03:9104'
```

**M√©triques cl√©s √† grapher :**

```promql
# 1. Gcache range (fen√™tre IST)
mysql_global_status_wsrep_last_committed - 
mysql_global_status_wsrep_local_cached_downto

# 2. Taux d'utilisation gcache (%)
(mysql_global_status_wsrep_last_committed - 
 mysql_global_status_wsrep_local_cached_downto) / 50000 * 100

# 3. SST en cours (boolean)
mysql_global_status_wsrep_local_state == 2

# 4. Cluster size (d√©tection n≈ìud down)
mysql_global_status_wsrep_cluster_size

# 5. Flow control (indicateur n≈ìud lent)
mysql_global_status_wsrep_flow_control_paused
```

**Alertes recommand√©es :**

```yaml
# prometheus/alerts/galera-sst.yml

groups:
  - name: galera_sst
    interval: 30s
    rules:
      # Alerte si gcache > 80% utilis√©
      - alert: GaleraGcacheHighUsage
        expr: |
          (mysql_global_status_wsrep_last_committed - 
           mysql_global_status_wsrep_local_cached_downto) / 50000 > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Galera gcache high usage on {{ $labels.instance }}"
          description: "Gcache usage > 80%, IST at risk"
      
      # Alerte si n≈ìud en SST > 30 minutes
      - alert: GaleraLongSST
        expr: |
          mysql_global_status_wsrep_local_state == 2
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "Long SST on {{ $labels.instance }}"
          description: "SST running for > 30 minutes"
      
      # Alerte si cluster size r√©duit
      - alert: GaleraClusterSizeReduced
        expr: |
          mysql_global_status_wsrep_cluster_size < 3
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Galera cluster size reduced"
          description: "Cluster size is {{ $value }}, expected 3"
```

---

## ‚úÖ Points cl√©s √† retenir

- **IST vs SST** : IST rapide (secondes/minutes) si seqno dans gcache, SST lent (minutes/heures) sinon
- **Gcache sizing critique** : `gcache.size = write_rate √ó downtime_max √ó 1.5`, d√©termine IST vs SST
- **Mariabackup recommand√©** : Non-bloquant (FTWRL <1s), rapide, compression native, m√©thode SST par d√©faut
- **Parall√©lisme mariabackup** : `--parallel` selon CPU, `--compress-threads` pour vitesse optimale
- **Donneur SST** : Configurer `wsrep_sst_donor` pour √©viter impact n≈ìuds production critiques
- **Monitoring gcache** : Surveiller `wsrep_local_cached_downto` vs `wsrep_last_committed` pour pr√©dire IST/SST
- **Recovery cluster** : Identifier n≈ìud seqno max, v√©rifier `safe_to_bootstrap=1`, bootstrap puis ajouter autres n≈ìuds
- **Impact minimisation** : SST hors heures pointe, n≈ìud d√©di√© SST, throttling r√©seau si n√©cessaire
- **Logs essentiels** : `/var/log/mysql/error.log` contient timeline compl√®te SST/IST
- **Timeout configuration** : `ist.recv_timeout` et `sst.timeout` dans `wsrep_provider_options` pour grosses BDD
- **Compression pigz** : Parall√®le, 2-3x plus rapide que gzip, √©conomise bande passante
- **Troubleshooting** : Authentication errors ‚Üí v√©rifier `sst_user`, timeouts ‚Üí augmenter limites, corruption ‚Üí retry ou cleanup complet

---

## üîó Ressources et r√©f√©rences

### Documentation officielle
- [üìñ State Snapshot Transfer (SST)](https://mariadb.com/kb/en/introduction-to-state-snapshot-transfers-ssts/)
- [üìñ Mariabackup SST Method](https://mariadb.com/kb/en/mariabackup-sst-method/)
- [üìñ Galera System Variables](https://mariadb.com/kb/en/galera-cluster-system-variables/)
- [üìñ wsrep_provider_options](https://mariadb.com/kb/en/galera-cluster-system-variables/#wsrep_provider_options)

### Documentation Galera (Codership)
- [State Transfer](https://galeracluster.com/library/documentation/state-transfer.html)
- [GCache Configuration](https://galeracluster.com/library/documentation/galera-parameters.html#gcache-size)
- [IST vs SST Decision](https://galeracluster.com/library/documentation/state-transfer.html#state-transfer-ist)

### Guides techniques
- [Optimizing Galera SST Performance](https://www.percona.com/blog/optimizing-galera-sst-performance/)
- [Understanding Galera Write-Set Cache](https://severalnines.com/database-blog/understanding-galera-write-set-cache/)
- [Galera Recovery Procedures](https://mariadb.com/resources/blog/galera-cluster-recovery-101/)

### Outils
- [Mariabackup Documentation](https://mariadb.com/kb/en/mariabackup/)
- [pigz - Parallel gzip](https://zlib.net/pigz/)
- [ClusterControl SST Management](https://severalnines.com/product/clustercontrol/galera)

---

## ‚û°Ô∏è Section suivante

**14.3 Split-brain et quorum** : Compr√©hension approfondie des m√©canismes de quorum dans Galera, d√©tection et r√©solution de split-brain, gestion des partitions r√©seau, configuration du quorum pour diff√©rentes topologies, et strat√©gies de pr√©vention des sc√©narios de perte de quorum.

---


‚è≠Ô∏è [Split-brain et quorum](/14-haute-disponibilite/03-split-brain-quorum.md)
