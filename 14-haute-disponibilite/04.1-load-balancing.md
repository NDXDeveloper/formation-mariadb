ğŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 14.4.1 Load Balancing

> **Niveau** : Expert  
> **DurÃ©e estimÃ©e** : 4-5 heures  
> **PrÃ©requis** : Galera Cluster (14.2), RÃ©plication (13), Architectures HA, RÃ©seaux

## ğŸ¯ Objectifs d'apprentissage

Ã€ l'issue de cette section, vous serez capable de :
- Comprendre les algorithmes de load balancing pour bases de donnÃ©es
- DÃ©ployer et configurer MaxScale pour rÃ©partir la charge
- ImplÃ©menter diffÃ©rentes stratÃ©gies de load balancing selon les workloads
- Optimiser les performances et la rÃ©silience avec MaxScale
- Monitorer et diagnostiquer les problÃ¨mes de rÃ©partition de charge
- IntÃ©grer MaxScale avec Galera Cluster en production
- Configurer les health checks et failover automatique

---

## Introduction

Le **load balancing** est un composant essentiel des architectures haute disponibilitÃ©. Dans le contexte des bases de donnÃ©es, il permet de :

- **Distribuer la charge** entre plusieurs nÅ“uds pour optimiser les performances
- **Maximiser la disponibilitÃ©** en dÃ©tectant et isolant les nÅ“uds dÃ©faillants
- **Simplifier l'architecture applicative** avec un point d'entrÃ©e unique
- **Permettre le scaling horizontal** transparent pour les applications
- **Optimiser l'utilisation des ressources** du cluster

**MaxScale** est le proxy intelligent dÃ©veloppÃ© par MariaDB Corporation qui fournit des fonctionnalitÃ©s avancÃ©es de load balancing, routage de requÃªtes, haute disponibilitÃ© et sÃ©curitÃ© pour MariaDB et MySQL.

```
Architecture typique avec MaxScale:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Application Layer                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚   â”‚  App 1   â”‚  â”‚  App 2   â”‚  â”‚  App 3   â”‚                â”‚
â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚             â”‚             â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ Port 3306 (unique entry point)
                       â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚        MaxScale Proxy       â”‚
         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
         â”‚  â”‚  Load Balancing Logic  â”‚ â”‚
         â”‚  â”‚  Health Checks         â”‚ â”‚
         â”‚  â”‚  Connection Pooling    â”‚ â”‚
         â”‚  â”‚  Query Routing         â”‚ â”‚
         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
         â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
            â”‚          â”‚         â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”  â”Œâ”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ galera-01â”‚  â”‚galera-02â”‚  â”‚ galera-03â”‚
    â”‚  (RW)    â”‚  â”‚  (RW)   â”‚  â”‚   (RW)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         Galera Cluster (Multi-Master)
```

---

## MaxScale : Vue d'ensemble

### Architecture et composants

**Composants principaux de MaxScale :**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MaxScale Architecture                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Listeners (Ports)                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚   â”‚
â”‚  â”‚  â”‚ :3306  â”‚  â”‚ :4006  â”‚  â”‚ :8989  â”‚                â”‚   â”‚
â”‚  â”‚  â”‚ MySQL  â”‚  â”‚ Admin  â”‚  â”‚  REST  â”‚                â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚           â”‚           â”‚                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Services Layer                        â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚ RW-Service â”‚   â”‚ RO-Service â”‚   â”‚ Admin-Svc   â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚            â”‚                â”‚                â”‚            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Routers (Logic)                       â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ Read/Write  â”‚  â”‚ Read Connâ”‚   â”‚  Schema      â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ Split       â”‚  â”‚ Router   â”‚   â”‚  Router      â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚            â”‚              â”‚                â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Monitors (Health Checks)              â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ Galera   â”‚  â”‚ MariaDB  â”‚  â”‚  Replication     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ Monitor  â”‚  â”‚ Monitor  â”‚  â”‚  Monitor         â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚          â”‚             â”‚             â”‚                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Servers (Backend Nodes)               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚   â”‚
â”‚  â”‚  â”‚galera-01 â”‚  â”‚galera-02 â”‚  â”‚galera-03 â”‚          â”‚   â”‚
â”‚  â”‚  â”‚10.0.1.11 â”‚  â”‚10.0.1.12 â”‚  â”‚10.0.1.13 â”‚          â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Installation de MaxScale

**MaxScale 25.01 - Installation sur Ubuntu 22.04 :**

```bash
# 1. Ajouter le repository MaxScale
curl -sS https://downloads.mariadb.com/MariaDB/mariadb_repo_setup | \
    sudo bash -s -- --mariadb-maxscale-version=25.01

# 2. Mettre Ã  jour et installer
sudo apt update
sudo apt install -y maxscale

# 3. VÃ©rifier l'installation
maxscale --version
# MaxScale 25.01.x

# 4. VÃ©rifier le service
systemctl status maxscale
```

**Installation sur RHEL/Rocky Linux 9 :**

```bash
# 1. Ajouter le repository
cat <<'EOF' > /etc/yum.repos.d/maxscale.repo
[maxscale]
name = MariaDB MaxScale
baseurl = https://dlm.mariadb.com/repo/maxscale/25.01/yum/rhel/$releasever/$basearch
gpgkey = https://supplychain.mariadb.com/MaxScale-GPG-KEY.public
gpgcheck = 1
EOF

# 2. Installer
sudo dnf install -y maxscale

# 3. VÃ©rifier
maxscale --version
```

---

## Configuration de base : Load Balancing simple

### PrÃ©paration des serveurs backend

**CrÃ©er l'utilisateur MaxScale sur chaque nÅ“ud Galera :**

```sql
-- Sur galera-01, galera-02, galera-03
-- ExÃ©cuter sur UN nÅ“ud seulement (rÃ©plication Galera propagera)

-- Utilisateur pour monitoring
CREATE USER 'maxscale_monitor'@'%' 
    IDENTIFIED BY 'Monitor_P@ssw0rd_2024!';

GRANT REPLICATION CLIENT, REPLICATION SLAVE 
    ON *.* TO 'maxscale_monitor'@'%';

-- Utilisateur pour routage des requÃªtes
CREATE USER 'maxscale_router'@'%' 
    IDENTIFIED BY 'Router_P@ssw0rd_2024!';

GRANT SELECT ON mysql.user TO 'maxscale_router'@'%';
GRANT SELECT ON mysql.db TO 'maxscale_router'@'%';
GRANT SELECT ON mysql.tables_priv TO 'maxscale_router'@'%';
GRANT SELECT ON mysql.columns_priv TO 'maxscale_router'@'%';
GRANT SELECT ON mysql.procs_priv TO 'maxscale_router'@'%';
GRANT SELECT ON mysql.proxies_priv TO 'maxscale_router'@'%';
GRANT SELECT ON mysql.roles_mapping TO 'maxscale_router'@'%';

-- PrivilÃ¨ges applicatifs (proxy pour utilisateurs rÃ©els)
GRANT SHOW DATABASES ON *.* TO 'maxscale_router'@'%';

FLUSH PRIVILEGES;
```

### Configuration MaxScale complÃ¨te

**Fichier de configuration : /etc/maxscale.cnf**

```ini
# /etc/maxscale.cnf
# MaxScale 25.01 - Configuration Load Balancing

#
# === Global Settings ===
#
[maxscale]
# Threads: nombre de CPU cores
threads = auto

# Logging
log_warning = true
log_notice = true
log_info = false
log_debug = false

# Log rotation
log_augmentation = 1
maxlog = true
logdir = /var/log/maxscale

#
# === Servers (Backend Nodes) ===
#
[galera-01]
type = server
address = 10.0.1.11
port = 3306
protocol = MariaDBBackend
# Priority pour sÃ©lection (plus Ã©levÃ© = prÃ©fÃ©rÃ©)
priority = 1

[galera-02]
type = server
address = 10.0.1.12
port = 3306
protocol = MariaDBBackend
priority = 1

[galera-03]
type = server
address = 10.0.1.13
port = 3306
protocol = MariaDBBackend
priority = 1

#
# === Monitor (Galera Health Check) ===
#
[Galera-Monitor]
type = monitor
module = galeramon
servers = galera-01, galera-02, galera-03

# Credentials pour monitoring
user = maxscale_monitor
password = Monitor_P@ssw0rd_2024!

# Monitoring interval
monitor_interval = 2000ms

# Galera-specific options
disable_master_failback = false
available_when_donor = true
use_priority = true

# Backend connect timeout
backend_connect_timeout = 3s
backend_write_timeout = 3s
backend_read_timeout = 3s

#
# === Service (Load Balancing) ===
#
[Read-Write-Service]
type = service
router = readconnroute
servers = galera-01, galera-02, galera-03

# Router module: readconnroute (connection-based LB)
router_options = master

# Credentials pour routing
user = maxscale_router
password = Router_P@ssw0rd_2024!

# Connection settings
max_connections = 1000
connection_timeout = 10s

# Session tracking
enable_root_user = true
version_string = 11.8-MaxScale

# Retry settings
master_failure_mode = fail_on_write
master_reconnection = true
transaction_replay = true
transaction_replay_max_size = 10M

#
# === Listener (Client Entry Point) ===
#
[Read-Write-Listener]
type = listener
service = Read-Write-Service
protocol = MariaDBClient
port = 3306
address = 0.0.0.0

# Connection queueing
connection_init_sql_file = /etc/maxscale.d/init.sql
```

**Fichier d'initialisation SQL (optionnel) :**

```sql
-- /etc/maxscale.d/init.sql
-- SQL exÃ©cutÃ© Ã  chaque nouvelle connexion client

SET SESSION sql_mode='TRADITIONAL';
SET SESSION autocommit=1;
```

### DÃ©marrage et vÃ©rification

```bash
# 1. DÃ©marrer MaxScale
sudo systemctl start maxscale
sudo systemctl enable maxscale

# 2. VÃ©rifier le statut
sudo systemctl status maxscale

# 3. VÃ©rifier les logs
sudo tail -f /var/log/maxscale/maxscale.log

# 4. VÃ©rifier via CLI MaxScale
maxctrl list servers
```

**Output attendu :**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Server    â”‚ Address      â”‚ Port â”‚ Connections â”‚ State           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ galera-01 â”‚ 10.0.1.11    â”‚ 3306 â”‚ 0           â”‚ Master, Running â”‚
â”‚ galera-02 â”‚ 10.0.1.12    â”‚ 3306 â”‚ 0           â”‚ Slave, Running  â”‚
â”‚ galera-03 â”‚ 10.0.1.13    â”‚ 3306 â”‚ 0           â”‚ Slave, Running  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Algorithmes de Load Balancing

### 1. Round Robin (readconnroute)

**Principe :** Distribution sÃ©quentielle circulaire des connexions.

```
Connexions clients:
C1 â†’ galera-01
C2 â†’ galera-02
C3 â†’ galera-03
C4 â†’ galera-01 (cycle recommence)
C5 â†’ galera-02
...
```

**Configuration :**

```ini
[RoundRobin-Service]
type = service
router = readconnroute
# Par dÃ©faut: round-robin si router_options non spÃ©cifiÃ©
servers = galera-01, galera-02, galera-03
user = maxscale_router
password = Router_P@ssw0rd_2024!
```

**Avantages :**
- âœ… Simple et prÃ©visible
- âœ… Distribution Ã©quitable
- âœ… Pas d'overhead de calcul

**InconvÃ©nients :**
- âŒ Ne considÃ¨re pas la charge rÃ©elle des serveurs
- âŒ Sessions longues peuvent dÃ©sÃ©quilibrer
- âŒ Pas adaptÃ© aux serveurs hÃ©tÃ©rogÃ¨nes

**Cas d'usage optimal :**
- Serveurs homogÃ¨nes (mÃªme hardware)
- Connexions courtes
- Workload uniforme

### 2. Least Connections

**Principe :** Route vers le serveur avec le moins de connexions actives.

```
Ã‰tat serveurs:
galera-01: 50 connexions
galera-02: 30 connexions â† Choisi (moins chargÃ©)
galera-03: 45 connexions

Nouvelle connexion â†’ galera-02
```

**Configuration :**

```ini
[LeastConn-Service]
type = service
router = readconnroute
router_options = least_connections
servers = galera-01, galera-02, galera-03
user = maxscale_router
password = Router_P@ssw0rd_2024!
```

**Avantages :**
- âœ… AdaptÃ© aux sessions de durÃ©e variable
- âœ… Ã‰quilibrage dynamique
- âœ… RÃ©agit aux changements de charge

**InconvÃ©nients :**
- âŒ Overhead lÃ©ger (comptage connexions)
- âŒ Ne considÃ¨re pas la complexitÃ© des requÃªtes

**Cas d'usage optimal :**
- Sessions de durÃ©e variable
- Workload hÃ©tÃ©rogÃ¨ne
- Serveurs avec capacitÃ©s similaires

### 3. Weighted Round Robin

**Principe :** Distribution proportionnelle selon poids configurÃ©s.

```
Configuration poids:
galera-01: weight=3 (serveur puissant)
galera-02: weight=2 (serveur moyen)
galera-03: weight=1 (serveur faible)

Distribution sur 6 connexions:
C1 â†’ galera-01
C2 â†’ galera-01
C3 â†’ galera-01
C4 â†’ galera-02
C5 â†’ galera-02
C6 â†’ galera-03
```

**Configuration :**

```ini
# DÃ©finir poids dans la section [server]
[galera-01]
type = server
address = 10.0.1.11
port = 3306
priority = 3  # Poids Ã©levÃ©

[galera-02]
type = server
address = 10.0.1.12
port = 3306
priority = 2  # Poids moyen

[galera-03]
type = server
address = 10.0.1.13
port = 3306
priority = 1  # Poids faible

[Weighted-Service]
type = service
router = readconnroute
servers = galera-01, galera-02, galera-03
use_priority = true  # Activer pondÃ©ration
user = maxscale_router
password = Router_P@ssw0rd_2024!
```

**Cas d'usage optimal :**
- Serveurs hÃ©tÃ©rogÃ¨nes (CPU, RAM diffÃ©rents)
- Migration progressive (vieux/nouveaux serveurs)
- ContrÃ´le fin de la distribution

### 4. Adaptive Routing (MaxScale intelligent)

**Principe :** MaxScale analyse les mÃ©triques en temps rÃ©el pour optimiser.

```
MÃ©triques analysÃ©es:
- Latence des requÃªtes
- Charge CPU (si monitoring avancÃ©)
- Taux d'erreur
- Historique de performance

DÃ©cision dynamique:
galera-01: Latence 50ms, CPU 80% â†’ Score: 60/100
galera-02: Latence 10ms, CPU 40% â†’ Score: 95/100 â† Choisi
galera-03: Latence 30ms, CPU 60% â†’ Score: 75/100
```

ğŸ†• **MaxScale 25.01 amÃ©liore l'adaptive routing avec machine learning**

**Configuration :**

```ini
[Adaptive-Service]
type = service
router = readconnroute
router_options = adaptive
servers = galera-01, galera-02, galera-03
user = maxscale_router
password = Router_P@ssw0rd_2024!

# Options adaptive
adaptive_avg_samples = 10
adaptive_avg_interval = 1000ms
```

**Avantages :**
- âœ… Performance optimale
- âœ… S'adapte automatiquement
- âœ… GÃ¨re les serveurs hÃ©tÃ©rogÃ¨nes

**InconvÃ©nients :**
- âŒ ComplexitÃ© accrue
- âŒ Overhead de calcul
- âŒ Peut Ãªtre instable si mal configurÃ©

---

## Health Checks et Failover

### Configuration du monitoring Galera

**Galera Monitor - Options avancÃ©es :**

```ini
[Galera-Monitor]
type = monitor
module = galeramon
servers = galera-01, galera-02, galera-03

user = maxscale_monitor
password = Monitor_P@ssw0rd_2024!

# === Timing ===
monitor_interval = 2000ms
backend_connect_timeout = 3s
backend_read_timeout = 3s
backend_write_timeout = 3s

# === Galera Specific ===

# ConsidÃ©rer nÅ“ud disponible mÃªme en mode Donor (SST)
available_when_donor = true

# Utiliser les prioritÃ©s configurÃ©es
use_priority = true

# Ne pas refaire du donneur le master aprÃ¨s recovery
disable_master_failback = false

# DÃ©sactiver temporairement un serveur aprÃ¨s N Ã©checs
# (auto-rejoin aprÃ¨s monitor_interval Ã— N)
detect_stale_master = true
detect_stale_slave = true

# ParamÃ¨tres de dÃ©tection
# Nombre d'Ã©checs avant marquage down
backend_connect_attempts = 3
backend_connect_timeout = 3s

# === Scripts de notification ===
# ExÃ©cuter scripts sur Ã©vÃ©nements
# script = /usr/local/bin/maxscale-event-handler.sh --event=$EVENT --server=$SERVER
```

### Ã‰tats des serveurs

**Ã‰tats possibles dans MaxScale :**

```
Master:      NÅ“ud Ã©ligible pour Ã©critures (Galera: tous peuvent l'Ãªtre)
Slave:       NÅ“ud pour lectures (Galera: tous peuvent l'Ãªtre)
Running:     NÅ“ud opÃ©rationnel et joignable
Down:        NÅ“ud injoignable ou hors service
Maintenance: NÅ“ud en maintenance manuelle
Synced:      NÅ“ud Galera synchronisÃ© (Ã©tat Galera wsrep_local_state_comment=Synced)
Donor:       NÅ“ud Galera en cours de SST (donneur)
Joiner:      NÅ“ud Galera rejoignant le cluster
```

**VÃ©rifier les Ã©tats :**

```bash
# CLI MaxScale
maxctrl list servers

# DÃ©tails d'un serveur
maxctrl show server galera-01

# Output exemple:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Parameter          â”‚ Value                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Server             â”‚ galera-01                        â”‚
â”‚ Address            â”‚ 10.0.1.11                        â”‚
â”‚ Port               â”‚ 3306                             â”‚
â”‚ State              â”‚ Master, Synced, Running          â”‚
â”‚ Connections        â”‚ 42                               â”‚
â”‚ Statistics         â”‚ Active: 42, Total: 150           â”‚
â”‚ Galera             â”‚ wsrep_cluster_size: 3            â”‚
â”‚                    â”‚ wsrep_local_state: 4 (Synced)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Failover automatique

**ScÃ©nario de failover :**

```
Avant failover:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚galera-01â”‚  â”‚galera-02â”‚  â”‚galera-03â”‚
â”‚ Master  â”‚  â”‚ Slave   â”‚  â”‚ Slave   â”‚
â”‚ Running â”‚  â”‚ Running â”‚  â”‚ Running â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â†‘
  Connexions actives: 100

galera-01 tombe (panne hardware)
     â†“
MaxScale dÃ©tecte (aprÃ¨s 3 Ã— monitor_interval)
     â†“
Ã‰tat: galera-01 = Down
     â†“
Redistribution automatique connexions
     â†“
AprÃ¨s failover:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚galera-01â”‚  â”‚galera-02â”‚  â”‚galera-03â”‚
â”‚  Down   â”‚  â”‚ Master  â”‚  â”‚ Slave   â”‚
â”‚    X    â”‚  â”‚ Running â”‚  â”‚ Running â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†‘             â†‘
          Connexions: 60   40

Nouvelles connexions:
â†’ galera-02 et galera-03 seulement
```

**Configuration failover :**

```ini
[Read-Write-Service]
type = service
router = readconnroute
servers = galera-01, galera-02, galera-03
router_options = master

# === Failover Settings ===

# Comportement si master Ã©choue
master_failure_mode = fail_on_write
# Options:
# - fail_on_write: Ã©chec seulement sur tentative Ã©criture
# - fail_instantly: Ã©chec immÃ©diat
# - error_on_write: retourne erreur mais garde connexion

# Reconnexion automatique au master
master_reconnection = true

# ğŸ†• MaxScale 25.01: Transaction Replay
transaction_replay = true
transaction_replay_max_size = 10M
transaction_replay_attempts = 3
transaction_replay_timeout = 10s

# Retry logic
max_retry_interval = 10s
retry_on_failure = true
```

ğŸ†• **Transaction Replay (MaxScale 25.01 + MariaDB 11.8) :**

```
ScÃ©nario sans Transaction Replay:
Client â†’ MaxScale â†’ galera-01 (Master)
BEGIN;
UPDATE accounts SET balance = balance - 100 WHERE id = 42;
                    â†“
              galera-01 CRASH
                    â†“
ERROR: Connection lost
â†’ Application doit gÃ©rer retry

ScÃ©nario avec Transaction Replay:
Client â†’ MaxScale â†’ galera-01 (Master)
BEGIN;
UPDATE accounts SET balance = balance - 100 WHERE id = 42;
                    â†“
              galera-01 CRASH
                    â†“
MaxScale dÃ©tecte et stocke transaction
                    â†“
MaxScale reconnecte â†’ galera-02
                    â†“
MaxScale rejoue transaction:
BEGIN;
UPDATE accounts SET balance = balance - 100 WHERE id = 42;
COMMIT;
                    â†“
â†’ Transparent pour l'application! âœ…
```

---

## Connection Pooling et optimisations

### Pooling de connexions

**ProblÃ©matique sans pooling :**

```
Application (100 threads) â†” MaxScale â†” Galera (100 connexions backend)

ProblÃ¨me:
- 100 connexions simultanÃ©es sur chaque nÅ“ud Galera
- Overhead mÃ©moire: ~500KB par connexion
- Total: 100 Ã— 500KB Ã— 3 nÅ“uds = 150MB
- Context switching CPU Ã©levÃ©
```

**Avec connection pooling :**

```
Application (100 threads) â†” MaxScale (pool 20) â†” Galera (20 connexions backend)

Avantages:
- 20 connexions seulement sur chaque nÅ“ud
- RÃ©duction overhead mÃ©moire: 20 Ã— 500KB Ã— 3 = 30MB
- Meilleures performances CPU
- RÃ©utilisation connexions
```

**Configuration connection pooling :**

```ini
[Pooled-Service]
type = service
router = readconnroute
servers = galera-01, galera-02, galera-03
user = maxscale_router
password = Router_P@ssw0rd_2024!

# === Connection Pooling ===

# Pool de connexions par serveur backend
max_connections = 1000          # Connexions client max
connection_keepalive = 60s      # Keep-alive des connexions backend

# Timeout connexion idle
connection_timeout = 300s       # 5 minutes idle â†’ close

# Multiplexing (partage connexions backend)
# NOTE: DÃ©licat avec transactions, tester en staging
multiplex_timeout = 60s
```

### Persistent Connections

**Configuration pour sessions persistantes :**

```ini
[Persistent-Service]
type = service
router = readconnroute
servers = galera-01, galera-02, galera-03
user = maxscale_router
password = Router_P@ssw0rd_2024!

# Maintenir connexions ouvertes
connection_keepalive = 300s

# Session commands (SQL Ã  rejouer si reconnexion)
prune_sescmd_history = false
disable_sescmd_history = false
max_sescmd_history = 100

# AffinitÃ© session (sticky sessions)
# Note: RÃ©duit le load balancing mais nÃ©cessaire pour:
# - Temporary tables
# - User variables
# - Prepared statements
```

### Optimisations de performance

**Configuration haute performance :**

```ini
[maxscale]
# Threads = nombre de CPU cores
threads = 16

# Taille buffers rÃ©seau
writeq_high_water = 16384
writeq_low_water = 8192

# Cache des metadata
query_classifier_cache_size = 100M

# Non-blocking I/O optimizations
non_blocking_polls = true
poll_sleep = 1000  # microseconds

[High-Perf-Service]
type = service
router = readconnroute
servers = galera-01, galera-02, galera-03
user = maxscale_router
password = Router_P@ssw0rd_2024!

# Optimisations
max_connections = 10000
connection_timeout = 30s
net_write_timeout = 60s

# Disable query classification si non utilisÃ©
disable_query_classifier = false
```

---

## Monitoring et mÃ©triques MaxScale

### MaxCtrl - Interface CLI

**Commandes essentielles :**

```bash
# === Status gÃ©nÃ©ral ===
maxctrl list servers
maxctrl list services
maxctrl list listeners
maxctrl list monitors

# === DÃ©tails serveur ===
maxctrl show server galera-01

# === Statistiques service ===
maxctrl show service Read-Write-Service

# === Connexions actives ===
maxctrl list sessions

# === Tuer une session ===
maxctrl destroy session <session-id>

# === Mettre serveur en maintenance ===
maxctrl set server galera-01 maintenance

# === Retirer de maintenance ===
maxctrl clear server galera-01 maintenance

# === Reload configuration (sans restart) ===
maxctrl reload service Read-Write-Service
```

### REST API

**Activation de l'API REST :**

```ini
# /etc/maxscale.cnf
[maxscale]
admin_host = 0.0.0.0
admin_port = 8989
admin_auth = true
admin_enabled = true
admin_secure_gui = true

# CrÃ©er utilisateur admin
admin_users = admin:admin_password
```

**RequÃªtes API :**

```bash
# Authentification
curl -u admin:admin_password http://localhost:8989/v1/auth

# Liste des serveurs
curl -u admin:admin_password http://localhost:8989/v1/servers | jq

# MÃ©triques spÃ©cifiques
curl -u admin:admin_password http://localhost:8989/v1/servers/galera-01 | jq

# Modifier Ã©tat serveur
curl -X PUT \
    -u admin:admin_password \
    -H "Content-Type: application/json" \
    http://localhost:8989/v1/servers/galera-01 \
    -d '{"state": "maintenance"}'
```

### MÃ©triques Prometheus

**Exporter mÃ©triques pour Prometheus :**

```bash
# MaxScale expose nativement des mÃ©triques
# Endpoint: http://maxscale-host:8989/v1/maxscale/metrics

# Configuration Prometheus
# prometheus.yml
scrape_configs:
  - job_name: 'maxscale'
    static_configs:
      - targets: ['maxscale-host:8989']
    basic_auth:
      username: admin
      password: admin_password
    metrics_path: /v1/maxscale/metrics
```

**MÃ©triques clÃ©s Ã  monitorer :**

```yaml
# Connexions
maxscale_connections_total
maxscale_connections_current
maxscale_server_connections{server="galera-01"}

# RequÃªtes
maxscale_queries_total
maxscale_queries_per_second

# Sessions
maxscale_sessions_total
maxscale_sessions_current

# Health
maxscale_server_status{server="galera-01"}  # 1=up, 0=down

# Latence
maxscale_server_response_time{server="galera-01"}
```

### Dashboard Grafana

**RequÃªtes Grafana essentielles :**

```promql
# 1. Connexions par serveur
sum by (server) (maxscale_server_connections)

# 2. Distribution de charge (%)
(maxscale_server_connections / 
 sum(maxscale_server_connections)) * 100

# 3. Taux de requÃªtes
rate(maxscale_queries_total[5m])

# 4. Latence moyenne par serveur
avg by (server) (maxscale_server_response_time)

# 5. DisponibilitÃ© des serveurs
maxscale_server_status
```

---

## ScÃ©narios de production avancÃ©s

### ScÃ©nario 1 : Geo-distributed load balancing

**Architecture multi-DC avec MaxScale rÃ©gional :**

```
         Europe                        US
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MaxScale-EU       â”‚      â”‚  MaxScale-US       â”‚
â”‚  (Priority local)  â”‚      â”‚  (Priority local)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                           â”‚
   â”Œâ”€â”€â”€â”´â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”¬â”€â”€â”€â”€â”€â”
   â”‚       â”‚                          â”‚     â”‚
â”Œâ”€â”€â”´â”€â”€â”€â”€â” â”Œâ”´â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â” â”Œâ”´â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚gal-eu1â”‚ â”‚gal-eu2  â”‚          â”‚gal-us1  â”‚ â”‚gal-us2  â”‚
â”‚ Prio:3â”‚ â”‚ Prio:2  â”‚          â”‚ Prio:3  â”‚ â”‚ Prio:2  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             Galera Cluster (WAN)
```

**Configuration MaxScale-EU :**

```ini
# MaxScale en Europe - prÃ©fÃ©rence nÅ“uds locaux
[galera-eu1]
type = server
address = galera-eu1.example.com
priority = 3  # PrÃ©fÃ©rÃ©

[galera-eu2]
type = server
address = galera-eu2.example.com
priority = 2

[galera-us1]
type = server
address = galera-us1.example.com
priority = 1  # Fallback seulement

[galera-us2]
type = server
address = galera-us2.example.com
priority = 1  # Fallback seulement

[EU-Service]
type = service
router = readconnroute
servers = galera-eu1, galera-eu2, galera-us1, galera-us2
use_priority = true
```

### ScÃ©nario 2 : Maintenance sans downtime

**ProcÃ©dure de maintenance d'un nÅ“ud :**

```bash
# 1. Mettre le nÅ“ud en maintenance dans MaxScale
maxctrl set server galera-02 maintenance

# Ã‰tat: galera-02 ne reÃ§oit plus de nouvelles connexions
# Connexions existantes continuent

# 2. Attendre drainage des connexions existantes
watch -n 5 'maxctrl show server galera-02 | grep Connections'

# Ou forcer fermeture (attention!)
# maxctrl call command mariadbmon async-drain-node galera-02

# 3. Effectuer maintenance sur galera-02
# (upgrade, configuration, hardware, etc.)

# 4. RedÃ©marrer galera-02
systemctl restart mariadb

# 5. VÃ©rifier synchronisation Galera
mysql -e "SHOW STATUS LIKE 'wsrep_local_state_comment';"
# Doit afficher: Synced

# 6. Retirer de maintenance dans MaxScale
maxctrl clear server galera-02 maintenance

# Ã‰tat: galera-02 recommence Ã  recevoir du trafic
```

### ScÃ©nario 3 : Rolling upgrade MaxScale (HA pair)

**Architecture MaxScale HA :**

```
        Virtual IP: 10.0.2.100
               â†“
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚   Keepalived    â”‚
      â”‚  (VRRP Master)  â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MaxScale-1 (Active)         â”‚
â”‚  Priority: 100               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  MaxScale-2 (Standby)        â”‚
â”‚  Priority: 90                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ProcÃ©dure upgrade sans downtime :**

```bash
# Sur MaxScale-2 (standby):
# 1. Upgrade
apt update
apt install maxscale=25.01.x

# 2. VÃ©rifier config compatible
maxscale --config-check /etc/maxscale.cnf

# 3. Restart MaxScale-2
systemctl restart maxscale

# 4. Test
maxctrl list servers

# 5. Basculer sur MaxScale-2
# RÃ©duire prioritÃ© keepalived de MaxScale-1
# MaxScale-2 devient master

# 6. Upgrade MaxScale-1
# (mÃªme procÃ©dure)

# 7. Optionnel: re-basculer sur MaxScale-1
```

---

## âœ… Points clÃ©s Ã  retenir

- **MaxScale** : Proxy intelligent pour load balancing, routage, HA et sÃ©curitÃ© MariaDB/MySQL
- **Algorithmes LB** : Round-robin (simple), least connections (adaptatif), weighted (serveurs hÃ©tÃ©rogÃ¨nes), adaptive (intelligent)
- **Connection pooling** : RÃ©duit connexions backend, amÃ©liore performances, Ã©conomise ressources
- **Health checks** : Galera monitor surveille Ã©tat cluster (2s interval recommandÃ©), dÃ©tection automatique pannes
- **Failover automatique** : DÃ©tection 3Ã— monitor_interval, redistribution connexions transparente
- **ğŸ†• Transaction Replay** : MaxScale 25.01 + MariaDB 11.8, rejoue transactions aprÃ¨s failover transparent
- **Monitoring** : maxctrl CLI, REST API, mÃ©triques Prometheus, dashboard Grafana
- **Production** : Geo-distributed avec prioritÃ©s, maintenance sans downtime, MaxScale HA avec keepalived
- **Configuration critique** : `available_when_donor=true`, `master_reconnection=true`, `transaction_replay=true`
- **Optimisations** : threads=auto, connection_keepalive, query_classifier_cache, non_blocking_polls
- **Utilisateurs requis** : maxscale_monitor (REPLICATION CLIENT), maxscale_router (SELECT mysql.*)
- **Ã‰tats serveurs** : Master/Slave (rÃ´le), Running/Down (disponibilitÃ©), Synced/Donor/Joiner (Galera)

---

## ğŸ”— Ressources et rÃ©fÃ©rences

### Documentation officielle MaxScale
- [ğŸ“– MaxScale 25.01 Documentation](https://mariadb.com/docs/server/architecture/components/maxscale/)
- [ğŸ“– MaxScale Load Balancing](https://mariadb.com/kb/en/maxscale-readconnroute/)
- [ğŸ“– Galera Monitor](https://mariadb.com/kb/en/mariadb-maxscale-25-galera-monitor/)
- [ğŸ“– MaxScale REST API](https://mariadb.com/kb/en/maxscale-rest-api/)

### NouveautÃ©s MaxScale 25.01
- [ğŸ“– Transaction Replay](https://mariadb.com/docs/server/connect/programming-languages/maxscale/transaction-replay/)
- [ğŸ†• Workload Capture & Replay](https://mariadb.com/docs/server/operations/workload-testing/)
- [ğŸ†• Connection Migration](https://mariadb.com/docs/server/architecture/components/maxscale/connection-migration/)

### Guides techniques
- [MaxScale Best Practices](https://mariadb.com/resources/blog/maxscale-best-practices/)
- [Load Balancing Strategies](https://severalnines.com/database-blog/maxscale-load-balancing-strategies/)
- [MaxScale High Availability](https://mariadb.com/resources/blog/maxscale-high-availability/)

### Outils
- [maxctrl CLI Reference](https://mariadb.com/kb/en/maxctrl/)
- [MaxScale Prometheus Exporter](https://github.com/mariadb-corporation/maxscale-prometheus-exporter)
- [Grafana Dashboard for MaxScale](https://grafana.com/grafana/dashboards/13106-maxscale/)

---

## â¡ï¸ Section suivante

**14.4.2 Read/Write Split** : Routage intelligent des requÃªtes entre nÅ“uds lecture et Ã©criture, optimisation des performances avec sÃ©paration des workloads, configuration avancÃ©e du router readwritesplit, gestion des sessions et consistance des lectures.

---


â­ï¸ [Read/Write Split](/14-haute-disponibilite/04.2-read-write-split.md)
