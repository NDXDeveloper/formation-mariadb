üîù Retour au [Sommaire](/SOMMAIRE.md)

# 14.5.3 Diff Router

> **Niveau** : Expert  
> **Dur√©e estim√©e** : 3-4 heures  
> **Pr√©requis** : MaxScale (14.4), Workload Capture/Replay (14.5.1-14.5.2), Architecture distribu√©e

## üéØ Objectifs d'apprentissage

√Ä l'issue de cette section, vous serez capable de :
- Comprendre l'architecture et le fonctionnement du Diff Router
- Configurer le Diff Router pour comparer deux backends
- Valider des upgrades MariaDB avec comparaison automatique
- D√©tecter et analyser les incompatibilit√©s SQL
- Comparer les performances entre versions
- Interpr√©ter les rapports de diff√©rences
- Optimiser la configuration pour minimiser les faux positifs
- Int√©grer le Diff Router dans des workflows de test

---

## Introduction

Le **Diff Router** est une fonctionnalit√© innovante introduite dans **MaxScale 25.01** qui permet de router chaque requ√™te vers deux backends diff√©rents et de comparer automatiquement les r√©sultats. C'est un outil puissant pour valider des changements avant leur d√©ploiement en production.

```
Architecture Diff Router:

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      Client Application                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ Requ√™te SQL
                       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   MaxScale Diff Router                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ
‚îÇ  ‚îÇ           Query Duplication Engine                 ‚îÇ     ‚îÇ
‚îÇ  ‚îÇ  Duplique chaque requ√™te vers 2 backends           ‚îÇ     ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ
‚îÇ          ‚îÇ                                    ‚îÇ             ‚îÇ
‚îÇ          ‚Üì                                    ‚Üì             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê               ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ  Primary Backend ‚îÇ               ‚îÇ Secondary Backend‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  (baseline)      ‚îÇ               ‚îÇ  (candidate)     ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  MariaDB 11.8    ‚îÇ               ‚îÇ  MariaDB 12.0    ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò               ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ           ‚îÇ                                  ‚îÇ              ‚îÇ
‚îÇ           ‚Üì                                  ‚Üì              ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ         Results Comparison Engine                   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ Compare:                                     ‚îÇ   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ - Result sets (rows, columns, values)        ‚îÇ   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ - Row counts                                 ‚îÇ   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ - Execution times                            ‚îÇ   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ - Errors                                     ‚îÇ   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ                         ‚îÇ                                   ‚îÇ
‚îÇ                         ‚Üì                                   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ          Difference Detection & Logging             ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ If differences detected:                     ‚îÇ   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ - Log to diff_log_file                       ‚îÇ   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ - Increment metrics                          ‚îÇ   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ - Generate alerts (optional)                 ‚îÇ   ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                       ‚îÇ Retourne r√©sultat PRIMARY au client
                       ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                      Client Application                     ‚îÇ
‚îÇ  (Re√ßoit r√©sultat du PRIMARY, transparent)                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Principe:
‚úÖ Double ex√©cution (primary + secondary)
‚úÖ Comparaison automatique des r√©sultats
‚úÖ Client re√ßoit r√©sultat du primary (transparent)
‚úÖ Logging des diff√©rences pour analyse
‚úÖ M√©triques Prometheus pour monitoring
```

**Cas d'usage principaux :**

1. **Validation upgrade MariaDB** : Comparer 11.8 vs 12.0 avant migration production
2. **Test nouvelles configurations** : Comparer deux configurations optimizer/storage
3. **D√©tection de r√©gressions** : Identifier bugs introduits par patches
4. **Validation patches** : V√©rifier qu'un fix ne casse rien
5. **A/B testing database** : Comparer comportement de 2 versions c√¥te-√†-c√¥te

---

## Configuration du Diff Router

### Configuration de base

**Fichier /etc/maxscale.cnf :**

```ini
# /etc/maxscale.cnf - Diff Router Configuration

[maxscale]
threads = auto
log_info = true

#
# === Servers ===
#

# Backend primaire (baseline)
[primary-server]
type = server
address = 10.0.1.11
port = 3306
protocol = MariaDBBackend

# Backend secondaire (candidate)
[secondary-server]
type = server
address = 10.0.1.12
port = 3306
protocol = MariaDBBackend

#
# === Monitor (optionnel) ===
#
[MariaDB-Monitor]
type = monitor
module = mariadbmon
servers = primary-server, secondary-server
user = maxscale_monitor
password = Monitor_P@ssw0rd_2024!
monitor_interval = 2000ms

#
# === Service Diff Router ===
#
[Diff-Service]
type = service
router = diff

# Backends
primary_server = primary-server
secondary_server = secondary-server

# Credentials
user = maxscale_router
password = Router_P@ssw0rd_2024!

# === Comparison Mode ===

# Mode de comparaison
diff_mode = both
# Options:
# - results: Compare seulement les r√©sultats (data)
# - performance: Compare seulement les temps d'ex√©cution
# - both: Compare r√©sultats ET performance (recommand√©)

# === Tolerance Settings ===

# Tol√©rance pour diff√©rences num√©riques (floats)
diff_tolerance = 0.001
# 0.001 = 0.1% de diff√©rence accept√©e pour valeurs flottantes
# Exemple: 99.999 vs 100.001 ‚Üí Consid√©r√© identique

# Tol√©rance pour temps d'ex√©cution
diff_performance_tolerance = 10
# 10 = 10% de diff√©rence temps d'ex√©cution accept√©e
# Exemple: 100ms vs 109ms ‚Üí Consid√©r√© identique

# === Result Comparison Settings ===

# Ignorer ordre des r√©sultats
diff_ignore_order = true
# true: ORDER BY non d√©terministe accept√©
# false: Ordre doit √™tre strictement identique

# Ignorer colonnes sp√©cifiques
diff_ignore_columns = created_at,updated_at,last_modified,timestamp
# Colonnes avec timestamps/auto-values variables

# Ignorer diff√©rences AUTO_INCREMENT
diff_ignore_auto_increment = true
# Permet diff√©rences dans valeurs AUTO_INCREMENT entre les 2 backends

# Comparer checksums plut√¥t que valeurs individuelles (performance)
diff_use_checksum = false
# true: Calcule MD5 du result set (plus rapide pour gros r√©sultats)
# false: Compare ligne par ligne (plus pr√©cis pour debugging)

# === Logging ===

# Fichier de log des diff√©rences
diff_log_file = /var/log/maxscale/diff.log

# Format du log
diff_log_format = json
# Options: json (recommand√©), text, csv

# Seuil de logging
diff_log_threshold = 1
# Log seulement si nombre de diff√©rences >= seuil
# 0 = log toutes diff√©rences, 1 = log si au moins 1 diff√©rence

# Logging verbeux
diff_log_verbose = true
# true: Inclut d√©tails complets (requ√™te, r√©sultats complets)
# false: Inclut seulement summary

# Limite taille log par entr√©e
diff_log_max_entry_size = 10KB
# Tronque les grandes entr√©es pour √©viter logs gigantesques

# === Execution Settings ===

# Timeout pour ex√©cution sur secondary
diff_timeout = 60s
# Si secondary prend >60s, consid√©r√© comme erreur

# Ex√©cution parall√®le
diff_parallel_execution = true
# true: Ex√©cute primary et secondary en parall√®le (plus rapide)
# false: Ex√©cute s√©quentiellement (plus facile pour debugging)

# === Error Handling ===

# Comportement si secondary √©choue
diff_on_secondary_error = ignore
# Options:
# - ignore: Continue, log erreur, retourne r√©sultat primary
# - log: Log erreur comme diff√©rence
# - fail: √âchoue requ√™te si secondary √©choue

# === Filtering ===

# Types de requ√™tes √† comparer
diff_query_types = SELECT,INSERT,UPDATE,DELETE
# Exclure: DDL (CREATE, ALTER) si pas pertinent

# Utilisateurs √† comparer (vide = tous)
diff_users = app_user,test_user
# Exclure utilisateurs techniques (monitoring, backup)

# Databases √† comparer
diff_databases = production_db,test_db
# Exclure databases syst√®me

#
# === Listener ===
#
[Diff-Listener]
type = listener
service = Diff-Service
protocol = MariaDBClient
port = 3306
address = 0.0.0.0
```

### Configuration optimis√©e pour production

**Configuration avec impact minimal :**

```ini
[Production-Diff-Service]
type = service
router = diff

primary_server = primary-server
secondary_server = secondary-server

user = maxscale_router
password = Router_P@ssw0rd_2024!

# Mode comparaison
diff_mode = results
# Production: Seulement r√©sultats (pas performance pour limiter overhead)

# Tol√©rance √©lev√©e pour r√©duire faux positifs
diff_tolerance = 0.01  # 1%
diff_ignore_order = true
diff_ignore_columns = created_at,updated_at,last_login,timestamp,modified_date
diff_ignore_auto_increment = true

# Logging optimis√©
diff_log_file = /var/log/maxscale/diff.log
diff_log_format = json
diff_log_threshold = 5  # Log seulement si ‚â•5 diff√©rences (filtre bruit)
diff_log_verbose = false  # Summary seulement
diff_log_max_entry_size = 5KB

# Performance
diff_timeout = 30s
diff_parallel_execution = true
diff_use_checksum = true  # Plus rapide pour gros r√©sultats

# Filtrage agressif pour limiter volume
diff_query_types = SELECT  # Seulement SELECT en production
diff_users = app_user  # Seulement traffic applicatif

# Erreurs
diff_on_secondary_error = ignore  # Ne pas impacter production si secondary fail
```

---

## Analyse des diff√©rences

### Format de log JSON

**Structure d'une entr√©e de diff√©rence :**

```json
{
  "timestamp": "2024-12-15T14:30:15.234Z",
  "session_id": "abc123def456",
  "user": "app_user",
  "database": "production_db",
  "source_ip": "10.0.2.50",
  
  "query": {
    "type": "SELECT",
    "text": "SELECT id, name, price * 1.055 AS total FROM products WHERE category = 'electronics'",
    "parameters": []
  },
  
  "primary": {
    "server": "primary-server",
    "version": "11.8.12-MariaDB",
    "execution_time_ms": 12.5,
    "rows_returned": 150,
    "rows_examined": 150,
    "result_checksum": "a1b2c3d4e5f6",
    "error": null
  },
  
  "secondary": {
    "server": "secondary-server",
    "version": "12.0.5-MariaDB",
    "execution_time_ms": 10.8,
    "rows_returned": 150,
    "rows_examined": 150,
    "result_checksum": "f6e5d4c3b2a1",
    "error": null
  },
  
  "differences": {
    "result_mismatch": true,
    "performance_mismatch": false,
    "details": [
      {
        "type": "value_difference",
        "row": 42,
        "column": "total",
        "primary_value": 99.999,
        "secondary_value": 100.001,
        "delta": 0.002,
        "delta_percent": 0.002,
        "within_tolerance": false
      },
      {
        "type": "value_difference",
        "row": 89,
        "column": "total",
        "primary_value": 149.998,
        "secondary_value": 150.002,
        "delta": 0.004,
        "delta_percent": 0.003,
        "within_tolerance": false
      }
    ]
  },
  
  "summary": {
    "total_differences": 2,
    "critical_differences": 0,
    "within_tolerance": 0,
    "impact": "LOW"
  }
}
```

### Types de diff√©rences d√©tect√©es

**Cat√©gorisation des diff√©rences :**

```
1. RESULT DIFFERENCES
   ‚îú‚îÄ Row count mismatch
   ‚îÇ  ‚îî‚îÄ Primary: 100 rows, Secondary: 99 rows
   ‚îÇ
   ‚îú‚îÄ Column count mismatch
   ‚îÇ  ‚îî‚îÄ Primary: 5 columns, Secondary: 6 columns
   ‚îÇ
   ‚îú‚îÄ Column type mismatch
   ‚îÇ  ‚îî‚îÄ Column 'age': Primary INT, Secondary BIGINT
   ‚îÇ
   ‚îú‚îÄ Value differences
   ‚îÇ  ‚îú‚îÄ Numeric precision: 99.999 vs 100.001
   ‚îÇ  ‚îú‚îÄ String differences: 'hello' vs 'Hello'
   ‚îÇ  ‚îú‚îÄ Date format: '2024-12-15' vs '12/15/2024'
   ‚îÇ  ‚îî‚îÄ NULL vs empty string
   ‚îÇ
   ‚îî‚îÄ Order differences (si diff_ignore_order=false)
      ‚îî‚îÄ Row 1 and Row 2 swapped

2. PERFORMANCE DIFFERENCES
   ‚îú‚îÄ Execution time delta
   ‚îÇ  ‚îî‚îÄ Primary: 100ms, Secondary: 150ms (+50%)
   ‚îÇ
   ‚îú‚îÄ Rows examined delta
   ‚îÇ  ‚îî‚îÄ Primary: 1000 examined, Secondary: 10000 examined (x10)
   ‚îÇ
   ‚îú‚îÄ Temporary tables
   ‚îÇ  ‚îî‚îÄ Primary: 0, Secondary: 1 temp table
   ‚îÇ
   ‚îî‚îÄ Filesort usage
      ‚îî‚îÄ Primary: No filesort, Secondary: Using filesort

3. ERROR DIFFERENCES
   ‚îú‚îÄ Primary success, Secondary error
   ‚îÇ  ‚îî‚îÄ Secondary: "Syntax error near 'LIMIT'"
   ‚îÇ
   ‚îú‚îÄ Primary error, Secondary success
   ‚îÇ  ‚îî‚îÄ Primary: "Column not found", Secondary: OK
   ‚îÇ
   ‚îî‚îÄ Different error codes
      ‚îî‚îÄ Primary: ER_DUP_KEY (1062), Secondary: ER_LOCK_WAIT (1205)
```

### Interpr√©tation des diff√©rences

**Matrice d'impact :**

| Type de diff√©rence | Impact | Action recommand√©e |
|-------------------|--------|-------------------|
| Float precision (0.001%) | üü¢ LOW | Acceptable si dans tol√©rance |
| Timestamp/NOW() diff√©rent | üü¢ LOW | Ajouter √† diff_ignore_columns |
| AUTO_INCREMENT diff√©rent | üü¢ LOW | Activer diff_ignore_auto_increment |
| Order diff√©rent sans ORDER BY | üü° MEDIUM | V√©rifier si ORDER BY manquant |
| Row count mismatch | üî¥ HIGH | Investigation requise |
| Column type mismatch | üî¥ HIGH | Incompatibilit√© d√©tect√©e |
| Error on secondary | üî¥ HIGH | Syntax/feature non support√©e |
| Performance >50% slower | üü° MEDIUM | Optimizer difference, analyser EXPLAIN |
| Performance >200% slower | üî¥ HIGH | R√©gression majeure |

---

## Cas d'usage avanc√©s

### Use case 1 : Validation upgrade MariaDB

**Sc√©nario :** Valider upgrade 11.8 ‚Üí 12.0 avec trafic production mirrored

```ini
# /etc/maxscale.cnf - Upgrade Validation

[Upgrade-Validation-Service]
type = service
router = diff

# Production (11.8) comme primary
primary_server = production-11.8

# Candidate (12.0) comme secondary
secondary_server = candidate-12.0

user = maxscale_router
password = Router_P@ssw0rd_2024!

# Comparaison stricte
diff_mode = both
diff_tolerance = 0.001
diff_ignore_order = true
diff_ignore_columns = created_at,updated_at,last_login
diff_ignore_auto_increment = true

# Logging d√©taill√© pour analyse
diff_log_file = /var/log/maxscale/upgrade_validation.log
diff_log_format = json
diff_log_threshold = 1
diff_log_verbose = true

# Timeout g√©n√©reux (secondary peut √™tre plus lent pendant warmup)
diff_timeout = 120s

# Erreurs secondary logg√©es comme diff√©rences critiques
diff_on_secondary_error = log

# Comparaison compl√®te
diff_query_types = SELECT,INSERT,UPDATE,DELETE
```

**Analyse des r√©sultats :**

```bash
# Script d'analyse des diff√©rences de validation
#!/bin/bash
# analyze-upgrade-validation.sh

LOG_FILE="/var/log/maxscale/upgrade_validation.log"
REPORT_FILE="/tmp/upgrade_validation_report.html"

echo "Analyzing upgrade validation differences..."

# Compter diff√©rences par type
python3 << 'EOF'
import json
from collections import defaultdict

differences = defaultdict(int)
critical_issues = []

with open('/var/log/maxscale/upgrade_validation.log') as f:
    for line in f:
        try:
            entry = json.loads(line)
            
            # Compter par type
            for diff in entry.get('differences', {}).get('details', []):
                differences[diff['type']] += 1
            
            # Identifier issues critiques
            if entry.get('summary', {}).get('impact') in ['HIGH', 'CRITICAL']:
                critical_issues.append({
                    'query': entry['query']['text'][:100],
                    'issue': entry['differences']['details'][0]['type'],
                    'impact': entry['summary']['impact']
                })
        except:
            continue

# Afficher r√©sum√©
print("\n=== UPGRADE VALIDATION REPORT ===\n")

print("Differences by type:")
for diff_type, count in sorted(differences.items(), key=lambda x: x[1], reverse=True):
    print(f"  {diff_type}: {count}")

print(f"\nCritical issues: {len(critical_issues)}")

if critical_issues:
    print("\nTop 10 critical issues:")
    for i, issue in enumerate(critical_issues[:10], 1):
        print(f"\n{i}. {issue['impact']} - {issue['issue']}")
        print(f"   Query: {issue['query']}...")

if len(critical_issues) == 0:
    print("\n‚úÖ NO CRITICAL ISSUES - UPGRADE SAFE")
elif len(critical_issues) < 10:
    print(f"\n‚ö†Ô∏è  {len(critical_issues)} CRITICAL ISSUES - REVIEW REQUIRED")
else:
    print(f"\n‚ùå {len(critical_issues)} CRITICAL ISSUES - UPGRADE NOT RECOMMENDED")
EOF
```

### Use case 2 : Comparaison optimizer hints

**Sc√©nario :** Comparer impact de hints optimizer

```ini
# /etc/maxscale.cnf - Optimizer Comparison

[Optimizer-Test-Service]
type = service
router = diff

# Baseline: Sans hints
primary_server = db-no-hints

# Candidate: Avec hints optimizer
secondary_server = db-with-hints

# Focus sur performance
diff_mode = performance
diff_performance_tolerance = 5  # Alert si >5% diff√©rence

diff_log_file = /var/log/maxscale/optimizer_comparison.log
diff_log_format = json
diff_log_verbose = true

# Seulement SELECT (optimizer impact)
diff_query_types = SELECT
```

**Configuration serveur avec hints :**

```sql
-- Sur db-with-hints: Activer optimizer hints globalement
-- my.cnf
[mysqld]
optimizer_switch='mrr=on,mrr_cost_based=off,index_merge=on'
optimizer_use_condition_selectivity=5
```

### Use case 3 : A/B testing storage engines

**Sc√©nario :** Comparer InnoDB vs MyRocks

```ini
[Storage-Engine-Comparison]
type = service
router = diff

# Primary: InnoDB (standard)
primary_server = db-innodb

# Secondary: MyRocks (test)
secondary_server = db-myrocks

# Comparaison r√©sultats + performance
diff_mode = both

# Tol√©rance pour diff√©rences acceptables
diff_tolerance = 0.01
diff_performance_tolerance = 20  # MyRocks peut √™tre diff√©rent

diff_log_file = /var/log/maxscale/storage_engine_comparison.log
diff_log_format = json
```

---

## M√©triques et monitoring

### M√©triques Prometheus

**M√©triques expos√©es par Diff Router :**

```promql
# Nombre total de requ√™tes compar√©es
maxscale_diff_queries_total{service="Diff-Service"}

# Nombre de diff√©rences d√©tect√©es
maxscale_diff_differences_total{service="Diff-Service",type="result"}
maxscale_diff_differences_total{service="Diff-Service",type="performance"}
maxscale_diff_differences_total{service="Diff-Service",type="error"}

# Taux de diff√©rences (%)
(maxscale_diff_differences_total / maxscale_diff_queries_total) * 100

# Latence ajout√©e par comparison (overhead)
maxscale_diff_comparison_duration_ms

# Erreurs sur secondary backend
maxscale_diff_secondary_errors_total

# Timeouts sur secondary
maxscale_diff_secondary_timeouts_total
```

### Dashboard Grafana

**Panels recommand√©s :**

```json
{
  "dashboard": {
    "title": "Diff Router Monitoring",
    "panels": [
      {
        "title": "Diff Rate (%)",
        "type": "graph",
        "targets": [
          {
            "expr": "(rate(maxscale_diff_differences_total[5m]) / rate(maxscale_diff_queries_total[5m])) * 100"
          }
        ],
        "alert": {
          "conditions": [
            {
              "evaluator": {
                "params": [1],
                "type": "gt"
              },
              "query": {
                "params": ["A", "5m", "now"]
              },
              "type": "query"
            }
          ],
          "message": "Diff rate >1% - investigate differences"
        }
      },
      {
        "title": "Differences by Type",
        "type": "piechart",
        "targets": [
          {
            "expr": "sum by (type) (increase(maxscale_diff_differences_total[1h]))"
          }
        ]
      },
      {
        "title": "Secondary Backend Errors",
        "type": "stat",
        "targets": [
          {
            "expr": "increase(maxscale_diff_secondary_errors_total[1h])"
          }
        ]
      },
      {
        "title": "Comparison Overhead (ms)",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(maxscale_diff_comparison_duration_ms_bucket[5m]))"
          }
        ]
      }
    ]
  }
}
```

### Alerting

**R√®gles Prometheus :**

```yaml
# /etc/prometheus/rules/diff_router.yml
groups:
  - name: diff_router
    interval: 30s
    rules:
      # Alerte si taux de diff√©rences >1%
      - alert: HighDiffRate
        expr: |
          (rate(maxscale_diff_differences_total[5m]) / 
           rate(maxscale_diff_queries_total[5m])) * 100 > 1
        for: 10m
        labels:
          severity: warning
          category: validation
        annotations:
          summary: "High diff rate detected"
          description: "{{ $value }}% of queries have differences (threshold: 1%)"
      
      # Alerte si erreurs sur secondary
      - alert: SecondaryBackendErrors
        expr: increase(maxscale_diff_secondary_errors_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          category: backend
        annotations:
          summary: "Secondary backend errors detected"
          description: "{{ $value }} errors in last 5 minutes"
      
      # Alerte si overhead trop √©lev√©
      - alert: HighComparisonOverhead
        expr: |
          histogram_quantile(0.95, 
            rate(maxscale_diff_comparison_duration_ms_bucket[5m])
          ) > 100
        for: 10m
        labels:
          severity: info
          category: performance
        annotations:
          summary: "High comparison overhead"
          description: "P95 comparison time: {{ $value }}ms (threshold: 100ms)"
```

---

## Optimisation et tuning

### R√©duction des faux positifs

**Configuration pour minimiser bruit :**

```ini
[Optimized-Diff-Service]
type = service
router = diff

primary_server = primary-server
secondary_server = secondary-server

# === Tol√©rance √©largie ===
diff_tolerance = 0.01  # 1% pour floats
diff_performance_tolerance = 20  # 20% pour temps ex√©cution

# === Ignorer patterns courants ===
diff_ignore_order = true
diff_ignore_auto_increment = true

# Colonnes √† ignorer (√©largir liste)
diff_ignore_columns = |
  created_at,updated_at,modified_at,last_modified,
  timestamp,last_login,last_seen,
  id,uuid,guid,
  random_id,token,session_id

# === Filtrage r√©sultats ===
diff_log_threshold = 5  # Seulement si ‚â•5 diff√©rences
# Ignore bruit de 1-2 diff√©rences isol√©es

# === Checksums pour performance ===
diff_use_checksum = true
# Plus rapide, mais moins d√©taill√©

# === Ignorer erreurs transitoires ===
diff_on_secondary_error = ignore
# Erreurs network timeout, etc.
```

### Pattern matching pour ignorer diff√©rences

**Regex-based filtering (si support√©) :**

```ini
# Ignorer diff√©rences sur certains patterns de requ√™tes
diff_ignore_query_patterns = |
  SELECT.*NOW\(\),
  SELECT.*RAND\(\),
  SELECT.*UUID\(\),
  SELECT.*CONNECTION_ID\(\),
  SELECT.*LAST_INSERT_ID\(\)

# Ces fonctions retournent naturellement diff√©rents r√©sultats
```

### Optimisation performance

**Minimiser overhead du Diff Router :**

```ini
[Low-Overhead-Diff-Service]
type = service
router = diff

primary_server = primary-server
secondary_server = secondary-server

# === Performance optimizations ===

# Ex√©cution parall√®le (plus rapide)
diff_parallel_execution = true

# Timeout court pour secondary
diff_timeout = 30s

# Checksums au lieu de comparaison ligne par ligne
diff_use_checksum = true

# Logging minimal
diff_log_verbose = false
diff_log_max_entry_size = 2KB

# === √âchantillonnage (optionnel) ===
# Comparer seulement X% des requ√™tes
diff_sampling_rate = 10  # 10% des requ√™tes
# Utile pour production √† tr√®s haute charge
```

**Benchmark overhead :**

```
Test environment:
- Workload: 1000 QPS
- Query complexity: Medium (joins, aggregations)

Sans Diff Router:
- Latency P50: 10ms
- Latency P95: 30ms
- Latency P99: 50ms

Avec Diff Router (diff_parallel_execution=true, diff_use_checksum=true):
- Latency P50: 11ms (+10%)
- Latency P95: 33ms (+10%)
- Latency P99: 55ms (+10%)

Overhead acceptable: ~10% latence additionnelle
```

---

## Troubleshooting

### Probl√®me 1 : Trop de faux positifs

**Sympt√¥mes :**

```
Logs diff remplis de diff√©rences non significatives:
- Float precision: 99.9999 vs 100.0001
- Timestamps: created_at differs by 1ms
- Order differences sur requ√™tes sans ORDER BY
```

**Solutions :**

```ini
# 1. Augmenter tol√©rance
diff_tolerance = 0.01  # Passer de 0.001 √† 0.01

# 2. √âlargir colonnes ignor√©es
diff_ignore_columns = created_at,updated_at,timestamp,last_modified,id

# 3. Ignorer ordre
diff_ignore_order = true

# 4. Ignorer AUTO_INCREMENT
diff_ignore_auto_increment = true

# 5. Augmenter seuil logging
diff_log_threshold = 10  # Log seulement si ‚â•10 diff√©rences
```

### Probl√®me 2 : Secondary backend timeout

**Sympt√¥mes :**

```json
{
  "secondary": {
    "error": "Timeout waiting for secondary response",
    "execution_time_ms": 60000
  }
}
```

**Solutions :**

```ini
# 1. Augmenter timeout
diff_timeout = 120s  # Doubler timeout

# 2. V√©rifier performance secondary
# Sur secondary backend:
SHOW GLOBAL STATUS LIKE 'Threads_running';
SHOW PROCESSLIST;

# 3. Warmup cache secondary
# Pr√©-charger donn√©es en cache:
SELECT * FROM table LIMIT 10000;

# 4. Si secondary constamment lent, ignorer erreurs
diff_on_secondary_error = ignore
```

### Probl√®me 3 : Overhead trop √©lev√©

**Sympt√¥mes :**

```
Production latency augment√©e significativement (>20%)
Comparison duration P95: 150ms
```

**Solutions :**

```ini
# 1. Activer checksums
diff_use_checksum = true

# 2. Ex√©cution parall√®le
diff_parallel_execution = true

# 3. R√©duire logging verbeux
diff_log_verbose = false
diff_log_max_entry_size = 1KB

# 4. √âchantillonnage
diff_sampling_rate = 50  # Comparer seulement 50% des requ√™tes

# 5. Filtrer types de requ√™tes
diff_query_types = SELECT  # Seulement SELECT (pas INSERT/UPDATE/DELETE)
```

### Probl√®me 4 : Logs gigantesques

**Sympt√¥mes :**

```bash
# Fichier de log prend 10GB/jour
ls -lh /var/log/maxscale/diff.log
-rw-r--r-- 1 maxscale maxscale 10G Dec 15 14:30 diff.log
```

**Solutions :**

```ini
# 1. Augmenter seuil
diff_log_threshold = 20  # Log seulement si ‚â•20 diff√©rences

# 2. Logging non verbeux
diff_log_verbose = false

# 3. Limiter taille entr√©es
diff_log_max_entry_size = 1KB

# 4. Rotation logs
# /etc/logrotate.d/maxscale-diff
/var/log/maxscale/diff.log {
    daily
    rotate 7
    compress
    delaycompress
    notifempty
    create 0644 maxscale maxscale
    postrotate
        systemctl reload maxscale
    endscript
}
```

---

## Int√©gration avec CI/CD

### Pipeline de validation automatique

**GitLab CI avec Diff Router :**

```yaml
# .gitlab-ci.yml
stages:
  - build
  - test
  - validate
  - deploy

# Stage validation avec Diff Router
diff_validation:
  stage: validate
  image: mariadb/maxscale:25.01
  
  services:
    - name: mariadb:11.8
      alias: baseline-db
    - name: mariadb:12.0
      alias: candidate-db
  
  before_script:
    # Setup databases
    - mysql -h baseline-db -u root -proot < schema.sql
    - mysql -h candidate-db -u root -proot < schema.sql
    
    # Configure MaxScale
    - |
      cat > /etc/maxscale.cnf << EOF
      [maxscale]
      threads=auto
      
      [baseline]
      type=server
      address=baseline-db
      port=3306
      
      [candidate]
      type=server
      address=candidate-db
      port=3306
      
      [diff-service]
      type=service
      router=diff
      primary_server=baseline
      secondary_server=candidate
      user=root
      password=root
      diff_mode=both
      diff_log_file=/tmp/diff.log
      diff_log_format=json
      
      [listener]
      type=listener
      service=diff-service
      port=3307
      EOF
    
    # Start MaxScale
    - maxscale -f /etc/maxscale.cnf &
    - sleep 10
  
  script:
    # Run test queries
    - mysql -h localhost -P 3307 -u root -proot test < test_queries.sql
    
    # Analyze diff results
    - |
      python3 << 'EOF'
      import json
      import sys
      
      differences = 0
      critical = 0
      
      with open('/tmp/diff.log') as f:
          for line in f:
              entry = json.loads(line)
              differences += 1
              if entry.get('summary', {}).get('impact') in ['HIGH', 'CRITICAL']:
                  critical += 1
      
      print(f"Total differences: {differences}")
      print(f"Critical differences: {critical}")
      
      if critical > 0:
          print("‚ùå VALIDATION FAILED - Critical differences detected")
          sys.exit(1)
      elif differences > 100:
          print("‚ö†Ô∏è  WARNING - Many differences detected")
          sys.exit(1)
      else:
          print("‚úÖ VALIDATION PASSED")
          sys.exit(0)
      EOF
  
  artifacts:
    paths:
      - /tmp/diff.log
    when: always
  
  allow_failure: false
```

---

## ‚úÖ Points cl√©s √† retenir

- **Diff Router** : Nouvelle fonctionnalit√© MaxScale 25.01 pour comparer automatiquement 2 backends en temps r√©el
- **Architecture** : Duplique chaque requ√™te vers primary (baseline) et secondary (candidate), compare r√©sultats
- **Transparence** : Client re√ßoit r√©sultat du primary, comparaison invisible pour application
- **Modes** : results (data), performance (temps), both (data+temps)
- **Tol√©rance** : diff_tolerance pour floats, diff_performance_tolerance pour temps, ignore patterns communs
- **Logging** : Format JSON d√©taill√©, seuil configurable, verbosit√© ajustable
- **Types diff√©rences** : R√©sultats (rows/values), performance (temps/plans), erreurs
- **Impact** : LOW (acceptable), MEDIUM (investiguer), HIGH/CRITICAL (blocker)
- **M√©triques** : Prometheus int√©gr√©, diff rate, erreurs secondary, overhead comparison
- **Optimisation** : Checksums, parall√©lisation, √©chantillonnage, filtrage pour minimiser overhead (~10%)
- **Use cases** : Validation upgrades, A/B testing configs/storage, d√©tection r√©gressions
- **Faux positifs** : Ignorer timestamps, AUTO_INCREMENT, order, augmenter tol√©rance

---

## üîó Ressources et r√©f√©rences

### Documentation officielle MaxScale
- [üÜï Diff Router](https://mariadb.com/docs/server/architecture/components/maxscale/diff-router/)
- [üìñ MaxScale 25.01 Release Notes](https://mariadb.com/docs/release-notes/maxscale/25-01/)
- [üìñ MaxScale Configuration Guide](https://mariadb.com/kb/en/mariadb-maxscale-25-mariadb-maxscale-configuration-guide/)

### Guides techniques
- [Database Testing Best Practices](https://mariadb.com/resources/blog/database-testing-best-practices/)
- [Upgrade Validation Strategies](https://www.percona.com/blog/upgrade-validation-strategies/)

### Outils
- [jq - JSON processor](https://stedolan.github.io/jq/)
- [Prometheus](https://prometheus.io/)
- [Grafana](https://grafana.com/)

---

## ‚û°Ô∏è Section suivante

**14.3 Split-brain et Quorum** : Comprendre et g√©rer le split-brain dans Galera Cluster, m√©canismes de quorum, r√©cup√©ration apr√®s partition r√©seau, strat√©gies de pr√©vention, et configurations production pour √©viter la perte de donn√©es.

---


‚è≠Ô∏è [Solutions de failover automatique](/14-haute-disponibilite/06-failover-automatique.md)
