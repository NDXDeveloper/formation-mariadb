ğŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 16.9.2 Dashboards Grafana - Visualisation avancÃ©e pour MariaDB

> **Niveau** : AvancÃ© Ã  Expert  
> **DurÃ©e estimÃ©e** : 4-5 heures  
> **PrÃ©requis** : Section 16.9.1 (mysqld_exporter), PromQL intermÃ©diaire, Grafana basics, Kubernetes

## ğŸ¯ Objectifs d'apprentissage

Ã€ l'issue de cette section, vous serez capable de :
- CrÃ©er des dashboards Grafana professionnels pour monitoring MariaDB
- Utiliser des requÃªtes PromQL optimisÃ©es pour visualisations avancÃ©es
- ImplÃ©menter des variables et templates pour multi-instances
- Configurer des alertes visuelles avec seuils dynamiques
- Provisionner des dashboards automatiquement via GitOps
- CrÃ©er des dashboards spÃ©cialisÃ©s (OLTP, rÃ©plication, InnoDB, etc.)
- Optimiser les performances des dashboards (query caching, interval)
- Importer et personnaliser des dashboards communautaires
- ImplÃ©menter des drill-downs et liens inter-dashboards
- CrÃ©er des dashboards responsive et accessibles

---

## Introduction

**Grafana** est la plateforme de visualisation et d'observabilitÃ© de rÃ©fÃ©rence pour les mÃ©triques Prometheus. Pour MariaDB, elle permet de crÃ©er des dashboards interactifs qui transforment les mÃ©triques brutes en insights actionnables.

### Pourquoi Grafana pour MariaDB ?

| Avantage | Description |
|----------|-------------|
| **Visualisation riche** | 15+ types de panels (Graph, Gauge, Table, Heatmap...) |
| **PromQL natif** | Support complet du langage de requÃªtes Prometheus |
| **Templating** | Variables pour dashboards multi-instances |
| **Alerting** | Alertes visuelles intÃ©grÃ©es |
| **Annotations** | CorrÃ©lation Ã©vÃ©nements (migrations, deployments) |
| **Partage** | Export JSON, snapshots, embed |
| **Provisioning** | GitOps avec ConfigMaps Kubernetes |
| **Plugins** | ExtensibilitÃ© (data sources, panels) |

### Architecture de visualisation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Grafana Visualization Stack                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Prometheus (Data Source)                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ Time-Series Database (TSDB)              â”‚               â”‚
â”‚  â”‚ - mysql_global_status_*                  â”‚               â”‚
â”‚  â”‚ - mysql_slave_status_*                   â”‚               â”‚
â”‚  â”‚ - mysql_info_schema_*                    â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                    â”‚ PromQL Query                           â”‚
â”‚                    â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚        Grafana Dashboard                 â”‚               â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚               â”‚
â”‚  â”‚  â”‚ Variables (Instance, DB, Table)    â”‚  â”‚               â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚               â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚               â”‚
â”‚  â”‚  â”‚ Row: Overview                      â”‚  â”‚               â”‚
â”‚  â”‚  â”‚  â”œâ”€ Panel: QPS (Graph)             â”‚  â”‚               â”‚
â”‚  â”‚  â”‚  â”œâ”€ Panel: Connections (Gauge)     â”‚  â”‚               â”‚
â”‚  â”‚  â”‚  â””â”€ Panel: Uptime (Stat)           â”‚  â”‚               â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚               â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚               â”‚
â”‚  â”‚  â”‚ Row: InnoDB Performance            â”‚  â”‚               â”‚
â”‚  â”‚  â”‚  â”œâ”€ Panel: Buffer Pool (Graph)     â”‚  â”‚               â”‚
â”‚  â”‚  â”‚  â”œâ”€ Panel: Row Operations (Graph)  â”‚  â”‚               â”‚
â”‚  â”‚  â”‚  â””â”€ Panel: Locks (Heatmap)         â”‚  â”‚               â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚               â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚               â”‚
â”‚  â”‚  â”‚ Row: Replication                   â”‚  â”‚               â”‚
â”‚  â”‚  â”‚  â”œâ”€ Panel: Lag (Graph + Alert)     â”‚  â”‚               â”‚
â”‚  â”‚  â”‚  â””â”€ Panel: Status (Table)          â”‚  â”‚               â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                    â”‚                                        â”‚
â”‚                    â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚        Alerting & Notifications          â”‚               â”‚
â”‚  â”‚  - Email, Slack, PagerDuty               â”‚               â”‚
â”‚  â”‚  - Visual thresholds                     â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Configuration initiale Grafana

### 1. Installation Grafana (Kubernetes)

**Helm Chart (recommandÃ©) :**
```bash
# Ajouter le repository Grafana
helm repo add grafana https://grafana.github.io/helm-charts
helm repo update

# Installer Grafana
helm install grafana grafana/grafana \
  --namespace monitoring \
  --create-namespace \
  --set persistence.enabled=true \
  --set persistence.size=10Gi \
  --set adminPassword=SecureGrafanaPassword123! \
  --set service.type=LoadBalancer \
  --set datasources."datasources\.yaml".apiVersion=1 \
  --set datasources."datasources\.yaml".datasources[0].name=Prometheus \
  --set datasources."datasources\.yaml".datasources[0].type=prometheus \
  --set datasources."datasources\.yaml".datasources[0].url=http://prometheus-server.monitoring.svc.cluster.local:9090 \
  --set datasources."datasources\.yaml".datasources[0].access=proxy \
  --set datasources."datasources\.yaml".datasources[0].isDefault=true
```

**Manifest Kubernetes :**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: monitoring
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      containers:
      - name: grafana
        image: grafana/grafana:10.2.3
        ports:
        - name: http
          containerPort: 3000
        env:
        - name: GF_SECURITY_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: grafana-admin
              key: password
        - name: GF_INSTALL_PLUGINS
          value: "grafana-piechart-panel,grafana-clock-panel"
        volumeMounts:
        - name: grafana-storage
          mountPath: /var/lib/grafana
        - name: grafana-datasources
          mountPath: /etc/grafana/provisioning/datasources
        - name: grafana-dashboards-provisioning
          mountPath: /etc/grafana/provisioning/dashboards
        - name: grafana-dashboards
          mountPath: /var/lib/grafana/dashboards
      volumes:
      - name: grafana-storage
        persistentVolumeClaim:
          claimName: grafana-pvc
      - name: grafana-datasources
        configMap:
          name: grafana-datasources
      - name: grafana-dashboards-provisioning
        configMap:
          name: grafana-dashboard-provider
      - name: grafana-dashboards
        configMap:
          name: grafana-mariadb-dashboards

---
apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: monitoring
spec:
  selector:
    app: grafana
  ports:
  - name: http
    port: 3000
    targetPort: 3000
  type: LoadBalancer
```

### 2. Configuration Data Source Prometheus

**ConfigMap pour datasource :**
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  namespace: monitoring
data:
  datasources.yaml: |
    apiVersion: 1
    datasources:
    - name: Prometheus
      type: prometheus
      access: proxy
      url: http://prometheus-server.monitoring.svc.cluster.local:9090
      isDefault: true
      editable: false
      jsonData:
        timeInterval: 30s
        queryTimeout: 60s
        httpMethod: POST
```

### 3. AccÃ¨s Ã  Grafana

```bash
# RÃ©cupÃ©rer le mot de passe admin
kubectl get secret grafana -n monitoring \
  -o jsonpath="{.data.admin-password}" | base64 --decode

# Port-forward pour accÃ¨s local
kubectl port-forward -n monitoring svc/grafana 3000:3000

# Ouvrir dans le navigateur
# http://localhost:3000
# User: admin
# Password: <rÃ©cupÃ©rÃ© ci-dessus>
```

---

## Dashboard MariaDB Overview (complet)

### Structure du dashboard

```json
{
  "dashboard": {
    "title": "MariaDB Overview",
    "tags": ["mariadb", "database", "mysql"],
    "timezone": "browser",
    "schemaVersion": 38,
    "version": 1,
    "refresh": "30s",
    
    "templating": {
      "list": [
        {
          "name": "datasource",
          "type": "datasource",
          "query": "prometheus",
          "current": {
            "text": "Prometheus",
            "value": "Prometheus"
          }
        },
        {
          "name": "instance",
          "type": "query",
          "datasource": "${datasource}",
          "query": "label_values(mysql_up, instance)",
          "refresh": 1,
          "multi": false,
          "includeAll": false,
          "current": {
            "text": "mariadb-primary",
            "value": "mariadb-primary"
          }
        },
        {
          "name": "interval",
          "type": "interval",
          "query": "30s,1m,5m,10m,30m,1h",
          "current": {
            "text": "1m",
            "value": "1m"
          }
        }
      ]
    },
    
    "panels": [
      {
        "id": 1,
        "gridPos": {
          "h": 4,
          "w": 6,
          "x": 0,
          "y": 0
        },
        "type": "stat",
        "title": "Instance Status",
        "targets": [
          {
            "expr": "mysql_up{instance=\"$instance\"}",
            "legendFormat": "Status"
          }
        ],
        "options": {
          "colorMode": "background",
          "graphMode": "none",
          "orientation": "auto",
          "textMode": "value_and_name",
          "reduceOptions": {
            "values": false,
            "calcs": ["lastNotNull"]
          }
        },
        "fieldConfig": {
          "defaults": {
            "mappings": [
              {
                "type": "value",
                "options": {
                  "0": {
                    "text": "DOWN",
                    "color": "red"
                  },
                  "1": {
                    "text": "UP",
                    "color": "green"
                  }
                }
              }
            ],
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {
                  "value": null,
                  "color": "red"
                },
                {
                  "value": 1,
                  "color": "green"
                }
              ]
            }
          }
        }
      },
      
      {
        "id": 2,
        "gridPos": {
          "h": 4,
          "w": 6,
          "x": 6,
          "y": 0
        },
        "type": "stat",
        "title": "Uptime",
        "targets": [
          {
            "expr": "mysql_global_status_uptime{instance=\"$instance\"}",
            "legendFormat": "Uptime"
          }
        ],
        "options": {
          "colorMode": "value",
          "graphMode": "area",
          "textMode": "auto",
          "reduceOptions": {
            "values": false,
            "calcs": ["lastNotNull"]
          }
        },
        "fieldConfig": {
          "defaults": {
            "unit": "s"
          }
        }
      },
      
      {
        "id": 3,
        "gridPos": {
          "h": 4,
          "w": 6,
          "x": 12,
          "y": 0
        },
        "type": "gauge",
        "title": "Connections Usage",
        "targets": [
          {
            "expr": "(mysql_global_status_threads_connected{instance=\"$instance\"} / mysql_global_variables_max_connections{instance=\"$instance\"}) * 100",
            "legendFormat": "Usage %"
          }
        ],
        "options": {
          "orientation": "auto",
          "showThresholdLabels": false,
          "showThresholdMarkers": true
        },
        "fieldConfig": {
          "defaults": {
            "unit": "percent",
            "min": 0,
            "max": 100,
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {
                  "value": null,
                  "color": "green"
                },
                {
                  "value": 70,
                  "color": "yellow"
                },
                {
                  "value": 90,
                  "color": "red"
                }
              ]
            }
          }
        }
      },
      
      {
        "id": 4,
        "gridPos": {
          "h": 4,
          "w": 6,
          "x": 18,
          "y": 0
        },
        "type": "stat",
        "title": "QPS (Queries Per Second)",
        "targets": [
          {
            "expr": "rate(mysql_global_status_queries{instance=\"$instance\"}[$interval])",
            "legendFormat": "QPS"
          }
        ],
        "options": {
          "colorMode": "value",
          "graphMode": "area",
          "textMode": "auto"
        },
        "fieldConfig": {
          "defaults": {
            "unit": "qps",
            "decimals": 1
          }
        }
      },
      
      {
        "id": 5,
        "gridPos": {
          "h": 8,
          "w": 12,
          "x": 0,
          "y": 4
        },
        "type": "timeseries",
        "title": "Query Rate by Type",
        "targets": [
          {
            "expr": "rate(mysql_global_status_com_select{instance=\"$instance\"}[$interval])",
            "legendFormat": "SELECT"
          },
          {
            "expr": "rate(mysql_global_status_com_insert{instance=\"$instance\"}[$interval])",
            "legendFormat": "INSERT"
          },
          {
            "expr": "rate(mysql_global_status_com_update{instance=\"$instance\"}[$interval])",
            "legendFormat": "UPDATE"
          },
          {
            "expr": "rate(mysql_global_status_com_delete{instance=\"$instance\"}[$interval])",
            "legendFormat": "DELETE"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "custom": {
              "drawStyle": "line",
              "lineInterpolation": "smooth",
              "fillOpacity": 10,
              "showPoints": "never",
              "stacking": {
                "mode": "normal"
              }
            },
            "unit": "qps"
          }
        },
        "options": {
          "legend": {
            "displayMode": "list",
            "placement": "bottom",
            "calcs": ["mean", "max"]
          },
          "tooltip": {
            "mode": "multi"
          }
        }
      },
      
      {
        "id": 6,
        "gridPos": {
          "h": 8,
          "w": 12,
          "x": 12,
          "y": 4
        },
        "type": "timeseries",
        "title": "Connections & Threads",
        "targets": [
          {
            "expr": "mysql_global_status_threads_connected{instance=\"$instance\"}",
            "legendFormat": "Threads Connected"
          },
          {
            "expr": "mysql_global_status_threads_running{instance=\"$instance\"}",
            "legendFormat": "Threads Running"
          },
          {
            "expr": "mysql_global_variables_max_connections{instance=\"$instance\"}",
            "legendFormat": "Max Connections"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "custom": {
              "drawStyle": "line",
              "lineInterpolation": "smooth",
              "fillOpacity": 0
            },
            "unit": "short"
          },
          "overrides": [
            {
              "matcher": {
                "id": "byName",
                "options": "Max Connections"
              },
              "properties": [
                {
                  "id": "custom.lineStyle",
                  "value": {
                    "dash": [10, 10],
                    "fill": "dash"
                  }
                },
                {
                  "id": "color",
                  "value": {
                    "mode": "fixed",
                    "fixedColor": "red"
                  }
                }
              ]
            }
          ]
        }
      },
      
      {
        "id": 7,
        "gridPos": {
          "h": 8,
          "w": 12,
          "x": 0,
          "y": 12
        },
        "type": "timeseries",
        "title": "InnoDB Buffer Pool Hit Ratio",
        "targets": [
          {
            "expr": "((mysql_global_status_innodb_buffer_pool_read_requests{instance=\"$instance\"} - mysql_global_status_innodb_buffer_pool_reads{instance=\"$instance\"}) / mysql_global_status_innodb_buffer_pool_read_requests{instance=\"$instance\"}) * 100",
            "legendFormat": "Hit Ratio %"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "custom": {
              "drawStyle": "line",
              "fillOpacity": 20
            },
            "unit": "percent",
            "min": 90,
            "max": 100,
            "thresholds": {
              "mode": "absolute",
              "steps": [
                {
                  "value": null,
                  "color": "red"
                },
                {
                  "value": 95,
                  "color": "yellow"
                },
                {
                  "value": 99,
                  "color": "green"
                }
              ]
            }
          }
        },
        "options": {
          "legend": {
            "displayMode": "list",
            "placement": "bottom"
          }
        }
      },
      
      {
        "id": 8,
        "gridPos": {
          "h": 8,
          "w": 12,
          "x": 12,
          "y": 12
        },
        "type": "timeseries",
        "title": "InnoDB Row Operations",
        "targets": [
          {
            "expr": "rate(mysql_global_status_innodb_rows_read{instance=\"$instance\"}[$interval])",
            "legendFormat": "Rows Read"
          },
          {
            "expr": "rate(mysql_global_status_innodb_rows_inserted{instance=\"$instance\"}[$interval])",
            "legendFormat": "Rows Inserted"
          },
          {
            "expr": "rate(mysql_global_status_innodb_rows_updated{instance=\"$instance\"}[$interval])",
            "legendFormat": "Rows Updated"
          },
          {
            "expr": "rate(mysql_global_status_innodb_rows_deleted{instance=\"$instance\"}[$interval])",
            "legendFormat": "Rows Deleted"
          }
        ],
        "fieldConfig": {
          "defaults": {
            "custom": {
              "drawStyle": "line",
              "lineInterpolation": "smooth",
              "fillOpacity": 10
            },
            "unit": "ops"
          }
        }
      }
    ]
  }
}
```

Ce JSON peut Ãªtre importÃ© directement dans Grafana via **Dashboard â†’ Import â†’ Paste JSON**.

---

## Panels avancÃ©s par cas d'usage

### 1. Panel Replication Lag avec alerte visuelle

```json
{
  "id": 10,
  "gridPos": {
    "h": 6,
    "w": 12,
    "x": 0,
    "y": 20
  },
  "type": "timeseries",
  "title": "Replication Lag (Seconds Behind Master)",
  "targets": [
    {
      "expr": "mysql_slave_status_seconds_behind_master{instance=~\"$instance\"}",
      "legendFormat": "{{instance}}"
    }
  ],
  "fieldConfig": {
    "defaults": {
      "custom": {
        "drawStyle": "line",
        "lineWidth": 2,
        "fillOpacity": 30,
        "gradientMode": "opacity"
      },
      "unit": "s",
      "thresholds": {
        "mode": "absolute",
        "steps": [
          {
            "value": null,
            "color": "green"
          },
          {
            "value": 10,
            "color": "yellow"
          },
          {
            "value": 60,
            "color": "red"
          }
        ]
      }
    }
  },
  "options": {
    "legend": {
      "displayMode": "table",
      "placement": "right",
      "calcs": ["last", "mean", "max"]
    },
    "tooltip": {
      "mode": "multi"
    }
  },
  "alert": {
    "name": "Replication Lag Alert",
    "conditions": [
      {
        "evaluator": {
          "params": [60],
          "type": "gt"
        },
        "operator": {
          "type": "and"
        },
        "query": {
          "params": ["A", "5m", "now"]
        },
        "reducer": {
          "params": [],
          "type": "avg"
        },
        "type": "query"
      }
    ],
    "executionErrorState": "alerting",
    "for": "5m",
    "frequency": "1m",
    "message": "Replication lag is above 60 seconds on {{instance}}",
    "noDataState": "no_data",
    "notifications": [
      {
        "uid": "slack-notification-channel"
      }
    ]
  }
}
```

### 2. Panel Table Top Slow Queries

```json
{
  "id": 11,
  "type": "table",
  "title": "Top Slow Queries (Last Hour)",
  "targets": [
    {
      "expr": "topk(10, rate(mysql_global_status_slow_queries{instance=\"$instance\"}[1h]))",
      "format": "table",
      "instant": true
    }
  ],
  "fieldConfig": {
    "defaults": {
      "custom": {
        "align": "auto",
        "displayMode": "auto"
      }
    },
    "overrides": [
      {
        "matcher": {
          "id": "byName",
          "options": "Value"
        },
        "properties": [
          {
            "id": "displayName",
            "value": "Slow Queries/sec"
          },
          {
            "id": "unit",
            "value": "qps"
          },
          {
            "id": "decimals",
            "value": 3
          },
          {
            "id": "custom.displayMode",
            "value": "color-background"
          },
          {
            "id": "thresholds",
            "value": {
              "mode": "absolute",
              "steps": [
                {
                  "value": null,
                  "color": "green"
                },
                {
                  "value": 0.1,
                  "color": "yellow"
                },
                {
                  "value": 1,
                  "color": "red"
                }
              ]
            }
          }
        ]
      }
    ]
  },
  "options": {
    "showHeader": true,
    "sortBy": [
      {
        "displayName": "Slow Queries/sec",
        "desc": true
      }
    ]
  }
}
```

### 3. Panel Heatmap InnoDB Row Lock Waits

```json
{
  "id": 12,
  "type": "heatmap",
  "title": "InnoDB Row Lock Wait Time (Heatmap)",
  "targets": [
    {
      "expr": "rate(mysql_global_status_innodb_row_lock_time{instance=\"$instance\"}[$interval])",
      "legendFormat": "Lock Time",
      "format": "time_series"
    }
  ],
  "fieldConfig": {
    "defaults": {
      "custom": {}
    }
  },
  "options": {
    "calculate": true,
    "calculation": {
      "xBuckets": {
        "mode": "size",
        "value": "1min"
      }
    },
    "cellGap": 2,
    "color": {
      "exponent": 0.5,
      "fill": "dark-orange",
      "mode": "scheme",
      "reverse": false,
      "scale": "exponential",
      "scheme": "Spectral",
      "steps": 128
    },
    "exemplars": {
      "color": "rgba(255,0,255,0.7)"
    },
    "filterValues": {
      "le": 1e-9
    },
    "legend": {
      "show": true
    },
    "rowsFrame": {
      "layout": "auto"
    },
    "tooltip": {
      "show": true,
      "yHistogram": false
    },
    "yAxis": {
      "axisPlacement": "left",
      "reverse": false,
      "unit": "ms"
    }
  }
}
```

### 4. Panel Gauge Buffer Pool Utilization

```json
{
  "id": 13,
  "type": "gauge",
  "title": "InnoDB Buffer Pool Utilization",
  "targets": [
    {
      "expr": "((mysql_global_status_innodb_buffer_pool_pages_total{instance=\"$instance\"} - mysql_global_status_innodb_buffer_pool_pages_free{instance=\"$instance\"}) / mysql_global_status_innodb_buffer_pool_pages_total{instance=\"$instance\"}) * 100",
      "legendFormat": "Utilization %"
    }
  ],
  "options": {
    "orientation": "auto",
    "reduceOptions": {
      "values": false,
      "calcs": ["lastNotNull"],
      "fields": ""
    },
    "showThresholdLabels": true,
    "showThresholdMarkers": true,
    "text": {}
  },
  "fieldConfig": {
    "defaults": {
      "mappings": [],
      "thresholds": {
        "mode": "absolute",
        "steps": [
          {
            "value": null,
            "color": "green"
          },
          {
            "value": 80,
            "color": "yellow"
          },
          {
            "value": 95,
            "color": "red"
          }
        ]
      },
      "unit": "percent",
      "min": 0,
      "max": 100
    }
  }
}
```

---

## Variables et templating avancÃ©s

### 1. Variable instance avec regex

```json
{
  "name": "instance",
  "type": "query",
  "datasource": "${datasource}",
  "query": "label_values(mysql_up, instance)",
  "regex": "/mariadb-(primary|replica-[0-9]+)/",
  "refresh": 2,
  "multi": true,
  "includeAll": true,
  "allValue": ".*",
  "sort": 1
}
```

### 2. Variable database avec filtre

```json
{
  "name": "database",
  "type": "query",
  "datasource": "${datasource}",
  "query": "label_values(mysql_info_schema_table_size{instance=\"$instance\"}, schema)",
  "regex": "/^(?!information_schema|performance_schema|mysql|sys).*/",
  "refresh": 1,
  "multi": false,
  "includeAll": false
}
```

### 3. Variable table dynamique

```json
{
  "name": "table",
  "type": "query",
  "datasource": "${datasource}",
  "query": "label_values(mysql_info_schema_table_size{instance=\"$instance\", schema=\"$database\"}, table)",
  "refresh": 1,
  "multi": false,
  "includeAll": false,
  "sort": 1
}
```

### 4. Variable interval auto

```json
{
  "name": "interval",
  "type": "interval",
  "query": "auto,30s,1m,5m,10m,30m,1h,6h,12h,1d,7d,14d,30d",
  "auto": true,
  "auto_count": 30,
  "auto_min": "10s",
  "current": {
    "text": "auto",
    "value": "$__auto_interval_interval"
  }
}
```

### 5. Variable personnalisÃ©e pour seuils

```json
{
  "name": "connection_threshold",
  "type": "custom",
  "query": "50,70,80,90,95",
  "current": {
    "text": "80",
    "value": "80"
  },
  "label": "Connection Threshold (%)"
}
```

---

## Provisioning automatique des dashboards

### 1. ConfigMap provider

**grafana-dashboard-provider.yaml :**
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-provider
  namespace: monitoring
data:
  dashboards.yaml: |
    apiVersion: 1
    providers:
    - name: 'MariaDB Dashboards'
      orgId: 1
      folder: 'MariaDB'
      type: file
      disableDeletion: false
      editable: true
      updateIntervalSeconds: 10
      allowUiUpdates: true
      options:
        path: /var/lib/grafana/dashboards
```

### 2. ConfigMap dashboards

**grafana-mariadb-dashboards.yaml :**
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-mariadb-dashboards
  namespace: monitoring
  labels:
    grafana_dashboard: "1"
data:
  mariadb-overview.json: |
    {
      "dashboard": {
        "title": "MariaDB Overview",
        "uid": "mariadb-overview",
        ...
      }
    }
  
  mariadb-replication.json: |
    {
      "dashboard": {
        "title": "MariaDB Replication",
        "uid": "mariadb-replication",
        ...
      }
    }
  
  mariadb-innodb.json: |
    {
      "dashboard": {
        "title": "MariaDB InnoDB Performance",
        "uid": "mariadb-innodb",
        ...
      }
    }
```

### 3. GitOps workflow

**Structure repository Git :**
```
grafana-dashboards/
â”œâ”€â”€ kustomization.yaml
â”œâ”€â”€ configmaps/
â”‚   â”œâ”€â”€ provider.yaml
â”‚   â””â”€â”€ dashboards/
â”‚       â”œâ”€â”€ mariadb-overview.yaml
â”‚       â”œâ”€â”€ mariadb-replication.yaml
â”‚       â””â”€â”€ mariadb-innodb.yaml
â””â”€â”€ deployment/
    â””â”€â”€ grafana.yaml
```

**Kustomization.yaml :**
```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: monitoring

resources:
- configmaps/provider.yaml
- configmaps/dashboards/mariadb-overview.yaml
- configmaps/dashboards/mariadb-replication.yaml
- configmaps/dashboards/mariadb-innodb.yaml

configMapGenerator:
- name: grafana-mariadb-dashboards
  files:
  - mariadb-overview.json=dashboards/mariadb-overview.json
  - mariadb-replication.json=dashboards/mariadb-replication.json
  - mariadb-innodb.json=dashboards/mariadb-innodb.json
  options:
    labels:
      grafana_dashboard: "1"
```

**Application avec ArgoCD :**
```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: grafana-dashboards
  namespace: argocd
spec:
  project: default
  source:
    repoURL: https://github.com/mycompany/grafana-dashboards.git
    targetRevision: main
    path: ./
  destination:
    server: https://kubernetes.default.svc
    namespace: monitoring
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
    - CreateNamespace=true
```

---

## Dashboards spÃ©cialisÃ©s

### 1. Dashboard OLTP Performance

**Panels clÃ©s :**
- QPS en temps rÃ©el
- Latence moyenne des requÃªtes
- Transactions per second (TPS)
- Lock wait time
- Threads running vs connected
- Buffer pool hit ratio

**RequÃªtes PromQL spÃ©cifiques :**
```promql
# TPS (Transactions Per Second)
rate(mysql_global_status_com_commit[$interval]) + 
rate(mysql_global_status_com_rollback[$interval])

# Average query latency (ms)
rate(mysql_global_status_questions[$interval]) / 
rate(mysql_global_status_queries[$interval]) * 1000

# Lock contention rate
rate(mysql_global_status_table_locks_waited[$interval])

# Thread cache efficiency
(mysql_global_status_threads_created / mysql_global_status_connections) * 100
```

### 2. Dashboard Replication Monitoring

**Panels clÃ©s :**
- Replication lag (avec alerte)
- IO thread status
- SQL thread status
- Master binlog position
- Replica position gap
- Replication errors

**RequÃªtes PromQL :**
```promql
# Replication lag
mysql_slave_status_seconds_behind_master

# IO/SQL thread status (1 = running, 0 = stopped)
mysql_slave_status_slave_io_running
mysql_slave_status_slave_sql_running

# Position gap (bytes behind)
mysql_slave_status_read_master_log_pos - mysql_slave_status_exec_master_log_pos

# Replication throughput (events/sec)
rate(mysql_slave_status_exec_master_log_pos[$interval])

# Last error
mysql_slave_status_last_errno != 0
```

### 3. Dashboard InnoDB Deep Dive

**Panels clÃ©s :**
- Buffer Pool statistics (read/write requests, pages)
- Redo log usage
- Dirty pages ratio
- Row lock statistics
- Deadlocks
- Checkpoint age

**RequÃªtes PromQL :**
```promql
# Dirty pages ratio
(mysql_global_status_innodb_buffer_pool_pages_dirty / 
 mysql_global_status_innodb_buffer_pool_pages_total) * 100

# Redo log usage %
(mysql_global_status_innodb_lsn_current - 
 mysql_global_status_innodb_lsn_flushed) / 
mysql_global_variables_innodb_log_file_size * 100

# Deadlocks rate
rate(mysql_global_status_innodb_deadlocks[$interval])

# Checkpoint age (MB)
(mysql_global_status_innodb_lsn_current - 
 mysql_global_status_innodb_lsn_last_checkpoint) / 1024 / 1024
```

### 4. Dashboard Tables & Schema

**Panels clÃ©s :**
- Top 10 tables par taille
- Tables les plus fragmentÃ©es
- Table growth rate
- Index usage statistics

**RequÃªtes PromQL :**
```promql
# Top 10 tables par taille
topk(10, 
  mysql_info_schema_table_size{schema="$database"}
)

# Fragmentation (Data_free > 100MB)
mysql_info_schema_table_size_data_free{schema="$database"} > 104857600

# Table growth rate (bytes/hour)
rate(mysql_info_schema_table_size{schema="$database", table="$table"}[1h]) * 3600

# Index efficiency (rows read vs rows examined)
rate(mysql_global_status_handler_read_rnd_next[$interval]) / 
rate(mysql_global_status_handler_read_key[$interval])
```

---

## Annotations et corrÃ©lation d'Ã©vÃ©nements

### 1. Annotations pour dÃ©ploiements

**API Grafana pour crÃ©er annotation :**
```bash
#!/bin/bash
# CrÃ©er une annotation aprÃ¨s un dÃ©ploiement

GRAFANA_URL="http://grafana.monitoring.svc.cluster.local:3000"
GRAFANA_API_KEY="eyJrIjoiXXXXX..."

curl -X POST "${GRAFANA_URL}/api/annotations" \
  -H "Authorization: Bearer ${GRAFANA_API_KEY}" \
  -H "Content-Type: application/json" \
  -d '{
    "dashboardUID": "mariadb-overview",
    "time": '$(date +%s000)',
    "tags": ["deployment", "production"],
    "text": "Deployed application v2.1.0"
  }'
```

### 2. Annotations pour migrations

**Script CI/CD :**
```yaml
# .gitlab-ci.yml
migrate-production:
  script:
    - gh-ost --execute ...
    
    # Annotation dÃ©but migration
    - |
      curl -X POST "${GRAFANA_URL}/api/annotations" \
        -H "Authorization: Bearer ${GRAFANA_API_KEY}" \
        -H "Content-Type: application/json" \
        -d '{
          "time": '$(date +%s000)',
          "timeEnd": '$(date +%s000)',
          "tags": ["migration", "gh-ost"],
          "text": "Started gh-ost migration: ${TABLE_NAME}"
        }'
    
    # Annotation fin migration
    - |
      curl -X POST "${GRAFANA_URL}/api/annotations" \
        -H "Authorization: Bearer ${GRAFANA_API_KEY}" \
        -H "Content-Type: application/json" \
        -d '{
          "time": '$(date +%s000)',
          "tags": ["migration", "gh-ost", "completed"],
          "text": "Completed gh-ost migration: ${TABLE_NAME}"
        }'
```

### 3. Annotations via Prometheus Alertmanager

**Configuration Alertmanager webhook :**
```yaml
# alertmanager.yml
route:
  receiver: 'grafana-annotations'
  group_by: ['alertname']

receivers:
- name: 'grafana-annotations'
  webhook_configs:
  - url: 'http://grafana:3000/api/annotations'
    send_resolved: true
    http_config:
      bearer_token: 'eyJrIjoiXXXXX...'
```

---

## Optimisation des performances des dashboards

### 1. Query caching

**Enable query caching dans datasource :**
```yaml
datasources:
- name: Prometheus
  type: prometheus
  url: http://prometheus:9090
  jsonData:
    timeInterval: 30s
    queryTimeout: 60s
    httpMethod: POST
    # Enable caching
    cacheLevel: 'Low'  # Low, Medium, High
```

### 2. Interval optimization

**Utiliser des intervalles adaptÃ©s :**
```promql
# Bon : utilise la variable $interval
rate(mysql_global_status_queries[$interval])

# Mauvais : interval fixe trop petit
rate(mysql_global_status_queries[10s])

# Optimal : interval auto-adaptatif
rate(mysql_global_status_queries[$__auto_interval])
```

### 3. Limiter le nombre de sÃ©ries temporelles

```promql
# Bon : filtre sur instance spÃ©cifique
mysql_global_status_queries{instance="$instance"}

# Mauvais : rÃ©cupÃ¨re toutes les instances
mysql_global_status_queries

# Optimal : topk pour limiter
topk(10, mysql_info_schema_table_size)
```

### 4. Utiliser le format table pour mÃ©triques instantanÃ©es

```json
{
  "targets": [
    {
      "expr": "mysql_global_status_uptime{instance=\"$instance\"}",
      "format": "table",
      "instant": true  // RÃ©cupÃ¨re seulement la derniÃ¨re valeur
    }
  ]
}
```

### 5. Panel caching

```json
{
  "cacheTimeout": 300,  // Cache pendant 5 minutes
  "interval": "1m",     // Interval minimum
  "maxDataPoints": 100  // Limiter le nombre de points
}
```

---

## Alerting visuel avancÃ©

### 1. Threshold colors dynamiques

```json
{
  "fieldConfig": {
    "defaults": {
      "thresholds": {
        "mode": "percentage",
        "steps": [
          {
            "value": null,
            "color": "green"
          },
          {
            "value": "$connection_threshold",  // Variable
            "color": "yellow"
          },
          {
            "value": 95,
            "color": "red"
          }
        ]
      }
    }
  }
}
```

### 2. Alert state mapping

```json
{
  "fieldConfig": {
    "defaults": {
      "mappings": [
        {
          "type": "value",
          "options": {
            "0": {
              "text": "OK",
              "color": "green",
              "index": 0
            },
            "1": {
              "text": "WARNING",
              "color": "yellow",
              "index": 1
            },
            "2": {
              "text": "CRITICAL",
              "color": "red",
              "index": 2
            }
          }
        }
      ]
    }
  }
}
```

### 3. Alert rules dans dashboard

```json
{
  "alert": {
    "name": "High Connection Usage",
    "conditions": [
      {
        "evaluator": {
          "params": [80],
          "type": "gt"
        },
        "operator": {
          "type": "and"
        },
        "query": {
          "params": ["A", "5m", "now"]
        },
        "reducer": {
          "params": [],
          "type": "avg"
        },
        "type": "query"
      }
    ],
    "executionErrorState": "alerting",
    "for": "5m",
    "frequency": "1m",
    "handler": 1,
    "message": "Connection usage is above 80% on {{instance}}",
    "name": "High Connection Usage Alert",
    "noDataState": "no_data",
    "notifications": [
      {
        "uid": "slack-notifications"
      },
      {
        "uid": "pagerduty-critical"
      }
    ]
  }
}
```

---

## Drill-down et liens inter-dashboards

### 1. Liens de navigation

```json
{
  "links": [
    {
      "title": "MariaDB Replication Dashboard",
      "type": "dashboard",
      "url": "/d/mariadb-replication",
      "targetBlank": false,
      "keepTime": true,
      "includeVars": true
    },
    {
      "title": "MariaDB InnoDB Dashboard",
      "type": "dashboard",
      "url": "/d/mariadb-innodb",
      "targetBlank": false,
      "keepTime": true,
      "includeVars": true
    },
    {
      "title": "Prometheus",
      "type": "link",
      "url": "http://prometheus:9090/graph?g0.expr=mysql_up",
      "targetBlank": true
    }
  ]
}
```

### 2. Data links sur panels

```json
{
  "fieldConfig": {
    "defaults": {
      "links": [
        {
          "title": "View Table Details",
          "url": "/d/mariadb-tables?var-database=${__field.labels.schema}&var-table=${__field.labels.table}",
          "targetBlank": false
        },
        {
          "title": "View in Prometheus",
          "url": "http://prometheus:9090/graph?g0.expr=${__field.name}",
          "targetBlank": true
        }
      ]
    }
  }
}
```

---

## Dashboards communautaires

### 1. Importer un dashboard depuis Grafana.com

**Via UI :**
1. Dashboard â†’ Import â†’ Grafana.com Dashboard ID
2. Entrer l'ID (ex: **7362** pour MySQL Overview)
3. SÃ©lectionner la datasource Prometheus
4. Import

**Via API :**
```bash
GRAFANA_URL="http://grafana:3000"
API_KEY="eyJrIjoiXXXXX..."
DASHBOARD_ID="7362"

curl -X POST "${GRAFANA_URL}/api/dashboards/import" \
  -H "Authorization: Bearer ${API_KEY}" \
  -H "Content-Type: application/json" \
  -d '{
    "dashboard": {
      "id": null,
      "uid": null
    },
    "folderId": 0,
    "inputs": [
      {
        "name": "DS_PROMETHEUS",
        "type": "datasource",
        "pluginId": "prometheus",
        "value": "Prometheus"
      }
    ],
    "overwrite": true,
    "gnetId": '${DASHBOARD_ID}'
  }'
```

### 2. Dashboards recommandÃ©s

| ID | Nom | Description |
|----|-----|-------------|
| **7362** | MySQL Overview | Dashboard complet MySQL/MariaDB |
| **7371** | MySQL InnoDB Metrics | Focus sur InnoDB |
| **6239** | MySQL Exporter Quickstart | Dashboard de dÃ©marrage |
| **11323** | MySQL Replication | Monitoring rÃ©plication dÃ©taillÃ© |

---

## Best practices

### 1. **Organisation en folders**

```
Grafana/
â”œâ”€â”€ General/
â”œâ”€â”€ MariaDB/
â”‚   â”œâ”€â”€ Overview
â”‚   â”œâ”€â”€ Replication
â”‚   â”œâ”€â”€ InnoDB Performance
â”‚   â”œâ”€â”€ Tables & Schema
â”‚   â””â”€â”€ Slow Queries
â”œâ”€â”€ Kubernetes/
â””â”€â”€ Applications/
```

### 2. **Naming conventions**

```
âœ… mariadb-overview
âœ… mariadb-replication-monitoring
âœ… mariadb-innodb-deep-dive

âŒ dashboard-1
âŒ test-dashboard
âŒ DB metrics
```

### 3. **Permissions et partage**

```yaml
# Dashboard permissions
- role: "Viewer"
  permission: "View"
- role: "Editor"
  permission: "Edit"
- role: "Admin"
  permission: "Admin"
```

### 4. **Versioning des dashboards**

```bash
# Export dashboard
grafana-cli dashboard export --dashboard-uid mariadb-overview > mariadb-overview-v1.json

# Commit dans Git
git add dashboards/mariadb-overview-v1.json
git commit -m "feat: Add MariaDB Overview dashboard v1"
git push
```

### 5. **Documentation inline**

```json
{
  "panels": [
    {
      "title": "Buffer Pool Hit Ratio",
      "description": "Percentage of reads served from buffer pool vs disk. Should be > 99% in production. Lower values indicate insufficient buffer pool size or cold cache.",
      ...
    }
  ]
}
```

---

## âœ… Points clÃ©s Ã  retenir

- **Templating** : Variables pour dashboards multi-instances ($instance, $database, $table)
- **Panels spÃ©cialisÃ©s** : Timeseries, Gauge, Table, Heatmap selon le type de donnÃ©e
- **PromQL optimisÃ©** : Utiliser $interval, topk(), rate() pour performances
- **Provisioning** : ConfigMaps Kubernetes pour GitOps et versioning
- **Alerting visuel** : Thresholds, colors, alert rules intÃ©grÃ©s
- **Drill-down** : Links inter-dashboards pour navigation fluide
- **Annotations** : CorrÃ©lation Ã©vÃ©nements (deployments, migrations)
- **Query caching** : Optimiser les performances avec cache et intervals
- **Dashboards communautaires** : Partir de templates existants (ID 7362, 7371)
- **Best practices** : Organisation folders, naming, versioning Git

---

## ğŸ”— Ressources et rÃ©fÃ©rences

### Documentation officielle
- **[Grafana Documentation](https://grafana.com/docs/grafana/latest/)** - Documentation complÃ¨te
- **[Panel Types](https://grafana.com/docs/grafana/latest/panels-visualizations/)** - Types de panels
- **[Templating](https://grafana.com/docs/grafana/latest/dashboards/variables/)** - Variables et templates

### Dashboards communautaires
- **[Grafana Dashboards](https://grafana.com/grafana/dashboards/)** - Catalogue officiel
- **[MySQL Overview 7362](https://grafana.com/grafana/dashboards/7362)** - Dashboard complet
- **[MySQL InnoDB 7371](https://grafana.com/grafana/dashboards/7371)** - Focus InnoDB

### Outils
- **[grafana-dashboard-exporter](https://github.com/Nexinto/grafana-dashboard-exporter)** - Export/import automatisÃ©
- **[grafonnet](https://github.com/grafana/grafonnet-lib)** - Dashboards as code (Jsonnet)

---

## â¡ï¸ Section suivante

**16.10 ObservabilitÃ©** : Logs, mÃ©triques, traces avec la stack ELK/Loki, corrÃ©lation d'Ã©vÃ©nements, distributed tracing pour MariaDB, et stratÃ©gies d'observabilitÃ© complÃ¨tes.

â­ï¸ [ObservabilitÃ© : Logs, Metrics, Traces](/16-devops-automatisation/10-observabilite.md)
