üîù Retour au [Sommaire](/SOMMAIRE.md)

# 16.2.2 Terraform : Providers cloud

> **Niveau** : Avanc√© √† Expert  
> **Dur√©e estim√©e** : 4-5 heures  
> **Pr√©requis** : Terraform basics, Cloud providers (AWS/Azure/GCP), Networking, MariaDB architecture

## üéØ Objectifs d'apprentissage

√Ä l'issue de cette section, vous serez capable de :
- Provisionner des instances MariaDB 11.8 LTS sur AWS, Azure et GCP avec Terraform
- Cr√©er des modules Terraform r√©utilisables pour MariaDB
- G√©rer l'√©tat distant (remote state) avec S3, Azure Blob, GCS
- Impl√©menter des architectures hautement disponibles multi-cloud
- Appliquer les meilleures pratiques IaC pour les bases de donn√©es en production
- Utiliser Terraform pour g√©rer le cycle de vie complet de l'infrastructure MariaDB

---

## Introduction

Terraform est l'outil de r√©f√©rence pour l'Infrastructure as Code (IaC) multi-cloud. D√©velopp√© par HashiCorp, il permet de **d√©crire, provisionner et g√©rer** l'infrastructure de mani√®re d√©clarative avec le langage HCL (HashiCorp Configuration Language).

### Pourquoi Terraform pour MariaDB ?

**Avantages cl√©s** :
- ‚úÖ **Multi-cloud** : Un seul langage pour AWS, Azure, GCP, et +100 providers
- ‚úÖ **D√©claratif** : Description de l'√©tat souhait√©, Terraform calcule les changements
- ‚úÖ **State management** : Suivi de l'infrastructure r√©elle vs d√©clar√©e
- ‚úÖ **Plan/Apply** : Pr√©visualisation avant modification (`terraform plan`)
- ‚úÖ **Modules** : R√©utilisation et standardisation
- ‚úÖ **Immutabilit√©** : Remplacement plut√¥t que modification (best practice cloud)
- ‚úÖ **Versionnable** : Infrastructure versionn√©e dans Git

**Cas d'usage MariaDB** :
- Provisioning d'instances RDS/Azure Database/Cloud SQL
- D√©ploiement de clusters Galera sur EC2/VMs
- Configuration r√©seau (VPC, Security Groups, Private Link)
- Gestion des snapshots et backups
- Multi-r√©gion et disaster recovery
- Environnements √©ph√©m√®res (dev/staging)

---

## Architecture d'un projet Terraform MariaDB

### Structure recommand√©e

```
terraform-mariadb/
‚îú‚îÄ‚îÄ environments/
‚îÇ   ‚îú‚îÄ‚îÄ production/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.tf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ variables.tf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ outputs.tf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ backend.tf
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ terraform.tfvars
‚îÇ   ‚îú‚îÄ‚îÄ staging/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îî‚îÄ‚îÄ development/
‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îú‚îÄ‚îÄ mariadb-aws/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.tf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ variables.tf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ outputs.tf
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ README.md
‚îÇ   ‚îú‚îÄ‚îÄ mariadb-azure/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îú‚îÄ‚îÄ mariadb-gcp/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îú‚îÄ‚îÄ networking/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îî‚îÄ‚îÄ monitoring/
‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ global/
‚îÇ   ‚îú‚îÄ‚îÄ iam/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main.tf
‚îÇ   ‚îî‚îÄ‚îÄ kms/
‚îÇ       ‚îî‚îÄ‚îÄ main.tf
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ init-db.sh
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ README.md
‚îî‚îÄ‚îÄ versions.tf
```

üí° **Conseil** : S√©parez les environnements pour √©viter les erreurs de d√©ploiement accidentel en production.

---

## Configuration de base Terraform

### versions.tf

```hcl
# versions.tf - Versions Terraform et providers
terraform {
  required_version = ">= 1.6.0"
  
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
    
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "~> 3.0"
    }
    
    google = {
      source  = "hashicorp/google"
      version = "~> 5.0"
    }
    
    random = {
      source  = "hashicorp/random"
      version = "~> 3.5"
    }
    
    null = {
      source  = "hashicorp/null"
      version = "~> 3.2"
    }
  }
}
```

### backend.tf (Remote State)

```hcl
# backend.tf - Configuration du backend distant
terraform {
  backend "s3" {
    bucket         = "company-terraform-state"
    key            = "mariadb/production/terraform.tfstate"
    region         = "eu-west-1"
    encrypt        = true
    dynamodb_table = "terraform-state-lock"
    
    # Versionning pour rollback
    versioning = true
  }
}
```

‚ö†Ô∏è **Attention** : Ne committez JAMAIS de credentials dans Git. Utilisez des variables d'environnement ou des r√¥les IAM.

---

## Module MariaDB pour AWS RDS

### modules/mariadb-aws/main.tf

```hcl
# Module r√©utilisable pour MariaDB sur AWS RDS
locals {
  name_prefix = "${var.project}-${var.environment}"
  
  # Tags communs
  common_tags = merge(
    var.tags,
    {
      Project     = var.project
      Environment = var.environment
      ManagedBy   = "Terraform"
      Database    = "MariaDB"
      Version     = var.engine_version
    }
  )
}

# Subnet Group pour RDS
resource "aws_db_subnet_group" "mariadb" {
  name       = "${local.name_prefix}-mariadb-subnet-group"
  subnet_ids = var.subnet_ids
  
  tags = merge(
    local.common_tags,
    {
      Name = "${local.name_prefix}-mariadb-subnet-group"
    }
  )
}

# Security Group pour MariaDB
resource "aws_security_group" "mariadb" {
  name        = "${local.name_prefix}-mariadb-sg"
  description = "Security group for MariaDB RDS instance"
  vpc_id      = var.vpc_id
  
  # R√®gle entrante depuis application subnets
  ingress {
    description     = "MariaDB from application subnets"
    from_port       = 3306
    to_port         = 3306
    protocol        = "tcp"
    cidr_blocks     = var.allowed_cidr_blocks
    security_groups = var.allowed_security_group_ids
  }
  
  # R√®gle sortante (n√©cessaire pour replication cross-region)
  egress {
    description = "Allow all outbound"
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }
  
  tags = merge(
    local.common_tags,
    {
      Name = "${local.name_prefix}-mariadb-sg"
    }
  )
}

# Parameter Group personnalis√© pour MariaDB 11.8
resource "aws_db_parameter_group" "mariadb" {
  name        = "${local.name_prefix}-mariadb-params"
  family      = "mariadb11.8"  # üÜï MariaDB 11.8 LTS
  description = "Custom parameter group for MariaDB ${var.engine_version}"
  
  # üÜï MariaDB 11.8 - utf8mb4 par d√©faut
  parameter {
    name  = "character_set_server"
    value = "utf8mb4"
  }
  
  parameter {
    name  = "collation_server"
    value = "utf8mb4_unicode_ci"
  }
  
  # InnoDB optimizations
  parameter {
    name  = "innodb_buffer_pool_size"
    value = "{DBInstanceClassMemory*3/4}"  # 75% de la RAM
  }
  
  # üÜï MariaDB 11.8 - ALTER TABLE efficace
  parameter {
    name  = "innodb_alter_copy_bulk"
    value = "268435456"  # 256MB
  }
  
  # Binary logs pour replication/PITR
  parameter {
    name  = "log_bin_trust_function_creators"
    value = "1"
  }
  
  parameter {
    name  = "binlog_format"
    value = "ROW"
  }
  
  # Slow query log
  parameter {
    name  = "slow_query_log"
    value = "1"
  }
  
  parameter {
    name  = "long_query_time"
    value = var.slow_query_time
  }
  
  # üÜï MariaDB 11.8 - Contr√¥le espace temporaire
  parameter {
    name  = "max_tmp_space_usage"
    value = "10737418240"  # 10GB
  }
  
  # Connexions
  parameter {
    name  = "max_connections"
    value = var.max_connections
  }
  
  # üÜï TLS enforcement (optionnel, √† activer progressivement)
  parameter {
    name         = "require_secure_transport"
    value        = var.require_secure_transport ? "1" : "0"
    apply_method = "pending-reboot"
  }
  
  tags = local.common_tags
}

# Option Group (pour plugins)
resource "aws_db_option_group" "mariadb" {
  name                     = "${local.name_prefix}-mariadb-options"
  option_group_description = "Option group for MariaDB ${var.engine_version}"
  engine_name              = "mariadb"
  major_engine_version     = var.major_engine_version
  
  # Audit Plugin (optionnel)
  dynamic "option" {
    for_each = var.enable_audit_plugin ? [1] : []
    
    content {
      option_name = "MARIADB_AUDIT_PLUGIN"
      
      option_settings {
        name  = "SERVER_AUDIT_EVENTS"
        value = "CONNECT,QUERY_DDL,QUERY_DML"
      }
      
      option_settings {
        name  = "SERVER_AUDIT_FILE_ROTATIONS"
        value = "9"
      }
    }
  }
  
  tags = local.common_tags
}

# KMS Key pour encryption at rest
resource "aws_kms_key" "mariadb" {
  count = var.create_kms_key ? 1 : 0
  
  description             = "KMS key for MariaDB encryption at rest"
  deletion_window_in_days = var.kms_key_deletion_window
  enable_key_rotation     = true
  
  tags = merge(
    local.common_tags,
    {
      Name = "${local.name_prefix}-mariadb-kms"
    }
  )
}

resource "aws_kms_alias" "mariadb" {
  count = var.create_kms_key ? 1 : 0
  
  name          = "alias/${local.name_prefix}-mariadb"
  target_key_id = aws_kms_key.mariadb[0].key_id
}

# G√©n√©ration du mot de passe root s√©curis√©
resource "random_password" "master_password" {
  count = var.master_password == null ? 1 : 0
  
  length  = 32
  special = true
  
  # Exclure les caract√®res probl√©matiques
  override_special = "!#$%&*()-_=+[]{}<>:?"
}

# Stockage du mot de passe dans Secrets Manager
resource "aws_secretsmanager_secret" "mariadb_master_password" {
  count = var.store_password_in_secrets_manager ? 1 : 0
  
  name                    = "${local.name_prefix}-mariadb-master-password"
  description             = "Master password for MariaDB RDS instance"
  recovery_window_in_days = var.secret_recovery_window
  
  tags = local.common_tags
}

resource "aws_secretsmanager_secret_version" "mariadb_master_password" {
  count = var.store_password_in_secrets_manager ? 1 : 0
  
  secret_id = aws_secretsmanager_secret.mariadb_master_password[0].id
  secret_string = jsonencode({
    username = var.master_username
    password = var.master_password != null ? var.master_password : random_password.master_password[0].result
    engine   = "mariadb"
    host     = aws_db_instance.mariadb.endpoint
    port     = 3306
    dbname   = var.database_name
  })
}

# RDS Instance principale
resource "aws_db_instance" "mariadb" {
  identifier = "${local.name_prefix}-mariadb"
  
  # Engine
  engine         = "mariadb"
  engine_version = var.engine_version  # üÜï 11.8.x
  
  # Instance class
  instance_class        = var.instance_class
  allocated_storage     = var.allocated_storage
  max_allocated_storage = var.max_allocated_storage
  storage_type          = var.storage_type
  storage_encrypted     = true
  kms_key_id            = var.create_kms_key ? aws_kms_key.mariadb[0].arn : var.kms_key_id
  iops                  = var.storage_type == "io1" || var.storage_type == "io2" ? var.iops : null
  storage_throughput    = var.storage_type == "gp3" ? var.storage_throughput : null
  
  # Database
  db_name  = var.database_name
  username = var.master_username
  password = var.master_password != null ? var.master_password : random_password.master_password[0].result
  port     = 3306
  
  # Network
  db_subnet_group_name   = aws_db_subnet_group.mariadb.name
  vpc_security_group_ids = [aws_security_group.mariadb.id]
  publicly_accessible    = var.publicly_accessible
  
  # Parameter & Option Groups
  parameter_group_name = aws_db_parameter_group.mariadb.name
  option_group_name    = aws_db_option_group.mariadb.name
  
  # Backup
  backup_retention_period   = var.backup_retention_period
  backup_window             = var.backup_window
  delete_automated_backups  = var.delete_automated_backups
  skip_final_snapshot       = var.skip_final_snapshot
  final_snapshot_identifier = var.skip_final_snapshot ? null : "${local.name_prefix}-mariadb-final-${formatdate("YYYY-MM-DD-hhmm", timestamp())}"
  copy_tags_to_snapshot     = true
  
  # Maintenance
  maintenance_window              = var.maintenance_window
  auto_minor_version_upgrade      = var.auto_minor_version_upgrade
  allow_major_version_upgrade     = var.allow_major_version_upgrade
  apply_immediately               = var.apply_immediately
  
  # Monitoring
  enabled_cloudwatch_logs_exports = var.enabled_cloudwatch_logs_exports
  monitoring_interval             = var.monitoring_interval
  monitoring_role_arn             = var.monitoring_interval > 0 ? aws_iam_role.rds_monitoring[0].arn : null
  performance_insights_enabled    = var.performance_insights_enabled
  performance_insights_kms_key_id = var.performance_insights_enabled && var.create_kms_key ? aws_kms_key.mariadb[0].arn : null
  performance_insights_retention_period = var.performance_insights_retention_period
  
  # High Availability
  multi_az = var.multi_az
  
  # Protection
  deletion_protection = var.deletion_protection
  
  tags = merge(
    local.common_tags,
    {
      Name = "${local.name_prefix}-mariadb"
    }
  )
  
  lifecycle {
    ignore_changes = [
      password,  # √âviter la recr√©ation si le mot de passe change
    ]
  }
  
  depends_on = [
    aws_db_subnet_group.mariadb,
    aws_security_group.mariadb,
  ]
}

# Read Replica (optionnel)
resource "aws_db_instance" "mariadb_replica" {
  count = var.create_read_replica ? var.read_replica_count : 0
  
  identifier             = "${local.name_prefix}-mariadb-replica-${count.index + 1}"
  replicate_source_db    = aws_db_instance.mariadb.identifier
  instance_class         = var.replica_instance_class != null ? var.replica_instance_class : var.instance_class
  
  # Les param√®tres suivants sont h√©rit√©s du primary
  # mais peuvent √™tre overrid√©s
  publicly_accessible = var.publicly_accessible
  
  # Backup (les replicas peuvent avoir leur propre r√©tention)
  backup_retention_period = var.replica_backup_retention_period
  
  # Monitoring
  monitoring_interval  = var.monitoring_interval
  monitoring_role_arn  = var.monitoring_interval > 0 ? aws_iam_role.rds_monitoring[0].arn : null
  
  performance_insights_enabled          = var.performance_insights_enabled
  performance_insights_kms_key_id       = var.performance_insights_enabled && var.create_kms_key ? aws_kms_key.mariadb[0].arn : null
  performance_insights_retention_period = var.performance_insights_retention_period
  
  # Maintenance
  auto_minor_version_upgrade = var.auto_minor_version_upgrade
  maintenance_window         = var.maintenance_window
  apply_immediately          = var.apply_immediately
  
  tags = merge(
    local.common_tags,
    {
      Name = "${local.name_prefix}-mariadb-replica-${count.index + 1}"
      Role = "replica"
    }
  )
  
  depends_on = [aws_db_instance.mariadb]
}

# IAM Role pour Enhanced Monitoring
resource "aws_iam_role" "rds_monitoring" {
  count = var.monitoring_interval > 0 ? 1 : 0
  
  name = "${local.name_prefix}-rds-monitoring-role"
  
  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Action = "sts:AssumeRole"
        Effect = "Allow"
        Principal = {
          Service = "monitoring.rds.amazonaws.com"
        }
      }
    ]
  })
  
  tags = local.common_tags
}

resource "aws_iam_role_policy_attachment" "rds_monitoring" {
  count = var.monitoring_interval > 0 ? 1 : 0
  
  role       = aws_iam_role.rds_monitoring[0].name
  policy_arn = "arn:aws:iam::aws:policy/service-role/AmazonRDSEnhancedMonitoringRole"
}

# CloudWatch Alarms
resource "aws_cloudwatch_metric_alarm" "database_cpu" {
  count = var.create_cloudwatch_alarms ? 1 : 0
  
  alarm_name          = "${local.name_prefix}-mariadb-cpu-utilization"
  comparison_operator = "GreaterThanThreshold"
  evaluation_periods  = "2"
  metric_name         = "CPUUtilization"
  namespace           = "AWS/RDS"
  period              = "300"
  statistic           = "Average"
  threshold           = var.cpu_alarm_threshold
  alarm_description   = "This metric monitors RDS CPU utilization"
  alarm_actions       = var.alarm_actions
  
  dimensions = {
    DBInstanceIdentifier = aws_db_instance.mariadb.id
  }
  
  tags = local.common_tags
}

resource "aws_cloudwatch_metric_alarm" "database_storage" {
  count = var.create_cloudwatch_alarms ? 1 : 0
  
  alarm_name          = "${local.name_prefix}-mariadb-free-storage-space"
  comparison_operator = "LessThanThreshold"
  evaluation_periods  = "1"
  metric_name         = "FreeStorageSpace"
  namespace           = "AWS/RDS"
  period              = "300"
  statistic           = "Average"
  threshold           = var.storage_alarm_threshold
  alarm_description   = "This metric monitors RDS free storage space"
  alarm_actions       = var.alarm_actions
  
  dimensions = {
    DBInstanceIdentifier = aws_db_instance.mariadb.id
  }
  
  tags = local.common_tags
}

resource "aws_cloudwatch_metric_alarm" "database_memory" {
  count = var.create_cloudwatch_alarms ? 1 : 0
  
  alarm_name          = "${local.name_prefix}-mariadb-freeable-memory"
  comparison_operator = "LessThanThreshold"
  evaluation_periods  = "2"
  metric_name         = "FreeableMemory"
  namespace           = "AWS/RDS"
  period              = "300"
  statistic           = "Average"
  threshold           = var.memory_alarm_threshold
  alarm_description   = "This metric monitors RDS freeable memory"
  alarm_actions       = var.alarm_actions
  
  dimensions = {
    DBInstanceIdentifier = aws_db_instance.mariadb.id
  }
  
  tags = local.common_tags
}

# Route53 CNAME pour nom DNS friendly
resource "aws_route53_record" "mariadb" {
  count = var.create_route53_record ? 1 : 0
  
  zone_id = var.route53_zone_id
  name    = var.route53_record_name
  type    = "CNAME"
  ttl     = "300"
  records = [aws_db_instance.mariadb.address]
}
```

### modules/mariadb-aws/variables.tf

```hcl
# Project & Environment
variable "project" {
  description = "Project name"
  type        = string
}

variable "environment" {
  description = "Environment (dev, staging, production)"
  type        = string
  
  validation {
    condition     = contains(["dev", "staging", "production"], var.environment)
    error_message = "Environment must be dev, staging, or production."
  }
}

# Network
variable "vpc_id" {
  description = "VPC ID where to deploy MariaDB"
  type        = string
}

variable "subnet_ids" {
  description = "List of subnet IDs for DB subnet group"
  type        = list(string)
}

variable "allowed_cidr_blocks" {
  description = "List of CIDR blocks allowed to connect"
  type        = list(string)
  default     = []
}

variable "allowed_security_group_ids" {
  description = "List of security group IDs allowed to connect"
  type        = list(string)
  default     = []
}

variable "publicly_accessible" {
  description = "Whether the DB is publicly accessible"
  type        = bool
  default     = false
}

# Engine
variable "engine_version" {
  description = "MariaDB engine version"
  type        = string
  default     = "11.8.1"  # üÜï MariaDB 11.8 LTS
}

variable "major_engine_version" {
  description = "Major engine version for option group"
  type        = string
  default     = "11.8"
}

variable "instance_class" {
  description = "RDS instance class"
  type        = string
  default     = "db.r6i.large"
  
  validation {
    condition     = can(regex("^db\\.", var.instance_class))
    error_message = "Instance class must start with 'db.'"
  }
}

# Storage
variable "allocated_storage" {
  description = "Initial allocated storage in GB"
  type        = number
  default     = 100
}

variable "max_allocated_storage" {
  description = "Maximum allocated storage for autoscaling in GB"
  type        = number
  default     = 1000
}

variable "storage_type" {
  description = "Storage type (gp2, gp3, io1, io2)"
  type        = string
  default     = "gp3"
  
  validation {
    condition     = contains(["gp2", "gp3", "io1", "io2"], var.storage_type)
    error_message = "Storage type must be gp2, gp3, io1, or io2."
  }
}

variable "iops" {
  description = "IOPS for io1/io2 storage"
  type        = number
  default     = null
}

variable "storage_throughput" {
  description = "Storage throughput for gp3 (MB/s)"
  type        = number
  default     = 125
}

# Database
variable "database_name" {
  description = "Initial database name"
  type        = string
  default     = "app"
}

variable "master_username" {
  description = "Master username"
  type        = string
  default     = "admin"
  sensitive   = true
}

variable "master_password" {
  description = "Master password (if null, will be auto-generated)"
  type        = string
  default     = null
  sensitive   = true
}

# Parameters
variable "max_connections" {
  description = "Maximum number of connections"
  type        = number
  default     = 200
}

variable "slow_query_time" {
  description = "Slow query time in seconds"
  type        = number
  default     = 2
}

variable "require_secure_transport" {
  description = "Require TLS for connections"
  type        = bool
  default     = false  # üÜï √Ä activer progressivement en prod
}

# Backup
variable "backup_retention_period" {
  description = "Backup retention period in days"
  type        = number
  default     = 7
}

variable "backup_window" {
  description = "Backup window (UTC)"
  type        = string
  default     = "03:00-04:00"
}

variable "delete_automated_backups" {
  description = "Delete automated backups after instance deletion"
  type        = bool
  default     = true
}

variable "skip_final_snapshot" {
  description = "Skip final snapshot on deletion"
  type        = bool
  default     = false
}

# Maintenance
variable "maintenance_window" {
  description = "Maintenance window (UTC)"
  type        = string
  default     = "sun:04:00-sun:05:00"
}

variable "auto_minor_version_upgrade" {
  description = "Auto minor version upgrade"
  type        = bool
  default     = false  # Contr√¥le manuel recommand√© en prod
}

variable "allow_major_version_upgrade" {
  description = "Allow major version upgrade"
  type        = bool
  default     = false
}

variable "apply_immediately" {
  description = "Apply changes immediately"
  type        = bool
  default     = false
}

# High Availability
variable "multi_az" {
  description = "Enable Multi-AZ"
  type        = bool
  default     = true
}

# Read Replicas
variable "create_read_replica" {
  description = "Create read replica(s)"
  type        = bool
  default     = false
}

variable "read_replica_count" {
  description = "Number of read replicas"
  type        = number
  default     = 1
}

variable "replica_instance_class" {
  description = "Instance class for replicas (if different from primary)"
  type        = string
  default     = null
}

variable "replica_backup_retention_period" {
  description = "Backup retention for replicas"
  type        = number
  default     = 0
}

# Monitoring
variable "monitoring_interval" {
  description = "Enhanced monitoring interval (0, 1, 5, 10, 15, 30, 60)"
  type        = number
  default     = 60
  
  validation {
    condition     = contains([0, 1, 5, 10, 15, 30, 60], var.monitoring_interval)
    error_message = "Monitoring interval must be 0, 1, 5, 10, 15, 30, or 60."
  }
}

variable "enabled_cloudwatch_logs_exports" {
  description = "List of log types to export to CloudWatch"
  type        = list(string)
  default     = ["error", "slowquery", "general"]
}

variable "performance_insights_enabled" {
  description = "Enable Performance Insights"
  type        = bool
  default     = true
}

variable "performance_insights_retention_period" {
  description = "Performance Insights retention period (7 or 731 days)"
  type        = number
  default     = 7
}

# Security
variable "deletion_protection" {
  description = "Enable deletion protection"
  type        = bool
  default     = true
}

variable "create_kms_key" {
  description = "Create KMS key for encryption"
  type        = bool
  default     = true
}

variable "kms_key_id" {
  description = "Existing KMS key ID (if create_kms_key is false)"
  type        = string
  default     = null
}

variable "kms_key_deletion_window" {
  description = "KMS key deletion window in days"
  type        = number
  default     = 30
}

variable "store_password_in_secrets_manager" {
  description = "Store master password in AWS Secrets Manager"
  type        = bool
  default     = true
}

variable "secret_recovery_window" {
  description = "Secrets Manager recovery window in days"
  type        = number
  default     = 7
}

# Audit
variable "enable_audit_plugin" {
  description = "Enable MariaDB Audit Plugin"
  type        = bool
  default     = false
}

# CloudWatch Alarms
variable "create_cloudwatch_alarms" {
  description = "Create CloudWatch alarms"
  type        = bool
  default     = true
}

variable "alarm_actions" {
  description = "SNS topic ARNs for alarms"
  type        = list(string)
  default     = []
}

variable "cpu_alarm_threshold" {
  description = "CPU utilization alarm threshold (%)"
  type        = number
  default     = 80
}

variable "storage_alarm_threshold" {
  description = "Free storage space alarm threshold (bytes)"
  type        = number
  default     = 10737418240  # 10GB
}

variable "memory_alarm_threshold" {
  description = "Freeable memory alarm threshold (bytes)"
  type        = number
  default     = 1073741824  # 1GB
}

# Route53
variable "create_route53_record" {
  description = "Create Route53 CNAME record"
  type        = bool
  default     = false
}

variable "route53_zone_id" {
  description = "Route53 hosted zone ID"
  type        = string
  default     = null
}

variable "route53_record_name" {
  description = "Route53 record name"
  type        = string
  default     = null
}

# Tags
variable "tags" {
  description = "Additional tags"
  type        = map(string)
  default     = {}
}
```

### modules/mariadb-aws/outputs.tf

```hcl
# Instance outputs
output "db_instance_id" {
  description = "RDS instance ID"
  value       = aws_db_instance.mariadb.id
}

output "db_instance_arn" {
  description = "RDS instance ARN"
  value       = aws_db_instance.mariadb.arn
}

output "db_instance_endpoint" {
  description = "Connection endpoint"
  value       = aws_db_instance.mariadb.endpoint
}

output "db_instance_address" {
  description = "Database hostname"
  value       = aws_db_instance.mariadb.address
}

output "db_instance_port" {
  description = "Database port"
  value       = aws_db_instance.mariadb.port
}

output "db_instance_name" {
  description = "Database name"
  value       = aws_db_instance.mariadb.db_name
}

output "db_instance_username" {
  description = "Master username"
  value       = aws_db_instance.mariadb.username
  sensitive   = true
}

# Read replicas
output "read_replica_endpoints" {
  description = "Read replica endpoints"
  value       = aws_db_instance.mariadb_replica[*].endpoint
}

# Security
output "security_group_id" {
  description = "Security group ID"
  value       = aws_security_group.mariadb.id
}

output "kms_key_id" {
  description = "KMS key ID"
  value       = var.create_kms_key ? aws_kms_key.mariadb[0].id : null
}

output "kms_key_arn" {
  description = "KMS key ARN"
  value       = var.create_kms_key ? aws_kms_key.mariadb[0].arn : null
}

# Secrets Manager
output "master_password_secret_arn" {
  description = "Secrets Manager secret ARN for master password"
  value       = var.store_password_in_secrets_manager ? aws_secretsmanager_secret.mariadb_master_password[0].arn : null
}

# DNS
output "route53_record_fqdn" {
  description = "Route53 FQDN"
  value       = var.create_route53_record ? aws_route53_record.mariadb[0].fqdn : null
}

# Connection string
output "connection_string" {
  description = "Complete connection string (sensitive)"
  value       = "mysql://${aws_db_instance.mariadb.username}@${aws_db_instance.mariadb.endpoint}/${aws_db_instance.mariadb.db_name}"
  sensitive   = true
}
```

üí° **Conseil** : Utilisez `sensitive = true` pour les outputs contenant des informations sensibles.

---

## Utilisation du module AWS

### environments/production/main.tf

```hcl
# Configuration du provider AWS
provider "aws" {
  region = var.aws_region
  
  default_tags {
    tags = {
      ManagedBy = "Terraform"
      Project   = "MariaDB-Platform"
    }
  }
}

# Data sources pour r√©cup√©rer les ressources existantes
data "aws_vpc" "main" {
  filter {
    name   = "tag:Name"
    values = ["production-vpc"]
  }
}

data "aws_subnets" "database" {
  filter {
    name   = "vpc-id"
    values = [data.aws_vpc.main.id]
  }
  
  filter {
    name   = "tag:Tier"
    values = ["database"]
  }
}

data "aws_security_group" "app" {
  filter {
    name   = "tag:Name"
    values = ["production-app-sg"]
  }
}

# SNS topic pour les alarmes
resource "aws_sns_topic" "database_alerts" {
  name = "production-mariadb-alerts"
}

resource "aws_sns_topic_subscription" "database_alerts_email" {
  topic_arn = aws_sns_topic.database_alerts.arn
  protocol  = "email"
  endpoint  = var.alert_email
}

# Module MariaDB
module "mariadb_production" {
  source = "../../modules/mariadb-aws"
  
  # Project
  project     = "myapp"
  environment = "production"
  
  # Network
  vpc_id                      = data.aws_vpc.main.id
  subnet_ids                  = data.aws_subnets.database.ids
  allowed_security_group_ids  = [data.aws_security_group.app.id]
  publicly_accessible         = false
  
  # Engine - üÜï MariaDB 11.8 LTS
  engine_version       = "11.8.1"
  major_engine_version = "11.8"
  instance_class       = "db.r6i.2xlarge"
  
  # Storage
  allocated_storage     = 500
  max_allocated_storage = 2000
  storage_type          = "gp3"
  storage_throughput    = 500
  
  # Database
  database_name   = "production_db"
  master_username = "admin"
  # master_password sera auto-g√©n√©r√© et stock√© dans Secrets Manager
  
  # Parameters
  max_connections           = 500
  slow_query_time           = 1
  require_secure_transport  = false  # √Ä activer apr√®s migration des clients
  
  # Backup
  backup_retention_period = 30  # 30 jours en production
  backup_window           = "03:00-04:00"
  skip_final_snapshot     = false
  
  # Maintenance
  maintenance_window         = "sun:04:00-sun:05:00"
  auto_minor_version_upgrade = false  # Contr√¥le manuel en prod
  apply_immediately          = false
  
  # High Availability
  multi_az = true
  
  # Read Replicas
  create_read_replica  = true
  read_replica_count   = 2
  replica_instance_class = "db.r6i.xlarge"
  
  # Monitoring
  monitoring_interval                   = 60
  performance_insights_enabled          = true
  performance_insights_retention_period = 731  # 2 ans
  enabled_cloudwatch_logs_exports       = ["error", "slowquery"]
  
  # Security
  deletion_protection                = true
  create_kms_key                     = true
  store_password_in_secrets_manager  = true
  enable_audit_plugin                = true
  
  # CloudWatch Alarms
  create_cloudwatch_alarms = true
  alarm_actions            = [aws_sns_topic.database_alerts.arn]
  cpu_alarm_threshold      = 75
  storage_alarm_threshold  = 53687091200  # 50GB
  memory_alarm_threshold   = 2147483648   # 2GB
  
  # Route53
  create_route53_record = true
  route53_zone_id       = var.route53_zone_id
  route53_record_name   = "db-prod.internal.example.com"
  
  tags = {
    CostCenter  = "Engineering"
    Compliance  = "SOC2"
    DataClass   = "Confidential"
  }
}
```

### environments/production/outputs.tf

```hcl
output "mariadb_endpoint" {
  description = "MariaDB primary endpoint"
  value       = module.mariadb_production.db_instance_endpoint
}

output "mariadb_read_replicas" {
  description = "MariaDB read replica endpoints"
  value       = module.mariadb_production.read_replica_endpoints
}

output "mariadb_password_secret" {
  description = "AWS Secrets Manager ARN for database password"
  value       = module.mariadb_production.master_password_secret_arn
}

output "mariadb_dns_name" {
  description = "Route53 FQDN for database"
  value       = module.mariadb_production.route53_record_fqdn
}
```

### environments/production/terraform.tfvars

```hcl
# AWS
aws_region = "eu-west-1"

# Alerts
alert_email = "dba-team@example.com"

# Route53
route53_zone_id = "Z1234567890ABC"
```

---

## Module MariaDB pour Azure Database

### modules/mariadb-azure/main.tf

```hcl
# Module MariaDB pour Azure Database for MariaDB
# Note: Azure Database for MariaDB est deprecated, migration vers Flexible Server recommand√©e

locals {
  name_prefix = "${var.project}-${var.environment}"
  
  common_tags = merge(
    var.tags,
    {
      project     = var.project
      environment = var.environment
      managedBy   = "Terraform"
      database    = "MariaDB"
    }
  )
}

# Resource Group
resource "azurerm_resource_group" "mariadb" {
  count = var.create_resource_group ? 1 : 0
  
  name     = "${local.name_prefix}-mariadb-rg"
  location = var.location
  
  tags = local.common_tags
}

# MariaDB Server (Single Server - deprecated, utilisez Flexible Server √† la place)
resource "azurerm_mariadb_server" "main" {
  name                = "${local.name_prefix}-mariadb"
  location            = var.create_resource_group ? azurerm_resource_group.mariadb[0].location : var.location
  resource_group_name = var.create_resource_group ? azurerm_resource_group.mariadb[0].name : var.resource_group_name
  
  administrator_login          = var.administrator_login
  administrator_login_password = var.administrator_password != null ? var.administrator_password : random_password.admin_password[0].result
  
  sku_name   = var.sku_name
  version    = "10.3"  # ‚ö†Ô∏è Azure supporte jusqu'√† MariaDB 10.3, pas encore 11.x
  storage_mb = var.storage_mb
  
  backup_retention_days        = var.backup_retention_days
  geo_redundant_backup_enabled = var.geo_redundant_backup_enabled
  auto_grow_enabled            = var.auto_grow_enabled
  
  public_network_access_enabled    = var.public_network_access_enabled
  ssl_enforcement_enabled          = true
  ssl_minimal_tls_version_enforced = "TLS1_2"
  
  tags = local.common_tags
}

# Random password
resource "random_password" "admin_password" {
  count = var.administrator_password == null ? 1 : 0
  
  length  = 32
  special = true
}

# Private Endpoint
resource "azurerm_private_endpoint" "mariadb" {
  count = var.create_private_endpoint ? 1 : 0
  
  name                = "${local.name_prefix}-mariadb-pe"
  location            = var.create_resource_group ? azurerm_resource_group.mariadb[0].location : var.location
  resource_group_name = var.create_resource_group ? azurerm_resource_group.mariadb[0].name : var.resource_group_name
  subnet_id           = var.private_endpoint_subnet_id
  
  private_service_connection {
    name                           = "${local.name_prefix}-mariadb-psc"
    private_connection_resource_id = azurerm_mariadb_server.main.id
    is_manual_connection           = false
    subresource_names              = ["mariadbServer"]
  }
  
  tags = local.common_tags
}

# Firewall Rules
resource "azurerm_mariadb_firewall_rule" "allow_azure_services" {
  count = var.allow_azure_services ? 1 : 0
  
  name                = "AllowAzureServices"
  resource_group_name = var.create_resource_group ? azurerm_resource_group.mariadb[0].name : var.resource_group_name
  server_name         = azurerm_mariadb_server.main.name
  start_ip_address    = "0.0.0.0"
  end_ip_address      = "0.0.0.0"
}

resource "azurerm_mariadb_firewall_rule" "additional" {
  for_each = var.firewall_rules
  
  name                = each.key
  resource_group_name = var.create_resource_group ? azurerm_resource_group.mariadb[0].name : var.resource_group_name
  server_name         = azurerm_mariadb_server.main.name
  start_ip_address    = each.value.start_ip
  end_ip_address      = each.value.end_ip
}

# Configuration
resource "azurerm_mariadb_configuration" "configs" {
  for_each = var.server_configurations
  
  name                = each.key
  resource_group_name = var.create_resource_group ? azurerm_resource_group.mariadb[0].name : var.resource_group_name
  server_name         = azurerm_mariadb_server.main.name
  value               = each.value
}

# Database
resource "azurerm_mariadb_database" "databases" {
  for_each = var.databases
  
  name                = each.value.name
  resource_group_name = var.create_resource_group ? azurerm_resource_group.mariadb[0].name : var.resource_group_name
  server_name         = azurerm_mariadb_server.main.name
  charset             = each.value.charset
  collation           = each.value.collation
}

# Key Vault pour stocker le mot de passe
resource "azurerm_key_vault_secret" "mariadb_password" {
  count = var.store_password_in_key_vault ? 1 : 0
  
  name         = "${local.name_prefix}-mariadb-admin-password"
  value        = var.administrator_password != null ? var.administrator_password : random_password.admin_password[0].result
  key_vault_id = var.key_vault_id
  
  tags = local.common_tags
}
```

‚ö†Ô∏è **Attention** : Azure Database for MariaDB (Single Server) est deprecated. Microsoft recommande de migrer vers Azure Database for MySQL Flexible Server.

---

## Module MariaDB pour Google Cloud SQL

### modules/mariadb-gcp/main.tf

```hcl
# Module MariaDB pour Google Cloud SQL
locals {
  name_prefix = "${var.project}-${var.environment}"
}

# Random suffix pour √©viter les conflits de noms
resource "random_id" "db_name_suffix" {
  byte_length = 4
}

# Cloud SQL Instance
resource "google_sql_database_instance" "mariadb" {
  name             = "${local.name_prefix}-mariadb-${random_id.db_name_suffix.hex}"
  database_version = var.database_version  # üÜï "MARIADB_11_8" quand disponible
  region           = var.region
  project          = var.gcp_project
  
  deletion_protection = var.deletion_protection
  
  settings {
    tier              = var.tier
    availability_type = var.availability_type  # ZONAL ou REGIONAL
    disk_type         = var.disk_type
    disk_size         = var.disk_size
    disk_autoresize   = var.disk_autoresize
    
    # Backup
    backup_configuration {
      enabled                        = true
      start_time                     = var.backup_start_time
      point_in_time_recovery_enabled = var.point_in_time_recovery_enabled
      transaction_log_retention_days = var.transaction_log_retention_days
      backup_retention_settings {
        retained_backups = var.retained_backups
        retention_unit   = "COUNT"
      }
    }
    
    # Maintenance
    maintenance_window {
      day          = var.maintenance_window_day
      hour         = var.maintenance_window_hour
      update_track = var.maintenance_update_track
    }
    
    # IP Configuration
    ip_configuration {
      ipv4_enabled    = var.ipv4_enabled
      private_network = var.private_network
      require_ssl     = var.require_ssl
      
      dynamic "authorized_networks" {
        for_each = var.authorized_networks
        content {
          name  = authorized_networks.value.name
          value = authorized_networks.value.cidr
        }
      }
    }
    
    # Database flags
    dynamic "database_flags" {
      for_each = var.database_flags
      content {
        name  = database_flags.value.name
        value = database_flags.value.value
      }
    }
    
    # Insights
    insights_config {
      query_insights_enabled  = var.query_insights_enabled
      query_string_length     = var.query_string_length
      record_application_tags = var.record_application_tags
    }
  }
  
  lifecycle {
    ignore_changes = [
      settings[0].disk_size  # Auto-resize g√®re cela
    ]
  }
}

# Root password
resource "random_password" "root_password" {
  count = var.root_password == null ? 1 : 0
  
  length  = 32
  special = true
}

# Root user
resource "google_sql_user" "root" {
  name     = "root"
  instance = google_sql_database_instance.mariadb.name
  password = var.root_password != null ? var.root_password : random_password.root_password[0].result
}

# Additional users
resource "google_sql_user" "users" {
  for_each = var.additional_users
  
  name     = each.value.name
  instance = google_sql_database_instance.mariadb.name
  password = each.value.password
  host     = each.value.host
}

# Databases
resource "google_sql_database" "databases" {
  for_each = var.databases
  
  name      = each.value.name
  instance  = google_sql_database_instance.mariadb.name
  charset   = each.value.charset
  collation = each.value.collation
}

# Read Replicas
resource "google_sql_database_instance" "read_replica" {
  count = var.create_read_replica ? var.read_replica_count : 0
  
  name                 = "${local.name_prefix}-mariadb-replica-${count.index + 1}-${random_id.db_name_suffix.hex}"
  database_version     = var.database_version
  region               = var.replica_region != null ? var.replica_region : var.region
  master_instance_name = google_sql_database_instance.mariadb.name
  
  replica_configuration {
    failover_target = false
  }
  
  settings {
    tier              = var.replica_tier != null ? var.replica_tier : var.tier
    availability_type = "ZONAL"  # Replicas sont toujours ZONAL
    disk_type         = var.disk_type
    disk_autoresize   = var.disk_autoresize
    
    ip_configuration {
      ipv4_enabled    = var.ipv4_enabled
      private_network = var.private_network
      require_ssl     = var.require_ssl
    }
    
    insights_config {
      query_insights_enabled = var.query_insights_enabled
    }
  }
}

# Secret Manager pour stocker le mot de passe
resource "google_secret_manager_secret" "mariadb_root_password" {
  count = var.store_password_in_secret_manager ? 1 : 0
  
  secret_id = "${local.name_prefix}-mariadb-root-password"
  project   = var.gcp_project
  
  replication {
    automatic = true
  }
}

resource "google_secret_manager_secret_version" "mariadb_root_password" {
  count = var.store_password_in_secret_manager ? 1 : 0
  
  secret      = google_secret_manager_secret.mariadb_root_password[0].id
  secret_data = var.root_password != null ? var.root_password : random_password.root_password[0].result
}
```

üí° **Conseil** : Google Cloud SQL g√®re automatiquement les mises √† jour de s√©curit√© pendant la fen√™tre de maintenance.

---

## Gestion de l'√©tat distant (Remote State)

### Backend S3 avec DynamoDB locking

```hcl
# backend.tf
terraform {
  backend "s3" {
    bucket         = "company-terraform-state"
    key            = "mariadb/production/terraform.tfstate"
    region         = "eu-west-1"
    encrypt        = true
    dynamodb_table = "terraform-state-lock"
    
    # Versionning S3 pour rollback
    versioning = true
  }
}
```

### Configuration initiale du backend

```bash
# Cr√©er le bucket S3
aws s3api create-bucket \
  --bucket company-terraform-state \
  --region eu-west-1 \
  --create-bucket-configuration LocationConstraint=eu-west-1

# Activer le versionning
aws s3api put-bucket-versioning \
  --bucket company-terraform-state \
  --versioning-configuration Status=Enabled

# Activer le chiffrement
aws s3api put-bucket-encryption \
  --bucket company-terraform-state \
  --server-side-encryption-configuration '{
    "Rules": [{
      "ApplyServerSideEncryptionByDefault": {
        "SSEAlgorithm": "AES256"
      }
    }]
  }'

# Cr√©er la table DynamoDB pour le locking
aws dynamodb create-table \
  --table-name terraform-state-lock \
  --attribute-definitions AttributeName=LockID,AttributeType=S \
  --key-schema AttributeName=LockID,KeyType=HASH \
  --provisioned-throughput ReadCapacityUnits=5,WriteCapacityUnits=5 \
  --region eu-west-1
```

### Backend Azure Storage

```hcl
# backend.tf pour Azure
terraform {
  backend "azurerm" {
    resource_group_name  = "terraform-state-rg"
    storage_account_name = "companytfstate"
    container_name       = "tfstate"
    key                  = "mariadb/production/terraform.tfstate"
  }
}
```

### Backend GCS

```hcl
# backend.tf pour Google Cloud
terraform {
  backend "gcs" {
    bucket = "company-terraform-state"
    prefix = "mariadb/production"
  }
}
```

---

## Workspaces pour multi-environnements

```bash
# Cr√©er des workspaces
terraform workspace new development
terraform workspace new staging
terraform workspace new production

# Lister les workspaces
terraform workspace list

# S√©lectionner un workspace
terraform workspace select production

# Afficher le workspace actuel
terraform workspace show
```

### Utilisation dans les configurations

```hcl
# main.tf avec workspaces
locals {
  environment = terraform.workspace
  
  # Configuration par environnement
  config = {
    development = {
      instance_class    = "db.t3.medium"
      multi_az          = false
      backup_retention  = 1
    }
    staging = {
      instance_class    = "db.r6i.large"
      multi_az          = true
      backup_retention  = 7
    }
    production = {
      instance_class    = "db.r6i.2xlarge"
      multi_az          = true
      backup_retention  = 30
    }
  }
}

module "mariadb" {
  source = "../../modules/mariadb-aws"
  
  environment      = local.environment
  instance_class   = local.config[local.environment].instance_class
  multi_az         = local.config[local.environment].multi_az
  backup_retention_period = local.config[local.environment].backup_retention
  
  # ...
}
```

---

## Workflow Terraform

### 1. Initialisation

```bash
# Initialiser le projet (t√©l√©charge providers et modules)
terraform init

# Avec upgrade des providers
terraform init -upgrade

# Reconfigurer le backend
terraform init -reconfigure
```

### 2. Planification

```bash
# Plan complet
terraform plan

# Plan avec fichier de sortie
terraform plan -out=tfplan

# Plan cibl√© sur une ressource
terraform plan -target=module.mariadb.aws_db_instance.mariadb

# Plan avec variables
terraform plan -var="environment=production" -var-file="production.tfvars"
```

### 3. Application

```bash
# Appliquer avec approbation manuelle
terraform apply

# Appliquer depuis un plan
terraform apply tfplan

# Appliquer avec auto-approve (CI/CD uniquement)
terraform apply -auto-approve

# Appliquer de mani√®re cibl√©e
terraform apply -target=module.mariadb.aws_db_instance.mariadb
```

### 4. Destruction

```bash
# D√©truire toute l'infrastructure (dangereux !)
terraform destroy

# D√©truire une ressource sp√©cifique
terraform destroy -target=module.mariadb.aws_db_instance.mariadb_replica[0]

# Plan de destruction
terraform plan -destroy
```

### 5. √âtat

```bash
# Lister les ressources
terraform state list

# Afficher une ressource
terraform state show module.mariadb.aws_db_instance.mariadb

# D√©placer une ressource
terraform state mv aws_db_instance.old aws_db_instance.new

# Supprimer une ressource du state (ne d√©truit pas la ressource r√©elle)
terraform state rm module.mariadb.aws_db_instance.mariadb_replica[1]

# Pull du state distant
terraform state pull > terraform.tfstate.backup

# Push du state distant
terraform state push terraform.tfstate
```

---

## Gestion des secrets

### 1. Variables d'environnement

```bash
# D√©finir les credentials AWS
export AWS_ACCESS_KEY_ID="AKIAIOSFODNN7EXAMPLE"
export AWS_SECRET_ACCESS_KEY="wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
export AWS_DEFAULT_REGION="eu-west-1"

# D√©finir des variables Terraform
export TF_VAR_master_password="SecurePassword123!"
```

### 2. Fichiers .tfvars (gitignore)

```hcl
# secrets.tfvars (ne JAMAIS committer)
master_password = "SuperSecurePassword123!"
alert_email     = "dba@example.com"
```

```bash
# Utilisation
terraform apply -var-file="secrets.tfvars"
```

### 3. AWS Secrets Manager

```hcl
# R√©cup√©rer un secret depuis AWS Secrets Manager
data "aws_secretsmanager_secret_version" "db_password" {
  secret_id = "production/mariadb/master-password"
}

locals {
  db_credentials = jsondecode(data.aws_secretsmanager_secret_version.db_password.secret_string)
}

module "mariadb" {
  source = "../../modules/mariadb-aws"
  
  master_password = local.db_credentials.password
}
```

### 4. HashiCorp Vault

```hcl
# Provider Vault
provider "vault" {
  address = "https://vault.example.com"
}

# R√©cup√©rer un secret
data "vault_generic_secret" "mariadb" {
  path = "secret/mariadb/production"
}

module "mariadb" {
  source = "../../modules/mariadb-aws"
  
  master_password = data.vault_generic_secret.mariadb.data["password"]
}
```

---

## CI/CD avec Terraform

### GitLab CI exemple

```yaml
# .gitlab-ci.yml
image:
  name: hashicorp/terraform:1.6
  entrypoint: [""]

variables:
  TF_ROOT: ${CI_PROJECT_DIR}/environments/production
  TF_ADDRESS: ${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/production

cache:
  paths:
    - ${TF_ROOT}/.terraform

before_script:
  - cd ${TF_ROOT}
  - terraform --version
  - terraform init

stages:
  - validate
  - plan
  - apply
  - destroy

validate:
  stage: validate
  script:
    - terraform validate
    - terraform fmt -check -recursive
  only:
    - merge_requests
    - main

plan:
  stage: plan
  script:
    - terraform plan -out=tfplan
  artifacts:
    paths:
      - ${TF_ROOT}/tfplan
    expire_in: 1 week
  only:
    - merge_requests
    - main

apply:
  stage: apply
  script:
    - terraform apply -auto-approve tfplan
  dependencies:
    - plan
  only:
    - main
  when: manual
  environment:
    name: production
    action: prepare

destroy:
  stage: destroy
  script:
    - terraform destroy -auto-approve
  only:
    - main
  when: manual
  environment:
    name: production
    action: stop
```

### GitHub Actions exemple

```yaml
# .github/workflows/terraform.yml
name: Terraform

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  TF_VERSION: 1.6.0
  AWS_REGION: eu-west-1

jobs:
  terraform:
    name: Terraform
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./environments/production
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: Terraform Format
        run: terraform fmt -check -recursive
      
      - name: Terraform Init
        run: terraform init
      
      - name: Terraform Validate
        run: terraform validate
      
      - name: Terraform Plan
        id: plan
        run: terraform plan -no-color
        continue-on-error: true
      
      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Terraform Format and Style üñå\`${{ steps.fmt.outcome }}\`
            #### Terraform Initialization ‚öôÔ∏è\`${{ steps.init.outcome }}\`
            #### Terraform Validation ü§ñ\`${{ steps.validate.outcome }}\`
            #### Terraform Plan üìñ\`${{ steps.plan.outcome }}\`
            
            <details><summary>Show Plan</summary>
            
            \`\`\`terraform
            ${{ steps.plan.outputs.stdout }}
            \`\`\`
            
            </details>`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })
      
      - name: Terraform Apply
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: terraform apply -auto-approve
```

---

## Modules avanc√©s et patterns

### 1. Module composite (networking + database)

```hcl
# modules/mariadb-platform/main.tf
module "vpc" {
  source = "../networking"
  
  cidr_block = var.vpc_cidr
  azs        = var.availability_zones
}

module "mariadb_primary" {
  source = "../mariadb-aws"
  
  vpc_id     = module.vpc.vpc_id
  subnet_ids = module.vpc.database_subnet_ids
  
  # ...
}

module "mariadb_replica_region2" {
  source = "../mariadb-aws"
  
  providers = {
    aws = aws.region2
  }
  
  vpc_id     = module.vpc_region2.vpc_id
  subnet_ids = module.vpc_region2.database_subnet_ids
  
  # ...
}
```

### 2. Module avec count et for_each

```hcl
# Cr√©er plusieurs bases de donn√©es
module "mariadb_tenants" {
  source = "../../modules/mariadb-aws"
  
  for_each = var.tenants
  
  project     = each.key
  environment = var.environment
  
  database_name   = each.value.database_name
  instance_class  = each.value.instance_class
  
  # ...
}
```

### 3. Drift detection

```bash
# D√©tecter les changements manuels
terraform plan -detailed-exitcode

# Exit codes:
# 0 = No changes
# 1 = Error
# 2 = Changes detected
```

### 4. Import de ressources existantes

```bash
# Importer une instance RDS existante
terraform import module.mariadb.aws_db_instance.mariadb production-mariadb

# G√©n√©rer la configuration depuis l'import (Terraform 1.5+)
terraform plan -generate-config-out=generated.tf
```

---

## Bonnes pratiques Terraform

### 1. Structure de code

‚úÖ **DO** :
- S√©parer les environnements (dev/staging/prod)
- Utiliser des modules r√©utilisables
- Versionner les modules
- Un fichier par type de ressource (rds.tf, network.tf, monitoring.tf)

‚ùå **DON'T** :
- Tout mettre dans un seul fichier
- Dupliquer le code entre environnements
- Hardcoder les valeurs sensibles

### 2. Naming conventions

```hcl
# Ressources: type-project-environment-name
resource "aws_db_instance" "mariadb" {
  identifier = "rds-myapp-prod-primary"
}

# Variables: descriptive_snake_case
variable "instance_class" {}

# Outputs: descriptive_snake_case
output "db_endpoint" {}

# Locals: descriptive_snake_case
locals {
  common_tags = {}
}
```

### 3. Documentation

```hcl
# variables.tf avec documentation
variable "instance_class" {
  description = "RDS instance class (e.g., db.r6i.large)"
  type        = string
  default     = "db.t3.medium"
  
  validation {
    condition     = can(regex("^db\\.", var.instance_class))
    error_message = "Instance class must start with 'db.'"
  }
}
```

### 4. Validation

```hcl
variable "environment" {
  type = string
  
  validation {
    condition     = contains(["dev", "staging", "production"], var.environment)
    error_message = "Environment must be dev, staging, or production."
  }
}

variable "backup_retention_period" {
  type = number
  
  validation {
    condition     = var.backup_retention_period >= 1 && var.backup_retention_period <= 35
    error_message = "Backup retention must be between 1 and 35 days."
  }
}
```

### 5. Lifecycle management

```hcl
resource "aws_db_instance" "mariadb" {
  # ...
  
  lifecycle {
    # √âviter la destruction accidentelle
    prevent_destroy = true
    
    # Ignorer certains changements
    ignore_changes = [
      password,
      tags["LastModified"],
    ]
    
    # Cr√©er avant de d√©truire (immutabilit√©)
    create_before_destroy = true
  }
}
```

### 6. D√©pendances explicites

```hcl
resource "aws_db_instance" "mariadb" {
  # ...
  
  depends_on = [
    aws_db_subnet_group.mariadb,
    aws_security_group.mariadb,
    aws_iam_role.rds_monitoring,
  ]
}
```

---

## Testing Terraform

### 1. Terraform Validate

```bash
# Validation syntaxique
terraform validate

# Format check
terraform fmt -check -recursive

# Format auto
terraform fmt -recursive
```

### 2. TFLint

```bash
# Installation
curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash

# Configuration .tflint.hcl
plugin "aws" {
  enabled = true
  version = "0.27.0"
  source  = "github.com/terraform-linters/tflint-ruleset-aws"
}

rule "aws_instance_invalid_type" {
  enabled = true
}

# Ex√©cution
tflint --init
tflint
```

### 3. Terratest (Go)

```go
// test/mariadb_test.go
package test

import (
    "testing"
    "github.com/gruntwork-io/terratest/modules/terraform"
    "github.com/stretchr/testify/assert"
)

func TestMariaDBModule(t *testing.T) {
    terraformOptions := &terraform.Options{
        TerraformDir: "../environments/staging",
        
        Vars: map[string]interface{}{
            "environment": "test",
            "instance_class": "db.t3.small",
        },
    }
    
    defer terraform.Destroy(t, terraformOptions)
    
    terraform.InitAndApply(t, terraformOptions)
    
    dbEndpoint := terraform.Output(t, terraformOptions, "db_instance_endpoint")
    assert.NotEmpty(t, dbEndpoint)
}
```

---

## ‚úÖ Points cl√©s √† retenir

- **Multi-cloud** : Terraform permet de g√©rer MariaDB sur AWS, Azure, GCP avec un langage unifi√©
- **Modules** : Cr√©ez des modules r√©utilisables pour standardiser les d√©ploiements
- **State** : Utilisez toujours un backend distant (S3, Azure Blob, GCS) avec locking
- **Secrets** : Ne commitez JAMAIS de credentials, utilisez des secret managers
- **Workspaces** : G√©rez plusieurs environnements avec les workspaces Terraform
- **Plan/Apply** : Toujours faire `terraform plan` avant `apply` en production
- **CI/CD** : Int√©grez Terraform dans vos pipelines pour automatiser les d√©ploiements
- **MariaDB 11.8** : Configurez utf8mb4, TLS, innodb_alter_copy_bulk dans les parameter groups
- **Validation** : Utilisez les validations de variables pour √©viter les erreurs
- **Documentation** : Documentez vos modules et variables pour faciliter la r√©utilisation

---

## üîó Ressources et r√©f√©rences

### Documentation officielle
- [üìñ Terraform Documentation](https://www.terraform.io/docs)
- [üìñ AWS Provider](https://registry.terraform.io/providers/hashicorp/aws/latest/docs)
- [üìñ Azure Provider](https://registry.terraform.io/providers/hashicorp/azurerm/latest/docs)
- [üìñ Google Provider](https://registry.terraform.io/providers/hashicorp/google/latest/docs)
- [üìñ MariaDB on AWS RDS](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/CHAP_MariaDB.html)

### Outils compl√©mentaires
- [Terragrunt](https://terragrunt.gruntwork.io/) - DRY Terraform configurations
- [Terraform Cloud](https://cloud.hashicorp.com/products/terraform) - Remote state & collaboration
- [Infracost](https://www.infracost.io/) - Estimation des co√ªts cloud
- [Checkov](https://www.checkov.io/) - Security scanning pour IaC
- [Terratest](https://terratest.gruntwork.io/) - Testing framework

### Modules Terraform communautaires
- [terraform-aws-rds](https://github.com/terraform-aws-modules/terraform-aws-rds)
- [terraform-google-sql-db](https://github.com/terraform-google-modules/terraform-google-sql-db)

---

## ‚û°Ô∏è Section suivante

**16.3 Conteneurisation avec Docker** : D√©couvrez comment conteneuriser MariaDB avec Docker, utiliser les images officielles, g√©rer les volumes persistants et cr√©er des environnements de d√©veloppement avec Docker Compose.

---

**MariaDB** : 11.8 LTS

‚è≠Ô∏è [Conteneurisation avec Docker](/16-devops-automatisation/03-conteneurisation-docker.md)
