üîù Retour au [Sommaire](/SOMMAIRE.md)

# 16.3.2 Docker Compose pour d√©veloppement

> **Niveau** : Avanc√© √† Expert  
> **Dur√©e estim√©e** : 3-4 heures  
> **Pr√©requis** : Docker Compose basics, MariaDB, networking, section 16.3.1

## üéØ Objectifs d'apprentissage

√Ä l'issue de cette section, vous serez capable de :
- Cr√©er des stacks MariaDB compl√®tes avec Docker Compose
- Orchestrer des architectures multi-services (app + DB + monitoring)
- Configurer la r√©plication Master-Slave avec Compose
- G√©rer les environnements de d√©veloppement reproductibles
- Impl√©menter des patterns avanc√©s (healthchecks, dependencies, networks)
- Optimiser les workflows de d√©veloppement avec Compose
- Appliquer les meilleures pratiques pour environnements √©ph√©m√®res

---

## Introduction

Docker Compose est l'outil de r√©f√©rence pour orchestrer des applications multi-conteneurs en environnement de d√©veloppement et de test. Il permet de d√©crire toute une stack dans un fichier YAML et de la d√©marrer/arr√™ter avec une seule commande.

### Pourquoi Docker Compose pour MariaDB ?

**Avantages cl√©s** :
- ‚úÖ **Reproductibilit√©** : Environnements identiques sur toutes les machines
- ‚úÖ **Simplicit√©** : Un fichier YAML pour toute la stack
- ‚úÖ **Isolation** : Networks, volumes et services isol√©s
- ‚úÖ **Rapidit√©** : Up/down en quelques secondes
- ‚úÖ **Versionnable** : Stack compl√®te dans Git
- ‚úÖ **Multi-environnements** : Dev, test, staging avec fichiers diff√©rents
- ‚úÖ **Int√©gration** : Application + DB + cache + monitoring d'un coup

**Cas d'usage** :
- Environnements de d√©veloppement local
- Tests d'int√©gration en CI/CD
- Prototypage rapide
- D√©monstrations et POC
- Formation et onboarding
- Validation de migrations

‚ö†Ô∏è **Attention** : Docker Compose n'est **pas recommand√© pour la production**. Utilisez Kubernetes, Docker Swarm ou des services manag√©s.

---

## Structure d'un projet Docker Compose

### Organisation recommand√©e

```
myproject/
‚îú‚îÄ‚îÄ docker-compose.yml              # Configuration principale
‚îú‚îÄ‚îÄ docker-compose.override.yml     # Overrides locaux (gitignore)
‚îú‚îÄ‚îÄ docker-compose.prod.yml         # Configuration production (exemple)
‚îú‚îÄ‚îÄ .env                            # Variables d'environnement (gitignore)
‚îú‚îÄ‚îÄ .env.example                    # Template de variables
‚îú‚îÄ‚îÄ mariadb/
‚îÇ   ‚îú‚îÄ‚îÄ conf/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ custom.cnf              # Configuration MariaDB
‚îÇ   ‚îú‚îÄ‚îÄ init/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 01-schema.sql          # Scripts d'initialisation
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ 02-data.sql
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ 03-users.sh
‚îÇ   ‚îî‚îÄ‚îÄ backup/
‚îÇ       ‚îî‚îÄ‚îÄ .gitkeep
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îú‚îÄ‚îÄ monitoring/
‚îÇ   ‚îú‚îÄ‚îÄ prometheus/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ prometheus.yml
‚îÇ   ‚îî‚îÄ‚îÄ grafana/
‚îÇ       ‚îî‚îÄ‚îÄ dashboards/
‚îî‚îÄ‚îÄ README.md
```

üí° **Conseil** : S√©parez les configurations sensibles (`.env`) et les configurations d'environnement (`docker-compose.override.yml`).

---

## Configuration de base

### docker-compose.yml simple

```yaml
version: '3.8'

services:
  mariadb:
    image: mariadb:11.8
    container_name: myapp-mariadb
    restart: unless-stopped
    
    environment:
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}
      MARIADB_DATABASE: ${MARIADB_DATABASE}
      MARIADB_USER: ${MARIADB_USER}
      MARIADB_PASSWORD: ${MARIADB_PASSWORD}
    
    ports:
      - "3306:3306"
    
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./mariadb/conf:/etc/mysql/conf.d:ro
      - ./mariadb/init:/docker-entrypoint-initdb.d:ro
    
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

volumes:
  mariadb_data:
    driver: local
```

### Fichier .env

```bash
# MariaDB Configuration
MARIADB_ROOT_PASSWORD=dev_root_password
MARIADB_DATABASE=myapp_dev
MARIADB_USER=app_user
MARIADB_PASSWORD=dev_password

# Application
APP_ENV=development
APP_PORT=8080
```

### Fichier .env.example

```bash
# Copier ce fichier en .env et remplir les valeurs

# MariaDB Configuration
MARIADB_ROOT_PASSWORD=change_me
MARIADB_DATABASE=myapp
MARIADB_USER=app_user
MARIADB_PASSWORD=change_me

# Application
APP_ENV=development
APP_PORT=8080
```

### Commandes de base

```bash
# D√©marrer la stack
docker compose up -d

# Voir les logs
docker compose logs -f mariadb

# Arr√™ter la stack
docker compose down

# Arr√™ter et supprimer les volumes
docker compose down -v

# Red√©marrer un service
docker compose restart mariadb

# Rebuild et red√©marrer
docker compose up -d --build

# Ex√©cuter une commande
docker compose exec mariadb mariadb -uroot -p
```

---

## Stack compl√®te Application + MariaDB

### docker-compose.yml multi-services

```yaml
version: '3.8'

services:
  # MariaDB Database
  mariadb:
    image: mariadb:11.8
    container_name: myapp-mariadb
    restart: unless-stopped
    
    environment:
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}
      MARIADB_DATABASE: ${MARIADB_DATABASE}
      MARIADB_USER: ${MARIADB_USER}
      MARIADB_PASSWORD: ${MARIADB_PASSWORD}
      # üÜï MariaDB 11.8 - TLS configuration
      MARIADB_INITDB_SKIP_TZINFO: "yes"
    
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --max-connections=200
      - --innodb-buffer-pool-size=1G
      - --innodb-log-file-size=256M
    
    ports:
      - "3306:3306"
    
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./mariadb/conf:/etc/mysql/conf.d:ro
      - ./mariadb/init:/docker-entrypoint-initdb.d:ro
      - ./mariadb/backup:/backup
    
    networks:
      - backend
    
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    
    # Limites de ressources
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

  # Application Backend
  app:
    build:
      context: ./app
      dockerfile: Dockerfile
      args:
        NODE_ENV: ${APP_ENV}
    container_name: myapp-backend
    restart: unless-stopped
    
    environment:
      NODE_ENV: ${APP_ENV}
      DATABASE_URL: mysql://${MARIADB_USER}:${MARIADB_PASSWORD}@mariadb:3306/${MARIADB_DATABASE}
      PORT: ${APP_PORT}
    
    ports:
      - "${APP_PORT}:${APP_PORT}"
    
    volumes:
      - ./app/src:/app/src:ro
      - /app/node_modules  # Anonymous volume pour node_modules
    
    networks:
      - backend
      - frontend
    
    depends_on:
      mariadb:
        condition: service_healthy
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${APP_PORT}/health"]
      interval: 30s
      timeout: 5s
      retries: 3

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: myapp-nginx
    restart: unless-stopped
    
    ports:
      - "80:80"
      - "443:443"
    
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    
    networks:
      - frontend
    
    depends_on:
      - app

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: myapp-redis
    restart: unless-stopped
    
    command: redis-server --appendonly yes
    
    volumes:
      - redis_data:/data
    
    networks:
      - backend
    
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # phpMyAdmin (optionnel, dev uniquement)
  phpmyadmin:
    image: phpmyadmin:latest
    container_name: myapp-phpmyadmin
    restart: unless-stopped
    
    environment:
      PMA_HOST: mariadb
      PMA_PORT: 3306
      PMA_USER: root
      PMA_PASSWORD: ${MARIADB_ROOT_PASSWORD}
      UPLOAD_LIMIT: 100M
    
    ports:
      - "8081:80"
    
    networks:
      - backend
    
    depends_on:
      mariadb:
        condition: service_healthy
    
    profiles:
      - dev  # Activ√© uniquement avec --profile dev

networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge
    internal: false  # Acc√®s internet pour mises √† jour

volumes:
  mariadb_data:
    driver: local
  redis_data:
    driver: local
```

### Configuration MariaDB personnalis√©e

```ini
# mariadb/conf/custom.cnf
[mysqld]
# üÜï MariaDB 11.8 - Character set
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

# InnoDB Configuration
innodb_buffer_pool_size = 1G
innodb_log_file_size = 256M
innodb_flush_method = O_DIRECT
innodb_flush_log_at_trx_commit = 2

# üÜï MariaDB 11.8 - ALTER TABLE optimizations
innodb_alter_copy_bulk = 256M

# Connection settings
max_connections = 200
max_connect_errors = 1000000

# Query cache (disabled in 11.x)
query_cache_type = 0
query_cache_size = 0

# Logging
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow-query.log
long_query_time = 2

# üÜï MariaDB 11.8 - Temp space control
max_tmp_space_usage = 5G

# Binary logs (for backup/replication)
log_bin = /var/log/mysql/mariadb-bin
binlog_format = ROW
expire_logs_days = 7

[client]
default-character-set = utf8mb4
```

### Scripts d'initialisation

```sql
-- mariadb/init/01-schema.sql
CREATE TABLE IF NOT EXISTS users (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(255) NOT NULL UNIQUE,
    email VARCHAR(255) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_username (username),
    INDEX idx_email (email)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE IF NOT EXISTS sessions (
    id CHAR(36) PRIMARY KEY,
    user_id BIGINT UNSIGNED NOT NULL,
    token VARCHAR(255) NOT NULL UNIQUE,
    data JSON,
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_token (token),
    INDEX idx_expires (expires_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- üÜï MariaDB 11.8 - Application Time Period Table
CREATE TABLE IF NOT EXISTS products (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    valid_from TIMESTAMP(6) GENERATED ALWAYS AS ROW START,
    valid_to TIMESTAMP(6) GENERATED ALWAYS AS ROW END,
    PERIOD FOR SYSTEM_TIME(valid_from, valid_to)
) ENGINE=InnoDB WITH SYSTEM VERSIONING;
```

```sql
-- mariadb/init/02-data.sql
-- Donn√©es de d√©veloppement
INSERT INTO users (username, email, password_hash) VALUES
    ('admin', 'admin@example.com', '$2y$10$...'),
    ('user1', 'user1@example.com', '$2y$10$...'),
    ('user2', 'user2@example.com', '$2y$10$...');

INSERT INTO products (name, price) VALUES
    ('Product A', 19.99),
    ('Product B', 29.99),
    ('Product C', 39.99);
```

```bash
#!/bin/bash
# mariadb/init/03-users.sh
set -e

echo "Creating additional users..."

mariadb -uroot -p"${MARIADB_ROOT_PASSWORD}" <<-EOSQL
    -- Utilisateur read-only
    CREATE USER IF NOT EXISTS 'readonly'@'%' IDENTIFIED BY 'readonly_password';
    GRANT SELECT ON ${MARIADB_DATABASE}.* TO 'readonly'@'%';
    
    -- Utilisateur backup
    CREATE USER IF NOT EXISTS 'backup'@'%' IDENTIFIED BY 'backup_password';
    GRANT SELECT, RELOAD, LOCK TABLES, REPLICATION CLIENT ON *.* TO 'backup'@'%';
    
    FLUSH PRIVILEGES;
EOSQL

echo "Additional users created!"
```

---

## R√©plication Master-Slave avec Docker Compose

### docker-compose-replication.yml

```yaml
version: '3.8'

services:
  # MariaDB Primary (Master)
  mariadb-primary:
    image: mariadb:11.8
    container_name: mariadb-primary
    restart: unless-stopped
    
    environment:
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}
      MARIADB_DATABASE: ${MARIADB_DATABASE}
      MARIADB_USER: ${MARIADB_USER}
      MARIADB_PASSWORD: ${MARIADB_PASSWORD}
      MARIADB_REPLICATION_MODE: master
      MARIADB_REPLICATION_USER: repl_user
      MARIADB_REPLICATION_PASSWORD: ${REPLICATION_PASSWORD}
    
    command:
      - --server-id=1
      - --log-bin=mariadb-bin
      - --binlog-format=ROW
      - --gtid-strict-mode=1
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    
    ports:
      - "3306:3306"
    
    volumes:
      - mariadb_primary_data:/var/lib/mysql
      - ./mariadb/conf/primary.cnf:/etc/mysql/conf.d/primary.cnf:ro
      - ./mariadb/init:/docker-entrypoint-initdb.d:ro
    
    networks:
      - mariadb_replication
    
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s

  # MariaDB Replica 1 (Slave)
  mariadb-replica-1:
    image: mariadb:11.8
    container_name: mariadb-replica-1
    restart: unless-stopped
    
    environment:
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}
      MARIADB_REPLICATION_MODE: slave
      MARIADB_MASTER_HOST: mariadb-primary
      MARIADB_MASTER_PORT: 3306
      MARIADB_MASTER_USER: repl_user
      MARIADB_MASTER_PASSWORD: ${REPLICATION_PASSWORD}
    
    command:
      - --server-id=2
      - --read-only=1
      - --log-bin=mariadb-bin
      - --binlog-format=ROW
      - --gtid-strict-mode=1
      - --character-set-server=utf8mb4
    
    ports:
      - "3307:3306"
    
    volumes:
      - mariadb_replica1_data:/var/lib/mysql
      - ./mariadb/conf/replica.cnf:/etc/mysql/conf.d/replica.cnf:ro
    
    networks:
      - mariadb_replication
    
    depends_on:
      mariadb-primary:
        condition: service_healthy
    
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 60s

  # MariaDB Replica 2 (Slave)
  mariadb-replica-2:
    image: mariadb:11.8
    container_name: mariadb-replica-2
    restart: unless-stopped
    
    environment:
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}
      MARIADB_REPLICATION_MODE: slave
      MARIADB_MASTER_HOST: mariadb-primary
      MARIADB_MASTER_PORT: 3306
      MARIADB_MASTER_USER: repl_user
      MARIADB_MASTER_PASSWORD: ${REPLICATION_PASSWORD}
    
    command:
      - --server-id=3
      - --read-only=1
      - --log-bin=mariadb-bin
      - --binlog-format=ROW
      - --gtid-strict-mode=1
      - --character-set-server=utf8mb4
    
    ports:
      - "3308:3306"
    
    volumes:
      - mariadb_replica2_data:/var/lib/mysql
      - ./mariadb/conf/replica.cnf:/etc/mysql/conf.d/replica.cnf:ro
    
    networks:
      - mariadb_replication
    
    depends_on:
      mariadb-primary:
        condition: service_healthy
    
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 60s

  # ProxySQL pour load balancing lecture/√©criture
  proxysql:
    image: proxysql/proxysql:latest
    container_name: proxysql
    restart: unless-stopped
    
    ports:
      - "6033:6033"  # Port MySQL
      - "6032:6032"  # Port Admin
    
    volumes:
      - ./proxysql/proxysql.cnf:/etc/proxysql.cnf:ro
    
    networks:
      - mariadb_replication
    
    depends_on:
      - mariadb-primary
      - mariadb-replica-1
      - mariadb-replica-2

networks:
  mariadb_replication:
    driver: bridge

volumes:
  mariadb_primary_data:
  mariadb_replica1_data:
  mariadb_replica2_data:
```

### Configuration de r√©plication

```ini
# mariadb/conf/primary.cnf
[mysqld]
# Server ID
server-id = 1

# Binary logging
log-bin = mariadb-bin
binlog-format = ROW
expire_logs_days = 7
max_binlog_size = 100M

# GTID
gtid_strict_mode = 1

# R√©plication
sync_binlog = 1
binlog_do_db = ${MARIADB_DATABASE}
```

```ini
# mariadb/conf/replica.cnf
[mysqld]
# Read-only
read_only = 1
super_read_only = 1

# Relay logs
relay-log = relay-bin
relay-log-index = relay-bin.index

# GTID
gtid_strict_mode = 1

# Crash safety
relay_log_recovery = 1
relay_log_purge = 1
```

### Script d'initialisation de la r√©plication

```bash
#!/bin/bash
# scripts/setup-replication.sh

set -e

echo "Waiting for primary to be ready..."
until docker compose exec -T mariadb-primary mariadb -uroot -p"${MARIADB_ROOT_PASSWORD}" -e "SELECT 1" &> /dev/null; do
    sleep 2
done

echo "Creating replication user on primary..."
docker compose exec -T mariadb-primary mariadb -uroot -p"${MARIADB_ROOT_PASSWORD}" <<-EOSQL
    CREATE USER IF NOT EXISTS 'repl_user'@'%' IDENTIFIED BY '${REPLICATION_PASSWORD}';
    GRANT REPLICATION SLAVE ON *.* TO 'repl_user'@'%';
    FLUSH PRIVILEGES;
EOSQL

echo "Getting primary status..."
PRIMARY_STATUS=$(docker compose exec -T mariadb-primary mariadb -uroot -p"${MARIADB_ROOT_PASSWORD}" -e "SHOW MASTER STATUS\G")
BINLOG_FILE=$(echo "$PRIMARY_STATUS" | grep "File:" | awk '{print $2}')
BINLOG_POS=$(echo "$PRIMARY_STATUS" | grep "Position:" | awk '{print $2}')

echo "Configuring replicas..."
for replica in mariadb-replica-1 mariadb-replica-2; do
    echo "Configuring $replica..."
    docker compose exec -T "$replica" mariadb -uroot -p"${MARIADB_ROOT_PASSWORD}" <<-EOSQL
        STOP SLAVE;
        CHANGE MASTER TO
            MASTER_HOST='mariadb-primary',
            MASTER_PORT=3306,
            MASTER_USER='repl_user',
            MASTER_PASSWORD='${REPLICATION_PASSWORD}',
            MASTER_LOG_FILE='${BINLOG_FILE}',
            MASTER_LOG_POS=${BINLOG_POS},
            MASTER_USE_GTID=current_pos;
        START SLAVE;
EOSQL
done

echo "Replication setup complete!"
echo "Check status with: docker compose exec mariadb-replica-1 mariadb -uroot -p -e 'SHOW SLAVE STATUS\G'"
```

---

## Stack avec monitoring (Prometheus + Grafana)

### docker-compose-monitoring.yml

```yaml
version: '3.8'

services:
  mariadb:
    image: mariadb:11.8
    container_name: mariadb
    restart: unless-stopped
    
    environment:
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}
      MARIADB_DATABASE: ${MARIADB_DATABASE}
      MARIADB_USER: ${MARIADB_USER}
      MARIADB_PASSWORD: ${MARIADB_PASSWORD}
    
    ports:
      - "3306:3306"
    
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./mariadb/conf:/etc/mysql/conf.d:ro
    
    networks:
      - monitoring
    
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect"]
      interval: 10s
      timeout: 5s
      retries: 3

  # MySQL Exporter pour Prometheus
  mysqld-exporter:
    image: prom/mysqld-exporter:latest
    container_name: mysqld-exporter
    restart: unless-stopped
    
    environment:
      DATA_SOURCE_NAME: "exporter:${EXPORTER_PASSWORD}@(mariadb:3306)/"
    
    ports:
      - "9104:9104"
    
    networks:
      - monitoring
    
    depends_on:
      mariadb:
        condition: service_healthy
    
    command:
      - --collect.info_schema.processlist
      - --collect.info_schema.innodb_metrics
      - --collect.info_schema.tablestats
      - --collect.info_schema.tables
      - --collect.info_schema.userstats
      - --collect.engine_innodb_status
      - --collect.perf_schema.file_events
      - --collect.perf_schema.eventswaits
      - --collect.perf_schema.indexiowaits
      - --collect.perf_schema.tableiowaits
      - --collect.slave_status

  # Prometheus
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    
    ports:
      - "9090:9090"
    
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/prometheus/alerts:/etc/prometheus/alerts:ro
      - prometheus_data:/prometheus
    
    networks:
      - monitoring
    
    depends_on:
      - mysqld-exporter

  # Grafana
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_USER}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD}
      GF_INSTALL_PLUGINS: grafana-piechart-panel
    
    ports:
      - "3000:3000"
    
    volumes:
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro
      - grafana_data:/var/lib/grafana
    
    networks:
      - monitoring
    
    depends_on:
      - prometheus

  # AlertManager (optionnel)
  alertmanager:
    image: prom/alertmanager:latest
    container_name: alertmanager
    restart: unless-stopped
    
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
    
    ports:
      - "9093:9093"
    
    volumes:
      - ./monitoring/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager_data:/alertmanager
    
    networks:
      - monitoring

networks:
  monitoring:
    driver: bridge

volumes:
  mariadb_data:
  prometheus_data:
  grafana_data:
  alertmanager_data:
```

### Configuration Prometheus

```yaml
# monitoring/prometheus/prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'docker-compose'
    replica: '1'

# Alerting configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - alertmanager:9093

# Load rules
rule_files:
  - '/etc/prometheus/alerts/*.yml'

# Scrape configurations
scrape_configs:
  # MariaDB Exporter
  - job_name: 'mariadb'
    static_configs:
      - targets: ['mysqld-exporter:9104']
        labels:
          instance: 'mariadb-primary'
          environment: 'development'
  
  # Prometheus self-monitoring
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
```

### R√®gles d'alerting

```yaml
# monitoring/prometheus/alerts/mariadb-alerts.yml
groups:
  - name: mariadb_alerts
    interval: 30s
    rules:
      # Instance down
      - alert: MariaDBDown
        expr: mysql_up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "MariaDB instance {{ $labels.instance }} is down"
          description: "MariaDB instance has been down for more than 1 minute"
      
      # Trop de connexions
      - alert: MariaDBTooManyConnections
        expr: (mysql_global_status_threads_connected / mysql_global_variables_max_connections) > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "MariaDB {{ $labels.instance }} has too many connections"
          description: "More than 80% of connections are in use (current: {{ $value | humanizePercentage }})"
      
      # Slow queries
      - alert: MariaDBSlowQueries
        expr: rate(mysql_global_status_slow_queries[5m]) > 10
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High rate of slow queries on {{ $labels.instance }}"
          description: "Slow queries rate: {{ $value }} queries/sec"
      
      # R√©plication lag
      - alert: MariaDBReplicationLag
        expr: mysql_slave_status_seconds_behind_master > 30
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Replication lag on {{ $labels.instance }}"
          description: "Replication is {{ $value }} seconds behind master"
      
      # InnoDB buffer pool efficiency
      - alert: MariaDBLowBufferPoolEfficiency
        expr: (mysql_global_status_innodb_buffer_pool_read_requests / (mysql_global_status_innodb_buffer_pool_read_requests + mysql_global_status_innodb_buffer_pool_reads)) < 0.95
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "Low InnoDB buffer pool efficiency on {{ $labels.instance }}"
          description: "Buffer pool read efficiency is {{ $value | humanizePercentage }}"
```

### Dashboard Grafana

```yaml
# monitoring/grafana/datasources/prometheus.yml
apiVersion: 1

datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    url: http://prometheus:9090
    isDefault: true
    editable: true
```

üí° **Conseil** : Importez des dashboards Grafana communautaires pour MariaDB (ID: 7362, 11323).

---

## Gestion de multiples environnements

### docker-compose.override.yml (local)

```yaml
# Ce fichier est automatiquement charg√© par docker compose
# Utilis√© pour surcharger les configurations en local
version: '3.8'

services:
  mariadb:
    # Ports diff√©rents pour √©viter les conflits
    ports:
      - "3307:3306"
    
    # Volumes en mode writable pour tests
    volumes:
      - ./mariadb/init:/docker-entrypoint-initdb.d:rw
    
    # D√©sactiver les limites de ressources en local
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G

  app:
    # Hot reload pour d√©veloppement
    volumes:
      - ./app/src:/app/src
    
    # Variables d'environnement de debug
    environment:
      DEBUG: "true"
      LOG_LEVEL: debug

  # Activer phpMyAdmin en local
  phpmyadmin:
    profiles: []  # Toujours actif en local
```

### docker-compose.ci.yml (CI/CD)

```yaml
# Configuration pour CI/CD
version: '3.8'

services:
  mariadb:
    # Image sp√©cifique pour tests
    image: mariadb:11.8
    
    # Pas de ports expos√©s
    ports: []
    
    # Volume temporaire
    volumes:
      - /var/lib/mysql  # Anonymous volume
    
    # Optimisations pour rapidit√©
    command:
      - --skip-innodb-doublewrite
      - --innodb-flush-log-at-trx-commit=0
      - --sync-binlog=0
    
    # Healthcheck plus rapide
    healthcheck:
      interval: 5s
      timeout: 2s
      retries: 5
      start_period: 10s

  app:
    # Build depuis CI
    build:
      context: .
      target: test
    
    environment:
      CI: "true"
      NODE_ENV: test
```

### docker-compose.prod.yml (staging/production)

```yaml
# Configuration pour production (exemple, utilisez K8s en prod r√©elle)
version: '3.8'

services:
  mariadb:
    # Image avec tag pr√©cis
    image: mariadb:11.8.1
    
    # Restart policy strict
    restart: always
    
    # Pas de ports expos√©s (via r√©seau interne uniquement)
    ports: []
    
    # Volumes nomm√©s avec backup
    volumes:
      - mariadb_prod_data:/var/lib/mysql
      - /backup/mariadb:/backup:rw
    
    # Configuration production
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --max-connections=500
      - --innodb-buffer-pool-size=8G
      - --innodb-log-file-size=1G
    
    # Limites strictes
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 12G
        reservations:
          cpus: '2'
          memory: 8G
    
    # Healthcheck production
    healthcheck:
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  mariadb_prod_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/data/mariadb
```

### Utilisation des diff√©rents environnements

```bash
# D√©veloppement local (compose.yml + compose.override.yml)
docker compose up -d

# CI/CD
docker compose -f docker-compose.yml -f docker-compose.ci.yml up --abort-on-container-exit

# Staging
docker compose -f docker-compose.yml -f docker-compose.prod.yml --env-file .env.staging up -d

# Production (exemple, pr√©f√©rez K8s)
docker compose -f docker-compose.yml -f docker-compose.prod.yml --env-file .env.production up -d
```

---

## Patterns avanc√©s

### 1. Init containers pattern

```yaml
services:
  # Container d'initialisation
  mariadb-init:
    image: mariadb:11.8
    container_name: mariadb-init
    
    environment:
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}
    
    volumes:
      - mariadb_data:/var/lib/mysql
      - ./scripts/init-data.sh:/init.sh:ro
    
    command: /init.sh
    
    networks:
      - backend
    
    restart: "no"  # Run once

  # MariaDB principal
  mariadb:
    image: mariadb:11.8
    container_name: mariadb
    
    volumes:
      - mariadb_data:/var/lib/mysql
    
    depends_on:
      mariadb-init:
        condition: service_completed_successfully
```

### 2. Sidecar pattern (backup automatique)

```yaml
services:
  mariadb:
    image: mariadb:11.8
    # ... configuration standard
  
  # Sidecar de backup
  mariadb-backup:
    image: mariadb:11.8
    container_name: mariadb-backup
    
    environment:
      MARIADB_HOST: mariadb
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}
      BACKUP_SCHEDULE: "0 2 * * *"  # Tous les jours √† 2h
    
    volumes:
      - ./scripts/backup-cron.sh:/backup.sh:ro
      - ./backups:/backups
    
    entrypoint: /backup.sh
    
    networks:
      - backend
    
    depends_on:
      mariadb:
        condition: service_healthy
```

```bash
#!/bin/bash
# scripts/backup-cron.sh
while true; do
    echo "Running backup at $(date)"
    
    mariadb-dump \
        -h"${MARIADB_HOST}" \
        -uroot \
        -p"${MARIADB_ROOT_PASSWORD}" \
        --all-databases \
        --single-transaction \
        --routines \
        --triggers \
        | gzip > "/backups/backup-$(date +%Y%m%d-%H%M%S).sql.gz"
    
    # Rotation : garder 7 jours
    find /backups -name "backup-*.sql.gz" -mtime +7 -delete
    
    # Attendre jusqu'au prochain backup (24h)
    sleep 86400
done
```

### 3. Service discovery avec DNS

```yaml
services:
  mariadb-primary:
    # ... config
    networks:
      - db
  
  mariadb-replica:
    # ... config
    networks:
      - db
  
  app:
    environment:
      # Utiliser le DNS Docker pour la d√©couverte
      DB_PRIMARY: mariadb-primary:3306
      DB_REPLICA: mariadb-replica:3306
    networks:
      - db

networks:
  db:
    driver: bridge
    # DNS automatique : les noms de services sont r√©solvables
```

### 4. Secrets avec Docker Compose

```yaml
version: '3.8'

services:
  mariadb:
    image: mariadb:11.8
    
    secrets:
      - mariadb_root_password
      - mariadb_user_password
    
    environment:
      MARIADB_ROOT_PASSWORD_FILE: /run/secrets/mariadb_root_password
      MARIADB_DATABASE: myapp
      MARIADB_USER: appuser
      MARIADB_PASSWORD_FILE: /run/secrets/mariadb_user_password

secrets:
  mariadb_root_password:
    file: ./secrets/root_password.txt
  mariadb_user_password:
    file: ./secrets/user_password.txt
```

```bash
# Cr√©er les secrets
mkdir -p secrets
echo "SuperSecureRootPassword" > secrets/root_password.txt
echo "AppUserPassword" > secrets/user_password.txt
chmod 600 secrets/*.txt

# Ajouter au .gitignore
echo "secrets/" >> .gitignore
```

---

## Debugging et troubleshooting

### Commandes utiles

```bash
# Voir l'√©tat des services
docker compose ps

# Logs d'un service
docker compose logs -f mariadb

# Logs avec timestamps
docker compose logs -f --timestamps mariadb

# Ex√©cuter une commande dans un conteneur
docker compose exec mariadb mariadb -uroot -p

# Shell dans un conteneur
docker compose exec mariadb bash

# Inspecter la configuration
docker compose config

# Valider la configuration
docker compose config --quiet

# Voir les volumes
docker compose volume ls

# Voir les r√©seaux
docker compose network ls

# Stats en temps r√©el
docker stats $(docker compose ps -q)
```

### Probl√®mes courants

#### 1. MariaDB ne d√©marre pas

```bash
# V√©rifier les logs
docker compose logs mariadb

# Erreurs communes :
# - Mot de passe manquant : v√©rifier .env
# - Port d√©j√† utilis√© : changer le port mapping
# - Permissions volume : chown -R 999:999 volume_path
# - Fichier de config invalide : valider la syntaxe
```

#### 2. R√©plication ne fonctionne pas

```bash
# V√©rifier le statut de la r√©plication
docker compose exec mariadb-replica mariadb -uroot -p -e "SHOW SLAVE STATUS\G"

# Points √† v√©rifier :
# - Slave_IO_Running: Yes
# - Slave_SQL_Running: Yes
# - Seconds_Behind_Master: <10
# - Last_Error: (vide)

# Red√©marrer la r√©plication
docker compose exec mariadb-replica mariadb -uroot -p <<EOF
STOP SLAVE;
RESET SLAVE;
CHANGE MASTER TO ...;
START SLAVE;
EOF
```

#### 3. Connexion refus√©e

```bash
# V√©rifier le r√©seau
docker compose exec app ping mariadb

# V√©rifier les ports
docker compose port mariadb 3306

# V√©rifier le healthcheck
docker compose ps mariadb

# Tester la connexion
docker compose exec mariadb mariadb -uroot -p -e "SELECT 1"
```

#### 4. Performance lente

```bash
# V√©rifier les ressources
docker stats mariadb

# V√©rifier les slow queries
docker compose exec mariadb cat /var/log/mysql/slow-query.log

# Analyser avec pt-query-digest
docker compose exec mariadb pt-query-digest /var/log/mysql/slow-query.log
```

---

## CI/CD avec Docker Compose

### GitLab CI exemple

```yaml
# .gitlab-ci.yml
stages:
  - test
  - build

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

services:
  - docker:dind

before_script:
  - docker compose version

test:
  stage: test
  image: docker/compose:latest
  script:
    # D√©marrer les services
    - docker compose -f docker-compose.yml -f docker-compose.ci.yml up -d
    
    # Attendre que MariaDB soit pr√™t
    - timeout 60 sh -c 'until docker compose exec -T mariadb mariadb -uroot -p${MARIADB_ROOT_PASSWORD} -e "SELECT 1"; do sleep 2; done'
    
    # Ex√©cuter les migrations
    - docker compose exec -T app npm run migrate
    
    # Ex√©cuter les tests
    - docker compose exec -T app npm test
    
    # Nettoyer
    - docker compose down -v
  
  after_script:
    - docker compose logs mariadb
  
  only:
    - merge_requests
    - main

build:
  stage: build
  image: docker:latest
  script:
    - docker build -t myapp:${CI_COMMIT_SHA} .
    - docker tag myapp:${CI_COMMIT_SHA} myapp:latest
    - docker push myapp:${CI_COMMIT_SHA}
    - docker push myapp:latest
  only:
    - main
```

### GitHub Actions exemple

```yaml
# .github/workflows/test.yml
name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Create .env file
        run: |
          cat > .env << EOF
          MARIADB_ROOT_PASSWORD=test_root
          MARIADB_DATABASE=test_db
          MARIADB_USER=test_user
          MARIADB_PASSWORD=test_pass
          EOF
      
      - name: Start services
        run: docker compose -f docker-compose.yml -f docker-compose.ci.yml up -d
      
      - name: Wait for MariaDB
        run: |
          timeout 60 bash -c 'until docker compose exec -T mariadb mariadb -uroot -ptest_root -e "SELECT 1"; do sleep 2; done'
      
      - name: Run migrations
        run: docker compose exec -T app npm run migrate
      
      - name: Run tests
        run: docker compose exec -T app npm test
      
      - name: Show logs
        if: failure()
        run: docker compose logs
      
      - name: Cleanup
        if: always()
        run: docker compose down -v
```

---

## Bonnes pratiques

### 1. Structuration

‚úÖ **DO** :
- Un fichier `docker-compose.yml` pour la base
- `docker-compose.override.yml` pour le local (gitignore)
- Fichiers s√©par√©s pour chaque environnement
- Variables dans `.env` (gitignore) avec `.env.example`
- Scripts d'initialisation dans des dossiers d√©di√©s

‚ùå **DON'T** :
- Tout dans un seul fichier
- Hardcoder les secrets
- Committer les fichiers `.env`
- M√©langer dev et prod dans le m√™me fichier

### 2. S√©curit√©

```yaml
# ‚úÖ GOOD
services:
  mariadb:
    environment:
      MARIADB_ROOT_PASSWORD_FILE: /run/secrets/db_root_password
    secrets:
      - db_root_password
    # Pas d'exposition de ports en prod
    ports: []

# ‚ùå BAD
services:
  mariadb:
    environment:
      MARIADB_ROOT_PASSWORD: "hardcoded_password"
    ports:
      - "3306:3306"  # Expos√© sur 0.0.0.0
```

### 3. Volumes

```yaml
# ‚úÖ GOOD - Volumes nomm√©s
volumes:
  mariadb_data:
    driver: local

# ‚úÖ GOOD - Bind mounts read-only pour configs
volumes:
  - ./mariadb/conf:/etc/mysql/conf.d:ro

# ‚ùå BAD - Bind mount du datadir (probl√®mes de permissions)
volumes:
  - ./data:/var/lib/mysql
```

### 4. Healthchecks

```yaml
# ‚úÖ GOOD - Healthcheck d√©taill√©
healthcheck:
  test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
  interval: 10s
  timeout: 5s
  retries: 3
  start_period: 30s

# ‚ùå BAD - Pas de healthcheck ou trop simple
healthcheck:
  test: ["CMD", "true"]
```

### 5. Dependencies

```yaml
# ‚úÖ GOOD - D√©pendances avec conditions
services:
  app:
    depends_on:
      mariadb:
        condition: service_healthy

# ‚ùå BAD - D√©pendance simple (d√©marre avant, pas de garantie de ready)
services:
  app:
    depends_on:
      - mariadb
```

---

## ‚úÖ Points cl√©s √† retenir

- **Reproductibilit√©** : Docker Compose garantit des environnements identiques partout
- **Fichiers multiples** : Utilisez plusieurs fichiers compose pour diff√©rents environnements
- **Secrets** : Ne committez JAMAIS les `.env`, utilisez `.env.example` comme template
- **Healthchecks** : Impl√©mentez des healthchecks robustes pour orchestrer les d√©pendances
- **Volumes nomm√©s** : Pr√©f√©rez les volumes nomm√©s aux bind mounts pour les donn√©es
- **Networks** : Utilisez des r√©seaux s√©par√©s (frontend/backend) pour l'isolation
- **CI/CD** : Docker Compose est parfait pour les tests d'int√©gration
- **Monitoring** : Int√©grez Prometheus/Grafana pour observer vos stacks locales
- **Production** : Docker Compose n'est **pas pour la production**, utilisez Kubernetes
- **MariaDB 11.8** : Profitez des nouveaut√©s (utf8mb4, Vector, optimisations SSD)

---

## üîó Ressources et r√©f√©rences

### Documentation officielle
- [üìñ Docker Compose Documentation](https://docs.docker.com/compose/)
- [üìñ Compose File Reference](https://docs.docker.com/compose/compose-file/)
- [üìñ MariaDB Docker Hub](https://hub.docker.com/_/mariadb)
- [üìñ Networking in Compose](https://docs.docker.com/compose/networking/)

### Exemples et templates
- [Awesome Compose](https://github.com/docker/awesome-compose) - Exemples officiels
- [MariaDB Compose Examples](https://github.com/docker-library/docs/tree/master/mariadb)

### Outils compl√©mentaires
- [docker-compose-viz](https://github.com/pmsipilot/docker-compose-viz) - Visualisation
- [ctop](https://github.com/bcicen/ctop) - Top pour conteneurs
- [lazydocker](https://github.com/jesseduffield/lazydocker) - TUI pour Docker

---

## ‚û°Ô∏è Section suivante

**16.4 Orchestration avec Kubernetes** : D√©couvrez comment d√©ployer MariaDB en production avec Kubernetes, StatefulSets, PersistentVolumes et operators.

---

**MariaDB** : 11.8 LTS

‚è≠Ô∏è [Volumes et persistance](/16-devops-automatisation/03.3-volumes-persistance.md)
