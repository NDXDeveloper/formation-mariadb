ğŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 16.8.1 Flyway - Gestion des migrations de bases de donnÃ©es

> **Niveau** : AvancÃ© Ã  Expert  
> **DurÃ©e estimÃ©e** : 3-4 heures  
> **PrÃ©requis** : SQL avancÃ©, CI/CD, Docker, Kubernetes basics, Git

## ğŸ¯ Objectifs d'apprentissage

Ã€ l'issue de cette section, vous serez capable de :
- ImplÃ©menter Flyway pour gÃ©rer les migrations de schÃ©ma MariaDB de maniÃ¨re versionnÃ©e
- Configurer Flyway dans un pipeline CI/CD pour dÃ©ploiements automatisÃ©s
- Orchestrer les migrations dans Kubernetes avec Jobs et Init Containers
- Mettre en place une stratÃ©gie GitOps pour les changements de schÃ©ma
- GÃ©rer les rollbacks, hotfixes et branches de dÃ©veloppement avec Flyway
- IntÃ©grer Flyway dans une architecture microservices
- Configurer les callbacks et hooks pour validation prÃ©/post-migration
- Monitorer l'Ã©tat des migrations et dÃ©tecter les dÃ©rives de schÃ©ma

---

## Introduction

**Flyway** est un outil open-source de migration de bases de donnÃ©es qui suit le principe du **versioning de schÃ©ma** (Database Schema Migration). Il permet de :

- Versionner les changements de schÃ©ma comme du code (Infrastructure as Code)
- Automatiser l'application des migrations dans les environnements (dev, staging, prod)
- Garantir la cohÃ©rence des schÃ©mas entre environnements
- Tracer l'historique complet des modifications
- Faciliter les dÃ©ploiements continus et le GitOps

### Pourquoi Flyway pour MariaDB ?

| Avantage | Description |
|----------|-------------|
| **Versioning explicite** | Chaque migration a un numÃ©ro de version (V1, V2, V3...) |
| **Idempotence** | Migrations dÃ©jÃ  appliquÃ©es ne sont jamais rejouÃ©es |
| **Rollback SQL** | Support des migrations Undo (version Teams) |
| **Validation** | DÃ©tection des modifications non autorisÃ©es du schÃ©ma |
| **SimplicitÃ©** | Migrations en SQL pur, pas de DSL propriÃ©taire |
| **IntÃ©gration** | Maven, Gradle, Docker, CI/CD, Kubernetes |
| **MariaDB natif** | Support complet MariaDB 10.x et 11.x |

ğŸ’¡ **Conseil** : Flyway est idÃ©al pour des migrations SQL pures et versionnÃ©es. Pour des migrations complexes nÃ©cessitant du code applicatif, considÃ©rez Liquibase. Pour des changements sans downtime sur grosses tables, prÃ©fÃ©rez gh-ost/pt-osc (section 16.8.3).

---

## Architecture et concepts Flyway

### ModÃ¨le de versioning

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Flyway Migration Lifecycle                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  Version Control (Git)                                  â”‚
â”‚  â”œâ”€â”€ V1__Create_users_table.sql                         â”‚
â”‚  â”œâ”€â”€ V2__Add_email_column.sql                           â”‚
â”‚  â”œâ”€â”€ V3__Create_orders_table.sql                        â”‚
â”‚  â””â”€â”€ V4__Add_index_on_email.sql                         â”‚
â”‚                â”‚                                        â”‚
â”‚                â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚   Flyway CLI / Docker       â”‚                        â”‚
â”‚  â”‚   flyway migrate            â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                â”‚                                        â”‚
â”‚                â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚          MariaDB Database                   â”‚        â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚        â”‚
â”‚  â”‚  â”‚  flyway_schema_history table        â”‚    â”‚        â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚        â”‚
â”‚  â”‚  â”‚ version      â”‚ script   â”‚ success   â”‚    â”‚        â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚        â”‚
â”‚  â”‚  â”‚ 1            â”‚ V1__...  â”‚ true      â”‚    â”‚        â”‚
â”‚  â”‚  â”‚ 2            â”‚ V2__...  â”‚ true      â”‚    â”‚        â”‚
â”‚  â”‚  â”‚ 3            â”‚ V3__...  â”‚ true      â”‚    â”‚        â”‚
â”‚  â”‚  â”‚ 4            â”‚ V4__...  â”‚ true      â”‚    â”‚        â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚        â”‚
â”‚  â”‚                                             â”‚        â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚        â”‚
â”‚  â”‚  â”‚   Application Schema                â”‚    â”‚        â”‚
â”‚  â”‚  â”‚   - users (id, name, email)         â”‚    â”‚        â”‚
â”‚  â”‚  â”‚   - orders (id, user_id, ...)       â”‚    â”‚        â”‚
â”‚  â”‚  â”‚   - indexes                         â”‚    â”‚        â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Table flyway_schema_history

Flyway crÃ©e automatiquement une table de mÃ©tadonnÃ©es :

```sql
-- Structure de flyway_schema_history
CREATE TABLE flyway_schema_history (
    installed_rank INT NOT NULL PRIMARY KEY,
    version VARCHAR(50),
    description VARCHAR(200) NOT NULL,
    type VARCHAR(20) NOT NULL,
    script VARCHAR(1000) NOT NULL,
    checksum INT,
    installed_by VARCHAR(100) NOT NULL,
    installed_on TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    execution_time INT NOT NULL,
    success BOOLEAN NOT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- Index pour performance
CREATE INDEX flyway_schema_history_s_idx ON flyway_schema_history (success);
```

### Convention de nommage des migrations

```
Prefix  Version    Separator  Description           Suffix
  â”‚        â”‚           â”‚            â”‚                  â”‚
  V     1.2.3         __      Create_users_table    .sql
  â”‚        â”‚           â”‚            â”‚                  â”‚
  â”‚        â”‚           â”‚            â””â”€ Snake_case ou CamelCase
  â”‚        â”‚           â””â”€ Double underscore (obligatoire)
  â”‚        â””â”€ Semantic versioning (1, 1.1, 1.2.3...)
  â””â”€ V = Versioned, R = Repeatable, U = Undo
```

**Exemples valides :**
```
V1__Initial_schema.sql
V2__Add_email_column.sql
V2.1__Fix_email_constraint.sql
V3__Create_orders_table.sql
V3.1.0__Add_order_status.sql
R__Create_view_active_users.sql  # Repeatable (toujours rejouÃ©)
U1__Undo_initial_schema.sql      # Undo (Flyway Teams uniquement)
```

---

## Installation et configuration

### 1. Installation via ligne de commande (local)

**Linux/macOS :**
```bash
# TÃ©lÃ©chargement binaire
wget -qO- https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/10.4.1/flyway-commandline-10.4.1-linux-x64.tar.gz | tar xvz

# Ajouter au PATH
sudo ln -s $(pwd)/flyway-10.4.1/flyway /usr/local/bin/flyway

# VÃ©rifier l'installation
flyway -v
# Flyway Community Edition 10.4.1 by Redgate
```

**Docker (recommandÃ©) :**
```bash
# Pull image officielle
docker pull flyway/flyway:10.4.1

# Alias pour utilisation simple
alias flyway='docker run --rm -v $(pwd)/sql:/flyway/sql flyway/flyway:10.4.1'

# Test
flyway -v
```

### 2. Configuration Flyway pour MariaDB

**Fichier flyway.conf :**
```ini
# ==============================================
# Flyway Configuration - MariaDB 11.8 LTS
# ==============================================

# --- Database Connection ---
flyway.url=jdbc:mariadb://mariadb-primary-svc.production.svc.cluster.local:3306/myapp_production
flyway.user=flyway_user
flyway.password=${FLYWAY_PASSWORD}

# Driver MariaDB (auto-dÃ©tectÃ©)
flyway.driver=org.mariadb.jdbc.Driver

# --- Migration Settings ---
# RÃ©pertoire des migrations SQL
flyway.locations=filesystem:./sql/migrations

# Table de mÃ©tadonnÃ©es
flyway.table=flyway_schema_history

# SchÃ©ma par dÃ©faut
flyway.defaultSchema=myapp_production

# --- Validation ---
# Valider les migrations avant exÃ©cution
flyway.validateOnMigrate=true

# DÃ©tecter les changements de checksum (modifications non autorisÃ©es)
flyway.validateMigrationNaming=true

# --- Baseline ---
# Version de baseline (pour bases existantes)
flyway.baselineVersion=0
flyway.baselineDescription=Initial baseline

# Baseline automatique sur DB non vide
flyway.baselineOnMigrate=true

# --- ExÃ©cution ---
# Sortie verbose
flyway.outOfOrder=false

# Ignorer les migrations manquantes (dangereux en prod!)
flyway.ignoreMissingMigrations=false

# Ignorer les migrations futures (permet rollback de version Flyway)
flyway.ignoreFutureMigrations=false

# --- Performance ---
# Batch SQL
flyway.batch=true

# Connexion pool (pour migrations lourdes)
flyway.connectRetries=3
flyway.connectRetriesInterval=10

# --- Placeholders (variables) ---
flyway.placeholders.environment=production
flyway.placeholders.app_user=myapp_user

# Activer le remplacement de placeholders
flyway.placeholderReplacement=true

# --- Callbacks ---
flyway.callbacks=com.myapp.db.FlywayCallbacks

# --- SÃ©curitÃ© ---
# Ne pas crÃ©er automatiquement le schÃ©ma (sÃ©curitÃ©)
flyway.createSchemas=false

# Lock timeout (Ã©viter deadlocks)
flyway.lockRetryCount=50
```

### 3. Configuration via variables d'environnement

```bash
# Variables d'environnement (prioritaires sur flyway.conf)
export FLYWAY_URL="jdbc:mariadb://localhost:3306/myapp"
export FLYWAY_USER="flyway_user"
export FLYWAY_PASSWORD="SecurePassword123!"
export FLYWAY_LOCATIONS="filesystem:./sql/migrations"
export FLYWAY_BASELINE_ON_MIGRATE=true

# ExÃ©cution
flyway migrate
```

### 4. Structure de projet recommandÃ©e

```
myapp-database/
â”œâ”€â”€ flyway.conf                    # Configuration principale
â”œâ”€â”€ flyway-dev.conf                # Override pour dev
â”œâ”€â”€ flyway-prod.conf               # Override pour production
â”œâ”€â”€ sql/
â”‚   â”œâ”€â”€ migrations/                # Migrations versionnÃ©es
â”‚   â”‚   â”œâ”€â”€ V1__Initial_schema.sql
â”‚   â”‚   â”œâ”€â”€ V2__Add_users_table.sql
â”‚   â”‚   â”œâ”€â”€ V3__Add_orders_table.sql
â”‚   â”‚   â””â”€â”€ V4__Create_indexes.sql
â”‚   â”œâ”€â”€ repeatable/                # Migrations rÃ©pÃ©tables (vues, procÃ©dures)
â”‚   â”‚   â”œâ”€â”€ R__View_active_users.sql
â”‚   â”‚   â””â”€â”€ R__Procedure_calculate_total.sql
â”‚   â””â”€â”€ callbacks/                 # Callbacks SQL
â”‚       â”œâ”€â”€ beforeMigrate.sql
â”‚       â””â”€â”€ afterMigrate.sql
â”œâ”€â”€ docker-compose.yml             # Test local avec MariaDB
â”œâ”€â”€ Dockerfile                     # Image Flyway personnalisÃ©e
â”œâ”€â”€ .gitignore
â””â”€â”€ README.md
```

---

## Migrations SQL versionnÃ©es

### 1. Migration initiale - CrÃ©ation de schÃ©ma

**V1__Initial_schema.sql :**
```sql
-- ============================================
-- Migration V1: Initial Database Schema
-- Author: DevOps Team
-- Date: 2025-01-15
-- Description: Create base tables for application
-- ============================================

-- Enable strict mode for data integrity
SET sql_mode = 'STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION';

-- Users table
CREATE TABLE users (
    id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    email VARCHAR(255) NOT NULL,
    username VARCHAR(100) NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    PRIMARY KEY (id),
    UNIQUE KEY uk_users_email (email),
    UNIQUE KEY uk_users_username (username),
    KEY idx_users_active (is_active, created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
COMMENT='Application users';

-- Roles table
CREATE TABLE roles (
    id INT UNSIGNED NOT NULL AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL,
    description TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    PRIMARY KEY (id),
    UNIQUE KEY uk_roles_name (name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- User-Role mapping
CREATE TABLE user_roles (
    user_id BIGINT UNSIGNED NOT NULL,
    role_id INT UNSIGNED NOT NULL,
    granted_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    granted_by BIGINT UNSIGNED,
    
    PRIMARY KEY (user_id, role_id),
    FOREIGN KEY fk_user_roles_user (user_id) 
        REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY fk_user_roles_role (role_id) 
        REFERENCES roles(id) ON DELETE CASCADE,
    FOREIGN KEY fk_user_roles_granted_by (granted_by) 
        REFERENCES users(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Insert default roles
INSERT INTO roles (name, description) VALUES
    ('admin', 'Administrator with full access'),
    ('user', 'Standard user'),
    ('guest', 'Guest with read-only access');

-- Audit log table
CREATE TABLE audit_logs (
    id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    user_id BIGINT UNSIGNED,
    action VARCHAR(50) NOT NULL,
    entity_type VARCHAR(50) NOT NULL,
    entity_id BIGINT UNSIGNED,
    details JSON,
    ip_address VARCHAR(45),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    PRIMARY KEY (id),
    KEY idx_audit_user (user_id, created_at),
    KEY idx_audit_entity (entity_type, entity_id),
    FOREIGN KEY fk_audit_user (user_id) 
        REFERENCES users(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
PARTITION BY RANGE (YEAR(created_at)) (
    PARTITION p2024 VALUES LESS THAN (2025),
    PARTITION p2025 VALUES LESS THAN (2026),
    PARTITION p2026 VALUES LESS THAN (2027),
    PARTITION pmax VALUES LESS THAN MAXVALUE
);
```

### 2. Migration additive - Ajout de colonne

**V2__Add_phone_to_users.sql :**
```sql
-- ============================================
-- Migration V2: Add phone number to users
-- Date: 2025-01-20
-- ============================================

-- Add phone column
ALTER TABLE users 
ADD COLUMN phone VARCHAR(20) AFTER email,
ADD COLUMN phone_verified BOOLEAN NOT NULL DEFAULT FALSE AFTER phone,
ADD COLUMN phone_verified_at TIMESTAMP NULL AFTER phone_verified;

-- Add index for phone lookups
ALTER TABLE users 
ADD INDEX idx_users_phone (phone);

-- Backfill data (if needed)
-- UPDATE users SET phone = NULL WHERE phone = '';

-- Add constraint (optional)
-- ALTER TABLE users 
-- ADD CONSTRAINT chk_users_phone_format 
-- CHECK (phone IS NULL OR phone REGEXP '^\\+?[1-9]\\d{1,14}$');
```

### 3. Migration avec donnÃ©es - Normalisation

**V3__Normalize_addresses.sql :**
```sql
-- ============================================
-- Migration V3: Normalize addresses to separate table
-- Date: 2025-01-25
-- ============================================

-- Create addresses table
CREATE TABLE addresses (
    id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
    user_id BIGINT UNSIGNED NOT NULL,
    address_type ENUM('billing', 'shipping', 'other') NOT NULL DEFAULT 'shipping',
    street_address VARCHAR(255) NOT NULL,
    city VARCHAR(100) NOT NULL,
    state_province VARCHAR(100),
    postal_code VARCHAR(20),
    country VARCHAR(2) NOT NULL,  -- ISO 3166-1 alpha-2
    is_default BOOLEAN NOT NULL DEFAULT FALSE,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    PRIMARY KEY (id),
    KEY idx_addresses_user (user_id, is_default),
    FOREIGN KEY fk_addresses_user (user_id) 
        REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Migrate existing address data (if columns exist)
-- INSERT INTO addresses (user_id, address_type, street_address, city, postal_code, country)
-- SELECT id, 'billing', billing_address, billing_city, billing_postal, 'US'
-- FROM users
-- WHERE billing_address IS NOT NULL;

-- Remove old columns (after data validation)
-- ALTER TABLE users 
-- DROP COLUMN billing_address,
-- DROP COLUMN billing_city,
-- DROP COLUMN billing_postal;
```

### 4. Migration avec rollback (Flyway Teams)

**V4__Add_subscription_tiers.sql :**
```sql
-- ============================================
-- Migration V4: Add subscription tiers
-- Date: 2025-02-01
-- Rollback: U4__Undo_subscription_tiers.sql
-- ============================================

CREATE TABLE subscription_tiers (
    id INT UNSIGNED NOT NULL AUTO_INCREMENT,
    name VARCHAR(50) NOT NULL,
    price_monthly DECIMAL(10, 2) NOT NULL,
    price_yearly DECIMAL(10, 2) NOT NULL,
    max_users INT UNSIGNED NOT NULL DEFAULT 1,
    features JSON,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    
    PRIMARY KEY (id),
    UNIQUE KEY uk_tiers_name (name)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Default tiers
INSERT INTO subscription_tiers (name, price_monthly, price_yearly, max_users, features) VALUES
    ('free', 0.00, 0.00, 1, JSON_ARRAY('basic_features')),
    ('pro', 29.99, 299.99, 5, JSON_ARRAY('basic_features', 'advanced_analytics')),
    ('enterprise', 99.99, 999.99, 999, JSON_ARRAY('basic_features', 'advanced_analytics', 'custom_integrations'));

-- Add subscription to users
ALTER TABLE users 
ADD COLUMN subscription_tier_id INT UNSIGNED AFTER is_active,
ADD COLUMN subscription_expires_at TIMESTAMP NULL AFTER subscription_tier_id,
ADD CONSTRAINT fk_users_subscription_tier 
    FOREIGN KEY (subscription_tier_id) 
    REFERENCES subscription_tiers(id) ON DELETE SET NULL;

-- Set all existing users to free tier
UPDATE users 
SET subscription_tier_id = (SELECT id FROM subscription_tiers WHERE name = 'free');
```

**U4__Undo_subscription_tiers.sql :**
```sql
-- ============================================
-- Undo Migration V4: Remove subscription tiers
-- ============================================

-- Remove foreign key and columns from users
ALTER TABLE users 
DROP FOREIGN KEY fk_users_subscription_tier,
DROP COLUMN subscription_tier_id,
DROP COLUMN subscription_expires_at;

-- Drop subscription_tiers table
DROP TABLE IF EXISTS subscription_tiers;
```

---

## Migrations rÃ©pÃ©tables (Repeatable)

Les migrations rÃ©pÃ©tables sont exÃ©cutÃ©es **Ã  chaque fois** que leur checksum change. Utiles pour :
- Vues
- ProcÃ©dures stockÃ©es
- Fonctions
- Triggers

**R__View_active_users.sql :**
```sql
-- ============================================
-- Repeatable Migration: Active Users View
-- This view is recreated on every change
-- ============================================

DROP VIEW IF EXISTS v_active_users;

CREATE VIEW v_active_users AS
SELECT 
    u.id,
    u.email,
    u.username,
    CONCAT(u.first_name, ' ', u.last_name) AS full_name,
    u.created_at,
    st.name AS subscription_tier,
    GROUP_CONCAT(r.name ORDER BY r.name SEPARATOR ', ') AS roles
FROM users u
LEFT JOIN subscription_tiers st ON u.subscription_tier_id = st.id
LEFT JOIN user_roles ur ON u.id = ur.user_id
LEFT JOIN roles r ON ur.role_id = r.id
WHERE u.is_active = TRUE
GROUP BY u.id, u.email, u.username, u.first_name, u.last_name, u.created_at, st.name;

-- Grant permissions
GRANT SELECT ON v_active_users TO '${app_user}'@'%';
```

**R__Procedure_cleanup_expired_sessions.sql :**
```sql
-- ============================================
-- Repeatable: Cleanup expired sessions procedure
-- ============================================

DROP PROCEDURE IF EXISTS sp_cleanup_expired_sessions;

DELIMITER $$

CREATE PROCEDURE sp_cleanup_expired_sessions(
    IN p_retention_days INT
)
BEGIN
    DECLARE v_cutoff_date TIMESTAMP;
    DECLARE v_deleted_count INT;
    
    -- Calculate cutoff date
    SET v_cutoff_date = DATE_SUB(NOW(), INTERVAL p_retention_days DAY);
    
    -- Delete expired sessions
    DELETE FROM user_sessions 
    WHERE expires_at < v_cutoff_date;
    
    -- Get count
    SET v_deleted_count = ROW_COUNT();
    
    -- Log cleanup
    INSERT INTO audit_logs (user_id, action, entity_type, details)
    VALUES (
        NULL, 
        'cleanup', 
        'user_sessions', 
        JSON_OBJECT('deleted_count', v_deleted_count, 'cutoff_date', v_cutoff_date)
    );
    
    -- Return result
    SELECT v_deleted_count AS deleted_sessions;
END$$

DELIMITER ;
```

---

## IntÃ©gration CI/CD

### 1. Pipeline GitLab CI/CD

**.gitlab-ci.yml :**
```yaml
stages:
  - validate
  - test
  - migrate-staging
  - migrate-production

variables:
  FLYWAY_VERSION: "10.4.1"
  FLYWAY_IMAGE: "flyway/flyway:${FLYWAY_VERSION}"

# ========================================
# Stage 1: Validation des migrations
# ========================================
validate-migrations:
  stage: validate
  image: ${FLYWAY_IMAGE}
  script:
    # VÃ©rifier la syntaxe SQL
    - |
      for file in sql/migrations/*.sql; do
        echo "Validating $file..."
        # Flyway validate vÃ©rifie la structure
        flyway -configFiles=flyway-dev.conf validate
      done
    
    # VÃ©rifier les noms de fichiers
    - |
      invalid_files=$(find sql/migrations -type f ! -name 'V*__*.sql' ! -name 'R__*.sql')
      if [ -n "$invalid_files" ]; then
        echo "ERROR: Invalid migration filenames:"
        echo "$invalid_files"
        exit 1
      fi
  only:
    changes:
      - sql/migrations/**/*

# ========================================
# Stage 2: Test sur base Ã©phÃ©mÃ¨re
# ========================================
test-migrations:
  stage: test
  image: ${FLYWAY_IMAGE}
  services:
    - name: mariadb:11.8.2
      alias: mariadb
  variables:
    MARIADB_ROOT_PASSWORD: test_root_pass
    MARIADB_DATABASE: myapp_test
    MARIADB_USER: flyway_user
    MARIADB_PASSWORD: flyway_pass
    FLYWAY_URL: "jdbc:mariadb://mariadb:3306/myapp_test"
    FLYWAY_USER: "flyway_user"
    FLYWAY_PASSWORD: "flyway_pass"
  script:
    # Attendre que MariaDB soit prÃªt
    - |
      until mariadb -h mariadb -u root -p${MARIADB_ROOT_PASSWORD} -e "SELECT 1"; do
        echo "Waiting for MariaDB..."
        sleep 2
      done
    
    # ExÃ©cuter les migrations
    - flyway migrate
    
    # Valider le rÃ©sultat
    - flyway info
    - flyway validate
    
    # Test: VÃ©rifier qu'une table existe
    - |
      mariadb -h mariadb -u flyway_user -p${FLYWAY_PASSWORD} myapp_test \
        -e "DESCRIBE users;" || exit 1
  only:
    changes:
      - sql/migrations/**/*

# ========================================
# Stage 3: Migration Staging (auto)
# ========================================
migrate-staging:
  stage: migrate-staging
  image: ${FLYWAY_IMAGE}
  environment:
    name: staging
    url: https://staging.myapp.com
  variables:
    FLYWAY_URL: "${STAGING_DB_URL}"
    FLYWAY_USER: "${STAGING_DB_USER}"
    FLYWAY_PASSWORD: "${STAGING_DB_PASSWORD}"
  script:
    # Dry-run d'abord (Flyway Teams)
    # - flyway migrate -dryRunOutput=/tmp/dryrun.sql
    # - cat /tmp/dryrun.sql
    
    # Migration rÃ©elle
    - flyway migrate
    
    # Afficher l'Ã©tat
    - flyway info
    
    # Notification Slack
    - |
      curl -X POST "${SLACK_WEBHOOK_URL}" \
        -H 'Content-Type: application/json' \
        -d "{\"text\":\"âœ… Database migrations applied to STAGING\"}"
  only:
    - develop
  when: on_success

# ========================================
# Stage 4: Migration Production (manuel)
# ========================================
migrate-production:
  stage: migrate-production
  image: ${FLYWAY_IMAGE}
  environment:
    name: production
    url: https://myapp.com
  variables:
    FLYWAY_URL: "${PROD_DB_URL}"
    FLYWAY_USER: "${PROD_DB_USER}"
    FLYWAY_PASSWORD: "${PROD_DB_PASSWORD}"
  before_script:
    # Backup avant migration (via mariabackup ou mysqldump)
    - |
      echo "Creating backup before migration..."
      mysqldump -h ${PROD_DB_HOST} -u ${PROD_DB_USER} -p${PROD_DB_PASSWORD} \
        --single-transaction --routines --triggers --events \
        myapp_production > /tmp/backup-pre-migration-$(date +%Y%m%d-%H%M%S).sql
      
      # Upload backup vers S3
      aws s3 cp /tmp/backup-*.sql s3://mariadb-backups-prod/pre-migration/
  script:
    # Info avant migration
    - flyway info
    
    # Migration avec confirmation
    - flyway migrate
    
    # Validation post-migration
    - flyway validate
    
    # Afficher l'Ã©tat final
    - flyway info
    
    # Notification
    - |
      curl -X POST "${SLACK_WEBHOOK_URL}" \
        -H 'Content-Type: application/json' \
        -d "{\"text\":\"ğŸš€ Database migrations applied to PRODUCTION\",\"attachments\":[{\"color\":\"good\",\"fields\":[{\"title\":\"Environment\",\"value\":\"Production\",\"short\":true},{\"title\":\"Triggered by\",\"value\":\"${GITLAB_USER_LOGIN}\",\"short\":true}]}]}"
  only:
    - main
  when: manual
  allow_failure: false
```

### 2. Pipeline GitHub Actions

**.github/workflows/database-migrations.yml :**
```yaml
name: Database Migrations

on:
  push:
    branches: [main, develop]
    paths:
      - 'sql/migrations/**'
  pull_request:
    branches: [main]
    paths:
      - 'sql/migrations/**'

env:
  FLYWAY_VERSION: '10.4.1'

jobs:
  # ========================================
  # Validation des migrations
  # ========================================
  validate:
    name: Validate SQL Migrations
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flyway
        run: |
          wget -qO- https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/${FLYWAY_VERSION}/flyway-commandline-${FLYWAY_VERSION}-linux-x64.tar.gz | tar xvz
          sudo ln -s $(pwd)/flyway-${FLYWAY_VERSION}/flyway /usr/local/bin/flyway
      
      - name: Validate migration naming
        run: |
          invalid=$(find sql/migrations -type f ! -name 'V*__*.sql' ! -name 'R__*.sql')
          if [ -n "$invalid" ]; then
            echo "::error::Invalid migration filenames found"
            echo "$invalid"
            exit 1
          fi
      
      - name: SQL Lint
        uses: sqlfluff/sqlfluff-github-actions@v0.1.0
        with:
          paths: 'sql/migrations'
          config_file: '.sqlfluff'

  # ========================================
  # Tests sur MariaDB ephemeral
  # ========================================
  test:
    name: Test Migrations
    runs-on: ubuntu-latest
    needs: validate
    services:
      mariadb:
        image: mariadb:11.8.2
        env:
          MARIADB_ROOT_PASSWORD: root_password
          MARIADB_DATABASE: test_db
          MARIADB_USER: test_user
          MARIADB_PASSWORD: test_password
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mariadb -u root -proot_password -e 'SELECT 1'"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flyway
        run: |
          wget -qO- https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/${FLYWAY_VERSION}/flyway-commandline-${FLYWAY_VERSION}-linux-x64.tar.gz | tar xvz
          sudo ln -s $(pwd)/flyway-${FLYWAY_VERSION}/flyway /usr/local/bin/flyway
      
      - name: Run migrations
        env:
          FLYWAY_URL: jdbc:mariadb://127.0.0.1:3306/test_db
          FLYWAY_USER: test_user
          FLYWAY_PASSWORD: test_password
        run: |
          flyway migrate
          flyway info
          flyway validate
      
      - name: Verify schema
        run: |
          mariadb -h 127.0.0.1 -u test_user -ptest_password test_db \
            -e "SHOW TABLES;"
          mariadb -h 127.0.0.1 -u test_user -ptest_password test_db \
            -e "SELECT * FROM flyway_schema_history;"

  # ========================================
  # DÃ©ploiement Staging (auto sur develop)
  # ========================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment:
      name: staging
      url: https://staging.myapp.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flyway
        run: |
          wget -qO- https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/${FLYWAY_VERSION}/flyway-commandline-${FLYWAY_VERSION}-linux-x64.tar.gz | tar xvz
          sudo ln -s $(pwd)/flyway-${FLYWAY_VERSION}/flyway /usr/local/bin/flyway
      
      - name: Migrate staging database
        env:
          FLYWAY_URL: ${{ secrets.STAGING_DB_URL }}
          FLYWAY_USER: ${{ secrets.STAGING_DB_USER }}
          FLYWAY_PASSWORD: ${{ secrets.STAGING_DB_PASSWORD }}
        run: |
          flyway info
          flyway migrate
          flyway validate
      
      - name: Notify Slack
        uses: slackapi/slack-github-action@v1.24.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "âœ… Database migrated to STAGING",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Environment:* Staging\n*Branch:* ${{ github.ref_name }}\n*Commit:* ${{ github.sha }}"
                  }
                }
              ]
            }

  # ========================================
  # DÃ©ploiement Production (manuel)
  # ========================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://myapp.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Flyway
        run: |
          wget -qO- https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/${FLYWAY_VERSION}/flyway-commandline-${FLYWAY_VERSION}-linux-x64.tar.gz | tar xvz
          sudo ln -s $(pwd)/flyway-${FLYWAY_VERSION}/flyway /usr/local/bin/flyway
      
      - name: Pre-migration backup
        env:
          PROD_DB_HOST: ${{ secrets.PROD_DB_HOST }}
          PROD_DB_USER: ${{ secrets.PROD_DB_USER }}
          PROD_DB_PASSWORD: ${{ secrets.PROD_DB_PASSWORD }}
        run: |
          mysqldump -h ${PROD_DB_HOST} -u ${PROD_DB_USER} -p${PROD_DB_PASSWORD} \
            --single-transaction --routines --triggers \
            myapp_production > backup-$(date +%Y%m%d-%H%M%S).sql
          
          # Upload to S3
          aws s3 cp backup-*.sql s3://mariadb-backups/pre-migration/
      
      - name: Migrate production database
        env:
          FLYWAY_URL: ${{ secrets.PROD_DB_URL }}
          FLYWAY_USER: ${{ secrets.PROD_DB_USER }}
          FLYWAY_PASSWORD: ${{ secrets.PROD_DB_PASSWORD }}
        run: |
          flyway info
          flyway migrate
          flyway validate
      
      - name: Notify on success
        uses: slackapi/slack-github-action@v1.24.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK }}
          payload: |
            {
              "text": "ğŸš€ Database migrated to PRODUCTION",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Environment:* Production\n*Triggered by:* ${{ github.actor }}\n*Workflow:* ${{ github.workflow }}"
                  }
                }
              ]
            }
```

---

## Flyway dans Kubernetes

### 1. Job Kubernetes pour migration

**flyway-migration-job.yaml :**
```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: flyway-migrate-20250115
  namespace: production
  labels:
    app: flyway
    component: database-migration
spec:
  # Ne conserver que les 3 derniers jobs
  ttlSecondsAfterFinished: 86400  # 24h
  backoffLimit: 2
  
  template:
    metadata:
      labels:
        app: flyway
    spec:
      restartPolicy: Never
      
      # Init container pour attendre MariaDB
      initContainers:
      - name: wait-for-mariadb
        image: mariadb:11.8.2
        command:
        - /bin/bash
        - -c
        - |
          until mariadb -h ${DB_HOST} -u ${DB_USER} -p${DB_PASSWORD} -e "SELECT 1"; do
            echo "Waiting for MariaDB to be ready..."
            sleep 5
          done
          echo "MariaDB is ready!"
        env:
        - name: DB_HOST
          value: "mariadb-primary-svc"
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: flyway-credentials
              key: username
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: flyway-credentials
              key: password
      
      containers:
      - name: flyway
        image: flyway/flyway:10.4.1
        command:
        - flyway
        - migrate
        - -url=jdbc:mariadb://$(DB_HOST):3306/$(DB_NAME)
        - -user=$(DB_USER)
        - -password=$(DB_PASSWORD)
        - -locations=filesystem:/flyway/sql
        - -baselineOnMigrate=true
        - -validateOnMigrate=true
        env:
        - name: DB_HOST
          value: "mariadb-primary-svc"
        - name: DB_NAME
          value: "myapp_production"
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: flyway-credentials
              key: username
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: flyway-credentials
              key: password
        
        # Monter les migrations depuis ConfigMap ou Git
        volumeMounts:
        - name: migrations
          mountPath: /flyway/sql
          readOnly: true
        
        resources:
          requests:
            cpu: "500m"
            memory: "512Mi"
          limits:
            cpu: "1"
            memory: "1Gi"
      
      volumes:
      # Option 1: ConfigMap (petites migrations)
      - name: migrations
        configMap:
          name: flyway-migrations
      
      # Option 2: Git sync (meillleur pour production)
      # - name: migrations
      #   emptyDir: {}
      # initContainers:
      # - name: git-sync
      #   image: k8s.gcr.io/git-sync:v3.6.3
      #   volumeMounts:
      #   - name: migrations
      #     mountPath: /tmp/git
      #   env:
      #   - name: GIT_SYNC_REPO
      #     value: "https://github.com/mycompany/database-migrations.git"
      #   - name: GIT_SYNC_BRANCH
      #     value: "main"
      #   - name: GIT_SYNC_ROOT
      #     value: "/tmp/git"
      #   - name: GIT_SYNC_ONE_TIME
      #     value: "true"
```

**Secret Flyway :**
```yaml
apiVersion: v1
kind: Secret
metadata:
  name: flyway-credentials
  namespace: production
type: Opaque
stringData:
  username: "flyway_user"
  password: "SecureFlywayPassword123!"
```

**ConfigMap pour petites migrations :**
```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: flyway-migrations
  namespace: production
data:
  V1__Initial_schema.sql: |
    CREATE TABLE users (
      id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
      email VARCHAR(255) NOT NULL,
      PRIMARY KEY (id)
    ) ENGINE=InnoDB;
  
  V2__Add_username.sql: |
    ALTER TABLE users 
    ADD COLUMN username VARCHAR(100) NOT NULL AFTER email;
```

### 2. Init Container pour applications

ExÃ©cuter les migrations **avant** le dÃ©marrage de l'application :

**deployment-with-flyway.yaml :**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp
  namespace: production
spec:
  replicas: 3
  selector:
    matchLabels:
      app: myapp
  template:
    metadata:
      labels:
        app: myapp
    spec:
      # Init container : Flyway migration
      initContainers:
      - name: flyway-migrate
        image: flyway/flyway:10.4.1
        command:
        - flyway
        - migrate
        - -url=jdbc:mariadb://mariadb-primary-svc:3306/myapp_production
        - -user=$(DB_USER)
        - -password=$(DB_PASSWORD)
        - -baselineOnMigrate=true
        env:
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: flyway-credentials
              key: username
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: flyway-credentials
              key: password
        volumeMounts:
        - name: migrations
          mountPath: /flyway/sql
      
      # Application container
      containers:
      - name: myapp
        image: myapp:1.2.3
        ports:
        - containerPort: 8080
        env:
        - name: DATABASE_URL
          value: "jdbc:mariadb://mariadb-primary-svc:3306/myapp_production"
      
      volumes:
      - name: migrations
        configMap:
          name: flyway-migrations
```

âš ï¸ **Attention** : Avec plusieurs replicas, seul le premier pod doit exÃ©cuter les migrations. Utilisez plutÃ´t un **Job** sÃ©parÃ© pour Ã©viter les conflits.

### 3. CronJob pour migrations rÃ©currentes (repeatable)

**flyway-repeatable-cronjob.yaml :**
```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: flyway-repeatable-migrations
  namespace: production
spec:
  # Toutes les nuits Ã  2h
  schedule: "0 2 * * *"
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
          - name: flyway
            image: flyway/flyway:10.4.1
            command:
            - /bin/bash
            - -c
            - |
              # Migrer uniquement les repeatable (vues, procÃ©dures)
              flyway migrate \
                -url=jdbc:mariadb://${DB_HOST}:3306/${DB_NAME} \
                -user=${DB_USER} \
                -password=${DB_PASSWORD} \
                -locations=filesystem:/flyway/sql/repeatable
            env:
            - name: DB_HOST
              value: "mariadb-primary-svc"
            - name: DB_NAME
              value: "myapp_production"
            - name: DB_USER
              valueFrom:
                secretKeyRef:
                  name: flyway-credentials
                  key: username
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: flyway-credentials
                  key: password
            volumeMounts:
            - name: migrations
              mountPath: /flyway/sql
          volumes:
          - name: migrations
            configMap:
              name: flyway-migrations-repeatable
```

---

## GitOps avec Flyway

### Architecture GitOps pour migrations

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Git Repository                       â”‚
â”‚           (Single Source of Truth)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  database-migrations/                                   â”‚
â”‚  â”œâ”€â”€ sql/migrations/                                    â”‚
â”‚  â”‚   â”œâ”€â”€ V1__Initial.sql                                â”‚
â”‚  â”‚   â””â”€â”€ V2__Add_users.sql                              â”‚
â”‚  â”œâ”€â”€ kustomize/                                         â”‚
â”‚  â”‚   â”œâ”€â”€ base/                                          â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ kustomization.yaml                         â”‚
â”‚  â”‚   â”‚   â””â”€â”€ flyway-job.yaml                            â”‚
â”‚  â”‚   â”œâ”€â”€ overlays/                                      â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ staging/                                   â”‚
â”‚  â”‚   â”‚   â”‚   â””â”€â”€ kustomization.yaml                     â”‚
â”‚  â”‚   â”‚   â””â”€â”€ production/                                â”‚
â”‚  â”‚   â”‚       â””â”€â”€ kustomization.yaml                     â”‚
â”‚  â””â”€â”€ argocd/                                            â”‚
â”‚      â””â”€â”€ flyway-application.yaml                        â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ Git Push
                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   ArgoCD / Flux CD    â”‚
    â”‚   (GitOps Operator)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚ Sync
                â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  Kubernetes Cluster   â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚  Flyway Job     â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â”‚         â”‚             â”‚
    â”‚         â–¼             â”‚
    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
    â”‚  â”‚  MariaDB        â”‚  â”‚
    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Configuration ArgoCD

**argocd/flyway-application.yaml :**
```yaml
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: database-migrations
  namespace: argocd
spec:
  project: default
  
  source:
    repoURL: https://github.com/mycompany/database-migrations.git
    targetRevision: HEAD
    path: kustomize/overlays/production
  
  destination:
    server: https://kubernetes.default.svc
    namespace: production
  
  syncPolicy:
    automated:
      # Ne PAS auto-sync les migrations en production!
      selfHeal: false
      prune: false
    
    # Sync manuel uniquement
    syncOptions:
    - CreateNamespace=true
    
    retry:
      limit: 2
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
  
  # Hooks pour validation
  syncWaves:
  - name: validate
    manifests:
    - kind: Job
      name: flyway-validate
  - name: migrate
    manifests:
    - kind: Job
      name: flyway-migrate
```

### Kustomize pour multi-environnement

**kustomize/base/kustomization.yaml :**
```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: production

resources:
- flyway-job.yaml
- flyway-secret.yaml

configMapGenerator:
- name: flyway-migrations
  files:
  - sql/migrations/V1__Initial_schema.sql
  - sql/migrations/V2__Add_users.sql

generatorOptions:
  disableNameSuffixHash: false
```

**kustomize/overlays/production/kustomization.yaml :**
```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: production

bases:
- ../../base

# Patches pour production
patchesStrategicMerge:
- flyway-job-patch.yaml

# Variables spÃ©cifiques
configMapGenerator:
- name: flyway-config
  literals:
  - DB_NAME=myapp_production
  - DB_HOST=mariadb-primary-svc.production.svc.cluster.local

secretGenerator:
- name: flyway-credentials
  envs:
  - flyway-prod.env
```

---

## Callbacks et hooks

**callbacks/beforeMigrate.sql :**
```sql
-- ============================================
-- Callback: Before any migration
-- ============================================

-- Log migration start
INSERT INTO migration_audit (event, details, created_at)
VALUES ('migration_started', JSON_OBJECT('user', USER()), CURRENT_TIMESTAMP);

-- Create backup of critical tables
CREATE TABLE IF NOT EXISTS users_backup_${timestamp} AS SELECT * FROM users;

-- Disable triggers temporarily (optional)
-- SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE='';
```

**callbacks/afterMigrate.sql :**
```sql
-- ============================================
-- Callback: After successful migration
-- ============================================

-- Analyze tables pour mise Ã  jour des stats
ANALYZE TABLE users, orders, audit_logs;

-- Log success
INSERT INTO migration_audit (event, details, created_at)
VALUES ('migration_completed', JSON_OBJECT('status', 'success'), CURRENT_TIMESTAMP);

-- Restore SQL mode
-- SET SQL_MODE=@OLD_SQL_MODE;

-- Send notification (via webhook)
-- SELECT http_post('https://hooks.slack.com/...', JSON_OBJECT('text', 'Migration completed'));
```

---

## Best practices de production

### 1. **Nommage strict des migrations**

```bash
# Bon
V1__Initial_schema.sql
V2.1__Add_email_column.sql
V3.2.1__Fix_email_constraint.sql

# Mauvais
migration_001.sql
add-email.sql
V1.sql
```

### 2. **Migrations idempotentes**

Toujours vÃ©rifier l'existence avant crÃ©ation/suppression :

```sql
-- CrÃ©ation conditionnelle
CREATE TABLE IF NOT EXISTS users (...);

-- Ajout de colonne conditionnelle
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS phone VARCHAR(20);

-- Suppression conditionnelle
DROP TABLE IF EXISTS old_table;
```

### 3. **Transactions explicites**

```sql
-- DÃ©but transaction
START TRANSACTION;

-- Migrations
ALTER TABLE users ADD COLUMN status VARCHAR(20);
UPDATE users SET status = 'active' WHERE is_active = TRUE;

-- Validation
-- Si erreur, Flyway rollback automatiquement
COMMIT;
```

### 4. **SÃ©paration des migrations lourdes**

```sql
-- V10__Add_index_on_email.sql
-- ATTENTION: Migration lourde sur table avec 100M rows

-- CrÃ©er l'index de maniÃ¨re non-bloquante
ALTER TABLE users 
ADD INDEX idx_users_email (email) 
ALGORITHM=INPLACE, LOCK=NONE;

-- Avec pt-online-schema-change pour trÃ¨s grosses tables
-- Voir section 16.8.3
```

### 5. **Backup automatique avant migration**

```yaml
# Dans le Job Kubernetes
initContainers:
- name: pre-migration-backup
  image: mariadb:11.8.2
  command:
  - /bin/bash
  - -c
  - |
    mysqldump -h ${DB_HOST} -u ${DB_USER} -p${DB_PASSWORD} \
      --single-transaction --routines \
      ${DB_NAME} | gzip > /backup/backup-$(date +%Y%m%d-%H%M%S).sql.gz
    
    aws s3 cp /backup/*.sql.gz s3://backups/pre-migration/
  volumeMounts:
  - name: backup
    mountPath: /backup
```

### 6. **Variables d'environnement (placeholders)**

```sql
-- Migration avec placeholders
CREATE USER '${app_user}'@'%' IDENTIFIED BY '${app_password}';
GRANT SELECT, INSERT, UPDATE, DELETE ON ${environment}_db.* TO '${app_user}'@'%';
```

Configuration :
```ini
flyway.placeholders.app_user=myapp_user
flyway.placeholders.app_password=SecurePass123
flyway.placeholders.environment=production
flyway.placeholderReplacement=true
```

### 7. **Validation continue**

```bash
# Cron quotidien pour dÃ©tecter drift
0 3 * * * cd /app && flyway validate || send_alert.sh
```

---

## Troubleshooting

### ProblÃ¨me 1 : Migration Ã©choue avec "Checksum mismatch"

**SymptÃ´mes :**
```
Migration checksum mismatch for migration version 2
-> Applied to database : 1234567890
-> Resolved locally    : 9876543210
```

**Cause :** La migration V2 a Ã©tÃ© modifiÃ©e aprÃ¨s avoir Ã©tÃ© appliquÃ©e.

**Solutions :**

1. **RÃ©parer le checksum (dÃ©veloppement uniquement) :**
```bash
flyway repair
```

2. **CrÃ©er une nouvelle migration (production) :**
```bash
# Ne JAMAIS modifier V2
# CrÃ©er V3 pour corriger
cp sql/migrations/V2__original.sql sql/migrations/V3__Fix_V2.sql
```

### ProblÃ¨me 2 : Migration timeout sur grosse table

**Diagnostic :**
```sql
-- VÃ©rifier la taille de la table
SELECT 
    table_name,
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS size_mb,
    table_rows
FROM information_schema.TABLES 
WHERE table_schema = 'myapp_production'
ORDER BY (data_length + index_length) DESC;
```

**Solution :** Utiliser pt-online-schema-change (section 16.8.3) :
```bash
pt-online-schema-change \
  --alter "ADD COLUMN status VARCHAR(20)" \
  D=myapp_production,t=users \
  --execute
```

### ProblÃ¨me 3 : Plusieurs pods tentent la migration simultanÃ©ment

**SymptÃ´mes :**
```
Waiting for metadata lock...
Duplicate key error in flyway_schema_history
```

**Solutions :**

1. **Job unique (pas Deployment) :**
```yaml
apiVersion: batch/v1
kind: Job  # Pas Deployment!
metadata:
  name: flyway-migrate
spec:
  completions: 1
  parallelism: 1  # Un seul pod
```

2. **Leader election dans l'application :**
```java
// Spring Boot avec Flyway
@Configuration
public class FlywayConfig {
    @Bean
    public Flyway flyway(DataSource dataSource) {
        return Flyway.configure()
            .dataSource(dataSource)
            .locations("classpath:db/migration")
            .baselineOnMigrate(true)
            // Lock pour Ã©viter double migration
            .lockRetryCount(50)
            .load();
    }
}
```

---

## âœ… Points clÃ©s Ã  retenir

- **Versioning strict** : Chaque migration a un numÃ©ro de version unique et immuable (V1, V2, V3...)
- **ImmutabilitÃ©** : Ne JAMAIS modifier une migration appliquÃ©e, toujours crÃ©er une nouvelle version
- **Idempotence** : Utiliser IF EXISTS / IF NOT EXISTS pour migrations rÃ©silientes
- **Migrations atomiques** : Une migration = une responsabilitÃ© logique
- **CI/CD intÃ©grÃ©** : Tests automatiques sur base Ã©phÃ©mÃ¨re avant production
- **Backup systÃ©matique** : Toujours sauvegarder avant migration production
- **GitOps** : Les migrations sont du code, versionnÃ©es dans Git comme source de vÃ©ritÃ©
- **Kubernetes Jobs** : Utiliser des Jobs (pas Deployments) pour Ã©viter concurrence
- **Validation continue** : `flyway validate` pour dÃ©tecter les dÃ©rives de schÃ©ma
- **Repeatable pour objets** : Vues, procÃ©dures, fonctions dans R__ (rejouÃ©es Ã  chaque changement)
- **Placeholders** : Utiliser des variables pour environnements multiples
- **Callbacks** : Hooks before/after pour audits, backups, notifications

---

## ğŸ”— Ressources et rÃ©fÃ©rences

### Documentation officielle
- **[Flyway Documentation](https://documentation.red-gate.com/fd)** - Documentation complÃ¨te Flyway
- **[Flyway MariaDB Support](https://documentation.red-gate.com/fd/mariadb-184127607.html)** - SpÃ©cificitÃ©s MariaDB
- **[Migration Guide](https://documentation.red-gate.com/fd/migrations-184127470.html)** - Best practices migrations

### Articles techniques
- **[Database Migrations with Flyway](https://www.baeldung.com/database-migrations-with-flyway)** - Tutorial complet
- **[GitOps for Databases](https://www.weave.works/blog/gitops-for-databases)** - GitOps et bases de donnÃ©es
- **[Flyway in Kubernetes](https://medium.com/containers-101/flyway-migrations-in-kubernetes-5f5e9f8f5b3e)** - Patterns K8s

### Outils
- **[Flyway Teams](https://www.red-gate.com/products/flyway/teams/)** - Version payante avec Undo, Dry-run
- **[flyway-test-extensions](https://github.com/flyway/flyway-test-extensions)** - Tests JUnit
- **[Kustomize](https://kustomize.io/)** - Configuration Kubernetes

---

## â¡ï¸ Section suivante

**16.8.2 Liquibase** : Alternative Ã  Flyway avec DSL XML/YAML/JSON, rollback natif, et changeSets conditionnels pour migrations complexes.

â­ï¸ [Liquibase](/16-devops-automatisation/08.2-liquibase.md)
