üîù Retour au [Sommaire](/SOMMAIRE.md)

# 16.3.1 Images officielles MariaDB

> **Niveau** : Avanc√© √† Expert  
> **Dur√©e estim√©e** : 2-3 heures  
> **Pr√©requis** : Docker basics, Linux containers, MariaDB fundamentals

## üéØ Objectifs d'apprentissage

√Ä l'issue de cette section, vous serez capable de :
- Comprendre l'architecture et le fonctionnement des images officielles MariaDB
- S√©lectionner la bonne image et le bon tag pour vos besoins
- Configurer MariaDB via variables d'environnement et fichiers de configuration
- G√©rer la persistance des donn√©es avec les volumes Docker
- Cr√©er des images personnalis√©es bas√©es sur l'image officielle
- Appliquer les meilleures pratiques de s√©curit√© pour les conteneurs de base de donn√©es
- Optimiser les images pour la production

---

## Introduction

Les images Docker officielles de MariaDB sont maintenues par MariaDB Foundation et disponibles sur [Docker Hub](https://hub.docker.com/_/mariadb). Elles constituent la base de r√©f√©rence pour d√©ployer MariaDB en conteneurs, que ce soit pour le d√©veloppement local, les environnements de test, ou m√™me la production avec Kubernetes.

### Pourquoi utiliser les images officielles ?

**Avantages** :
- ‚úÖ **Maintenabilit√©** : Mises √† jour r√©guli√®res par MariaDB Foundation
- ‚úÖ **S√©curit√©** : Scans de vuln√©rabilit√©s, patches de s√©curit√© rapides
- ‚úÖ **Compatibilit√©** : Test√© sur multiples plateformes et orchestrateurs
- ‚úÖ **Documentation** : Exhaustive et √† jour
- ‚úÖ **Support** : Communaut√© large et active
- ‚úÖ **Optimisation** : Images l√©g√®res et performantes
- ‚úÖ **Standards** : Suit les best practices Docker

**Cas d'usage** :
- Environnements de d√©veloppement locaux
- CI/CD pipelines (tests d'int√©gration)
- D√©ploiements Kubernetes (avec StatefulSets)
- Architectures microservices
- Conteneurs √©ph√©m√®res pour tests
- Base pour images personnalis√©es

---

## Versions et tags disponibles

### Structure des tags

Les images MariaDB suivent une convention de nommage claire :

```
mariadb:<version>[-<variant>]

Exemples:
mariadb:latest          # Derni√®re version stable
mariadb:11.8            # Derni√®re 11.8.x
mariadb:11.8.1          # Version exacte 11.8.1
mariadb:11.8-jammy      # 11.8 sur Ubuntu 22.04 Jammy
mariadb:11.4-lts        # Version LTS 11.4
mariadb:10.11           # Ancienne version LTS
```

### Versions majeures disponibles

| Version | Type | Support | Tag recommand√© | Base OS |
|---------|------|---------|----------------|---------|
| **11.8** | **LTS** | **2028** | `11.8`, `11.8.1` | Debian 12 / Ubuntu 24.04 |
| **11.4** | **LTS** | **2027** | `11.4` | Debian 12 / Ubuntu 22.04 |
| 11.7 | Rolling | 2025-Q1 | `11.7` | Debian 12 |
| 11.6 | Rolling | 2024-Q4 | `11.6` | Debian 12 |
| 10.11 | LTS | 2028 | `10.11` | Debian 11 |
| 10.6 | LTS | 2026 | `10.6` | Debian 11 |

üÜï **MariaDB 11.8 LTS** : Version de r√©f√©rence depuis juin 2025

### Variantes d'images

```bash
# Debian (d√©faut) - Recommand√© pour production
mariadb:11.8
mariadb:11.8-bookworm    # Debian 12 Bookworm

# Ubuntu
mariadb:11.8-jammy       # Ubuntu 22.04 LTS
mariadb:11.8-noble       # Ubuntu 24.04 LTS

# Alpine (l√©g√®re mais moins compatible)
# ‚ö†Ô∏è Pas d'image Alpine officielle pour MariaDB
```

üí° **Conseil** : Utilisez toujours des tags versionn√©s (`11.8.1`) en production, jamais `latest`.

---

## Anatomie de l'image officielle

### Contenu de l'image

```bash
# Inspecter l'image
docker inspect mariadb:11.8

# Principales caract√©ristiques :
# - Base: Debian 12 (Bookworm)
# - Taille: ~400MB
# - Architecture: amd64, arm64v8
# - User: mysql (UID 999)
# - Port: 3306
# - Volume: /var/lib/mysql
# - Entrypoint: docker-entrypoint.sh
```

### Structure du filesystem

```
/
‚îú‚îÄ‚îÄ etc/
‚îÇ   ‚îî‚îÄ‚îÄ mysql/
‚îÇ       ‚îú‚îÄ‚îÄ my.cnf                    # Configuration principale
‚îÇ       ‚îú‚îÄ‚îÄ mariadb.cnf               # Inclusions MariaDB
‚îÇ       ‚îî‚îÄ‚îÄ conf.d/                   # Configurations additionnelles
‚îÇ           ‚îî‚îÄ‚îÄ docker.cnf            # Config sp√©cifique Docker
‚îú‚îÄ‚îÄ var/
‚îÇ   ‚îú‚îÄ‚îÄ lib/mysql/                    # üìÅ VOLUME - Donn√©es
‚îÇ   ‚îî‚îÄ‚îÄ log/mysql/                    # Logs
‚îú‚îÄ‚îÄ usr/
‚îÇ   ‚îú‚îÄ‚îÄ bin/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mariadb                   # Client CLI
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mariadbd                  # Serveur
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mariadb-dump              # Backup
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ mariadb-upgrade           # Upgrade
‚îÇ   ‚îî‚îÄ‚îÄ local/bin/
‚îÇ       ‚îî‚îÄ‚îÄ docker-entrypoint.sh      # üöÄ Entrypoint
‚îî‚îÄ‚îÄ docker-entrypoint-initdb.d/       # üìÅ Scripts d'initialisation
```

### Entrypoint et initialisation

L'entrypoint `docker-entrypoint.sh` effectue les actions suivantes au d√©marrage :

1. **V√©rification du datadir** : Si `/var/lib/mysql` est vide ‚Üí initialisation
2. **Initialisation de la base** : `mariadb-install-db` si n√©cessaire
3. **D√©marrage temporaire** : Pour configuration initiale
4. **Ex√©cution des scripts** : `/docker-entrypoint-initdb.d/*.{sh,sql,sql.gz}`
5. **Configuration utilisateur/DB** : Selon variables d'environnement
6. **Arr√™t temporaire** : Fin de l'initialisation
7. **D√©marrage final** : `mariadbd` en tant que PID 1

---

## Variables d'environnement

### Variables essentielles

```bash
# Mot de passe root (OBLIGATOIRE au premier d√©marrage)
MARIADB_ROOT_PASSWORD=SecureRootPassword123!

# Alternative : g√©n√©ration al√©atoire
MARIADB_RANDOM_ROOT_PASSWORD=yes
# Le mot de passe sera affich√© dans les logs

# Alternative : pas de mot de passe (DANGEREUX, dev uniquement)
MARIADB_ALLOW_EMPTY_PASSWORD=yes
```

### Cr√©ation de base de donn√©es et utilisateur

```bash
# Base de donn√©es initiale
MARIADB_DATABASE=myapp

# Utilisateur applicatif
MARIADB_USER=appuser
MARIADB_PASSWORD=AppUserPassword123!

# Note: L'utilisateur aura tous les privil√®ges sur MARIADB_DATABASE
```

### Variables avanc√©es

```bash
# Initialisation rapide (pour dev/test)
MARIADB_INITDB_SKIP_TZINFO=yes

# MySQL backward compatibility
MYSQL_ROOT_PASSWORD=$MARIADB_ROOT_PASSWORD
MYSQL_DATABASE=$MARIADB_DATABASE
MYSQL_USER=$MARIADB_USER
MYSQL_PASSWORD=$MARIADB_PASSWORD
```

### Exemple complet

```bash
docker run -d \
  --name mariadb-prod \
  -e MARIADB_ROOT_PASSWORD=SuperSecureRootPass! \
  -e MARIADB_DATABASE=production_db \
  -e MARIADB_USER=app_user \
  -e MARIADB_PASSWORD=AppUserSecurePass! \
  -e MARIADB_INITDB_SKIP_TZINFO=yes \
  -v mariadb_data:/var/lib/mysql \
  -p 3306:3306 \
  mariadb:11.8
```

‚ö†Ô∏è **Attention** : Ne passez JAMAIS de mots de passe en clair dans les commandes production. Utilisez Docker secrets ou des fichiers d'environnement.

---

## Configuration personnalis√©e

### 1. Via fichier de configuration

```bash
# Cr√©er un fichier custom.cnf
cat > /my/custom/config-file.cnf << 'EOF'
[mysqld]
# üÜï MariaDB 11.8 - utf8mb4 par d√©faut
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

# InnoDB optimizations
innodb_buffer_pool_size = 2G
innodb_log_file_size = 512M
innodb_flush_log_at_trx_commit = 2

# üÜï MariaDB 11.8 - ALTER TABLE efficace
innodb_alter_copy_bulk = 256M

# Connexions
max_connections = 200

# Slow query log
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow-query.log
long_query_time = 2

# üÜï MariaDB 11.8 - Contr√¥le espace temporaire
max_tmp_space_usage = 10G
max_total_tmp_space_usage = 20G
EOF

# Monter le fichier
docker run -d \
  --name mariadb \
  -v /my/custom/config-file.cnf:/etc/mysql/conf.d/custom.cnf:ro \
  -v mariadb_data:/var/lib/mysql \
  -e MARIADB_ROOT_PASSWORD=mypass \
  mariadb:11.8
```

### 2. Via arguments de commande

```bash
docker run -d \
  --name mariadb \
  -e MARIADB_ROOT_PASSWORD=mypass \
  mariadb:11.8 \
  --character-set-server=utf8mb4 \
  --collation-server=utf8mb4_unicode_ci \
  --max-connections=300 \
  --innodb-buffer-pool-size=4G
```

### 3. V√©rification de la configuration

```bash
# V√©rifier les variables
docker exec mariadb mariadb -uroot -p -e "SHOW VARIABLES LIKE 'character_set%';"

# V√©rifier la configuration charg√©e
docker exec mariadb mariadbd --verbose --help | grep -A 1 "Default options"
```

---

## Gestion des volumes et persistance

### Types de volumes

```bash
# 1. Volume nomm√© (RECOMMAND√â)
docker volume create mariadb_data
docker run -d \
  -v mariadb_data:/var/lib/mysql \
  mariadb:11.8

# 2. Bind mount (d√©veloppement)
docker run -d \
  -v /my/host/datadir:/var/lib/mysql \
  mariadb:11.8

# 3. Volume anonyme (temporaire, tests)
docker run -d mariadb:11.8
```

### Structure du volume de donn√©es

```bash
# Inspecter le contenu du volume
docker run --rm \
  -v mariadb_data:/data \
  busybox ls -la /data

# Structure typique :
/var/lib/mysql/
‚îú‚îÄ‚îÄ aria_log.00000001
‚îú‚îÄ‚îÄ aria_log_control
‚îú‚îÄ‚îÄ ib_buffer_pool
‚îú‚îÄ‚îÄ ibdata1                    # InnoDB system tablespace
‚îú‚îÄ‚îÄ ib_logfile0               # InnoDB redo logs
‚îú‚îÄ‚îÄ ib_logfile1
‚îú‚îÄ‚îÄ ibtmp1                    # InnoDB temp tablespace
‚îú‚îÄ‚îÄ mysql/                    # Syst√®me
‚îú‚îÄ‚îÄ performance_schema/       # Performance Schema
‚îú‚îÄ‚îÄ production_db/            # Base utilisateur
‚îÇ   ‚îú‚îÄ‚îÄ table1.frm
‚îÇ   ‚îú‚îÄ‚îÄ table1.ibd
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ mariadb-bin.000001        # Binary logs
```

### Sauvegarde de volume

```bash
# Arr√™ter le conteneur pour coh√©rence
docker stop mariadb

# Backup du volume
docker run --rm \
  -v mariadb_data:/data \
  -v $(pwd):/backup \
  busybox tar czf /backup/mariadb-backup-$(date +%Y%m%d).tar.gz -C /data .

# Red√©marrer
docker start mariadb

# Restauration
docker run --rm \
  -v mariadb_data:/data \
  -v $(pwd):/backup \
  busybox tar xzf /backup/mariadb-backup-20251214.tar.gz -C /data
```

üí° **Conseil** : Utilisez plut√¥t `mariadb-dump` ou `mariabackup` pour des backups coh√©rents sans arr√™t.

---

## Scripts d'initialisation

### M√©canisme

Tous les fichiers dans `/docker-entrypoint-initdb.d/` sont ex√©cut√©s au **premier d√©marrage** uniquement :

- `*.sh` : Scripts shell
- `*.sql` : Scripts SQL
- `*.sql.gz` : Scripts SQL compress√©s

**Ordre d'ex√©cution** : Alphab√©tique

### Exemples de scripts

#### 1. Script SQL - Cr√©ation de sch√©ma

```sql
-- /docker-entrypoint-initdb.d/01-schema.sql
CREATE TABLE IF NOT EXISTS users (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(255) NOT NULL UNIQUE,
    email VARCHAR(255) NOT NULL UNIQUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_username (username),
    INDEX idx_email (email)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE IF NOT EXISTS sessions (
    id CHAR(36) PRIMARY KEY,
    user_id BIGINT UNSIGNED NOT NULL,
    data JSON,
    expires_at TIMESTAMP NOT NULL,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_expires (expires_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 2. Script SQL - Donn√©es de test

```sql
-- /docker-entrypoint-initdb.d/02-data.sql
INSERT INTO users (username, email) VALUES
    ('admin', 'admin@example.com'),
    ('user1', 'user1@example.com'),
    ('user2', 'user2@example.com');
```

#### 3. Script shell - Configuration avanc√©e

```bash
#!/bin/bash
# /docker-entrypoint-initdb.d/03-setup.sh

set -e

echo "Creating additional users and privileges..."

mariadb -uroot -p"${MARIADB_ROOT_PASSWORD}" <<-EOSQL
    -- Utilisateur lecture seule
    CREATE USER IF NOT EXISTS 'readonly'@'%' IDENTIFIED BY '${READONLY_PASSWORD}';
    GRANT SELECT ON ${MARIADB_DATABASE}.* TO 'readonly'@'%';
    
    -- Utilisateur backup
    CREATE USER IF NOT EXISTS 'backup'@'%' IDENTIFIED BY '${BACKUP_PASSWORD}';
    GRANT SELECT, RELOAD, LOCK TABLES, REPLICATION CLIENT ON *.* TO 'backup'@'%';
    
    -- Utilisateur monitoring
    CREATE USER IF NOT EXISTS 'exporter'@'%' IDENTIFIED BY '${EXPORTER_PASSWORD}';
    GRANT PROCESS, REPLICATION CLIENT, SELECT ON *.* TO 'exporter'@'%';
    
    FLUSH PRIVILEGES;
EOSQL

echo "Additional users created successfully!"
```

### Montage des scripts

```bash
docker run -d \
  --name mariadb \
  -e MARIADB_ROOT_PASSWORD=rootpass \
  -e MARIADB_DATABASE=myapp \
  -e READONLY_PASSWORD=readonly123 \
  -e BACKUP_PASSWORD=backup123 \
  -e EXPORTER_PASSWORD=exporter123 \
  -v ./init-scripts:/docker-entrypoint-initdb.d:ro \
  -v mariadb_data:/var/lib/mysql \
  mariadb:11.8
```

‚ö†Ô∏è **Attention** : Les scripts d'initialisation ne sont ex√©cut√©s QUE si `/var/lib/mysql` est vide. Pour r√©ex√©cuter, supprimez le volume.

---

## S√©curit√© des conteneurs MariaDB

### 1. User non-root

Les images officielles ex√©cutent MariaDB avec l'utilisateur `mysql` (UID 999) :

```bash
# V√©rifier l'utilisateur
docker exec mariadb whoami
# Output: mysql

docker exec mariadb id
# Output: uid=999(mysql) gid=999(mysql) groups=999(mysql)
```

### 2. Gestion des secrets

#### Docker Secrets (Swarm/Compose)

```yaml
# docker-compose.yml
version: '3.8'

services:
  mariadb:
    image: mariadb:11.8
    secrets:
      - mariadb_root_password
      - mariadb_user_password
    environment:
      MARIADB_ROOT_PASSWORD_FILE: /run/secrets/mariadb_root_password
      MARIADB_DATABASE: myapp
      MARIADB_USER: appuser
      MARIADB_PASSWORD_FILE: /run/secrets/mariadb_user_password
    volumes:
      - mariadb_data:/var/lib/mysql

secrets:
  mariadb_root_password:
    file: ./secrets/root_password.txt
  mariadb_user_password:
    file: ./secrets/user_password.txt

volumes:
  mariadb_data:
```

#### Variables d'environnement avec fichiers

```bash
# Cr√©er les fichiers de secrets
echo "SuperSecureRootPass!" > /secrets/root_password
echo "AppUserSecurePass!" > /secrets/user_password
chmod 600 /secrets/*

# Utiliser _FILE suffix
docker run -d \
  --name mariadb \
  -e MARIADB_ROOT_PASSWORD_FILE=/secrets/root_password \
  -e MARIADB_PASSWORD_FILE=/secrets/user_password \
  -e MARIADB_DATABASE=myapp \
  -e MARIADB_USER=appuser \
  -v /secrets:/secrets:ro \
  -v mariadb_data:/var/lib/mysql \
  mariadb:11.8
```

### 3. Read-only root filesystem

```bash
docker run -d \
  --name mariadb \
  --read-only \
  --tmpfs /tmp \
  --tmpfs /run/mysqld \
  -v mariadb_data:/var/lib/mysql \
  -v mariadb_logs:/var/log/mysql \
  -e MARIADB_ROOT_PASSWORD=mypass \
  mariadb:11.8
```

### 4. Capabilities minimales

```bash
docker run -d \
  --name mariadb \
  --cap-drop=ALL \
  --cap-add=SETGID \
  --cap-add=SETUID \
  --cap-add=DAC_OVERRIDE \
  -e MARIADB_ROOT_PASSWORD=mypass \
  mariadb:11.8
```

### 5. Security scanning

```bash
# Avec Trivy
trivy image mariadb:11.8

# Avec Snyk
snyk container test mariadb:11.8

# Avec Clair
clairctl analyze mariadb:11.8
```

---

## Images personnalis√©es

### Dockerfile basique

```dockerfile
# Dockerfile
FROM mariadb:11.8

# Copier configuration personnalis√©e
COPY custom.cnf /etc/mysql/conf.d/

# Copier scripts d'initialisation
COPY init-scripts/ /docker-entrypoint-initdb.d/

# Installer des outils suppl√©mentaires
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        mariadb-backup \
        percona-toolkit \
        mydumper \
    && rm -rf /var/lib/apt/lists/*
```

### Dockerfile avec configurations avanc√©es

```dockerfile
FROM mariadb:11.8

LABEL maintainer="dba@example.com"
LABEL version="11.8-custom-1.0"
LABEL description="MariaDB 11.8 LTS with custom configuration and tools"

# Variables d'environnement par d√©faut
ENV MARIADB_CHARACTER_SET=utf8mb4 \
    MARIADB_COLLATION=utf8mb4_unicode_ci \
    MARIADB_INNODB_BUFFER_POOL_SIZE=2G

# Installer outils de monitoring et backup
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        # Backup tools
        mariadb-backup \
        percona-toolkit \
        mydumper \
        # Monitoring
        prometheus-mysqld-exporter \
        # Utilities
        curl \
        jq \
        netcat-openbsd \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Copier configurations
COPY config/custom.cnf /etc/mysql/conf.d/
COPY config/security.cnf /etc/mysql/conf.d/

# Copier scripts d'initialisation
COPY init-scripts/*.sql /docker-entrypoint-initdb.d/
COPY init-scripts/*.sh /docker-entrypoint-initdb.d/
RUN chmod +x /docker-entrypoint-initdb.d/*.sh

# Copier scripts de maintenance
COPY scripts/backup.sh /usr/local/bin/
COPY scripts/healthcheck.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/*.sh

# Healthcheck
HEALTHCHECK --interval=30s --timeout=5s --start-period=30s --retries=3 \
    CMD /usr/local/bin/healthcheck.sh || exit 1

# Exposer le port
EXPOSE 3306

# L'image de base a d√©j√† ENTRYPOINT et CMD
```

### Scripts associ√©s

```bash
# config/custom.cnf
[mysqld]
# üÜï MariaDB 11.8 optimizations
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

innodb_buffer_pool_size = 2G
innodb_log_file_size = 512M
innodb_alter_copy_bulk = 256M

max_connections = 300
max_tmp_space_usage = 10G

slow_query_log = 1
long_query_time = 1
```

```bash
#!/bin/bash
# scripts/healthcheck.sh
set -eo pipefail

# V√©rifier que MariaDB est up
if mariadb -uroot -p"${MARIADB_ROOT_PASSWORD}" -e "SELECT 1" > /dev/null 2>&1; then
    exit 0
else
    exit 1
fi
```

```bash
#!/bin/bash
# scripts/backup.sh
set -e

BACKUP_DIR="/backup"
DATE=$(date +%Y%m%d_%H%M%S)

mariadb-dump \
    -uroot \
    -p"${MARIADB_ROOT_PASSWORD}" \
    --all-databases \
    --single-transaction \
    --routines \
    --triggers \
    --events \
    | gzip > "${BACKUP_DIR}/backup-${DATE}.sql.gz"

# Rotation (garder 7 jours)
find "${BACKUP_DIR}" -name "backup-*.sql.gz" -mtime +7 -delete
```

### Build et push

```bash
# Build
docker build -t mycompany/mariadb:11.8-custom .

# Tag pour diff√©rents registries
docker tag mycompany/mariadb:11.8-custom mycompany/mariadb:latest

# Push vers Docker Hub
docker push mycompany/mariadb:11.8-custom

# Push vers registry priv√©
docker tag mycompany/mariadb:11.8-custom registry.example.com/mariadb:11.8-custom
docker push registry.example.com/mariadb:11.8-custom
```

---

## Multi-stage builds pour optimisation

### Dockerfile optimis√©

```dockerfile
# Stage 1: Builder - Installation outils
FROM mariadb:11.8 AS builder

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        build-essential \
        git \
        cmake \
    && rm -rf /var/lib/apt/lists/*

# Compiler des outils custom (exemple)
WORKDIR /build
RUN git clone https://github.com/mydumper/mydumper.git && \
    cd mydumper && \
    cmake . && \
    make && \
    make install

# Stage 2: Runtime - Image finale
FROM mariadb:11.8

# Copier uniquement les binaires n√©cessaires du builder
COPY --from=builder /usr/local/bin/mydumper /usr/local/bin/
COPY --from=builder /usr/local/bin/myloader /usr/local/bin/

# Installer uniquement les d√©pendances runtime
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
        libglib2.0-0 \
        libpcre3 \
    && rm -rf /var/lib/apt/lists/*

# Copier configs et scripts
COPY config/ /etc/mysql/conf.d/
COPY scripts/ /usr/local/bin/

HEALTHCHECK --interval=30s --timeout=5s --retries=3 \
    CMD mariadb -uroot -p"${MARIADB_ROOT_PASSWORD}" -e "SELECT 1" || exit 1
```

üí° **Conseil** : Les multi-stage builds r√©duisent significativement la taille finale de l'image.

---

## Architectures multi-plateforme

### Build pour ARM64 et AMD64

```bash
# Installer buildx
docker buildx create --name multiarch --use
docker buildx inspect --bootstrap

# Build multi-arch
docker buildx build \
    --platform linux/amd64,linux/arm64 \
    -t mycompany/mariadb:11.8-custom \
    --push \
    .

# V√©rifier les architectures
docker buildx imagetools inspect mycompany/mariadb:11.8-custom
```

### Dockerfile avec conditions par architecture

```dockerfile
FROM mariadb:11.8

# Variables selon l'architecture
ARG TARGETARCH

RUN if [ "$TARGETARCH" = "arm64" ]; then \
        echo "ARM64 specific configuration"; \
        # Optimisations ARM
    else \
        echo "AMD64 specific configuration"; \
        # Optimisations x86_64
    fi
```

---

## Healthchecks avanc√©s

### Healthcheck complet

```dockerfile
HEALTHCHECK --interval=30s \
            --timeout=10s \
            --start-period=40s \
            --retries=3 \
    CMD mariadb -h localhost -uroot -p"${MARIADB_ROOT_PASSWORD}" \
        -e "SELECT 1; \
            SHOW SLAVE STATUS\G; \
            SELECT COUNT(*) FROM information_schema.PROCESSLIST;" \
        || exit 1
```

### Script healthcheck avanc√©

```bash
#!/bin/bash
# /usr/local/bin/healthcheck.sh

set -eo pipefail

# 1. V√©rifier connexion
if ! mariadb -uroot -p"${MARIADB_ROOT_PASSWORD}" -e "SELECT 1" > /dev/null 2>&1; then
    echo "ERROR: Cannot connect to MariaDB"
    exit 1
fi

# 2. V√©rifier que le serveur n'est pas en read-only
READ_ONLY=$(mariadb -uroot -p"${MARIADB_ROOT_PASSWORD}" -NB -e "SELECT @@read_only")
if [ "$READ_ONLY" = "1" ] && [ "${ALLOW_READ_ONLY:-0}" != "1" ]; then
    echo "ERROR: Server is in read-only mode"
    exit 1
fi

# 3. V√©rifier la r√©plication (si configur√©e)
if [ "${CHECK_REPLICATION:-0}" = "1" ]; then
    SLAVE_IO=$(mariadb -uroot -p"${MARIADB_ROOT_PASSWORD}" -NB -e "SHOW SLAVE STATUS\G" | grep "Slave_IO_Running:" | awk '{print $2}')
    SLAVE_SQL=$(mariadb -uroot -p"${MARIADB_ROOT_PASSWORD}" -NB -e "SHOW SLAVE STATUS\G" | grep "Slave_SQL_Running:" | awk '{print $2}')
    
    if [ "$SLAVE_IO" != "Yes" ] || [ "$SLAVE_SQL" != "Yes" ]; then
        echo "ERROR: Replication is not running"
        exit 1
    fi
fi

# 4. V√©rifier le nombre de connexions
MAX_CONNECTIONS=$(mariadb -uroot -p"${MARIADB_ROOT_PASSWORD}" -NB -e "SELECT @@max_connections")
CURRENT_CONNECTIONS=$(mariadb -uroot -p"${MARIADB_ROOT_PASSWORD}" -NB -e "SELECT COUNT(*) FROM information_schema.PROCESSLIST")

if [ "$CURRENT_CONNECTIONS" -ge "$MAX_CONNECTIONS" ]; then
    echo "ERROR: Too many connections ($CURRENT_CONNECTIONS/$MAX_CONNECTIONS)"
    exit 1
fi

echo "OK: MariaDB is healthy"
exit 0
```

---

## Optimisations de performance

### 1. Configuration InnoDB

```cnf
# /etc/mysql/conf.d/performance.cnf
[mysqld]
# üÜï MariaDB 11.8 - Optimisations SSD
innodb_io_capacity = 2000
innodb_io_capacity_max = 4000
innodb_flush_method = O_DIRECT

# Buffer Pool (75% de la RAM disponible)
innodb_buffer_pool_size = 6G
innodb_buffer_pool_instances = 6

# Log files
innodb_log_file_size = 1G
innodb_log_buffer_size = 32M

# üÜï MariaDB 11.8 - ALTER TABLE efficace
innodb_alter_copy_bulk = 512M

# Flush
innodb_flush_log_at_trx_commit = 2  # Performance vs durabilit√©

# Thread concurrency
innodb_read_io_threads = 8
innodb_write_io_threads = 8
innodb_purge_threads = 4
```

### 2. Limiter les ressources

```bash
# Limites CPU et m√©moire
docker run -d \
    --name mariadb \
    --cpus="2.0" \
    --memory="8g" \
    --memory-swap="8g" \
    -e MARIADB_ROOT_PASSWORD=mypass \
    mariadb:11.8
```

### 3. Monitoring des ressources

```bash
# Stats en temps r√©el
docker stats mariadb

# Inspection d√©taill√©e
docker inspect mariadb | jq '.[0].HostConfig.Memory'
```

---

## Logs et debugging

### Acc√®s aux logs

```bash
# Logs du conteneur (stderr/stdout)
docker logs mariadb
docker logs -f mariadb  # Follow
docker logs --tail 100 mariadb

# Logs MariaDB (error log)
docker exec mariadb cat /var/log/mysql/error.log

# Slow query log
docker exec mariadb cat /var/log/mysql/slow-query.log

# General log (si activ√©)
docker exec mariadb cat /var/log/mysql/general.log
```

### Configuration des logs

```cnf
# /etc/mysql/conf.d/logging.cnf
[mysqld]
log_error = /var/log/mysql/error.log

slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow-query.log
long_query_time = 1
log_queries_not_using_indexes = 1

# General log (d√©sactiv√© en production)
general_log = 0
general_log_file = /var/log/mysql/general.log
```

### Exporter les logs vers stdout

Pour une meilleure int√©gration avec les syst√®mes de logging (ELK, Loki) :

```dockerfile
FROM mariadb:11.8

# Rediriger les logs vers stdout/stderr
RUN ln -sf /dev/stdout /var/log/mysql/general.log && \
    ln -sf /dev/stderr /var/log/mysql/error.log && \
    ln -sf /dev/stdout /var/log/mysql/slow-query.log
```

---

## Cas d'usage pratiques

### 1. D√©veloppement local

```bash
# D√©marrage rapide pour dev
docker run -d \
    --name mariadb-dev \
    -e MARIADB_ROOT_PASSWORD=dev \
    -e MARIADB_DATABASE=myapp_dev \
    -e MARIADB_USER=dev \
    -e MARIADB_PASSWORD=dev \
    -p 3306:3306 \
    mariadb:11.8 \
    --character-set-server=utf8mb4 \
    --collation-server=utf8mb4_unicode_ci
```

### 2. Tests d'int√©gration CI/CD

```yaml
# .gitlab-ci.yml
test:
  image: node:18
  services:
    - name: mariadb:11.8
      alias: mariadb
  variables:
    MARIADB_ROOT_PASSWORD: test
    MARIADB_DATABASE: test_db
    DATABASE_URL: mysql://root:test@mariadb:3306/test_db
  script:
    - npm install
    - npm run migrate
    - npm test
```

### 3. Conteneur √©ph√©m√®re pour tests

```bash
# Cr√©er, tester, d√©truire
docker run --rm \
    -e MARIADB_ROOT_PASSWORD=temp \
    -e MARIADB_DATABASE=test \
    mariadb:11.8 &

# Attendre que MariaDB soit pr√™t
sleep 20

# Ex√©cuter tests
docker exec -i $(docker ps -q -f ancestor=mariadb:11.8) \
    mariadb -uroot -ptemp test < test-schema.sql

# Le conteneur sera automatiquement supprim√© (--rm)
```

---

## Comparaison des images

### MariaDB vs MySQL

```bash
# MariaDB (recommand√©)
docker pull mariadb:11.8
# Taille: ~400MB
# Fonctionnalit√©s: Vector, JSON avanc√©, System-versioned tables

# MySQL
docker pull mysql:8.0
# Taille: ~500MB
# Diff√©rences: Pas de Vector, syntaxe diff√©rente
```

### Images alternatives

| Image | Source | Taille | Usage |
|-------|--------|--------|-------|
| `mariadb:11.8` | Docker Hub (officiel) | ~400MB | Production |
| `bitnami/mariadb` | Bitnami | ~450MB | Kubernetes friendly |
| `linuxserver/mariadb` | LinuxServer.io | ~380MB | Home lab |

üí° **Conseil** : Privil√©giez toujours l'image officielle pour la production.

---

## ‚úÖ Points cl√©s √† retenir

- **Tags versionn√©s** : Toujours utiliser des versions sp√©cifiques (`11.8.1`) en production, jamais `latest`
- **Volumes nomm√©s** : Utilisez des volumes Docker pour la persistance, pas de bind mounts en prod
- **Secrets** : Utilisez `_FILE` suffix ou Docker secrets pour les mots de passe
- **Initialisation** : Scripts dans `/docker-entrypoint-initdb.d/` ex√©cut√©s au premier d√©marrage uniquement
- **Configuration** : Montez des fichiers `.cnf` dans `/etc/mysql/conf.d/`
- **S√©curit√©** : User non-root, read-only filesystem, security scanning
- **Healthchecks** : Impl√©mentez des healthchecks robustes pour l'orchestration
- **Images custom** : Utilisez multi-stage builds pour optimiser la taille
- **MariaDB 11.8** : Profitez de utf8mb4 par d√©faut, Vector, optimisations SSD
- **Logs** : Redirigez vers stdout/stderr pour meilleure observabilit√©

---

## üîó Ressources et r√©f√©rences

### Documentation officielle
- [üìñ MariaDB Docker Hub](https://hub.docker.com/_/mariadb)
- [üìñ MariaDB Container Documentation](https://mariadb.com/kb/en/installing-and-using-mariadb-via-docker/)
- [üìñ Docker Best Practices](https://docs.docker.com/develop/dev-best-practices/)
- [üìñ Dockerfile Reference](https://docs.docker.com/engine/reference/builder/)

### Images et registries
- [Docker Hub - MariaDB](https://hub.docker.com/_/mariadb)
- [Bitnami MariaDB](https://hub.docker.com/r/bitnami/mariadb)
- [GitHub Container Registry](https://github.com/MariaDB/mariadb-docker)

### Outils compl√©mentaires
- [Trivy](https://github.com/aquasecurity/trivy) - Vulnerability scanning
- [Dive](https://github.com/wagoodman/dive) - Image layer analysis
- [Hadolint](https://github.com/hadolint/hadolint) - Dockerfile linter

### Exemples de configurations
- [MariaDB Docker Examples](https://github.com/docker-library/docs/tree/master/mariadb)
- [Production Dockerfiles](https://github.com/bitnami/containers/tree/main/bitnami/mariadb)

---

## ‚û°Ô∏è Section suivante

**16.3.2 Docker Compose pour d√©veloppement** : D√©couvrez comment orchestrer des stacks MariaDB compl√®tes avec Docker Compose, incluant r√©plication, monitoring, et environnements multi-services.

---

**MariaDB** : 11.8 LTS

‚è≠Ô∏è [Docker Compose pour d√©veloppement](/16-devops-automatisation/03.2-docker-compose.md)
