ğŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 16.8.2 Liquibase - Migrations avancÃ©es avec DSL multi-format

> **Niveau** : AvancÃ© Ã  Expert  
> **DurÃ©e estimÃ©e** : 4-5 heures  
> **PrÃ©requis** : Section 16.8.1 (Flyway), SQL avancÃ©, CI/CD, Kubernetes, Git

## ğŸ¯ Objectifs d'apprentissage

Ã€ l'issue de cette section, vous serez capable de :
- Comprendre les diffÃ©rences entre Liquibase et Flyway et choisir l'outil appropriÃ©
- Utiliser les formats XML, YAML, JSON et SQL pour dÃ©finir des migrations
- ImplÃ©menter des rollbacks natifs et automatiques avec Liquibase
- Configurer des prÃ©conditions et contextes pour migrations conditionnelles
- GÃ©rer les changeSets avec tags et labels pour dÃ©ploiements ciblÃ©s
- IntÃ©grer Liquibase dans des pipelines CI/CD multi-environnements
- Orchestrer les migrations dans Kubernetes avec l'operator pattern
- Mettre en place des stratÃ©gies de branching Git complexes avec Liquibase
- GÃ©nÃ©rer automatiquement des changelogs depuis des bases existantes
- Monitorer et auditer l'Ã©tat des migrations en production

---

## Introduction

**Liquibase** est un outil open-source de gestion des migrations de bases de donnÃ©es qui se distingue par :

- **DSL multi-format** : XML, YAML, JSON, SQL (contrairement Ã  Flyway qui privilÃ©gie SQL)
- **Rollback natif** : GÃ©nÃ©ration automatique de commandes de rollback
- **Database refactoring** : Patterns de refactoring de schÃ©ma intÃ©grÃ©s
- **PrÃ©conditions** : ExÃ©cution conditionnelle des changements
- **Contextes et labels** : DÃ©ploiements ciblÃ©s par environnement ou feature
- **Diff et sync** : Comparaison et synchronisation de schÃ©mas

### Liquibase vs Flyway : Tableau comparatif

| CritÃ¨re | Liquibase | Flyway |
|---------|-----------|--------|
| **Formats** | XML, YAML, JSON, SQL | SQL principalement |
| **Rollback** | Natif, automatique | Manuel (Teams only) |
| **ComplexitÃ©** | Plus Ã©levÃ©e, plus flexible | Plus simple, opinionnÃ© |
| **PrÃ©conditions** | Oui, avancÃ©es | Non |
| **Contextes** | Oui (dev/staging/prod) | Non natif |
| **Database-agnostic** | Oui, abstraction forte | Oui, mais SQL natif |
| **Courbe d'apprentissage** | Moyenne Ã  Ã©levÃ©e | Faible |
| **Cas d'usage** | Migrations complexes, multi-DB | Migrations SQL simples |
| **CommunautÃ©** | Grande, Datical (commercial) | Grande, Redgate (commercial) |

ğŸ’¡ **Conseil** : Utilisez **Liquibase** si vous avez besoin de :
- Rollbacks automatiques frÃ©quents
- Migrations conditionnelles complexes
- Support multi-bases (MySQL, PostgreSQL, Oracle...)
- Abstraction database-agnostic

Utilisez **Flyway** si vous prÃ©fÃ©rez :
- SQL pur et simplicitÃ©
- Migrations linÃ©aires sans rollback
- IntÃ©gration rapide

---

## Architecture et concepts

### ModÃ¨le ChangeLog et ChangeSets

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Liquibase Architecture               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                         â”‚
â”‚  Master ChangeLog (db.changelog-master.xml)             â”‚
â”‚  â”œâ”€â”€ include: db.changelog-1.0.xml                      â”‚
â”‚  â”œâ”€â”€ include: db.changelog-2.0.xml                      â”‚
â”‚  â””â”€â”€ include: db.changelog-3.0.xml                      â”‚
â”‚                                                         â”‚
â”‚  db.changelog-1.0.xml                                   â”‚
â”‚  â”œâ”€â”€ changeSet id="1" author="alice"                    â”‚
â”‚  â”‚   â””â”€â”€ createTable: users                             â”‚
â”‚  â”œâ”€â”€ changeSet id="2" author="alice"                    â”‚
â”‚  â”‚   â””â”€â”€ addColumn: email                               â”‚
â”‚  â””â”€â”€ changeSet id="3" author="bob"                      â”‚
â”‚      â””â”€â”€ createIndex: idx_email                         â”‚
â”‚                â”‚                                        â”‚
â”‚                â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   Liquibase CLI / Docker / Maven            â”‚        â”‚
â”‚  â”‚   liquibase update                          â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                â”‚                                        â”‚
â”‚                â–¼                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚          MariaDB Database                   â”‚        â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚        â”‚
â”‚  â”‚  â”‚  DATABASECHANGELOG table            â”‚    â”‚        â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚        â”‚
â”‚  â”‚  â”‚ ID     â”‚ AUTHOR   â”‚ FILE   â”‚ MD5    â”‚    â”‚        â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚        â”‚
â”‚  â”‚  â”‚ 1      â”‚ alice    â”‚ 1.0.xmlâ”‚ abc123 â”‚    â”‚        â”‚
â”‚  â”‚  â”‚ 2      â”‚ alice    â”‚ 1.0.xmlâ”‚ def456 â”‚    â”‚        â”‚
â”‚  â”‚  â”‚ 3      â”‚ bob      â”‚ 1.0.xmlâ”‚ ghi789 â”‚    â”‚        â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚        â”‚
â”‚  â”‚                                             â”‚        â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚        â”‚
â”‚  â”‚  â”‚  DATABASECHANGELOGLOCK table        â”‚    â”‚        â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¤    â”‚        â”‚
â”‚  â”‚  â”‚ ID     â”‚ LOCKED   â”‚ LOCKBY   â”‚ ...  â”‚    â”‚        â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜    â”‚        â”‚
â”‚  â”‚                                             â”‚        â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚        â”‚
â”‚  â”‚  â”‚   Application Schema                â”‚    â”‚        â”‚
â”‚  â”‚  â”‚   - users (id, email, ...)          â”‚    â”‚        â”‚
â”‚  â”‚  â”‚   - indexes, constraints            â”‚    â”‚        â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Tables de mÃ©tadonnÃ©es Liquibase

**DATABASECHANGELOG :**
```sql
CREATE TABLE DATABASECHANGELOG (
    ID VARCHAR(255) NOT NULL,
    AUTHOR VARCHAR(255) NOT NULL,
    FILENAME VARCHAR(255) NOT NULL,
    DATEEXECUTED TIMESTAMP NOT NULL,
    ORDEREXECUTED INT NOT NULL,
    EXECTYPE VARCHAR(10) NOT NULL,
    MD5SUM VARCHAR(35),
    DESCRIPTION VARCHAR(255),
    COMMENTS VARCHAR(255),
    TAG VARCHAR(255),
    LIQUIBASE VARCHAR(20),
    CONTEXTS VARCHAR(255),
    LABELS VARCHAR(255),
    DEPLOYMENT_ID VARCHAR(10),
    PRIMARY KEY (ID, AUTHOR, FILENAME)
) ENGINE=InnoDB;
```

**DATABASECHANGELOGLOCK :**
```sql
CREATE TABLE DATABASECHANGELOGLOCK (
    ID INT NOT NULL,
    LOCKED TINYINT(1) NOT NULL,
    LOCKGRANTED TIMESTAMP,
    LOCKEDBY VARCHAR(255),
    PRIMARY KEY (ID)
) ENGINE=InnoDB;
```

### Structure changeSet

```xml
<changeSet id="unique-id" author="developer-name">
    <!-- Changes -->
    <createTable tableName="users">
        <column name="id" type="BIGINT" autoIncrement="true">
            <constraints primaryKey="true"/>
        </column>
    </createTable>
    
    <!-- Rollback (optionnel, auto-gÃ©nÃ©rÃ© si possible) -->
    <rollback>
        <dropTable tableName="users"/>
    </rollback>
</changeSet>
```

---

## Installation et configuration

### 1. Installation via CLI

**Linux/macOS :**
```bash
# TÃ©lÃ©chargement
wget https://github.com/liquibase/liquibase/releases/download/v4.25.1/liquibase-4.25.1.tar.gz
tar -xzf liquibase-4.25.1.tar.gz -C /opt/liquibase

# Ajouter au PATH
export PATH=$PATH:/opt/liquibase
echo 'export PATH=$PATH:/opt/liquibase' >> ~/.bashrc

# TÃ©lÃ©charger le driver MariaDB
wget https://repo1.maven.org/maven2/org/mariadb/jdbc/mariadb-java-client/3.3.2/mariadb-java-client-3.3.2.jar \
  -P /opt/liquibase/lib/

# VÃ©rifier l'installation
liquibase --version
# Liquibase Version: 4.25.1
```

**Docker (recommandÃ©) :**
```bash
# Image officielle
docker pull liquibase/liquibase:4.25.1

# Alias pour utilisation facile
alias liquibase='docker run --rm -v $(pwd):/liquibase/changelog liquibase/liquibase:4.25.1'

# Test
liquibase --version
```

### 2. Configuration Liquibase pour MariaDB

**liquibase.properties :**
```properties
# =============================================
# Liquibase Configuration - MariaDB 11.8 LTS
# =============================================

# --- Database Connection ---
driver: org.mariadb.jdbc.Driver
url: jdbc:mariadb://mariadb-primary-svc.production.svc.cluster.local:3306/myapp_production
username: liquibase_user
password: ${LIQUIBASE_PASSWORD}

# --- ChangeLog Location ---
changeLogFile: db.changelog-master.xml
# ou changeLogFile: db.changelog-master.yaml
# ou changeLogFile: db.changelog-master.sql

# --- Output ---
# Fichiers de sortie pour diff, documentation
outputFile: target/liquibase-output.txt

# --- Contexts ---
# DÃ©ploiement conditionnel par environnement
contexts: production
# contexts: dev,test,production

# --- Labels ---
# DÃ©ploiement par feature/release
# labels: release-1.0,feature-payments

# --- Performance ---
# Niveau de log
logLevel: INFO
# Verbose pour debug
# logLevel: DEBUG

# --- Schema Management ---
# SchÃ©ma par dÃ©faut
defaultSchemaName: myapp_production
# Liquibase tables schema
liquibaseSchemaName: myapp_production

# --- Rollback ---
# Nombre de changeSets Ã  rollback
rollbackCount: 1

# --- Classpath ---
# Driver MariaDB
classpath: /liquibase/lib/mariadb-java-client-3.3.2.jar

# --- Changeset Validation ---
# VÃ©rifier les checksums
validateChecksums: true

# --- Snapshot ---
# Format de snapshot (pour diff)
snapshotFormat: json
```

### 3. Structure de projet recommandÃ©e

```
myapp-database/
â”œâ”€â”€ liquibase.properties           # Configuration principale
â”œâ”€â”€ liquibase-dev.properties       # Override dev
â”œâ”€â”€ liquibase-prod.properties      # Override production
â”œâ”€â”€ changelog/
â”‚   â”œâ”€â”€ db.changelog-master.xml    # Master changelog
â”‚   â”œâ”€â”€ releases/
â”‚   â”‚   â”œâ”€â”€ db.changelog-1.0.xml   # Release 1.0
â”‚   â”‚   â”œâ”€â”€ db.changelog-1.1.xml   # Release 1.1
â”‚   â”‚   â””â”€â”€ db.changelog-2.0.xml   # Release 2.0
â”‚   â”œâ”€â”€ rollback/
â”‚   â”‚   â””â”€â”€ rollback-scripts.sql   # Rollback manuels
â”‚   â””â”€â”€ data/
â”‚       â””â”€â”€ seed-data.xml          # DonnÃ©es initiales
â”œâ”€â”€ docker-compose.yml             # Test local
â”œâ”€â”€ Dockerfile                     # Image Liquibase custom
â”œâ”€â”€ pom.xml                        # Maven (optionnel)
â””â”€â”€ README.md
```

---

## Migrations avec diffÃ©rents formats

### 1. Format XML (le plus complet)

**db.changelog-master.xml :**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.25.xsd">

    <!-- Include release changelogs -->
    <include file="changelog/releases/db.changelog-1.0.xml"/>
    <include file="changelog/releases/db.changelog-1.1.xml"/>
    <include file="changelog/releases/db.changelog-2.0.xml"/>
    
</databaseChangeLog>
```

**db.changelog-1.0.xml :**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.25.xsd">

    <!-- ============================================
         ChangeSet 1: Create users table
         Author: DevOps Team
         Date: 2025-01-15
         ============================================ -->
    <changeSet id="1" author="alice">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="users"/>
            </not>
        </preConditions>
        
        <createTable tableName="users" remarks="Application users">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="pk_users"/>
            </column>
            <column name="email" type="VARCHAR(255)">
                <constraints nullable="false" unique="true" uniqueConstraintName="uk_users_email"/>
            </column>
            <column name="username" type="VARCHAR(100)">
                <constraints nullable="false" unique="true" uniqueConstraintName="uk_users_username"/>
            </column>
            <column name="password_hash" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="first_name" type="VARCHAR(100)"/>
            <column name="last_name" type="VARCHAR(100)"/>
            <column name="is_active" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
        </createTable>
        
        <modifySql dbms="mariadb,mysql">
            <append value=" ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci"/>
        </modifySql>
        
        <!-- Rollback automatique gÃ©nÃ©rÃ© : dropTable users -->
    </changeSet>

    <!-- ============================================
         ChangeSet 2: Create roles table
         ============================================ -->
    <changeSet id="2" author="alice">
        <createTable tableName="roles">
            <column name="id" type="INT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="name" type="VARCHAR(50)">
                <constraints nullable="false" unique="true"/>
            </column>
            <column name="description" type="TEXT"/>
            <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
        
        <modifySql dbms="mariadb,mysql">
            <append value=" ENGINE=InnoDB DEFAULT CHARSET=utf8mb4"/>
        </modifySql>
    </changeSet>

    <!-- ============================================
         ChangeSet 3: Create user_roles mapping
         ============================================ -->
    <changeSet id="3" author="alice">
        <createTable tableName="user_roles">
            <column name="user_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="role_id" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="granted_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
        </createTable>
        
        <!-- Composite primary key -->
        <addPrimaryKey tableName="user_roles" 
                       columnNames="user_id,role_id" 
                       constraintName="pk_user_roles"/>
        
        <!-- Foreign keys -->
        <addForeignKeyConstraint baseTableName="user_roles"
                                 baseColumnNames="user_id"
                                 constraintName="fk_user_roles_user"
                                 referencedTableName="users"
                                 referencedColumnNames="id"
                                 onDelete="CASCADE"/>
        
        <addForeignKeyConstraint baseTableName="user_roles"
                                 baseColumnNames="role_id"
                                 constraintName="fk_user_roles_role"
                                 referencedTableName="roles"
                                 referencedColumnNames="id"
                                 onDelete="CASCADE"/>
        
        <modifySql dbms="mariadb,mysql">
            <append value=" ENGINE=InnoDB"/>
        </modifySql>
    </changeSet>

    <!-- ============================================
         ChangeSet 4: Insert default roles
         Context: dev,staging,production
         ============================================ -->
    <changeSet id="4" author="alice" context="dev,staging,production">
        <insert tableName="roles">
            <column name="name" value="admin"/>
            <column name="description" value="Administrator with full access"/>
        </insert>
        <insert tableName="roles">
            <column name="name" value="user"/>
            <column name="description" value="Standard user"/>
        </insert>
        <insert tableName="roles">
            <column name="name" value="guest"/>
            <column name="description" value="Guest with read-only access"/>
        </insert>
        
        <!-- Rollback manuel -->
        <rollback>
            <delete tableName="roles">
                <where>name IN ('admin', 'user', 'guest')</where>
            </delete>
        </rollback>
    </changeSet>

    <!-- ============================================
         ChangeSet 5: Add indexes for performance
         ============================================ -->
    <changeSet id="5" author="bob">
        <createIndex indexName="idx_users_active" tableName="users">
            <column name="is_active"/>
            <column name="created_at"/>
        </createIndex>
        
        <createIndex indexName="idx_user_roles_user" tableName="user_roles">
            <column name="user_id"/>
        </createIndex>
        
        <!-- Rollback auto-gÃ©nÃ©rÃ© : dropIndex -->
    </changeSet>

</databaseChangeLog>
```

### 2. Format YAML (plus lisible)

**db.changelog-1.1.yaml :**
```yaml
# ============================================
# Liquibase ChangeLog - Release 1.1
# Author: DevOps Team
# Date: 2025-01-20
# ============================================

databaseChangeLog:
  - changeSet:
      id: 6
      author: alice
      comment: Add phone column to users
      preConditions:
        - onFail: MARK_RAN
        - not:
            - columnExists:
                tableName: users
                columnName: phone
      changes:
        - addColumn:
            tableName: users
            columns:
              - column:
                  name: phone
                  type: VARCHAR(20)
                  afterColumn: email
              - column:
                  name: phone_verified
                  type: BOOLEAN
                  defaultValueBoolean: false
                  constraints:
                    nullable: false
              - column:
                  name: phone_verified_at
                  type: TIMESTAMP
      # Rollback auto-gÃ©nÃ©rÃ© : dropColumn

  - changeSet:
      id: 7
      author: alice
      comment: Add index on phone
      changes:
        - createIndex:
            indexName: idx_users_phone
            tableName: users
            columns:
              - column:
                  name: phone

  - changeSet:
      id: 8
      author: bob
      comment: Create addresses table
      changes:
        - createTable:
            tableName: addresses
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    primaryKeyName: pk_addresses
              - column:
                  name: user_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: address_type
                  type: VARCHAR(20)
                  defaultValue: shipping
                  constraints:
                    nullable: false
              - column:
                  name: street_address
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: city
                  type: VARCHAR(100)
                  constraints:
                    nullable: false
              - column:
                  name: postal_code
                  type: VARCHAR(20)
              - column:
                  name: country
                  type: VARCHAR(2)
                  constraints:
                    nullable: false
              - column:
                  name: is_default
                  type: BOOLEAN
                  defaultValueBoolean: false
              - column:
                  name: created_at
                  type: TIMESTAMP
                  defaultValueComputed: CURRENT_TIMESTAMP
        
        # Foreign key
        - addForeignKeyConstraint:
            baseTableName: addresses
            baseColumnNames: user_id
            constraintName: fk_addresses_user
            referencedTableName: users
            referencedColumnNames: id
            onDelete: CASCADE
        
        # Index
        - createIndex:
            indexName: idx_addresses_user
            tableName: addresses
            columns:
              - column:
                  name: user_id
              - column:
                  name: is_default

  - changeSet:
      id: 9
      author: bob
      comment: Add constraint on address_type
      changes:
        - sql:
            dbms: mariadb,mysql
            sql: >
              ALTER TABLE addresses 
              ADD CONSTRAINT chk_address_type 
              CHECK (address_type IN ('billing', 'shipping', 'other'))
      rollback:
        - sql:
            sql: ALTER TABLE addresses DROP CONSTRAINT chk_address_type
```

### 3. Format JSON

**db.changelog-1.2.json :**
```json
{
  "databaseChangeLog": [
    {
      "changeSet": {
        "id": "10",
        "author": "charlie",
        "comment": "Add subscription tiers",
        "changes": [
          {
            "createTable": {
              "tableName": "subscription_tiers",
              "columns": [
                {
                  "column": {
                    "name": "id",
                    "type": "INT",
                    "autoIncrement": true,
                    "constraints": {
                      "primaryKey": true
                    }
                  }
                },
                {
                  "column": {
                    "name": "name",
                    "type": "VARCHAR(50)",
                    "constraints": {
                      "nullable": false,
                      "unique": true
                    }
                  }
                },
                {
                  "column": {
                    "name": "price_monthly",
                    "type": "DECIMAL(10,2)",
                    "constraints": {
                      "nullable": false
                    }
                  }
                },
                {
                  "column": {
                    "name": "price_yearly",
                    "type": "DECIMAL(10,2)",
                    "constraints": {
                      "nullable": false
                    }
                  }
                },
                {
                  "column": {
                    "name": "features",
                    "type": "JSON"
                  }
                }
              ]
            }
          }
        ]
      }
    },
    {
      "changeSet": {
        "id": "11",
        "author": "charlie",
        "comment": "Insert default subscription tiers",
        "context": "!test",
        "changes": [
          {
            "insert": {
              "tableName": "subscription_tiers",
              "columns": [
                {"column": {"name": "name", "value": "free"}},
                {"column": {"name": "price_monthly", "valueNumeric": 0}},
                {"column": {"name": "price_yearly", "valueNumeric": 0}},
                {"column": {"name": "features", "value": "[\"basic_features\"]"}}
              ]
            }
          },
          {
            "insert": {
              "tableName": "subscription_tiers",
              "columns": [
                {"column": {"name": "name", "value": "pro"}},
                {"column": {"name": "price_monthly", "valueNumeric": 29.99}},
                {"column": {"name": "price_yearly", "valueNumeric": 299.99}},
                {"column": {"name": "features", "value": "[\"basic_features\",\"analytics\"]"}}
              ]
            }
          }
        ],
        "rollback": [
          {
            "delete": {
              "tableName": "subscription_tiers",
              "where": "name IN ('free', 'pro')"
            }
          }
        ]
      }
    }
  ]
}
```

### 4. Format SQL (formatted SQL)

**db.changelog-1.3.sql :**
```sql
--liquibase formatted sql

--changeset alice:12 context:production
--comment: Create audit_logs table for compliance
CREATE TABLE audit_logs (
    id BIGINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT UNSIGNED,
    action VARCHAR(50) NOT NULL,
    entity_type VARCHAR(50) NOT NULL,
    entity_id BIGINT UNSIGNED,
    details JSON,
    ip_address VARCHAR(45),
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    KEY idx_audit_user (user_id, created_at),
    KEY idx_audit_entity (entity_type, entity_id),
    CONSTRAINT fk_audit_user FOREIGN KEY (user_id) 
        REFERENCES users(id) ON DELETE SET NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
--rollback DROP TABLE audit_logs;

--changeset bob:13 labels:feature-sessions
--comment: Create user_sessions table
CREATE TABLE user_sessions (
    id VARCHAR(255) NOT NULL PRIMARY KEY,
    user_id BIGINT UNSIGNED NOT NULL,
    token_hash VARCHAR(255) NOT NULL,
    ip_address VARCHAR(45),
    user_agent TEXT,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP NOT NULL,
    last_activity TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    KEY idx_sessions_user (user_id, expires_at),
    KEY idx_sessions_token (token_hash),
    CONSTRAINT fk_sessions_user FOREIGN KEY (user_id) 
        REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
--rollback DROP TABLE user_sessions;

--changeset charlie:14 runAlways:true runOnChange:true
--comment: Refresh materialized view (repeatable)
DROP VIEW IF EXISTS v_active_users;
CREATE VIEW v_active_users AS
SELECT 
    u.id,
    u.email,
    u.username,
    CONCAT(u.first_name, ' ', u.last_name) AS full_name,
    GROUP_CONCAT(r.name) AS roles
FROM users u
LEFT JOIN user_roles ur ON u.id = ur.user_id
LEFT JOIN roles r ON ur.role_id = r.id
WHERE u.is_active = TRUE
GROUP BY u.id;
--rollback DROP VIEW v_active_users;
```

---

## Rollback natif et automatique

### 1. Rollback auto-gÃ©nÃ©rÃ©

Pour la plupart des changements, Liquibase gÃ©nÃ¨re automatiquement le rollback :

```xml
<changeSet id="15" author="alice">
    <!-- CrÃ©ation table : rollback = dropTable -->
    <createTable tableName="products">
        <column name="id" type="BIGINT" autoIncrement="true">
            <constraints primaryKey="true"/>
        </column>
        <column name="name" type="VARCHAR(255)"/>
    </createTable>
    <!-- Pas besoin de spÃ©cifier rollback, auto-gÃ©nÃ©rÃ© -->
</changeSet>

<changeSet id="16" author="alice">
    <!-- Ajout colonne : rollback = dropColumn -->
    <addColumn tableName="products">
        <column name="description" type="TEXT"/>
    </addColumn>
</changeSet>
```

### 2. Rollback manuel pour changements complexes

```xml
<changeSet id="17" author="bob">
    <comment>Migrate pricing from single to multi-tier</comment>
    
    <!-- Changements -->
    <addColumn tableName="products">
        <column name="tier_pricing" type="JSON"/>
    </addColumn>
    
    <sql>
        UPDATE products 
        SET tier_pricing = JSON_OBJECT(
            'basic', price,
            'pro', price * 1.5,
            'enterprise', price * 2.0
        );
    </sql>
    
    <dropColumn tableName="products" columnName="price"/>
    
    <!-- Rollback manuel -->
    <rollback>
        <addColumn tableName="products">
            <column name="price" type="DECIMAL(10,2)"/>
        </addColumn>
        <sql>
            UPDATE products 
            SET price = JSON_EXTRACT(tier_pricing, '$.basic');
        </sql>
        <dropColumn tableName="products" columnName="tier_pricing"/>
    </rollback>
</changeSet>
```

### 3. Rollback vide (non rÃ©versible)

```xml
<changeSet id="18" author="charlie">
    <comment>Archive old data (irreversible)</comment>
    
    <delete tableName="audit_logs">
        <where>created_at < DATE_SUB(NOW(), INTERVAL 7 YEAR)</where>
    </delete>
    
    <!-- Rollback vide : impossible de rÃ©cupÃ©rer les donnÃ©es -->
    <rollback/>
</changeSet>
```

### 4. Commandes rollback

```bash
# Rollback du dernier changeSet
liquibase rollback-count 1

# Rollback jusqu'Ã  une date
liquibase rollback-to-date 2025-01-15

# Rollback jusqu'Ã  un tag
liquibase rollback myapp-v1.0

# Rollback SQL (dry-run, gÃ©nÃ¨re le SQL sans exÃ©cuter)
liquibase rollback-count-sql 1 > rollback.sql
cat rollback.sql  # Inspecter avant d'exÃ©cuter

# ExÃ©cuter le rollback gÃ©nÃ©rÃ©
liquibase execute-sql --sql-file=rollback.sql
```

---

## PrÃ©conditions et contextes

### 1. PrÃ©conditions (preConditions)

ExÃ©cuter un changeSet **seulement si** certaines conditions sont remplies :

```xml
<changeSet id="19" author="alice">
    <preConditions onFail="MARK_RAN">
        <!-- ExÃ©cuter seulement si la table n'existe pas -->
        <not>
            <tableExists tableName="notifications"/>
        </not>
    </preConditions>
    
    <createTable tableName="notifications">
        <column name="id" type="BIGINT" autoIncrement="true">
            <constraints primaryKey="true"/>
        </column>
        <column name="message" type="TEXT"/>
    </createTable>
</changeSet>

<changeSet id="20" author="bob">
    <preConditions onFail="WARN" onError="MARK_RAN">
        <!-- ExÃ©cuter seulement sur MariaDB 11+-->
        <dbms type="mariadb"/>
        <sqlCheck expectedResult="1">
            SELECT IF(SUBSTRING_INDEX(VERSION(), '.', 1) >= 11, 1, 0)
        </sqlCheck>
    </preConditions>
    
    <!-- Utiliser une feature MariaDB 11+ -->
    <sql>
        ALTER TABLE users 
        ADD COLUMN vector_embedding VECTOR(512) AFTER email;
    </sql>
</changeSet>

<changeSet id="21" author="charlie">
    <preConditions onFail="HALT">
        <!-- Bloquer si la colonne existe dÃ©jÃ  (sÃ©curitÃ©) -->
        <not>
            <columnExists tableName="users" columnName="ssn"/>
        </not>
        <!-- ET si en production -->
        <sqlCheck expectedResult="production">
            SELECT '${environment}'
        </sqlCheck>
    </preConditions>
    
    <addColumn tableName="users">
        <column name="ssn" type="VARCHAR(11)"/>
    </addColumn>
</changeSet>
```

**Actions onFail :**
- `HALT` : ArrÃªter l'exÃ©cution
- `CONTINUE` : Ignorer ce changeSet et continuer
- `MARK_RAN` : Marquer comme exÃ©cutÃ© sans l'appliquer
- `WARN` : Afficher un warning et continuer

### 2. Contextes (dÃ©ploiement conditionnel)

```xml
<!-- DonnÃ©es de test uniquement en dev -->
<changeSet id="22" author="alice" context="dev,test">
    <insert tableName="users">
        <column name="email" value="test@example.com"/>
        <column name="username" value="testuser"/>
        <column name="password_hash" value="hashed_password"/>
    </insert>
</changeSet>

<!-- Index uniquement en production -->
<changeSet id="23" author="bob" context="production">
    <createIndex indexName="idx_users_created_at" tableName="users">
        <column name="created_at"/>
    </createIndex>
</changeSet>

<!-- Logs dÃ©taillÃ©s sauf en production -->
<changeSet id="24" author="charlie" context="!production">
    <createTable tableName="debug_logs">
        <column name="id" type="BIGINT" autoIncrement="true">
            <constraints primaryKey="true"/>
        </column>
        <column name="message" type="TEXT"/>
    </createTable>
</changeSet>
```

ExÃ©cution avec contextes :
```bash
# Dev
liquibase --contexts=dev update

# Staging
liquibase --contexts=staging update

# Production
liquibase --contexts=production update

# Multi-contextes
liquibase --contexts="production,feature-payments" update
```

### 3. Labels (dÃ©ploiement par feature)

```xml
<changeSet id="25" author="alice" labels="feature-notifications">
    <createTable tableName="notification_preferences">
        <column name="user_id" type="BIGINT">
            <constraints primaryKey="true"/>
        </column>
        <column name="email_notifications" type="BOOLEAN" defaultValueBoolean="true"/>
        <column name="sms_notifications" type="BOOLEAN" defaultValueBoolean="false"/>
    </createTable>
</changeSet>

<changeSet id="26" author="bob" labels="feature-payments,release-1.0">
    <createTable tableName="payment_methods">
        <column name="id" type="BIGINT" autoIncrement="true">
            <constraints primaryKey="true"/>
        </column>
        <column name="user_id" type="BIGINT"/>
        <column name="card_last4" type="VARCHAR(4)"/>
    </createTable>
</changeSet>
```

DÃ©ploiement par labels :
```bash
# DÃ©ployer seulement feature-notifications
liquibase --labels=feature-notifications update

# DÃ©ployer release 1.0 complÃ¨te
liquibase --labels=release-1.0 update

# Combiner labels ET contextes
liquibase --contexts=production --labels=release-1.0 update
```

---

## IntÃ©gration CI/CD

### 1. Pipeline GitLab CI/CD

**.gitlab-ci.yml :**
```yaml
stages:
  - validate
  - test
  - migrate-staging
  - tag
  - migrate-production

variables:
  LIQUIBASE_VERSION: "4.25.1"
  LIQUIBASE_IMAGE: "liquibase/liquibase:${LIQUIBASE_VERSION}"

# ========================================
# Stage 1: Validation
# ========================================
validate-changelogs:
  stage: validate
  image: ${LIQUIBASE_IMAGE}
  script:
    # Valider la syntaxe XML/YAML
    - liquibase validate
    
    # GÃ©nÃ©rer documentation
    - liquibase db-doc target/db-doc
    
    # Diff contre base de rÃ©fÃ©rence
    - |
      liquibase diff \
        --referenceUrl=jdbc:mariadb://mariadb-reference:3306/reference_db \
        --referenceUsername=root \
        --referencePassword=${REFERENCE_DB_PASSWORD}
  artifacts:
    paths:
      - target/db-doc
    expire_in: 7 days
  only:
    changes:
      - changelog/**/*

# ========================================
# Stage 2: Test sur base Ã©phÃ©mÃ¨re
# ========================================
test-migrations:
  stage: test
  image: ${LIQUIBASE_IMAGE}
  services:
    - name: mariadb:11.8.2
      alias: mariadb
  variables:
    MARIADB_ROOT_PASSWORD: test_root
    MARIADB_DATABASE: test_db
    LIQUIBASE_COMMAND_URL: "jdbc:mariadb://mariadb:3306/test_db"
    LIQUIBASE_COMMAND_USERNAME: "root"
    LIQUIBASE_COMMAND_PASSWORD: "test_root"
  script:
    # Attendre MariaDB
    - |
      until liquibase status; do
        echo "Waiting for MariaDB..."
        sleep 2
      done
    
    # Appliquer migrations
    - liquibase --contexts=dev update
    
    # Valider
    - liquibase validate
    
    # Tester rollback
    - liquibase rollback-count 1
    - liquibase update
    
    # GÃ©nÃ©rer diff
    - liquibase diff
  only:
    changes:
      - changelog/**/*

# ========================================
# Stage 3: Migration Staging
# ========================================
migrate-staging:
  stage: migrate-staging
  image: ${LIQUIBASE_IMAGE}
  environment:
    name: staging
  variables:
    LIQUIBASE_COMMAND_URL: "${STAGING_DB_URL}"
    LIQUIBASE_COMMAND_USERNAME: "${STAGING_DB_USER}"
    LIQUIBASE_COMMAND_PASSWORD: "${STAGING_DB_PASSWORD}"
    LIQUIBASE_COMMAND_CONTEXTS: "staging"
  script:
    # Status avant
    - liquibase status --verbose
    
    # Dry-run (Liquibase Pro)
    # - liquibase update-sql > update-staging.sql
    # - cat update-staging.sql
    
    # Migration
    - liquibase update
    
    # Validation
    - liquibase validate
    
    # Snapshot pour diff ultÃ©rieur
    - liquibase snapshot --snapshotFormat=json > staging-snapshot.json
  artifacts:
    paths:
      - staging-snapshot.json
  only:
    - develop

# ========================================
# Stage 4: Tagging
# ========================================
tag-release:
  stage: tag
  image: ${LIQUIBASE_IMAGE}
  variables:
    LIQUIBASE_COMMAND_URL: "${STAGING_DB_URL}"
    LIQUIBASE_COMMAND_USERNAME: "${STAGING_DB_USER}"
    LIQUIBASE_COMMAND_PASSWORD: "${STAGING_DB_PASSWORD}"
  script:
    # CrÃ©er un tag pour rollback futur
    - liquibase tag "release-${CI_COMMIT_TAG}"
  only:
    - tags

# ========================================
# Stage 5: Migration Production
# ========================================
migrate-production:
  stage: migrate-production
  image: ${LIQUIBASE_IMAGE}
  environment:
    name: production
    url: https://myapp.com
  variables:
    LIQUIBASE_COMMAND_URL: "${PROD_DB_URL}"
    LIQUIBASE_COMMAND_USERNAME: "${PROD_DB_USER}"
    LIQUIBASE_COMMAND_PASSWORD: "${PROD_DB_PASSWORD}"
    LIQUIBASE_COMMAND_CONTEXTS: "production"
    LIQUIBASE_COMMAND_LABELS: "${CI_COMMIT_TAG}"
  before_script:
    # Backup avant migration
    - |
      echo "Creating pre-migration backup..."
      mysqldump -h ${PROD_DB_HOST} -u ${PROD_DB_USER} -p${PROD_DB_PASSWORD} \
        --single-transaction --routines \
        myapp_production | gzip > backup-pre-migration-$(date +%Y%m%d-%H%M%S).sql.gz
      
      aws s3 cp backup-*.sql.gz s3://mariadb-backups-prod/pre-migration/
  script:
    # Status dÃ©taillÃ©
    - liquibase status --verbose
    
    # Changements en attente
    - liquibase update-count-sql 999 > update-production.sql
    - cat update-production.sql
    
    # Pause pour revue manuelle (optionnel)
    # - read -p "Review SQL above. Press Enter to continue or Ctrl+C to abort..."
    
    # Migration
    - liquibase update
    
    # Tag post-migration
    - liquibase tag "prod-${CI_COMMIT_TAG}-$(date +%Y%m%d-%H%M%S)"
    
    # Validation
    - liquibase validate
    
    # Snapshot final
    - liquibase snapshot --snapshotFormat=json > prod-snapshot-${CI_COMMIT_TAG}.json
  artifacts:
    paths:
      - update-production.sql
      - prod-snapshot-*.json
  only:
    - main
  when: manual
  allow_failure: false
```

### 2. Pipeline GitHub Actions

**.github/workflows/liquibase-migrations.yml :**
```yaml
name: Liquibase Migrations

on:
  push:
    branches: [main, develop]
    paths:
      - 'changelog/**'
  pull_request:
    branches: [main]
    paths:
      - 'changelog/**'

env:
  LIQUIBASE_VERSION: '4.25.1'

jobs:
  validate:
    name: Validate ChangeLogs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Liquibase
        uses: liquibase-github-actions/setup@v4
        with:
          liquibase-version: ${{ env.LIQUIBASE_VERSION }}
      
      - name: Validate syntax
        uses: liquibase-github-actions/validate@v4
        with:
          changelogFile: 'db.changelog-master.xml'
          url: 'offline:mariadb?version=11.8'

  test:
    name: Test Migrations
    runs-on: ubuntu-latest
    needs: validate
    services:
      mariadb:
        image: mariadb:11.8.2
        env:
          MARIADB_ROOT_PASSWORD: test_root
          MARIADB_DATABASE: test_db
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mariadb -u root -ptest_root -e 'SELECT 1'"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Liquibase
        uses: liquibase-github-actions/setup@v4
        with:
          liquibase-version: ${{ env.LIQUIBASE_VERSION }}
      
      - name: Run migrations
        uses: liquibase-github-actions/update@v4
        with:
          changelogFile: 'db.changelog-master.xml'
          url: 'jdbc:mariadb://127.0.0.1:3306/test_db'
          username: 'root'
          password: 'test_root'
          contexts: 'dev,test'
      
      - name: Validate result
        run: |
          mariadb -h 127.0.0.1 -u root -ptest_root test_db \
            -e "SHOW TABLES; SELECT * FROM DATABASECHANGELOG;"
      
      - name: Test rollback
        uses: liquibase-github-actions/rollback-count@v4
        with:
          changelogFile: 'db.changelog-master.xml'
          url: 'jdbc:mariadb://127.0.0.1:3306/test_db'
          username: 'root'
          password: 'test_root'
          count: 1

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Liquibase
        uses: liquibase-github-actions/setup@v4
        with:
          liquibase-version: ${{ env.LIQUIBASE_VERSION }}
      
      - name: Pre-migration backup
        run: |
          mysqldump -h ${{ secrets.PROD_DB_HOST }} \
            -u ${{ secrets.PROD_DB_USER }} \
            -p${{ secrets.PROD_DB_PASSWORD }} \
            --single-transaction myapp_production | gzip > backup.sql.gz
          aws s3 cp backup.sql.gz s3://backups/pre-migration/
      
      - name: Migrate production
        uses: liquibase-github-actions/update@v4
        with:
          changelogFile: 'db.changelog-master.xml'
          url: ${{ secrets.PROD_DB_URL }}
          username: ${{ secrets.PROD_DB_USER }}
          password: ${{ secrets.PROD_DB_PASSWORD }}
          contexts: 'production'
      
      - name: Tag release
        uses: liquibase-github-actions/tag@v4
        with:
          changelogFile: 'db.changelog-master.xml'
          url: ${{ secrets.PROD_DB_URL }}
          username: ${{ secrets.PROD_DB_USER }}
          password: ${{ secrets.PROD_DB_PASSWORD }}
          tag: 'prod-${{ github.sha }}'
```

---

## Liquibase dans Kubernetes

### 1. Job Kubernetes

**liquibase-migration-job.yaml :**
```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: liquibase-migrate-20250115
  namespace: production
  labels:
    app: liquibase
    component: database-migration
spec:
  ttlSecondsAfterFinished: 86400
  backoffLimit: 2
  
  template:
    metadata:
      labels:
        app: liquibase
    spec:
      restartPolicy: Never
      
      initContainers:
      # Wait for MariaDB
      - name: wait-for-db
        image: mariadb:11.8.2
        command:
        - /bin/bash
        - -c
        - |
          until mariadb -h ${DB_HOST} -u ${DB_USER} -p${DB_PASSWORD} -e "SELECT 1"; do
            echo "Waiting for MariaDB..."
            sleep 5
          done
      
      # Clone changelog from Git
      - name: git-sync
        image: k8s.gcr.io/git-sync:v3.6.3
        volumeMounts:
        - name: changelog
          mountPath: /tmp/git
        env:
        - name: GIT_SYNC_REPO
          value: "https://github.com/mycompany/database-migrations.git"
        - name: GIT_SYNC_BRANCH
          value: "main"
        - name: GIT_SYNC_ROOT
          value: "/tmp/git"
        - name: GIT_SYNC_DEST
          value: "changelog"
        - name: GIT_SYNC_ONE_TIME
          value: "true"
      
      containers:
      - name: liquibase
        image: liquibase/liquibase:4.25.1
        command:
        - liquibase
        - --changeLogFile=/liquibase/changelog/db.changelog-master.xml
        - --url=jdbc:mariadb://$(DB_HOST):3306/$(DB_NAME)
        - --username=$(DB_USER)
        - --password=$(DB_PASSWORD)
        - --contexts=$(CONTEXTS)
        - --labels=$(LABELS)
        - update
        
        env:
        - name: DB_HOST
          value: "mariadb-primary-svc"
        - name: DB_NAME
          value: "myapp_production"
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: liquibase-credentials
              key: username
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: liquibase-credentials
              key: password
        - name: CONTEXTS
          value: "production"
        - name: LABELS
          value: "release-1.0"
        
        volumeMounts:
        - name: changelog
          mountPath: /liquibase/changelog
          readOnly: true
        
        resources:
          requests:
            cpu: "500m"
            memory: "512Mi"
          limits:
            cpu: "1"
            memory: "1Gi"
      
      volumes:
      - name: changelog
        emptyDir: {}

---
apiVersion: v1
kind: Secret
metadata:
  name: liquibase-credentials
  namespace: production
type: Opaque
stringData:
  username: "liquibase_user"
  password: "SecureLiquibasePassword123!"
```

### 2. CronJob pour validation continue

**liquibase-validation-cronjob.yaml :**
```yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: liquibase-validate
  namespace: production
spec:
  schedule: "0 6 * * *"  # Quotidien Ã  6h
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
          - name: liquibase
            image: liquibase/liquibase:4.25.1
            command:
            - /bin/bash
            - -c
            - |
              # Validate schema integrity
              liquibase validate
              
              # Check for schema drift
              liquibase diff \
                --referenceUrl="offline:mariadb?snapshot=/liquibase/reference-snapshot.json"
              
              # Alert si drift dÃ©tectÃ©
              if [ $? -ne 0 ]; then
                curl -X POST "${SLACK_WEBHOOK}" \
                  -H 'Content-Type: application/json' \
                  -d '{"text":"âš ï¸ Schema drift detected in production database!"}'
                exit 1
              fi
            env:
            - name: LIQUIBASE_COMMAND_URL
              value: "jdbc:mariadb://mariadb-primary-svc:3306/myapp_production"
            - name: LIQUIBASE_COMMAND_USERNAME
              valueFrom:
                secretKeyRef:
                  name: liquibase-credentials
                  key: username
            - name: LIQUIBASE_COMMAND_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: liquibase-credentials
                  key: password
            - name: SLACK_WEBHOOK
              valueFrom:
                secretKeyRef:
                  name: slack-webhook
                  key: url
            volumeMounts:
            - name: changelog
              mountPath: /liquibase/changelog
            - name: reference-snapshot
              mountPath: /liquibase/reference-snapshot.json
              subPath: snapshot.json
          volumes:
          - name: changelog
            configMap:
              name: liquibase-changelog
          - name: reference-snapshot
            configMap:
              name: liquibase-reference-snapshot
```

---

## Diff et synchronisation de schÃ©mas

### 1. GÃ©nÃ©rer un changelog depuis une base existante

```bash
# GÃ©nÃ©rer changelog depuis une base de rÃ©fÃ©rence
liquibase generate-changelog \
  --changelog-file=generated-changelog.xml

# GÃ©nÃ©rer en YAML
liquibase generate-changelog \
  --changelog-file=generated-changelog.yaml

# GÃ©nÃ©rer seulement certaines tables
liquibase generate-changelog \
  --changelog-file=generated-changelog.xml \
  --includeObjects="table:users,roles"
```

### 2. Diff entre deux bases

```bash
# Comparer deux bases
liquibase diff \
  --url=jdbc:mariadb://localhost:3306/production_db \
  --username=root \
  --password=prod_password \
  --referenceUrl=jdbc:mariadb://localhost:3306/staging_db \
  --referenceUsername=root \
  --referencePassword=staging_password

# GÃ©nÃ©rer un changelog des diffÃ©rences
liquibase diff-changelog \
  --changelog-file=sync-prod-to-staging.xml \
  --url=jdbc:mariadb://localhost:3306/production_db \
  --username=root \
  --password=prod_password \
  --referenceUrl=jdbc:mariadb://localhost:3306/staging_db \
  --referenceUsername=root \
  --referencePassword=staging_password

# Appliquer le changelog de synchronisation
liquibase \
  --changelog-file=sync-prod-to-staging.xml \
  --url=jdbc:mariadb://localhost:3306/staging_db \
  --username=root \
  --password=staging_password \
  update
```

### 3. Snapshot pour versioning de schÃ©ma

```bash
# CrÃ©er un snapshot JSON du schÃ©ma actuel
liquibase snapshot \
  --snapshotFormat=json \
  --url=jdbc:mariadb://localhost:3306/myapp_production > prod-snapshot-20250115.json

# Comparer avec un snapshot prÃ©cÃ©dent
liquibase diff \
  --referenceUrl="offline:mariadb?snapshot=prod-snapshot-20250101.json" \
  --url=jdbc:mariadb://localhost:3306/myapp_production

# GÃ©nÃ©rer changelog des changements depuis snapshot
liquibase diff-changelog \
  --changelog-file=changes-since-20250101.xml \
  --referenceUrl="offline:mariadb?snapshot=prod-snapshot-20250101.json" \
  --url=jdbc:mariadb://localhost:3306/myapp_production
```

---

## Best practices de production

### 1. **Structure modulaire par release**

```xml
<!-- db.changelog-master.xml -->
<databaseChangeLog>
    <!-- Releases ordonnÃ©es -->
    <include file="releases/v1.0.0/db.changelog-1.0.0.xml"/>
    <include file="releases/v1.1.0/db.changelog-1.1.0.xml"/>
    <include file="releases/v2.0.0/db.changelog-2.0.0.xml"/>
    
    <!-- Hotfixes sÃ©parÃ©s -->
    <include file="hotfixes/db.changelog-hotfix-20250115.xml"/>
</databaseChangeLog>
```

### 2. **ID unique et traÃ§abilitÃ©**

```xml
<!-- Bon : ID unique avec prÃ©fixe release -->
<changeSet id="v1.0.0-001" author="alice@company.com">
    ...
</changeSet>

<!-- Mauvais : ID non unique, author ambigu -->
<changeSet id="1" author="alice">
    ...
</changeSet>
```

### 3. **Commentaires dÃ©taillÃ©s**

```xml
<changeSet id="v2.0.0-042" author="bob@company.com">
    <comment>
        Add GDPR compliance fields to users table.
        Jira: PROJ-1234
        PR: https://github.com/company/repo/pull/567
        Reviewer: charlie@company.com
    </comment>
    <addColumn tableName="users">
        <column name="gdpr_consent" type="BOOLEAN" defaultValueBoolean="false"/>
        <column name="gdpr_consent_date" type="TIMESTAMP"/>
    </addColumn>
</changeSet>
```

### 4. **Rollback explicite pour donnÃ©es**

```xml
<changeSet id="v1.5.0-010" author="alice">
    <insert tableName="subscription_tiers">
        <column name="name" value="premium"/>
        <column name="price" valueNumeric="99.99"/>
    </insert>
    
    <!-- Rollback explicite pour suppressions de donnÃ©es -->
    <rollback>
        <delete tableName="subscription_tiers">
            <where>name = 'premium'</where>
        </delete>
    </rollback>
</changeSet>
```

### 5. **PrÃ©conditions de sÃ©curitÃ©**

```xml
<changeSet id="v2.1.0-005" author="charlie">
    <preConditions onFail="HALT">
        <!-- Bloquer en production si donnÃ©es sensibles prÃ©sentes -->
        <sqlCheck expectedResult="0">
            SELECT COUNT(*) FROM users WHERE ssn IS NOT NULL
        </sqlCheck>
    </preConditions>
    
    <dropColumn tableName="users" columnName="ssn"/>
</changeSet>
```

### 6. **Validation de checksum**

```bash
# Activer dans liquibase.properties
validateChecksums=true

# Ou via CLI
liquibase --validate-checksums=true update

# En cas de modification lÃ©gitime, mettre Ã  jour le checksum
liquibase clear-checksums
liquibase update
```

### 7. **Documentation automatique**

```bash
# GÃ©nÃ©rer documentation HTML du schÃ©ma
liquibase db-doc target/db-doc

# Servir localement pour revue
cd target/db-doc
python3 -m http.server 8000
# Ouvrir http://localhost:8000
```

---

## Troubleshooting

### ProblÃ¨me 1 : Lock persistant

**SymptÃ´mes :**
```
Waiting for changelog lock...
```

**Diagnostic :**
```sql
SELECT * FROM DATABASECHANGELOGLOCK;
```

**Solution :**
```bash
# Forcer le release du lock
liquibase release-locks

# Ou manuellement
UPDATE DATABASECHANGELOGLOCK SET LOCKED=0, LOCKEDBY=NULL, LOCKGRANTED=NULL WHERE ID=1;
```

### ProblÃ¨me 2 : Checksum mismatch

**SymptÃ´mes :**
```
Validation Failed:
     1 changesets check sum
          changelog/db.changelog-1.0.xml::v1.0.0-005::alice was: 8:abc123... but is now: 8:def456...
```

**Cause :** Le changeSet a Ã©tÃ© modifiÃ© aprÃ¨s application.

**Solutions :**

1. **Revenir Ã  la version originale (recommandÃ©) :**
```bash
git checkout HEAD~1 -- changelog/db.changelog-1.0.xml
```

2. **Clear checksums (dÃ©veloppement uniquement) :**
```bash
liquibase clear-checksums
```

3. **Nouvelle migration corrective :**
```xml
<changeSet id="v1.0.0-006" author="alice">
    <comment>Fix issue from v1.0.0-005</comment>
    <!-- Correction -->
</changeSet>
```

### ProblÃ¨me 3 : PrÃ©condition Ã©choue en production

**Diagnostic :**
```bash
liquibase --log-level=DEBUG update
```

**Solution temporaire :**
```bash
# Marquer le changeSet comme exÃ©cutÃ© sans l'appliquer
liquibase changelog-sync

# Ou marquer jusqu'Ã  un tag
liquibase changelog-sync-to-tag myapp-v1.0
```

---

## âœ… Points clÃ©s Ã  retenir

- **Multi-format flexible** : XML (complet), YAML (lisible), JSON, SQL formatÃ© selon prÃ©fÃ©rence
- **Rollback natif** : Auto-gÃ©nÃ©rÃ© pour la plupart des changements, manuel pour les cas complexes
- **PrÃ©conditions puissantes** : ExÃ©cution conditionnelle avec `onFail` (HALT, CONTINUE, MARK_RAN, WARN)
- **Contextes et labels** : DÃ©ploiement ciblÃ© par environnement (dev/staging/prod) ou feature
- **ChangeSets immutables** : ID unique, ne jamais modifier aprÃ¨s application
- **Diff et sync** : Comparaison de schÃ©mas et gÃ©nÃ©ration automatique de changelogs
- **Snapshot versioning** : Capturer l'Ã©tat du schÃ©ma pour comparaisons futures
- **GitOps friendly** : Changelogs versionnÃ©s dans Git, source unique de vÃ©ritÃ©
- **CI/CD intÃ©grÃ©** : Validation, test, et dÃ©ploiement automatisÃ© multi-environnements
- **Kubernetes Jobs** : Migrations via Jobs K8s avec git-sync pour source de vÃ©ritÃ©
- **Documentation auto** : GÃ©nÃ©ration de doc HTML du schÃ©ma avec `db-doc`
- **Validation continue** : CronJobs pour dÃ©tecter schema drift en production

---

## ğŸ”— Ressources et rÃ©fÃ©rences

### Documentation officielle
- **[Liquibase Documentation](https://docs.liquibase.com/)** - Documentation complÃ¨te
- **[Liquibase MariaDB](https://docs.liquibase.com/start/tutorials/mariadb.html)** - Tutorial MariaDB
- **[Best Practices](https://docs.liquibase.com/concepts/bestpractices.html)** - Best practices officielles
- **[ChangeSet Guidelines](https://docs.liquibase.com/concepts/changelogs/changeset.html)** - Guide changeSets

### Articles techniques
- **[Liquibase vs Flyway](https://www.liquibase.com/blog/liquibase-vs-flyway)** - Comparaison dÃ©taillÃ©e
- **[Database Refactoring](https://www.liquibase.com/refactoring)** - Patterns de refactoring
- **[GitOps for Databases](https://www.liquibase.com/blog/gitops-databases)** - GitOps avec Liquibase

### Outils
- **[Liquibase Hub](https://hub.liquibase.com/)** - Plateforme cloud pour collaboration
- **[Liquibase Pro](https://www.liquibase.com/products/pro)** - Version payante (rollback avancÃ©, dry-run)
- **[GitHub Actions](https://github.com/liquibase-github-actions)** - Actions officielles

---

## â¡ï¸ Section suivante

**16.8.3 gh-ost et pt-online-schema-change** : Migrations sans downtime sur tables volumineuses avec gh-ost (GitHub) et pt-online-schema-change (Percona), pour ALTER TABLE non-bloquants en production.

â­ï¸ [gh-ost et pt-online-schema-change](/16-devops-automatisation/08.3-gh-ost-pt-osc.md)
