üîù Retour au [Sommaire](/SOMMAIRE.md)

# 16.3.3 Volumes et persistance

> **Niveau** : Avanc√© √† Expert  
> **Dur√©e estim√©e** : 3-4 heures  
> **Pr√©requis** : Docker volumes, Storage systems, MariaDB internals, sections 16.3.1-16.3.2

## üéØ Objectifs d'apprentissage

√Ä l'issue de cette section, vous serez capable de :
- Ma√Ætriser les diff√©rents types de volumes Docker pour MariaDB
- Concevoir des strat√©gies de persistance adapt√©es √† chaque environnement
- Optimiser les performances de stockage pour les bases de donn√©es
- G√©rer les snapshots et la sauvegarde de volumes
- Impl√©menter des volume drivers avanc√©s (NFS, Ceph, cloud providers)
- Appliquer les meilleures pratiques de persistance en production
- Diagnostiquer et r√©soudre les probl√®mes de stockage

---

## Introduction

La persistance des donn√©es est **critique** pour les bases de donn√©es conteneuris√©es. Contrairement aux applications stateless, MariaDB n√©cessite un stockage durable, performant et fiable. Docker offre plusieurs m√©canismes de persistance, chacun avec ses avantages et contraintes.

### Pourquoi la persistance est cruciale pour MariaDB ?

**Risques sans persistance appropri√©e** :
- ‚ùå **Perte de donn√©es** : Destruction du conteneur = perte des donn√©es
- ‚ùå **Performance d√©grad√©e** : Stockage inadapt√© aux workloads database
- ‚ùå **Corruption** : Arr√™ts non gracieux peuvent corrompre les donn√©es
- ‚ùå **Scalabilit√© limit√©e** : Impossible de d√©placer les conteneurs
- ‚ùå **Backup complexe** : Difficile de sauvegarder sans volume

**Exigences pour MariaDB** :
- ‚úÖ **Durabilit√©** : Donn√©es persistent au-del√† du cycle de vie du conteneur
- ‚úÖ **Performance** : IOPS √©lev√©s, faible latence pour InnoDB
- ‚úÖ **Coh√©rence** : ACID compliance pr√©serv√©e
- ‚úÖ **Snapshots** : Possibilit√© de point-in-time recovery
- ‚úÖ **Scalabilit√©** : Migration entre h√¥tes, scaling horizontal

---

## Types de volumes Docker

### 1. Volumes nomm√©s (Recommended)

Les volumes nomm√©s sont **la m√©thode recommand√©e** pour la persistance des bases de donn√©es.

```bash
# Cr√©er un volume nomm√©
docker volume create mariadb_data

# Inspecter le volume
docker volume inspect mariadb_data

# Output :
[
    {
        "CreatedAt": "2025-12-14T10:30:00Z",
        "Driver": "local",
        "Labels": {},
        "Mountpoint": "/var/lib/docker/volumes/mariadb_data/_data",
        "Name": "mariadb_data",
        "Options": {},
        "Scope": "local"
    }
]

# Utiliser le volume
docker run -d \
  --name mariadb \
  -e MARIADB_ROOT_PASSWORD=mypass \
  -v mariadb_data:/var/lib/mysql \
  mariadb:11.8
```

**Avantages** :
- ‚úÖ G√©r√© par Docker (lifecycle, cleanup)
- ‚úÖ Portable entre environnements
- ‚úÖ Permissions g√©r√©es automatiquement (UID 999:999 pour mysql)
- ‚úÖ Peut utiliser des drivers avanc√©s
- ‚úÖ Compatible avec tous les orchestrateurs

**Inconv√©nients** :
- ‚ö†Ô∏è Emplacement sur l'h√¥te moins √©vident
- ‚ö†Ô∏è Backup n√©cessite des outils Docker sp√©cifiques

### 2. Bind mounts

Montage direct d'un r√©pertoire h√¥te dans le conteneur.

```bash
# Cr√©er le r√©pertoire sur l'h√¥te
mkdir -p /data/mariadb
chown -R 999:999 /data/mariadb  # UID/GID de mysql

# Bind mount
docker run -d \
  --name mariadb \
  -e MARIADB_ROOT_PASSWORD=mypass \
  -v /data/mariadb:/var/lib/mysql \
  mariadb:11.8
```

**Avantages** :
- ‚úÖ Contr√¥le total sur l'emplacement
- ‚úÖ Acc√®s direct depuis l'h√¥te
- ‚úÖ Backup standard (rsync, tar, etc.)
- ‚úÖ Permissions personnalisables

**Inconv√©nients** :
- ‚ö†Ô∏è Probl√®mes de permissions fr√©quents
- ‚ö†Ô∏è Non portable (paths absolus)
- ‚ö†Ô∏è Performance variable selon le filesystem h√¥te
- ‚ö†Ô∏è Risque de conflits avec SELinux/AppArmor

‚ö†Ô∏è **Attention** : Les bind mounts sont **d√©conseill√©s en production** pour les bases de donn√©es.

### 3. tmpfs mounts

Stockage en RAM, **non persistant**.

```bash
# tmpfs pour donn√©es temporaires
docker run -d \
  --name mariadb-temp \
  -e MARIADB_ROOT_PASSWORD=temp \
  --tmpfs /var/lib/mysql:rw,size=2g,mode=1777 \
  mariadb:11.8
```

**Usage** :
- ‚úÖ Tests d'int√©gration rapides
- ‚úÖ Caches temporaires
- ‚úÖ Environnements √©ph√©m√®res CI/CD

**Limitations** :
- ‚ùå Donn√©es perdues au red√©marrage
- ‚ùå Limit√© par la RAM disponible
- ‚ùå Pas de persistance

### 4. Volumes anonymes

Cr√©√©s automatiquement par Docker, difficiles √† g√©rer.

```bash
# Volume anonyme (D√âCONSEILL√â)
docker run -d \
  --name mariadb \
  -e MARIADB_ROOT_PASSWORD=mypass \
  mariadb:11.8

# Le volume est cr√©√© mais difficile √† identifier
docker volume ls
# DRIVER    VOLUME NAME
# local     a1b2c3d4e5f6...
```

‚ö†Ô∏è **Ne jamais utiliser de volumes anonymes pour des donn√©es importantes !**

---

## Configuration des volumes en production

### Volume nomm√© avec options avanc√©es

```bash
# Cr√©er un volume avec options sp√©cifiques
docker volume create \
  --driver local \
  --opt type=none \
  --opt device=/mnt/ssd-raid/mariadb \
  --opt o=bind \
  mariadb_prod_data

# Avec XFS et options de montage
docker volume create \
  --driver local \
  --opt type=xfs \
  --opt device=/dev/mapper/vg-mariadb \
  --opt o=noatime,nodiratime \
  mariadb_prod_xfs
```

### Docker Compose avec volumes optimis√©s

```yaml
version: '3.8'

services:
  mariadb:
    image: mariadb:11.8
    container_name: mariadb-prod
    
    volumes:
      # Volume de donn√©es principal
      - mariadb_data:/var/lib/mysql
      
      # Logs s√©par√©s pour rotation
      - mariadb_logs:/var/log/mysql
      
      # Configurations en read-only
      - ./conf:/etc/mysql/conf.d:ro
      
      # tmpfs pour donn√©es temporaires
      - type: tmpfs
        target: /tmp
        tmpfs:
          size: 1g
          mode: 1777
    
    environment:
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}

volumes:
  # Volume de donn√©es sur SSD
  mariadb_data:
    driver: local
    driver_opts:
      type: none
      o: bind,noatime
      device: /mnt/nvme-raid/mariadb/data
  
  # Volume de logs (peut √™tre sur disque standard)
  mariadb_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/log/containers/mariadb
```

### Structure optimale du volume de donn√©es

```
/var/lib/mysql/
‚îú‚îÄ‚îÄ aria_log.00000001              # Aria logs
‚îú‚îÄ‚îÄ aria_log_control
‚îú‚îÄ‚îÄ ib_buffer_pool                 # InnoDB buffer pool dump
‚îú‚îÄ‚îÄ ibdata1                        # InnoDB system tablespace (512MB+)
‚îú‚îÄ‚îÄ ib_logfile0                    # InnoDB redo log (256MB-2GB)
‚îú‚îÄ‚îÄ ib_logfile1
‚îú‚îÄ‚îÄ ibtmp1                         # InnoDB temp tablespace
‚îú‚îÄ‚îÄ mysql/                         # Syst√®me
‚îÇ   ‚îú‚îÄ‚îÄ user.frm
‚îÇ   ‚îú‚îÄ‚îÄ user.MYD
‚îÇ   ‚îî‚îÄ‚îÄ user.MYI
‚îú‚îÄ‚îÄ performance_schema/            # Performance Schema
‚îú‚îÄ‚îÄ sys/                          # Sys schema
‚îú‚îÄ‚îÄ production_db/                # Bases utilisateur
‚îÇ   ‚îú‚îÄ‚îÄ users.frm                 # Table definition
‚îÇ   ‚îú‚îÄ‚îÄ users.ibd                 # InnoDB file-per-table
‚îÇ   ‚îú‚îÄ‚îÄ sessions.frm
‚îÇ   ‚îî‚îÄ‚îÄ sessions.ibd
‚îú‚îÄ‚îÄ mariadb-bin.000001            # Binary logs (si activ√©)
‚îú‚îÄ‚îÄ mariadb-bin.000002
‚îú‚îÄ‚îÄ mariadb-bin.index
‚îî‚îÄ‚îÄ #ib_16384_*.dblwr             # üÜï Doublewrite buffer files (11.8)
```

üí° **Conseil** : Utilisez `innodb_file_per_table=1` (d√©faut) pour faciliter la gestion granulaire des tablespaces.

---

## Performance et optimisations

### Choix du filesystem

| Filesystem | IOPS | Latence | Recommandation |
|------------|------|---------|----------------|
| **XFS** | Excellent | Faible | ‚úÖ **Production recommand√©** |
| **ext4** | Bon | Moyenne | ‚úÖ Alternative acceptable |
| **Btrfs** | Variable | Moyenne | ‚ö†Ô∏è Avec pr√©cautions |
| **ZFS** | Excellent | Faible | ‚úÖ Si disponible (FreeBSD) |
| **NTFS** | Moyen | √âlev√©e | ‚ùå Windows uniquement |
| **NFS** | Variable | √âlev√©e | ‚ö†Ô∏è Seulement avec optimisations |

### Options de montage optimales

```bash
# XFS (recommand√© pour MariaDB)
mount -o noatime,nodiratime,logbufs=8,logbsize=256k /dev/sdb1 /mnt/mariadb

# ext4
mount -o noatime,nodiratime,data=ordered,barrier=1 /dev/sdb1 /mnt/mariadb

# Dans /etc/fstab
/dev/sdb1  /mnt/mariadb  xfs  noatime,nodiratime,logbufs=8  0  2
```

**Explications** :
- `noatime` : Ne pas mettre √† jour l'access time (√©conomise des I/O)
- `nodiratime` : Idem pour les r√©pertoires
- `logbufs=8` : 8 buffers de logs en m√©moire (XFS)
- `logbsize=256k` : Taille des buffers de log (XFS)
- `data=ordered` : Mode de journaling (ext4)
- `barrier=1` : Active les barriers pour coh√©rence (ext4)

### Configuration InnoDB pour volumes optimis√©s

```ini
# /etc/mysql/conf.d/storage.cnf
[mysqld]
# Data directory
datadir = /var/lib/mysql

# üÜï MariaDB 11.8 - InnoDB optimizations for SSD
innodb_io_capacity = 2000
innodb_io_capacity_max = 4000
innodb_flush_method = O_DIRECT

# Buffer Pool (75% de la RAM)
innodb_buffer_pool_size = 12G
innodb_buffer_pool_instances = 12

# Log files (sur le m√™me volume pour coh√©rence)
innodb_log_file_size = 1G
innodb_log_files_in_group = 2
innodb_log_buffer_size = 32M

# Flushing
innodb_flush_log_at_trx_commit = 1  # Durabilit√© maximale
innodb_flush_neighbors = 0  # D√©sactiver pour SSD

# üÜï MariaDB 11.8 - Doublewrite buffer
innodb_doublewrite = ON
innodb_doublewrite_files = 2  # S√©par√© depuis 11.x

# File per table
innodb_file_per_table = 1

# Tablespace temp
innodb_temp_data_file_path = ibtmp1:12M:autoextend:max:5G

# üÜï MariaDB 11.8 - Temp space control
max_tmp_space_usage = 10G
```

---

## Snapshots et backups de volumes

### 1. Snapshots avec LVM

```bash
# Cr√©er un snapshot LVM
lvcreate -L 10G -s -n mariadb_snapshot /dev/vg0/mariadb_lv

# Monter le snapshot en read-only
mkdir -p /mnt/snapshot
mount -o ro /dev/vg0/mariadb_snapshot /mnt/snapshot

# Backup depuis le snapshot
tar czf /backup/mariadb-$(date +%Y%m%d).tar.gz -C /mnt/snapshot .

# Nettoyer
umount /mnt/snapshot
lvremove -f /dev/vg0/mariadb_snapshot
```

### 2. Snapshots Docker volume

```bash
# Arr√™ter MariaDB proprement
docker exec mariadb mariadb -uroot -p -e "FLUSH TABLES WITH READ LOCK;"

# Cr√©er un snapshot du volume
docker run --rm \
  -v mariadb_data:/source:ro \
  -v /backup:/backup \
  alpine tar czf /backup/mariadb-snapshot-$(date +%Y%m%d-%H%M%S).tar.gz -C /source .

# Lib√©rer le lock
docker exec mariadb mariadb -uroot -p -e "UNLOCK TABLES;"

# Restauration
docker run --rm \
  -v mariadb_data:/target \
  -v /backup:/backup \
  alpine tar xzf /backup/mariadb-snapshot-20251214-103000.tar.gz -C /target
```

### 3. Backup coh√©rent avec Mariabackup

```bash
# Script de backup avec Mariabackup
#!/bin/bash
set -e

BACKUP_DIR="/backup/mariabackup"
DATE=$(date +%Y%m%d-%H%M%S)
BACKUP_PATH="${BACKUP_DIR}/${DATE}"

# Cr√©er le r√©pertoire de backup
mkdir -p "${BACKUP_PATH}"

# Backup avec Mariabackup
docker exec mariadb \
  mariabackup --backup \
  --target-dir=/backup/${DATE} \
  --user=root \
  --password=${MARIADB_ROOT_PASSWORD}

# Copier depuis le conteneur
docker cp mariadb:/backup/${DATE} "${BACKUP_PATH}"

# Prepare le backup (rendre coh√©rent)
docker run --rm \
  -v "${BACKUP_PATH}:/backup" \
  mariadb:11.8 \
  mariabackup --prepare --target-dir=/backup

# Compression
tar czf "${BACKUP_PATH}.tar.gz" -C "${BACKUP_DIR}" "${DATE}"
rm -rf "${BACKUP_PATH}"

# Rotation (garder 7 jours)
find "${BACKUP_DIR}" -name "*.tar.gz" -mtime +7 -delete

echo "Backup completed: ${BACKUP_PATH}.tar.gz"
```

---

## Monitoring des volumes

### Prometheus metrics pour volumes

```yaml
# prometheus/prometheus.yml
scrape_configs:
  # Node Exporter pour m√©triques syst√®me
  - job_name: 'node'
    static_configs:
      - targets: ['node-exporter:9100']
  
  # cAdvisor pour m√©triques conteneurs
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['cadvisor:8080']
```

**M√©triques cl√©s √† surveiller** :
- `node_filesystem_avail_bytes` : Espace disponible
- `node_filesystem_files_free` : Inodes libres
- `node_disk_io_time_seconds_total` : Temps I/O
- `node_disk_read_bytes_total` : Octets lus
- `node_disk_written_bytes_total` : Octets √©crits
- `container_fs_usage_bytes` : Usage conteneur

---

## ‚úÖ Points cl√©s √† retenir

- **Volumes nomm√©s** : Toujours privil√©gier en production, g√©r√©s par Docker
- **Bind mounts** : √âviter pour les donn√©es MariaDB (probl√®mes de permissions)
- **Filesystem** : XFS recommand√© pour MariaDB, avec options noatime
- **Performance** : SSD/NVMe obligatoire en production, optimiser innodb_io_capacity
- **Snapshots** : Mettre en place une strat√©gie de snapshot r√©guli√®re
- **Monitoring** : Surveiller espace disque, inodes, IOPS, latence
- **Backup** : Toujours sauvegarder les volumes avant maintenance
- **Drivers** : Utiliser des drivers avanc√©s (LVM, Ceph, cloud) en production
- **Isolation** : S√©parer donn√©es, logs et backups sur des volumes diff√©rents
- **Documentation** : Labelliser et documenter tous les volumes importants

---

## üîó Ressources et r√©f√©rences

### Documentation officielle
- [üìñ Docker Volumes](https://docs.docker.com/storage/volumes/)
- [üìñ Docker Storage Drivers](https://docs.docker.com/storage/storagedriver/)
- [üìñ Volume Plugins](https://docs.docker.com/engine/extend/plugins_volume/)
- [üìñ MariaDB Storage Engines](https://mariadb.com/kb/en/storage-engines/)

### Performance et benchmarking
- [Sysbench](https://github.com/akopytov/sysbench) - Database benchmarking
- [fio](https://github.com/axboe/fio) - Flexible I/O tester
- [ioping](https://github.com/koct9i/ioping) - Latency monitoring

---

## ‚û°Ô∏è Section suivante

**16.4 Orchestration avec Kubernetes** : D√©couvrez comment g√©rer la persistance MariaDB en production avec Kubernetes StatefulSets, PersistentVolumes, StorageClasses et operators.

---

**MariaDB** : 11.8 LTS

‚è≠Ô∏è [Orchestration avec Kubernetes](/16-devops-automatisation/04-orchestration-kubernetes.md)
