üîù Retour au [Sommaire](/SOMMAIRE.md)

# 16.2.1 Ansible : Playbooks MariaDB

> **Niveau** : Avanc√© √† Expert  
> **Dur√©e estim√©e** : 3-4 heures  
> **Pr√©requis** : Connaissances Ansible de base, Linux system administration, concepts MariaDB

## üéØ Objectifs d'apprentissage

√Ä l'issue de cette section, vous serez capable de :
- Cr√©er des playbooks Ansible idiomatiques pour d√©ployer MariaDB 11.8 LTS
- G√©rer la configuration MariaDB de mani√®re d√©clarative et reproductible
- Automatiser l'installation, la s√©curisation et la configuration de MariaDB
- Impl√©menter des r√¥les Ansible r√©utilisables pour diff√©rents environnements
- Appliquer les meilleures pratiques Infrastructure as Code pour les bases de donn√©es

---

## Introduction

Ansible est l'outil d'Infrastructure as Code (IaC) le plus populaire pour l'automatisation de configuration gr√¢ce √† sa simplicit√©, son approche agentless et son langage d√©claratif YAML. Pour MariaDB, Ansible permet de garantir la **coh√©rence**, la **reproductibilit√©** et la **scalabilit√©** des d√©ploiements sur l'ensemble du parc d'infrastructure.

### Pourquoi Ansible pour MariaDB ?

**Avantages cl√©s** :
- ‚úÖ **Agentless** : Communication SSH, pas d'agent √† installer sur les n≈ìuds
- ‚úÖ **Idempotent** : Ex√©cutions multiples produisent le m√™me √©tat final
- ‚úÖ **D√©claratif** : Description de l'√©tat souhait√©, pas des √©tapes
- ‚úÖ **Modules natifs** : `mysql_*` modules pour g√©rer MariaDB
- ‚úÖ **Versionnable** : Playbooks dans Git = historique et revue de code
- ‚úÖ **Extensible** : Collections, r√¥les, plugins personnalis√©s

**Cas d'usage typiques** :
- D√©ploiement standardis√© multi-environnements (dev, staging, prod)
- Configuration de r√©plication Master-Slave ou Galera Cluster
- Mise √† jour de version (upgrade paths)
- Application de correctifs de s√©curit√©
- Gestion de secrets (credentials, certificats TLS)
- Automatisation des t√¢ches r√©currentes (backup, monitoring)

---

## Architecture d'un projet Ansible MariaDB

### Structure recommand√©e

```
mariadb-ansible/
‚îú‚îÄ‚îÄ ansible.cfg                 # Configuration Ansible
‚îú‚îÄ‚îÄ inventory/
‚îÇ   ‚îú‚îÄ‚îÄ production/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hosts.yml          # Inventaire production
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ group_vars/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ all.yml        # Variables communes
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ mariadb_primary.yml
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ mariadb_replicas.yml
‚îÇ   ‚îú‚îÄ‚îÄ staging/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ hosts.yml
‚îÇ   ‚îî‚îÄ‚îÄ development/
‚îÇ       ‚îî‚îÄ‚îÄ hosts.yml
‚îú‚îÄ‚îÄ playbooks/
‚îÇ   ‚îú‚îÄ‚îÄ deploy_mariadb.yml     # Playbook principal
‚îÇ   ‚îú‚îÄ‚îÄ configure_replication.yml
‚îÇ   ‚îú‚îÄ‚îÄ upgrade_mariadb.yml
‚îÇ   ‚îî‚îÄ‚îÄ backup_mariadb.yml
‚îú‚îÄ‚îÄ roles/
‚îÇ   ‚îú‚îÄ‚îÄ mariadb/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tasks/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ main.yml
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ install.yml
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ configure.yml
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ secure.yml
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ replication.yml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ templates/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ my.cnf.j2
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ mariadb.service.j2
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main.yml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ defaults/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main.yml
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ vars/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ main.yml
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ files/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ mariadb.repo
‚îÇ   ‚îî‚îÄ‚îÄ monitoring/
‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ group_vars/
‚îÇ   ‚îî‚îÄ‚îÄ all.yml                # Variables globales
‚îî‚îÄ‚îÄ requirements.yml           # Collections Ansible n√©cessaires
```

üí° **Conseil** : S√©parez clairement les inventaires par environnement pour √©viter toute confusion entre dev/staging/prod.

---

## Installation et configuration de base

### Fichier ansible.cfg

```ini
[defaults]
inventory = inventory/production/hosts.yml
host_key_checking = False
retry_files_enabled = False
gathering = smart
fact_caching = jsonfile
fact_caching_connection = /tmp/ansible_facts
fact_caching_timeout = 3600
roles_path = roles
collections_paths = ~/.ansible/collections

[privilege_escalation]
become = True
become_method = sudo
become_user = root
become_ask_pass = False

[ssh_connection]
pipelining = True
ssh_args = -o ControlMaster=auto -o ControlPersist=60s
```

### Inventaire dynamique

```yaml
# inventory/production/hosts.yml
all:
  children:
    mariadb_cluster:
      children:
        mariadb_primary:
          hosts:
            db-primary-01.example.com:
              ansible_host: 10.0.1.10
              server_id: 1
              
        mariadb_replicas:
          hosts:
            db-replica-01.example.com:
              ansible_host: 10.0.1.11
              server_id: 2
            db-replica-02.example.com:
              ansible_host: 10.0.1.12
              server_id: 3
              
      vars:
        ansible_user: ansible
        ansible_python_interpreter: /usr/bin/python3
        mariadb_version: "11.8"
        mariadb_datadir: /var/lib/mysql
        mariadb_port: 3306
```

---

## Playbook principal de d√©ploiement

### playbooks/deploy_mariadb.yml

```yaml
---
- name: Deploy MariaDB 11.8 LTS
  hosts: mariadb_cluster
  become: true
  vars:
    mariadb_root_password: "{{ vault_mariadb_root_password }}"
    
  pre_tasks:
    - name: Gather facts
      ansible.builtin.setup:
        
    - name: Check OS compatibility
      ansible.builtin.assert:
        that:
          - ansible_distribution in ['Ubuntu', 'Debian', 'CentOS', 'RedHat', 'Rocky']
          - ansible_distribution_major_version | int >= 20 or ansible_distribution == 'CentOS'
        fail_msg: "OS non support√© pour MariaDB 11.8 LTS"
        
  roles:
    - role: mariadb
      tags: ['mariadb', 'install']
      
  post_tasks:
    - name: Verify MariaDB is running
      ansible.builtin.systemd:
        name: mariadb
        state: started
        enabled: true
        
    - name: Wait for MariaDB to be ready
      ansible.builtin.wait_for:
        host: "{{ ansible_host }}"
        port: "{{ mariadb_port }}"
        delay: 5
        timeout: 60
        
    - name: Display MariaDB version
      ansible.builtin.command: mariadb --version
      register: mariadb_version_output
      changed_when: false
      
    - name: Show installed version
      ansible.builtin.debug:
        msg: "{{ mariadb_version_output.stdout }}"
```

üí° **Conseil** : Utilisez `pre_tasks` pour valider les pr√©requis avant l'ex√©cution du r√¥le principal.

---

## R√¥le MariaDB complet

### roles/mariadb/defaults/main.yml

```yaml
---
# Version MariaDB
mariadb_version: "11.8"
mariadb_use_lts: true

# Chemins syst√®me
mariadb_datadir: /var/lib/mysql
mariadb_logdir: /var/log/mysql
mariadb_tmpdir: /tmp
mariadb_socket: /var/run/mysqld/mysqld.sock
mariadb_pid_file: /var/run/mysqld/mysqld.pid

# Configuration r√©seau
mariadb_bind_address: "0.0.0.0"
mariadb_port: 3306
mariadb_max_connections: 200

# Configuration InnoDB (optimis√©e pour 11.8)
mariadb_innodb_buffer_pool_size: "{{ (ansible_memtotal_mb * 0.7) | int }}M"
mariadb_innodb_buffer_pool_instances: "{{ [ansible_processor_vcpus, 8] | min }}"
mariadb_innodb_log_file_size: 512M
mariadb_innodb_flush_log_at_trx_commit: 1
mariadb_innodb_flush_method: O_DIRECT
mariadb_innodb_io_capacity: 2000  # SSD par d√©faut (11.8)
mariadb_innodb_io_capacity_max: 4000

# üÜï MariaDB 11.8 - innodb_alter_copy_bulk
mariadb_innodb_alter_copy_bulk: 256M

# Character set (utf8mb4 par d√©faut depuis 11.8)
mariadb_character_set: utf8mb4
mariadb_collation: utf8mb4_unicode_ci

# S√©curit√©
mariadb_enable_tls: true  # TLS par d√©faut depuis 11.8
mariadb_require_secure_transport: false  # √Ä activer progressivement
mariadb_ssl_ca: /etc/mysql/ssl/ca-cert.pem
mariadb_ssl_cert: /etc/mysql/ssl/server-cert.pem
mariadb_ssl_key: /etc/mysql/ssl/server-key.pem

# Binary logs
mariadb_enable_binlog: true
mariadb_binlog_format: ROW
mariadb_binlog_expire_logs_seconds: 604800  # 7 jours
mariadb_max_binlog_size: 100M

# Slow query log
mariadb_slow_query_log: 1
mariadb_slow_query_log_file: "{{ mariadb_logdir }}/mariadb-slow.log"
mariadb_long_query_time: 2

# Users √† cr√©er
mariadb_users: []
# Exemple:
#  - name: appuser
#    password: "{{ vault_appuser_password }}"
#    priv: "appdb.*:ALL"
#    host: "10.0.%.%"

# Databases √† cr√©er
mariadb_databases: []
# Exemple:
#  - name: appdb
#    encoding: utf8mb4
#    collation: utf8mb4_unicode_ci
```

### roles/mariadb/tasks/main.yml

```yaml
---
- name: Include OS-specific variables
  ansible.builtin.include_vars: "{{ ansible_os_family }}.yml"
  
- name: Installation MariaDB
  ansible.builtin.include_tasks: install.yml
  tags: ['install']
  
- name: Configuration MariaDB
  ansible.builtin.include_tasks: configure.yml
  tags: ['configure']
  
- name: S√©curisation MariaDB
  ansible.builtin.include_tasks: secure.yml
  tags: ['secure']
  
- name: Configuration r√©plication (si applicable)
  ansible.builtin.include_tasks: replication.yml
  when: mariadb_replication_role is defined
  tags: ['replication']
```

### roles/mariadb/tasks/install.yml

```yaml
---
- name: Add MariaDB repository (Debian/Ubuntu)
  when: ansible_os_family == 'Debian'
  block:
    - name: Install prerequisites
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - ca-certificates
          - software-properties-common
        state: present
        update_cache: true
        
    - name: Add MariaDB GPG key
      ansible.builtin.apt_key:
        url: "https://mariadb.org/mariadb_release_signing_key.asc"
        state: present
        
    - name: Add MariaDB repository
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64] https://dlm.mariadb.com/repo/mariadb-server/{{ mariadb_version }}/repo/ubuntu {{ ansible_distribution_release }} main"
        state: present
        filename: mariadb
        
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true

- name: Add MariaDB repository (RHEL/CentOS/Rocky)
  when: ansible_os_family == 'RedHat'
  block:
    - name: Add MariaDB repository
      ansible.builtin.yum_repository:
        name: mariadb
        description: MariaDB {{ mariadb_version }} LTS Repository
        baseurl: "https://dlm.mariadb.com/repo/mariadb-server/{{ mariadb_version }}/yum/rhel/$releasever/$basearch"
        gpgkey: https://mariadb.org/mariadb_release_signing_key.asc
        gpgcheck: true
        enabled: true

- name: Install MariaDB server (Debian/Ubuntu)
  when: ansible_os_family == 'Debian'
  ansible.builtin.apt:
    name:
      - mariadb-server
      - mariadb-client
      - mariadb-backup  # Mariabackup
      - python3-pymysql  # Pour modules Ansible
    state: present
    update_cache: true
    
- name: Install MariaDB server (RHEL/CentOS/Rocky)
  when: ansible_os_family == 'RedHat'
  ansible.builtin.yum:
    name:
      - MariaDB-server
      - MariaDB-client
      - MariaDB-backup
      - python3-PyMySQL
    state: present

- name: Create MariaDB directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: mysql
    group: mysql
    mode: '0755'
  loop:
    - "{{ mariadb_datadir }}"
    - "{{ mariadb_logdir }}"
    - /etc/mysql/conf.d
    - /etc/mysql/ssl

- name: Ensure MariaDB is started
  ansible.builtin.systemd:
    name: mariadb
    state: started
    enabled: true
    daemon_reload: true
```

‚ö†Ô∏è **Attention** : V√©rifiez toujours la compatibilit√© des repositories avec votre distribution Linux.

### roles/mariadb/tasks/configure.yml

```yaml
---
- name: Deploy MariaDB configuration from template
  ansible.builtin.template:
    src: my.cnf.j2
    dest: /etc/mysql/my.cnf
    owner: root
    group: root
    mode: '0644'
    backup: true
    validate: 'mariadbd --defaults-file=%s --help --verbose > /dev/null'
  notify: restart mariadb
  
- name: Deploy additional configuration files
  ansible.builtin.template:
    src: "{{ item }}"
    dest: "/etc/mysql/conf.d/{{ item | basename | regex_replace('\\.j2$', '') }}"
    owner: root
    group: root
    mode: '0644'
  loop: "{{ mariadb_additional_configs | default([]) }}"
  notify: restart mariadb

- name: Configure TLS certificates
  when: mariadb_enable_tls | bool
  block:
    - name: Copy SSL CA certificate
      ansible.builtin.copy:
        src: "{{ mariadb_ssl_ca_source }}"
        dest: "{{ mariadb_ssl_ca }}"
        owner: mysql
        group: mysql
        mode: '0644'
        
    - name: Copy SSL server certificate
      ansible.builtin.copy:
        src: "{{ mariadb_ssl_cert_source }}"
        dest: "{{ mariadb_ssl_cert }}"
        owner: mysql
        group: mysql
        mode: '0644'
        
    - name: Copy SSL server key
      ansible.builtin.copy:
        src: "{{ mariadb_ssl_key_source }}"
        dest: "{{ mariadb_ssl_key }}"
        owner: mysql
        group: mysql
        mode: '0600'
      notify: restart mariadb

- name: Flush handlers to apply configuration
  ansible.builtin.meta: flush_handlers
  
- name: Wait for MariaDB to be ready after restart
  ansible.builtin.wait_for:
    host: "{{ mariadb_bind_address }}"
    port: "{{ mariadb_port }}"
    delay: 5
    timeout: 60
```

### roles/mariadb/templates/my.cnf.j2

```ini
# MariaDB {{ mariadb_version }} LTS Configuration
# G√©n√©r√© par Ansible - Ne pas modifier manuellement
# Derni√®re modification: {{ ansible_date_time.iso8601 }}

[client]
port = {{ mariadb_port }}
socket = {{ mariadb_socket }}
default-character-set = {{ mariadb_character_set }}

[mysql]
default-character-set = {{ mariadb_character_set }}

[mysqld]
#
# Basic Settings
#
user = mysql
pid-file = {{ mariadb_pid_file }}
socket = {{ mariadb_socket }}
port = {{ mariadb_port }}
basedir = /usr
datadir = {{ mariadb_datadir }}
tmpdir = {{ mariadb_tmpdir }}
lc-messages-dir = /usr/share/mysql
skip-external-locking

#
# Network Settings
#
bind-address = {{ mariadb_bind_address }}
max_connections = {{ mariadb_max_connections }}
max_connect_errors = 1000000

#
# Character Set & Collation (utf8mb4 par d√©faut depuis 11.8)
#
character-set-server = {{ mariadb_character_set }}
collation-server = {{ mariadb_collation }}

#
# InnoDB Settings (Optimis√© pour MariaDB 11.8)
#
default-storage-engine = InnoDB
innodb_buffer_pool_size = {{ mariadb_innodb_buffer_pool_size }}
innodb_buffer_pool_instances = {{ mariadb_innodb_buffer_pool_instances }}
innodb_log_file_size = {{ mariadb_innodb_log_file_size }}
innodb_flush_log_at_trx_commit = {{ mariadb_innodb_flush_log_at_trx_commit }}
innodb_flush_method = {{ mariadb_innodb_flush_method }}
innodb_file_per_table = 1

# üÜï MariaDB 11.8 - Optimisations SSD
innodb_io_capacity = {{ mariadb_innodb_io_capacity }}
innodb_io_capacity_max = {{ mariadb_innodb_io_capacity_max }}

# üÜï MariaDB 11.8 - ALTER TABLE plus efficace
innodb_alter_copy_bulk = {{ mariadb_innodb_alter_copy_bulk }}

# MVCC et concurrence
innodb_read_io_threads = 4
innodb_write_io_threads = 4
innodb_purge_threads = 4
innodb_thread_concurrency = 0

#
# Binary Logging & Replication
#
{% if mariadb_enable_binlog | bool %}
server-id = {{ server_id | default(1) }}
log_bin = {{ mariadb_logdir }}/mariadb-bin
binlog_format = {{ mariadb_binlog_format }}
binlog_expire_logs_seconds = {{ mariadb_binlog_expire_logs_seconds }}
max_binlog_size = {{ mariadb_max_binlog_size }}
sync_binlog = 1

# GTID (recommand√© pour failover)
gtid_strict_mode = 1
{% endif %}

#
# Logging
#
log_error = {{ mariadb_logdir }}/error.log
slow_query_log = {{ mariadb_slow_query_log }}
slow_query_log_file = {{ mariadb_slow_query_log_file }}
long_query_time = {{ mariadb_long_query_time }}
log_queries_not_using_indexes = 0

#
# Security & TLS (TLS par d√©faut depuis 11.8)
#
{% if mariadb_enable_tls | bool %}
ssl_ca = {{ mariadb_ssl_ca }}
ssl_cert = {{ mariadb_ssl_cert }}
ssl_key = {{ mariadb_ssl_key }}
{% if mariadb_require_secure_transport | bool %}
require_secure_transport = ON
{% endif %}
{% endif %}

#
# Performance & Tuning
#
table_open_cache = 4096
table_definition_cache = 2048
thread_cache_size = 50
tmp_table_size = 64M
max_heap_table_size = 64M
join_buffer_size = 256K
sort_buffer_size = 256K
read_buffer_size = 128K
read_rnd_buffer_size = 256K

# üÜï MariaDB 11.8 - Contr√¥le espace temporaire
max_tmp_space_usage = 10G
max_total_tmp_space_usage = 20G

# Query cache d√©sactiv√© (d√©pr√©ci√©)
query_cache_type = 0
query_cache_size = 0

#
# SQL Mode (strict par d√©faut)
#
sql_mode = STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION

[mysqldump]
quick
quote-names
max_allowed_packet = 64M

[mariadb-dump]
quick
quote-names
max_allowed_packet = 64M
single-transaction

[isamchk]
key_buffer_size = 16M
```

üí° **Conseil** : Utilisez `validate` dans le module template pour v√©rifier la syntaxe avant de d√©ployer.

### roles/mariadb/tasks/secure.yml

```yaml
---
- name: Set root password
  community.mysql.mysql_user:
    name: root
    password: "{{ mariadb_root_password }}"
    host: "{{ item }}"
    login_unix_socket: "{{ mariadb_socket }}"
    state: present
  loop:
    - localhost
    - 127.0.0.1
    - ::1
  no_log: true
  
- name: Create /root/.my.cnf for passwordless root access
  ansible.builtin.template:
    src: root_my.cnf.j2
    dest: /root/.my.cnf
    owner: root
    group: root
    mode: '0600'
  no_log: true

- name: Remove anonymous users
  community.mysql.mysql_user:
    name: ''
    host_all: true
    state: absent
    login_unix_socket: "{{ mariadb_socket }}"
    
- name: Remove test database
  community.mysql.mysql_db:
    name: test
    state: absent
    login_unix_socket: "{{ mariadb_socket }}"
    
- name: Ensure root can only login from localhost
  community.mysql.mysql_query:
    login_unix_socket: "{{ mariadb_socket }}"
    query: DELETE FROM mysql.user WHERE User='root' AND Host NOT IN ('localhost', '127.0.0.1', '::1')

- name: Create application databases
  community.mysql.mysql_db:
    name: "{{ item.name }}"
    encoding: "{{ item.encoding | default('utf8mb4') }}"
    collation: "{{ item.collation | default('utf8mb4_unicode_ci') }}"
    state: present
    login_unix_socket: "{{ mariadb_socket }}"
  loop: "{{ mariadb_databases }}"
  when: mariadb_databases is defined

- name: Create application users
  community.mysql.mysql_user:
    name: "{{ item.name }}"
    password: "{{ item.password }}"
    priv: "{{ item.priv }}"
    host: "{{ item.host | default('%') }}"
    state: present
    login_unix_socket: "{{ mariadb_socket }}"
  loop: "{{ mariadb_users }}"
  when: mariadb_users is defined
  no_log: true

- name: Flush privileges
  community.mysql.mysql_query:
    login_unix_socket: "{{ mariadb_socket }}"
    query: FLUSH PRIVILEGES
```

‚ö†Ô∏è **Attention** : Utilisez `no_log: true` pour les t√¢ches manipulant des mots de passe afin d'√©viter leur exposition dans les logs.

### roles/mariadb/templates/root_my.cnf.j2

```ini
[client]
user=root
password="{{ mariadb_root_password }}"
socket={{ mariadb_socket }}
```

### roles/mariadb/handlers/main.yml

```yaml
---
- name: restart mariadb
  ansible.builtin.systemd:
    name: mariadb
    state: restarted
    
- name: reload mariadb
  ansible.builtin.systemd:
    name: mariadb
    state: reloaded
```

---

## Gestion des secrets avec Ansible Vault

### Cr√©ation du fichier de secrets

```bash
# Cr√©er un fichier vault chiffr√©
ansible-vault create inventory/production/group_vars/all/vault.yml

# Contenu du fichier vault.yml (apr√®s d√©chiffrement)
---
vault_mariadb_root_password: "StrongR00tP@ssw0rd2025!"
vault_appuser_password: "AppUs3rS3cur3P@ss"
vault_backup_user_password: "B@ckupUs3rP@ss2025"
vault_replication_password: "R3pl!c@t!onP@ss2025"
```

### Utilisation dans les playbooks

```yaml
# inventory/production/group_vars/all.yml
---
mariadb_root_password: "{{ vault_mariadb_root_password }}"

mariadb_users:
  - name: appuser
    password: "{{ vault_appuser_password }}"
    priv: "production_db.*:ALL"
    host: "10.0.%.%"
    
  - name: backup
    password: "{{ vault_backup_user_password }}"
    priv: "*.*:SELECT,RELOAD,LOCK TABLES,REPLICATION CLIENT"
    host: "10.0.100.50"
```

### Ex√©cution avec vault

```bash
# Avec mot de passe interactif
ansible-playbook -i inventory/production playbooks/deploy_mariadb.yml --ask-vault-pass

# Avec fichier de mot de passe
echo "my-vault-password" > .vault_pass
chmod 600 .vault_pass
ansible-playbook -i inventory/production playbooks/deploy_mariadb.yml --vault-password-file .vault_pass

# Configuration dans ansible.cfg
[defaults]
vault_password_file = .vault_pass
```

üí° **Conseil** : Ne committez JAMAIS `.vault_pass` dans Git. Ajoutez-le au `.gitignore`.

---

## Configuration de la r√©plication avec Ansible

### Playbook de r√©plication

```yaml
---
# playbooks/configure_replication.yml
- name: Configure MariaDB replication
  hosts: mariadb_cluster
  become: true
  serial: 1  # Configurer un serveur √† la fois
  
  tasks:
    - name: Configure replication user on primary
      community.mysql.mysql_user:
        name: repl_user
        password: "{{ vault_replication_password }}"
        priv: "*.*:REPLICATION SLAVE,REPLICATION CLIENT"
        host: "10.0.%.%"
        state: present
      when: inventory_hostname in groups['mariadb_primary']
      delegate_to: "{{ groups['mariadb_primary'][0] }}"
      
    - name: Get primary status
      community.mysql.mysql_replication:
        mode: getprimary
      register: primary_status
      when: inventory_hostname in groups['mariadb_primary']
      
    - name: Configure replicas
      when: inventory_hostname in groups['mariadb_replicas']
      block:
        - name: Stop replication
          community.mysql.mysql_replication:
            mode: stopreplica
          ignore_errors: true
          
        - name: Configure replication source
          community.mysql.mysql_replication:
            mode: changeprimary
            primary_host: "{{ groups['mariadb_primary'][0] }}"
            primary_port: 3306
            primary_user: repl_user
            primary_password: "{{ vault_replication_password }}"
            primary_log_file: "{{ hostvars[groups['mariadb_primary'][0]]['primary_status']['File'] }}"
            primary_log_pos: "{{ hostvars[groups['mariadb_primary'][0]]['primary_status']['Position'] }}"
            primary_use_gtid: current_pos  # üÜï Utilisation GTID
            
        - name: Start replication
          community.mysql.mysql_replication:
            mode: startreplica
            
        - name: Wait for replica to catch up
          community.mysql.mysql_replication:
            mode: getreplica
          register: replica_status
          until: replica_status.Seconds_Behind_Master | int < 10
          retries: 30
          delay: 10
          
        - name: Display replication status
          ansible.builtin.debug:
            msg: "Replica lag: {{ replica_status.Seconds_Behind_Master }}s"
```

---

## Gestion des versions et upgrades

### Playbook de mise √† jour

```yaml
---
# playbooks/upgrade_mariadb.yml
- name: Upgrade MariaDB from 11.4 to 11.8 LTS
  hosts: mariadb_cluster
  become: true
  serial: 1  # Un serveur √† la fois
  max_fail_percentage: 0
  
  vars:
    old_version: "11.4"
    new_version: "11.8"
    
  pre_tasks:
    - name: Backup before upgrade
      ansible.builtin.command: >
        mariadb-dump --all-databases 
        --single-transaction 
        --routines 
        --triggers 
        --events 
        > /backup/pre-upgrade-{{ ansible_date_time.epoch }}.sql
      args:
        creates: /backup/pre-upgrade-{{ ansible_date_time.epoch }}.sql
        
    - name: Verify backup exists
      ansible.builtin.stat:
        path: /backup/pre-upgrade-{{ ansible_date_time.epoch }}.sql
      register: backup_file
      failed_when: not backup_file.stat.exists
      
  tasks:
    - name: Stop MariaDB
      ansible.builtin.systemd:
        name: mariadb
        state: stopped
        
    - name: Update repository version
      ansible.builtin.replace:
        path: /etc/apt/sources.list.d/mariadb.list
        regexp: "{{ old_version }}"
        replace: "{{ new_version }}"
      when: ansible_os_family == 'Debian'
      
    - name: Update packages
      ansible.builtin.apt:
        update_cache: true
        name:
          - mariadb-server
          - mariadb-client
        state: latest
      when: ansible_os_family == 'Debian'
      
    - name: Start MariaDB
      ansible.builtin.systemd:
        name: mariadb
        state: started
        
    - name: Run mariadb-upgrade
      ansible.builtin.command: mariadb-upgrade --force
      register: upgrade_result
      changed_when: "'is already up to date' not in upgrade_result.stdout"
      
    - name: Restart MariaDB after upgrade
      ansible.builtin.systemd:
        name: mariadb
        state: restarted
        
  post_tasks:
    - name: Verify upgraded version
      ansible.builtin.command: mariadb --version
      register: version_check
      changed_when: false
      failed_when: new_version not in version_check.stdout
      
    - name: Check replication status (replicas)
      community.mysql.mysql_replication:
        mode: getreplica
      register: replica_check
      when: inventory_hostname in groups['mariadb_replicas']
      failed_when: replica_check.Slave_IO_Running != 'Yes' or replica_check.Slave_SQL_Running != 'Yes'
```

‚ö†Ô∏è **Attention** : Toujours tester les upgrades en environnement de staging avant la production.

---

## Idempotence et testing

### V√©rification de l'idempotence

```bash
# Premier run : changements attendus
ansible-playbook -i inventory/production playbooks/deploy_mariadb.yml

# Second run : aucun changement attendu (idempotent)
ansible-playbook -i inventory/production playbooks/deploy_mariadb.yml --check --diff
```

### Tests avec Molecule

```yaml
# molecule/default/molecule.yml
---
dependency:
  name: galaxy
driver:
  name: docker
platforms:
  - name: mariadb-ubuntu2204
    image: geerlingguy/docker-ubuntu2204-ansible:latest
    command: ""
    volumes:
      - /sys/fs/cgroup:/sys/fs/cgroup:ro
    privileged: true
    pre_build_image: true
    
provisioner:
  name: ansible
  config_options:
    defaults:
      interpreter_python: auto_silent
      callback_whitelist: profile_tasks, timer, yaml
      
verifier:
  name: ansible
  
scenario:
  test_sequence:
    - dependency
    - lint
    - cleanup
    - destroy
    - syntax
    - create
    - prepare
    - converge
    - idempotence
    - side_effect
    - verify
    - cleanup
    - destroy
```

```yaml
# molecule/default/verify.yml
---
- name: Verify MariaDB installation
  hosts: all
  tasks:
    - name: Check MariaDB is running
      ansible.builtin.systemd:
        name: mariadb
        state: started
      check_mode: true
      register: service_check
      failed_when: service_check.changed
      
    - name: Verify MariaDB version
      ansible.builtin.command: mariadb --version
      register: version_output
      changed_when: false
      failed_when: "'11.8' not in version_output.stdout"
      
    - name: Test database connection
      community.mysql.mysql_query:
        login_unix_socket: /var/run/mysqld/mysqld.sock
        query: SELECT VERSION()
      register: query_result
      
    - name: Verify utf8mb4 default charset
      community.mysql.mysql_query:
        login_unix_socket: /var/run/mysqld/mysqld.sock
        query: SHOW VARIABLES LIKE 'character_set_server'
      register: charset_result
      failed_when: "'utf8mb4' not in charset_result.query_result[0][0]['Value']"
```

---

## Int√©gration CI/CD

### GitLab CI exemple

```yaml
# .gitlab-ci.yml
stages:
  - lint
  - test
  - deploy

variables:
  ANSIBLE_FORCE_COLOR: "true"
  ANSIBLE_HOST_KEY_CHECKING: "False"

ansible-lint:
  stage: lint
  image: cytopia/ansible-lint:latest
  script:
    - ansible-lint playbooks/ roles/
  only:
    - merge_requests
    - main

molecule-test:
  stage: test
  image: geerlingguy/docker-ubuntu2204-ansible:latest
  services:
    - docker:dind
  script:
    - pip3 install molecule molecule-docker
    - cd roles/mariadb
    - molecule test
  only:
    - merge_requests
    - main

deploy-staging:
  stage: deploy
  image: cytopia/ansible:latest
  script:
    - ansible-playbook -i inventory/staging playbooks/deploy_mariadb.yml --vault-password-file=$VAULT_PASSWORD
  environment:
    name: staging
  only:
    - main

deploy-production:
  stage: deploy
  image: cytopia/ansible:latest
  script:
    - ansible-playbook -i inventory/production playbooks/deploy_mariadb.yml --vault-password-file=$VAULT_PASSWORD
  environment:
    name: production
  when: manual
  only:
    - main
```

---

## Bonnes pratiques et patterns avanc√©s

### 1. Variables hi√©rarchiques

```
inventory/
‚îú‚îÄ‚îÄ production/
‚îÇ   ‚îú‚îÄ‚îÄ group_vars/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ all.yml                    # Variables communes √† tous
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ mariadb_cluster.yml        # Variables du cluster
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ mariadb_primary.yml        # Variables sp√©cifiques primary
‚îÇ   ‚îî‚îÄ‚îÄ host_vars/
‚îÇ       ‚îî‚îÄ‚îÄ db-primary-01.example.com.yml  # Variables d'h√¥te
```

**Ordre de pr√©c√©dence** (du plus faible au plus fort) :
1. `roles/mariadb/defaults/main.yml`
2. `inventory/group_vars/all.yml`
3. `inventory/group_vars/mariadb_cluster.yml`
4. `inventory/host_vars/db-primary-01.example.com.yml`
5. Variables en ligne de commande (`-e`)

### 2. Tags pour ex√©cutions cibl√©es

```yaml
---
- name: Deploy MariaDB
  hosts: mariadb_cluster
  roles:
    - role: mariadb
      tags: ['mariadb', 'database']
      
  tasks:
    - name: Configure monitoring
      tags: ['monitoring']
      # ...
```

```bash
# Ex√©cuter uniquement l'installation
ansible-playbook deploy.yml --tags install

# Ex√©cuter tout sauf le monitoring
ansible-playbook deploy.yml --skip-tags monitoring

# Lister les tags disponibles
ansible-playbook deploy.yml --list-tags
```

### 3. Handlers conditionnels

```yaml
# roles/mariadb/handlers/main.yml
---
- name: restart mariadb
  ansible.builtin.systemd:
    name: mariadb
    state: restarted
  when: not mariadb_in_maintenance_window | default(false)
  
- name: notify restart needed
  ansible.builtin.debug:
    msg: "MariaDB restart required but skipped due to maintenance window"
  when: mariadb_in_maintenance_window | default(false)
```

### 4. Gestion des diff√©rences environnementales

```yaml
# inventory/production/group_vars/all.yml
---
environment: production
mariadb_innodb_buffer_pool_size: "32G"
mariadb_max_connections: 500
mariadb_monitoring_enabled: true

# inventory/development/group_vars/all.yml
---
environment: development
mariadb_innodb_buffer_pool_size: "1G"
mariadb_max_connections: 50
mariadb_monitoring_enabled: false
```

### 5. Validation pre-flight

```yaml
---
- name: Pre-flight checks
  hosts: mariadb_cluster
  tasks:
    - name: Check minimum RAM
      ansible.builtin.assert:
        that:
          - ansible_memtotal_mb >= 4096
        fail_msg: "Minimum 4GB RAM required for MariaDB 11.8"
        
    - name: Check disk space
      ansible.builtin.assert:
        that:
          - item.size_available >= 10737418240  # 10GB
        fail_msg: "Insufficient disk space on {{ item.mount }}"
      loop: "{{ ansible_mounts }}"
      when: item.mount in ['/var', '/var/lib/mysql']
      
    - name: Verify ports are available
      ansible.builtin.wait_for:
        port: "{{ mariadb_port }}"
        state: stopped
        timeout: 5
      ignore_errors: true
      register: port_check
      failed_when: port_check.failed == false
```

---

## Patterns pour environnements cloud

### AWS EC2 avec inventory dynamique

```yaml
# inventory/aws_ec2.yml
plugin: amazon.aws.aws_ec2
regions:
  - eu-west-1
  - eu-west-3
  
filters:
  tag:Environment: production
  tag:Service: mariadb
  instance-state-name: running

keyed_groups:
  - key: tags.Role
    prefix: role
  - key: tags.Environment
    prefix: env
    
hostnames:
  - private-ip-address
  
compose:
  ansible_host: private_ip_address
  mariadb_replication_role: tags.ReplicationRole
```

```bash
# Test de l'inventaire dynamique
ansible-inventory -i inventory/aws_ec2.yml --graph

# Utilisation dans playbook
ansible-playbook -i inventory/aws_ec2.yml playbooks/deploy_mariadb.yml
```

### Gestion multi-r√©gion

```yaml
# inventory/production/group_vars/mariadb_cluster.yml
---
mariadb_regions:
  eu-west-1:
    primary: db-eu-west-1-primary
    replicas:
      - db-eu-west-1-replica-1
      - db-eu-west-1-replica-2
  us-east-1:
    primary: db-us-east-1-primary
    replicas:
      - db-us-east-1-replica-1
      
mariadb_cross_region_replication: true
mariadb_gtid_domain_id_base: 100  # EU
```

---

## Monitoring et observabilit√©

### D√©ploiement mysqld_exporter avec Ansible

```yaml
---
# roles/mariadb/tasks/monitoring.yml
- name: Create monitoring user
  community.mysql.mysql_user:
    name: exporter
    password: "{{ vault_exporter_password }}"
    priv: "*.*:PROCESS,REPLICATION CLIENT,SELECT"
    host: localhost
    state: present
    
- name: Download mysqld_exporter
  ansible.builtin.get_url:
    url: "https://github.com/prometheus/mysqld_exporter/releases/download/v0.15.1/mysqld_exporter-0.15.1.linux-amd64.tar.gz"
    dest: /tmp/mysqld_exporter.tar.gz
    
- name: Extract mysqld_exporter
  ansible.builtin.unarchive:
    src: /tmp/mysqld_exporter.tar.gz
    dest: /opt
    remote_src: true
    creates: /opt/mysqld_exporter-0.15.1.linux-amd64
    
- name: Create exporter config
  ansible.builtin.template:
    src: mysqld_exporter.cnf.j2
    dest: /etc/.mysqld_exporter.cnf
    owner: root
    group: root
    mode: '0600'
    
- name: Create systemd service
  ansible.builtin.template:
    src: mysqld_exporter.service.j2
    dest: /etc/systemd/system/mysqld_exporter.service
    owner: root
    group: root
    mode: '0644'
  notify: restart mysqld_exporter
    
- name: Start mysqld_exporter
  ansible.builtin.systemd:
    name: mysqld_exporter
    state: started
    enabled: true
    daemon_reload: true
```

---

## Cas d'usage avanc√©s

### 1. D√©ploiement Galera Cluster

```yaml
---
# playbooks/deploy_galera.yml
- name: Deploy MariaDB Galera Cluster
  hosts: galera_cluster
  become: true
  
  vars:
    galera_cluster_name: "production_cluster"
    galera_cluster_nodes: "{{ groups['galera_cluster'] | map('extract', hostvars, 'ansible_host') | join(',') }}"
    
  tasks:
    - name: Install Galera packages
      ansible.builtin.apt:
        name:
          - mariadb-server
          - mariadb-client
          - galera-4
          - rsync
        state: present
        
    - name: Configure Galera
      ansible.builtin.template:
        src: galera.cnf.j2
        dest: /etc/mysql/conf.d/galera.cnf
      notify: restart mariadb
      
    - name: Bootstrap first node
      ansible.builtin.command: galera_new_cluster
      when: inventory_hostname == groups['galera_cluster'][0]
      run_once: true
      
    - name: Start other nodes
      ansible.builtin.systemd:
        name: mariadb
        state: started
      when: inventory_hostname != groups['galera_cluster'][0]
```

### 2. Backup automatis√© avec Mariabackup

```yaml
---
# roles/mariadb/tasks/backup.yml
- name: Create backup user
  community.mysql.mysql_user:
    name: backup
    password: "{{ vault_backup_password }}"
    priv: "*.*:RELOAD,LOCK TABLES,REPLICATION CLIENT,PROCESS,SUPER"
    host: localhost
    state: present
    
- name: Create backup directory
  ansible.builtin.file:
    path: /backup/mariadb
    state: directory
    owner: mysql
    group: mysql
    mode: '0750'
    
- name: Deploy backup script
  ansible.builtin.template:
    src: mariabackup.sh.j2
    dest: /usr/local/bin/mariabackup.sh
    owner: root
    group: root
    mode: '0755'
    
- name: Schedule daily backup
  ansible.builtin.cron:
    name: "MariaDB daily backup"
    minute: "0"
    hour: "2"
    job: "/usr/local/bin/mariabackup.sh >> /var/log/mariabackup.log 2>&1"
    user: root
```

```bash
# templates/mariabackup.sh.j2
#!/bin/bash
BACKUP_DIR="/backup/mariadb"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_PATH="${BACKUP_DIR}/${DATE}"

# Backup complet
mariabackup --backup \
  --target-dir="${BACKUP_PATH}" \
  --user=backup \
  --password="{{ vault_backup_password }}"

# Prepare backup
mariabackup --prepare --target-dir="${BACKUP_PATH}"

# Compression
tar czf "${BACKUP_PATH}.tar.gz" -C "${BACKUP_DIR}" "${DATE}"
rm -rf "${BACKUP_PATH}"

# Rotation (garder 7 jours)
find "${BACKUP_DIR}" -name "*.tar.gz" -mtime +7 -delete
```

---

## ‚úÖ Points cl√©s √† retenir

- **Idempotence** : Les playbooks Ansible doivent √™tre ex√©cutables plusieurs fois sans effet de bord
- **S√©curit√©** : Utilisez Ansible Vault pour tous les secrets (mots de passe, certificats)
- **Modularit√©** : Structurez avec des r√¥les r√©utilisables et des variables hi√©rarchiques
- **Validation** : Utilisez `--check` et `--diff` pour pr√©visualiser les changements
- **Testing** : Int√©grez Molecule pour tester les r√¥les en environnement isol√©
- **Documentation** : Commentez les variables et tasks complexes
- **MariaDB 11.8** : Profitez des optimisations SSD, TLS par d√©faut, utf8mb4 natif
- **Handlers** : Utilisez-les pour red√©marrer les services uniquement si n√©cessaire
- **Tags** : Permettent des ex√©cutions cibl√©es et acc√©l√®rent le d√©veloppement
- **Inventory dynamique** : Essential en environnement cloud pour d√©couvrir automatiquement les instances

---

## üîó Ressources et r√©f√©rences

### Documentation officielle
- [üìñ MariaDB Documentation](https://mariadb.com/kb/en/documentation/)
- [üìñ Ansible Documentation](https://docs.ansible.com/)
- [üìñ Ansible MySQL Modules](https://docs.ansible.com/ansible/latest/collections/community/mysql/index.html)
- [üìñ Ansible Vault](https://docs.ansible.com/ansible/latest/user_guide/vault.html)

### Collections Ansible
- [community.mysql](https://galaxy.ansible.com/community/mysql) - Modules MariaDB/MySQL
- [amazon.aws](https://galaxy.ansible.com/amazon/aws) - AWS inventory dynamique
- [azure.azcollection](https://galaxy.ansible.com/azure/azcollection) - Azure inventory

### Outils compl√©mentaires
- [Molecule](https://molecule.readthedocs.io/) - Testing framework pour r√¥les Ansible
- [Ansible Lint](https://ansible-lint.readthedocs.io/) - Linter pour playbooks
- [mariadb-operator](https://github.com/mariadb-operator/mariadb-operator) - Kubernetes operator

### Exemples de r√¥les Ansible MariaDB
- [geerlingguy.mysql](https://github.com/geerlingguy/ansible-role-mysql)
- [bertvv.mariadb](https://github.com/bertvv/ansible-role-mariadb)

---

## ‚û°Ô∏è Section suivante

**16.2.2 Terraform : Providers cloud** : D√©couvrez comment provisionner l'infrastructure MariaDB avec Terraform sur AWS, Azure et GCP, avec gestion de l'√©tat distant et modules r√©utilisables.

---

**MariaDB** : 11.8 LTS

‚è≠Ô∏è [Terraform : Providers cloud](/16-devops-automatisation/02.2-terraform-providers.md)
