ğŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 19.4.1 mariadb-upgrade

> **Niveau** : AvancÃ© Ã  Expert  
> **DurÃ©e estimÃ©e** : 5-6 heures  
> **PrÃ©requis** : Administration MariaDB, gestion des sauvegardes, comprÃ©hension de l'architecture interne InnoDB

## ğŸ¯ Objectifs d'apprentissage

Ã€ l'issue de cette section, vous serez capable de :
- MaÃ®triser l'outil mariadb-upgrade et ses options avancÃ©es
- Planifier et exÃ©cuter des mises Ã  jour majeures et mineures
- Choisir entre upgrade in-place et migration logique selon le contexte
- GÃ©rer les migrations de System-Versioned Tables (ğŸ†• 11.8)
- ImplÃ©menter des stratÃ©gies de rollback fiables
- Orchestrer des upgrades zero-downtime en production

---

## Introduction

La mise Ã  jour de MariaDB est une opÃ©ration critique qui nÃ©cessite une planification minutieuse. L'outil `mariadb-upgrade` (anciennement `mysql_upgrade`) est le composant central de ce processus, responsable de la mise Ã  jour des tables systÃ¨me et de la vÃ©rification de la compatibilitÃ© des donnÃ©es.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    PROCESSUS DE MISE Ã€ JOUR MARIADB                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚  PRÃ‰PARATION â”‚    â”‚   UPGRADE   â”‚    â”‚  VALIDATION â”‚             â”‚
â”‚  â”‚              â”‚    â”‚             â”‚    â”‚             â”‚             â”‚
â”‚  â”‚ â€¢ Backup     â”‚â”€â”€â”€â–¶â”‚ â€¢ Stop      â”‚â”€â”€â”€â–¶â”‚ â€¢ Tests     â”‚             â”‚
â”‚  â”‚ â€¢ Audit      â”‚    â”‚ â€¢ Install   â”‚    â”‚ â€¢ Perf      â”‚             â”‚
â”‚  â”‚ â€¢ Plan       â”‚    â”‚ â€¢ Start     â”‚    â”‚ â€¢ Rollback? â”‚             â”‚
â”‚  â”‚              â”‚    â”‚ â€¢ Upgrade   â”‚    â”‚             â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                                                                     â”‚
â”‚  DurÃ©e typique :    â”‚                  â”‚                            â”‚
â”‚  Major: 1-4h        â”‚  mariadb-upgrade â”‚  Monitoring intensif       â”‚
â”‚  Minor: 15-30min    â”‚  est exÃ©cutÃ© ici â”‚  24-48h                    â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Comprendre mariadb-upgrade

### RÃ´le et fonctionnement

`mariadb-upgrade` effectue plusieurs opÃ©rations essentielles :

1. **Mise Ã  jour des tables systÃ¨me** (`mysql.*`)
2. **VÃ©rification et rÃ©paration des tables utilisateur**
3. **Mise Ã  jour des privilÃ¨ges** pour les nouvelles fonctionnalitÃ©s
4. **Conversion des formats internes** si nÃ©cessaire

```bash
# Emplacement de l'outil
which mariadb-upgrade
# /usr/bin/mariadb-upgrade

# Version et aide
mariadb-upgrade --version
mariadb-upgrade --help
```

### Quand exÃ©cuter mariadb-upgrade

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                NÃ‰CESSITÃ‰ DE mariadb-upgrade                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Type de mise Ã  jour          â”‚ mariadb-upgrade requis?             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  Patch (10.6.15 â†’ 10.6.16)   â”‚ RecommandÃ© (rapide)                  â”‚
â”‚  Minor (10.6 â†’ 10.11)        â”‚ OBLIGATOIRE                          â”‚
â”‚  Major (10.x â†’ 11.x)         â”‚ OBLIGATOIRE                          â”‚
â”‚  MySQL â†’ MariaDB             â”‚ OBLIGATOIRE                          â”‚
â”‚  Downgrade                   â”‚ NON (utiliser dump/restore)          â”‚
â”‚                                                                     â”‚
â”‚  âš ï¸  IMPORTANT : Toujours exÃ©cuter aprÃ¨s le premier dÃ©marrage       â”‚
â”‚     du nouveau binaire avec les anciennes donnÃ©es                   â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Syntaxe et options principales

```bash
# Syntaxe de base
mariadb-upgrade [options]

# Options de connexion
mariadb-upgrade \
    --host=localhost \
    --port=3306 \
    --user=root \
    --password='SecureP@ss' \
    --socket=/var/run/mysqld/mysqld.sock

# Options principales
mariadb-upgrade \
    --verbose \              # Afficher les dÃ©tails
    --force \                # Forcer mÃªme si dÃ©jÃ  exÃ©cutÃ©
    --check-if-upgrade-is-needed \  # VÃ©rifier seulement
    --skip-write-binlog \    # Ne pas logger dans binlog
    --write-binlog \         # Logger dans binlog (rÃ©plication)
    --silent \               # Mode silencieux
    --debug-info             # Afficher infos debug
```

### Options avancÃ©es

```bash
# ContrÃ´le des tables Ã  vÃ©rifier
mariadb-upgrade \
    --upgrade-system-tables \   # Uniquement tables systÃ¨me
    --skip-sys-schema           # Ignorer le schema sys

# Gestion de la rÃ©paration
mariadb-upgrade \
    --auto-repair \            # RÃ©parer automatiquement
    --repair-threads=4         # ParallÃ©lisme rÃ©paration

# Pour environnements spÃ©cifiques
mariadb-upgrade \
    --ssl \                    # Utiliser SSL
    --ssl-ca=/path/ca.pem \
    --ssl-cert=/path/cert.pem \
    --ssl-key=/path/key.pem

# Version check
mariadb-upgrade --version-check
```

---

## Processus de mise Ã  jour dÃ©taillÃ©

### Mise Ã  jour mineure (patch)

```bash
#!/bin/bash
# minor_upgrade.sh - Mise Ã  jour patch (ex: 11.4.2 â†’ 11.4.3)

set -e

BACKUP_DIR="/backup/pre-upgrade"
LOG_FILE="/var/log/mariadb-upgrade-$(date +%Y%m%d).log"

echo "=== Mise Ã  jour patch MariaDB ===" | tee -a $LOG_FILE
echo "Date: $(date)" | tee -a $LOG_FILE

# 1. VÃ©rifier la version actuelle
echo "[1/6] Version actuelle:" | tee -a $LOG_FILE
mariadb -e "SELECT VERSION();" | tee -a $LOG_FILE

# 2. Backup rapide (structure + donnÃ©es critiques)
echo "[2/6] Backup des tables systÃ¨me..." | tee -a $LOG_FILE
mariadb-dump --single-transaction \
    --routines --triggers \
    mysql > $BACKUP_DIR/mysql_db_$(date +%Y%m%d).sql

# 3. VÃ©rifier si upgrade nÃ©cessaire
echo "[3/6] VÃ©rification prÃ©-upgrade..." | tee -a $LOG_FILE
if mariadb-upgrade --check-if-upgrade-is-needed; then
    echo "Upgrade non nÃ©cessaire selon mariadb-upgrade"
fi

# 4. ArrÃªter MariaDB
echo "[4/6] ArrÃªt de MariaDB..." | tee -a $LOG_FILE
systemctl stop mariadb

# 5. Mise Ã  jour des packages
echo "[5/6] Installation nouvelle version..." | tee -a $LOG_FILE
# Debian/Ubuntu
apt-get update && apt-get install -y mariadb-server mariadb-client

# CentOS/RHEL
# yum update -y MariaDB-server MariaDB-client

# 6. DÃ©marrer et upgrade
echo "[6/6] DÃ©marrage et upgrade..." | tee -a $LOG_FILE
systemctl start mariadb
mariadb-upgrade --verbose 2>&1 | tee -a $LOG_FILE

# VÃ©rification finale
echo "=== Nouvelle version ===" | tee -a $LOG_FILE
mariadb -e "SELECT VERSION();" | tee -a $LOG_FILE

echo "=== Mise Ã  jour terminÃ©e ===" | tee -a $LOG_FILE
```

### Mise Ã  jour majeure (version)

```bash
#!/bin/bash
# major_upgrade.sh - Mise Ã  jour majeure (ex: 10.11 â†’ 11.4)

set -e

# Variables
OLD_VERSION="10.11"
NEW_VERSION="11.4"
BACKUP_DIR="/backup/major-upgrade-$(date +%Y%m%d)"
LOG_FILE="/var/log/mariadb-major-upgrade.log"
DATADIR="/var/lib/mysql"

echo "=== Mise Ã  jour majeure MariaDB $OLD_VERSION â†’ $NEW_VERSION ===" | tee $LOG_FILE

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 1 : PRÃ‰PARATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo "[PHASE 1] PrÃ©paration" | tee -a $LOG_FILE

# 1.1 VÃ©rifier version actuelle
CURRENT=$(mariadb -BNe "SELECT VERSION();")
echo "Version actuelle: $CURRENT" | tee -a $LOG_FILE

# 1.2 CrÃ©er rÃ©pertoire backup
mkdir -p $BACKUP_DIR
echo "Backup directory: $BACKUP_DIR" | tee -a $LOG_FILE

# 1.3 Backup complet
echo "Backup complet en cours..." | tee -a $LOG_FILE

# Option A : Backup logique (portable, plus lent)
mariadb-dump \
    --all-databases \
    --single-transaction \
    --routines \
    --triggers \
    --events \
    --flush-logs \
    --master-data=2 \
    > $BACKUP_DIR/full_backup.sql 2>> $LOG_FILE

# Option B : Backup physique (rapide, mÃªme version)
mariabackup \
    --backup \
    --target-dir=$BACKUP_DIR/physical \
    --user=backup_user \
    --password='BackupP@ss' \
    2>> $LOG_FILE

# 1.4 Sauvegarder la configuration
cp -a /etc/mysql $BACKUP_DIR/etc_mysql
cp -a /etc/my.cnf* $BACKUP_DIR/ 2>/dev/null || true

# 1.5 Sauvegarder les fichiers de donnÃ©es (extra sÃ©curitÃ©)
echo "Snapshot du datadir..." | tee -a $LOG_FILE
cp -a $DATADIR $BACKUP_DIR/datadir_snapshot

# 1.6 Lister les tables pour vÃ©rification post-upgrade
mariadb -BNe "
    SELECT CONCAT(table_schema, '.', table_name, ':', table_rows)
    FROM information_schema.tables
    WHERE table_schema NOT IN ('information_schema', 'performance_schema', 'sys')
    ORDER BY table_schema, table_name;
" > $BACKUP_DIR/table_inventory.txt

echo "Tables inventoriÃ©es: $(wc -l < $BACKUP_DIR/table_inventory.txt)" | tee -a $LOG_FILE

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 2 : MISE Ã€ JOUR
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo "[PHASE 2] Mise Ã  jour" | tee -a $LOG_FILE

# 2.1 ArrÃªter MariaDB proprement
echo "ArrÃªt de MariaDB..." | tee -a $LOG_FILE
mariadb -e "SET GLOBAL innodb_fast_shutdown = 0;"  # Clean shutdown
systemctl stop mariadb

# Attendre l'arrÃªt complet
while pgrep -x mysqld > /dev/null; do
    echo "Attente arrÃªt mysqld..."
    sleep 2
done

# 2.2 Mettre Ã  jour le repository
echo "Mise Ã  jour repository vers $NEW_VERSION..." | tee -a $LOG_FILE

# Debian/Ubuntu
cat > /etc/apt/sources.list.d/mariadb.list << EOF
deb [arch=amd64] https://mirror.mariadb.org/repo/$NEW_VERSION/ubuntu $(lsb_release -cs) main
EOF

apt-get update

# 2.3 Installer nouvelle version
echo "Installation MariaDB $NEW_VERSION..." | tee -a $LOG_FILE
apt-get install -y mariadb-server mariadb-client mariadb-backup

# CentOS/RHEL alternative:
# yum install -y MariaDB-server MariaDB-client MariaDB-backup

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 3 : UPGRADE DES DONNÃ‰ES
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo "[PHASE 3] Upgrade des donnÃ©es" | tee -a $LOG_FILE

# 3.1 DÃ©marrer MariaDB
echo "DÃ©marrage MariaDB $NEW_VERSION..." | tee -a $LOG_FILE
systemctl start mariadb

# Attendre que MariaDB soit prÃªt
until mariadb -e "SELECT 1" > /dev/null 2>&1; do
    echo "Attente dÃ©marrage MariaDB..."
    sleep 2
done

# 3.2 ExÃ©cuter mariadb-upgrade
echo "ExÃ©cution mariadb-upgrade..." | tee -a $LOG_FILE
mariadb-upgrade \
    --verbose \
    --force \
    --write-binlog \
    2>&1 | tee -a $LOG_FILE

# 3.3 VÃ©rification version
NEW_VER=$(mariadb -BNe "SELECT VERSION();")
echo "Nouvelle version: $NEW_VER" | tee -a $LOG_FILE

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 4 : VALIDATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo "[PHASE 4] Validation" | tee -a $LOG_FILE

# 4.1 VÃ©rifier les tables
echo "VÃ©rification des tables..." | tee -a $LOG_FILE
mysqlcheck --all-databases --check 2>&1 | tee -a $LOG_FILE

# 4.2 Comparer inventaire des tables
mariadb -BNe "
    SELECT CONCAT(table_schema, '.', table_name, ':', table_rows)
    FROM information_schema.tables
    WHERE table_schema NOT IN ('information_schema', 'performance_schema', 'sys')
    ORDER BY table_schema, table_name;
" > $BACKUP_DIR/table_inventory_after.txt

echo "Comparaison inventaire tables..." | tee -a $LOG_FILE
diff $BACKUP_DIR/table_inventory.txt $BACKUP_DIR/table_inventory_after.txt || true

# 4.3 Tester les connexions
echo "Test connexion..." | tee -a $LOG_FILE
mariadb -e "SHOW DATABASES;" | tee -a $LOG_FILE

# 4.4 VÃ©rifier les erreurs
echo "VÃ©rification logs d'erreur..." | tee -a $LOG_FILE
tail -50 /var/log/mysql/error.log | grep -i "error\|warning" || echo "Pas d'erreurs"

echo "=== Mise Ã  jour majeure terminÃ©e ===" | tee -a $LOG_FILE
echo "Surveillez les performances et logs pendant 24-48h" | tee -a $LOG_FILE
```

---

## ğŸ†• Migration System-Versioned Tables (MariaDB 11.8)

MariaDB 11.8 introduit un changement de format pour les timestamps des System-Versioned Tables. Cette section dÃ©taille la migration.

### Comprendre le changement

```sql
-- Avant MariaDB 11.8
-- Les timestamps des colonnes ROW START/END utilisaient un format interne
-- limitÃ© Ã  6 bytes, avec une prÃ©cision de microsecondes mais une plage rÃ©duite

-- MariaDB 11.8+
-- Nouveau format avec :
-- â€¢ Extension jusqu'Ã  l'annÃ©e 2106 (rÃ©solution du problÃ¨me Y2038)
-- â€¢ Meilleure prÃ©cision
-- â€¢ Format interne optimisÃ©

-- VÃ©rifier le format actuel d'une table
SELECT TABLE_NAME, ROW_FORMAT, CREATE_OPTIONS
FROM information_schema.TABLES
WHERE TABLE_SCHEMA = 'mydb'
  AND CREATE_OPTIONS LIKE '%SYSTEM VERSIONING%';
```

### Identifier les tables Ã  migrer

```sql
-- Script d'audit des System-Versioned Tables
SELECT 
    t.TABLE_SCHEMA,
    t.TABLE_NAME,
    t.ENGINE,
    t.ROW_FORMAT,
    t.TABLE_ROWS,
    ROUND(t.DATA_LENGTH / 1024 / 1024, 2) AS data_mb,
    c_start.COLUMN_NAME AS row_start_column,
    c_end.COLUMN_NAME AS row_end_column,
    c_start.DATA_TYPE AS timestamp_type
FROM information_schema.TABLES t
JOIN information_schema.COLUMNS c_start 
    ON t.TABLE_SCHEMA = c_start.TABLE_SCHEMA 
    AND t.TABLE_NAME = c_start.TABLE_NAME
    AND c_start.EXTRA LIKE '%GENERATED ALWAYS AS ROW START%'
JOIN information_schema.COLUMNS c_end 
    ON t.TABLE_SCHEMA = c_end.TABLE_SCHEMA 
    AND t.TABLE_NAME = c_end.TABLE_NAME
    AND c_end.EXTRA LIKE '%GENERATED ALWAYS AS ROW END%'
WHERE t.TABLE_SCHEMA NOT IN ('mysql', 'information_schema', 'performance_schema', 'sys')
ORDER BY t.DATA_LENGTH DESC;
```

### StratÃ©gie de migration des System-Versioned Tables

```bash
#!/bin/bash
# migrate_system_versioned.sh

set -e

DATABASE="production"
BACKUP_DIR="/backup/svt-migration"
LOG_FILE="/var/log/svt-migration.log"

echo "=== Migration System-Versioned Tables pour MariaDB 11.8 ===" | tee $LOG_FILE

# 1. Identifier les tables versionnÃ©es
echo "[1] Identification des tables versionnÃ©es..." | tee -a $LOG_FILE

mariadb -BNe "
    SELECT TABLE_NAME 
    FROM information_schema.TABLES 
    WHERE TABLE_SCHEMA = '$DATABASE'
    AND CREATE_OPTIONS LIKE '%versioning%'
" > /tmp/svt_tables.txt

TABLE_COUNT=$(wc -l < /tmp/svt_tables.txt)
echo "Tables versionnÃ©es trouvÃ©es: $TABLE_COUNT" | tee -a $LOG_FILE

# 2. Pour chaque table, effectuer la migration
while read TABLE; do
    echo "" | tee -a $LOG_FILE
    echo "[Migration] $DATABASE.$TABLE" | tee -a $LOG_FILE
    
    # 2.1 Backup de la table (donnÃ©es actuelles + historique)
    echo "  Backup..." | tee -a $LOG_FILE
    mariadb-dump --single-transaction \
        $DATABASE $TABLE > $BACKUP_DIR/${TABLE}_backup.sql
    
    # 2.2 Obtenir la structure actuelle
    STRUCTURE=$(mariadb -BNe "SHOW CREATE TABLE $DATABASE.$TABLE" | tail -1)
    
    # 2.3 Compter les enregistrements
    CURRENT_COUNT=$(mariadb -BNe "SELECT COUNT(*) FROM $DATABASE.$TABLE")
    HISTORY_COUNT=$(mariadb -BNe "SELECT COUNT(*) FROM $DATABASE.$TABLE FOR SYSTEM_TIME ALL" 2>/dev/null || echo "0")
    
    echo "  Enregistrements actuels: $CURRENT_COUNT" | tee -a $LOG_FILE
    echo "  Enregistrements historiques: $HISTORY_COUNT" | tee -a $LOG_FILE
    
    # 2.4 Option A : ALTER TABLE (si supportÃ©)
    # MariaDB 11.8 peut convertir automatiquement le format
    echo "  Tentative ALTER TABLE..." | tee -a $LOG_FILE
    
    if mariadb -e "ALTER TABLE $DATABASE.$TABLE FORCE;" 2>> $LOG_FILE; then
        echo "  âœ“ ALTER TABLE rÃ©ussi" | tee -a $LOG_FILE
    else
        # 2.5 Option B : RecrÃ©ation de la table
        echo "  ALTER Ã©chouÃ©, recrÃ©ation nÃ©cessaire..." | tee -a $LOG_FILE
        
        # DÃ©sactiver temporairement le versioning
        mariadb -e "ALTER TABLE $DATABASE.$TABLE DROP SYSTEM VERSIONING;"
        
        # Exporter les donnÃ©es
        mariadb-dump --single-transaction --no-create-info \
            $DATABASE $TABLE > $BACKUP_DIR/${TABLE}_data.sql
        
        # RecrÃ©er avec nouvelle structure
        mariadb -e "DROP TABLE $DATABASE.$TABLE;"
        mariadb $DATABASE < $BACKUP_DIR/${TABLE}_backup.sql
        
        echo "  âœ“ Table recrÃ©Ã©e" | tee -a $LOG_FILE
    fi
    
    # 2.6 VÃ©rification
    NEW_COUNT=$(mariadb -BNe "SELECT COUNT(*) FROM $DATABASE.$TABLE FOR SYSTEM_TIME ALL")
    if [ "$HISTORY_COUNT" = "$NEW_COUNT" ]; then
        echo "  âœ“ VÃ©rification OK (${NEW_COUNT} enregistrements)" | tee -a $LOG_FILE
    else
        echo "  âš  ATTENTION: Compte diffÃ©rent! Avant: $HISTORY_COUNT, AprÃ¨s: $NEW_COUNT" | tee -a $LOG_FILE
    fi
    
done < /tmp/svt_tables.txt

echo "" | tee -a $LOG_FILE
echo "=== Migration System-Versioned terminÃ©e ===" | tee -a $LOG_FILE
```

### Script SQL de migration manuelle

```sql
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--              MIGRATION MANUELLE SYSTEM-VERSIONED TABLE
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Exemple : Table employees avec versioning

-- 1. VÃ©rifier la structure actuelle
SHOW CREATE TABLE employees\G

-- 2. CrÃ©er une table temporaire avec le nouveau format
CREATE TABLE employees_new (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    salary DECIMAL(10,2),
    department_id INT,
    -- Nouvelles colonnes de versioning avec format 11.8
    row_start TIMESTAMP(6) GENERATED ALWAYS AS ROW START INVISIBLE,
    row_end TIMESTAMP(6) GENERATED ALWAYS AS ROW END INVISIBLE,
    PERIOD FOR SYSTEM_TIME (row_start, row_end)
) ENGINE=InnoDB WITH SYSTEM VERSIONING;

-- 3. Copier les donnÃ©es actuelles
INSERT INTO employees_new (id, name, salary, department_id)
SELECT id, name, salary, department_id
FROM employees;

-- 4. Pour l'historique, procÃ©dure plus complexe :
-- L'historique doit Ãªtre migrÃ© sÃ©parÃ©ment si nÃ©cessaire

-- 4a. CrÃ©er une table pour stocker l'historique
CREATE TABLE employees_history_backup AS
SELECT *, row_start AS old_row_start, row_end AS old_row_end
FROM employees FOR SYSTEM_TIME ALL
WHERE row_end < '9999-12-31';  -- Exclure les enregistrements courants

-- 5. Renommer les tables
RENAME TABLE 
    employees TO employees_old,
    employees_new TO employees;

-- 6. VÃ©rification
SELECT 'Current' as type, COUNT(*) FROM employees
UNION ALL
SELECT 'History' as type, COUNT(*) FROM employees FOR SYSTEM_TIME ALL
UNION ALL  
SELECT 'Old Current' as type, COUNT(*) FROM employees_old
UNION ALL
SELECT 'Old History' as type, COUNT(*) FROM employees_old FOR SYSTEM_TIME ALL;

-- 7. Si tout est OK, supprimer l'ancienne table
-- DROP TABLE employees_old;
-- DROP TABLE employees_history_backup;
```

### Gestion de l'extension TIMESTAMP 2106

```sql
-- ğŸ†• MariaDB 11.8 : Extension TIMESTAMP jusqu'Ã  2106

-- Avant 11.8 : TIMESTAMP limitÃ© Ã  2038-01-19 03:14:07 UTC
-- AprÃ¨s 11.8 : TIMESTAMP Ã©tendu jusqu'Ã  2106

-- VÃ©rifier si une table utilise l'ancien format
SELECT 
    TABLE_NAME,
    COLUMN_NAME,
    DATA_TYPE,
    COLUMN_TYPE
FROM information_schema.COLUMNS
WHERE TABLE_SCHEMA = 'mydb'
  AND DATA_TYPE = 'timestamp';

-- Pour les System-Versioned Tables crÃ©Ã©es avant 11.8,
-- les colonnes ROW START/END peuvent nÃ©cessiter une mise Ã  jour

-- ProcÃ©dure de conversion pour une table existante
DELIMITER //
CREATE PROCEDURE upgrade_svt_timestamp(
    IN p_schema VARCHAR(64),
    IN p_table VARCHAR(64)
)
BEGIN
    DECLARE v_sql TEXT;
    
    -- VÃ©rifier que la table est versionnÃ©e
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.TABLES
        WHERE TABLE_SCHEMA = p_schema 
        AND TABLE_NAME = p_table
        AND CREATE_OPTIONS LIKE '%versioning%'
    ) THEN
        SIGNAL SQLSTATE '45000' 
            SET MESSAGE_TEXT = 'Table is not system-versioned';
    END IF;
    
    -- ALTER TABLE FORCE reconstruit la table avec le nouveau format
    SET v_sql = CONCAT('ALTER TABLE `', p_schema, '`.`', p_table, '` FORCE');
    
    SET @stmt = v_sql;
    PREPARE stmt FROM @stmt;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
    
    SELECT CONCAT('Table ', p_schema, '.', p_table, ' upgraded successfully') AS result;
END //
DELIMITER ;

-- Utilisation
CALL upgrade_svt_timestamp('production', 'employees');
CALL upgrade_svt_timestamp('production', 'orders');
```

---

## StratÃ©gies de mise Ã  jour

### Upgrade In-Place vs Migration Logique

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              COMPARAISON DES STRATÃ‰GIES D'UPGRADE                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  UPGRADE IN-PLACE                                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                  â”‚
â”‚  âœ… Rapide (pas de copie de donnÃ©es)                                â”‚
â”‚  âœ… Simple Ã  exÃ©cuter                                               â”‚
â”‚  âœ… PrÃ©serve l'historique System-Versioned                          â”‚
â”‚  âŒ Requiert arrÃªt du service                                       â”‚
â”‚  âŒ Rollback plus complexe                                          â”‚
â”‚  âŒ Risque si problÃ¨me durant l'upgrade                             â”‚
â”‚                                                                     â”‚
â”‚  RecommandÃ© pour :                                                  â”‚
â”‚  â€¢ Mises Ã  jour patch                                               â”‚
â”‚  â€¢ Environnements avec fenÃªtre de maintenance                       â”‚
â”‚  â€¢ Bases de donnÃ©es < 500 GB                                        â”‚
â”‚                                                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                     â”‚
â”‚  MIGRATION LOGIQUE (dump/restore)                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                   â”‚
â”‚  âœ… Rollback facile (anciennes donnÃ©es intactes)                    â”‚
â”‚  âœ… PossibilitÃ© de tester sur nouvelle instance                     â”‚
â”‚  âœ… Nettoyage/dÃ©fragmentation automatique                           â”‚
â”‚  âŒ Plus lent (dump + restore)                                      â”‚
â”‚  âŒ Espace disque double nÃ©cessaire                                 â”‚
â”‚  âŒ Temps d'arrÃªt plus long                                         â”‚
â”‚                                                                     â”‚
â”‚  RecommandÃ© pour :                                                  â”‚
â”‚  â€¢ Sauts de version importants (10.x â†’ 11.x)                        â”‚
â”‚  â€¢ Changements majeurs de structure                                 â”‚
â”‚  â€¢ Quand rollback garanti est requis                                â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Upgrade In-Place dÃ©taillÃ©

```bash
#!/bin/bash
# inplace_upgrade.sh

set -e

# Variables
NEW_VERSION="11.8"
DATADIR="/var/lib/mysql"
BACKUP_DIR="/backup/inplace-$(date +%Y%m%d)"

# PrÃ©-vÃ©rifications
echo "=== VÃ©rifications prÃ©-upgrade ==="

# Espace disque
DISK_FREE=$(df -BG $DATADIR | tail -1 | awk '{print $4}' | tr -d 'G')
DATA_SIZE=$(du -sG $DATADIR | awk '{print $1}')
echo "Espace libre: ${DISK_FREE}G, DonnÃ©es: ${DATA_SIZE}G"

if [ $DISK_FREE -lt $((DATA_SIZE * 2)) ]; then
    echo "ERREUR: Espace disque insuffisant pour backup sÃ©curisÃ©"
    exit 1
fi

# Tables corrompues ?
echo "VÃ©rification intÃ©gritÃ© tables..."
mysqlcheck --all-databases --check --auto-repair

# Transactions en cours ?
ACTIVE_TX=$(mariadb -BNe "SELECT COUNT(*) FROM information_schema.INNODB_TRX")
if [ "$ACTIVE_TX" -gt 0 ]; then
    echo "ATTENTION: $ACTIVE_TX transactions actives"
    mariadb -e "SELECT * FROM information_schema.INNODB_TRX\G"
fi

# Backup physique
echo "=== Backup physique ==="
mariabackup --backup --target-dir=$BACKUP_DIR --user=root --password='pass'
mariabackup --prepare --target-dir=$BACKUP_DIR

# ArrÃªt propre
echo "=== ArrÃªt MariaDB ==="
mariadb -e "SET GLOBAL innodb_fast_shutdown = 0;"
systemctl stop mariadb

# Mise Ã  jour packages
echo "=== Installation nouvelle version ==="
apt-get update
apt-get install -y mariadb-server mariadb-client

# DÃ©marrage
echo "=== DÃ©marrage et upgrade ==="
systemctl start mariadb

# Attendre le dÃ©marrage
sleep 10

# mariadb-upgrade
mariadb-upgrade --verbose --force

# VÃ©rification
echo "=== VÃ©rification post-upgrade ==="
mariadb -e "SELECT VERSION();"
mysqlcheck --all-databases --check

echo "=== Upgrade In-Place terminÃ© ==="
```

### Migration Logique dÃ©taillÃ©e

```bash
#!/bin/bash
# logical_migration.sh

set -e

# Variables
OLD_HOST="old-mariadb"
NEW_HOST="new-mariadb"
DUMP_DIR="/backup/logical-migration"
DATABASES="production reporting analytics"

echo "=== Migration Logique MariaDB ==="

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 1 : EXPORT DEPUIS ANCIEN SERVEUR
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo "[PHASE 1] Export depuis $OLD_HOST"

for DB in $DATABASES; do
    echo "Export de $DB..."
    
    # Structure
    mariadb-dump -h $OLD_HOST \
        --no-data \
        --routines \
        --triggers \
        --events \
        $DB > $DUMP_DIR/${DB}_structure.sql
    
    # DonnÃ©es (parallÃ©lisÃ© par table)
    TABLES=$(mariadb -h $OLD_HOST -BNe "SHOW TABLES FROM $DB")
    
    for TABLE in $TABLES; do
        echo "  Export $DB.$TABLE..."
        mariadb-dump -h $OLD_HOST \
            --single-transaction \
            --quick \
            --no-create-info \
            $DB $TABLE | gzip > $DUMP_DIR/${DB}_${TABLE}_data.sql.gz &
        
        # Limiter le parallÃ©lisme
        while [ $(jobs -r | wc -l) -ge 4 ]; do
            sleep 1
        done
    done
    wait
done

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 2 : IMPORT SUR NOUVEAU SERVEUR
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo "[PHASE 2] Import sur $NEW_HOST"

for DB in $DATABASES; do
    echo "CrÃ©ation database $DB..."
    mariadb -h $NEW_HOST -e "CREATE DATABASE IF NOT EXISTS $DB"
    
    # Structure
    echo "Import structure $DB..."
    mariadb -h $NEW_HOST $DB < $DUMP_DIR/${DB}_structure.sql
    
    # DonnÃ©es
    echo "Import donnÃ©es $DB..."
    for DATA_FILE in $DUMP_DIR/${DB}_*_data.sql.gz; do
        TABLE=$(basename $DATA_FILE | sed "s/${DB}_\(.*\)_data.sql.gz/\1/")
        echo "  Import $DB.$TABLE..."
        
        zcat $DATA_FILE | mariadb -h $NEW_HOST $DB &
        
        while [ $(jobs -r | wc -l) -ge 4 ]; do
            sleep 1
        done
    done
    wait
done

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 3 : VALIDATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo "[PHASE 3] Validation"

for DB in $DATABASES; do
    echo "Validation $DB..."
    
    # Compter les lignes
    TABLES=$(mariadb -h $NEW_HOST -BNe "SHOW TABLES FROM $DB")
    
    for TABLE in $TABLES; do
        OLD_COUNT=$(mariadb -h $OLD_HOST -BNe "SELECT COUNT(*) FROM $DB.$TABLE")
        NEW_COUNT=$(mariadb -h $NEW_HOST -BNe "SELECT COUNT(*) FROM $DB.$TABLE")
        
        if [ "$OLD_COUNT" = "$NEW_COUNT" ]; then
            echo "  âœ“ $TABLE: $NEW_COUNT lignes"
        else
            echo "  âœ— $TABLE: OLD=$OLD_COUNT NEW=$NEW_COUNT DIFFÃ‰RENCE!"
        fi
    done
done

echo "=== Migration Logique terminÃ©e ==="
```

---

## Rollback et plan de secours

### StratÃ©gie de rollback pour upgrade in-place

```bash
#!/bin/bash
# rollback_inplace.sh

set -e

BACKUP_DIR=$1
OLD_VERSION=$2

if [ -z "$BACKUP_DIR" ] || [ -z "$OLD_VERSION" ]; then
    echo "Usage: $0 <backup_dir> <old_version>"
    echo "Example: $0 /backup/inplace-20250615 10.11"
    exit 1
fi

echo "=== ROLLBACK vers MariaDB $OLD_VERSION ==="

# 1. ArrÃªter MariaDB
echo "[1/5] ArrÃªt de MariaDB..."
systemctl stop mariadb

# 2. Sauvegarder l'Ã©tat actuel (au cas oÃ¹)
echo "[2/5] Sauvegarde Ã©tat actuel..."
DATADIR=$(mariadb -BNe "SELECT @@datadir" 2>/dev/null || echo "/var/lib/mysql")
mv $DATADIR ${DATADIR}.failed_upgrade_$(date +%Y%m%d%H%M%S)

# 3. Restaurer le backup
echo "[3/5] Restauration du backup..."
mariabackup --copy-back --target-dir=$BACKUP_DIR

# 4. Corriger les permissions
echo "[4/5] Correction permissions..."
chown -R mysql:mysql $DATADIR

# 5. Downgrade des packages
echo "[5/5] Downgrade vers $OLD_VERSION..."

# Debian/Ubuntu
apt-get remove -y mariadb-server mariadb-client mariadb-backup

# RÃ©installer ancienne version
cat > /etc/apt/sources.list.d/mariadb.list << EOF
deb [arch=amd64] https://mirror.mariadb.org/repo/$OLD_VERSION/ubuntu $(lsb_release -cs) main
EOF

apt-get update
apt-get install -y mariadb-server=$OLD_VERSION* mariadb-client=$OLD_VERSION*

# DÃ©marrer
systemctl start mariadb

# VÃ©rification
echo "=== VÃ©rification rollback ==="
mariadb -e "SELECT VERSION();"

echo "=== ROLLBACK terminÃ© ==="
```

### Rollback pour migration logique

```bash
#!/bin/bash
# rollback_logical.sh

OLD_HOST=$1
NEW_HOST=$2

echo "=== ROLLBACK Migration Logique ==="

# La migration logique laisse l'ancien serveur intact
# Le rollback consiste simplement Ã  repointer les applications

echo "[1/3] VÃ©rification ancien serveur $OLD_HOST..."
mariadb -h $OLD_HOST -e "SELECT VERSION();"

echo "[2/3] ArrÃªt nouveau serveur $NEW_HOST..."
ssh $NEW_HOST "systemctl stop mariadb"

echo "[3/3] Actions manuelles requises:"
echo "  1. Mettre Ã  jour les connection strings des applications"
echo "  2. Mettre Ã  jour DNS/VIP vers $OLD_HOST"
echo "  3. RedÃ©marrer les applications"

echo "=== ROLLBACK prÃªt (actions manuelles requises) ==="
```

### Plan de rollback automatisÃ© avec test

```bash
#!/bin/bash
# upgrade_with_rollback_test.sh

set -e

BACKUP_DIR="/backup/upgrade-$(date +%Y%m%d)"
TEST_QUERIES="/etc/mariadb/upgrade_test_queries.sql"
ROLLBACK_TRIGGER="/tmp/rollback_required"

# Nettoyer flag de rollback
rm -f $ROLLBACK_TRIGGER

# Fonction de rollback
rollback() {
    echo "!!! ROLLBACK INITIÃ‰ !!!"
    touch $ROLLBACK_TRIGGER
    
    # Logique de rollback
    ./rollback_inplace.sh $BACKUP_DIR $OLD_VERSION
    
    exit 1
}

# Trap pour rollback automatique en cas d'erreur
trap rollback ERR

# === PHASE UPGRADE ===
echo "=== DÃ©but upgrade avec rollback automatique ==="

# Backup
echo "[Backup]"
mariabackup --backup --target-dir=$BACKUP_DIR --user=root --password='pass'

# Upgrade
echo "[Upgrade]"
systemctl stop mariadb
apt-get update && apt-get install -y mariadb-server
systemctl start mariadb
mariadb-upgrade --verbose --force

# === PHASE VALIDATION ===
echo "[Validation] Tests de santÃ©..."

# Test 1 : Version
NEW_VER=$(mariadb -BNe "SELECT VERSION()")
echo "Version: $NEW_VER"

# Test 2 : Toutes les bases accessibles
DATABASES=$(mariadb -BNe "SHOW DATABASES" | grep -v "information_schema\|performance_schema\|mysql\|sys")
for DB in $DATABASES; do
    echo "Test accÃ¨s $DB..."
    if ! mariadb -e "USE $DB; SELECT 1 LIMIT 1;" > /dev/null 2>&1; then
        echo "ERREUR: Impossible d'accÃ©der Ã  $DB"
        rollback
    fi
done

# Test 3 : RequÃªtes critiques
if [ -f "$TEST_QUERIES" ]; then
    echo "ExÃ©cution requÃªtes de test..."
    if ! mariadb < $TEST_QUERIES > /dev/null 2>&1; then
        echo "ERREUR: RequÃªtes de test Ã©chouÃ©es"
        rollback
    fi
fi

# Test 4 : Pas d'erreurs dans les logs
ERRORS=$(tail -100 /var/log/mysql/error.log | grep -c "ERROR" || true)
if [ "$ERRORS" -gt 5 ]; then
    echo "ATTENTION: $ERRORS erreurs dans les logs"
    # Rollback optionnel selon seuil
fi

echo "=== Upgrade terminÃ© avec succÃ¨s ==="

# DÃ©sactiver le trap
trap - ERR
```

---

## Zero-Downtime Upgrade

### Architecture Blue-Green

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BLUE-GREEN UPGRADE STRATEGY                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Phase 1 : Ã‰tat initial                                             â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                             â”‚
â”‚                                                                     â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚       â”‚  HAProxy/   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  BLUE (Active)      â”‚               â”‚
â”‚       â”‚  MaxScale   â”‚         â”‚  MariaDB 10.11      â”‚               â”‚
â”‚       â”‚   (VIP)     â”‚         â”‚                     â”‚               â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚              â”‚                           â”‚                          â”‚
â”‚              â”‚                           â”‚ RÃ©plication              â”‚
â”‚              â”‚                           â–¼                          â”‚
â”‚              â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  GREEN (Standby)    â”‚               â”‚
â”‚                   (backup)    â”‚  MariaDB 10.11      â”‚               â”‚
â”‚                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                     â”‚
â”‚  Phase 2 : Upgrade GREEN                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                            â”‚
â”‚                                                                     â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚       â”‚  HAProxy    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  BLUE (Active)      â”‚               â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚  MariaDB 10.11      â”‚               â”‚
â”‚                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                          â”‚                          â”‚
â”‚       [Upgrade GREEN vers 11.8]          â”‚ RÃ©plication              â”‚
â”‚       [Reconfigurer rÃ©plication]         â–¼                          â”‚
â”‚                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚                               â”‚  GREEN (Upgrading)  â”‚               â”‚
â”‚                               â”‚  MariaDB 11.8       â”‚               â”‚
â”‚                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                     â”‚
â”‚  Phase 3 : Switch vers GREEN                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                        â”‚
â”‚                                                                     â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚       â”‚  HAProxy    â”‚         â”‚  BLUE (Standby)     â”‚               â”‚
â”‚       â”‚   (VIP)     â”‚â”€ â”€ â”€ â”€ â–¶â”‚  MariaDB 10.11      â”‚               â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚              â”‚                           â–²                          â”‚
â”‚              â”‚                           â”‚ RÃ©plication              â”‚
â”‚              â”‚                           â”‚ (inverse)                â”‚
â”‚              â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  GREEN (Active)     â”‚               â”‚
â”‚                    (active)   â”‚  MariaDB 11.8       â”‚               â”‚
â”‚                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                     â”‚
â”‚  Phase 4 : Upgrade BLUE (optionnel)                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                 â”‚
â”‚                                                                     â”‚
â”‚       Upgrade BLUE vers 11.8 pendant que GREEN est actif            â”‚
â”‚       Reconfigurer rÃ©plication bidirectionnelle                     â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Script Blue-Green Upgrade

```bash
#!/bin/bash
# blue_green_upgrade.sh

set -e

# Configuration
BLUE_HOST="mariadb-blue"
GREEN_HOST="mariadb-green"
VIP="192.168.1.100"
NEW_VERSION="11.8"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 1 : PrÃ©paration
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo "=== PHASE 1: PrÃ©paration ==="

# VÃ©rifier que GREEN est synchronisÃ©
echo "VÃ©rification synchronisation GREEN..."
LAG=$(ssh $GREEN_HOST "mariadb -BNe \"SHOW SLAVE STATUS\\G\" | grep Seconds_Behind_Master | awk '{print \$2}'")
if [ "$LAG" != "0" ] && [ "$LAG" != "NULL" ]; then
    echo "ERREUR: GREEN n'est pas synchronisÃ© (lag: $LAG secondes)"
    exit 1
fi
echo "GREEN synchronisÃ© âœ“"

# VÃ©rifier espace disque sur GREEN
DISK_FREE=$(ssh $GREEN_HOST "df -BG /var/lib/mysql | tail -1 | awk '{print \$4}' | tr -d 'G'")
echo "Espace libre sur GREEN: ${DISK_FREE}G"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 2 : Upgrade GREEN
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo "=== PHASE 2: Upgrade GREEN ==="

# ArrÃªter la rÃ©plication sur GREEN
echo "ArrÃªt rÃ©plication sur GREEN..."
ssh $GREEN_HOST "mariadb -e 'STOP SLAVE;'"

# Upgrade GREEN
echo "Upgrade GREEN vers $NEW_VERSION..."
ssh $GREEN_HOST << 'REMOTE_SCRIPT'
    # ArrÃªter MariaDB
    systemctl stop mariadb
    
    # Mettre Ã  jour repository
    curl -sS https://downloads.mariadb.com/MariaDB/mariadb_repo_setup | bash -s -- --mariadb-server-version=mariadb-11.8
    
    # Installer nouvelle version
    apt-get update && apt-get install -y mariadb-server mariadb-client
    
    # DÃ©marrer
    systemctl start mariadb
    
    # mariadb-upgrade
    mariadb-upgrade --verbose --force
REMOTE_SCRIPT

# VÃ©rifier upgrade GREEN
GREEN_VERSION=$(ssh $GREEN_HOST "mariadb -BNe 'SELECT VERSION()'")
echo "GREEN version: $GREEN_VERSION"

# Reconfigurer rÃ©plication depuis BLUE
echo "Reconfiguration rÃ©plication GREEN <- BLUE..."
BINLOG_FILE=$(ssh $BLUE_HOST "mariadb -BNe \"SHOW MASTER STATUS\" | awk '{print \$1}'")
BINLOG_POS=$(ssh $BLUE_HOST "mariadb -BNe \"SHOW MASTER STATUS\" | awk '{print \$2}'")

ssh $GREEN_HOST "mariadb -e \"
    CHANGE MASTER TO
        MASTER_HOST='$BLUE_HOST',
        MASTER_USER='repl_user',
        MASTER_PASSWORD='repl_pass',
        MASTER_LOG_FILE='$BINLOG_FILE',
        MASTER_LOG_POS=$BINLOG_POS;
    START SLAVE;
\""

# Attendre synchronisation
echo "Attente synchronisation GREEN..."
while true; do
    LAG=$(ssh $GREEN_HOST "mariadb -BNe \"SHOW SLAVE STATUS\\G\" | grep Seconds_Behind_Master | awk '{print \$2}'")
    echo "Lag: $LAG"
    if [ "$LAG" = "0" ]; then
        break
    fi
    sleep 5
done
echo "GREEN synchronisÃ© âœ“"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 3 : Switch vers GREEN
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

echo "=== PHASE 3: Switch vers GREEN ==="
echo "ATTENTION: Cette phase va basculer le trafic vers GREEN"
read -p "Continuer? (yes/no): " CONFIRM
if [ "$CONFIRM" != "yes" ]; then
    echo "AnnulÃ© par l'utilisateur"
    exit 0
fi

# Mettre BLUE en read-only
echo "BLUE -> read-only..."
ssh $BLUE_HOST "mariadb -e 'SET GLOBAL read_only = ON;'"

# Attendre que GREEN rattrape les derniÃ¨res Ã©critures
sleep 5
while true; do
    LAG=$(ssh $GREEN_HOST "mariadb -BNe \"SHOW SLAVE STATUS\\G\" | grep Seconds_Behind_Master | awk '{print \$2}'")
    if [ "$LAG" = "0" ]; then
        break
    fi
    sleep 1
done

# ArrÃªter rÃ©plication sur GREEN et promouvoir
echo "Promotion GREEN..."
ssh $GREEN_HOST "mariadb -e 'STOP SLAVE; RESET SLAVE ALL;'"

# Basculer le VIP / HAProxy
echo "Basculement VIP vers GREEN..."
# Option 1 : Keepalived (si configurÃ©)
# ssh $GREEN_HOST "systemctl restart keepalived"

# Option 2 : HAProxy (mise Ã  jour config)
# ssh haproxy-server "sed -i 's/$BLUE_HOST/$GREEN_HOST/' /etc/haproxy/haproxy.cfg && systemctl reload haproxy"

# Option 3 : MaxScale
mysql -h maxscale-host -P 6603 -u admin -p'admin_pass' << EOF
    ALTER SERVER blue_server SET STATUS = 'MAINTENANCE';
    ALTER SERVER green_server SET STATUS = 'MASTER';
EOF

# VÃ©rification
echo "=== VÃ©rification post-switch ==="
ACTIVE_VERSION=$(mysql -h $VIP -BNe "SELECT VERSION();")
echo "Version active: $ACTIVE_VERSION"

echo "=== SWITCH TERMINÃ‰ ==="
echo "GREEN ($GREEN_HOST) est maintenant le serveur actif"
echo "BLUE ($BLUE_HOST) peut Ãªtre upgradÃ© ou gardÃ© pour rollback"
```

### Rolling Upgrade avec Galera

```bash
#!/bin/bash
# galera_rolling_upgrade.sh

set -e

# Cluster Galera 3 nÅ“uds
NODES="galera1 galera2 galera3"
NEW_VERSION="11.8"

echo "=== Rolling Upgrade Galera Cluster ==="

for NODE in $NODES; do
    echo ""
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "Upgrade du nÅ“ud: $NODE"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    
    # VÃ©rifier l'Ã©tat du cluster
    CLUSTER_SIZE=$(ssh $NODE "mariadb -BNe \"SHOW STATUS LIKE 'wsrep_cluster_size'\" | awk '{print \$2}'")
    echo "Taille cluster actuelle: $CLUSTER_SIZE"
    
    if [ "$CLUSTER_SIZE" -lt 3 ]; then
        echo "ERREUR: Cluster incomplet ($CLUSTER_SIZE nÅ“uds). Attente..."
        sleep 60
        continue
    fi
    
    # DÃ©synchroniser le nÅ“ud proprement
    echo "DÃ©synchronisation de $NODE..."
    ssh $NODE "mariadb -e \"SET GLOBAL wsrep_desync = ON;\""
    
    # Attendre que les autres nÅ“uds dÃ©tectent
    sleep 10
    
    # ArrÃªter MariaDB sur ce nÅ“ud
    echo "ArrÃªt de MariaDB sur $NODE..."
    ssh $NODE "systemctl stop mariadb"
    
    # Upgrade des packages
    echo "Installation $NEW_VERSION sur $NODE..."
    ssh $NODE << REMOTE
        curl -sS https://downloads.mariadb.com/MariaDB/mariadb_repo_setup | bash -s -- --mariadb-server-version=mariadb-$NEW_VERSION
        apt-get update
        apt-get install -y mariadb-server mariadb-client galera-4
REMOTE
    
    # DÃ©marrer et rejoindre le cluster
    echo "RedÃ©marrage de $NODE..."
    ssh $NODE "systemctl start mariadb"
    
    # Attendre la synchronisation
    echo "Attente synchronisation SST/IST..."
    while true; do
        STATE=$(ssh $NODE "mariadb -BNe \"SHOW STATUS LIKE 'wsrep_local_state_comment'\" | awk '{print \$2}'")
        echo "Ã‰tat: $STATE"
        if [ "$STATE" = "Synced" ]; then
            break
        fi
        sleep 10
    done
    
    # RÃ©activer la synchronisation
    ssh $NODE "mariadb -e \"SET GLOBAL wsrep_desync = OFF;\""
    
    # mariadb-upgrade
    echo "ExÃ©cution mariadb-upgrade sur $NODE..."
    ssh $NODE "mariadb-upgrade --verbose --force"
    
    # VÃ©rification
    NODE_VERSION=$(ssh $NODE "mariadb -BNe 'SELECT VERSION()'")
    echo "$NODE upgradÃ© vers: $NODE_VERSION"
    
    # Pause entre nÅ“uds
    echo "Pause de 60 secondes avant prochain nÅ“ud..."
    sleep 60
done

echo ""
echo "=== Rolling Upgrade Galera terminÃ© ==="

# VÃ©rification finale
echo "Ã‰tat final du cluster:"
for NODE in $NODES; do
    VERSION=$(ssh $NODE "mariadb -BNe 'SELECT VERSION()'")
    STATE=$(ssh $NODE "mariadb -BNe \"SHOW STATUS LIKE 'wsrep_local_state_comment'\" | awk '{print \$2}'")
    echo "$NODE: $VERSION ($STATE)"
done
```

---

## Tests de compatibilitÃ© prÃ©-upgrade

### Script d'audit prÃ©-upgrade

```sql
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--              AUDIT PRÃ‰-UPGRADE MARIADB
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- ExÃ©cuter avant toute mise Ã  jour majeure

-- 1. Informations systÃ¨me
SELECT '=== INFORMATIONS SYSTÃˆME ===' AS section;
SELECT 
    @@version AS current_version,
    @@version_compile_os AS os,
    @@datadir AS datadir,
    @@innodb_buffer_pool_size / 1024 / 1024 / 1024 AS buffer_pool_gb;

-- 2. Taille des donnÃ©es
SELECT '=== TAILLE DES DONNÃ‰ES ===' AS section;
SELECT 
    table_schema AS `database`,
    ROUND(SUM(data_length + index_length) / 1024 / 1024 / 1024, 2) AS size_gb,
    COUNT(*) AS tables
FROM information_schema.TABLES
WHERE table_schema NOT IN ('mysql', 'information_schema', 'performance_schema', 'sys')
GROUP BY table_schema
ORDER BY size_gb DESC;

-- 3. Moteurs de stockage utilisÃ©s
SELECT '=== MOTEURS DE STOCKAGE ===' AS section;
SELECT 
    ENGINE,
    COUNT(*) as table_count,
    ROUND(SUM(DATA_LENGTH + INDEX_LENGTH) / 1024 / 1024, 2) as total_mb
FROM information_schema.TABLES
WHERE TABLE_SCHEMA NOT IN ('mysql', 'information_schema', 'performance_schema', 'sys')
GROUP BY ENGINE;

-- 4. Tables MyISAM (recommandÃ©: convertir en InnoDB)
SELECT '=== TABLES MYISAM (Ã  convertir) ===' AS section;
SELECT 
    TABLE_SCHEMA,
    TABLE_NAME,
    TABLE_ROWS,
    ROUND((DATA_LENGTH + INDEX_LENGTH) / 1024 / 1024, 2) AS size_mb
FROM information_schema.TABLES
WHERE ENGINE = 'MyISAM'
  AND TABLE_SCHEMA NOT IN ('mysql', 'information_schema', 'performance_schema', 'sys');

-- 5. System-Versioned Tables (ğŸ†• important pour 11.8)
SELECT '=== SYSTEM-VERSIONED TABLES ===' AS section;
SELECT 
    TABLE_SCHEMA,
    TABLE_NAME,
    TABLE_ROWS,
    CREATE_OPTIONS
FROM information_schema.TABLES
WHERE CREATE_OPTIONS LIKE '%versioning%';

-- 6. Formats de ligne potentiellement problÃ©matiques
SELECT '=== FORMATS DE LIGNE ===' AS section;
SELECT 
    ROW_FORMAT,
    COUNT(*) as table_count
FROM information_schema.TABLES
WHERE TABLE_SCHEMA NOT IN ('mysql', 'information_schema', 'performance_schema', 'sys')
GROUP BY ROW_FORMAT;

-- 7. Collations utilisÃ©es
SELECT '=== COLLATIONS ===' AS section;
SELECT 
    CHARACTER_SET_NAME,
    COLLATION_NAME,
    COUNT(*) as column_count
FROM information_schema.COLUMNS
WHERE TABLE_SCHEMA NOT IN ('mysql', 'information_schema', 'performance_schema', 'sys')
  AND COLLATION_NAME IS NOT NULL
GROUP BY CHARACTER_SET_NAME, COLLATION_NAME
ORDER BY column_count DESC;

-- 8. ProcÃ©dures et fonctions
SELECT '=== ROUTINES ===' AS section;
SELECT 
    ROUTINE_SCHEMA,
    ROUTINE_TYPE,
    COUNT(*) as count
FROM information_schema.ROUTINES
WHERE ROUTINE_SCHEMA NOT IN ('mysql', 'sys')
GROUP BY ROUTINE_SCHEMA, ROUTINE_TYPE;

-- 9. Triggers
SELECT '=== TRIGGERS ===' AS section;
SELECT 
    TRIGGER_SCHEMA,
    COUNT(*) as trigger_count
FROM information_schema.TRIGGERS
WHERE TRIGGER_SCHEMA NOT IN ('sys')
GROUP BY TRIGGER_SCHEMA;

-- 10. Events
SELECT '=== EVENTS ===' AS section;
SELECT 
    EVENT_SCHEMA,
    EVENT_NAME,
    STATUS,
    LAST_EXECUTED
FROM information_schema.EVENTS;

-- 11. VÃ©rification des tables corrompues
SELECT '=== VÃ‰RIFICATION INTÃ‰GRITÃ‰ ===' AS section;
-- ExÃ©cuter sÃ©parÃ©ment : mysqlcheck --all-databases --check

-- 12. Variables de configuration importantes
SELECT '=== CONFIGURATION CRITIQUE ===' AS section;
SELECT 
    VARIABLE_NAME,
    VARIABLE_VALUE
FROM information_schema.GLOBAL_VARIABLES
WHERE VARIABLE_NAME IN (
    'innodb_file_per_table',
    'innodb_page_size',
    'innodb_log_file_size',
    'character_set_server',
    'collation_server',
    'sql_mode',
    'innodb_strict_mode',
    'lower_case_table_names'
);

-- 13. Utilisateurs et privilÃ¨ges
SELECT '=== UTILISATEURS ===' AS section;
SELECT 
    User,
    Host,
    plugin,
    password_expired
FROM mysql.user
WHERE User NOT IN ('root', 'mysql.sys', 'mariadb.sys');

-- 14. RÃ©plication (si applicable)
SELECT '=== RÃ‰PLICATION ===' AS section;
SHOW SLAVE STATUS\G
SHOW MASTER STATUS\G
```

### Script de tests de compatibilitÃ©

```bash
#!/bin/bash
# compatibility_tests.sh

set -e

TARGET_VERSION=$1
LOG_FILE="/var/log/mariadb-compat-test.log"

echo "=== Tests de compatibilitÃ© pour upgrade vers $TARGET_VERSION ===" | tee $LOG_FILE

# Test 1 : VÃ©rifier la documentation des changements
echo "[Test 1] Changements incompatibles documentÃ©s" | tee -a $LOG_FILE
echo "Consultez: https://mariadb.com/kb/en/upgrading-from-mariadb-10x-to-mariadb-11y/" | tee -a $LOG_FILE

# Test 2 : Variables dÃ©prÃ©ciÃ©es
echo "[Test 2] Variables dÃ©prÃ©ciÃ©es" | tee -a $LOG_FILE
DEPRECATED_VARS="query_cache_size query_cache_type innodb_large_prefix innodb_file_format"
for VAR in $DEPRECATED_VARS; do
    VALUE=$(mariadb -BNe "SELECT @@$VAR" 2>/dev/null || echo "NOT_FOUND")
    if [ "$VALUE" != "NOT_FOUND" ]; then
        echo "  âš  $VAR = $VALUE (peut Ãªtre dÃ©prÃ©ciÃ©)" | tee -a $LOG_FILE
    fi
done

# Test 3 : sql_mode
echo "[Test 3] sql_mode" | tee -a $LOG_FILE
SQL_MODE=$(mariadb -BNe "SELECT @@sql_mode")
echo "  sql_mode actuel: $SQL_MODE" | tee -a $LOG_FILE
# VÃ©rifier les modes potentiellement problÃ©matiques
if [[ $SQL_MODE == *"NO_AUTO_CREATE_USER"* ]]; then
    echo "  âš  NO_AUTO_CREATE_USER est dÃ©prÃ©ciÃ©" | tee -a $LOG_FILE
fi

# Test 4 : Tables avec ancien format
echo "[Test 4] Format des tables InnoDB" | tee -a $LOG_FILE
mariadb -BNe "
    SELECT TABLE_SCHEMA, TABLE_NAME, ROW_FORMAT
    FROM information_schema.TABLES
    WHERE ENGINE = 'InnoDB'
      AND ROW_FORMAT IN ('Compact', 'Redundant')
      AND TABLE_SCHEMA NOT IN ('mysql', 'information_schema', 'performance_schema', 'sys')
" | while read SCHEMA TABLE FORMAT; do
    echo "  Table $SCHEMA.$TABLE utilise format $FORMAT (ancien)" | tee -a $LOG_FILE
done

# Test 5 : RequÃªtes avec syntaxe dÃ©prÃ©ciÃ©e
echo "[Test 5] Syntaxe SQL potentiellement problÃ©matique" | tee -a $LOG_FILE
# VÃ©rifier les procÃ©dures stockÃ©es pour syntaxe dÃ©prÃ©ciÃ©e
mariadb -BNe "
    SELECT ROUTINE_SCHEMA, ROUTINE_NAME, ROUTINE_TYPE
    FROM information_schema.ROUTINES
    WHERE ROUTINE_DEFINITION LIKE '%PASSWORD(%'
       OR ROUTINE_DEFINITION LIKE '%ENCODE(%'
       OR ROUTINE_DEFINITION LIKE '%DECODE(%'
" | while read SCHEMA NAME TYPE; do
    echo "  âš  $TYPE $SCHEMA.$NAME utilise fonctions dÃ©prÃ©ciÃ©es" | tee -a $LOG_FILE
done

# Test 6 : Plugins
echo "[Test 6] Plugins chargÃ©s" | tee -a $LOG_FILE
mariadb -e "SHOW PLUGINS" | grep -v "ACTIVE" | while read line; do
    echo "  âš  Plugin inactif: $line" | tee -a $LOG_FILE
done

# Test 7 : Espace disque
echo "[Test 7] Espace disque" | tee -a $LOG_FILE
DATADIR=$(mariadb -BNe "SELECT @@datadir")
DATA_SIZE=$(du -s $DATADIR | awk '{print $1}')
DISK_FREE=$(df $DATADIR | tail -1 | awk '{print $4}')
echo "  DonnÃ©es: $((DATA_SIZE/1024/1024)) GB" | tee -a $LOG_FILE
echo "  Espace libre: $((DISK_FREE/1024/1024)) GB" | tee -a $LOG_FILE
if [ $DISK_FREE -lt $((DATA_SIZE * 2)) ]; then
    echo "  âš  ATTENTION: Espace insuffisant pour backup sÃ©curisÃ©" | tee -a $LOG_FILE
fi

# Test 8 : Transactions longues
echo "[Test 8] Transactions actives" | tee -a $LOG_FILE
LONG_TRX=$(mariadb -BNe "
    SELECT COUNT(*) FROM information_schema.INNODB_TRX
    WHERE TIME_TO_SEC(TIMEDIFF(NOW(), trx_started)) > 300
")
if [ "$LONG_TRX" -gt 0 ]; then
    echo "  âš  $LONG_TRX transactions actives > 5 minutes" | tee -a $LOG_FILE
fi

# RÃ©sumÃ©
echo "" | tee -a $LOG_FILE
echo "=== RÃ©sumÃ© des tests ===" | tee -a $LOG_FILE
WARNINGS=$(grep -c "âš " $LOG_FILE || true)
echo "Avertissements: $WARNINGS" | tee -a $LOG_FILE

if [ $WARNINGS -eq 0 ]; then
    echo "âœ“ Tous les tests passÃ©s" | tee -a $LOG_FILE
else
    echo "âš  Revoyez les avertissements avant l'upgrade" | tee -a $LOG_FILE
fi
```

---

## Monitoring post-upgrade

### Dashboard de surveillance

```sql
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--              MONITORING POST-UPGRADE
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Ã€ exÃ©cuter rÃ©guliÃ¨rement pendant 24-48h aprÃ¨s upgrade

-- 1. SantÃ© gÃ©nÃ©rale
SELECT 
    'Uptime' AS metric,
    VARIABLE_VALUE AS value
FROM information_schema.GLOBAL_STATUS
WHERE VARIABLE_NAME = 'UPTIME'
UNION ALL
SELECT 'Questions', VARIABLE_VALUE
FROM information_schema.GLOBAL_STATUS
WHERE VARIABLE_NAME = 'QUESTIONS'
UNION ALL
SELECT 'Slow queries', VARIABLE_VALUE
FROM information_schema.GLOBAL_STATUS
WHERE VARIABLE_NAME = 'SLOW_QUERIES'
UNION ALL
SELECT 'Threads connected', VARIABLE_VALUE
FROM information_schema.GLOBAL_STATUS
WHERE VARIABLE_NAME = 'THREADS_CONNECTED';

-- 2. Performance InnoDB
SELECT 
    VARIABLE_NAME,
    VARIABLE_VALUE
FROM information_schema.GLOBAL_STATUS
WHERE VARIABLE_NAME IN (
    'INNODB_BUFFER_POOL_READ_REQUESTS',
    'INNODB_BUFFER_POOL_READS',
    'INNODB_BUFFER_POOL_HIT_RATE',
    'INNODB_ROWS_READ',
    'INNODB_ROWS_INSERTED',
    'INNODB_ROWS_UPDATED',
    'INNODB_ROWS_DELETED',
    'INNODB_DEADLOCKS'
);

-- 3. Erreurs et warnings
SELECT 
    VARIABLE_NAME,
    VARIABLE_VALUE
FROM information_schema.GLOBAL_STATUS
WHERE VARIABLE_NAME LIKE '%ERROR%'
   OR VARIABLE_NAME LIKE '%WARNING%'
   AND VARIABLE_VALUE > 0;

-- 4. RequÃªtes lentes rÃ©centes (si slow query log activÃ©)
-- SELECT * FROM mysql.slow_log ORDER BY start_time DESC LIMIT 10;

-- 5. Connexions refusÃ©es
SELECT VARIABLE_VALUE AS connections_refused
FROM information_schema.GLOBAL_STATUS
WHERE VARIABLE_NAME = 'ABORTED_CONNECTS';
```

### Script de monitoring automatisÃ©

```bash
#!/bin/bash
# post_upgrade_monitor.sh

DURATION_HOURS=48
INTERVAL_MINUTES=5
LOG_FILE="/var/log/post-upgrade-monitor.log"

END_TIME=$(date -d "+${DURATION_HOURS} hours" +%s)

echo "=== Monitoring post-upgrade (${DURATION_HOURS}h) ===" | tee $LOG_FILE
echo "DÃ©but: $(date)" | tee -a $LOG_FILE

while [ $(date +%s) -lt $END_TIME ]; do
    echo "" >> $LOG_FILE
    echo "=== $(date) ===" >> $LOG_FILE
    
    # MÃ©triques clÃ©s
    mariadb -BNe "
        SELECT 
            'QPS', ROUND(VARIABLE_VALUE / 
                (SELECT VARIABLE_VALUE FROM information_schema.GLOBAL_STATUS 
                 WHERE VARIABLE_NAME = 'UPTIME'), 2)
        FROM information_schema.GLOBAL_STATUS
        WHERE VARIABLE_NAME = 'QUESTIONS'
        UNION ALL
        SELECT 'Threads', VARIABLE_VALUE
        FROM information_schema.GLOBAL_STATUS
        WHERE VARIABLE_NAME = 'THREADS_CONNECTED'
        UNION ALL
        SELECT 'Slow', VARIABLE_VALUE
        FROM information_schema.GLOBAL_STATUS
        WHERE VARIABLE_NAME = 'SLOW_QUERIES'
    " >> $LOG_FILE
    
    # VÃ©rifier erreurs rÃ©centes
    ERRORS=$(tail -100 /var/log/mysql/error.log | grep -c "ERROR" || true)
    echo "Erreurs log (100 derniÃ¨res lignes): $ERRORS" >> $LOG_FILE
    
    # Alerte si problÃ¨me
    if [ $ERRORS -gt 10 ]; then
        echo "ALERTE: Trop d'erreurs dÃ©tectÃ©es!" | tee -a $LOG_FILE
        # Envoyer notification
        # mail -s "MariaDB upgrade - Erreurs dÃ©tectÃ©es" admin@example.com < $LOG_FILE
    fi
    
    sleep $((INTERVAL_MINUTES * 60))
done

echo "" | tee -a $LOG_FILE
echo "=== Fin monitoring: $(date) ===" | tee -a $LOG_FILE
```

---

## âœ… Points clÃ©s Ã  retenir

- **mariadb-upgrade obligatoire** : Toujours exÃ©cuter aprÃ¨s une mise Ã  jour mineure ou majeure, jamais pour un downgrade

- **innodb_fast_shutdown = 0** : Utiliser avant l'arrÃªt pour un shutdown propre qui facilite l'upgrade

- **Backup avant tout** : Toujours avoir un backup physique ET logique avant une mise Ã  jour majeure

- **ğŸ†• System-Versioned Tables 11.8** : Le format des timestamps change, utiliser `ALTER TABLE ... FORCE` pour convertir

- **Zero-downtime possible** : Avec Blue-Green, Galera rolling upgrade, ou rÃ©plication master-slave

- **Tests de compatibilitÃ©** : VÃ©rifier sql_mode, variables dÃ©prÃ©ciÃ©es, et format des tables avant upgrade

- **Monitoring 24-48h** : Surveillance intensive aprÃ¨s l'upgrade pour dÃ©tecter les rÃ©gressions

- **Plan de rollback** : Toujours documenter et tester la procÃ©dure de rollback avant de commencer

---

## ğŸ”— Ressources et rÃ©fÃ©rences

- [ğŸ“– mariadb-upgrade Documentation](https://mariadb.com/kb/en/mariadb-upgrade/)
- [ğŸ“– Upgrading MariaDB](https://mariadb.com/kb/en/upgrading/)
- [ğŸ“– Upgrading Between Major MariaDB Versions](https://mariadb.com/kb/en/upgrading-between-major-mariadb-versions/)
- [ğŸ“– System-Versioned Tables](https://mariadb.com/kb/en/system-versioned-tables/)
- [ğŸ“– Galera Cluster Rolling Upgrade](https://mariadb.com/kb/en/upgrading-galera-cluster/)
- [ğŸ“– MariaDB Release Notes](https://mariadb.com/kb/en/release-notes/)

---


â­ï¸ [Upgrade in-place vs logical](/19-migration-compatibilite/04.2-upgrade-inplace-logical.md)
