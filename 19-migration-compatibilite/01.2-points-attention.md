üîù Retour au [Sommaire](/SOMMAIRE.md)

# 19.1.2 Points d'attention et diff√©rences

> **Niveau** : Avanc√© √† Expert  
> **Dur√©e estim√©e** : 5-6 heures  
> **Pr√©requis** : Section 19.1.1 (Compatibilit√© MySQL/MariaDB), exp√©rience en administration MySQL/MariaDB, connaissance des internals InnoDB

## üéØ Objectifs d'apprentissage

√Ä l'issue de cette section, vous serez capable de :
- Identifier les diff√©rences subtiles de comportement SQL entre MySQL et MariaDB
- Anticiper les pi√®ges li√©s aux valeurs par d√©faut et modes SQL divergents
- Comprendre les implications des diff√©rences au niveau des moteurs de stockage
- Diagnostiquer et r√©soudre les probl√®mes post-migration courants
- Mettre en place des strat√©gies de test cibl√©es pour les points de divergence critiques

---

## Introduction

La section pr√©c√©dente a √©tabli le cadre g√©n√©ral de compatibilit√© MySQL/MariaDB. Cette section approfondit les **diff√©rences subtiles** qui peuvent provoquer des comportements inattendus apr√®s migration. Ces divergences, souvent non document√©es ou sous-estim√©es, sont responsables de la majorit√© des incidents post-migration.

Un DBA exp√©riment√© sait que la compatibilit√© "√† 95%" signifie que les 5% restants concentrent 80% des probl√®mes. Cette section catalogue ces points critiques par domaine, avec des exemples concrets et des strat√©gies de d√©tection.

---

## Diff√©rences de comportement SQL

### Gestion des valeurs NULL

MySQL et MariaDB g√®rent les NULL de mani√®re identique dans la plupart des cas, mais certaines fonctions pr√©sentent des diff√©rences subtiles :

```sql
-- Comportement identique : comparaisons NULL
SELECT NULL = NULL;      -- NULL (les deux)
SELECT NULL <=> NULL;    -- 1 (les deux)
SELECT NULL IS NULL;     -- 1 (les deux)

-- Diff√©rence subtile : IFNULL vs COALESCE avec types mixtes
-- MySQL 8.0
SELECT IFNULL(NULL, 1) + IFNULL(NULL, 1.5);  
-- R√©sultat : 2.5 (DECIMAL)

-- MariaDB 11.8
SELECT IFNULL(NULL, 1) + IFNULL(NULL, 1.5);  
-- R√©sultat : 2.5 (DECIMAL) - Identique

-- Mais attention aux UNION avec NULL
-- MySQL 8.0 : Type d√©termin√© par la premi√®re colonne non-NULL
-- MariaDB : Type d√©termin√© de mani√®re plus conservative

SELECT NULL AS col
UNION
SELECT 'text';
-- MySQL 8.0 : col est VARCHAR(4)
-- MariaDB : col peut √™tre VARCHAR(4) ou TEXT selon le contexte
```

üí° **Conseil** : Toujours expliciter les types dans les UNION contenant des NULL pour garantir un comportement pr√©visible.

### Comportement AUTO_INCREMENT

```sql
-- Diff√©rence majeure : AUTO_INCREMENT apr√®s DELETE

CREATE TABLE test_ai (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(50)
);

INSERT INTO test_ai (name) VALUES ('a'), ('b'), ('c');
-- id = 1, 2, 3

DELETE FROM test_ai WHERE id = 3;

-- Apr√®s red√©marrage du serveur :

-- MySQL 8.0+ (InnoDB) : 
-- Le prochain INSERT obtient id = 4 (persist√© dans le dictionnaire)

-- MariaDB (toutes versions) :
-- Le prochain INSERT obtient id = 4 (persist√© depuis 10.2.4)
-- MAIS comportement historique diff√©rent sur versions anciennes

-- Point critique : TRUNCATE vs DELETE
TRUNCATE TABLE test_ai;
INSERT INTO test_ai (name) VALUES ('new');
-- Les deux : id = 1 (reset complet)

-- DELETE sans WHERE
DELETE FROM test_ai;
INSERT INTO test_ai (name) VALUES ('new');
-- MySQL 8.0+ : id = 4 (compteur pr√©serv√© apr√®s restart)
-- MariaDB : id = 4 (comportement identique depuis 10.2.4)
```

‚ö†Ô∏è **Attention** : Sur d'anciennes versions MariaDB (< 10.2.4), le compteur AUTO_INCREMENT √©tait recalcul√© au red√©marrage comme `MAX(id) + 1`, ce qui pouvait causer des r√©utilisations d'ID apr√®s DELETE.

### Expressions r√©guli√®res (REGEXP)

MariaDB 10.0.5+ utilise la biblioth√®que PCRE (Perl Compatible Regular Expressions), tandis que MySQL 8.0+ utilise ICU :

```sql
-- Syntaxe de base : compatible
SELECT 'hello' REGEXP '^h';  -- 1 (les deux)

-- Diff√©rences de syntaxe avanc√©e

-- Lookahead (MySQL 8.0 avec ICU)
SELECT 'foobar' REGEXP 'foo(?=bar)';
-- MySQL 8.0 : 1
-- MariaDB (PCRE) : 1 (support√© aussi)

-- Classes de caract√®res Unicode
SELECT 'Œ©' REGEXP '\\p{Greek}';
-- MySQL 8.0 : 1 (ICU supporte Unicode properties)
-- MariaDB : Erreur ou 0 (PCRE standard ne supporte pas \p{Greek})

-- Alternative MariaDB pour Unicode
SELECT 'Œ©' REGEXP '[Œë-Œ©Œ±-œâ]';  -- Plage explicite

-- Fonctions REGEXP √©tendues
-- MySQL 8.0
SELECT REGEXP_REPLACE('abc123def', '[0-9]+', 'X');
-- R√©sultat : 'abcXdef'

-- MariaDB 10.0.5+
SELECT REGEXP_REPLACE('abc123def', '[0-9]+', 'X');
-- R√©sultat : 'abcXdef' (syntaxe identique, m√™me r√©sultat)

-- Diff√©rence : flags inline
-- MySQL 8.0
SELECT REGEXP_LIKE('Hello', 'hello', 'i');  -- 1 (case insensitive)

-- MariaDB
SELECT 'Hello' REGEXP '(?i)hello';  -- 1 (flag inline PCRE)
-- OU
SELECT 'Hello' RLIKE 'hello';  -- D√©pend de la collation
```

### Fonctions de date et heure

```sql
-- CURRENT_TIMESTAMP pr√©cision

-- MySQL 8.0 : pr√©cision par d√©faut = 0
SELECT CURRENT_TIMESTAMP;  -- '2025-12-15 10:30:00'

-- MariaDB 11.8 : pr√©cision par d√©faut = 0 aussi, mais...
SELECT CURRENT_TIMESTAMP(6);  -- '2025-12-15 10:30:00.123456'

-- Diff√©rence critique : TIMESTAMP vs DATETIME storage

-- MySQL 8.0
CREATE TABLE t1 (
    ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
-- Range : '1970-01-01 00:00:01' UTC to '2038-01-19 03:14:07' UTC

-- MariaDB 11.8 üÜï
CREATE TABLE t1 (
    ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
-- Range √©tendu : '1970-01-01 00:00:01' UTC to '2106-02-07 06:28:15' UTC
-- R√©solution du probl√®me Y2038 !
```

üÜï **Nouveaut√© MariaDB 11.8** : Extension de la plage TIMESTAMP jusqu'en 2106, r√©solvant le probl√®me Y2038 sans modification de sch√©ma.

```sql
-- Fonction UNIX_TIMESTAMP comportement

-- Valeur maximale
SELECT UNIX_TIMESTAMP('2040-01-01 00:00:00');
-- MySQL 8.0 : 0 (d√©passement)
-- MariaDB 11.8 : 2208988800 (support√©) üÜï

-- STR_TO_DATE avec formats ambigus
SELECT STR_TO_DATE('01/02/03', '%d/%m/%y');
-- MySQL 8.0 : '2003-02-01'
-- MariaDB : '2003-02-01' (identique)

-- Mais attention au format %y (ann√©e 2 chiffres)
SELECT STR_TO_DATE('01/02/69', '%d/%m/%y');
-- Les deux : '2069-02-01' (seuil √† 69/70 pour si√®cle)

-- DATE_FORMAT : diff√©rences mineures sur %W, %M avec locales
SET lc_time_names = 'fr_FR';
SELECT DATE_FORMAT(NOW(), '%W %d %M %Y');
-- R√©sultats identiques si locale install√©e
```

### Op√©rateurs de comparaison et casting

```sql
-- Comparaison string/number : comportement historiquement diff√©rent

SELECT '10' > '9';    -- 0 (comparaison string : '1' < '9')
SELECT '10' > 9;      -- 1 (cast implicite en number)
SELECT 10 > '9';      -- 1 (cast implicite)

-- Cas probl√©matique : colonnes VARCHAR avec valeurs num√©riques
CREATE TABLE products (
    code VARCHAR(20),
    INDEX idx_code (code)
);

INSERT INTO products VALUES ('1'), ('2'), ('10'), ('20'), ('100');

SELECT * FROM products WHERE code > '9';
-- R√©sultat : '10', '20', '100' ? Non !
-- R√©sultat : vide ou seulement les codes commen√ßant par caract√®re > '9'

-- Les deux SGBD ont le m√™me comportement, mais c'est un pi√®ge fr√©quent

-- Diff√©rence MySQL 8.0 vs MariaDB : casting explicite
SELECT CAST('123abc' AS SIGNED);
-- MySQL 8.0 : 123 (warning)
-- MariaDB : 123 (warning identique)

SELECT CAST('abc123' AS SIGNED);
-- MySQL 8.0 : 0 (warning)
-- MariaDB : 0 (warning identique)

-- Casting vers UUID (MariaDB sp√©cifique)
SELECT UUID();  -- Les deux : g√©n√®rent un UUID
-- MariaDB a un type UUID natif
-- MySQL stocke en BINARY(16) ou VARCHAR(36)
```

---

## Diff√©rences de configuration

### Variables syst√®me critiques

```ini
# Comparaison des valeurs par d√©faut critiques

# === MySQL 8.0 defaults ===
# character_set_server = utf8mb4
# collation_server = utf8mb4_0900_ai_ci
# default_authentication_plugin = caching_sha2_password
# sql_mode = STRICT_TRANS_TABLES,NO_ENGINE_SUBSTITUTION,...
# innodb_redo_log_capacity = 104857600 (100MB, nouvelle variable 8.0.30+)

# === MariaDB 11.8 defaults === üÜï
# character_set_server = utf8mb4
# collation_server = utf8mb4_uca1400_ai_ci  
# (pas de default_authentication_plugin, g√©r√© diff√©remment)
# sql_mode = STRICT_TRANS_TABLES,ERROR_FOR_DIVISION_BY_ZERO,...
# innodb_log_file_size = 100663296 (96MB, variable classique)
```

### Modes SQL : diff√©rences importantes

```sql
-- V√©rifier le sql_mode actuel
SELECT @@sql_mode;

-- Modes communs avec comportement identique
-- STRICT_TRANS_TABLES : Erreur si valeur invalide dans transaction
-- NO_ENGINE_SUBSTITUTION : Erreur si moteur demand√© indisponible
-- ONLY_FULL_GROUP_BY : GROUP BY strict

-- Modes avec diff√©rences subtiles ou exclusifs

-- MySQL 8.0 uniquement
-- TIME_TRUNCATE_FRACTIONAL : Tronque les microsecondes (pas d'arrondi)

-- MariaDB uniquement  
-- EMPTY_STRING_IS_NULL : '' trait√© comme NULL (pour Oracle compat)
-- SIMULTANEOUS_ASSIGNMENT : √âvaluation simultan√©e dans UPDATE

-- Exemple SIMULTANEOUS_ASSIGNMENT (MariaDB)
SET sql_mode = 'SIMULTANEOUS_ASSIGNMENT';
UPDATE t SET a = b, b = a;  -- Swap sans variable temporaire !

-- Sans ce mode (comportement MySQL standard)
UPDATE t SET a = b, b = a;  -- a et b ont la m√™me valeur √† la fin
```

```sql
-- Script de v√©rification sql_mode post-migration
DELIMITER //
CREATE PROCEDURE check_sql_mode_compatibility()
BEGIN
    DECLARE current_mode VARCHAR(500);
    SELECT @@sql_mode INTO current_mode;
    
    -- V√©rifications critiques
    IF FIND_IN_SET('STRICT_TRANS_TABLES', current_mode) = 0 THEN
        SELECT 'WARNING: STRICT_TRANS_TABLES disabled - data truncation silencieuse possible' AS alert;
    END IF;
    
    IF FIND_IN_SET('ONLY_FULL_GROUP_BY', current_mode) = 0 THEN
        SELECT 'WARNING: ONLY_FULL_GROUP_BY disabled - GROUP BY non d√©terministe possible' AS alert;
    END IF;
    
    IF FIND_IN_SET('NO_ZERO_DATE', current_mode) = 0 THEN
        SELECT 'INFO: NO_ZERO_DATE disabled - dates 0000-00-00 autoris√©es' AS alert;
    END IF;
    
    SELECT current_mode AS 'Current SQL Mode';
END //
DELIMITER ;
```

### Variables InnoDB divergentes

```sql
-- Variables avec noms diff√©rents ou comportement modifi√©

-- Redo log configuration
-- MySQL 8.0.30+
SHOW VARIABLES LIKE 'innodb_redo_log_capacity';
-- Nouvelle variable unifi√©e (remplace innodb_log_file_size * innodb_log_files_in_group)

-- MariaDB 11.8
SHOW VARIABLES LIKE 'innodb_log_file_size';
SHOW VARIABLES LIKE 'innodb_log_files_in_group';
-- Variables classiques maintenues

-- Buffer pool
-- Identique sur les deux
SHOW VARIABLES LIKE 'innodb_buffer_pool_size';
SHOW VARIABLES LIKE 'innodb_buffer_pool_instances';

-- Flush method
SHOW VARIABLES LIKE 'innodb_flush_method';
-- MySQL 8.0 Linux default : fsync (mais O_DIRECT recommand√©)
-- MariaDB default : fsync (O_DIRECT recommand√© aussi)

-- Undo tablespaces
-- MySQL 8.0 : innodb_undo_tablespaces (d√©faut 2, min 2)
-- MariaDB : innodb_undo_tablespaces (d√©faut 0 = dans system tablespace)
```

```ini
# Configuration InnoDB √©quivalente MySQL 8.0 / MariaDB 11.8

# === MySQL 8.0 my.cnf ===
[mysqld]
innodb_buffer_pool_size = 8G
innodb_redo_log_capacity = 2G
innodb_flush_method = O_DIRECT
innodb_io_capacity = 2000
innodb_io_capacity_max = 4000

# === MariaDB 11.8 my.cnf ===
[mysqld]
innodb_buffer_pool_size = 8G
innodb_log_file_size = 1G
innodb_log_files_in_group = 2
innodb_flush_method = O_DIRECT
innodb_io_capacity = 2000
innodb_io_capacity_max = 4000
```

---

## Diff√©rences au niveau des index

### Index invisibles vs ignor√©s

```sql
-- MySQL 8.0 : Invisible Indexes
ALTER TABLE orders ALTER INDEX idx_date INVISIBLE;
-- L'index existe mais l'optimiseur l'ignore
-- Utile pour tester l'impact avant suppression

-- MariaDB 10.6+ : Ignored Indexes (syntaxe diff√©rente)
ALTER TABLE orders ALTER INDEX idx_date IGNORED;
-- Fonctionnalit√© √©quivalente, mot-cl√© diff√©rent

-- V√©rification
-- MySQL 8.0
SELECT INDEX_NAME, IS_VISIBLE 
FROM INFORMATION_SCHEMA.STATISTICS 
WHERE TABLE_NAME = 'orders';

-- MariaDB
SELECT INDEX_NAME, IGNORED
FROM INFORMATION_SCHEMA.STATISTICS
WHERE TABLE_NAME = 'orders';
```

### Index descendants (DESC)

```sql
-- MySQL 8.0 : Support natif des index descendants
CREATE TABLE events (
    id BIGINT PRIMARY KEY,
    created_at DATETIME,
    INDEX idx_created_desc (created_at DESC)
);

-- L'index stocke physiquement les donn√©es en ordre descendant
-- Optimal pour : SELECT ... ORDER BY created_at DESC

-- MariaDB 11.8 : DESC accept√© mais ignor√© (stockage ASC)
CREATE TABLE events (
    id BIGINT PRIMARY KEY,
    created_at DATETIME,
    INDEX idx_created_desc (created_at DESC)  -- Syntaxe accept√©e
);

-- MariaDB stocke toujours en ASC, parcourt en sens inverse si n√©cessaire
-- Performance l√©g√®rement inf√©rieure pour les scans DESC massifs
```

üí° **Conseil** : Pour les requ√™tes ORDER BY ... DESC critiques sur MariaDB, envisagez une colonne calcul√©e invers√©e :

```sql
-- Workaround MariaDB pour index "DESC" performant
ALTER TABLE events 
ADD COLUMN created_at_inv BIGINT AS (0 - UNIX_TIMESTAMP(created_at)) STORED,
ADD INDEX idx_created_inv (created_at_inv);

-- Requ√™te optimis√©e
SELECT * FROM events ORDER BY created_at_inv LIMIT 100;
-- √âquivalent √† ORDER BY created_at DESC avec scan d'index forward
```

### Index fonctionnels

```sql
-- MySQL 8.0.13+ : Index fonctionnels natifs
CREATE TABLE users (
    id BIGINT PRIMARY KEY,
    email VARCHAR(255),
    INDEX idx_email_lower ((LOWER(email)))
);

SELECT * FROM users WHERE LOWER(email) = 'user@example.com';
-- Utilise l'index fonctionnel

-- MariaDB : Via colonnes virtuelles (toutes versions)
CREATE TABLE users (
    id BIGINT PRIMARY KEY,
    email VARCHAR(255),
    email_lower VARCHAR(255) AS (LOWER(email)) VIRTUAL,
    INDEX idx_email_lower (email_lower)
);

SELECT * FROM users WHERE email_lower = 'user@example.com';
-- M√™me r√©sultat, syntaxe l√©g√®rement diff√©rente
```

### üÜï Index VECTOR (MariaDB 11.8 exclusif)

```sql
-- Fonctionnalit√© exclusive MariaDB 11.8
CREATE TABLE documents (
    id BIGINT PRIMARY KEY,
    content TEXT,
    embedding VECTOR(768) NOT NULL,
    VECTOR INDEX idx_embedding (embedding) USING HNSW
);

-- Recherche de similarit√©
SELECT id, content, 
       VEC_DISTANCE_COSINE(embedding, VEC_FromText('[0.1, 0.2, ...]')) AS distance
FROM documents
ORDER BY distance
LIMIT 10;

-- Aucun √©quivalent natif MySQL
-- MySQL n√©cessite des solutions externes (Pinecone, Milvus, etc.)
```

---

## Diff√©rences au niveau des verrous

### Verrouillage des m√©tadonn√©es (MDL)

```sql
-- Les deux utilisent MDL, mais avec des diff√©rences de timeout

-- MySQL 8.0
SHOW VARIABLES LIKE 'lock_wait_timeout';  
-- D√©faut : 31536000 (1 an !)

-- MariaDB 11.8
SHOW VARIABLES LIKE 'lock_wait_timeout';
-- D√©faut : 86400 (1 jour)

-- Recommandation production : r√©duire significativement
SET GLOBAL lock_wait_timeout = 60;  -- 60 secondes
```

### Verrous intentionnels et gap locks

```sql
-- Gap locking dans REPEATABLE READ

-- Comportement identique sur les deux pour les gap locks basiques
BEGIN;
SELECT * FROM orders WHERE id BETWEEN 10 AND 20 FOR UPDATE;
-- Verrouille la plage, y compris les "gaps" pour √©viter phantom reads

-- Diff√©rence subtile : innodb_locks_unsafe_for_binlog
-- MySQL 8.0 : Variable supprim√©e (toujours safe)
-- MariaDB : Variable encore disponible (pour compatibilit√©)

-- Nouvelle option MariaDB pour r√©duire les gap locks
-- innodb_snapshot_isolation (MariaDB 10.6+)
-- Permet READ COMMITTED-like behavior sans gap locks dans certains cas
```

### Deadlock detection et logs

```sql
-- Visualisation des deadlocks

-- MySQL 8.0
SHOW ENGINE INNODB STATUS\G
-- Section "LATEST DETECTED DEADLOCK"

-- MariaDB 11.8 (identique)
SHOW ENGINE INNODB STATUS\G

-- Diff√©rence : logging automatique des deadlocks
-- MySQL 8.0
SET GLOBAL innodb_print_all_deadlocks = ON;
-- Log dans error log

-- MariaDB
SET GLOBAL innodb_print_all_deadlocks = ON;  -- Identique
-- Mais aussi disponible via : log_warnings = 4
```

---

## Diff√©rences dans les proc√©dures stock√©es

### Syntaxe et fonctionnalit√©s

```sql
-- D√©claration de handlers : comportement identique
DECLARE CONTINUE HANDLER FOR SQLEXCEPTION
BEGIN
    SET @error_occurred = 1;
END;

-- GET DIAGNOSTICS : support√© par les deux
GET DIAGNOSTICS CONDITION 1
    @errno = MYSQL_ERRNO,
    @msg = MESSAGE_TEXT;

-- SIGNAL/RESIGNAL : identique
SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'Custom error';

-- Diff√©rence : ORACLE mode (MariaDB exclusif)
SET sql_mode = 'ORACLE';

-- Permet syntaxe PL/SQL
CREATE PROCEDURE oracle_style AS
    v_count NUMBER;
BEGIN
    SELECT COUNT(*) INTO v_count FROM dual;
    DBMS_OUTPUT.PUT_LINE('Count: ' || v_count);
END;
/
-- Ce mode n'existe pas sur MySQL
```

### Curseurs et it√©ration

```sql
-- Curseurs : syntaxe identique
DECLARE cur CURSOR FOR SELECT id, name FROM users;
DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

OPEN cur;
read_loop: LOOP
    FETCH cur INTO v_id, v_name;
    IF done THEN
        LEAVE read_loop;
    END IF;
    -- traitement
END LOOP;
CLOSE cur;

-- FOR loop (MariaDB 10.3+ avec ORACLE mode ou natif en 10.6+)
-- MariaDB
FOR rec IN (SELECT id, name FROM users) DO
    -- rec.id, rec.name accessibles directement
    INSERT INTO audit_log (user_id) VALUES (rec.id);
END FOR;

-- MySQL 8.0 : Pas de FOR loop, utiliser curseur ou application
```

### Packages (MariaDB exclusif)

```sql
-- MariaDB supporte les packages Oracle-style

CREATE PACKAGE user_management AS
    FUNCTION get_full_name(p_id BIGINT) RETURNS VARCHAR(200);
    PROCEDURE update_status(p_id BIGINT, p_status VARCHAR(20));
END;

CREATE PACKAGE BODY user_management AS
    FUNCTION get_full_name(p_id BIGINT) RETURNS VARCHAR(200) AS
    BEGIN
        RETURN (SELECT CONCAT(first_name, ' ', last_name) 
                FROM users WHERE id = p_id);
    END;
    
    PROCEDURE update_status(p_id BIGINT, p_status VARCHAR(20)) AS
    BEGIN
        UPDATE users SET status = p_status WHERE id = p_id;
    END;
END;

-- Utilisation
SELECT user_management.get_full_name(42);
CALL user_management.update_status(42, 'active');

-- MySQL : Aucun √©quivalent, utiliser proc√©dures/fonctions individuelles
```

---

## Diff√©rences de r√©plication avanc√©es

### Format binlog et √©v√©nements

```sql
-- V√©rification du format binlog
SHOW VARIABLES LIKE 'binlog_format';
-- ROW recommand√© pour les deux

-- Diff√©rence : binlog_row_image
SHOW VARIABLES LIKE 'binlog_row_image';
-- FULL : Log toutes les colonnes (d√©faut)
-- MINIMAL : Log uniquement colonnes n√©cessaires
-- NOBLOB : Exclut BLOBs non modifi√©s

-- MariaDB supporte aussi
SET GLOBAL binlog_row_image = 'FULL,UPDATE_ONLY_CHANGED_COLUMNS';
-- Option hybride non disponible sur MySQL
```

### GTID : incompatibilit√© fondamentale

```sql
-- Format GTID radicalement diff√©rent

-- MySQL 8.0 GTID
-- Format : source_uuid:transaction_id
-- Exemple : 3E11FA47-71CA-11E1-9E33-C80AA9429562:1-100

SHOW VARIABLES LIKE 'gtid_mode';          -- ON/OFF
SHOW VARIABLES LIKE 'enforce_gtid_consistency';

-- MariaDB GTID  
-- Format : domain_id-server_id-sequence_number
-- Exemple : 0-1-100

SHOW VARIABLES LIKE 'gtid_domain_id';     -- Domaine de r√©plication
SHOW VARIABLES LIKE 'gtid_strict_mode';

-- Conversion impossible automatiquement !
-- Migration n√©cessite r√©plication par position binlog
```

```sql
-- Configuration r√©plication MySQL ‚Üí MariaDB (sans GTID)

-- Sur MySQL source
SHOW MASTER STATUS;
-- +------------------+----------+
-- | File             | Position |
-- +------------------+----------+
-- | mysql-bin.000042 | 154789   |
-- +------------------+----------+

-- Sur MariaDB replica
CHANGE MASTER TO
    MASTER_HOST = 'mysql-primary.example.com',
    MASTER_USER = 'repl_user',
    MASTER_PASSWORD = 'password',
    MASTER_LOG_FILE = 'mysql-bin.000042',
    MASTER_LOG_POS = 154789,
    MASTER_USE_GTID = NO;  -- Important !

START SLAVE;
```

### R√©plication parall√®le

```sql
-- MySQL 8.0 : slave_parallel_type
SET GLOBAL slave_parallel_type = 'LOGICAL_CLOCK';
SET GLOBAL slave_parallel_workers = 8;
-- Parall√©lise par timestamps logiques (writesets)

-- MariaDB 11.8 : slave_parallel_mode
SET GLOBAL slave_parallel_mode = 'optimistic';
SET GLOBAL slave_parallel_workers = 8;
-- Options : conservative, optimistic, aggressive, minimal

-- 'optimistic' permet plus de parall√©lisme mais risque de rollback
-- si conflit d√©tect√©

-- Variable additionnelle MariaDB
SET GLOBAL slave_domain_parallel_threads = 4;
-- Threads par domaine GTID (utile en multi-source)
```

üÜï **MariaDB 11.8** : Optimistic parallel replication am√©lior√©e pour les ALTER TABLE

```sql
-- Les ALTER TABLE sont maintenant r√©pliqu√©s de mani√®re optimiste
-- R√©duit significativement le lag de r√©plication lors des migrations de sch√©ma

-- V√©rification du mode
SHOW VARIABLES LIKE 'slave_parallel_mode';

-- Si lag observ√© pendant ALTER, v√©rifier
SHOW SLAVE STATUS\G
-- Parallel_Mode, Running_Transactional_Appliers
```

---

## Diff√©rences de s√©curit√©

### Plugins d'authentification

```sql
-- Inventaire des plugins disponibles

-- MySQL 8.0
SELECT PLUGIN_NAME, PLUGIN_STATUS 
FROM INFORMATION_SCHEMA.PLUGINS 
WHERE PLUGIN_TYPE = 'AUTHENTICATION';
/*
| caching_sha2_password | ACTIVE  |  -- D√©faut 8.0
| mysql_native_password | ACTIVE  |  -- D√©pr√©ci√© 8.0, retir√© 8.4
| sha256_password       | ACTIVE  |
*/

-- MariaDB 11.8
SELECT PLUGIN_NAME, PLUGIN_STATUS 
FROM INFORMATION_SCHEMA.PLUGINS 
WHERE PLUGIN_TYPE = 'AUTHENTICATION';
/*
| mysql_native_password | ACTIVE  |  -- Toujours support√©
| ed25519              | ACTIVE  |  -- Recommand√©
| gssapi               | ACTIVE  |  -- Kerberos
| pam                  | ACTIVE  |
| parsec               | ACTIVE  |  -- Nouveau 11.8 üÜï
*/
```

### Migration des utilisateurs

```sql
-- Script de migration utilisateurs MySQL 8.0 ‚Üí MariaDB 11.8

-- 1. Export des utilisateurs MySQL (avec pt-show-grants ou manuellement)
-- MySQL
SELECT CONCAT(
    'CREATE USER ''', User, '''@''', Host, ''' IDENTIFIED BY PASSWORD ''',
    authentication_string, ''';'
) AS create_statement
FROM mysql.user
WHERE User NOT IN ('mysql.sys', 'mysql.session', 'mysql.infoschema', 'root');

-- 2. Conversion des plugins d'authentification
-- Utilisateurs caching_sha2_password ‚Üí recr√©er avec ed25519

-- Sur MariaDB
CREATE USER 'app_user'@'%' 
    IDENTIFIED VIA ed25519 USING PASSWORD('nouveau_password');

-- OU conserver mysql_native_password
CREATE USER 'app_user'@'%' 
    IDENTIFIED VIA mysql_native_password USING PASSWORD('password');

-- 3. Migration des privil√®ges
-- SHOW GRANTS fonctionne identiquement
SHOW GRANTS FOR 'app_user'@'%';
-- Ex√©cuter les GRANT sur MariaDB
```

üÜï **MariaDB 11.8** : Plugin PARSEC pour authentification hardware-backed

```sql
-- Configuration PARSEC (Platform AbstRaction for SECurity)
-- Utilise TPM, HSM ou autres modules de s√©curit√© hardware

INSTALL PLUGIN parsec SONAME 'auth_parsec.so';

CREATE USER 'secure_user'@'%' 
    IDENTIFIED VIA parsec USING 'key_name_in_parsec';

-- L'authentification utilise les cl√©s stock√©es dans le HSM/TPM
-- Aucune √©quivalent direct MySQL
```

### Chiffrement TLS

```sql
-- MySQL 8.0 : SSL par d√©faut (g√©n√©r√© automatiquement)
SHOW VARIABLES LIKE '%ssl%';
-- ssl_ca, ssl_cert, ssl_key auto-g√©n√©r√©s au premier d√©marrage

-- MariaDB 11.8 üÜï : TLS obligatoire par d√©faut
SHOW VARIABLES LIKE 'require_secure_transport';
-- ON par d√©faut !

-- Pour autoriser connexions non-TLS (dev uniquement)
SET GLOBAL require_secure_transport = OFF;
-- Ou dans my.cnf
[mysqld]
require_secure_transport = OFF
```

```sql
-- V√©rification connexion TLS
-- MySQL
\s
-- SSL: Cipher in use is TLS_AES_256_GCM_SHA384

-- MariaDB (identique)
\s

-- Via SQL
SELECT * FROM performance_schema.session_status 
WHERE VARIABLE_NAME LIKE 'Ssl_cipher';
```

---

## Diff√©rences de performance

### Optimiseur de requ√™tes

```sql
-- Hints d'optimiseur

-- MySQL 8.0 : Optimizer hints modernes
SELECT /*+ INDEX(orders idx_customer) */ * 
FROM orders 
WHERE customer_id = 42;

SELECT /*+ NO_INDEX(orders idx_date) */ *
FROM orders 
WHERE created_at > '2025-01-01';

-- MariaDB 11.8 : Support partiel des hints + syntaxe propre
SELECT /*+ INDEX(orders idx_customer) */ * 
FROM orders 
WHERE customer_id = 42;
-- Support√© depuis MariaDB 10.3

-- Hints exclusifs MariaDB
SELECT * FROM orders 
USE INDEX (idx_customer) 
WHERE customer_id = 42;

SELECT * FROM orders 
FORCE INDEX (idx_date)
WHERE created_at > '2025-01-01';
```

üÜï **MariaDB 11.8** : Cost optimizer am√©lior√© pour SSD

```sql
-- Nouvelles variables pour ajuster les co√ªts I/O
SHOW VARIABLES LIKE 'optimizer_disk_read_ratio';
-- Ratio lecture disque vs m√©moire (ajust√© pour SSD)

-- Le cost model prend mieux en compte les performances SSD
-- Moins de biais vers les full table scans sur petites tables
```

### Histogrammes de statistiques

```sql
-- MySQL 8.0 : Histogrammes automatiques
ANALYZE TABLE orders UPDATE HISTOGRAM ON customer_id, status;

-- Visualisation
SELECT HISTOGRAM FROM INFORMATION_SCHEMA.COLUMN_STATISTICS 
WHERE TABLE_NAME = 'orders' AND COLUMN_NAME = 'status';

-- MariaDB 11.8 : Statistiques persistantes (diff√©rente approche)
ANALYZE TABLE orders PERSISTENT FOR COLUMNS (customer_id, status) INDEXES ();

-- Visualisation
SELECT * FROM mysql.column_stats 
WHERE table_name = 'orders';

-- MariaDB utilise des statistiques d'histogramme diff√©rentes (height-balanced)
-- MySQL utilise singleton + equi-height hybrid
```

### Thread pool

```sql
-- MySQL 8.0 Enterprise : Thread Pool (payant)
-- Variables : thread_pool_size, thread_pool_algorithm

-- MariaDB Community : Thread Pool (inclus gratuitement !)
SHOW VARIABLES LIKE 'thread_pool%';
/*
| thread_pool_size        | 4    |  -- Groupes de threads
| thread_pool_max_threads | 65536 |
| thread_pool_idle_timeout | 60   |
| thread_pool_oversubscribe | 3   |
*/

-- Configuration recommand√©e production
[mysqld]
thread_handling = pool-of-threads
thread_pool_size = 16  -- Typiquement = nombre de CPUs
thread_pool_max_threads = 1000
```

---

## Points d'attention sp√©cifiques aux applications

### Frameworks et ORM

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              COMPATIBILIT√â ORM MySQL ‚Üí MariaDB                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Framework       ‚îÇ Compatibilit√© ‚îÇ Points d'attention              ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Hibernate       ‚îÇ ‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ         ‚îÇ Dialect MySQL fonctionne,       ‚îÇ
‚îÇ  (Java)          ‚îÇ               ‚îÇ utiliser MariaDBDialect pour    ‚îÇ
‚îÇ                  ‚îÇ               ‚îÇ features sp√©cifiques            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  SQLAlchemy      ‚îÇ ‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ         ‚îÇ Driver mysql-connector ou       ‚îÇ
‚îÇ  (Python)        ‚îÇ               ‚îÇ mariadb, dialect 'mariadb'      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Entity Framework‚îÇ ‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ         ‚îÇ Pomelo.EntityFrameworkCore      ‚îÇ
‚îÇ  (.NET)          ‚îÇ               ‚îÇ .MySql supporte MariaDB         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Prisma          ‚îÇ ‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ         ‚îÇ Provider 'mysql', certaines     ‚îÇ
‚îÇ  (Node.js)       ‚îÇ               ‚îÇ features MariaDB non support√©es ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Laravel/Eloquent‚îÇ ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ         ‚îÇ Excellente compatibilit√©,       ‚îÇ
‚îÇ  (PHP)           ‚îÇ               ‚îÇ driver 'mariadb' natif          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Django          ‚îÇ ‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ         ‚îÇ Backend mysqlclient,            ‚îÇ
‚îÇ  (Python)        ‚îÇ               ‚îÇ full support MariaDB            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

```python
# Exemple SQLAlchemy : configuration explicite MariaDB
from sqlalchemy import create_engine

# Connexion MySQL (fonctionne avec MariaDB)
engine_compat = create_engine(
    "mysql+pymysql://user:pass@host/db"
)

# Connexion MariaDB native (recommand√©)
engine_mariadb = create_engine(
    "mariadb+mariadbconnector://user:pass@host/db"
)

# Avec le connecteur MariaDB natif, vous avez acc√®s √† :
# - Meilleure gestion des reconnexions
# - Support VECTOR (11.8)
# - Performances optimis√©es
```

```java
// Exemple Hibernate : Dialect MariaDB

// persistence.xml ou application.properties
// MySQL g√©n√©rique (fonctionne)
hibernate.dialect = org.hibernate.dialect.MySQLDialect

// MariaDB sp√©cifique (recommand√©)
hibernate.dialect = org.hibernate.dialect.MariaDBDialect

// Pour MariaDB 10.3+ avec features avanc√©es
hibernate.dialect = org.hibernate.dialect.MariaDB103Dialect
```

### Gestion des connexions

```sql
-- Diff√©rences timeout connexions

-- MySQL 8.0
SHOW VARIABLES LIKE 'wait_timeout';     -- 28800 (8h)
SHOW VARIABLES LIKE 'interactive_timeout'; -- 28800

-- MariaDB 11.8
SHOW VARIABLES LIKE 'wait_timeout';     -- 28800 (identique)
SHOW VARIABLES LIKE 'interactive_timeout'; -- 28800

-- Variable importante pour les applications modernes
SHOW VARIABLES LIKE 'max_connections';
-- MySQL d√©faut : 151
-- MariaDB d√©faut : 151

-- Recommandation : ajuster selon thread_pool
-- Avec thread_pool, max_connections peut √™tre plus √©lev√©
[mysqld]
max_connections = 1000
thread_handling = pool-of-threads
```

### Prepared statements et caching

```sql
-- MySQL 8.0 : Prepared statement caching
SHOW VARIABLES LIKE 'max_prepared_stmt_count';  -- 16382

-- MariaDB 11.8 : Variable identique
SHOW VARIABLES LIKE 'max_prepared_stmt_count';  -- 16382

-- Comportement important : prepared statements et query cache
-- Le Query Cache est d√©pr√©ci√©/supprim√© sur les deux
-- MySQL 8.0 : Query Cache supprim√© compl√®tement
-- MariaDB : Query Cache encore disponible mais d√©conseill√©

SHOW VARIABLES LIKE 'query_cache_type';
-- MySQL 8.0 : Variable inexistante
-- MariaDB : 'OFF' par d√©faut (peut √™tre activ√©, non recommand√©)
```

---

## Sc√©narios de probl√®mes r√©els et solutions

### Sc√©nario 1 : Changement de comportement GROUP BY

**Sympt√¥me** : Requ√™tes qui fonctionnaient sur MySQL 5.7 √©chouent apr√®s migration

```sql
-- Requ√™te probl√©matique
SELECT customer_id, name, MAX(order_date)
FROM customers c
JOIN orders o ON c.id = o.customer_id
GROUP BY customer_id;
-- Erreur : 'name' n'est pas dans GROUP BY ni fonction d'agr√©gation

-- Cause : ONLY_FULL_GROUP_BY actif par d√©faut

-- Solution 1 : Corriger la requ√™te (recommand√©)
SELECT customer_id, ANY_VALUE(name), MAX(order_date)
FROM customers c
JOIN orders o ON c.id = o.customer_id
GROUP BY customer_id;

-- Solution 2 : D√©sactiver le mode (temporaire, non recommand√©)
SET sql_mode = (SELECT REPLACE(@@sql_mode, 'ONLY_FULL_GROUP_BY', ''));
```

### Sc√©nario 2 : Dates invalides rejet√©es

**Sympt√¥me** : INSERT √©chouent avec des dates '0000-00-00'

```sql
-- Requ√™te √©chouante
INSERT INTO events (event_date) VALUES ('0000-00-00');
-- Erreur : Incorrect date value: '0000-00-00'

-- Cause : STRICT mode + NO_ZERO_DATE

-- Solution temporaire (si donn√©es historiques)
SET sql_mode = (SELECT REPLACE(@@sql_mode, 'NO_ZERO_DATE', ''));
SET sql_mode = (SELECT REPLACE(@@sql_mode, 'NO_ZERO_IN_DATE', ''));

-- Solution p√©renne : convertir les donn√©es
UPDATE events SET event_date = NULL WHERE event_date = '0000-00-00';

-- Et ajouter contrainte
ALTER TABLE events MODIFY event_date DATE NULL;
```

### Sc√©nario 3 : Performance d√©grad√©e sur requ√™tes JSON

**Sympt√¥me** : Requ√™tes JSON 10x plus lentes apr√®s migration

```sql
-- Requ√™te probl√©matique
SELECT * FROM products 
WHERE JSON_EXTRACT(metadata, '$.category') = 'electronics';
-- Full table scan sur MariaDB (JSON = LONGTEXT)

-- Cause : MySQL stocke JSON en binaire, MariaDB en texte

-- Solution : Colonne virtuelle index√©e
ALTER TABLE products 
ADD COLUMN category VARCHAR(100) 
    AS (JSON_UNQUOTE(JSON_EXTRACT(metadata, '$.category'))) STORED,
ADD INDEX idx_category (category);

-- Requ√™te optimis√©e
SELECT * FROM products WHERE category = 'electronics';
-- Index scan efficace
```

### Sc√©nario 4 : R√©plication cass√©e apr√®s failover

**Sympt√¥me** : Replica refuse de d√©marrer apr√®s promotion/demotion

```sql
-- Erreur typique
-- ERROR 1236: Could not find GTID state requested by slave

-- Cause : Incompatibilit√© GTID MySQL/MariaDB

-- Solution : Reset et reconfiguration en mode position
STOP SLAVE;
RESET SLAVE ALL;

-- Obtenir position actuelle du nouveau primary
-- Sur le primary MariaDB
SHOW MASTER STATUS;

-- Reconfigurer le replica
CHANGE MASTER TO
    MASTER_HOST = 'new-primary',
    MASTER_LOG_FILE = 'mariadb-bin.000001',
    MASTER_LOG_POS = 12345,
    MASTER_USE_GTID = NO;

START SLAVE;
```

### Sc√©nario 5 : Erreurs de collation apr√®s migration MySQL 8.0

**Sympt√¥me** : Illegal mix of collations dans les jointures

```sql
-- Erreur
-- ERROR 1267: Illegal mix of collations 
-- (utf8mb4_0900_ai_ci,IMPLICIT) and (utf8mb4_general_ci,IMPLICIT)

-- Cause : Tables avec collations MySQL 8.0 non converties

-- Diagnostic
SELECT TABLE_NAME, COLUMN_NAME, COLLATION_NAME
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_SCHEMA = 'mydb'
  AND COLLATION_NAME LIKE '%0900%';

-- Solution : Script de conversion bulk
SELECT CONCAT(
    'ALTER TABLE `', TABLE_SCHEMA, '`.`', TABLE_NAME, '` ',
    'CONVERT TO CHARACTER SET utf8mb4 COLLATE utf8mb4_uca1400_ai_ci;'
) AS alter_sql
FROM (
    SELECT DISTINCT TABLE_SCHEMA, TABLE_NAME
    FROM INFORMATION_SCHEMA.COLUMNS
    WHERE TABLE_SCHEMA = 'mydb'
      AND COLLATION_NAME LIKE '%0900%'
) t;

-- Ex√©cuter les ALTER g√©n√©r√©s
```

---

## Checklist des points d'attention pr√©-migration

### Analyse statique du code SQL

```bash
#!/bin/bash
# analyze_sql_compatibility.sh

SQL_DIR="./app/sql"
OUTPUT_FILE="compatibility_report.txt"

echo "=== MySQL ‚Üí MariaDB Compatibility Analysis ===" > $OUTPUT_FILE
echo "Date: $(date)" >> $OUTPUT_FILE
echo "" >> $OUTPUT_FILE

# Recherche de patterns probl√©matiques
patterns=(
    "JSON_TABLE"
    "utf8mb4_0900"
    "caching_sha2_password"
    "LATERAL"
    "VISIBLE\|INVISIBLE.*INDEX"
    "WITH ROLLUP.*ORDER BY"
    "GET_LOCK.*timeout"
    "GROUP_REPLICATION"
    "CLONE"
    "\\\\p{.*}"  # Unicode regex properties
)

for pattern in "${patterns[@]}"; do
    echo "--- Checking: $pattern ---" >> $OUTPUT_FILE
    grep -rn "$pattern" $SQL_DIR >> $OUTPUT_FILE 2>/dev/null
    echo "" >> $OUTPUT_FILE
done

echo "Report generated: $OUTPUT_FILE"
```

### Tests de r√©gression SQL

```sql
-- Suite de tests de compatibilit√© √† ex√©cuter

-- Test 1: Comportement NULL
SELECT ASSERT_EQUALS(
    (SELECT IFNULL(NULL, 1) + 1),
    2,
    'IFNULL basic test'
);

-- Test 2: AUTO_INCREMENT apr√®s DELETE  
CREATE TEMPORARY TABLE test_ai (id INT AUTO_INCREMENT PRIMARY KEY);
INSERT INTO test_ai VALUES (), (), ();
DELETE FROM test_ai WHERE id = 3;
INSERT INTO test_ai VALUES ();
SELECT ASSERT_TRUE(
    (SELECT MAX(id) FROM test_ai) >= 4,
    'AUTO_INCREMENT no reuse'
);

-- Test 3: Collation comparison
SELECT ASSERT_EQUALS(
    (SELECT 'a' COLLATE utf8mb4_general_ci = 'A' COLLATE utf8mb4_general_ci),
    1,
    'Case insensitive collation'
);

-- Test 4: JSON extraction
CREATE TEMPORARY TABLE test_json (data JSON);
INSERT INTO test_json VALUES ('{"key": "value"}');
SELECT ASSERT_EQUALS(
    (SELECT JSON_UNQUOTE(JSON_EXTRACT(data, '$.key')) FROM test_json),
    'value',
    'JSON extraction'
);

-- Test 5: Window functions
SELECT ASSERT_TRUE(
    (SELECT COUNT(*) FROM (
        SELECT ROW_NUMBER() OVER (ORDER BY 1) AS rn FROM dual
    ) t) = 1,
    'Window function basic'
);
```

---

## ‚úÖ Points cl√©s √† retenir

- **Modes SQL divergents** : V√©rifiez syst√©matiquement `@@sql_mode` apr√®s migration, les comportements par d√©faut diff√®rent sur ONLY_FULL_GROUP_BY, NO_ZERO_DATE, etc.

- **Expressions r√©guli√®res** : MariaDB utilise PCRE, MySQL utilise ICU - les patterns Unicode avanc√©s (`\p{Greek}`) ne fonctionnent pas de la m√™me mani√®re

- **Index invisibles/ignor√©s** : Syntaxe diff√©rente (`INVISIBLE` vs `IGNORED`), fonctionnalit√© √©quivalente

- **GTID incompatibles** : Migration avec r√©plication n√©cessite le mode position binlog, jamais GTID direct

- **Performances JSON** : MariaDB stocke JSON en texte, cr√©ez des colonnes virtuelles index√©es pour les acc√®s fr√©quents

- **Collations MySQL 8.0** : Les `utf8mb4_0900_*` n'existent pas en MariaDB, convertissez vers `utf8mb4_uca1400_ai_ci`

- **Thread Pool gratuit** : Avantage MariaDB Community, configurez-le pour les charges √©lev√©es

- **Timestamp 2038** : MariaDB 11.8 √©tend TIMESTAMP jusqu'en 2106, MySQL reste limit√© √† 2038

---

## üîó Ressources et r√©f√©rences

- [üìñ MariaDB Knowledge Base - SQL Differences](https://mariadb.com/kb/en/mariadb-vs-mysql-features/)
- [üìñ MariaDB SQL Mode](https://mariadb.com/kb/en/sql-mode/)
- [üìñ MariaDB Thread Pool](https://mariadb.com/kb/en/thread-pool-in-mariadb/)
- [üìñ MySQL 8.0 Reference Manual](https://dev.mysql.com/doc/refman/8.0/en/)
- [üìñ PCRE Regular Expressions](https://mariadb.com/kb/en/pcre-regular-expressions/)
- [üìñ MariaDB GTID](https://mariadb.com/kb/en/gtid/)

---

## ‚û°Ô∏è Section suivante

**[19.1.3 Outils de migration](./01.3-outils-migration.md)** : Pr√©sentation d√©taill√©e des outils de migration (mysqldump, mydumper, pt-tools, AWS DMS, etc.) avec workflows complets, comparaisons de performance et cas d'usage optimaux.

‚è≠Ô∏è [Outils de migration](/19-migration-compatibilite/01.3-outils-migration.md)
