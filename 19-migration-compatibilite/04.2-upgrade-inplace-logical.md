ğŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 19.4.2 Upgrade In-Place vs Migration Logique

> **Niveau** : AvancÃ© Ã  Expert  
> **DurÃ©e estimÃ©e** : 5-6 heures  
> **PrÃ©requis** : Section 19.4.1 (mariadb-upgrade), expÃ©rience en administration MariaDB, comprÃ©hension des formats de stockage InnoDB

## ğŸ¯ Objectifs d'apprentissage

Ã€ l'issue de cette section, vous serez capable de :
- Analyser en profondeur les deux stratÃ©gies d'upgrade et leurs implications
- Ã‰valuer les critÃ¨res de dÃ©cision pour choisir la bonne approche
- ImplÃ©menter chaque stratÃ©gie avec les meilleures pratiques
- Optimiser les performances des migrations logiques Ã  grande Ã©chelle
- GÃ©rer les cas hybrides et les migrations partielles
- Anticiper et rÃ©soudre les problÃ¨mes spÃ©cifiques Ã  chaque approche

---

## Introduction

Le choix entre upgrade in-place et migration logique est l'une des dÃ©cisions les plus importantes lors d'une mise Ã  jour MariaDB. Ce choix impacte directement :
- Le **temps d'arrÃªt** du service
- La **sÃ©curitÃ©** des donnÃ©es
- La **complexitÃ©** de la procÃ©dure
- Les **options de rollback**
- Les **performances** post-migration

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ARBRE DE DÃ‰CISION STRATÃ‰GIQUE                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚                          â”‚ Type d'upgrade? â”‚                             â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚                 â”‚                 â”‚                  â”‚                   â”‚
â”‚                 â–¼                 â–¼                  â–¼                   â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚          â”‚  Patch   â”‚      â”‚  Minor   â”‚         â”‚  Major   â”‚             â”‚
â”‚          â”‚10.6.15â†’16â”‚      â”‚ 10.6â†’11  â”‚         â”‚ 10â†’11.8  â”‚             â”‚
â”‚          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜             â”‚
â”‚               â”‚                 â”‚                    â”‚                   â”‚
â”‚               â–¼                 â–¼                    â–¼                   â”‚
â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚        â”‚ IN-PLACE   â”‚    â”‚  Volume?   â”‚       â”‚  Source?   â”‚             â”‚
â”‚        â”‚ RecommandÃ© â”‚    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚                          â”‚           â”‚         â”‚           â”‚             â”‚
â”‚                          â–¼           â–¼         â–¼           â–¼             â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚                    â”‚ < 500GB â”‚ â”‚ > 500GB â”‚ â”‚MariaDB  â”‚ â”‚ MySQL 8+ â”‚      â”‚
â”‚                    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â”‚ compat. â”‚ â”‚ ou autre â”‚      â”‚
â”‚                         â”‚           â”‚      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                         â–¼           â–¼           â–¼           â–¼            â”‚
â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚                   â”‚ IN-PLACE â”‚ â”‚ LOGIQUE  â”‚ â”‚ IN-PLACE â”‚ â”‚ LOGIQUE  â”‚    â”‚
â”‚                   â”‚ possible â”‚ â”‚ prÃ©fÃ©rÃ©  â”‚ â”‚ possible â”‚ â”‚ REQUIS   â”‚    â”‚
â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Upgrade In-Place : Analyse approfondie

### Principe de fonctionnement

L'upgrade in-place consiste Ã  remplacer les binaires MariaDB tout en conservant le rÃ©pertoire de donnÃ©es intact. Le nouveau serveur lit et met Ã  jour les fichiers de donnÃ©es existants.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    UPGRADE IN-PLACE : FLUX                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Ã‰tat initial                                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ MariaDB 10.11   â”‚â”€â”€â”€â–¶â”‚ /var/lib/mysql/                     â”‚     â”‚
â”‚  â”‚ (binaires)      â”‚    â”‚  â”œâ”€â”€ ibdata1                        â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”œâ”€â”€ ib_logfile0, ib_logfile1       â”‚     â”‚
â”‚                         â”‚  â”œâ”€â”€ mysql/ (tables systÃ¨me)        â”‚     â”‚
â”‚                         â”‚  â””â”€â”€ mydb/ (donnÃ©es utilisateur)    â”‚     â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                          â”‚                          â”‚
â”‚  AprÃ¨s upgrade                           â”‚ MÃŠME RÃ‰PERTOIRE          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                            â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ MariaDB 11.8    â”‚â”€â”€â”€â–¶â”‚ /var/lib/mysql/                     â”‚     â”‚
â”‚  â”‚ (nouveaux       â”‚    â”‚  â”œâ”€â”€ ibdata1 (peut Ãªtre modifiÃ©)    â”‚     â”‚
â”‚  â”‚  binaires)      â”‚    â”‚  â”œâ”€â”€ ib_logfile0 (peut changer)     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”œâ”€â”€ mysql/ (mis Ã  jour)            â”‚     â”‚
â”‚         â”‚               â”‚  â””â”€â”€ mydb/ (inchangÃ© ou converti)   â”‚     â”‚
â”‚         â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         â”‚                                                           â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ mariadb-upgrade                            â”‚
â”‚                          (mise Ã  jour schÃ©ma systÃ¨me)               â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### CompatibilitÃ© des fichiers de donnÃ©es

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            MATRICE DE COMPATIBILITÃ‰ FICHIERS InnoDB                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Source â†’ Cible          â”‚ In-Place? â”‚ Notes                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  MariaDB 10.5 â†’ 10.6    â”‚ âœ… Oui    â”‚ Aucune modification           â”‚
â”‚  MariaDB 10.6 â†’ 10.11   â”‚ âœ… Oui    â”‚ Upgrade transparent           â”‚
â”‚  MariaDB 10.11 â†’ 11.4   â”‚ âœ… Oui    â”‚ Upgrade transparent           â”‚
â”‚  MariaDB 11.4 â†’ 11.8    â”‚ âœ… Oui    â”‚ ğŸ†• SVT format change          
â”‚  MariaDB 10.x â†’ 11.8    â”‚ âš ï¸ Oui   â”‚ VÃ©rifier variables dÃ©prÃ©c.     â”‚
â”‚  MySQL 5.6 â†’ MariaDB    â”‚ âœ… Oui    â”‚ Compatible                    â”‚
â”‚  MySQL 5.7 â†’ MariaDB    â”‚ âœ… Oui    â”‚ Compatible (attention auth)   â”‚
â”‚  MySQL 8.0 â†’ MariaDB    â”‚ âŒ Non    â”‚ Format incompatible !         â”‚
â”‚  MariaDB â†’ version inf. â”‚ âŒ Non    â”‚ Downgrade non supportÃ©        â”‚
â”‚                                                                     â”‚
â”‚  âš ï¸  innodb_page_size doit rester identique                         â”‚
â”‚  âš ï¸  innodb_file_per_table configuration prÃ©servÃ©e                  â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ProcÃ©dure In-Place dÃ©taillÃ©e

```bash
#!/bin/bash
# detailed_inplace_upgrade.sh
# Upgrade in-place avec toutes les vÃ©rifications

set -e

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CONFIGURATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

OLD_VERSION="10.11"
NEW_VERSION="11.8"
DATADIR="/var/lib/mysql"
BACKUP_DIR="/backup/inplace-$(date +%Y%m%d-%H%M%S)"
LOG_FILE="/var/log/mariadb-upgrade-$(date +%Y%m%d).log"

# Fonctions utilitaires
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a $LOG_FILE
}

check_error() {
    if [ $? -ne 0 ]; then
        log "ERREUR: $1"
        exit 1
    fi
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 1 : VÃ‰RIFICATIONS PRÃ‰-UPGRADE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

log "=== PHASE 1: VÃ©rifications prÃ©-upgrade ==="

# 1.1 VÃ©rifier la version actuelle
CURRENT_VERSION=$(mariadb -BNe "SELECT VERSION()")
log "Version actuelle: $CURRENT_VERSION"

# 1.2 VÃ©rifier l'espace disque
DATA_SIZE=$(du -sb $DATADIR | awk '{print $1}')
DISK_FREE=$(df -B1 $DATADIR | tail -1 | awk '{print $4}')
DATA_SIZE_GB=$((DATA_SIZE / 1024 / 1024 / 1024))
DISK_FREE_GB=$((DISK_FREE / 1024 / 1024 / 1024))

log "Taille donnÃ©es: ${DATA_SIZE_GB} GB"
log "Espace libre: ${DISK_FREE_GB} GB"

if [ $DISK_FREE -lt $DATA_SIZE ]; then
    log "ERREUR: Espace disque insuffisant pour backup"
    exit 1
fi

# 1.3 VÃ©rifier les transactions en cours
ACTIVE_TRX=$(mariadb -BNe "SELECT COUNT(*) FROM information_schema.INNODB_TRX")
if [ "$ACTIVE_TRX" -gt 0 ]; then
    log "ATTENTION: $ACTIVE_TRX transactions actives"
    mariadb -e "SELECT trx_id, trx_state, trx_started, trx_query 
                FROM information_schema.INNODB_TRX" | tee -a $LOG_FILE
    read -p "Continuer malgrÃ© les transactions actives? (yes/no): " CONTINUE
    if [ "$CONTINUE" != "yes" ]; then
        exit 1
    fi
fi

# 1.4 VÃ©rifier la rÃ©plication (si applicable)
SLAVE_STATUS=$(mariadb -BNe "SHOW SLAVE STATUS\G" 2>/dev/null | grep -c "Slave_IO_Running" || echo "0")
if [ "$SLAVE_STATUS" -gt 0 ]; then
    LAG=$(mariadb -BNe "SHOW SLAVE STATUS\G" | grep "Seconds_Behind_Master" | awk '{print $2}')
    log "Serveur rÃ©plica dÃ©tectÃ©, lag: $LAG secondes"
    if [ "$LAG" != "0" ] && [ "$LAG" != "NULL" ]; then
        log "ERREUR: RÃ©plication en retard"
        exit 1
    fi
fi

# 1.5 VÃ©rifier les tables corrompues
log "VÃ©rification intÃ©gritÃ© des tables..."
mysqlcheck --all-databases --check 2>&1 | tee -a $LOG_FILE
if grep -q "error" $LOG_FILE; then
    log "ATTENTION: Erreurs dÃ©tectÃ©es, tentative de rÃ©paration..."
    mysqlcheck --all-databases --auto-repair 2>&1 | tee -a $LOG_FILE
fi

# 1.6 VÃ©rifier innodb_page_size (ne peut pas changer)
PAGE_SIZE=$(mariadb -BNe "SELECT @@innodb_page_size")
log "innodb_page_size: $PAGE_SIZE (ne changera pas)"

# 1.7 Identifier les System-Versioned Tables (ğŸ†• 11.8)
log "Identification des System-Versioned Tables..."
SVT_COUNT=$(mariadb -BNe "
    SELECT COUNT(*) FROM information_schema.TABLES 
    WHERE CREATE_OPTIONS LIKE '%versioning%'
")
log "Tables System-Versioned: $SVT_COUNT"
if [ "$SVT_COUNT" -gt 0 ]; then
    mariadb -BNe "
        SELECT TABLE_SCHEMA, TABLE_NAME, TABLE_ROWS
        FROM information_schema.TABLES 
        WHERE CREATE_OPTIONS LIKE '%versioning%'
    " | tee -a $LOG_FILE
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 2 : BACKUP
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

log "=== PHASE 2: Backup ==="

mkdir -p $BACKUP_DIR
log "RÃ©pertoire backup: $BACKUP_DIR"

# 2.1 Backup physique avec Mariabackup
log "Backup physique en cours..."
mariabackup \
    --backup \
    --target-dir=$BACKUP_DIR/physical \
    --user=root \
    --password="${MARIADB_ROOT_PASSWORD}" \
    --parallel=4 \
    2>&1 | tee -a $LOG_FILE
check_error "Backup physique Ã©chouÃ©"

# 2.2 PrÃ©parer le backup
log "PrÃ©paration du backup..."
mariabackup \
    --prepare \
    --target-dir=$BACKUP_DIR/physical \
    2>&1 | tee -a $LOG_FILE

# 2.3 Backup logique des mÃ©tadonnÃ©es
log "Backup des mÃ©tadonnÃ©es..."
mariadb-dump \
    --no-data \
    --routines \
    --triggers \
    --events \
    --all-databases \
    > $BACKUP_DIR/schema_backup.sql 2>> $LOG_FILE

# 2.4 Backup de la configuration
log "Backup configuration..."
cp -a /etc/mysql $BACKUP_DIR/etc_mysql 2>/dev/null || true
cp /etc/my.cnf $BACKUP_DIR/ 2>/dev/null || true
cp /etc/my.cnf.d/* $BACKUP_DIR/ 2>/dev/null || true

# 2.5 Sauvegarder les informations de rÃ©plication
if [ "$SLAVE_STATUS" -gt 0 ]; then
    mariadb -e "SHOW SLAVE STATUS\G" > $BACKUP_DIR/slave_status.txt
fi
mariadb -e "SHOW MASTER STATUS\G" > $BACKUP_DIR/master_status.txt 2>/dev/null || true

log "Backup terminÃ©: $BACKUP_DIR"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 3 : ARRÃŠT PROPRE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

log "=== PHASE 3: ArrÃªt propre de MariaDB ==="

# 3.1 Flush et shutdown propre
log "Configuration shutdown propre..."
mariadb -e "SET GLOBAL innodb_fast_shutdown = 0;"
mariadb -e "SET GLOBAL innodb_max_dirty_pages_pct = 0;"

# 3.2 Attendre que les dirty pages soient vidÃ©es
log "Attente vidage dirty pages..."
while true; do
    DIRTY=$(mariadb -BNe "SHOW STATUS LIKE 'Innodb_buffer_pool_pages_dirty'" | awk '{print $2}')
    log "Dirty pages: $DIRTY"
    if [ "$DIRTY" -lt 100 ]; then
        break
    fi
    sleep 5
done

# 3.3 ArrÃªt du service
log "ArrÃªt de MariaDB..."
systemctl stop mariadb
check_error "ArrÃªt MariaDB Ã©chouÃ©"

# 3.4 VÃ©rifier que le processus est bien arrÃªtÃ©
TIMEOUT=60
COUNTER=0
while pgrep -x mysqld > /dev/null; do
    log "Attente arrÃªt mysqld..."
    sleep 2
    COUNTER=$((COUNTER + 2))
    if [ $COUNTER -gt $TIMEOUT ]; then
        log "ERREUR: mysqld ne s'arrÃªte pas, kill forcÃ©"
        pkill -9 mysqld
        sleep 5
    fi
done
log "MariaDB arrÃªtÃ©"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 4 : INSTALLATION NOUVELLE VERSION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

log "=== PHASE 4: Installation MariaDB $NEW_VERSION ==="

# 4.1 Backup des anciens binaires (optionnel)
log "Sauvegarde anciens binaires..."
dpkg -l | grep -i mariadb > $BACKUP_DIR/installed_packages.txt

# 4.2 Mise Ã  jour du repository
log "Configuration repository $NEW_VERSION..."

# Debian/Ubuntu
if [ -f /etc/debian_version ]; then
    curl -sS https://downloads.mariadb.com/MariaDB/mariadb_repo_setup | \
        bash -s -- --mariadb-server-version=mariadb-$NEW_VERSION
    apt-get update
    
    log "Installation packages..."
    DEBIAN_FRONTEND=noninteractive apt-get install -y \
        mariadb-server \
        mariadb-client \
        mariadb-backup
fi

# CentOS/RHEL
if [ -f /etc/redhat-release ]; then
    cat > /etc/yum.repos.d/MariaDB.repo << EOF
[mariadb]
name = MariaDB
baseurl = https://mirror.mariadb.org/yum/$NEW_VERSION/centos/\$releasever/\$basearch
gpgkey = https://mirror.mariadb.org/yum/RPM-GPG-KEY-MariaDB
gpgcheck = 1
EOF
    
    yum clean all
    yum install -y MariaDB-server MariaDB-client MariaDB-backup
fi

log "Installation terminÃ©e"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 5 : DÃ‰MARRAGE ET UPGRADE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

log "=== PHASE 5: DÃ©marrage et upgrade ==="

# 5.1 DÃ©marrer MariaDB
log "DÃ©marrage MariaDB $NEW_VERSION..."
systemctl start mariadb
check_error "DÃ©marrage MariaDB Ã©chouÃ©"

# 5.2 Attendre que le serveur soit prÃªt
TIMEOUT=120
COUNTER=0
until mariadb -e "SELECT 1" > /dev/null 2>&1; do
    log "Attente dÃ©marrage MariaDB..."
    sleep 2
    COUNTER=$((COUNTER + 2))
    if [ $COUNTER -gt $TIMEOUT ]; then
        log "ERREUR: MariaDB ne dÃ©marre pas"
        tail -100 /var/log/mysql/error.log | tee -a $LOG_FILE
        exit 1
    fi
done

# 5.3 VÃ©rifier la version
NEW_VER=$(mariadb -BNe "SELECT VERSION()")
log "Nouvelle version: $NEW_VER"

# 5.4 ExÃ©cuter mariadb-upgrade
log "ExÃ©cution mariadb-upgrade..."
mariadb-upgrade \
    --verbose \
    --force \
    2>&1 | tee -a $LOG_FILE
check_error "mariadb-upgrade Ã©chouÃ©"

# 5.5 ğŸ†• Mise Ã  jour format System-Versioned Tables (11.8)
if [ "$SVT_COUNT" -gt 0 ]; then
    log "Mise Ã  jour format System-Versioned Tables..."
    mariadb -BNe "
        SELECT CONCAT('ALTER TABLE \`', TABLE_SCHEMA, '\`.\`', TABLE_NAME, '\` FORCE;')
        FROM information_schema.TABLES 
        WHERE CREATE_OPTIONS LIKE '%versioning%'
    " | while read SQL; do
        log "ExÃ©cution: $SQL"
        mariadb -e "$SQL" 2>&1 | tee -a $LOG_FILE
    done
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 6 : VALIDATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

log "=== PHASE 6: Validation ==="

# 6.1 VÃ©rifier les tables
log "VÃ©rification des tables..."
mysqlcheck --all-databases --check 2>&1 | tee -a $LOG_FILE

# 6.2 Compter les objets
TABLES_AFTER=$(mariadb -BNe "
    SELECT COUNT(*) FROM information_schema.TABLES 
    WHERE TABLE_SCHEMA NOT IN ('information_schema', 'performance_schema', 'sys')
")
log "Nombre de tables: $TABLES_AFTER"

# 6.3 VÃ©rifier les routines
ROUTINES_AFTER=$(mariadb -BNe "
    SELECT COUNT(*) FROM information_schema.ROUTINES
")
log "Nombre de routines: $ROUTINES_AFTER"

# 6.4 VÃ©rifier les erreurs dans les logs
ERRORS=$(tail -200 /var/log/mysql/error.log | grep -ci "error" || echo "0")
log "Erreurs dans les logs: $ERRORS"

# 6.5 RedÃ©marrer la rÃ©plication si nÃ©cessaire
if [ "$SLAVE_STATUS" -gt 0 ]; then
    log "RedÃ©marrage rÃ©plication..."
    mariadb -e "START SLAVE;"
    sleep 5
    mariadb -e "SHOW SLAVE STATUS\G" | tee -a $LOG_FILE
fi

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# RÃ‰SUMÃ‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

log ""
log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
log "              UPGRADE IN-PLACE TERMINÃ‰"
log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
log "Version prÃ©cÃ©dente: $CURRENT_VERSION"
log "Nouvelle version:   $NEW_VER"
log "Backup disponible:  $BACKUP_DIR"
log "Log complet:        $LOG_FILE"
log ""
log "Actions recommandÃ©es:"
log "1. Surveiller les performances pendant 24-48h"
log "2. VÃ©rifier les logs d'erreur rÃ©guliÃ¨rement"
log "3. Tester les fonctionnalitÃ©s critiques"
log "4. Conserver le backup pendant 1 semaine minimum"
log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
```

### Avantages et limitations de l'In-Place

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    IN-PLACE : AVANTAGES                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  âœ… RapiditÃ©                                                        â”‚
â”‚     â€¢ Pas de copie de donnÃ©es                                       â”‚
â”‚     â€¢ Temps d'arrÃªt minimal (minutes Ã  heures selon taille)         â”‚
â”‚     â€¢ IdÃ©al pour bases < 500 GB                                     â”‚
â”‚                                                                     â”‚
â”‚  âœ… SimplicitÃ©                                                      â”‚
â”‚     â€¢ ProcÃ©dure linÃ©aire                                            â”‚
â”‚     â€¢ Moins de risques d'erreur humaine                             â”‚
â”‚     â€¢ Un seul serveur impliquÃ©                                      â”‚
â”‚                                                                     â”‚
â”‚  âœ… PrÃ©servation                                                    â”‚
â”‚     â€¢ Historique System-Versioned Tables conservÃ©                   â”‚
â”‚     â€¢ Statistiques et index intacts                                 â”‚
â”‚     â€¢ Configuration prÃ©servÃ©e                                       â”‚
â”‚                                                                     â”‚
â”‚  âœ… Ressources                                                      â”‚
â”‚     â€¢ Pas besoin d'espace disque double                             â”‚
â”‚     â€¢ Pas de serveur supplÃ©mentaire requis                          â”‚
â”‚                                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    IN-PLACE : LIMITATIONS                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  âŒ Downtime obligatoire                                            â”‚
â”‚     â€¢ Le service doit Ãªtre arrÃªtÃ©                                   â”‚
â”‚     â€¢ Pas de zero-downtime natif                                    â”‚
â”‚                                                                     â”‚
â”‚  âŒ Rollback complexe                                               â”‚
â”‚     â€¢ NÃ©cessite restauration du backup                              â”‚
â”‚     â€¢ Temps de rollback = temps de restauration                     â”‚
â”‚                                                                     â”‚
â”‚  âŒ Pas de test prÃ©alable                                           â”‚
â”‚     â€¢ Impossible de valider sur les vraies donnÃ©es avant            â”‚
â”‚     â€¢ DÃ©couverte des problÃ¨mes en production                        â”‚
â”‚                                                                     â”‚
â”‚  âŒ Fragmentation conservÃ©e                                         â”‚
â”‚     â€¢ Les tables fragmentÃ©es restent fragmentÃ©es                    â”‚
â”‚     â€¢ Pas d'optimisation automatique                                â”‚
â”‚                                                                     â”‚
â”‚  âŒ Versions incompatibles                                          â”‚
â”‚     â€¢ MySQL 8.0+ â†’ MariaDB impossible                               â”‚
â”‚     â€¢ Downgrade impossible                                          â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Migration Logique : Analyse approfondie

### Principe de fonctionnement

La migration logique exporte les donnÃ©es sous forme SQL (ou autre format), puis les rÃ©importe dans une nouvelle instance. C'est une reconstruction complÃ¨te de la base.

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MIGRATION LOGIQUE : FLUX                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ MariaDB 10.11   â”‚                    â”‚ MariaDB 11.8        â”‚    â”‚
â”‚  â”‚ (SOURCE)        â”‚                    â”‚ (CIBLE)             â”‚    â”‚
â”‚  â”‚                 â”‚                    â”‚                     â”‚    â”‚
â”‚  â”‚ /var/lib/mysql/ â”‚                    â”‚ /var/lib/mysql/     â”‚    â”‚
â”‚  â”‚ (anciennes      â”‚                    â”‚ (nouvelle           â”‚    â”‚
â”‚  â”‚  donnÃ©es)       â”‚                    â”‚  instance vide)     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚           â”‚                                        â”‚               â”‚
â”‚           â”‚ EXPORT                                 â”‚ IMPORT        â”‚
â”‚           â”‚ (mariadb-dump,                         â”‚ (mariadb,     â”‚
â”‚           â”‚  mydumper)                             â”‚  myloader)    â”‚
â”‚           â”‚                                        â”‚               â”‚
â”‚           â–¼                                        â”‚               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚                                                           â”‚     â”‚
â”‚  â”‚   /backup/migration/                                      â”‚     â”‚
â”‚  â”‚   â”œâ”€â”€ schema.sql         (DDL)                            â”‚     â”‚
â”‚  â”‚   â”œâ”€â”€ data_table1.sql    (INSERT)                         â”‚     â”‚
â”‚  â”‚   â”œâ”€â”€ data_table2.sql    (INSERT)                         â”‚     â”‚
â”‚  â”‚   â”œâ”€â”€ routines.sql       (PROCEDURES, FUNCTIONS)          â”‚     â”‚
â”‚  â”‚   â””â”€â”€ triggers.sql       (TRIGGERS)                       â”‚     â”‚
â”‚  â”‚                                                           â”‚     â”‚
â”‚  â”‚   Format : SQL, CSV, ou binaire (mydumper)                â”‚     â”‚
â”‚  â”‚                                                           â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ProcÃ©dure de migration logique complÃ¨te

```bash
#!/bin/bash
# detailed_logical_migration.sh
# Migration logique complÃ¨te avec optimisations

set -e

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CONFIGURATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

SOURCE_HOST="source-db.example.com"
SOURCE_PORT="3306"
SOURCE_USER="migration_user"
SOURCE_PASS="MigrationP@ss"

TARGET_HOST="target-db.example.com"
TARGET_PORT="3306"
TARGET_USER="root"
TARGET_PASS="RootP@ss"

EXPORT_DIR="/backup/logical-migration-$(date +%Y%m%d)"
LOG_FILE="/var/log/logical-migration.log"
PARALLEL_JOBS=8
CHUNK_SIZE=500000

# Bases Ã  migrer (vide = toutes)
DATABASES=""

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a $LOG_FILE
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 1 : PRÃ‰PARATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

log "=== PHASE 1: PrÃ©paration ==="

mkdir -p $EXPORT_DIR/{schema,data,routines}

# 1.1 Inventaire source
log "Inventaire de la source..."
mysql -h $SOURCE_HOST -P $SOURCE_PORT -u $SOURCE_USER -p"$SOURCE_PASS" -BNe "
    SELECT 
        table_schema,
        table_name,
        table_rows,
        ROUND((data_length + index_length) / 1024 / 1024, 2) AS size_mb
    FROM information_schema.tables
    WHERE table_schema NOT IN ('mysql', 'information_schema', 'performance_schema', 'sys')
    ORDER BY (data_length + index_length) DESC
" > $EXPORT_DIR/source_inventory.txt

TOTAL_TABLES=$(wc -l < $EXPORT_DIR/source_inventory.txt)
TOTAL_SIZE=$(awk '{sum += $4} END {print sum}' $EXPORT_DIR/source_inventory.txt)
log "Tables Ã  migrer: $TOTAL_TABLES"
log "Taille totale: ${TOTAL_SIZE} MB"

# 1.2 VÃ©rifier l'espace sur la cible
TARGET_FREE=$(ssh $TARGET_HOST "df -BM /var/lib/mysql | tail -1 | awk '{print \$4}' | tr -d 'M'")
REQUIRED=$((TOTAL_SIZE * 2))  # Marge de sÃ©curitÃ©
log "Espace requis: ${REQUIRED} MB, disponible: ${TARGET_FREE} MB"

if [ "$TARGET_FREE" -lt "$REQUIRED" ]; then
    log "ERREUR: Espace insuffisant sur la cible"
    exit 1
fi

# 1.3 PrÃ©parer la cible
log "PrÃ©paration de la cible..."
ssh $TARGET_HOST "mysql -u $TARGET_USER -p'$TARGET_PASS' -e '
    SET GLOBAL innodb_buffer_pool_size = 4294967296;
    SET GLOBAL innodb_log_file_size = 1073741824;
    SET GLOBAL innodb_flush_log_at_trx_commit = 2;
    SET GLOBAL sync_binlog = 0;
    SET GLOBAL foreign_key_checks = 0;
    SET GLOBAL unique_checks = 0;
'"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 2 : EXPORT (utilisant mydumper pour performance)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

log "=== PHASE 2: Export avec mydumper ==="

# 2.1 Export structure
log "Export de la structure..."
mydumper \
    --host=$SOURCE_HOST \
    --port=$SOURCE_PORT \
    --user=$SOURCE_USER \
    --password="$SOURCE_PASS" \
    --outputdir=$EXPORT_DIR/schema \
    --no-data \
    --triggers \
    --routines \
    --events \
    --threads=4 \
    --verbose=3 \
    2>&1 | tee -a $LOG_FILE

# 2.2 Export donnÃ©es en parallÃ¨le
log "Export des donnÃ©es..."
mydumper \
    --host=$SOURCE_HOST \
    --port=$SOURCE_PORT \
    --user=$SOURCE_USER \
    --password="$SOURCE_PASS" \
    --outputdir=$EXPORT_DIR/data \
    --no-schemas \
    --threads=$PARALLEL_JOBS \
    --rows=$CHUNK_SIZE \
    --compress \
    --long-query-guard=300 \
    --kill-long-queries \
    --verbose=3 \
    --logfile=$EXPORT_DIR/mydumper.log \
    2>&1 | tee -a $LOG_FILE

# 2.3 VÃ©rifier l'export
EXPORTED_FILES=$(find $EXPORT_DIR/data -name "*.sql*" | wc -l)
log "Fichiers exportÃ©s: $EXPORTED_FILES"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 3 : TRANSFORMATION (si nÃ©cessaire)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

log "=== PHASE 3: Transformations ==="

# 3.1 Conversion collations si MySQL 8 â†’ MariaDB
log "VÃ©rification collations..."
grep -r "utf8mb4_0900" $EXPORT_DIR/schema/ && {
    log "Conversion collations MySQL 8..."
    find $EXPORT_DIR/schema -name "*.sql" -exec sed -i \
        -e 's/utf8mb4_0900_ai_ci/utf8mb4_uca1400_ai_ci/g' \
        -e 's/utf8mb4_0900_as_cs/utf8mb4_uca1400_as_cs/g' \
        {} \;
}

# 3.2 Suppression directives GTID MySQL
log "Nettoyage directives GTID..."
find $EXPORT_DIR -name "*.sql" -exec sed -i \
    -e '/SET @@GLOBAL.GTID_PURGED/d' \
    -e '/SET @@SESSION.SQL_LOG_BIN/d' \
    {} \;

# 3.3 Conversion moteurs si nÃ©cessaire
log "VÃ©rification moteurs..."
grep -r "ENGINE=MyISAM" $EXPORT_DIR/schema/ && {
    log "Conversion MyISAM â†’ InnoDB..."
    find $EXPORT_DIR/schema -name "*.sql" -exec sed -i \
        's/ENGINE=MyISAM/ENGINE=InnoDB/g' {} \;
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 4 : IMPORT SUR LA CIBLE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

log "=== PHASE 4: Import sur la cible ==="

# 4.1 CrÃ©er les bases de donnÃ©es
log "CrÃ©ation des databases..."
mysql -h $SOURCE_HOST -P $SOURCE_PORT -u $SOURCE_USER -p"$SOURCE_PASS" -BNe "
    SHOW DATABASES
" | grep -v "information_schema\|performance_schema\|mysql\|sys" | while read DB; do
    ssh $TARGET_HOST "mysql -u $TARGET_USER -p'$TARGET_PASS' -e 'CREATE DATABASE IF NOT EXISTS \`$DB\`'"
done

# 4.2 Import structure
log "Import de la structure..."
myloader \
    --host=$TARGET_HOST \
    --port=$TARGET_PORT \
    --user=$TARGET_USER \
    --password="$TARGET_PASS" \
    --directory=$EXPORT_DIR/schema \
    --threads=4 \
    --verbose=3 \
    2>&1 | tee -a $LOG_FILE

# 4.3 Import donnÃ©es en parallÃ¨le
log "Import des donnÃ©es..."
myloader \
    --host=$TARGET_HOST \
    --port=$TARGET_PORT \
    --user=$TARGET_USER \
    --password="$TARGET_PASS" \
    --directory=$EXPORT_DIR/data \
    --threads=$PARALLEL_JOBS \
    --queries-per-transaction=10000 \
    --overwrite-tables \
    --verbose=3 \
    2>&1 | tee -a $LOG_FILE

# 4.4 RÃ©activer les checks
log "RÃ©activation des contraintes..."
ssh $TARGET_HOST "mysql -u $TARGET_USER -p'$TARGET_PASS' -e '
    SET GLOBAL foreign_key_checks = 1;
    SET GLOBAL unique_checks = 1;
    SET GLOBAL innodb_flush_log_at_trx_commit = 1;
    SET GLOBAL sync_binlog = 1;
'"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 5 : VALIDATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

log "=== PHASE 5: Validation ==="

# 5.1 Compter les tables
log "Comparaison nombre de tables..."
SOURCE_TABLES=$(mysql -h $SOURCE_HOST -P $SOURCE_PORT -u $SOURCE_USER -p"$SOURCE_PASS" -BNe "
    SELECT COUNT(*) FROM information_schema.tables 
    WHERE table_schema NOT IN ('mysql', 'information_schema', 'performance_schema', 'sys')
")
TARGET_TABLES=$(ssh $TARGET_HOST "mysql -u $TARGET_USER -p'$TARGET_PASS' -BNe \"
    SELECT COUNT(*) FROM information_schema.tables 
    WHERE table_schema NOT IN ('mysql', 'information_schema', 'performance_schema', 'sys')
\"")

log "Tables source: $SOURCE_TABLES, cible: $TARGET_TABLES"
if [ "$SOURCE_TABLES" != "$TARGET_TABLES" ]; then
    log "ATTENTION: Nombre de tables diffÃ©rent!"
fi

# 5.2 Compter les lignes par table
log "Comparaison nombre de lignes..."
mysql -h $SOURCE_HOST -P $SOURCE_PORT -u $SOURCE_USER -p"$SOURCE_PASS" -BNe "
    SELECT CONCAT(table_schema, '.', table_name), table_rows
    FROM information_schema.tables
    WHERE table_schema NOT IN ('mysql', 'information_schema', 'performance_schema', 'sys')
    ORDER BY table_schema, table_name
" > $EXPORT_DIR/source_counts.txt

ssh $TARGET_HOST "mysql -u $TARGET_USER -p'$TARGET_PASS' -BNe \"
    SELECT CONCAT(table_schema, '.', table_name), table_rows
    FROM information_schema.tables
    WHERE table_schema NOT IN ('mysql', 'information_schema', 'performance_schema', 'sys')
    ORDER BY table_schema, table_name
\"" > $EXPORT_DIR/target_counts.txt

diff $EXPORT_DIR/source_counts.txt $EXPORT_DIR/target_counts.txt > $EXPORT_DIR/count_diff.txt || true
DIFF_COUNT=$(wc -l < $EXPORT_DIR/count_diff.txt)
if [ "$DIFF_COUNT" -gt 0 ]; then
    log "ATTENTION: DiffÃ©rences de comptage dÃ©tectÃ©es"
    cat $EXPORT_DIR/count_diff.txt | head -20 | tee -a $LOG_FILE
fi

# 5.3 VÃ©rifier les routines
log "VÃ©rification routines..."
SOURCE_ROUTINES=$(mysql -h $SOURCE_HOST -P $SOURCE_PORT -u $SOURCE_USER -p"$SOURCE_PASS" -BNe "
    SELECT COUNT(*) FROM information_schema.routines
")
TARGET_ROUTINES=$(ssh $TARGET_HOST "mysql -u $TARGET_USER -p'$TARGET_PASS' -BNe \"
    SELECT COUNT(*) FROM information_schema.routines
\"")
log "Routines source: $SOURCE_ROUTINES, cible: $TARGET_ROUTINES"

# 5.4 VÃ©rifier les triggers
log "VÃ©rification triggers..."
SOURCE_TRIGGERS=$(mysql -h $SOURCE_HOST -P $SOURCE_PORT -u $SOURCE_USER -p"$SOURCE_PASS" -BNe "
    SELECT COUNT(*) FROM information_schema.triggers
")
TARGET_TRIGGERS=$(ssh $TARGET_HOST "mysql -u $TARGET_USER -p'$TARGET_PASS' -BNe \"
    SELECT COUNT(*) FROM information_schema.triggers
\"")
log "Triggers source: $SOURCE_TRIGGERS, cible: $TARGET_TRIGGERS"

# 5.5 Checksum sur tables critiques
log "Checksums tables critiques..."
CRITICAL_TABLES="users orders products"
for TABLE in $CRITICAL_TABLES; do
    log "Checksum de $TABLE..."
    SOURCE_CHECKSUM=$(mysql -h $SOURCE_HOST -P $SOURCE_PORT -u $SOURCE_USER -p"$SOURCE_PASS" -BNe "
        CHECKSUM TABLE $TABLE" | awk '{print $2}')
    TARGET_CHECKSUM=$(ssh $TARGET_HOST "mysql -u $TARGET_USER -p'$TARGET_PASS' -BNe \"
        CHECKSUM TABLE $TABLE\"" | awk '{print $2}')
    
    if [ "$SOURCE_CHECKSUM" = "$TARGET_CHECKSUM" ]; then
        log "  âœ“ $TABLE: OK"
    else
        log "  âœ— $TABLE: DIFFÃ‰RENT (source: $SOURCE_CHECKSUM, cible: $TARGET_CHECKSUM)"
    fi
done

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 6 : POST-MIGRATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

log "=== PHASE 6: Post-migration ==="

# 6.1 Analyser les tables pour les statistiques
log "Analyse des tables..."
ssh $TARGET_HOST "mysql -u $TARGET_USER -p'$TARGET_PASS' -BNe \"
    SELECT CONCAT('ANALYZE TABLE \\\`', table_schema, '\\\`.\\\`', table_name, '\\\`;')
    FROM information_schema.tables
    WHERE table_schema NOT IN ('mysql', 'information_schema', 'performance_schema', 'sys')
\"" | while read SQL; do
    ssh $TARGET_HOST "mysql -u $TARGET_USER -p'$TARGET_PASS' -e \"$SQL\"" 2>/dev/null
done

# 6.2 Migrer les utilisateurs
log "Migration des utilisateurs..."
pt-show-grants \
    --host=$SOURCE_HOST \
    --port=$SOURCE_PORT \
    --user=$SOURCE_USER \
    --password="$SOURCE_PASS" \
    | grep -v "mysql.session\|mysql.sys\|root" \
    > $EXPORT_DIR/grants.sql

ssh $TARGET_HOST "mysql -u $TARGET_USER -p'$TARGET_PASS'" < $EXPORT_DIR/grants.sql

log ""
log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
log "              MIGRATION LOGIQUE TERMINÃ‰E"
log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
log "Export: $EXPORT_DIR"
log "Log:    $LOG_FILE"
log ""
log "Prochaines Ã©tapes:"
log "1. Tests fonctionnels complets"
log "2. Tests de performance"
log "3. Basculement DNS/Load Balancer"
log "4. Monitoring post-migration"
log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
```

### Optimisations de performance pour migration logique

```bash
#!/bin/bash
# optimized_import.sh
# Import optimisÃ© pour trÃ¨s grandes bases

# Configuration cible pour import rapide
mysql -h $TARGET -e "
-- DÃ©sactiver les checks pendant l'import
SET GLOBAL foreign_key_checks = 0;
SET GLOBAL unique_checks = 0;

-- Optimiser InnoDB pour bulk insert
SET GLOBAL innodb_flush_log_at_trx_commit = 0;
SET GLOBAL innodb_doublewrite = 0;
SET GLOBAL sync_binlog = 0;

-- Augmenter les buffers
SET GLOBAL innodb_buffer_pool_size = 8589934592;  -- 8 GB
SET GLOBAL innodb_log_buffer_size = 268435456;    -- 256 MB
SET GLOBAL bulk_insert_buffer_size = 536870912;   -- 512 MB

-- DÃ©sactiver le binlog si pas de rÃ©plication
SET GLOBAL sql_log_bin = 0;

-- Mode d'import optimisÃ©
SET GLOBAL innodb_autoinc_lock_mode = 2;
"

# AprÃ¨s l'import, restaurer les valeurs normales
mysql -h $TARGET -e "
SET GLOBAL foreign_key_checks = 1;
SET GLOBAL unique_checks = 1;
SET GLOBAL innodb_flush_log_at_trx_commit = 1;
SET GLOBAL innodb_doublewrite = 1;
SET GLOBAL sync_binlog = 1;
SET GLOBAL sql_log_bin = 1;
SET GLOBAL innodb_autoinc_lock_mode = 1;
"
```

### Avantages et limitations de la migration logique

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LOGIQUE : AVANTAGES                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  âœ… PortabilitÃ©                                                     â”‚
â”‚     â€¢ Fonctionne entre versions incompatibles                       â”‚
â”‚     â€¢ MySQL 8+ â†’ MariaDB possible                                   â”‚
â”‚     â€¢ Cross-platform (Linux â†’ Windows, etc.)                        â”‚
â”‚                                                                     â”‚
â”‚  âœ… Rollback facile                                                 â”‚
â”‚     â€¢ Source intacte pendant tout le processus                      â”‚
â”‚     â€¢ Rollback = repointer vers la source                           â”‚
â”‚     â€¢ Aucune restauration nÃ©cessaire                                â”‚
â”‚                                                                     â”‚
â”‚  âœ… Test prÃ©alable                                                  â”‚
â”‚     â€¢ Validation complÃ¨te sur la cible avant cutover                â”‚
â”‚     â€¢ Tests de performance rÃ©alistes                                â”‚
â”‚     â€¢ DÃ©tection des problÃ¨mes Ã  l'avance                            â”‚
â”‚                                                                     â”‚
â”‚  âœ… Optimisation                                                    â”‚
â”‚     â€¢ DÃ©fragmentation automatique                                   â”‚
â”‚     â€¢ Reconstruction des index                                      â”‚
â”‚     â€¢ PossibilitÃ© de restructurer                                   â”‚
â”‚                                                                     â”‚
â”‚  âœ… FlexibilitÃ©                                                     â”‚
â”‚     â€¢ Migration sÃ©lective (certaines tables/bases)                  â”‚
â”‚     â€¢ Transformation pendant la migration                           â”‚
â”‚     â€¢ Changement de structure possible                              â”‚
â”‚                                                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    LOGIQUE : LIMITATIONS                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  âŒ Temps                                                           â”‚
â”‚     â€¢ Beaucoup plus long que in-place                               â”‚
â”‚     â€¢ Export + Import peuvent prendre des heures/jours              â”‚
â”‚                                                                     â”‚
â”‚  âŒ Ressources                                                      â”‚
â”‚     â€¢ Espace disque pour le dump                                    â”‚
â”‚     â€¢ Serveur cible nÃ©cessaire                                      â”‚
â”‚     â€¢ CPU/IO intensifs pendant export/import                        â”‚
â”‚                                                                     â”‚
â”‚  âŒ Downtime pour synchronisation finale                            â”‚
â”‚     â€¢ FenÃªtre de freeze pour derniÃ¨re synchro                       â”‚
â”‚     â€¢ Ou setup de rÃ©plication complexe                              â”‚
â”‚                                                                     â”‚
â”‚  âŒ Historique System-Versioned                                     â”‚
â”‚     â€¢ L'historique peut nÃ©cessiter traitement spÃ©cial               â”‚
â”‚     â€¢ Timestamps rÃ©gÃ©nÃ©rÃ©s lors de l'import                         â”‚
â”‚                                                                     â”‚
â”‚  âŒ ComplexitÃ©                                                      â”‚
â”‚     â€¢ Plus d'Ã©tapes Ã  gÃ©rer                                         â”‚
â”‚     â€¢ Plus de points de dÃ©faillance potentiels                      â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Comparaison dÃ©taillÃ©e

### Benchmarks de performance

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              BENCHMARKS : IN-PLACE vs LOGIQUE                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚  Taille base: 100 GB (InnoDB, 200 tables)                          â”‚
â”‚  Hardware: 16 cores, 64 GB RAM, SSD NVMe                           â”‚
â”‚                                                                    â”‚
â”‚  OpÃ©ration                    â”‚ In-Place  â”‚ Logique (mydumper)     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  Backup prÃ©alable             â”‚ 15 min    â”‚ N/A (source intacte)   â”‚
â”‚  ArrÃªt service                â”‚ 1 min     â”‚ N/A                    â”‚
â”‚  Installation packages        â”‚ 5 min     â”‚ 5 min (autre serveur)  â”‚
â”‚  Export donnÃ©es               â”‚ N/A       â”‚ 45 min                 â”‚
â”‚  Import donnÃ©es               â”‚ N/A       â”‚ 60 min                 â”‚
â”‚  mariadb-upgrade              â”‚ 10 min    â”‚ N/A                    â”‚
â”‚  Validation                   â”‚ 5 min     â”‚ 15 min                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  TOTAL DOWNTIME               â”‚ ~35 min   â”‚ ~5 min (cutover seul)  â”‚
â”‚  TOTAL DURÃ‰E PROCESSUS        â”‚ ~35 min   â”‚ ~2h30                  â”‚
â”‚                                                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                    â”‚
â”‚  Taille base: 1 TB (InnoDB, 500 tables)                            â”‚
â”‚                                                                    â”‚
â”‚  OpÃ©ration                    â”‚ In-Place  â”‚ Logique (mydumper)     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  Backup prÃ©alable             â”‚ 2h        â”‚ N/A                    â”‚
â”‚  Export donnÃ©es               â”‚ N/A       â”‚ 6h                     â”‚
â”‚  Import donnÃ©es               â”‚ N/A       â”‚ 8h                     â”‚
â”‚  mariadb-upgrade              â”‚ 1h        â”‚ N/A                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  TOTAL DOWNTIME               â”‚ ~4h       â”‚ ~10 min (cutover)      â”‚
â”‚  TOTAL DURÃ‰E PROCESSUS        â”‚ ~4h       â”‚ ~16h                   â”‚
â”‚                                                                    â”‚
â”‚  Note: Avec CDC (Debezium), le downtime logique â†’ quasi-zero       â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Matrice de dÃ©cision

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MATRICE DE DÃ‰CISION                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  CritÃ¨re                        â”‚ Recommandation                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  Volume < 100 GB                â”‚ IN-PLACE (rapide et simple)       â”‚
â”‚  Volume 100-500 GB              â”‚ Au choix selon contraintes        â”‚
â”‚  Volume > 500 GB                â”‚ LOGIQUE (meilleur contrÃ´le)       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  Downtime illimitÃ©              â”‚ IN-PLACE (plus simple)            â”‚
â”‚  Downtime < 1h                  â”‚ IN-PLACE si petit, sinon LOGIQUE  â”‚
â”‚  Downtime < 10 min              â”‚ LOGIQUE + rÃ©plication             â”‚
â”‚  Zero downtime                  â”‚ LOGIQUE + CDC (Debezium)          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  MySQL 5.x â†’ MariaDB            â”‚ IN-PLACE possible                 â”‚
â”‚  MySQL 8+ â†’ MariaDB             â”‚ LOGIQUE REQUIS                    â”‚
â”‚  MariaDB â†’ MariaDB (minor)      â”‚ IN-PLACE prÃ©fÃ©rÃ©                  â”‚
â”‚  MariaDB â†’ MariaDB (major)      â”‚ Au choix                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  Rollback rapide requis         â”‚ LOGIQUE (source intacte)          â”‚
â”‚  Test prÃ©alable requis          â”‚ LOGIQUE (validation avant)        â”‚
â”‚  Restructuration schÃ©ma         â”‚ LOGIQUE (flexibilitÃ©)             â”‚
â”‚  System-Versioned Ã  prÃ©server   â”‚ IN-PLACE ou LOGIQUE avec soin     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  Ã‰quipe expÃ©rimentÃ©e            â”‚ Au choix                          â”‚
â”‚  Ã‰quipe moins expÃ©rimentÃ©e      â”‚ IN-PLACE (moins d'Ã©tapes)         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  Budget serveur limitÃ©          â”‚ IN-PLACE (mÃªme serveur)           â”‚
â”‚  Serveur cible disponible       â”‚ LOGIQUE (meilleure sÃ©curitÃ©)      â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ†• Gestion des System-Versioned Tables (MariaDB 11.8)

### DiffÃ©rences de comportement

```sql
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
--        SYSTEM-VERSIONED TABLES : IN-PLACE vs LOGIQUE
-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

-- Structure exemple
CREATE TABLE employees (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100),
    salary DECIMAL(10,2),
    row_start TIMESTAMP(6) GENERATED ALWAYS AS ROW START INVISIBLE,
    row_end TIMESTAMP(6) GENERATED ALWAYS AS ROW END INVISIBLE,
    PERIOD FOR SYSTEM_TIME (row_start, row_end)
) WITH SYSTEM VERSIONING;

-- DonnÃ©es et historique
INSERT INTO employees (name, salary) VALUES ('Alice', 50000);
UPDATE employees SET salary = 55000 WHERE name = 'Alice';
UPDATE employees SET salary = 60000 WHERE name = 'Alice';

-- VÃ©rifier l'historique
SELECT *, row_start, row_end 
FROM employees FOR SYSTEM_TIME ALL 
ORDER BY row_start;

-- RÃ©sultat attendu :
-- id | name  | salary | row_start           | row_end
-- 1  | Alice | 50000  | 2025-01-01 10:00:00 | 2025-01-01 11:00:00
-- 1  | Alice | 55000  | 2025-01-01 11:00:00 | 2025-01-01 12:00:00
-- 1  | Alice | 60000  | 2025-01-01 12:00:00 | 2038-01-19 03:14:07  (avant 11.8)
-- 1  | Alice | 60000  | 2025-01-01 12:00:00 | 2106-02-07 06:28:15  (11.8+)
```

### In-Place : PrÃ©servation de l'historique

```bash
#!/bin/bash
# svt_inplace_upgrade.sh
# Upgrade in-place avec System-Versioned Tables

set -e

log() {
    echo "[$(date)] $1"
}

# 1. Identifier les SVT
log "Identification des System-Versioned Tables..."
SVT_LIST=$(mariadb -BNe "
    SELECT CONCAT(TABLE_SCHEMA, '.', TABLE_NAME)
    FROM information_schema.TABLES 
    WHERE CREATE_OPTIONS LIKE '%versioning%'
")

SVT_COUNT=$(echo "$SVT_LIST" | wc -l)
log "Tables System-Versioned: $SVT_COUNT"

# 2. Sauvegarder les mÃ©tadonnÃ©es de versioning
log "Sauvegarde mÃ©tadonnÃ©es versioning..."
for TABLE in $SVT_LIST; do
    SCHEMA=$(echo $TABLE | cut -d'.' -f1)
    TNAME=$(echo $TABLE | cut -d'.' -f2)
    
    mariadb -BNe "
        SELECT 'HISTORY_COUNT', COUNT(*) 
        FROM $TABLE FOR SYSTEM_TIME ALL
        WHERE row_end < '9999-12-31';
    " > /tmp/svt_${SCHEMA}_${TNAME}_before.txt
    
    mariadb -BNe "
        SELECT MIN(row_start), MAX(row_end)
        FROM $TABLE FOR SYSTEM_TIME ALL;
    " >> /tmp/svt_${SCHEMA}_${TNAME}_before.txt
done

# 3. Effectuer l'upgrade in-place standard
# ... (procÃ©dure standard)

# 4. AprÃ¨s l'upgrade, convertir le format 11.8
log "Conversion format timestamp 11.8..."
for TABLE in $SVT_LIST; do
    log "  ALTER TABLE $TABLE FORCE..."
    mariadb -e "ALTER TABLE $TABLE FORCE;" 2>&1
done

# 5. Valider l'historique
log "Validation de l'historique..."
ERRORS=0
for TABLE in $SVT_LIST; do
    SCHEMA=$(echo $TABLE | cut -d'.' -f1)
    TNAME=$(echo $TABLE | cut -d'.' -f2)
    
    BEFORE_COUNT=$(grep "HISTORY_COUNT" /tmp/svt_${SCHEMA}_${TNAME}_before.txt | awk '{print $2}')
    AFTER_COUNT=$(mariadb -BNe "
        SELECT COUNT(*) FROM $TABLE FOR SYSTEM_TIME ALL
        WHERE row_end < '9999-12-31';
    ")
    
    if [ "$BEFORE_COUNT" != "$AFTER_COUNT" ]; then
        log "  âš  $TABLE: historique diffÃ©rent (avant: $BEFORE_COUNT, aprÃ¨s: $AFTER_COUNT)"
        ERRORS=$((ERRORS + 1))
    else
        log "  âœ“ $TABLE: historique prÃ©servÃ© ($AFTER_COUNT enregistrements)"
    fi
done

if [ $ERRORS -gt 0 ]; then
    log "ATTENTION: $ERRORS tables avec diffÃ©rences d'historique"
else
    log "Toutes les tables validÃ©es avec succÃ¨s"
fi
```

### Migration Logique : PrÃ©servation de l'historique

```bash
#!/bin/bash
# svt_logical_migration.sh
# Migration logique avec prÃ©servation historique System-Versioned

set -e

SOURCE_HOST="source-db"
TARGET_HOST="target-db"
DATABASE="production"

log() {
    echo "[$(date)] $1"
}

# 1. Identifier les SVT sur la source
log "Identification des System-Versioned Tables..."
SVT_TABLES=$(mysql -h $SOURCE_HOST -BNe "
    SELECT TABLE_NAME
    FROM information_schema.TABLES 
    WHERE TABLE_SCHEMA = '$DATABASE'
    AND CREATE_OPTIONS LIKE '%versioning%'
")

# 2. Pour chaque SVT, exporter avec l'historique
for TABLE in $SVT_TABLES; do
    log "Export de $TABLE avec historique..."
    
    # 2.1 Exporter la structure
    mariadb-dump -h $SOURCE_HOST \
        --no-data \
        $DATABASE $TABLE > /tmp/${TABLE}_schema.sql
    
    # 2.2 Modifier la structure pour import sans versioning initial
    sed -i 's/WITH SYSTEM VERSIONING//' /tmp/${TABLE}_schema.sql
    sed -i 's/GENERATED ALWAYS AS ROW START//' /tmp/${TABLE}_schema.sql
    sed -i 's/GENERATED ALWAYS AS ROW END//' /tmp/${TABLE}_schema.sql
    sed -i 's/PERIOD FOR SYSTEM_TIME ([^)]*)//' /tmp/${TABLE}_schema.sql
    sed -i 's/INVISIBLE//' /tmp/${TABLE}_schema.sql
    
    # 2.3 Exporter toutes les donnÃ©es (courantes + historiques)
    mysql -h $SOURCE_HOST -BNe "
        SELECT * FROM $DATABASE.$TABLE FOR SYSTEM_TIME ALL
    " > /tmp/${TABLE}_all_data.csv
    
    # 2.4 Exporter les mÃ©tadonnÃ©es de versioning
    mysql -h $SOURCE_HOST -BNe "
        SELECT 
            id,
            row_start,
            row_end,
            CASE WHEN row_end = '2038-01-19 03:14:07.999999' OR row_end > NOW() 
                 THEN 'CURRENT' ELSE 'HISTORY' END as record_type
        FROM $DATABASE.$TABLE FOR SYSTEM_TIME ALL
    " > /tmp/${TABLE}_versioning_meta.csv
done

# 3. CrÃ©er les tables sur la cible
log "CrÃ©ation des tables sur la cible..."
for TABLE in $SVT_TABLES; do
    mysql -h $TARGET_HOST $DATABASE < /tmp/${TABLE}_schema.sql
done

# 4. Importer les donnÃ©es
log "Import des donnÃ©es..."
for TABLE in $SVT_TABLES; do
    log "  Import $TABLE..."
    
    # Import via LOAD DATA
    mysql -h $TARGET_HOST $DATABASE -e "
        LOAD DATA LOCAL INFILE '/tmp/${TABLE}_all_data.csv'
        INTO TABLE $TABLE
        FIELDS TERMINATED BY '\t'
        LINES TERMINATED BY '\n';
    "
done

# 5. RÃ©activer le versioning
log "RÃ©activation du System Versioning..."
for TABLE in $SVT_TABLES; do
    log "  ALTER $TABLE..."
    
    # Obtenir les colonnes row_start/row_end originales
    mysql -h $TARGET_HOST $DATABASE -e "
        ALTER TABLE $TABLE
        MODIFY row_start TIMESTAMP(6) GENERATED ALWAYS AS ROW START,
        MODIFY row_end TIMESTAMP(6) GENERATED ALWAYS AS ROW END,
        ADD PERIOD FOR SYSTEM_TIME (row_start, row_end),
        ADD SYSTEM VERSIONING;
    "
done

# 6. Validation
log "Validation..."
for TABLE in $SVT_TABLES; do
    SOURCE_COUNT=$(mysql -h $SOURCE_HOST -BNe "
        SELECT COUNT(*) FROM $DATABASE.$TABLE FOR SYSTEM_TIME ALL
    ")
    TARGET_COUNT=$(mysql -h $TARGET_HOST -BNe "
        SELECT COUNT(*) FROM $DATABASE.$TABLE FOR SYSTEM_TIME ALL
    ")
    
    if [ "$SOURCE_COUNT" = "$TARGET_COUNT" ]; then
        log "  âœ“ $TABLE: OK ($TARGET_COUNT enregistrements)"
    else
        log "  âœ— $TABLE: DIFFÃ‰RENT (source: $SOURCE_COUNT, cible: $TARGET_COUNT)"
    fi
done
```

---

## StratÃ©gies hybrides

### Migration logique avec rÃ©plication pour zero-downtime

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          STRATÃ‰GIE HYBRIDE : LOGIQUE + RÃ‰PLICATION                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  Ã‰tape 1 : Export initial (source continue de fonctionner)          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                     â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚     â”‚   SOURCE     â”‚   mydumper avec      â”‚    CIBLE     â”‚          â”‚
â”‚     â”‚  MariaDB     â”‚   --lock-all-tables  â”‚  MariaDB     â”‚          â”‚
â”‚     â”‚  (ACTIF)     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶  (VIDE)      â”‚          â”‚
â”‚     â”‚              â”‚   Capture position   â”‚              â”‚          â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   binlog             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                     â”‚
â”‚  Ã‰tape 2 : Import initial sur la cible                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                     â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚     â”‚   SOURCE     â”‚                      â”‚    CIBLE     â”‚          â”‚
â”‚     â”‚  (ACTIF)     â”‚                      â”‚  myloader    â”‚          â”‚
â”‚     â”‚  continue    â”‚                      â”‚  (IMPORT)    â”‚          â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                     â”‚
â”‚  Ã‰tape 3 : Configuration rÃ©plication catch-up                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                     â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    RÃ©plication       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚     â”‚   SOURCE     â”‚ â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â–¶  â”‚    CIBLE     â”‚          â”‚
â”‚     â”‚  (ACTIF)     â”‚    binlog-based      â”‚  (REPLICA)   â”‚          â”‚
â”‚     â”‚              â”‚    rattrape delta    â”‚              â”‚          â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                     â”‚
â”‚  Ã‰tape 4 : Cutover (quelques secondes de freeze)                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                     â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚     â”‚   SOURCE     â”‚   1. read_only=ON    â”‚    CIBLE     â”‚          â”‚
â”‚     â”‚  (FREEZE)    â”‚   2. Attendre sync   â”‚  (SYNC)      â”‚          â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   3. STOP SLAVE      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚            â”‚           4. Switch VIP              â”‚                 â”‚
â”‚            â”‚                                      â”‚                 â”‚
â”‚            â–¼                                      â–¼                 â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚     â”‚   SOURCE     â”‚                      â”‚    CIBLE     â”‚          â”‚
â”‚     â”‚  (STANDBY)   â”‚                      â”‚  (ACTIF)     â”‚          â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Script de migration hybride

```bash
#!/bin/bash
# hybrid_migration.sh
# Migration logique avec rÃ©plication pour zero-downtime

set -e

SOURCE="source-db"
TARGET="target-db"
EXPORT_DIR="/backup/hybrid-migration"

log() {
    echo "[$(date '+%H:%M:%S')] $1"
}

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 1 : EXPORT AVEC POSITION BINLOG
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

log "=== PHASE 1: Export avec capture position binlog ==="

mkdir -p $EXPORT_DIR

# Export avec lock global temporaire pour capturer la position
mydumper \
    --host=$SOURCE \
    --user=migration_user \
    --password='MigrationP@ss' \
    --outputdir=$EXPORT_DIR \
    --threads=8 \
    --compress \
    --trx-consistency-only \
    --triggers \
    --routines \
    --events

# La position binlog est dans le fichier metadata
BINLOG_FILE=$(grep "Log:" $EXPORT_DIR/metadata | awk '{print $2}')
BINLOG_POS=$(grep "Pos:" $EXPORT_DIR/metadata | awk '{print $2}')

log "Position binlog capturÃ©e: $BINLOG_FILE:$BINLOG_POS"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 2 : IMPORT SUR LA CIBLE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

log "=== PHASE 2: Import sur la cible ==="

# Optimiser la cible pour l'import
ssh $TARGET "mysql -e '
    SET GLOBAL foreign_key_checks = 0;
    SET GLOBAL unique_checks = 0;
    SET GLOBAL innodb_flush_log_at_trx_commit = 0;
'"

# Import parallÃ¨le
myloader \
    --host=$TARGET \
    --user=root \
    --password='RootP@ss' \
    --directory=$EXPORT_DIR \
    --threads=8 \
    --overwrite-tables

# Restaurer les paramÃ¨tres
ssh $TARGET "mysql -e '
    SET GLOBAL foreign_key_checks = 1;
    SET GLOBAL unique_checks = 1;
    SET GLOBAL innodb_flush_log_at_trx_commit = 1;
'"

log "Import terminÃ©"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 3 : CONFIGURATION RÃ‰PLICATION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

log "=== PHASE 3: Configuration rÃ©plication catch-up ==="

# Configurer la rÃ©plication sur la cible
ssh $TARGET "mysql -e \"
    CHANGE MASTER TO
        MASTER_HOST='$SOURCE',
        MASTER_USER='repl_user',
        MASTER_PASSWORD='ReplP@ss',
        MASTER_LOG_FILE='$BINLOG_FILE',
        MASTER_LOG_POS=$BINLOG_POS;
    START SLAVE;
\""

# Attendre la synchronisation
log "Attente synchronisation..."
while true; do
    LAG=$(ssh $TARGET "mysql -BNe \"SHOW SLAVE STATUS\\G\" | grep Seconds_Behind_Master | awk '{print \$2}'")
    SLAVE_IO=$(ssh $TARGET "mysql -BNe \"SHOW SLAVE STATUS\\G\" | grep Slave_IO_Running | awk '{print \$2}'")
    SLAVE_SQL=$(ssh $TARGET "mysql -BNe \"SHOW SLAVE STATUS\\G\" | grep Slave_SQL_Running | awk '{print \$2}'")
    
    log "Lag: ${LAG}s, IO: $SLAVE_IO, SQL: $SLAVE_SQL"
    
    if [ "$LAG" = "0" ] && [ "$SLAVE_IO" = "Yes" ] && [ "$SLAVE_SQL" = "Yes" ]; then
        break
    fi
    
    if [ "$SLAVE_IO" != "Yes" ] || [ "$SLAVE_SQL" != "Yes" ]; then
        log "ERREUR: RÃ©plication arrÃªtÃ©e!"
        ssh $TARGET "mysql -e 'SHOW SLAVE STATUS\\G'"
        exit 1
    fi
    
    sleep 10
done

log "RÃ©plication synchronisÃ©e"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PHASE 4 : CUTOVER
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

log "=== PHASE 4: Cutover ==="
echo ""
echo "La cible est synchronisÃ©e et prÃªte pour le cutover."
echo ""
echo "Pour effectuer le cutover:"
echo "1. Mettre la source en read-only: SET GLOBAL read_only = ON;"
echo "2. Attendre que lag = 0"
echo "3. ArrÃªter la rÃ©plication: STOP SLAVE; RESET SLAVE ALL;"
echo "4. Basculer le VIP / DNS vers la cible"
echo "5. Mettre la cible en read-write si nÃ©cessaire"
echo ""
read -p "ExÃ©cuter le cutover maintenant? (yes/no): " CONFIRM

if [ "$CONFIRM" = "yes" ]; then
    log "ExÃ©cution cutover..."
    
    # 1. Read-only sur source
    log "Source â†’ read_only..."
    ssh $SOURCE "mysql -e 'SET GLOBAL read_only = ON;'"
    
    # 2. Attendre sync finale
    sleep 5
    while true; do
        LAG=$(ssh $TARGET "mysql -BNe \"SHOW SLAVE STATUS\\G\" | grep Seconds_Behind_Master | awk '{print \$2}'")
        if [ "$LAG" = "0" ]; then
            break
        fi
        sleep 1
    done
    
    # 3. ArrÃªter rÃ©plication
    log "ArrÃªt rÃ©plication..."
    ssh $TARGET "mysql -e 'STOP SLAVE; RESET SLAVE ALL;'"
    
    # 4. Basculer (exemple avec mise Ã  jour DNS)
    log "Basculement VIP..."
    # ssh dns-server "nsupdate -k /etc/rndc.key << EOF
    # update delete db.example.com A
    # update add db.example.com 60 A $(dig +short $TARGET)
    # send
    # EOF"
    
    log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    log "           CUTOVER TERMINÃ‰ - CIBLE ACTIVE"
    log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
else
    log "Cutover reportÃ©. RÃ©plication continue de fonctionner."
fi
```

---

## Rollback selon la stratÃ©gie

### Rollback In-Place

```bash
#!/bin/bash
# rollback_inplace.sh

BACKUP_DIR=$1

if [ ! -d "$BACKUP_DIR/physical" ]; then
    echo "ERREUR: Backup physique non trouvÃ© dans $BACKUP_DIR"
    exit 1
fi

echo "=== ROLLBACK IN-PLACE ==="
echo "Backup: $BACKUP_DIR"
echo ""
echo "ATTENTION: Cette opÃ©ration va:"
echo "1. ArrÃªter MariaDB"
echo "2. Supprimer les donnÃ©es actuelles"
echo "3. Restaurer depuis le backup"
echo "4. RÃ©installer l'ancienne version"
echo ""
read -p "Continuer? (yes/no): " CONFIRM

if [ "$CONFIRM" != "yes" ]; then
    exit 0
fi

# 1. ArrÃªter MariaDB
systemctl stop mariadb

# 2. Sauvegarder l'Ã©tat actuel (au cas oÃ¹)
mv /var/lib/mysql /var/lib/mysql.failed.$(date +%Y%m%d%H%M%S)

# 3. Restaurer le backup
mariabackup --copy-back --target-dir=$BACKUP_DIR/physical
chown -R mysql:mysql /var/lib/mysql

# 4. RÃ©installer l'ancienne version
OLD_VERSION=$(cat $BACKUP_DIR/installed_packages.txt | grep mariadb-server | head -1 | awk '{print $3}')
echo "RÃ©installation de MariaDB $OLD_VERSION..."

# Debian/Ubuntu
apt-get install -y --allow-downgrades mariadb-server=$OLD_VERSION

# 5. DÃ©marrer
systemctl start mariadb

# 6. VÃ©rifier
mariadb -e "SELECT VERSION();"

echo "=== ROLLBACK TERMINÃ‰ ==="
```

### Rollback Migration Logique

```bash
#!/bin/bash
# rollback_logical.sh

SOURCE=$1
TARGET=$2

echo "=== ROLLBACK MIGRATION LOGIQUE ==="
echo ""
echo "La migration logique laisse la source intacte."
echo "Le rollback consiste simplement Ã  repointer vers la source."
echo ""
echo "Source (ancienne): $SOURCE"
echo "Cible (nouvelle):  $TARGET"
echo ""

# 1. VÃ©rifier que la source est accessible
mysql -h $SOURCE -e "SELECT VERSION();" || {
    echo "ERREUR: Source inaccessible!"
    exit 1
}

echo "Source accessible âœ“"

# 2. Actions Ã  effectuer manuellement
echo ""
echo "Actions pour le rollback:"
echo "1. Mettre la cible en read-only (si elle a reÃ§u des Ã©critures)"
echo "   mysql -h $TARGET -e 'SET GLOBAL read_only = ON;'"
echo ""
echo "2. Basculer le VIP/DNS vers la source"
echo "   Modifier la configuration du load balancer ou DNS"
echo ""
echo "3. VÃ©rifier que les applications utilisent la source"
echo ""
echo "4. (Optionnel) ArrÃªter la cible"
echo "   ssh $TARGET systemctl stop mariadb"
echo ""

read -p "ExÃ©cuter le rollback automatisÃ©? (yes/no): " CONFIRM

if [ "$CONFIRM" = "yes" ]; then
    # Mettre cible en read-only
    mysql -h $TARGET -e "SET GLOBAL read_only = ON;" 2>/dev/null || true
    
    echo ""
    echo "Cible mise en read-only."
    echo "Veuillez basculer le trafic manuellement vers $SOURCE"
    echo ""
    echo "=== ROLLBACK PRÃ‰PARÃ‰ ==="
fi
```

---

## Checklist comparative

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CHECKLIST : IN-PLACE                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  AVANT                                                              â”‚
â”‚  â–¡ VÃ©rifier compatibilitÃ© des versions                              â”‚
â”‚  â–¡ VÃ©rifier espace disque (backup)                                  â”‚
â”‚  â–¡ Backup physique avec Mariabackup                                 â”‚
â”‚  â–¡ Backup configuration (/etc/mysql)                                â”‚
â”‚  â–¡ Tester le backup (restauration partielle)                        â”‚
â”‚  â–¡ Identifier les System-Versioned Tables                           â”‚
â”‚  â–¡ Planifier la fenÃªtre de maintenance                              â”‚
â”‚  â–¡ Notifier les utilisateurs                                        â”‚
â”‚                                                                     â”‚
â”‚  PENDANT                                                            â”‚
â”‚  â–¡ innodb_fast_shutdown = 0                                         â”‚
â”‚  â–¡ ArrÃªter les connexions applicatives                              â”‚
â”‚  â–¡ ArrÃªter MariaDB proprement                                       â”‚
â”‚  â–¡ Installer nouvelle version                                       â”‚
â”‚  â–¡ DÃ©marrer MariaDB                                                 â”‚
â”‚  â–¡ ExÃ©cuter mariadb-upgrade                                         â”‚
â”‚  â–¡ ğŸ†• ALTER TABLE ... FORCE pour SVT (11.8)                          â”‚
â”‚                                                                     â”‚
â”‚  APRÃˆS                                                              â”‚
â”‚  â–¡ VÃ©rifier les logs d'erreur                                       â”‚
â”‚  â–¡ mysqlcheck --all-databases                                       â”‚
â”‚  â–¡ Tester les connexions applicatives                               â”‚
â”‚  â–¡ Monitoring 24-48h                                                â”‚
â”‚  â–¡ Conserver backup 1 semaine                                       â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CHECKLIST : LOGIQUE                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  AVANT                                                              â”‚
â”‚  â–¡ Provisionner serveur cible                                       â”‚
â”‚  â–¡ Installer MariaDB version cible                                  â”‚
â”‚  â–¡ VÃ©rifier espace disque (export + cible)                          â”‚
â”‚  â–¡ Configurer accÃ¨s rÃ©seau source â†’ cible                           â”‚
â”‚  â–¡ PrÃ©parer scripts de transformation si nÃ©cessaire                 â”‚
â”‚  â–¡ Planifier le cutover                                             â”‚
â”‚                                                                     â”‚
â”‚  EXPORT                                                             â”‚
â”‚  â–¡ Choisir outil (mysqldump, mydumper)                              â”‚
â”‚  â–¡ Export avec capture position binlog                              â”‚
â”‚  â–¡ VÃ©rifier intÃ©gritÃ© de l'export                                   â”‚
â”‚  â–¡ Transformer si nÃ©cessaire (collations, etc.)                     â”‚
â”‚                                                                     â”‚
â”‚  IMPORT                                                             â”‚
â”‚  â–¡ Optimiser cible pour bulk insert                                 â”‚
â”‚  â–¡ Importer structure                                               â”‚
â”‚  â–¡ Importer donnÃ©es                                                 â”‚
â”‚  â–¡ VÃ©rifier comptages                                               â”‚
â”‚  â–¡ Importer routines, triggers, events                              â”‚
â”‚  â–¡ Importer utilisateurs et privilÃ¨ges                              â”‚
â”‚                                                                     â”‚
â”‚  SYNCHRONISATION (si rÃ©plication)                                   â”‚
â”‚  â–¡ Configurer rÃ©plication vers cible                                â”‚
â”‚  â–¡ Attendre synchronisation complÃ¨te                                â”‚
â”‚  â–¡ Valider lag = 0                                                  â”‚
â”‚                                                                     â”‚
â”‚  CUTOVER                                                            â”‚
â”‚  â–¡ Source â†’ read_only                                               â”‚
â”‚  â–¡ Attendre sync finale                                             â”‚
â”‚  â–¡ ArrÃªter rÃ©plication                                              â”‚
â”‚  â–¡ Basculer VIP/DNS                                                 â”‚
â”‚  â–¡ Valider accÃ¨s applicatif                                         â”‚
â”‚                                                                     â”‚
â”‚  APRÃˆS                                                              â”‚
â”‚  â–¡ ANALYZE tables                                                   â”‚
â”‚  â–¡ Monitoring intensif                                              â”‚
â”‚  â–¡ Conserver source en standby (rollback)                           â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… Points clÃ©s Ã  retenir

- **In-Place rapide, Logique sÃ»r** : L'in-place minimise le temps total, la migration logique minimise le risque

- **Taille critique : 500 GB** : Au-delÃ , la migration logique offre plus de contrÃ´le malgrÃ© la durÃ©e

- **MySQL 8+ â†’ MariaDB** : La migration logique est OBLIGATOIRE (format fichiers incompatible)

- **Zero-downtime** : Possible uniquement avec migration logique + rÃ©plication ou CDC

- **ğŸ†• System-Versioned Tables** : Attention au changement de format 11.8, utiliser ALTER TABLE FORCE aprÃ¨s upgrade

- **Rollback** : Toujours plus facile avec migration logique (source intacte)

- **Tests prÃ©alables** : Seule la migration logique permet de valider sur les vraies donnÃ©es avant cutover

- **Fragmentation** : La migration logique dÃ©fragmente automatiquement, pas l'in-place

---

## ğŸ”— Ressources et rÃ©fÃ©rences

- [ğŸ“– MariaDB Upgrade Documentation](https://mariadb.com/kb/en/upgrading/)
- [ğŸ“– mydumper Documentation](https://github.com/mydumper/mydumper)
- [ğŸ“– Mariabackup Documentation](https://mariadb.com/kb/en/mariabackup-overview/)
- [ğŸ“– System-Versioned Tables](https://mariadb.com/kb/en/system-versioned-tables/)
- [ğŸ“– Replication for Upgrade](https://mariadb.com/kb/en/replication-as-a-backup-solution/)
- [ğŸ“– pt-table-checksum](https://docs.percona.com/percona-toolkit/pt-table-checksum.html)

---


â­ï¸ [CompatibilitÃ© des applications](/19-migration-compatibilite/05-compatibilite-applications.md)
