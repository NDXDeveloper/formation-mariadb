üîù Retour au [Sommaire](/SOMMAIRE.md)

# 19.1.1 Compatibilit√© MySQL/MariaDB

> **Niveau** : Avanc√© √† Expert  
> **Dur√©e estim√©e** : 4-5 heures  
> **Pr√©requis** : Connaissance approfondie de MySQL ou MariaDB, exp√©rience en administration de bases de donn√©es, compr√©hension des architectures de production

## üéØ Objectifs d'apprentissage

√Ä l'issue de cette section, vous serez capable de :
- √âvaluer la compatibilit√© entre MySQL et MariaDB pour un projet de migration
- Identifier les divergences critiques au niveau SQL, types de donn√©es et fonctionnalit√©s
- Planifier une strat√©gie de migration minimisant les risques applicatifs
- Anticiper les incompatibilit√©s potentielles selon les versions source et cible
- Mettre en ≈ìuvre des tests de compatibilit√© robustes avant migration

---

## Introduction

MariaDB est n√© en 2009 comme un fork de MySQL 5.1, cr√©√© par Michael "Monty" Widenius, le fondateur original de MySQL, suite au rachat de Sun Microsystems (et donc de MySQL) par Oracle. L'objectif initial √©tait de maintenir une compatibilit√© totale avec MySQL tout en garantissant un d√©veloppement ouvert et communautaire.

Quinze ans plus tard, la r√©alit√© est plus nuanc√©e. Si MariaDB conserve une **compatibilit√© √©lev√©e** avec MySQL, les deux projets ont diverg√© significativement. MariaDB 11.8 LTS repr√©sente aujourd'hui un SGBD mature avec ses propres innovations (Vector, System-Versioned Tables, ColumnStore), tandis que MySQL 8.x/9.x a d√©velopp√© des fonctionnalit√©s exclusives (Document Store, MySQL HeatWave).

Pour l'architecte ou le DBA planifiant une migration, comprendre pr√©cis√©ment le niveau de compatibilit√© et les points de divergence est **critique** pour √©viter les surprises en production.

---

## Niveaux de compatibilit√©

### Compatibilit√© du protocole client/serveur

MariaDB maintient une **compatibilit√© binaire** avec le protocole MySQL. Cela signifie que :

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    COMPATIBILIT√â PROTOCOLE                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  ‚úÖ Connecteurs MySQL fonctionnent avec MariaDB                 ‚îÇ
‚îÇ  ‚úÖ Applications existantes se connectent sans modification     ‚îÇ
‚îÇ  ‚úÖ Outils d'administration MySQL compatibles                   ‚îÇ
‚îÇ  ‚úÖ Drivers JDBC, ODBC, ADO.NET MySQL utilisables               ‚îÇ
‚îÇ  ‚ö†Ô∏è  Certaines fonctionnalit√©s avanc√©es peuvent diff√©rer        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

Les connecteurs officiels MariaDB (MariaDB Connector/J, MariaDB Connector/C, etc.) offrent cependant un support optimis√© pour les fonctionnalit√©s sp√©cifiques √† MariaDB.

### Compatibilit√© au niveau fichiers de donn√©es

La compatibilit√© au niveau des fichiers de donn√©es d√©pend fortement des versions :

| Sc√©nario | Compatibilit√© | Recommandation |
|----------|---------------|----------------|
| MySQL 5.7 ‚Üí MariaDB 10.x | √âlev√©e (m√™me format InnoDB) | Possible in-place avec pr√©cautions |
| MySQL 8.0 ‚Üí MariaDB 10.x/11.x | **Incompatible** | Migration logique obligatoire |
| MariaDB 10.x ‚Üí MySQL 8.x | **Incompatible** | Migration logique obligatoire |
| MySQL 5.6 ‚Üí MariaDB 11.8 | Migration logique recommand√©e | Trop d'√©cart de versions |

‚ö†Ô∏è **Attention critique** : √Ä partir de MySQL 8.0, Oracle a modifi√© le format interne des fichiers InnoDB et du dictionnaire de donn√©es. Une migration directe par copie de fichiers est **impossible** depuis MySQL 8.0 vers MariaDB.

### Compatibilit√© SQL et syntaxique

MariaDB supporte la grande majorit√© de la syntaxe SQL de MySQL, avec quelques extensions et diff√©rences :

```sql
-- Syntaxe commune MySQL/MariaDB (100% compatible)
SELECT * FROM users WHERE status = 'active' ORDER BY created_at DESC LIMIT 10;

CREATE TABLE orders (
    id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,
    user_id BIGINT UNSIGNED NOT NULL,
    total DECIMAL(10,2) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id)
) ENGINE=InnoDB;

-- Extensions MariaDB (non disponibles sur MySQL)
CREATE SEQUENCE order_seq START WITH 1000 INCREMENT BY 1;

CREATE TABLE audit_log (
    id BIGINT PRIMARY KEY,
    data JSON,
    valid_from TIMESTAMP(6) GENERATED ALWAYS AS ROW START,
    valid_to TIMESTAMP(6) GENERATED ALWAYS AS ROW END,
    PERIOD FOR SYSTEM_TIME (valid_from, valid_to)
) WITH SYSTEM VERSIONING;
```

---

## Divergences critiques par domaine

### Types de donn√©es

La plupart des types de donn√©es sont identiques, mais certaines diff√©rences existent :

```sql
-- Types communs (compatibles)
INT, BIGINT, SMALLINT, TINYINT, MEDIUMINT
VARCHAR(n), CHAR(n), TEXT, MEDIUMTEXT, LONGTEXT
DATE, TIME, DATETIME, TIMESTAMP
DECIMAL(p,s), FLOAT, DOUBLE
BLOB, MEDIUMBLOB, LONGBLOB
ENUM('val1', 'val2'), SET('val1', 'val2')
JSON -- Support√© par les deux, impl√©mentation diff√©rente

-- Types sp√©cifiques MariaDB (non disponibles sur MySQL)
INET6          -- Adresses IPv6 natives
UUID           -- Type UUID natif (MySQL utilise BINARY(16) ou VARCHAR(36))
```

üÜï **Nouveaut√© MariaDB 11.8** : Type `VECTOR` pour la recherche vectorielle

```sql
-- Type VECTOR exclusif √† MariaDB 11.8+
CREATE TABLE embeddings (
    id BIGINT PRIMARY KEY,
    content TEXT,
    embedding VECTOR(1536) NOT NULL,  -- Vecteur de 1536 dimensions
    VECTOR INDEX idx_embedding (embedding) 
        USING HNSW 
        WITH (M=16, ef_construction=200)
);
```

### Gestion du JSON

Les deux SGBD supportent le type JSON, mais l'impl√©mentation diff√®re :

| Aspect | MySQL 8.x | MariaDB 11.8 |
|--------|-----------|--------------|
| Stockage | Format binaire optimis√© | Format texte (LONGTEXT alias) |
| Validation | Validation stricte √† l'insertion | Validation optionnelle |
| Performance lecture | G√©n√©ralement plus rapide | Comparable avec index virtuels |
| Fonctions | `JSON_TABLE()`, `->>`  | `->>`  √©quivalent, pas de `JSON_TABLE()` natif |

üí° **Conseil** : Pour les applications JSON-intensives, testez les performances des deux c√¥t√©s. MySQL peut avoir un avantage sur les lectures JSON complexes, MariaDB compense avec les colonnes virtuelles index√©es.

```sql
-- Strat√©gie MariaDB pour optimiser JSON : colonnes virtuelles
CREATE TABLE products (
    id BIGINT PRIMARY KEY,
    data JSON,
    -- Colonnes virtuelles extraites du JSON
    category VARCHAR(100) AS (JSON_UNQUOTE(JSON_EXTRACT(data, '$.category'))) STORED,
    price DECIMAL(10,2) AS (JSON_EXTRACT(data, '$.price')) STORED,
    INDEX idx_category (category),
    INDEX idx_price (price)
);
```

### Authentification et s√©curit√©

Les plugins d'authentification ont diverg√© significativement :

```
MySQL 8.0+ :
‚îú‚îÄ‚îÄ caching_sha2_password (d√©faut)
‚îú‚îÄ‚îÄ mysql_native_password (deprecated 8.0, retir√© 8.4)
‚îú‚îÄ‚îÄ sha256_password
‚îî‚îÄ‚îÄ authentication_ldap_*

MariaDB 11.8 :
‚îú‚îÄ‚îÄ mysql_native_password (toujours support√©)
‚îú‚îÄ‚îÄ ed25519 (recommand√©, plus s√©curis√©)
‚îú‚îÄ‚îÄ gssapi (Kerberos)
‚îú‚îÄ‚îÄ pam
‚îî‚îÄ‚îÄ parsec (nouveau 11.8) üÜï
```

‚ö†Ô∏è **Point d'attention migration** : Si votre MySQL 8.x utilise `caching_sha2_password` (d√©faut), vous devrez :

```sql
-- Option 1 : Avant migration, sur MySQL, basculer les utilisateurs
ALTER USER 'app_user'@'%' IDENTIFIED WITH mysql_native_password BY 'password';

-- Option 2 : Apr√®s migration, sur MariaDB, recr√©er les utilisateurs
CREATE USER 'app_user'@'%' IDENTIFIED VIA ed25519 USING PASSWORD('password');
```

üÜï **MariaDB 11.8** : TLS est activ√© par d√©faut. Les connexions non chiffr√©es n√©cessitent une configuration explicite.

```ini
# my.cnf - Pour autoriser les connexions non-TLS (d√©conseill√© en production)
[mysqld]
require_secure_transport = OFF
```

### R√©plication

La r√©plication entre MySQL et MariaDB est possible mais avec des limitations :

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              MATRICE DE COMPATIBILIT√â R√âPLICATION                  ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  MySQL 5.7 Primary ‚Üí MariaDB 10.x Replica    ‚úÖ Support√©           ‚îÇ
‚îÇ  MySQL 8.0 Primary ‚Üí MariaDB 10.x/11.x       ‚ö†Ô∏è  Limit√© (GTID diff)‚îÇ
‚îÇ  MariaDB Primary ‚Üí MySQL Replica             ‚ùå Non recommand√©     ‚îÇ
‚îÇ  MariaDB ‚Üí MariaDB (versions diff√©rentes)    ‚úÖ Support√©           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

Les GTID (Global Transaction Identifiers) sont **incompatibles** entre MySQL et MariaDB :

```sql
-- Format GTID MySQL 8.x
-- source_id:transaction_id
-- Exemple : 3E11FA47-71CA-11E1-9E33-C80AA9429562:23

-- Format GTID MariaDB
-- domain_id-server_id-sequence_number
-- Exemple : 0-1-23
```

üí° **Strat√©gie de migration avec r√©plication** : Utilisez la r√©plication bas√©e sur les positions binlog (pas GTID) pour une migration progressive MySQL ‚Üí MariaDB.

---

## Fonctionnalit√©s exclusives et divergentes

### Fonctionnalit√©s MySQL sans √©quivalent direct MariaDB

| Fonctionnalit√© MySQL | Alternative MariaDB |
|---------------------|---------------------|
| MySQL Document Store (X DevAPI) | Utiliser JSON + colonnes virtuelles |
| MySQL HeatWave (analytics in-memory) | MariaDB ColumnStore |
| MySQL Group Replication | MariaDB Galera Cluster |
| MySQL InnoDB Cluster | Galera + MaxScale |
| MySQL Clone Plugin | Mariabackup + r√©plication |
| `EXPLAIN ANALYZE` (MySQL 8.0.18+) | `ANALYZE` statement, `EXPLAIN ANALYZE` (MariaDB 10.1+) |
| `JSON_TABLE()` | Requ√™tes alternatives avec `JSON_EXTRACT` |
| Invisible Indexes (MySQL 8.0) | `IGNORED` indexes (MariaDB 10.6+) |
| Histograms (automatiques 8.0) | Histograms (manuels, `ANALYZE TABLE ... PERSISTENT`) |

### Fonctionnalit√©s MariaDB sans √©quivalent MySQL

| Fonctionnalit√© MariaDB | Avantage |
|-----------------------|----------|
| System-Versioned Tables | Historisation automatique des donn√©es |
| üÜï Application Time Period Tables | Gestion temporelle applicative |
| Sequences (`CREATE SEQUENCE`) | Alternative flexible √† AUTO_INCREMENT |
| Spider Engine | Sharding natif int√©gr√© |
| ColumnStore | OLAP/analytics int√©gr√© |
| üÜï VECTOR type + HNSW Index | Recherche vectorielle pour IA/RAG |
| Oracle PL/SQL Compatibility Mode | Migration Oracle facilit√©e |
| `RETURNING` clause | Retour de valeurs apr√®s INSERT/UPDATE/DELETE |
| Thread Pool (Community) | Inclus en Community (payant chez MySQL) |
| MaxScale | Proxy intelligent avec routing avanc√© |

```sql
-- Exemple : RETURNING clause (MariaDB uniquement)
INSERT INTO orders (user_id, total) 
VALUES (42, 199.99) 
RETURNING id, created_at;

-- R√©sultat imm√©diat sans requ√™te suppl√©mentaire
-- +----+---------------------+
-- | id | created_at          |
-- +----+---------------------+
-- | 1  | 2025-12-15 10:30:00 |
-- +----+---------------------+
```

---

## Analyse de compatibilit√© par version

### Matrice de compatibilit√© versions

```
                        MariaDB Cible
                   10.6    10.11   11.4    11.8
MySQL Source       LTS     LTS     LTS     LTS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
5.5                 ‚òÖ‚òÖ‚òÖ‚òÖ    ‚òÖ‚òÖ‚òÖ‚òÖ    ‚òÖ‚òÖ‚òÖ‚òÜ    ‚òÖ‚òÖ‚òÖ‚òÜ
5.6                 ‚òÖ‚òÖ‚òÖ‚òÖ    ‚òÖ‚òÖ‚òÖ‚òÖ    ‚òÖ‚òÖ‚òÖ‚òÖ    ‚òÖ‚òÖ‚òÖ‚òÜ
5.7                 ‚òÖ‚òÖ‚òÖ‚òÖ    ‚òÖ‚òÖ‚òÖ‚òÖ    ‚òÖ‚òÖ‚òÖ‚òÖ    ‚òÖ‚òÖ‚òÖ‚òÖ
8.0                 ‚òÖ‚òÖ‚òÖ‚òÜ    ‚òÖ‚òÖ‚òÖ‚òÜ    ‚òÖ‚òÖ‚òÖ‚òÜ    ‚òÖ‚òÖ‚òÖ‚òÜ
8.4/9.0             ‚òÖ‚òÖ‚òÜ‚òÜ    ‚òÖ‚òÖ‚òÜ‚òÜ    ‚òÖ‚òÖ‚òÖ‚òÜ    ‚òÖ‚òÖ‚òÖ‚òÜ

L√©gende : ‚òÖ‚òÖ‚òÖ‚òÖ Excellente  ‚òÖ‚òÖ‚òÖ‚òÜ Bonne  ‚òÖ‚òÖ‚òÜ‚òÜ Mod√©r√©e  ‚òÖ‚òÜ‚òÜ‚òÜ Difficile
```

### Points d'attention MySQL 5.7 ‚Üí MariaDB 11.8

La migration depuis MySQL 5.7 est g√©n√©ralement la plus fluide :

```sql
-- V√©rification des incompatibilit√©s potentielles sur MySQL 5.7

-- 1. Identifier les tables avec des types probl√©matiques
SELECT TABLE_SCHEMA, TABLE_NAME, COLUMN_NAME, COLUMN_TYPE
FROM INFORMATION_SCHEMA.COLUMNS
WHERE COLUMN_TYPE LIKE '%generated%'
   OR DATA_TYPE = 'json';

-- 2. V√©rifier les proc√©dures stock√©es utilisant des syntaxes MySQL-sp√©cifiques
SELECT ROUTINE_SCHEMA, ROUTINE_NAME, ROUTINE_TYPE
FROM INFORMATION_SCHEMA.ROUTINES
WHERE ROUTINE_DEFINITION LIKE '%GET_LOCK%'
   OR ROUTINE_DEFINITION LIKE '%JSON_TABLE%';

-- 3. Analyser les utilisateurs et leurs m√©thodes d'authentification
SELECT User, Host, plugin 
FROM mysql.user 
WHERE plugin != 'mysql_native_password';
```

### Points d'attention MySQL 8.0+ ‚Üí MariaDB 11.8

La migration depuis MySQL 8.0+ n√©cessite plus d'attention :

```sql
-- Audit de compatibilit√© MySQL 8.0 ‚Üí MariaDB 11.8

-- 1. Fonctionnalit√©s MySQL 8.0 non support√©es
-- Rechercher l'utilisation de :
-- - CTEs r√©cursives avec syntaxe sp√©cifique MySQL
-- - Window functions avec frames GROUPS (support√© en MariaDB)
-- - JSON_TABLE() (non support√© nativement)
-- - CHECK constraints (support√©, syntaxe identique)

-- 2. Changements de comportement par d√©faut
-- MySQL 8.0 defaults vs MariaDB 11.8 :
-- sql_mode : MySQL plus strict par d√©faut
-- character_set : utf8mb4 des deux c√¥t√©s (11.8 üÜï)
-- collation : utf8mb4_0900_ai_ci (MySQL) vs utf8mb4_uca1400_ai_ci (MariaDB 11.8 üÜï)

-- 3. V√©rifier les collations utilis√©es
SELECT TABLE_SCHEMA, TABLE_NAME, TABLE_COLLATION
FROM INFORMATION_SCHEMA.TABLES
WHERE TABLE_COLLATION LIKE '%0900%';  -- Collations MySQL 8 sp√©cifiques
```

üÜï **MariaDB 11.8** : Nouvelles collations UCA 14.0.0

```sql
-- Les collations MySQL 8.0 utf8mb4_0900_* n'existent pas en MariaDB
-- Mapping recommand√© :
-- utf8mb4_0900_ai_ci    ‚Üí utf8mb4_uca1400_ai_ci
-- utf8mb4_0900_as_cs    ‚Üí utf8mb4_uca1400_as_cs
```

---

## Sc√©narios de migration r√©els

### Sc√©nario 1 : Application web PHP/Laravel sur MySQL 5.7

**Contexte** : Application e-commerce avec 50 tables, 10M lignes, MySQL 5.7.44

**Analyse de compatibilit√©** :

```bash
# Export du sch√©ma pour analyse
mysqldump --no-data -u root -p ecommerce > schema.sql

# Recherche de syntaxes potentiellement probl√©matiques
grep -E "JSON_TABLE|caching_sha2|INVISIBLE|PERSIST" schema.sql
```

**Points v√©rifi√©s** :
- ‚úÖ Types de donn√©es : Standard (INT, VARCHAR, DATETIME, DECIMAL)
- ‚úÖ Moteur : InnoDB uniquement
- ‚úÖ JSON : Utilisation basique (`JSON_EXTRACT`, `->>`)
- ‚úÖ Proc√©dures stock√©es : Aucune
- ‚ö†Ô∏è Triggers : 3 triggers √† valider
- ‚úÖ Authentification : `mysql_native_password`

**Verdict** : Migration directe possible avec tests applicatifs.

### Sc√©nario 2 : Application Java/Spring sur MySQL 8.0

**Contexte** : Application financi√®re, 200 tables, MySQL 8.0.35, authentification LDAP

**Analyse de compatibilit√©** :

```sql
-- Audit des fonctionnalit√©s MySQL 8 utilis√©es
SELECT 'JSON_TABLE usage' as feature, COUNT(*) as occurrences
FROM INFORMATION_SCHEMA.VIEWS 
WHERE VIEW_DEFINITION LIKE '%JSON_TABLE%'
UNION ALL
SELECT 'Window functions', COUNT(*)
FROM INFORMATION_SCHEMA.VIEWS 
WHERE VIEW_DEFINITION LIKE '%OVER%'
UNION ALL
SELECT 'CTEs', COUNT(*)
FROM INFORMATION_SCHEMA.VIEWS 
WHERE VIEW_DEFINITION LIKE '%WITH %';
```

**Points identifi√©s** :
- ‚ö†Ô∏è `JSON_TABLE()` : Utilis√© dans 3 vues ‚Üí R√©√©criture n√©cessaire
- ‚úÖ Window functions : Compatible
- ‚úÖ CTEs : Compatible
- ‚ö†Ô∏è `caching_sha2_password` : Migration utilisateurs requise
- ‚ö†Ô∏è Collation `utf8mb4_0900_ai_ci` : Conversion n√©cessaire

**Plan d'action** :

```sql
-- R√©√©criture d'une vue utilisant JSON_TABLE
-- MySQL 8.0 (original)
CREATE VIEW order_items_expanded AS
SELECT o.id, jt.*
FROM orders o,
JSON_TABLE(o.items, '$[*]' COLUMNS (
    product_id INT PATH '$.product_id',
    quantity INT PATH '$.quantity',
    price DECIMAL(10,2) PATH '$.price'
)) AS jt;

-- MariaDB 11.8 (√©quivalent)
CREATE VIEW order_items_expanded AS
SELECT 
    o.id,
    JSON_UNQUOTE(JSON_EXTRACT(item.item, '$.product_id')) AS product_id,
    JSON_UNQUOTE(JSON_EXTRACT(item.item, '$.quantity')) AS quantity,
    JSON_UNQUOTE(JSON_EXTRACT(item.item, '$.price')) AS price
FROM orders o
JOIN JSON_TABLE(
    (SELECT JSON_ARRAYAGG(items) FROM orders WHERE id = o.id),
    '$[*]' COLUMNS (item JSON PATH '$')
) AS item;

-- Alternative plus performante : d√©normaliser avec proc√©dure stock√©e
-- ou utiliser une table temporaire avec parsing JSON
```

### Sc√©nario 3 : Migration avec haute disponibilit√© (zero-downtime)

**Contexte** : Base de donn√©es critique 24/7, MySQL 5.7 Cluster (3 n≈ìuds)

**Architecture de migration** :

```
Phase 1 : Setup r√©plication
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  MySQL Primary  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ MariaDB Replica ‚îÇ
‚îÇ    (5.7.44)     ‚îÇ binlog  ‚îÇ    (11.8 LTS)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ
        ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ MySQL Replicas  ‚îÇ
‚îÇ   (existants)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Phase 2 : Bascule progressive
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  MySQL Primary  ‚îÇ         ‚îÇ MariaDB Primary ‚îÇ
‚îÇ   (read-only)   ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ    (11.8 LTS)   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ                           ‚îÇ
        ‚ñº                           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ MySQL Replicas  ‚îÇ         ‚îÇMariaDB Replicas ‚îÇ
‚îÇ   (shutdown)    ‚îÇ         ‚îÇ   (nouveaux)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**√âtapes d√©taill√©es** :

```bash
# 1. Configuration r√©plication MySQL ‚Üí MariaDB
# Sur MySQL Primary
mysql> SHOW MASTER STATUS;
+------------------+----------+
| File             | Position |
+------------------+----------+
| mysql-bin.000042 | 154789   |
+------------------+----------+

# Sur MariaDB Replica
mysql> CHANGE MASTER TO
    MASTER_HOST='mysql-primary.example.com',
    MASTER_USER='repl_user',
    MASTER_PASSWORD='secure_password',
    MASTER_LOG_FILE='mysql-bin.000042',
    MASTER_LOG_POS=154789;

mysql> START SLAVE;
mysql> SHOW SLAVE STATUS\G
```

```sql
-- 2. V√©rification synchronisation
-- Sur MariaDB
SELECT 
    @@server_id as server,
    VARIABLE_VALUE as seconds_behind
FROM information_schema.GLOBAL_STATUS 
WHERE VARIABLE_NAME = 'Seconds_Behind_Master';

-- Attendre que Seconds_Behind_Master = 0
```

```bash
# 3. Bascule (fen√™tre de maintenance minimale)
# Dur√©e typique : 30 secondes √† 2 minutes

# a. Arr√™ter les √©critures sur MySQL
mysql -h mysql-primary -e "SET GLOBAL read_only = ON;"
mysql -h mysql-primary -e "SET GLOBAL super_read_only = ON;"

# b. Attendre synchronisation finale
mysql -h mariadb-replica -e "SHOW SLAVE STATUS\G" | grep Seconds_Behind

# c. Promouvoir MariaDB
mysql -h mariadb-replica -e "STOP SLAVE; RESET SLAVE ALL;"

# d. Basculer le DNS/VIP vers MariaDB
# (d√©pend de votre infrastructure)

# e. V√©rifier l'application
curl -s https://app.example.com/health | jq .database
```

---

## Outils d'analyse et de migration

### mysqldump / mariadb-dump

L'outil standard pour les migrations logiques :

```bash
# Export depuis MySQL avec options de compatibilit√©
mysqldump \
    --single-transaction \
    --routines \
    --triggers \
    --events \
    --set-gtid-purged=OFF \
    --skip-lock-tables \
    --default-character-set=utf8mb4 \
    -u root -p \
    production_db > export.sql

# Nettoyage pour MariaDB (si n√©cessaire)
sed -i 's/utf8mb4_0900_ai_ci/utf8mb4_uca1400_ai_ci/g' export.sql
sed -i '/SET @@SESSION.SQL_LOG_BIN/d' export.sql
sed -i '/SET @@GLOBAL.GTID_PURGED/d' export.sql

# Import dans MariaDB
mariadb -u root -p production_db < export.sql
```

### mydumper / myloader

Pour les bases volumineuses, mydumper offre un export/import parall√®le :

```bash
# Export parall√®le (16 threads)
mydumper \
    --host=mysql-source \
    --user=backup_user \
    --password=secure_pwd \
    --database=production \
    --outputdir=/backup/migration \
    --threads=16 \
    --compress \
    --triggers \
    --routines \
    --events \
    --rows=500000 \
    --verbose=3

# Import parall√®le dans MariaDB
myloader \
    --host=mariadb-target \
    --user=root \
    --password=secure_pwd \
    --database=production \
    --directory=/backup/migration \
    --threads=16 \
    --overwrite-tables \
    --verbose=3
```

### pt-table-checksum / pt-table-sync (Percona Toolkit)

Pour valider la coh√©rence des donn√©es apr√®s migration :

```bash
# V√©rification de coh√©rence entre MySQL source et MariaDB cible
pt-table-checksum \
    --host=mysql-source \
    --user=checksum_user \
    --password=secure_pwd \
    --databases=production \
    --replicate=percona.checksums \
    --no-check-binlog-format

# Si des diff√©rences sont d√©tect√©es
pt-table-sync \
    --execute \
    --sync-to-master \
    h=mariadb-target,u=sync_user,p=secure_pwd \
    --databases=production \
    --print
```

### MySQL Shell (mysqlsh)

Pour les exports avanc√©s depuis MySQL 8.0+ :

```bash
# Export avec MySQL Shell (format compatible)
mysqlsh root@mysql-source -- util dump-instance /backup/full \
    --excludeSchemas=mysql,information_schema,performance_schema,sys \
    --compatibility=strip_definers,strip_restricted_grants \
    --threads=8

# Note : L'import avec MySQL Shell ne fonctionne pas vers MariaDB
# Utilisez le dump SQL classique ou mydumper
```

---

## Tests de compatibilit√© pr√©-migration

### Framework de tests recommand√©

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    PYRAMIDE DE TESTS MIGRATION                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                           ‚îÇ
‚îÇ                        ‚îÇ Tests E2E   ‚îÇ  ‚Üê Parcours utilisateurs  ‚îÇ
‚îÇ                        ‚îÇ (10-20)     ‚îÇ                           ‚îÇ
‚îÇ                       ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ                          ‚îÇ
‚îÇ                    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                     ‚îÇ
‚îÇ                    ‚îÇ Tests d'int√©gration   ‚îÇ  ‚Üê API + DB         ‚îÇ
‚îÇ                    ‚îÇ (50-100)              ‚îÇ                     ‚îÇ
‚îÇ                   ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ                    ‚îÇ
‚îÇ                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê               ‚îÇ
‚îÇ                ‚îÇ Tests unitaires SQL             ‚îÇ  ‚Üê Requ√™tes   ‚îÇ
‚îÇ                ‚îÇ (200-500)                       ‚îÇ               ‚îÇ
‚îÇ               ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ              ‚îÇ
‚îÇ            ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îÇ
‚îÇ            ‚îÇ Tests de compatibilit√© sch√©ma             ‚îÇ         ‚îÇ
‚îÇ            ‚îÇ (Automatis√©s)                             ‚îÇ         ‚îÇ
‚îÇ           ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Script d'audit de compatibilit√©

```sql
-- compatibility_audit.sql
-- Ex√©cuter sur la base MySQL source

DELIMITER //

CREATE PROCEDURE compatibility_audit()
BEGIN
    -- 1. Types de donn√©es potentiellement probl√©matiques
    SELECT 'DATA_TYPES' as category, 
           TABLE_SCHEMA, TABLE_NAME, COLUMN_NAME, DATA_TYPE, COLUMN_TYPE
    FROM INFORMATION_SCHEMA.COLUMNS
    WHERE TABLE_SCHEMA NOT IN ('mysql', 'information_schema', 'performance_schema', 'sys')
      AND (
          COLUMN_TYPE LIKE '%GENERATED%'
          OR DATA_TYPE IN ('geometry', 'point', 'linestring', 'polygon')
          OR EXTRA LIKE '%INVISIBLE%'
      );

    -- 2. Collations MySQL 8.0 sp√©cifiques
    SELECT 'COLLATIONS' as category,
           TABLE_SCHEMA, TABLE_NAME, COLUMN_NAME, COLLATION_NAME
    FROM INFORMATION_SCHEMA.COLUMNS
    WHERE TABLE_SCHEMA NOT IN ('mysql', 'information_schema', 'performance_schema', 'sys')
      AND COLLATION_NAME LIKE '%0900%';

    -- 3. Proc√©dures/fonctions √† v√©rifier
    SELECT 'ROUTINES' as category,
           ROUTINE_SCHEMA, ROUTINE_NAME, ROUTINE_TYPE,
           CASE 
               WHEN ROUTINE_DEFINITION LIKE '%JSON_TABLE%' THEN 'JSON_TABLE - R√©√©criture n√©cessaire'
               WHEN ROUTINE_DEFINITION LIKE '%EXPLAIN ANALYZE%' THEN 'EXPLAIN ANALYZE - Syntaxe diff√©rente'
               WHEN ROUTINE_DEFINITION LIKE '%GROUPING%' THEN 'GROUPING() - V√©rifier compatibilit√©'
               ELSE 'OK'
           END as compatibility_note
    FROM INFORMATION_SCHEMA.ROUTINES
    WHERE ROUTINE_SCHEMA NOT IN ('mysql', 'information_schema', 'performance_schema', 'sys');

    -- 4. Vues complexes
    SELECT 'VIEWS' as category,
           TABLE_SCHEMA, TABLE_NAME,
           CASE 
               WHEN VIEW_DEFINITION LIKE '%JSON_TABLE%' THEN 'Contient JSON_TABLE'
               WHEN VIEW_DEFINITION LIKE '%LATERAL%' THEN 'Contient LATERAL'
               ELSE 'Standard'
           END as complexity
    FROM INFORMATION_SCHEMA.VIEWS
    WHERE TABLE_SCHEMA NOT IN ('mysql', 'information_schema', 'performance_schema', 'sys');

    -- 5. Utilisateurs et authentification
    SELECT 'USERS' as category,
           User, Host, plugin,
           CASE 
               WHEN plugin = 'caching_sha2_password' THEN 'Migration requise'
               WHEN plugin = 'mysql_native_password' THEN 'Compatible'
               ELSE 'V√©rifier'
           END as migration_action
    FROM mysql.user
    WHERE User NOT IN ('mysql.sys', 'mysql.session', 'mysql.infoschema');

    -- 6. √âv√©nements planifi√©s
    SELECT 'EVENTS' as category,
           EVENT_SCHEMA, EVENT_NAME, STATUS, EVENT_TYPE
    FROM INFORMATION_SCHEMA.EVENTS
    WHERE EVENT_SCHEMA NOT IN ('mysql', 'information_schema', 'performance_schema', 'sys');

END //

DELIMITER ;

CALL compatibility_audit();
```

### Tests de performance comparatifs

```bash
#!/bin/bash
# benchmark_comparison.sh
# Compare les performances entre MySQL source et MariaDB cible

MYSQL_HOST="mysql-source"
MARIADB_HOST="mariadb-target"
DATABASE="production"

# Requ√™tes de benchmark repr√©sentatives
QUERIES=(
    "SELECT COUNT(*) FROM orders WHERE created_at > DATE_SUB(NOW(), INTERVAL 30 DAY)"
    "SELECT u.*, COUNT(o.id) FROM users u LEFT JOIN orders o ON u.id = o.user_id GROUP BY u.id LIMIT 1000"
    "SELECT * FROM products WHERE JSON_EXTRACT(metadata, '$.category') = 'electronics' LIMIT 100"
    "WITH RECURSIVE cat_tree AS (...) SELECT * FROM cat_tree"  # Adapter selon votre sch√©ma
)

echo "=== Benchmark MySQL vs MariaDB ==="
echo ""

for query in "${QUERIES[@]}"; do
    echo "Query: ${query:0:60}..."
    
    # MySQL
    mysql_time=$(mysql -h $MYSQL_HOST -u bench_user -p$BENCH_PWD $DATABASE \
        -e "SET profiling=1; $query; SHOW PROFILES;" 2>/dev/null | tail -1 | awk '{print $2}')
    
    # MariaDB
    mariadb_time=$(mariadb -h $MARIADB_HOST -u bench_user -p$BENCH_PWD $DATABASE \
        -e "SET profiling=1; $query; SHOW PROFILES;" 2>/dev/null | tail -1 | awk '{print $2}')
    
    echo "  MySQL:   ${mysql_time}s"
    echo "  MariaDB: ${mariadb_time}s"
    echo ""
done
```

---

## Gestion des incompatibilit√©s courantes

### Probl√®me 1 : Collations incompatibles

```sql
-- Erreur typique apr√®s migration
-- ERROR 1267 (HY000): Illegal mix of collations 
-- (utf8mb4_0900_ai_ci,IMPLICIT) and (utf8mb4_uca1400_ai_ci,IMPLICIT)

-- Solution : Script de conversion des collations
SELECT CONCAT(
    'ALTER TABLE `', TABLE_SCHEMA, '`.`', TABLE_NAME, '` ',
    'MODIFY COLUMN `', COLUMN_NAME, '` ', COLUMN_TYPE, ' ',
    'CHARACTER SET utf8mb4 COLLATE utf8mb4_uca1400_ai_ci',
    CASE WHEN IS_NULLABLE = 'NO' THEN ' NOT NULL' ELSE '' END,
    CASE WHEN COLUMN_DEFAULT IS NOT NULL 
         THEN CONCAT(' DEFAULT ', QUOTE(COLUMN_DEFAULT)) 
         ELSE '' END,
    ';'
) as alter_statement
FROM INFORMATION_SCHEMA.COLUMNS
WHERE TABLE_SCHEMA = 'production'
  AND COLLATION_NAME LIKE '%0900%';
```

### Probl√®me 2 : Syntaxe JSON_TABLE

```sql
-- MySQL 8.0 avec JSON_TABLE
SELECT o.id, items.*
FROM orders o,
JSON_TABLE(o.item_json, '$[*]' COLUMNS (
    rowid FOR ORDINALITY,
    product_id INT PATH '$.pid',
    qty INT PATH '$.quantity'
)) AS items;

-- MariaDB 11.8 - R√©√©criture avec JSON_EXTRACT et s√©quence
-- Option A : Pour petits tableaux JSON (< 100 √©l√©ments)
WITH RECURSIVE seq AS (
    SELECT 0 AS n
    UNION ALL
    SELECT n + 1 FROM seq WHERE n < 99
)
SELECT 
    o.id,
    seq.n + 1 AS rowid,
    JSON_EXTRACT(o.item_json, CONCAT('$[', seq.n, '].pid')) AS product_id,
    JSON_EXTRACT(o.item_json, CONCAT('$[', seq.n, '].quantity')) AS qty
FROM orders o
JOIN seq ON seq.n < JSON_LENGTH(o.item_json);

-- Option B : D√©normaliser dans une table d√©di√©e (meilleure performance)
CREATE TABLE order_items (
    order_id BIGINT,
    item_index INT,
    product_id INT,
    quantity INT,
    PRIMARY KEY (order_id, item_index),
    INDEX idx_product (product_id)
);

-- Trigger pour maintenir la synchronisation
DELIMITER //
CREATE TRIGGER orders_ai AFTER INSERT ON orders
FOR EACH ROW
BEGIN
    DECLARE i INT DEFAULT 0;
    DECLARE len INT;
    SET len = JSON_LENGTH(NEW.item_json);
    WHILE i < len DO
        INSERT INTO order_items (order_id, item_index, product_id, quantity)
        VALUES (
            NEW.id,
            i,
            JSON_EXTRACT(NEW.item_json, CONCAT('$[', i, '].pid')),
            JSON_EXTRACT(NEW.item_json, CONCAT('$[', i, '].quantity'))
        );
        SET i = i + 1;
    END WHILE;
END //
DELIMITER ;
```

### Probl√®me 3 : Variables syst√®me diff√©rentes

```sql
-- Variables MySQL sans √©quivalent MariaDB
-- MySQL                          MariaDB √©quivalent/alternative
-- cte_max_recursion_depth        max_recursive_iterations
-- regexp_stack_limit             (pas d'√©quivalent direct)
-- regexp_time_limit              (pas d'√©quivalent direct)
-- temptable_max_ram              tmp_table_size + max_heap_table_size

-- Script de mapping
SELECT 
    v.VARIABLE_NAME as mysql_var,
    CASE v.VARIABLE_NAME
        WHEN 'cte_max_recursion_depth' THEN 'max_recursive_iterations'
        WHEN 'default_authentication_plugin' THEN '(utilisateurs ed25519)'
        WHEN 'group_replication_%' THEN '(Galera Cluster)'
        ELSE 'V√©rifier documentation MariaDB'
    END as mariadb_equivalent
FROM information_schema.GLOBAL_VARIABLES v
WHERE v.VARIABLE_NAME NOT IN (
    SELECT VARIABLE_NAME FROM information_schema.GLOBAL_VARIABLES
);  -- Ex√©cuter sur MariaDB pour voir les variables manquantes
```

---

## Checklist de migration MySQL ‚Üí MariaDB

### Phase 1 : Analyse (1-2 semaines)

- [ ] Inventaire des bases de donn√©es et tailles
- [ ] Audit des versions MySQL sources
- [ ] Ex√©cution du script `compatibility_audit()`
- [ ] Identification des fonctionnalit√©s MySQL-sp√©cifiques
- [ ] Analyse des m√©thodes d'authentification
- [ ] Revue des collations utilis√©es
- [ ] Inventaire des proc√©dures stock√©es, triggers, events
- [ ] Documentation des int√©grations applicatives

### Phase 2 : Pr√©paration (2-4 semaines)

- [ ] Mise en place environnement MariaDB de test
- [ ] R√©√©criture des requ√™tes incompatibles (JSON_TABLE, etc.)
- [ ] Scripts de conversion des collations
- [ ] Mise √† jour des cha√Ænes de connexion applicatives
- [ ] Tests unitaires SQL sur MariaDB
- [ ] Tests d'int√©gration API
- [ ] Benchmark de performance comparatif
- [ ] Plan de rollback document√©

### Phase 3 : Migration (1-2 jours)

- [ ] Export des donn√©es (mysqldump/mydumper)
- [ ] Cr√©ation de la base MariaDB
- [ ] Import et validation du sch√©ma
- [ ] Import des donn√©es
- [ ] V√©rification d'int√©grit√© (checksums)
- [ ] Migration des utilisateurs
- [ ] Tests de fum√©e applicatifs

### Phase 4 : Validation (1 semaine)

- [ ] Tests de charge
- [ ] Validation fonctionnelle compl√®te
- [ ] Monitoring des performances
- [ ] Tests de failover/recovery
- [ ] Formation √©quipes op√©rationnelles
- [ ] Documentation mise √† jour

---

## ‚úÖ Points cl√©s √† retenir

- **Compatibilit√© protocole** : Les connecteurs MySQL fonctionnent avec MariaDB, mais les connecteurs MariaDB natifs offrent un meilleur support des fonctionnalit√©s sp√©cifiques

- **Migration logique obligatoire depuis MySQL 8.0+** : Le format InnoDB et le dictionnaire de donn√©es ont chang√©, rendant impossible la migration par copie de fichiers

- **Attention aux collations** : Les collations `utf8mb4_0900_*` de MySQL 8.0 n'existent pas en MariaDB, planifiez la conversion vers `utf8mb4_uca1400_ai_ci` (11.8)

- **JSON_TABLE() non support√©** : Cette fonction MySQL 8.0 populaire n√©cessite une r√©√©criture en MariaDB, privil√©giez la d√©normalisation pour la performance

- **Authentification** : Pr√©voyez la migration des utilisateurs `caching_sha2_password` vers `ed25519` ou `mysql_native_password`

- **GTID incompatibles** : Utilisez la r√©plication par positions binlog pour une migration progressive, pas les GTID

- **Test, test, test** : Ex√©cutez syst√©matiquement l'audit de compatibilit√© et les benchmarks avant toute migration production

---

## üîó Ressources et r√©f√©rences

- [üìñ Documentation officielle MariaDB - Compatibility](https://mariadb.com/kb/en/mariadb-vs-mysql-compatibility/)
- [üìñ MariaDB Knowledge Base - Migrating from MySQL](https://mariadb.com/kb/en/migrating-to-mariadb-from-mysql/)
- [üìñ Collations UCA 14.0.0 MariaDB 11.8](https://mariadb.com/kb/en/supported-character-sets-and-collations/)
- [üìñ MySQL to MariaDB Migration Guide](https://mariadb.com/resources/blog/how-to-migrate-from-mysql-to-mariadb/)
- [üîß Percona Toolkit Documentation](https://docs.percona.com/percona-toolkit/)
- [üîß mydumper Project](https://github.com/mydumper/mydumper)

---

## ‚û°Ô∏è Section suivante

**[19.1.2 Points d'attention et diff√©rences](./01.2-points-attention.md)** : Approfondissement des cas limites, diff√©rences subtiles de comportement SQL, et strat√©gies de r√©solution des incompatibilit√©s complexes d√©couvertes lors des audits.

‚è≠Ô∏è [Points d'attention et diff√©rences](/19-migration-compatibilite/01.2-points-attention.md)
