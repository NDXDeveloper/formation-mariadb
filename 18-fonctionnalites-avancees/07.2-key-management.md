üîù Retour au [Sommaire](/SOMMAIRE.md)

# 18.7.2 Key Management

> **Niveau** : Expert  
> **Dur√©e estim√©e** : 3-4 heures  
> **Pr√©requis** : 
> - Section 18.7.1 - Data at Rest Encryption
> - Compr√©hension de la cryptographie (PKI, HSM)
> - Exp√©rience en administration syst√®me s√©curis√©e
> - Connaissance des normes de s√©curit√© (SOC 2, ISO 27001)

## üéØ Objectifs d'apprentissage

√Ä l'issue de cette section, vous serez capable de :
- Concevoir une strat√©gie compl√®te de gestion des cl√©s
- Impl√©menter la rotation automatique et manuelle des cl√©s
- G√©rer le versioning et l'historique des cl√©s de chiffrement
- Int√©grer des HSM (Hardware Security Module) pour s√©curit√© maximale
- Mettre en place une r√©cup√©ration apr√®s sinistre des cl√©s
- Auditer et tracer toutes les op√©rations sur les cl√©s
- Assurer la conformit√© avec les standards de s√©curit√©
- G√©rer les cl√©s dans un environnement multi-cloud

---

## Introduction

La **gestion des cl√©s de chiffrement** (Key Management) est l'aspect le plus critique de la s√©curit√© des donn√©es au repos. Un chiffrement parfait devient inutile si les cl√©s sont mal g√©r√©es, perdues ou compromises.

### Hi√©rarchie des cl√©s

MariaDB utilise une architecture √† **deux niveaux de cl√©s** :

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Niveau 1 : MASTER KEY (Cl√© ma√Ætre)                 ‚îÇ
‚îÇ  - Stock√©e dans KMS externe ou keyfile              ‚îÇ
‚îÇ  - Jamais stock√©e dans MariaDB                      ‚îÇ
‚îÇ  - Utilis√©e pour chiffrer les Table Keys            ‚îÇ
‚îÇ  - Rotation facile (rechiffrement Table Keys)       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì Chiffre
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Niveau 2 : TABLE KEYS (Cl√©s de table)              ‚îÇ
‚îÇ  - Une cl√© par tablespace                           ‚îÇ
‚îÇ  - Stock√©es chiffr√©es dans .ibd files               ‚îÇ
‚îÇ  - D√©chiffr√©es en m√©moire par Master Key            ‚îÇ
‚îÇ  - Utilis√©es pour chiffrer les donn√©es              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì Chiffre
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Niveau 3 : DONN√âES (Pages InnoDB)                  ‚îÇ
‚îÇ  - Chiffr√©es par Table Keys                         ‚îÇ
‚îÇ  - D√©chiffr√©es √† la vol√©e en m√©moire                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Avantages architecture 2 niveaux** :
- ‚úÖ Rotation Master Key sans rechiffrer toutes les donn√©es
- ‚úÖ S√©paration des responsabilit√©s (ops vs security)
- ‚úÖ Performance (Table Keys en cache)
- ‚úÖ Scalabilit√© (nombreuses tables, une Master Key)

---

## Cycle de vie des cl√©s

### Les 4 √©tats d'une cl√©

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  1. PRE-ACTIVE                                       ‚îÇ
‚îÇ  - Cl√© g√©n√©r√©e mais pas encore utilis√©e              ‚îÇ
‚îÇ  - En attente de d√©ploiement                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  2. ACTIVE                                           ‚îÇ
‚îÇ  - Utilis√©e pour chiffrer nouvelles donn√©es          ‚îÇ
‚îÇ  - Utilis√©e pour d√©chiffrer donn√©es existantes       ‚îÇ
‚îÇ  - √âtat principal de production                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì Rotation
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  3. DEACTIVATED (Deprecated)                         ‚îÇ
‚îÇ  - N'est plus utilis√©e pour chiffrer                 ‚îÇ
‚îÇ  - Encore utilis√©e pour d√©chiffrer donn√©es anciennes ‚îÇ
‚îÇ  - En cours de remplacement                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì Apr√®s migration compl√®te
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  4. DESTROYED                                        ‚îÇ
‚îÇ  - Supprim√©e d√©finitivement                          ‚îÇ
‚îÇ  - Donn√©es chiffr√©es avec cette cl√© inaccessibles    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Dur√©e de vie recommand√©e

| Type de cl√© | Dur√©e de vie | Rotation |
|-------------|--------------|----------|
| **Master Key (haute s√©curit√©)** | 90 jours | Trimestrielle |
| **Master Key (standard)** | 180-365 jours | Semestrielle/Annuelle |
| **Table Keys** | Automatique avec Master Key | Avec Master Key |
| **Cl√©s de test** | 30 jours | Mensuelle |

üí° **Best practice** : La rotation r√©guli√®re r√©duit l'impact d'une compromission potentielle.

---

## Strat√©gies de rotation des cl√©s

### 1. Rotation automatique (Recommand√©)

```ini
# Fichier my.cnf

[mysqld]
# Rotation automatique tous les 30 jours
innodb_encryption_rotate_key_age = 30

# Threads d√©di√©s √† la rotation
innodb_encryption_threads = 4

# Priorit√© rotation (0=normale, 1=basse)
innodb_encryption_rotation_iops = 100
```

**Processus automatique** :

```sql
-- √âtat de la rotation
SELECT 
    SPACE,
    NAME,
    ENCRYPTION_SCHEME,
    CURRENT_KEY_VERSION,
    MIN_KEY_VERSION,
    ROTATING_OR_FLUSHING,
    CURRENT_KEY_ID
FROM information_schema.innodb_tablespaces_encryption
WHERE ENCRYPTION_SCHEME > 0
ORDER BY ROTATING_OR_FLUSHING DESC, CURRENT_KEY_VERSION;

-- Monitoring progression
SELECT 
    COUNT(*) AS total_encrypted_tables,
    SUM(CASE WHEN ROTATING_OR_FLUSHING = 1 THEN 1 ELSE 0 END) AS rotating,
    SUM(CASE WHEN ROTATING_OR_FLUSHING = 0 THEN 1 ELSE 0 END) AS stable,
    ROUND(AVG(CURRENT_KEY_VERSION), 2) AS avg_key_version
FROM information_schema.innodb_tablespaces_encryption
WHERE ENCRYPTION_SCHEME > 0;
```

### 2. Rotation manuelle planifi√©e

```bash
#!/bin/bash
# Script rotation manuelle Master Key

KEYFILE="/etc/mysql/encryption/keyfile.enc"
BACKUP_DIR="/etc/mysql/encryption/backup"
NEW_KEY_ID=$(($(tail -1 $KEYFILE | cut -d';' -f1) + 1))

# 1. Backup keyfile actuel
cp $KEYFILE $BACKUP_DIR/keyfile.enc.$(date +%Y%m%d_%H%M%S)

# 2. G√©n√©rer nouvelle Master Key
NEW_KEY=$(openssl rand -hex 32)

# 3. Ajouter au keyfile
echo "${NEW_KEY_ID};${NEW_KEY}" >> $KEYFILE

# 4. Forcer rotation dans MariaDB
mysql -e "SET GLOBAL innodb_encryption_rotate_key_age = 1;"
mysql -e "ALTER INSTANCE ROTATE INNODB MASTER KEY;"

# 5. Logger l'op√©ration
echo "$(date): Rotated to key ID ${NEW_KEY_ID}" >> /var/log/mysql/key-rotation.log

# 6. Notification
mail -s "MariaDB Key Rotation Completed" security@example.com <<EOF
New Master Key deployed: ID ${NEW_KEY_ID}
Rotation started at: $(date)
Monitor progress: SELECT * FROM information_schema.innodb_tablespaces_encryption;
EOF
```

### 3. Rotation avec downtime minimal

```sql
-- Proc√©dure de rotation contr√¥l√©e
DELIMITER $$
CREATE PROCEDURE controlled_key_rotation()
BEGIN
    -- 1. R√©duire charge rotation
    SET GLOBAL innodb_encryption_threads = 1;
    SET GLOBAL innodb_encryption_rotation_iops = 50;
    
    -- 2. D√©clencher rotation
    ALTER INSTANCE ROTATE INNODB MASTER KEY;
    
    -- 3. Attendre completion (polling)
    rotation_check: LOOP
        SELECT SUM(ROTATING_OR_FLUSHING) INTO @rotating_count
        FROM information_schema.innodb_tablespaces_encryption;
        
        IF @rotating_count = 0 THEN
            LEAVE rotation_check;
        END IF;
        
        -- Attendre 30 secondes
        DO SLEEP(30);
    END LOOP;
    
    -- 4. Restaurer param√®tres normaux
    SET GLOBAL innodb_encryption_threads = 4;
    SET GLOBAL innodb_encryption_rotation_iops = 100;
    
    -- 5. Logger
    INSERT INTO key_management_log (event_type, event_date, details)
    VALUES ('KEY_ROTATION_COMPLETED', NOW(), 'Manual rotation successful');
END$$
DELIMITER ;

-- Ex√©cution
CALL controlled_key_rotation();
```

---

## Versioning et historique

### Gestion des versions de cl√©s

```sql
-- Table de tracking des cl√©s
CREATE TABLE encryption_key_history (
    key_id INT PRIMARY KEY AUTO_INCREMENT,
    key_version INT NOT NULL,
    activation_date DATETIME NOT NULL,
    deactivation_date DATETIME,
    destroyed_date DATETIME,
    reason VARCHAR(200),
    created_by VARCHAR(50) DEFAULT USER(),
    
    INDEX idx_activation (activation_date),
    INDEX idx_version (key_version)
) ENGINE=InnoDB;

-- Trigger lors de rotation
DELIMITER $$
CREATE TRIGGER after_key_rotation
AFTER INSERT ON key_management_log
FOR EACH ROW
BEGIN
    IF NEW.event_type = 'KEY_ROTATION_STARTED' THEN
        -- D√©sactiver ancienne cl√©
        UPDATE encryption_key_history
        SET deactivation_date = NOW()
        WHERE deactivation_date IS NULL;
        
        -- Activer nouvelle cl√©
        INSERT INTO encryption_key_history 
        (key_version, activation_date, reason)
        VALUES (NEW.new_key_version, NOW(), NEW.details);
    END IF;
END$$
DELIMITER ;
```

### Audit trail complet

```sql
-- Vue historique consolid√©
CREATE VIEW key_lifecycle_audit AS
SELECT 
    k.key_id,
    k.key_version,
    k.activation_date,
    k.deactivation_date,
    DATEDIFF(COALESCE(k.deactivation_date, NOW()), k.activation_date) AS days_active,
    k.destroyed_date,
    k.reason,
    k.created_by,
    -- Tables encore chiffr√©es avec cette cl√©
    COUNT(DISTINCT t.NAME) AS tables_using_key
FROM encryption_key_history k
LEFT JOIN information_schema.innodb_tablespaces_encryption t
    ON k.key_version = t.CURRENT_KEY_VERSION
GROUP BY k.key_id
ORDER BY k.activation_date DESC;

-- Analyse
SELECT * FROM key_lifecycle_audit;

-- Alertes cl√©s anciennes
SELECT 
    key_version,
    activation_date,
    days_active,
    tables_using_key
FROM key_lifecycle_audit
WHERE deactivation_date IS NULL
AND days_active > 180
AND tables_using_key > 0;
```

---

## Int√©gration KMS externe

### AWS Key Management Service

#### Configuration compl√®te

```ini
# /etc/mysql/my.cnf

[mysqld]
plugin_load_add = aws_key_management

# R√©gion AWS
aws_key_management_region = eu-west-1

# KMS Master Key ARN
aws_key_management_master_key_id = arn:aws:kms:eu-west-1:123456789012:key/abcd1234-ab12-cd34-ef56-abcdef123456

# Algorithme
aws_key_management_key_spec = AES_256

# Rotation automatique (g√©r√© par AWS)
# La cl√© KMS rotate automatiquement tous les ans
# MariaDB suit automatiquement la rotation
```

#### Script de d√©ploiement AWS

```bash
#!/bin/bash
# D√©ploiement KMS pour MariaDB

AWS_REGION="eu-west-1"
KEY_ALIAS="mariadb-master-encryption-key"

# 1. Cr√©er la cl√© KMS
KEY_ID=$(aws kms create-key \
    --region $AWS_REGION \
    --description "MariaDB Master Encryption Key" \
    --key-usage ENCRYPT_DECRYPT \
    --customer-master-key-spec SYMMETRIC_DEFAULT \
    --query 'KeyMetadata.KeyId' \
    --output text)

echo "Created KMS Key: $KEY_ID"

# 2. Cr√©er alias
aws kms create-alias \
    --region $AWS_REGION \
    --alias-name "alias/$KEY_ALIAS" \
    --target-key-id $KEY_ID

# 3. Activer rotation automatique
aws kms enable-key-rotation \
    --region $AWS_REGION \
    --key-id $KEY_ID

# 4. Politique IAM pour EC2
cat > /tmp/kms-policy.json <<EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "MariaDBEncryption",
      "Effect": "Allow",
      "Action": [
        "kms:Encrypt",
        "kms:Decrypt",
        "kms:GenerateDataKey",
        "kms:GenerateDataKeyWithoutPlaintext",
        "kms:DescribeKey",
        "kms:CreateGrant"
      ],
      "Resource": "arn:aws:kms:$AWS_REGION:*:key/$KEY_ID"
    }
  ]
}
EOF

# 5. Cr√©er r√¥le IAM
aws iam create-role \
    --role-name MariaDB-KMS-Role \
    --assume-role-policy-document file:///tmp/assume-role.json

aws iam put-role-policy \
    --role-name MariaDB-KMS-Role \
    --policy-name MariaDB-KMS-Policy \
    --policy-document file:///tmp/kms-policy.json

# 6. Attacher r√¥le √† instance EC2
INSTANCE_ID=$(ec2-metadata --instance-id | cut -d' ' -f2)
aws ec2 associate-iam-instance-profile \
    --instance-id $INSTANCE_ID \
    --iam-instance-profile Name=MariaDB-KMS-Profile

echo "KMS setup complete. Update MariaDB config with:"
echo "aws_key_management_master_key_id = arn:aws:kms:$AWS_REGION:$(aws sts get-caller-identity --query Account --output text):key/$KEY_ID"
```

#### Rotation AWS KMS

```sql
-- AWS KMS rotate automatiquement tous les 365 jours
-- MariaDB d√©tecte et suit automatiquement

-- Forcer utilisation nouvelle version KMS
ALTER INSTANCE ROTATE INNODB MASTER KEY;

-- V√©rifier version KMS utilis√©e
SHOW VARIABLES LIKE 'aws_key_management%';
```

### HashiCorp Vault

#### Configuration Vault

```bash
# 1. Activer secrets engine
vault secrets enable -path=mariadb transit

# 2. Cr√©er cl√© de chiffrement
vault write -f mariadb/transit/keys/master-key \
    type=aes256-gcm96 \
    exportable=false \
    allow_plaintext_backup=false

# 3. Activer rotation automatique
vault write mariadb/transit/keys/master-key/config \
    auto_rotate_period=2160h  # 90 jours

# 4. Politique d'acc√®s
vault policy write mariadb-encryption - <<EOF
path "mariadb/transit/encrypt/master-key" {
  capabilities = ["update"]
}
path "mariadb/transit/decrypt/master-key" {
  capabilities = ["update"]
}
path "mariadb/transit/keys/master-key" {
  capabilities = ["read"]
}
EOF

# 5. Cr√©er token pour MariaDB
vault token create \
    -policy=mariadb-encryption \
    -period=720h \
    -renewable=true
```

#### Configuration MariaDB avec Vault

```ini
# /etc/mysql/my.cnf

[mysqld]
plugin_load_add = hashicorp_key_management

# Vault server
hashicorp_key_management_vault_url = https://vault.example.com:8200

# Authentification par token
hashicorp_key_management_token = s.xxxxxxxxxxxxxxxxxxxxxxxxxx

# Ou authentification AppRole
# hashicorp_key_management_role_id = xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
# hashicorp_key_management_secret_id = yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy

# Chemin des cl√©s
hashicorp_key_management_vault_mount = mariadb/transit/
hashicorp_key_management_vault_prefix = encryption_keys/

# Timeout et retry
hashicorp_key_management_timeout = 15
hashicorp_key_management_retries = 3

# Cache des cl√©s (performance)
hashicorp_key_management_cache_timeout = 60000
hashicorp_key_management_cache_version_timeout = 0
```

#### Script monitoring Vault

```bash
#!/bin/bash
# Monitoring cl√©s Vault

VAULT_ADDR="https://vault.example.com:8200"
VAULT_TOKEN="s.xxxxxxxxxxxxxxxxxx"

# √âtat de la cl√©
vault read mariadb/transit/keys/master-key

# Statistiques rotation
vault read mariadb/transit/keys/master-key/rotate

# Audit des op√©rations
vault audit list

# Logs r√©cents
vault operator diagnose
```

---

## Hardware Security Module (HSM)

### Int√©gration PKCS#11

```ini
# /etc/mysql/my.cnf - Configuration HSM

[mysqld]
plugin_load_add = kmip_key_management

# Serveur KMIP (Key Management Interoperability Protocol)
kmip_key_management_server_address = hsm.example.com
kmip_key_management_server_port = 5696

# Certificats SSL pour KMIP
kmip_key_management_client_ca = /etc/mysql/kmip/ca.pem
kmip_key_management_client_certificate = /etc/mysql/kmip/client-cert.pem
kmip_key_management_client_key = /etc/mysql/kmip/client-key.pem

# Cl√© master dans HSM
kmip_key_management_master_key_id = mariadb-master-key-001
```

### Configuration Thales HSM

```bash
# Installation driver Thales
apt-get install libnfast-ctk-nethsm

# Configuration client
cat > /opt/nfast/kmdata/config/config <<EOF
server_address=hsm1.example.com
server_port=9004
use_ssl=yes
client_cert=/etc/nfast/client.pem
EOF

# Test connectivit√© HSM
/opt/nfast/bin/enquiry
# Response: HSM OK, 3 modules available

# G√©n√©rer cl√© dans HSM
/opt/nfast/bin/generatekey \
    --batch \
    --module=1 \
    --app=pkcs11 \
    --type=AES \
    --size=256 \
    --ident=mariadb-master-key \
    --plainname=mariadb-master-key-001
```

### Avantages HSM

| Crit√®re | Software KMS | HSM |
|---------|--------------|-----|
| **S√©curit√©** | Bonne | Maximale |
| **FIPS 140-2** | Niveau 1-2 | Niveau 3-4 |
| **R√©sistance physique** | Non | Oui (tamper-proof) |
| **Performance** | Excellente | Bonne |
| **Co√ªt** | Faible | √âlev√© |
| **Complexit√©** | Faible | √âlev√©e |
| **Conformit√©** | Standard | Haute s√©curit√© |

üí° **Recommandation** : HSM pour secteurs r√©gul√©s (finance, sant√©, d√©fense), KMS software pour autres cas.

---

## Backup et r√©cup√©ration

### Strat√©gie backup des cl√©s

```bash
#!/bin/bash
# Backup complet infrastructure de cl√©s

BACKUP_DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/mnt/secure-backup/keys"
GPG_RECIPIENT="security-team@example.com"

# 1. Backup keyfile
cp /etc/mysql/encryption/keyfile.enc \
   /tmp/keyfile-$BACKUP_DATE.enc

# 2. Backup historique rotations
mysqldump encryption_key_history > /tmp/key-history-$BACKUP_DATE.sql

# 3. Backup configuration
cp /etc/mysql/my.cnf /tmp/my.cnf-$BACKUP_DATE

# 4. Snapshot √©tat actuel
mysql -e "SELECT * FROM information_schema.innodb_tablespaces_encryption" \
    > /tmp/encryption-state-$BACKUP_DATE.txt

# 5. Archiver
tar czf /tmp/key-backup-$BACKUP_DATE.tar.gz \
    /tmp/keyfile-$BACKUP_DATE.enc \
    /tmp/key-history-$BACKUP_DATE.sql \
    /tmp/my.cnf-$BACKUP_DATE \
    /tmp/encryption-state-$BACKUP_DATE.txt

# 6. Chiffrer avec GPG
gpg --encrypt \
    --recipient $GPG_RECIPIENT \
    --armor \
    --output $BACKUP_DIR/key-backup-$BACKUP_DATE.tar.gz.asc \
    /tmp/key-backup-$BACKUP_DATE.tar.gz

# 7. Uploader vers stockage s√©curis√© externe
aws s3 cp $BACKUP_DIR/key-backup-$BACKUP_DATE.tar.gz.asc \
    s3://company-key-vault/mariadb-keys/ \
    --sse aws:kms \
    --sse-kms-key-id arn:aws:kms:eu-west-1:xxx:key/backup-key

# 8. Cleanup local
rm /tmp/keyfile-$BACKUP_DATE.enc \
   /tmp/key-history-$BACKUP_DATE.sql \
   /tmp/my.cnf-$BACKUP_DATE \
   /tmp/encryption-state-$BACKUP_DATE.txt \
   /tmp/key-backup-$BACKUP_DATE.tar.gz

# 9. V√©rification backup
gpg --decrypt $BACKUP_DIR/key-backup-$BACKUP_DATE.tar.gz.asc | \
    tar tz | wc -l
# Doit retourner 4 (4 fichiers dans archive)

# 10. Logger
echo "$(date): Key backup completed - $BACKUP_DATE" \
    >> /var/log/mysql/key-backup.log
```

### Proc√©dure de r√©cup√©ration apr√®s sinistre

```bash
#!/bin/bash
# Disaster Recovery - Restauration des cl√©s

BACKUP_FILE="key-backup-20251214_120000.tar.gz.asc"
RECOVERY_DIR="/tmp/key-recovery"

echo "=== DISASTER RECOVERY: Key Restoration ==="

# 1. T√©l√©charger backup depuis S3
aws s3 cp s3://company-key-vault/mariadb-keys/$BACKUP_FILE \
    /tmp/$BACKUP_FILE

# 2. D√©chiffrer
gpg --decrypt /tmp/$BACKUP_FILE > /tmp/key-backup.tar.gz

# 3. Extraire
mkdir -p $RECOVERY_DIR
tar xzf /tmp/key-backup.tar.gz -C $RECOVERY_DIR

# 4. Restaurer keyfile
sudo cp $RECOVERY_DIR/keyfile-*.enc /etc/mysql/encryption/keyfile.enc
sudo chmod 600 /etc/mysql/encryption/keyfile.enc
sudo chown mysql:mysql /etc/mysql/encryption/keyfile.enc

# 5. Restaurer configuration
sudo cp $RECOVERY_DIR/my.cnf-* /etc/mysql/my.cnf.recovered
echo "Review /etc/mysql/my.cnf.recovered before applying"

# 6. Restaurer historique
mysql < $RECOVERY_DIR/key-history-*.sql

# 7. V√©rifier coh√©rence
mysql -e "SELECT COUNT(*) FROM encryption_key_history;"

# 8. Red√©marrer MariaDB
sudo systemctl restart mariadb

# 9. V√©rifier chiffrement op√©rationnel
mysql -e "SELECT 
    COUNT(*) AS encrypted_tables,
    SUM(CASE WHEN ENCRYPTION_SCHEME > 0 THEN 1 ELSE 0 END) AS accessible
FROM information_schema.innodb_tablespaces_encryption;"

# 10. Logger recovery
echo "$(date): Key recovery completed from $BACKUP_FILE" \
    >> /var/log/mysql/disaster-recovery.log
```

---

## Multi-cloud et g√©o-distribution

### Architecture multi-r√©gion

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Region 1: eu-west-1 (Ireland)                      ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ MariaDB Primary                               ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ KMS: AWS KMS eu-west-1                        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ Master Key: arn:...eu-west-1:key/primary      ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì R√©plication
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Region 2: us-east-1 (Virginia)                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ MariaDB Replica                               ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ KMS: AWS KMS us-east-1                        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ Master Key: arn:...us-east-1:key/replica      ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì DR Failover
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Region 3: ap-southeast-1 (Singapore)               ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
‚îÇ  ‚îÇ MariaDB DR                                    ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ KMS: AWS KMS ap-southeast-1                   ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ Master Key: arn:...ap-southeast-1:key/dr      ‚îÇ  ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Configuration multi-r√©gion

```ini
# Primary (eu-west-1)
[mysqld]
plugin_load_add = aws_key_management
aws_key_management_region = eu-west-1
aws_key_management_master_key_id = arn:aws:kms:eu-west-1:123456789012:key/primary-key

# R√©plication binlog chiffr√©
encrypt_binlog = ON
binlog_encryption_key_id = 1
```

```ini
# Replica (us-east-1)
[mysqld]
plugin_load_add = aws_key_management
aws_key_management_region = us-east-1
aws_key_management_master_key_id = arn:aws:kms:us-east-1:123456789012:key/replica-key

# Important: Les donn√©es arrivent d√©j√† chiffr√©es via binlog
# La replica utilise sa propre Master Key pour rechiffrer localement
encrypt_binlog = ON
```

### Failover multi-r√©gion

```bash
#!/bin/bash
# Failover proc√©dure avec gestion cl√©s

PRIMARY_REGION="eu-west-1"
FAILOVER_REGION="us-east-1"

# 1. Promouvoir replica en primary
mysql -h replica.us-east-1.rds.amazonaws.com -e "STOP SLAVE; RESET SLAVE ALL;"

# 2. Synchroniser keyfile (si file_key_management)
aws s3 cp s3://key-vault-$PRIMARY_REGION/keyfile.enc \
    s3://key-vault-$FAILOVER_REGION/keyfile.enc

# 3. Mettre √† jour DNS
aws route53 change-resource-record-sets \
    --hosted-zone-id Z1234567890ABC \
    --change-batch file://dns-failover.json

# 4. Notification
aws sns publish \
    --topic-arn arn:aws:sns:us-east-1:xxx:db-alerts \
    --message "Failover completed: Primary is now us-east-1"
```

---

## Audit et compliance

### Logging complet

```sql
-- Table audit d√©taill√©
CREATE TABLE key_audit_log (
    audit_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    event_timestamp TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP(6),
    event_type ENUM('KEY_GENERATED', 'KEY_ACTIVATED', 'KEY_ROTATED', 
                    'KEY_DEACTIVATED', 'KEY_ACCESSED', 'KEY_DESTROYED'),
    key_id VARCHAR(100),
    key_version INT,
    user_principal VARCHAR(100),
    source_ip VARCHAR(45),
    success BOOLEAN,
    details JSON,
    
    INDEX idx_timestamp (event_timestamp),
    INDEX idx_type (event_type),
    INDEX idx_key (key_id)
) ENGINE=InnoDB;

-- Trigger audit automatique
DELIMITER $$
CREATE TRIGGER audit_key_rotation
AFTER UPDATE ON encryption_key_history
FOR EACH ROW
BEGIN
    INSERT INTO key_audit_log 
    (event_type, key_id, key_version, user_principal, success, details)
    VALUES (
        'KEY_ROTATED',
        CONCAT('key_', NEW.key_version),
        NEW.key_version,
        USER(),
        TRUE,
        JSON_OBJECT(
            'old_version', OLD.key_version,
            'new_version', NEW.key_version,
            'activation_date', NEW.activation_date
        )
    );
END$$
DELIMITER ;
```

### Rapports de conformit√©

```sql
-- Rapport mensuel conformit√© cl√©s
CREATE PROCEDURE monthly_key_compliance_report(report_month DATE)
BEGIN
    SELECT 
        'Key Rotation Compliance' AS metric,
        COUNT(*) AS total_rotations,
        AVG(DATEDIFF(deactivation_date, activation_date)) AS avg_key_lifetime_days,
        MIN(DATEDIFF(deactivation_date, activation_date)) AS min_lifetime,
        MAX(DATEDIFF(deactivation_date, activation_date)) AS max_lifetime
    FROM encryption_key_history
    WHERE DATE_FORMAT(activation_date, '%Y-%m') = DATE_FORMAT(report_month, '%Y-%m');
    
    SELECT 
        'Active Keys' AS metric,
        COUNT(*) AS count
    FROM encryption_key_history
    WHERE deactivation_date IS NULL;
    
    SELECT 
        'Tables Encrypted' AS metric,
        COUNT(*) AS count,
        ROUND(AVG(CURRENT_KEY_VERSION), 2) AS avg_key_version
    FROM information_schema.innodb_tablespaces_encryption
    WHERE ENCRYPTION_SCHEME > 0;
    
    SELECT 
        'Audit Events' AS metric,
        event_type,
        COUNT(*) AS event_count
    FROM key_audit_log
    WHERE DATE_FORMAT(event_timestamp, '%Y-%m') = DATE_FORMAT(report_month, '%Y-%m')
    GROUP BY event_type;
END$$

-- G√©n√©ration rapport
CALL monthly_key_compliance_report('2025-12-01');
```

### Export pour auditeurs

```bash
#!/bin/bash
# Export audit pour conformit√©

AUDIT_DATE=$(date +%Y%m%d)

# Rapport SQL
mysql -e "
SELECT 
    event_timestamp,
    event_type,
    key_id,
    user_principal,
    source_ip,
    details
FROM key_audit_log
WHERE event_timestamp >= DATE_SUB(NOW(), INTERVAL 90 DAY)
ORDER BY event_timestamp DESC
" > /tmp/key-audit-$AUDIT_DATE.csv

# Rapport PDF avec signatures
pandoc /tmp/key-audit-$AUDIT_DATE.csv \
    -o /tmp/key-audit-$AUDIT_DATE.pdf \
    --metadata title="MariaDB Key Management Audit Report" \
    --metadata date="$AUDIT_DATE"

# Signer num√©riquement
gpg --detach-sign --armor /tmp/key-audit-$AUDIT_DATE.pdf

# Archiver
tar czf /secure-archive/audit-reports/key-audit-$AUDIT_DATE.tar.gz \
    /tmp/key-audit-$AUDIT_DATE.csv \
    /tmp/key-audit-$AUDIT_DATE.pdf \
    /tmp/key-audit-$AUDIT_DATE.pdf.asc
```

---

## Automatisation compl√®te

### Workflow GitOps

```yaml
# .github/workflows/key-rotation.yml

name: MariaDB Key Rotation
on:
  schedule:
    - cron: '0 2 1 * *'  # 1er de chaque mois √† 2h
  workflow_dispatch:      # Manuel aussi

jobs:
  rotate-keys:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Configure AWS
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-region: eu-west-1
          role-to-assume: arn:aws:iam::xxx:role/github-actions
      
      - name: Rotate KMS Key
        run: |
          aws kms enable-key-rotation \
            --key-id ${{ secrets.KMS_KEY_ID }}
      
      - name: Trigger MariaDB Rotation
        run: |
          mysql -h ${{ secrets.DB_HOST }} \
                -u ${{ secrets.DB_USER }} \
                -p${{ secrets.DB_PASSWORD }} \
                -e "ALTER INSTANCE ROTATE INNODB MASTER KEY;"
      
      - name: Monitor Progress
        run: |
          ./scripts/monitor-rotation.sh
      
      - name: Slack Notification
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "Key rotation completed successfully"
            }
```

### Terraform pour infrastructure cl√©s

```hcl
# main.tf - Infrastructure KMS

resource "aws_kms_key" "mariadb_master" {
  description             = "MariaDB Master Encryption Key"
  deletion_window_in_days = 30
  enable_key_rotation     = true
  
  tags = {
    Environment = "production"
    Application = "mariadb"
    Compliance  = "PCI-DSS"
  }
}

resource "aws_kms_alias" "mariadb_master_alias" {
  name          = "alias/mariadb-master-${var.environment}"
  target_key_id = aws_kms_key.mariadb_master.key_id
}

resource "aws_kms_grant" "mariadb_grant" {
  name              = "mariadb-encryption-grant"
  key_id            = aws_kms_key.mariadb_master.key_id
  grantee_principal = aws_iam_role.mariadb_role.arn
  
  operations = [
    "Encrypt",
    "Decrypt",
    "GenerateDataKey",
    "DescribeKey"
  ]
}

# Politique sauvegarde cl√©s
resource "aws_backup_plan" "kms_backup" {
  name = "mariadb-kms-backup-plan"
  
  rule {
    rule_name         = "daily_backup"
    target_vault_name = aws_backup_vault.key_vault.name
    schedule          = "cron(0 2 * * ? *)"
    
    lifecycle {
      delete_after = 90
    }
  }
}

output "kms_key_arn" {
  value     = aws_kms_key.mariadb_master.arn
  sensitive = true
}
```

---

## Bonnes pratiques

### ‚úÖ Recommandations

1. **S√©paration des environnements**
   ```
   Production:   KMS key-prod-001
   Staging:      KMS key-staging-001
   Development:  file_key_management
   ```

2. **Rotation r√©guli√®re**
   ```ini
   # Production haute s√©curit√©
   innodb_encryption_rotate_key_age = 30  # Mensuel
   
   # Production standard
   innodb_encryption_rotate_key_age = 90  # Trimestriel
   ```

3. **Backup automatis√©**
   ```bash
   # Cron quotidien
   0 3 * * * /scripts/backup-encryption-keys.sh
   ```

4. **Monitoring proactif**
   ```sql
   -- Alerte si pas de rotation > 180 jours
   SELECT * FROM encryption_key_history
   WHERE deactivation_date IS NULL
   AND DATEDIFF(NOW(), activation_date) > 180;
   ```

5. **Audit trail immuable**
   ```sql
   -- Jamais DELETE sur key_audit_log
   REVOKE DELETE ON key_audit_log FROM ALL;
   ```

6. **Tests DR r√©guliers**
   ```bash
   # Mensuel : test restauration cl√©s
   ./test-key-recovery.sh
   ```

7. **Documentation √† jour**
   ```markdown
   # Maintenir README.md
   - Proc√©dures rotation
   - Contacts d'urgence
   - Checklist DR
   ```

### ‚ö†Ô∏è Pi√®ges √† √©viter

1. **Cl√©s en clair dans Git** ‚Üí Utiliser secrets management
2. **Pas de backup keyfile** ‚Üí Perte irr√©versible donn√©es
3. **Rotation sans monitoring** ‚Üí Blocage inaper√ßu
4. **M√™me cl√© dev/prod** ‚Üí Risque contamination
5. **Logs audit effa√ßables** ‚Üí Non-conformit√©
6. **KMS single-region** ‚Üí Risque DR
7. **Pas de tests recovery** ‚Üí DR √©choue en production

---

## ‚úÖ Points cl√©s √† retenir

- Architecture **2 niveaux** : Master Key chiffre Table Keys qui chiffrent les donn√©es
- **Rotation automatique** tous les 30-90 jours selon niveau de s√©curit√©
- **KMS externe** (AWS KMS, Vault) pr√©f√©rable √† file_key_management en production
- **HSM** n√©cessaire pour secteurs hautement r√©gul√©s (finance, sant√©)
- **Backup cl√©s** critique : sans cl√©s, donn√©es irr√©cup√©rables
- **Audit trail** complet indispensable pour conformit√©
- **Multi-r√©gion** pour haute disponibilit√© et disaster recovery
- **Versioning cl√©s** permet rollback et d√©commissionnement graduel
- **Automatisation** (GitOps, Terraform) r√©duit erreurs humaines
- **Tests DR r√©guliers** garantissent proc√©dures fonctionnelles

---

## üîó Ressources et r√©f√©rences

- [üìñ MariaDB - Encryption Key Management](https://mariadb.com/kb/en/encryption-key-management/)
- [üìñ AWS KMS Best Practices](https://docs.aws.amazon.com/kms/latest/developerguide/best-practices.html)
- [üìñ HashiCorp Vault - Database Secrets](https://www.vaultproject.io/docs/secrets/databases)
- [üìñ NIST - Key Management Guidelines](https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-57pt1r5.pdf)
- [üîí OWASP - Key Management Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Key_Management_Cheat_Sheet.html)
- [üîí PCI-DSS - Cryptographic Key Management](https://www.pcisecuritystandards.org/)

---


‚è≠Ô∏è [Thread Pool avanc√©](/18-fonctionnalites-avancees/08-thread-pool-avance.md)
