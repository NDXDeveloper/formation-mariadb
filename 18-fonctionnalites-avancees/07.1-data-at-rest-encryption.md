üîù Retour au [Sommaire](/SOMMAIRE.md)

# 18.7.1 Data at Rest Encryption

> **Niveau** : Avanc√©  
> **Dur√©e estim√©e** : 3-4 heures  
> **Pr√©requis** : 
> - Chapitre 10 - S√©curit√© et gestion des utilisateurs
> - Compr√©hension des concepts de cryptographie (AES, cl√©s)
> - Connaissance des moteurs de stockage (InnoDB, Aria)
> - Administration syst√®me Linux

## üéØ Objectifs d'apprentissage

√Ä l'issue de cette section, vous serez capable de :
- Comprendre les principes du chiffrement au repos
- Configurer le chiffrement pour InnoDB et Aria
- Impl√©menter diff√©rents plugins de gestion de cl√©s
- Chiffrer les tables existantes sans downtime
- Mesurer et optimiser l'impact performance
- G√©rer la rotation des cl√©s de chiffrement
- Assurer la conformit√© r√©glementaire (RGPD, HIPAA)
- Diagnostiquer et r√©soudre les probl√®mes de chiffrement

---

## Introduction

Le **chiffrement des donn√©es au repos** (Data at Rest Encryption) prot√®ge les donn√©es stock√©es sur disque contre les acc√®s non autoris√©s. Contrairement au chiffrement en transit (SSL/TLS), il s√©curise les fichiers physiques de la base de donn√©es.

### Pourquoi chiffrer au repos ?

Les menaces sans chiffrement au repos :

- **Vol de disques/serveurs** : Acc√®s physique aux donn√©es
- **Backups non s√©curis√©s** : Copies lisibles si vol√©es
- **D√©commissionnement** : Donn√©es r√©cup√©rables sur disques jet√©s
- **Acc√®s administrateur syst√®me** : Lecture fichiers `.ibd` sans authentification MariaDB
- **Snapshots cloud** : Stockage volumes non chiffr√©s

üí° **Principe de d√©fense en profondeur** : Le chiffrement au repos est une couche de s√©curit√© **compl√©mentaire** aux autres m√©canismes (authentification, autorisations, SSL/TLS).

### Port√©e du chiffrement

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  CHIFFR√â au repos                                   ‚îÇ
‚îÇ  ‚úÖ Fichiers .ibd (tables InnoDB)                   ‚îÇ
‚îÇ  ‚úÖ Tablespace syst√®me InnoDB                       ‚îÇ
‚îÇ  ‚úÖ Redo logs (ib_logfile*)                         ‚îÇ
‚îÇ  ‚úÖ Undo logs                                       ‚îÇ
‚îÇ  ‚úÖ Fichiers Aria (.MAI, .MAD)                      ‚îÇ
‚îÇ  ‚úÖ Temporary tables (si configur√©)                 ‚îÇ
‚îÇ  ‚úÖ Binlogs (si configur√©)                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  NON CHIFFR√â (par d√©faut)                           ‚îÇ
‚îÇ  ‚ùå Slow query log                                  ‚îÇ
‚îÇ  ‚ùå General log                                     ‚îÇ
‚îÇ  ‚ùå Error log                                       ‚îÇ
‚îÇ  ‚ùå Backups (mysqldump, mariabackup)                ‚îÇ
‚îÇ  ‚ùå Donn√©es en m√©moire (buffer pool)                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

‚ö†Ô∏è **Important** : Le chiffrement au repos ne prot√®ge **pas** les donn√©es en m√©moire ou pendant la transmission r√©seau.

---

## Architecture du chiffrement

### Chiffrement transparent (TDE)

MariaDB utilise le **Transparent Data Encryption (TDE)** :

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Application                                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  MariaDB Server                                        ‚îÇ
‚îÇ  - Aucune modification requise dans les requ√™tes SQL   ‚îÇ
‚îÇ  - Chiffrement/d√©chiffrement automatique               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  InnoDB/Aria Storage Engine                            ‚îÇ
‚îÇ  - Chiffrement AES avant √©criture disque               ‚îÇ
‚îÇ  - D√©chiffrement AES apr√®s lecture disque              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Syst√®me de fichiers                                   ‚îÇ
‚îÇ  - Donn√©es chiffr√©es (.ibd, ib_logfile*)               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Transparent** signifie :
- ‚úÖ Aucun changement applicatif n√©cessaire
- ‚úÖ Chiffrement/d√©chiffrement automatique
- ‚úÖ Compatible avec applications existantes
- ‚úÖ Performance impact minimal (~5-10%)

### Algorithmes de chiffrement

MariaDB supporte plusieurs algorithmes AES :

| Algorithme | Taille cl√© | S√©curit√© | Performance |
|------------|-----------|----------|-------------|
| **AES-128-CBC** | 128 bits | Bonne | Excellente |
| **AES-192-CBC** | 192 bits | Tr√®s bonne | Bonne |
| **AES-256-CBC** | 256 bits | Maximale | Bonne |
| **AES-128-CTR** | 128 bits | Bonne | Excellente (parall√©lisable) |
| **AES-256-CTR** | 256 bits | Maximale | Tr√®s bonne |

üí° **Recommandation** : **AES-256-CBC** pour conformit√© maximale, **AES-128-CTR** pour meilleure performance.

---

## Configuration pour InnoDB

### Activation du chiffrement

```ini
# Fichier my.cnf / my.ini

[mysqld]
# Plugin de gestion des cl√©s (obligatoire)
plugin_load_add = file_key_management

# Configuration file_key_management
file_key_management_filename = /etc/mysql/encryption/keyfile.enc
file_key_management_filekey = FILE:/etc/mysql/encryption/keyfile.key
file_key_management_encryption_algorithm = AES_CBC

# Activation chiffrement InnoDB
innodb_encrypt_tables = ON
innodb_encrypt_log = ON
innodb_encrypt_temporary_tables = ON

# Rotation automatique des cl√©s
innodb_encryption_threads = 4
innodb_encryption_rotate_key_age = 30

# Algorithme de chiffrement
innodb_default_encryption_key_id = 1
```

### G√©n√©ration du fichier de cl√©s

```bash
# 1. Cr√©er le r√©pertoire de cl√©s
sudo mkdir -p /etc/mysql/encryption
sudo chown mysql:mysql /etc/mysql/encryption
sudo chmod 700 /etc/mysql/encryption

# 2. G√©n√©rer une cl√© ma√Ætre al√©atoire (256 bits)
openssl rand -hex 32 > /etc/mysql/encryption/keyfile.key
sudo chmod 600 /etc/mysql/encryption/keyfile.key

# 3. Cr√©er le fichier de cl√©s de chiffrement
sudo tee /etc/mysql/encryption/keyfile.enc > /dev/null << 'EOF'
1;$(openssl rand -hex 32)
2;$(openssl rand -hex 32)
3;$(openssl rand -hex 32)
EOF

sudo chmod 600 /etc/mysql/encryption/keyfile.enc

# 4. Red√©marrer MariaDB
sudo systemctl restart mariadb
```

**Format du fichier de cl√©s** :
```
key_id;hex_encoded_key
1;abcdef0123456789abcdef0123456789abcdef0123456789abcdef0123456789
2;fedcba9876543210fedcba9876543210fedcba9876543210fedcba9876543210
```

### V√©rification du chiffrement

```sql
-- V√©rifier que le plugin est charg√©
SHOW PLUGINS WHERE Name = 'file_key_management';
-- Status: ACTIVE

-- V√©rifier variables de chiffrement
SHOW VARIABLES LIKE '%encrypt%';

-- R√©sultat attendu :
-- innodb_encrypt_tables           | ON
-- innodb_encrypt_log              | ON
-- innodb_encryption_threads       | 4
-- innodb_encryption_rotate_key_age| 30

-- V√©rifier √©tat du chiffrement par table
SELECT 
    table_schema,
    table_name,
    create_options
FROM information_schema.tables
WHERE engine = 'InnoDB'
AND table_schema NOT IN ('mysql', 'information_schema', 'performance_schema')
ORDER BY table_schema, table_name;
```

---

## Chiffrement des tables

### Nouvelles tables (automatique)

```sql
-- Avec innodb_encrypt_tables = ON, toutes nouvelles tables sont chiffr√©es
CREATE TABLE secure_data (
    id INT PRIMARY KEY AUTO_INCREMENT,
    ssn VARCHAR(11) NOT NULL,
    credit_card VARCHAR(19),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB;
-- ‚Üí Automatiquement chiffr√©e

-- V√©rification
SHOW CREATE TABLE secure_data\G
-- Create Table: CREATE TABLE `secure_data` (
--   ...
-- ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 ENCRYPTED=YES
```

### Chiffrement explicite

```sql
-- Forcer chiffrement m√™me si innodb_encrypt_tables = OFF
CREATE TABLE confidential_logs (
    log_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id INT,
    action VARCHAR(100),
    details TEXT,
    log_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=1;

-- Sp√©cifier un ID de cl√© particulier
CREATE TABLE financial_data (
    transaction_id BIGINT PRIMARY KEY,
    amount DECIMAL(15,2),
    account_number VARCHAR(20)
) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=2;
```

### Chiffrement de tables existantes

```sql
-- Chiffrer une table existante (op√©ration en ligne avec MariaDB 10.4+)
ALTER TABLE users ENCRYPTED=YES ENCRYPTION_KEY_ID=1;

-- Chiffrement par lots (script pour toutes les tables)
DELIMITER $$
CREATE PROCEDURE encrypt_all_tables()
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE tbl_schema VARCHAR(64);
    DECLARE tbl_name VARCHAR(64);
    
    DECLARE table_cursor CURSOR FOR
        SELECT table_schema, table_name
        FROM information_schema.tables
        WHERE engine = 'InnoDB'
        AND table_schema NOT IN ('mysql', 'information_schema', 'performance_schema', 'sys')
        AND (create_options NOT LIKE '%ENCRYPTED=YES%' OR create_options IS NULL);
    
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;
    
    OPEN table_cursor;
    
    read_loop: LOOP
        FETCH table_cursor INTO tbl_schema, tbl_name;
        IF done THEN
            LEAVE read_loop;
        END IF;
        
        SET @sql = CONCAT('ALTER TABLE `', tbl_schema, '`.`', tbl_name, 
                          '` ENCRYPTED=YES ENCRYPTION_KEY_ID=1');
        
        PREPARE stmt FROM @sql;
        EXECUTE stmt;
        DEALLOCATE PREPARE stmt;
        
        SELECT CONCAT('Encrypted: ', tbl_schema, '.', tbl_name) AS status;
    END LOOP;
    
    CLOSE table_cursor;
END$$
DELIMITER ;

-- Ex√©cution
CALL encrypt_all_tables();
```

### D√©chiffrement de table

```sql
-- D√©sactiver le chiffrement (si n√©cessaire pour debug ou migration)
ALTER TABLE users ENCRYPTED=NO;

-- V√©rification
SELECT create_options FROM information_schema.tables
WHERE table_schema = DATABASE() AND table_name = 'users';
```

---

## Chiffrement Aria

### Configuration Aria

```ini
# Fichier my.cnf

[mysqld]
# Chiffrement Aria
aria_encrypt_tables = ON

# Logs Aria
encrypt_tmp_disk_tables = ON
encrypt_tmp_files = ON

# R√©pertoire temporaire chiffr√©
tmpdir = /var/lib/mysql/tmp
```

### Tables Aria chiffr√©es

```sql
-- Cr√©er table Aria chiffr√©e
CREATE TABLE aria_secure (
    id INT PRIMARY KEY,
    data TEXT
) ENGINE=Aria ENCRYPTED=YES;

-- Migration MyISAM ‚Üí Aria chiffr√©e
ALTER TABLE old_myisam_table 
ENGINE=Aria 
ENCRYPTED=YES 
ENCRYPTION_KEY_ID=1;

-- V√©rification
SHOW TABLE STATUS WHERE Name = 'aria_secure'\G
-- Engine: Aria
-- Create_options: encrypted=yes
```

---

## Plugins de gestion de cl√©s

### 1. file_key_management (par d√©faut)

**Avantages** :  
‚úÖ Simple √† configurer  
‚úÖ Pas de d√©pendances externes  
‚úÖ Id√©al pour dev/test

**Inconv√©nients** :  
‚ùå Cl√©s stock√©es sur m√™me serveur  
‚ùå Gestion manuelle rotation  
‚ùå Pas adapt√© production haute s√©curit√©

```ini
[mysqld]
plugin_load_add = file_key_management
file_key_management_filename = /etc/mysql/encryption/keyfile.enc
file_key_management_filekey = FILE:/etc/mysql/encryption/keyfile.key
file_key_management_encryption_algorithm = AES_CBC
```

### 2. AWS Key Management Service (KMS)

**Avantages** :  
‚úÖ Gestion centralis√©e des cl√©s  
‚úÖ Rotation automatique  
‚úÖ Audit trails int√©gr√© (CloudTrail)  
‚úÖ Haute disponibilit√©

**Configuration** :

```ini
[mysqld]
plugin_load_add = aws_key_management

# R√©gion AWS
aws_key_management_region = eu-west-1

# ARN de la cl√© ma√Ætre KMS
aws_key_management_master_key_id = arn:aws:kms:eu-west-1:123456789012:key/abcd-1234-efgh-5678

# Authentification (via IAM role ou credentials)
# Option 1 : IAM Instance Role (recommand√©)
# Option 2 : Credentials explicites
aws_key_management_key_spec = AES_256
```

**Configuration IAM policy** :

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "kms:Encrypt",
        "kms:Decrypt",
        "kms:GenerateDataKey",
        "kms:DescribeKey"
      ],
      "Resource": "arn:aws:kms:eu-west-1:123456789012:key/abcd-1234-efgh-5678"
    }
  ]
}
```

### 3. HashiCorp Vault

**Avantages** :  
‚úÖ Multi-cloud  
‚úÖ Gestion avanc√©e secrets  
‚úÖ Audit complet  
‚úÖ Dynamic secrets  

**Configuration** :

```ini
[mysqld]
plugin_load_add = hashicorp_key_management

# Adresse Vault
hashicorp_key_management_vault_url = https://vault.example.com:8200

# Authentification
hashicorp_key_management_token = s.xxxxxxxxxxxxxxxxxxxxxxxx

# Ou authentification AppRole
hashicorp_key_management_role_id = xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
hashicorp_key_management_secret_id = yyyyyyyy-yyyy-yyyy-yyyy-yyyyyyyyyyyy

# Chemin des cl√©s
hashicorp_key_management_vault_mount = mariadb/
hashicorp_key_management_vault_prefix = encryption_keys/
```

### 4. eperi Gateway

**Cas d'usage** : Conformit√© stricte (finance, sant√©)

```ini
[mysqld]
plugin_load_add = eperi_key_management

eperi_key_management_host = eperi-gateway.example.com
eperi_key_management_port = 9090
eperi_key_management_user = mariadb_service
eperi_key_management_password = <password>
```

---

## Chiffrement des logs

### Binary logs

```ini
[mysqld]
# Chiffrer binlogs
encrypt_binlog = ON

# Cl√© de chiffrement binlog
binlog_encryption_key_id = 3
```

```sql
-- V√©rifier chiffrement binlogs
SHOW BINARY LOGS;

-- V√©rifier variable
SHOW VARIABLES LIKE 'encrypt_binlog';
-- encrypt_binlog | ON
```

### Redo logs (InnoDB)

```ini
[mysqld]
# Redo logs chiffr√©s (inclus dans innodb_encrypt_log)
innodb_encrypt_log = ON
```

### Temporary files

```ini
[mysqld]
# Chiffrer fichiers temporaires
encrypt_tmp_disk_tables = ON
encrypt_tmp_files = ON
```

---

## Rotation des cl√©s

### Rotation automatique

```ini
[mysqld]
# Threads d√©di√©s √† la rotation
innodb_encryption_threads = 4

# Rotation apr√®s 30 jours
innodb_encryption_rotate_key_age = 30
```

**Processus de rotation** :
1. Nouvelle cl√© g√©n√©r√©e
2. Tables rechiffr√©es progressivement en arri√®re-plan
3. Ancienne cl√© conserv√©e pour d√©chiffrement tables non encore migr√©es
4. Cleanup apr√®s migration compl√®te

### Rotation manuelle

```bash
# 1. Ajouter nouvelle cl√© au keyfile
echo "4;$(openssl rand -hex 32)" >> /etc/mysql/encryption/keyfile.enc

# 2. Recharger les cl√©s (sans red√©marrage)
mysql -e "SET GLOBAL innodb_encryption_rotate_key_age = 1;"

# 3. Forcer rotation imm√©diate
mysql -e "ALTER INSTANCE ROTATE INNODB MASTER KEY;"
```

### Monitoring rotation

```sql
-- √âtat de la rotation
SELECT 
    SPACE AS tablespace_id,
    NAME AS tablespace_name,
    ENCRYPTION_SCHEME,
    CURRENT_KEY_VERSION,
    ROTATING_OR_FLUSHING
FROM information_schema.innodb_tablespaces_encryption
WHERE ENCRYPTION_SCHEME > 0
ORDER BY CURRENT_KEY_VERSION;

-- Tables avec rotation en cours
SELECT 
    table_schema,
    table_name,
    create_options
FROM information_schema.tables
WHERE create_options LIKE '%ENCRYPTED=YES%'
ORDER BY table_schema, table_name;
```

---

## Performance et overhead

### Impact mesur√©

```sql
-- Benchmark : insertion 1M lignes
-- Table non chiffr√©e : 45 secondes
-- Table chiffr√©e AES-256 : 48 secondes
-- Overhead : +6.7%

-- Benchmark : SELECT complexe avec JOINs
-- Non chiffr√© : 2.3 secondes
-- Chiffr√© : 2.5 secondes
-- Overhead : +8.7%
```

**Facteurs d'impact** :

| Op√©ration | Overhead typique |
|-----------|------------------|
| INSERT | 5-10% |
| UPDATE | 5-10% |
| DELETE | 3-5% |
| SELECT (full scan) | 8-12% |
| SELECT (index) | 3-5% |
| D√©marrage serveur | 10-15% |

### Optimisations

```ini
[mysqld]
# CPU avec AES-NI (instructions mat√©rielles)
# ‚Üí Overhead r√©duit √† 2-3% !

# Buffer pool plus large pour compenser
innodb_buffer_pool_size = 16G  # Au lieu de 12G

# Threads rotation en heures creuses
innodb_encryption_threads = 2  # R√©duit charge CPU
```

### V√©rifier support AES-NI

```bash
# Linux : v√©rifier support mat√©riel AES
grep -m1 -o aes /proc/cpuinfo
# R√©sultat : aes (support√©)

# V√©rifier que MariaDB utilise AES-NI
mysql -e "SHOW VARIABLES LIKE 'have_openssl';"
# have_openssl | YES (compile avec OpenSSL qui utilise AES-NI)
```

---

## Cas d'usage production

### 1. Application sant√© (HIPAA)

```sql
-- Chiffrement strict donn√©es patients
CREATE TABLE patients (
    patient_id INT PRIMARY KEY AUTO_INCREMENT,
    first_name VARCHAR(50) ENCRYPTED=YES,
    last_name VARCHAR(50) ENCRYPTED=YES,
    ssn VARCHAR(11) ENCRYPTED=YES,
    date_of_birth DATE,
    medical_history TEXT,
    
    INDEX idx_name (last_name, first_name)
) ENGINE=InnoDB 
  ENCRYPTED=YES 
  ENCRYPTION_KEY_ID=100  -- Cl√© d√©di√©e donn√©es sant√©
  ROW_FORMAT=COMPRESSED; -- Compression + chiffrement
```

**Configuration** :

```ini
[mysqld]
# KMS d√©di√© healthcare
aws_key_management_master_key_id = arn:aws:kms:us-east-1:xxx:key/healthcare-master

# Rotation agressive (7 jours)
innodb_encryption_rotate_key_age = 7

# Logs chiffr√©s
encrypt_binlog = ON
innodb_encrypt_log = ON
```

### 2. E-commerce (PCI-DSS)

```sql
-- Donn√©es cartes bancaires
CREATE TABLE payment_methods (
    payment_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    customer_id INT,
    card_number_hash CHAR(64), -- Hash SHA-256
    card_last4 CHAR(4),
    expiry_encrypted VARBINARY(100), -- Chiffr√© application-level
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB 
  ENCRYPTED=YES 
  ENCRYPTION_KEY_ID=200; -- Cl√© d√©di√©e paiements

-- Double chiffrement : TDE + application-level
```

### 3. Finance (SOX)

```sql
-- Audit trail immuable
CREATE TABLE audit_log (
    audit_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id INT,
    action VARCHAR(100),
    table_name VARCHAR(64),
    record_id VARCHAR(100),
    old_values JSON,
    new_values JSON,
    timestamp TIMESTAMP(6) DEFAULT CURRENT_TIMESTAMP(6),
    ip_address VARCHAR(45)
) ENGINE=InnoDB 
  ENCRYPTED=YES 
  ENCRYPTION_KEY_ID=300
  ROW_FORMAT=COMPRESSED;

-- Pas de DELETE/UPDATE autoris√©
REVOKE DELETE, UPDATE ON audit_log FROM 'app_user'@'%';
```

### 4. Cloud multi-tenant

```sql
-- Chiffrement par tenant
CREATE TABLE tenant_1_data (
    id INT PRIMARY KEY,
    sensitive_field VARCHAR(200)
) ENGINE=InnoDB 
  ENCRYPTED=YES 
  ENCRYPTION_KEY_ID=1001; -- Cl√© tenant 1

CREATE TABLE tenant_2_data (
    id INT PRIMARY KEY,
    sensitive_field VARCHAR(200)
) ENGINE=InnoDB 
  ENCRYPTED=YES 
  ENCRYPTION_KEY_ID=1002; -- Cl√© tenant 2

-- Isolation cryptographique entre tenants
```

---

## Sauvegarde de bases chiffr√©es

### Mariabackup

```bash
# Backup base chiffr√©e (donn√©es restent chiffr√©es)
mariabackup --backup \
  --target-dir=/backup/full-$(date +%Y%m%d) \
  --user=backup_user \
  --password=<password>

# Restore (keyfile n√©cessaire)
mariabackup --copy-back \
  --target-dir=/backup/full-20251214

# ‚ö†Ô∏è CRITIQUE : Conserver le keyfile s√©par√©ment et s√©curis√© !
```

### mysqldump (donn√©es d√©chiffr√©es)

```bash
# mysqldump exporte donn√©es d√©chiffr√©es !
mysqldump --all-databases > backup.sql
# ‚ö†Ô∏è backup.sql n'est PAS chiffr√©

# Solution : chiffrer le dump
mysqldump --all-databases | \
  openssl enc -aes-256-cbc -pbkdf2 -out backup.sql.enc

# Restore
openssl enc -d -aes-256-cbc -pbkdf2 -in backup.sql.enc | \
  mysql
```

### Strat√©gie backup s√©curis√©

```bash
#!/bin/bash
# Script backup chiffr√©

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/mnt/secure-backup"
GPG_RECIPIENT="backup@example.com"

# 1. Mariabackup (donn√©es chiffr√©es au repos)
mariabackup --backup --target-dir=/tmp/backup-$DATE

# 2. Archiver
tar czf /tmp/backup-$DATE.tar.gz /tmp/backup-$DATE

# 3. Chiffrer avec GPG
gpg --encrypt --recipient $GPG_RECIPIENT \
    --output $BACKUP_DIR/backup-$DATE.tar.gz.gpg \
    /tmp/backup-$DATE.tar.gz

# 4. Copier keyfile chiffr√© s√©par√©ment
gpg --encrypt --recipient $GPG_RECIPIENT \
    --output $BACKUP_DIR/keyfile-$DATE.enc.gpg \
    /etc/mysql/encryption/keyfile.enc

# 5. Cleanup
rm -rf /tmp/backup-$DATE /tmp/backup-$DATE.tar.gz

# 6. Upload vers S3 (optionnel)
aws s3 cp $BACKUP_DIR/backup-$DATE.tar.gz.gpg \
    s3://my-encrypted-backups/ --sse aws:kms
```

---

## Monitoring et audit

### Variables de monitoring

```sql
-- √âtat global du chiffrement
SHOW VARIABLES WHERE Variable_name LIKE '%encrypt%' 
                 OR Variable_name LIKE '%encryption%';

-- Compteurs de rotation
SHOW GLOBAL STATUS WHERE Variable_name LIKE '%encrypt%' 
                      OR Variable_name LIKE '%encryption%';
```

### Audit des tables chiffr√©es

```sql
-- Vue synth√©tique du chiffrement
CREATE VIEW encryption_status AS
SELECT 
    table_schema,
    table_name,
    engine,
    CASE 
        WHEN create_options LIKE '%ENCRYPTED=YES%' THEN 'YES'
        WHEN create_options LIKE '%ENCRYPTED=NO%' THEN 'NO'
        ELSE 'DEFAULT'
    END AS encrypted,
    SUBSTRING_INDEX(SUBSTRING_INDEX(create_options, 'ENCRYPTION_KEY_ID=', -1), ' ', 1) AS key_id,
    ROUND((data_length + index_length) / 1024 / 1024, 2) AS size_mb
FROM information_schema.tables
WHERE table_schema NOT IN ('mysql', 'information_schema', 'performance_schema', 'sys')
AND engine IN ('InnoDB', 'Aria')
ORDER BY size_mb DESC;

-- Utilisation
SELECT * FROM encryption_status;
```

### Alertes automatiques

```sql
-- Event : v√©rifier tables non chiffr√©es
DELIMITER $$
CREATE EVENT check_unencrypted_tables
ON SCHEDULE EVERY 1 DAY
DO
BEGIN
    DECLARE unencrypted_count INT;
    
    SELECT COUNT(*) INTO unencrypted_count
    FROM information_schema.tables
    WHERE table_schema NOT IN ('mysql', 'information_schema', 'performance_schema', 'sys')
    AND engine = 'InnoDB'
    AND (create_options NOT LIKE '%ENCRYPTED=YES%' OR create_options IS NULL);
    
    IF unencrypted_count > 0 THEN
        -- Logger l'alerte
        INSERT INTO security_alerts (alert_type, message, alert_date)
        VALUES ('UNENCRYPTED_TABLES', 
                CONCAT(unencrypted_count, ' tables non chiffr√©es d√©tect√©es'),
                NOW());
    END IF;
END$$
DELIMITER ;
```

---

## Troubleshooting

### Probl√®me : Erreur au d√©marrage

```
[ERROR] InnoDB: Encryption algorithm support missing
```

**Solution** :

```bash
# V√©rifier OpenSSL install√©
openssl version
# OpenSSL 1.1.1 ou sup√©rieur requis

# V√©rifier compilation MariaDB avec SSL
mysql -V | grep SSL
# MariaDB ... SSL

# Recompiler si n√©cessaire avec -DWITH_SSL=system
```

### Probl√®me : Cl√© introuvable

```
[ERROR] InnoDB: Cannot find encryption key for tablespace
```

**Solution** :

```bash
# 1. V√©rifier existence keyfile
ls -la /etc/mysql/encryption/keyfile.enc

# 2. V√©rifier permissions
chmod 600 /etc/mysql/encryption/keyfile.enc
chown mysql:mysql /etc/mysql/encryption/keyfile.enc

# 3. V√©rifier configuration
grep file_key_management /etc/mysql/my.cnf

# 4. V√©rifier contenu keyfile (format correct)
cat /etc/mysql/encryption/keyfile.enc
# Format : key_id;hex_key
```

### Probl√®me : Performance d√©grad√©e

```sql
-- Identifier tables avec rotation en cours
SELECT 
    NAME,
    ROTATING_OR_FLUSHING,
    CURRENT_KEY_VERSION
FROM information_schema.innodb_tablespaces_encryption
WHERE ROTATING_OR_FLUSHING = 1;

-- Solution : r√©duire threads rotation en heures ouvr√©es
SET GLOBAL innodb_encryption_threads = 1;

-- Reprendre en heures creuses
-- (via cron ou event scheduler)
SET GLOBAL innodb_encryption_threads = 4;
```

---

## Conformit√© r√©glementaire

### RGPD (UE)

**Exigences** :
- Chiffrement donn√©es personnelles recommand√©
- Droit √† l'oubli ‚Üí suppression garantie

```sql
-- Pseudonymisation avec chiffrement
CREATE TABLE gdpr_users (
    user_id INT PRIMARY KEY,
    email_encrypted VARBINARY(200),
    name_encrypted VARBINARY(200),
    consent_date DATE
) ENGINE=InnoDB ENCRYPTED=YES;

-- Suppression d√©finitive
DELETE FROM gdpr_users WHERE user_id = 12345;
-- Avec encryption at rest, donn√©es irr√©cup√©rables sur disque
```

### HIPAA (USA - Sant√©)

**Exigences** :
- Chiffrement obligatoire ePHI (Protected Health Information)
- Audit trail complet
- Rotation cl√©s r√©guli√®re

```ini
[mysqld]
# Configuration HIPAA-compliant
innodb_encrypt_tables = FORCE  # Interdit tables non chiffr√©es
innodb_encrypt_log = ON
encrypt_binlog = ON
innodb_encryption_rotate_key_age = 7  # Rotation hebdomadaire
```

### PCI-DSS (Paiements)

**Exigences** :
- Chiffrement donn√©es cartes bancaires
- Cl√©s de chiffrement s√©par√©es des donn√©es
- Logs d'acc√®s complets

```sql
-- Pas de stockage CVV (interdit PCI-DSS)
CREATE TABLE payments (
    payment_id BIGINT PRIMARY KEY,
    card_number_encrypted VARBINARY(200),  -- Chiffr√©
    card_last4 CHAR(4),  -- Clair (autoris√©)
    expiry_month TINYINT,
    expiry_year SMALLINT
    -- PAS DE CVV !
) ENGINE=InnoDB ENCRYPTED=YES ENCRYPTION_KEY_ID=200;
```

---

## Bonnes pratiques

### ‚úÖ Recommandations

1. **S√©parer les cl√©s des donn√©es**
   ```bash
   # Keyfile sur volume s√©par√©, chiffr√© au niveau OS
   /mnt/secure-keys/keyfile.enc  # Volume LUKS ou AWS EBS encrypted
   ```

2. **Utiliser KMS centralis√© en production**
   ```ini
   # Pr√©f√©rer AWS KMS, Vault vs file_key_management
   plugin_load_add = aws_key_management
   ```

3. **Chiffrer tous les composants**
   ```ini
   innodb_encrypt_tables = FORCE  # Interdit non-chiffr√©
   innodb_encrypt_log = ON
   encrypt_binlog = ON
   encrypt_tmp_disk_tables = ON
   ```

4. **Rotation r√©guli√®re**
   ```ini
   # Mensuel minimum, hebdomadaire pour haute s√©curit√©
   innodb_encryption_rotate_key_age = 30
   ```

5. **Backup s√©curis√©s**
   ```bash
   # Backups chiffr√©s + keyfile s√©par√©
   mariabackup ... && gpg --encrypt ...
   ```

6. **Monitoring continu**
   ```sql
   -- Event quotidien v√©rifiant conformit√©
   CREATE EVENT daily_encryption_audit ...
   ```

7. **Tester les restores**
   ```bash
   # Test mensuel restauration backup chiffr√©
   # V√©rifier disponibilit√© keyfile
   ```

### ‚ö†Ô∏è Pi√®ges √† √©viter

1. **Keyfile sur m√™me disque que donn√©es** ‚Üí Perte de s√©curit√©
2. **Oublier de chiffrer binlogs** ‚Üí Fuite dans r√©plication
3. **mysqldump sans rechiffrement** ‚Üí Export en clair
4. **Rotation manqu√©e** ‚Üí Vieilles cl√©s compromettables
5. **Pas de backup keyfile** ‚Üí Perte d√©finitive donn√©es
6. **Performance non test√©e** ‚Üí Surprise production

---

## ‚úÖ Points cl√©s √† retenir

- Le chiffrement au repos prot√®ge les **fichiers physiques** contre acc√®s non autoris√©
- **Transparent Data Encryption (TDE)** : aucun changement applicatif requis
- **AES-256-CBC** recommand√© pour conformit√© maximale
- Overhead performance : **5-10%** (2-3% avec AES-NI mat√©riel)
- **file_key_management** pour dev, **KMS centralis√©** (AWS KMS, Vault) pour production
- Chiffrer **tables + logs** (redo, binlog, temp files)
- **Rotation des cl√©s** automatique ou manuelle r√©guli√®re
- **Backups** : mariabackup pr√©serve chiffrement, mysqldump d√©chiffre
- **S√©paration keyfile/donn√©es** critique pour s√©curit√©
- Conformit√© : **RGPD, HIPAA, PCI-DSS** n√©cessitent chiffrement au repos

---

## üîó Ressources et r√©f√©rences

- [üìñ MariaDB - Data at Rest Encryption](https://mariadb.com/kb/en/data-at-rest-encryption/)
- [üìñ InnoDB Encryption](https://mariadb.com/kb/en/innodb-encryption/)
- [üìñ Encryption Plugins](https://mariadb.com/kb/en/encryption-plugins/)
- [üìñ AWS Key Management Plugin](https://mariadb.com/kb/en/aws-key-management-encryption-plugin/)
- [üìñ File Key Management Plugin](https://mariadb.com/kb/en/file-key-management-encryption-plugin/)
- [üîí NIST Encryption Standards](https://csrc.nist.gov/projects/cryptographic-standards-and-guidelines)
- [üîí RGPD - Encryption Requirements](https://gdpr-info.eu/)

---

## ‚û°Ô∏è Section suivante

**18.7.2 [Key Management](./07.2-key-management.md)** : Approfondissez la gestion avanc√©e des cl√©s de chiffrement : rotation, versioning, r√©cup√©ration apr√®s sinistre, int√©gration HSM et strat√©gies multi-cloud.

‚è≠Ô∏è [Key management](/18-fonctionnalites-avancees/07.2-key-management.md)
