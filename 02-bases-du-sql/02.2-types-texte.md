üîù Retour au [Sommaire](/SOMMAIRE.md)

# 2.2.2 Types de donn√©es texte

> **Niveau** : D√©butant
> **Dur√©e estim√©e** : 1-1.5 heures
> **Pr√©requis** : Section 2.2.1 (Types num√©riques)

## üéØ Objectifs d'apprentissage

√Ä l'issue de cette section, vous serez capable de :
- Distinguer VARCHAR, TEXT, CHAR et choisir le type appropri√©
- Comprendre les types ENUM et SET pour des valeurs pr√©d√©finies
- Ma√Ætriser les concepts de charset (jeu de caract√®res) et collation
- Utiliser correctement utf8mb4 (d√©faut dans MariaDB 11.8)
- Conna√Ætre les limites de longueur de chaque type
- √âviter les pi√®ges courants li√©s aux types texte

---

## Introduction

Les **types de donn√©es texte** permettent de stocker des cha√Ænes de caract√®res dans MariaDB. Le choix du bon type impacte :

- üíæ **L'espace de stockage** : CHAR(10) occupe toujours 10 caract√®res, VARCHAR(10) est variable
- ‚ö° **Les performances** : VARCHAR est plus rapide que TEXT pour les petites cha√Ænes
- üîç **L'indexation** : TEXT n√©cessite une longueur de pr√©fixe pour les index
- üåç **L'internationalisation** : Choix du charset (utf8mb4 recommand√©)

üÜï **MariaDB 11.8** : Le charset par d√©faut est maintenant **utf8mb4** avec la collation **utf8mb4_uca_1400_ai_ci** (Unicode Collation Algorithm 14.0.0), offrant un meilleur support Unicode et des performances am√©lior√©es.

---

## Vue d'ensemble des types texte

| Type | Longueur max | Pr√©fixe requis | Stockage | Usage principal |
|------|--------------|----------------|----------|-----------------|
| **CHAR(M)** | 255 caract√®res | Non | Fixe (M octets) | Codes fixes, abr√©viations |
| **VARCHAR(M)** | 65,535 octets | Non | Variable + 1-2 octets | Texte court √† moyen |
| **TINYTEXT** | 255 octets | Oui (indexation) | Variable + 1 octet | Tr√®s court texte |
| **TEXT** | 65,535 octets | Oui | Variable + 2 octets | Texte moyen |
| **MEDIUMTEXT** | 16,777,215 octets | Oui | Variable + 3 octets | Texte long |
| **LONGTEXT** | 4,294,967,295 octets | Oui | Variable + 4 octets | Tr√®s long texte |
| **ENUM** | 65,535 valeurs | Non | 1-2 octets | Liste ferm√©e de valeurs |
| **SET** | 64 membres | Non | 1-8 octets | Combinaisons de valeurs |

üí° **Note** : Avec utf8mb4, un caract√®re peut occuper jusqu'√† 4 octets (emoji, caract√®res asiatiques).

---

## CHAR - Cha√Æne de longueur fixe

### Caract√©ristiques

**CHAR(M)** stocke une cha√Æne de longueur **fixe** de M caract√®res (0-255).

- Toujours rempli avec des espaces √† droite jusqu'√† M caract√®res
- Occupe toujours M √ó (octets par caract√®re) d'espace
- Rapide pour les recherches (longueur fixe)
- Id√©al pour les codes, identifiants de taille fixe

```sql
-- Cr√©ation d'une table avec CHAR
CREATE TABLE codes_pays (
    code_iso CHAR(2) PRIMARY KEY,          -- Toujours 2 caract√®res : FR, US, DE
    code_iso3 CHAR(3) NOT NULL,            -- Toujours 3 caract√®res : FRA, USA, DEU
    indicatif_tel CHAR(5),                 -- Format : +33 (avec espaces)
    nom_pays VARCHAR(100) NOT NULL
);

-- Insertion de donn√©es
INSERT INTO codes_pays VALUES
    ('FR', 'FRA', '+33', 'France'),
    ('US', 'USA', '+1', '√âtats-Unis'),
    ('DE', 'DEU', '+49', 'Allemagne'),
    ('JP', 'JPN', '+81', 'Japon');

-- Requ√™te
SELECT code_iso, nom_pays
FROM codes_pays
WHERE code_iso = 'FR';
```

### Comportement avec les espaces

```sql
-- D√©monstration du padding automatique
CREATE TABLE demo_char (
    code CHAR(5),
    description VARCHAR(50)
);

-- Insertion avec diff√©rentes longueurs
INSERT INTO demo_char VALUES
    ('A', 'Un seul caract√®re'),      -- Stock√© comme 'A    ' (4 espaces ajout√©s)
    ('ABC', 'Trois caract√®res'),     -- Stock√© comme 'ABC  ' (2 espaces ajout√©s)
    ('ABCDE', 'Cinq caract√®res');    -- Stock√© comme 'ABCDE' (aucun espace)

-- Les espaces sont supprim√©s √† la lecture
SELECT code, LENGTH(code), CHAR_LENGTH(code) FROM demo_char;
-- R√©sultat : tous retournent longueur 1, 3, 5 (espaces supprim√©s)

-- Pour garder les espaces, utiliser VARCHAR
CREATE TABLE demo_varchar (
    code VARCHAR(5)
);

INSERT INTO demo_varchar VALUES ('A  ');  -- Garde les 2 espaces
SELECT LENGTH(code) FROM demo_varchar;     -- Retourne 3
```

üí° **Quand utiliser CHAR** :
- ‚úÖ Codes pays (ISO 2 ou 3 lettres)
- ‚úÖ Codes postaux de longueur fixe
- ‚úÖ Hash MD5/SHA (longueur fixe)
- ‚úÖ Identifiants format√©s (SKU de 8 caract√®res)
- ‚ùå Noms, descriptions (longueur variable)

‚ö†Ô∏è **Attention** : Avec utf8mb4, CHAR(10) peut occuper jusqu'√† 40 octets (10 caract√®res √ó 4 octets max).

---

## VARCHAR - Cha√Æne de longueur variable

### Caract√©ristiques

**VARCHAR(M)** stocke une cha√Æne de longueur **variable** jusqu'√† M caract√®res.

- Utilise uniquement l'espace n√©cessaire + 1 ou 2 octets de pr√©fixe
- M peut aller jusqu'√† 65,535 octets (limit√© par la taille de ligne)
- Type le plus utilis√© pour le texte court √† moyen
- Peut √™tre index√© sans pr√©fixe

```sql
-- Cr√©ation d'une table avec VARCHAR
CREATE TABLE utilisateurs (
    utilisateur_id INT PRIMARY KEY AUTO_INCREMENT,
    nom VARCHAR(50) NOT NULL,                    -- Nom jusqu'√† 50 caract√®res
    prenom VARCHAR(50) NOT NULL,                 -- Pr√©nom jusqu'√† 50 caract√®res
    email VARCHAR(255) UNIQUE NOT NULL,          -- Email (standard 255)
    ville VARCHAR(100),                          -- Ville
    biographie VARCHAR(500),                     -- Courte bio
    INDEX idx_nom (nom),                         -- Index possible sans pr√©fixe
    INDEX idx_email (email)
);

-- Insertion
INSERT INTO utilisateurs (nom, prenom, email, ville, biographie) VALUES
    ('Dupont', 'Marie', 'marie.dupont@example.com', 'Paris',
     'Passionn√©e de technologie et de litt√©rature.'),
    ('Martin', 'Jean', 'jean.martin@example.com', 'Lyon',
     'D√©veloppeur full-stack depuis 10 ans.'),
    ('Bernard', 'Sophie', 'sophie.bernard@example.com', 'Marseille', NULL);

-- Requ√™tes efficaces gr√¢ce aux index
SELECT * FROM utilisateurs WHERE nom = 'Dupont';
SELECT * FROM utilisateurs WHERE email LIKE '%@example.com';
```

### Calcul de l'espace de stockage

```sql
-- D√©monstration de l'espace variable
CREATE TABLE demo_varchar_storage (
    texte_court VARCHAR(100),
    texte_moyen VARCHAR(1000),
    texte_long VARCHAR(5000)
);

INSERT INTO demo_varchar_storage VALUES
    ('Court', 'Moyen', 'Long texte r√©p√©t√©... [imagine 500 caract√®res]');

-- V√©rification de l'espace utilis√©
SELECT
    LENGTH(texte_court) AS longueur_court,      -- 5 octets + pr√©fixe
    LENGTH(texte_moyen) AS longueur_moyen,      -- 5 octets + pr√©fixe
    LENGTH(texte_long) AS longueur_long         -- 500 octets + pr√©fixe
FROM demo_varchar_storage;
```

üí° **Longueur recommand√©e par usage** :
- Nom/pr√©nom : `VARCHAR(50)` ou `VARCHAR(100)`
- Email : `VARCHAR(255)` (standard RFC)
- URL : `VARCHAR(2083)` (limite IE)
- Titre : `VARCHAR(200)`
- Description courte : `VARCHAR(500)`
- Adresse : `VARCHAR(255)`

‚ö†Ô∏è **Limite importante** : La longueur maximale r√©elle d√©pend de :
- La taille maximale de ligne (65,535 octets pour toutes les colonnes)
- Le charset utilis√© (utf8mb4 = 4 octets max par caract√®re)

```sql
-- ‚ùå Ceci peut √©chouer si la ligne est trop grande
CREATE TABLE trop_large (
    col1 VARCHAR(65535),  -- Th√©oriquement 65535 caract√®res
    col2 VARCHAR(100)     -- Mais total ligne > 65535 octets
);
-- ERROR: Row size too large

-- ‚úÖ Solution : Utiliser TEXT pour les grandes colonnes
CREATE TABLE correct (
    col1 TEXT,            -- Stock√© hors de la ligne principale
    col2 VARCHAR(100)
);
```

---

## TEXT - Types pour texte long

MariaDB propose **4 types TEXT** de tailles diff√©rentes :

### Comparaison des types TEXT

| Type | Longueur maximale | Pr√©fixe longueur | Usage typique |
|------|-------------------|------------------|---------------|
| **TINYTEXT** | 255 octets | 1 octet | Tr√®s court (notes) |
| **TEXT** | 65,535 octets (~64 KB) | 2 octets | Articles courts |
| **MEDIUMTEXT** | 16,777,215 octets (~16 MB) | 3 octets | Articles longs |
| **LONGTEXT** | 4,294,967,295 octets (~4 GB) | 4 octets | Livres, gros documents |

### TEXT - Le type standard

```sql
-- Exemple : Blog avec articles
CREATE TABLE articles (
    article_id INT PRIMARY KEY AUTO_INCREMENT,
    titre VARCHAR(200) NOT NULL,
    auteur VARCHAR(100) NOT NULL,
    resume VARCHAR(500),                        -- R√©sum√© court
    contenu TEXT NOT NULL,                      -- Contenu principal (jusqu'√† 64KB)
    date_publication DATE,
    INDEX idx_titre (titre),
    -- Index avec pr√©fixe obligatoire pour TEXT
    INDEX idx_contenu (contenu(100))            -- Index sur les 100 premiers caract√®res
);

-- Insertion d'un article
INSERT INTO articles (titre, auteur, resume, contenu, date_publication) VALUES
    (
        'Introduction √† MariaDB 11.8',
        'Jean Dupont',
        'D√©couvrez les nouveaut√©s de MariaDB 11.8 LTS, notamment le type VECTOR.',
        'MariaDB 11.8 LTS est une version majeure sortie en juin 2025... [contenu complet de l\'article]',
        '2025-12-12'
    );

-- Recherche dans le contenu (utilise l'index pr√©fixe)
SELECT titre, auteur
FROM articles
WHERE contenu LIKE 'MariaDB%';

-- Recherche fulltext (plus efficace pour le texte long)
ALTER TABLE articles ADD FULLTEXT INDEX idx_fulltext_contenu (contenu);

SELECT titre
FROM articles
WHERE MATCH(contenu) AGAINST('MariaDB VECTOR' IN NATURAL LANGUAGE MODE);
```

### MEDIUMTEXT - Pour texte tr√®s long

```sql
-- Exemple : Plateforme d'√©criture
CREATE TABLE manuscrits (
    manuscrit_id INT PRIMARY KEY AUTO_INCREMENT,
    titre VARCHAR(200) NOT NULL,
    auteur_id INT NOT NULL,
    contenu MEDIUMTEXT,                         -- Jusqu'√† 16MB de texte
    date_creation DATETIME DEFAULT CURRENT_TIMESTAMP,
    date_modification DATETIME ON UPDATE CURRENT_TIMESTAMP
);

-- Insertion d'un long manuscrit
INSERT INTO manuscrits (titre, auteur_id, contenu) VALUES
    ('Mon roman complet', 1001, 'Chapitre 1... [imagine des milliers de pages]');

-- Compte de mots approximatif
SELECT
    titre,
    CHAR_LENGTH(contenu) AS nombre_caracteres,
    CHAR_LENGTH(contenu) - CHAR_LENGTH(REPLACE(contenu, ' ', '')) + 1 AS nombre_mots_approx
FROM manuscrits;
```

### LONGTEXT - Pour contenus massifs

```sql
-- Exemple : Syst√®me de stockage de logs
CREATE TABLE logs_application (
    log_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    application VARCHAR(50),
    niveau_log VARCHAR(10),                     -- DEBUG, INFO, ERROR
    message LONGTEXT,                           -- Logs d√©taill√©s (jusqu'√† 4GB)
    date_log DATETIME DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_date (date_log),
    INDEX idx_niveau (niveau_log)
);

-- Insertion de logs volumineux
INSERT INTO logs_application (application, niveau_log, message) VALUES
    ('API', 'ERROR', 'Stack trace complet avec tous les d√©tails... [peut √™tre tr√®s long]');
```

üí° **Diff√©rence TEXT vs VARCHAR** :

| Crit√®re | VARCHAR | TEXT |
|---------|---------|------|
| Stockage | Dans la ligne | Hors ligne (pointeur) |
| Index | Sans pr√©fixe | Pr√©fixe requis |
| Longueur max | 65,535 octets (limit√© par ligne) | Jusqu'√† 4 GB (LONGTEXT) |
| Performance | Plus rapide (petites valeurs) | Moins rapide |
| Default | Possible | ‚ùå Impossible |
| ORDER BY | Rapide | Plus lent |

```sql
-- ‚úÖ VARCHAR permet DEFAULT
CREATE TABLE test_varchar (
    description VARCHAR(100) DEFAULT 'Aucune description'
);

-- ‚ùå TEXT n'autorise pas DEFAULT
CREATE TABLE test_text (
    description TEXT DEFAULT 'Aucune description'
);
-- ERROR: BLOB/TEXT column 'description' can't have a default value
```

---

## ENUM - Liste de valeurs pr√©d√©finies

### Caract√©ristiques

**ENUM('valeur1', 'valeur2', ...)** permet de stocker **une seule valeur** parmi une liste pr√©d√©finie.

- Stockage tr√®s compact : 1-2 octets (index interne)
- Maximum 65,535 valeurs distinctes
- Valeurs stock√©es comme des entiers en interne
- Id√©al pour les statuts, cat√©gories ferm√©es

```sql
-- Exemple : Gestion de commandes
CREATE TABLE commandes (
    commande_id INT PRIMARY KEY AUTO_INCREMENT,
    client_id INT NOT NULL,

    -- ENUM pour le statut (une seule valeur possible)
    statut ENUM(
        'en_attente',
        'confirmee',
        'en_preparation',
        'expediee',
        'livree',
        'annulee'
    ) NOT NULL DEFAULT 'en_attente',

    -- ENUM pour la priorit√©
    priorite ENUM('basse', 'normale', 'haute', 'urgente') DEFAULT 'normale',

    montant DECIMAL(10,2),
    date_commande DATETIME DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_statut (statut)
);

-- Insertion avec valeurs ENUM
INSERT INTO commandes (client_id, statut, priorite, montant) VALUES
    (1001, 'en_attente', 'normale', 99.99),
    (1002, 'confirmee', 'haute', 249.50),
    (1003, 'expediee', 'urgente', 499.00);

-- Requ√™tes avec ENUM
SELECT * FROM commandes WHERE statut = 'expediee';
SELECT * FROM commandes WHERE priorite IN ('haute', 'urgente');

-- Mise √† jour de statut
UPDATE commandes
SET statut = 'livree'
WHERE commande_id = 3 AND statut = 'expediee';

-- ‚ùå Tentative d'insertion d'une valeur non d√©finie
INSERT INTO commandes (client_id, statut, montant) VALUES
    (1004, 'invalide', 150.00);
-- ERROR: Data truncated for column 'statut' (devient cha√Æne vide)
```

### Requ√™tes sur ENUM

```sql
-- Compter par statut
SELECT
    statut,
    COUNT(*) AS nombre_commandes,
    SUM(montant) AS total_montant
FROM commandes
GROUP BY statut
ORDER BY FIELD(statut, 'en_attente', 'confirmee', 'en_preparation', 'expediee', 'livree', 'annulee');

-- Utilisation des valeurs num√©riques internes (d√©conseill√©)
SELECT * FROM commandes WHERE statut = 1;  -- 1 = premi√®re valeur = 'en_attente'
```

üí° **Avantages ENUM** :
- ‚úÖ Stockage compact (1-2 octets)
- ‚úÖ Validation automatique des valeurs
- ‚úÖ Index tr√®s performant
- ‚úÖ Liste des valeurs dans la structure de la table

‚ö†Ô∏è **Inconv√©nients ENUM** :
- ‚ùå Modification de la liste = ALTER TABLE (lent sur grandes tables)
- ‚ùå Difficile √† internationaliser
- ‚ùå Logique m√©tier dans la base de donn√©es
- ‚ùå Mauvaise pratique selon certains DBA (pr√©f√©rer table de r√©f√©rence)

### Alternative : Table de r√©f√©rence

```sql
-- ‚úÖ Approche "propre" : Table de r√©f√©rence
CREATE TABLE statuts_commande (
    statut_id TINYINT PRIMARY KEY AUTO_INCREMENT,
    code VARCHAR(30) UNIQUE NOT NULL,
    libelle VARCHAR(50) NOT NULL,
    ordre_affichage TINYINT,
    actif BOOLEAN DEFAULT TRUE
);

INSERT INTO statuts_commande (code, libelle, ordre_affichage) VALUES
    ('en_attente', 'En attente', 1),
    ('confirmee', 'Confirm√©e', 2),
    ('en_preparation', 'En pr√©paration', 3),
    ('expediee', 'Exp√©di√©e', 4),
    ('livree', 'Livr√©e', 5),
    ('annulee', 'Annul√©e', 6);

CREATE TABLE commandes_avec_fk (
    commande_id INT PRIMARY KEY AUTO_INCREMENT,
    client_id INT NOT NULL,
    statut_id TINYINT NOT NULL,
    montant DECIMAL(10,2),
    FOREIGN KEY (statut_id) REFERENCES statuts_commande(statut_id)
);

-- Plus flexible pour ajouter de nouveaux statuts sans ALTER TABLE
```

---

## SET - Ensemble de valeurs

### Caract√©ristiques

**SET('valeur1', 'valeur2', ...)** permet de stocker **plusieurs valeurs** simultan√©ment.

- Stockage : 1-8 octets selon le nombre de membres (bitmap)
- Maximum 64 membres diff√©rents
- Valeurs stock√©es comme un bitmap (chaque bit = une valeur)

```sql
-- Exemple : Permissions utilisateur
CREATE TABLE utilisateurs_permissions (
    utilisateur_id INT PRIMARY KEY AUTO_INCREMENT,
    nom VARCHAR(100) NOT NULL,

    -- SET : plusieurs permissions possibles simultan√©ment
    permissions SET(
        'lecture',
        'ecriture',
        'suppression',
        'admin',
        'moderation',
        'publication',
        'statistiques',
        'configuration'
    ) NOT NULL DEFAULT 'lecture'
);

-- Insertion avec une seule permission
INSERT INTO utilisateurs_permissions (nom, permissions) VALUES
    ('Visiteur', 'lecture');

-- Insertion avec plusieurs permissions (s√©par√©es par virgule)
INSERT INTO utilisateurs_permissions (nom, permissions) VALUES
    ('R√©dacteur', 'lecture,ecriture,publication'),
    ('Mod√©rateur', 'lecture,ecriture,moderation'),
    ('Admin', 'lecture,ecriture,suppression,admin,moderation,publication,statistiques,configuration');

-- Consultation
SELECT nom, permissions FROM utilisateurs_permissions;

-- R√©sultat :
-- Visiteur    | lecture
-- R√©dacteur   | lecture,ecriture,publication
-- Mod√©rateur  | lecture,ecriture,moderation
-- Admin       | lecture,ecriture,suppression,admin,moderation,publication,statistiques,configuration
```

### Requ√™tes avec SET

```sql
-- Rechercher les utilisateurs avec une permission sp√©cifique
SELECT nom, permissions
FROM utilisateurs_permissions
WHERE FIND_IN_SET('admin', permissions) > 0;

-- Utiliser LIKE (moins optimal)
SELECT nom
FROM utilisateurs_permissions
WHERE permissions LIKE '%admin%';

-- V√©rifier plusieurs permissions
SELECT nom, permissions
FROM utilisateurs_permissions
WHERE FIND_IN_SET('ecriture', permissions) > 0
  AND FIND_IN_SET('publication', permissions) > 0;

-- Ajouter une permission
UPDATE utilisateurs_permissions
SET permissions = CONCAT(permissions, ',statistiques')
WHERE nom = 'R√©dacteur'
  AND FIND_IN_SET('statistiques', permissions) = 0;
```

üí° **Cas d'usage SET** :
- ‚úÖ Tags, cat√©gories multiples
- ‚úÖ Permissions/droits (limit√© √† 64)
- ‚úÖ Options/pr√©f√©rences multiples
- ‚úÖ Jours de la semaine s√©lectionn√©s

‚ö†Ô∏è **Limitations SET** :
- Maximum **64 membres** (limite stricte)
- Modification de la liste = ALTER TABLE
- Difficile √† requ√™ter efficacement
- Mauvaise pratique selon certains (pr√©f√©rer table many-to-many)

### Alternative : Table many-to-many

```sql
-- ‚úÖ Approche relationnelle classique
CREATE TABLE permissions (
    permission_id TINYINT PRIMARY KEY AUTO_INCREMENT,
    code VARCHAR(30) UNIQUE,
    libelle VARCHAR(50)
);

CREATE TABLE utilisateurs_has_permissions (
    utilisateur_id INT,
    permission_id TINYINT,
    date_attribution DATETIME DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (utilisateur_id, permission_id),
    FOREIGN KEY (utilisateur_id) REFERENCES utilisateurs(utilisateur_id),
    FOREIGN KEY (permission_id) REFERENCES permissions(permission_id)
);

-- Plus flexible, meilleure normalisation
-- Permet plus de 64 permissions
-- Permet de tracker la date d'attribution
```

---

## Charset et Collation

### Qu'est-ce qu'un charset ?

Le **charset** (jeu de caract√®res) d√©finit quels caract√®res peuvent √™tre stock√©s :
- `latin1` : Caract√®res occidentaux (ASCII √©tendu)
- `utf8` : Unicode 3 octets max (obsol√®te, √©viter)
- `utf8mb4` : Unicode 4 octets max (recommand√©) ‚úÖ

La **collation** d√©finit comment comparer et trier les caract√®res :
- `_ci` : Case Insensitive (A = a)
- `_cs` : Case Sensitive (A ‚â† a)
- `_bin` : Binaire (comparaison byte par byte)

üÜï **MariaDB 11.8** : Le charset par d√©faut est **utf8mb4** avec la collation **utf8mb4_uca_1400_ai_ci** :
- **UCA 14.0.0** : Unicode Collation Algorithm version 14
- **ai** : Accent Insensitive (√© = e)
- **ci** : Case Insensitive (A = a)

### Configuration au niveau de la base

```sql
-- Cr√©er une base avec utf8mb4 (d√©faut en 11.8)
CREATE DATABASE ma_base
    CHARACTER SET utf8mb4
    COLLATE utf8mb4_uca_1400_ai_ci;

-- V√©rifier le charset d'une base
SHOW CREATE DATABASE ma_base;

-- Voir les charsets disponibles
SHOW CHARACTER SET;

-- Voir les collations disponibles pour utf8mb4
SHOW COLLATION WHERE Charset = 'utf8mb4';
```

### Configuration au niveau de la table

```sql
-- Table avec charset sp√©cifique
CREATE TABLE articles_multilangues (
    article_id INT PRIMARY KEY AUTO_INCREMENT,
    titre VARCHAR(200) NOT NULL,
    contenu TEXT NOT NULL
) CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- Colonne avec collation diff√©rente
CREATE TABLE utilisateurs_sensible_casse (
    utilisateur_id INT PRIMARY KEY AUTO_INCREMENT,
    login VARCHAR(50) COLLATE utf8mb4_bin NOT NULL UNIQUE,  -- Sensible √† la casse
    nom VARCHAR(100) COLLATE utf8mb4_uca_1400_ai_ci         -- Insensible
);

INSERT INTO utilisateurs_sensible_casse (login, nom) VALUES
    ('JohnDoe', 'John Doe'),
    ('johndoe', 'Jane Doe');  -- OK : 'JohnDoe' ‚â† 'johndoe' (bin)

-- Recherche sensible √† la casse
SELECT * FROM utilisateurs_sensible_casse WHERE login = 'JohnDoe';  -- Trouve 1 r√©sultat
SELECT * FROM utilisateurs_sensible_casse WHERE login = 'johndoe';  -- Trouve 1 r√©sultat diff√©rent
```

### Impact sur les comparaisons

```sql
-- D√©monstration collation insensible vs sensible
CREATE TABLE demo_collation (
    texte_ci VARCHAR(50) COLLATE utf8mb4_uca_1400_ai_ci,
    texte_cs VARCHAR(50) COLLATE utf8mb4_uca_1400_as_cs,
    texte_bin VARCHAR(50) COLLATE utf8mb4_bin
);

INSERT INTO demo_collation VALUES
    ('Caf√©', 'Caf√©', 'Caf√©'),
    ('caf√©', 'caf√©', 'caf√©'),
    ('CAF√â', 'CAF√â', 'CAF√â');

-- Comparaison avec collation insensible (ci)
SELECT COUNT(DISTINCT texte_ci) FROM demo_collation;  -- Retourne 1 (tous identiques)

-- Comparaison avec collation sensible (cs)
SELECT COUNT(DISTINCT texte_cs) FROM demo_collation;  -- Retourne 3 (tous diff√©rents)

-- Comparaison binaire
SELECT COUNT(DISTINCT texte_bin) FROM demo_collation;  -- Retourne 3 (bytes diff√©rents)
```

### Support Emoji et caract√®res sp√©ciaux

```sql
-- utf8mb4 supporte les emoji (4 octets)
CREATE TABLE messages_chat (
    message_id BIGINT PRIMARY KEY AUTO_INCREMENT,
    utilisateur VARCHAR(50),
    message TEXT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci
);

-- ‚úÖ Insertion d'emoji et caract√®res sp√©ciaux
INSERT INTO messages_chat (utilisateur, message) VALUES
    ('Alice', 'Bonjour ! üëã Comment √ßa va ? üòä'),
    ('Bob', 'Super ! üéâ J\'adore MariaDB üíæüöÄ'),
    ('Charlie', '‰Ω†Â•Ω (N«ê h«éo) - Bonjour en chinois üá®üá≥');

SELECT * FROM messages_chat;

-- ‚ùå Avec l'ancien utf8 (3 octets max), les emoji ne passeraient pas
```

üí° **Recommandations charset** :
- ‚úÖ **Toujours utiliser utf8mb4** (d√©faut MariaDB 11.8)
- ‚úÖ Collation **utf8mb4_uca_1400_ai_ci** pour usage g√©n√©ral
- ‚úÖ Collation **utf8mb4_bin** pour login/password (sensible casse)
- ‚ùå Ne plus utiliser `utf8` (limite 3 octets, pas d'emoji)
- ‚ùå √âviter `latin1` sauf besoin sp√©cifique legacy

---

## Fonctions de manipulation de texte

### Fonctions courantes

```sql
-- Cr√©ation table de d√©monstration
CREATE TABLE demo_fonctions (
    texte VARCHAR(100)
);

INSERT INTO demo_fonctions VALUES
    ('  Bonjour MariaDB 11.8  '),
    ('marie.dupont@example.com'),
    ('MariaDB est G√âNIAL !');

-- Longueur
SELECT
    texte,
    LENGTH(texte) AS octets,               -- Nombre d'octets
    CHAR_LENGTH(texte) AS caracteres       -- Nombre de caract√®res
FROM demo_fonctions;

-- Casse
SELECT
    texte,
    UPPER(texte) AS majuscules,
    LOWER(texte) AS minuscules,
    CONCAT(UPPER(LEFT(texte, 1)), LOWER(SUBSTRING(texte, 2))) AS capitalise
FROM demo_fonctions;

-- Espaces
SELECT
    texte,
    TRIM(texte) AS sans_espaces,
    LTRIM(texte) AS sans_gauche,
    RTRIM(texte) AS sans_droite
FROM demo_fonctions;

-- Extraction
SELECT
    texte,
    LEFT(texte, 10) AS debut,
    RIGHT(texte, 10) AS fin,
    SUBSTRING(texte, 5, 10) AS milieu
FROM demo_fonctions;

-- Recherche
SELECT
    texte,
    LOCATE('@', texte) AS position_arobase,
    INSTR(texte, 'MariaDB') AS position_mariadb,
    texte LIKE '%@%' AS contient_arobase
FROM demo_fonctions;

-- Remplacement
SELECT
    texte,
    REPLACE(texte, 'MariaDB', 'MySQL') AS remplace,
    CONCAT('Pr√©fixe: ', texte, ' :Suffixe') AS concat
FROM demo_fonctions;
```

---

## Choix du type texte appropri√©

### Arbre de d√©cision

```
Quelle est la taille de votre texte ?
‚îÇ
‚îú‚îÄ Longueur FIXE (codes, abr√©viations) ?
‚îÇ   ‚îî‚îÄ OUI ‚Üí CHAR(M)
‚îÇ
‚îú‚îÄ Longueur VARIABLE < 255 caract√®res ?
‚îÇ   ‚îî‚îÄ OUI ‚Üí VARCHAR(M) avec M appropri√©
‚îÇ
‚îú‚îÄ Longueur 255-65K caract√®res ?
‚îÇ   ‚îú‚îÄ Besoin d'index sans pr√©fixe ‚Üí VARCHAR(M)
‚îÇ   ‚îî‚îÄ Texte long sans index ‚Üí TEXT
‚îÇ
‚îú‚îÄ Longueur > 64KB ?
‚îÇ   ‚îú‚îÄ < 16MB ‚Üí MEDIUMTEXT
‚îÇ   ‚îî‚îÄ > 16MB ‚Üí LONGTEXT
‚îÇ
‚îú‚îÄ Liste FERM√âE de valeurs (une seule) ?
‚îÇ   ‚îî‚îÄ OUI ‚Üí ENUM (ou table de r√©f√©rence)
‚îÇ
‚îî‚îÄ Combinaison de valeurs (plusieurs) ?
    ‚îî‚îÄ OUI ‚Üí SET (ou table many-to-many)
```

### Recommandations par cas d'usage

```sql
-- ‚úÖ Guide de s√©lection des types texte
CREATE TABLE guide_types_texte (
    -- IDENTIFIANTS ET CODES
    code_pays CHAR(2),                          -- FR, US (fixe)
    code_postal CHAR(5),                        -- 75001 (fixe si France)
    uuid CHAR(36),                              -- UUID format standard

    -- NOMS ET IDENTIFIANTS
    nom VARCHAR(50),                            -- Nom de personne
    prenom VARCHAR(50),                         -- Pr√©nom
    email VARCHAR(255),                         -- Email (standard)
    url VARCHAR(2083),                          -- URL compl√®te
    telephone VARCHAR(20),                      -- T√©l√©phone international

    -- DESCRIPTIONS COURTES
    titre VARCHAR(200),                         -- Titre article/produit
    resume VARCHAR(500),                        -- R√©sum√© court
    slogan VARCHAR(100),                        -- Slogan marketing

    -- ADRESSES
    rue VARCHAR(255),                           -- Adresse rue
    ville VARCHAR(100),                         -- Ville

    -- TEXTE MOYEN
    description TEXT,                           -- Description produit/article
    commentaire TEXT,                           -- Commentaires utilisateurs

    -- TEXTE LONG
    contenu_article MEDIUMTEXT,                 -- Article de blog complet
    livre_complet LONGTEXT,                     -- Manuscrit entier

    -- VALEURS PR√âD√âFINIES
    statut ENUM('actif', 'inactif', 'suspendu'), -- Une seule valeur
    tags SET('urgent', 'important', 'favori')    -- Plusieurs valeurs
);
```

---

## Pi√®ges courants √† √©viter

### 1. Utiliser TEXT au lieu de VARCHAR

```sql
-- ‚ùå MAUVAIS : TEXT pour petit texte
CREATE TABLE mauvais_exemple (
    nom TEXT,          -- Inutilement complexe
    email TEXT         -- Ne peut pas avoir de DEFAULT
);

-- ‚úÖ BON : VARCHAR pour petit texte
CREATE TABLE bon_exemple (
    nom VARCHAR(100) NOT NULL DEFAULT 'Inconnu',
    email VARCHAR(255) UNIQUE
);
```

### 2. Oublier utf8mb4 pour les emoji

```sql
-- ‚ùå MAUVAIS : utf8 (3 octets max)
CREATE TABLE messages_utf8 (
    message TEXT CHARACTER SET utf8
);

INSERT INTO messages_utf8 VALUES ('Hello üòä');  -- ERREUR ou caract√®re coup√©

-- ‚úÖ BON : utf8mb4
CREATE TABLE messages_utf8mb4 (
    message TEXT CHARACTER SET utf8mb4
);

INSERT INTO messages_utf8mb4 VALUES ('Hello üòä');  -- OK
```

### 3. Index sans pr√©fixe sur TEXT

```sql
-- ‚ùå ERREUR : Index sur TEXT sans pr√©fixe
CREATE TABLE erreur_index (
    contenu TEXT,
    INDEX idx_contenu (contenu)  -- ERREUR !
);
-- ERROR: BLOB/TEXT column 'contenu' used in key specification without a key length

-- ‚úÖ CORRECT : Index avec pr√©fixe
CREATE TABLE correct_index (
    contenu TEXT,
    INDEX idx_contenu (contenu(255))  -- OK avec pr√©fixe
);
```

### 4. Mauvaise utilisation de CHAR

```sql
-- ‚ùå MAUVAIS : CHAR pour texte variable
CREATE TABLE mauvais_char (
    nom CHAR(100)  -- Gaspillage : occupe toujours 100 caract√®res
);

-- ‚úÖ BON : VARCHAR pour texte variable
CREATE TABLE bon_varchar (
    nom VARCHAR(100)  -- N'occupe que l'espace n√©cessaire
);
```

### 5. ENUM difficile √† maintenir

```sql
-- ‚ùå Probl√®me : Ajouter une valeur ENUM n√©cessite ALTER TABLE
CREATE TABLE commandes_enum (
    statut ENUM('attente', 'validee', 'expediee')
);

-- Plus tard : besoin d'ajouter 'annulee'
ALTER TABLE commandes_enum
MODIFY statut ENUM('attente', 'validee', 'expediee', 'annulee');
-- ALTER TABLE = blocage table + temps long

-- ‚úÖ Alternative flexible : table de r√©f√©rence
CREATE TABLE statuts (
    statut_id TINYINT PRIMARY KEY,
    libelle VARCHAR(50)
);
-- Ajouter un statut = simple INSERT
```

---

## ‚úÖ Points cl√©s √† retenir

- **CHAR** : Longueur fixe, rapide, pour codes (ISO, postal, hash)
- **VARCHAR** : Longueur variable, le plus utilis√©, jusqu'√† 65K octets
- **TEXT** : Pour texte > 255 caract√®res, stock√© hors ligne, index avec pr√©fixe
- **ENUM** : Une valeur parmi liste ferm√©e, compact mais rigide
- **SET** : Plusieurs valeurs simultan√©es, max 64 membres
- üÜï **utf8mb4** : Charset par d√©faut dans MariaDB 11.8, support emoji
- **Collation _ci** : Insensible casse/accents (d√©faut)
- **Collation _bin** : Sensible casse (login, password)
- VARCHAR(255) : Standard pour email, nom, titre
- TEXT ne peut pas avoir de DEFAULT

---

## üîó Ressources et r√©f√©rences

### Documentation officielle MariaDB
- [üìñ String Data Types](https://mariadb.com/kb/en/string-data-types/)
- [üìñ CHAR](https://mariadb.com/kb/en/char/)
- [üìñ VARCHAR](https://mariadb.com/kb/en/varchar/)
- [üìñ TEXT](https://mariadb.com/kb/en/text/)
- [üìñ ENUM](https://mariadb.com/kb/en/enum/)
- [üìñ SET](https://mariadb.com/kb/en/set-data-type/)
- [üìñ Character Sets and Collations](https://mariadb.com/kb/en/character-sets/)
- [üìñ utf8mb4 Character Set](https://mariadb.com/kb/en/unicode/)

---

## ‚û°Ô∏è Section suivante

**[2.2.3 Types temporels (DATE, DATETIME, TIMESTAMP, TIME, YEAR)](/02-bases-du-sql/02.3-types-temporels.md)**

D√©couvrez comment stocker et manipuler les dates et heures dans MariaDB : diff√©rences entre DATETIME et TIMESTAMP, extension jusqu'en 2106 üÜï, fuseaux horaires, et fonctions de date essentielles.

---


‚è≠Ô∏è [Temporels (DATE, DATETIME, TIMESTAMP, TIME, YEAR)](/02-bases-du-sql/02.3-types-temporels.md)
