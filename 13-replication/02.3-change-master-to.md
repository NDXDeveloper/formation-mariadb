üîù Retour au [Sommaire](/SOMMAIRE.md)

# 13.2.3 CHANGE MASTER TO / CHANGE REPLICATION SOURCE

> **Niveau** : Avanc√©  
> **Dur√©e estim√©e** : 2 heures  
> **Pr√©requis** : 
> - Section 13.2.1 (Configuration du Primary)
> - Section 13.2.2 (Configuration du Replica)
> - Compr√©hension des concepts GTID et positions binlog

## üéØ Objectifs d'apprentissage

√Ä l'issue de cette section, vous serez capable de :
- Ma√Ætriser la syntaxe compl√®te de CHANGE MASTER TO et ses variantes
- Configurer des connexions de r√©plication complexes (SSL, compression, filtrage)
- G√©rer les r√©plications multi-source avec des connexions nomm√©es
- Modifier dynamiquement les param√®tres de r√©plication sans interruption
- Utiliser les options avanc√©es pour optimiser la r√©plication
- Diagnostiquer et corriger les probl√®mes de configuration
- Migrer entre diff√©rentes topologies de r√©plication

---

## Introduction

La commande **CHANGE MASTER TO** (et sa variante moderne **CHANGE REPLICATION SOURCE TO** depuis MariaDB 10.5) est l'outil central pour configurer, modifier et g√©rer les connexions de r√©plication. Elle est utilis√©e pour :

- **Initialiser** une nouvelle connexion de r√©plication
- **Modifier** les param√®tres d'une r√©plication existante
- **Changer** de Primary en cas de failover
- **Configurer** des r√©plications multi-source
- **Ajuster** les performances et la s√©curit√©

Cette commande offre une **flexibilit√© exceptionnelle** avec plus de 30 options diff√©rentes. Cette section d√©taille toutes les options importantes et leurs cas d'usage.

üí° **√âvolution de la syntaxe** :
- MariaDB < 10.5 : `CHANGE MASTER TO`
- MariaDB ‚â• 10.5 : `CHANGE REPLICATION SOURCE TO` (nouvelle syntaxe recommand√©e)
- Les deux syntaxes restent compatibles pour r√©trocompatibilit√©

---

## Syntaxe de Base

### Syntaxe minimale

```sql
-- Ancienne syntaxe (toujours fonctionnelle)
CHANGE MASTER TO
  MASTER_HOST = 'hostname',
  MASTER_USER = 'username',
  MASTER_PASSWORD = 'password';

-- Nouvelle syntaxe (MariaDB 10.5+, recommand√©e)
CHANGE REPLICATION SOURCE TO
  SOURCE_HOST = 'hostname',
  SOURCE_USER = 'username',
  SOURCE_PASSWORD = 'password';
```

üí° **Compatibilit√©** : Dans les exemples suivants, nous utiliserons la syntaxe moderne `CHANGE REPLICATION SOURCE`, mais `CHANGE MASTER` fonctionne identiquement.

### Syntaxe compl√®te (aper√ßu)

```sql
CHANGE REPLICATION SOURCE ['connection_name'] TO
  -- Connexion au Primary
  SOURCE_HOST = 'hostname',
  SOURCE_PORT = port_number,
  SOURCE_USER = 'username',
  SOURCE_PASSWORD = 'password',
  
  -- Position binlog
  SOURCE_LOG_FILE = 'binlog_file',
  SOURCE_LOG_POS = position,
  
  -- GTID
  SOURCE_USE_GTID = {current_pos | slave_pos | no},
  
  -- SSL/TLS
  SOURCE_SSL = {0|1},
  SOURCE_SSL_CA = 'path/to/ca.pem',
  SOURCE_SSL_CERT = 'path/to/cert.pem',
  SOURCE_SSL_KEY = 'path/to/key.pem',
  
  -- Options avanc√©es
  SOURCE_CONNECT_RETRY = seconds,
  SOURCE_RETRY_COUNT = count,
  SOURCE_HEARTBEAT_PERIOD = seconds,
  SOURCE_COMPRESSION = {0|1},
  
  -- Filtrage
  IGNORE_SERVER_IDS = (id1, id2, ...),
  DO_DOMAIN_IDS = (id1, id2, ...);
```

---

## Options de Connexion au Primary

### Param√®tres r√©seau essentiels

```sql
STOP REPLICA;

CHANGE REPLICATION SOURCE TO
  -- Hostname ou IP du Primary
  SOURCE_HOST = '192.168.1.100',
  
  -- Port MySQL/MariaDB (d√©faut 3306)
  SOURCE_PORT = 3306,
  
  -- Socket Unix (alternative √† HOST/PORT pour connexions locales)
  -- SOURCE_SOCKET = '/var/run/mysqld/mysqld.sock',
  
  -- Utilisateur de r√©plication
  SOURCE_USER = 'repl_user',
  
  -- Mot de passe
  SOURCE_PASSWORD = 'SecurePassword123!';

START REPLICA;
```

‚ö†Ô∏è **S√©curit√©** : Le mot de passe est stock√© en clair dans `mysql.slave_master_info`. Utilisez des permissions restrictives sur le datadir.

### Gestion des reconnexions

```sql
CHANGE REPLICATION SOURCE TO
  -- D√©lai entre deux tentatives de reconnexion (secondes)
  SOURCE_CONNECT_RETRY = 10,
  
  -- Nombre maximum de tentatives (0 = illimit√©, d√©faut)
  SOURCE_RETRY_COUNT = 0,
  
  -- Timeout de connexion (secondes)
  SOURCE_CONNECT_TIMEOUT = 30;
```

üí° **Bonne pratique** : En production, utilisez `SOURCE_CONNECT_RETRY = 10` et `SOURCE_RETRY_COUNT = 0` pour une reconnexion automatique infinie.

### Heartbeat et d√©tection de pannes

```sql
CHANGE REPLICATION SOURCE TO
  -- Intervalle d'envoi de heartbeat par le Primary (secondes)
  -- Le Primary envoie un √©v√©nement heartbeat m√™me si pas d'activit√©
  SOURCE_HEARTBEAT_PERIOD = 30;
```

**Fonctionnement** :
- Le Primary envoie un √©v√©nement heartbeat toutes les 30 secondes
- Si le Replica ne re√ßoit rien pendant `slave_net_timeout` (d√©faut: 60s), il consid√®re la connexion perdue
- Permet de d√©tecter rapidement les pannes r√©seau

üí° **Recommandation** : `SOURCE_HEARTBEAT_PERIOD = 30` pour une d√©tection rapide de panne sans surcharge r√©seau.

---

## Positionnement : Binlog vs GTID

### Mode 1 : Position binlog (traditionnel)

```sql
CHANGE REPLICATION SOURCE TO
  SOURCE_HOST = '192.168.1.100',
  SOURCE_USER = 'repl_user',
  SOURCE_PASSWORD = 'SecurePassword123!',
  
  -- Position exacte dans le binlog
  SOURCE_LOG_FILE = 'mariadb-bin.000003',
  SOURCE_LOG_POS = 67890,
  
  -- D√©sactiver GTID explicitement
  SOURCE_USE_GTID = no;
```

‚ö†Ô∏è **Limitation** : N√©cessite de conna√Ætre la position exacte. En cas de failover, trouver la bonne position sur le nouveau Primary est complexe.

### Mode 2 : GTID slave_pos (recommand√©)

```sql
CHANGE REPLICATION SOURCE TO
  SOURCE_HOST = '192.168.1.100',
  SOURCE_USER = 'repl_user',
  SOURCE_PASSWORD = 'SecurePassword123!',
  
  -- Utiliser la position GTID du Replica
  SOURCE_USE_GTID = slave_pos;
  
-- Pas besoin de sp√©cifier SOURCE_LOG_FILE/SOURCE_LOG_POS
-- Le Replica se positionne automatiquement via @@gtid_slave_pos
```

**Avantages** :
- **Automatique** : Le Replica trouve lui-m√™me la bonne position
- **Failover simple** : Changer de Primary ne n√©cessite que de changer SOURCE_HOST
- **Robuste** : Pas de risque d'erreur de position

üí° **Cas d'usage** : R√©plication d√©j√† √©tablie, maintenance, red√©marrage apr√®s arr√™t.

### Mode 3 : GTID current_pos (initialisation)

```sql
-- Sur le Replica : D√©finir manuellement la position GTID
SET GLOBAL gtid_slave_pos = '0-1-1000';

CHANGE REPLICATION SOURCE TO
  SOURCE_HOST = '192.168.1.100',
  SOURCE_USER = 'repl_user',
  SOURCE_PASSWORD = 'SecurePassword123!',
  
  -- Utiliser la position GTID courante
  SOURCE_USE_GTID = current_pos;

START REPLICA;
```

üí° **Cas d'usage** : Initialisation d'un nouveau Replica √† partir d'un snapshot avec GTID.

### Comparaison des modes

| Mode | Quand l'utiliser | Avantages | Inconv√©nients |
|------|------------------|-----------|---------------|
| **Binlog position** | Legacy, environnements sans GTID | Compatible anciennes versions | Complexe pour failover |
| **slave_pos** | Production moderne, maintenance | Automatique, failover facile | N√©cessite GTID activ√© |
| **current_pos** | Initialisation nouveau Replica | Position globale coh√©rente | N√©cessite setup manuel |

---

## Configuration SSL/TLS

La s√©curisation de la connexion de r√©plication est **essentielle** en production, surtout pour les r√©seaux non s√©curis√©s.

### Configuration SSL compl√®te

```sql
CHANGE REPLICATION SOURCE TO
  SOURCE_HOST = '192.168.1.100',
  SOURCE_USER = 'repl_user',
  SOURCE_PASSWORD = 'SecurePassword123!',
  SOURCE_USE_GTID = slave_pos,
  
  -- Activer SSL/TLS
  SOURCE_SSL = 1,
  
  -- Certificat de l'autorit√© de certification
  SOURCE_SSL_CA = '/etc/mysql/ssl/ca-cert.pem',
  
  -- Certificat client du Replica
  SOURCE_SSL_CERT = '/etc/mysql/ssl/client-cert.pem',
  
  -- Cl√© priv√©e du client
  SOURCE_SSL_KEY = '/etc/mysql/ssl/client-key.pem',
  
  -- V√©rifier le certificat du serveur
  SOURCE_SSL_VERIFY_SERVER_CERT = 1,
  
  -- Algorithmes de chiffrement autoris√©s (optionnel)
  SOURCE_SSL_CIPHER = 'DHE-RSA-AES256-SHA',
  
  -- Version TLS minimum (optionnel, depuis MariaDB 10.4)
  SOURCE_TLS_VERSION = 'TLSv1.2,TLSv1.3';
```

üÜï **MariaDB 11.8** : TLS est activ√© par d√©faut. Si vous utilisez `require_secure_transport = ON` sur le Primary, le SSL est obligatoire.

### SSL avec certificat uniquement (sans CA)

```sql
-- Configuration minimale SSL (moins s√©curis√©e)
CHANGE REPLICATION SOURCE TO
  SOURCE_SSL = 1,
  SOURCE_SSL_VERIFY_SERVER_CERT = 0;  -- Ne pas v√©rifier le certificat
```

‚ö†Ô∏è **S√©curit√© r√©duite** : Sans v√©rification du certificat, vous √™tes vuln√©rable aux attaques man-in-the-middle. √Ä n'utiliser qu'en environnement de confiance.

### V√©rification de la connexion SSL

```sql
-- V√©rifier que SSL est actif
SHOW REPLICA STATUS\G

-- Regarder ces champs :
-- Master_SSL_Allowed: Yes
-- Master_SSL_CA_File: /etc/mysql/ssl/ca-cert.pem
-- Master_SSL_Verify_Server_Cert: Yes

-- V√©rifier la version TLS utilis√©e
SELECT * FROM performance_schema.session_status 
WHERE VARIABLE_NAME = 'Ssl_version';
```

---

## Compression de la R√©plication

La compression r√©duit le trafic r√©seau entre Primary et Replica, particuli√®rement utile pour des liaisons lentes ou co√ªteuses.

### Activer la compression

```sql
CHANGE REPLICATION SOURCE TO
  SOURCE_HOST = '192.168.1.100',
  SOURCE_USER = 'repl_user',
  SOURCE_PASSWORD = 'SecurePassword123!',
  
  -- Activer la compression du protocole
  SOURCE_COMPRESSION = 1,
  
  -- Niveau de compression zlib (1-9, d√©faut 6)
  SOURCE_COMPRESSION_LEVEL = 6;
```

### Impact de la compression

**Avantages** :
- R√©duction du trafic r√©seau de **40-80%** selon les donn√©es
- Utile pour r√©plication inter-datacenter ou cloud
- R√©duit les co√ªts de bande passante

**Inconv√©nients** :
- Augmentation de la charge CPU sur Primary et Replica (10-20%)
- Latence l√©g√®rement accrue (compression/d√©compression)

üí° **Recommandation** :
- **Activez** si bande passante limit√©e ou co√ªteuse
- **D√©sactivez** si CPU limit√© ou r√©seau local rapide (10 Gbps+)

### Benchmark de compression

```bash
# Tester sans compression
# Mesurer : SELECT * FROM information_schema.SLAVE_STATUS; ‚Üí Relay_Log_Space

# Tester avec compression
CHANGE REPLICATION SOURCE TO SOURCE_COMPRESSION = 1;

# Comparer la taille des relay logs sur une p√©riode
# √âconomie typique : 50-70% pour donn√©es textuelles
```

---

## R√©plication Multi-Source

MariaDB supporte la **r√©plication multi-source** : un Replica peut se connecter √† plusieurs Primary diff√©rents. Chaque connexion est identifi√©e par un **nom de connexion**.

### Configuration multi-source

```sql
-- Connexion 1 : Primary production
CHANGE REPLICATION SOURCE 'production' TO
  SOURCE_HOST = '192.168.1.100',
  SOURCE_USER = 'repl_user',
  SOURCE_PASSWORD = 'SecurePass1',
  SOURCE_USE_GTID = slave_pos;

-- Connexion 2 : Primary analytics
CHANGE REPLICATION SOURCE 'analytics' TO
  SOURCE_HOST = '192.168.1.200',
  SOURCE_USER = 'repl_user',
  SOURCE_PASSWORD = 'SecurePass2',
  SOURCE_USE_GTID = slave_pos;

-- D√©marrer les deux r√©plications
START REPLICA 'production';
START REPLICA 'analytics';
```

### Architecture multi-source

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  PRIMARY    ‚îÇ         ‚îÇ  PRIMARY    ‚îÇ
‚îÇ production  ‚îÇ         ‚îÇ analytics   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ                       ‚îÇ
       ‚îÇ   Connection 'prod'   ‚îÇ
       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                   ‚îÇ   ‚îÇ
                   ‚ñº   ‚ñº
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ   REPLICA    ‚îÇ
              ‚îÇ Multi-Source ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Monitoring multi-source

```sql
-- Voir toutes les connexions
SHOW ALL REPLICAS STATUS\G

-- Voir une connexion sp√©cifique
SHOW REPLICA 'production' STATUS\G

-- Stopper/d√©marrer une connexion sp√©cifique
STOP REPLICA 'analytics';
START REPLICA 'production';

-- R√©initialiser une connexion
RESET REPLICA 'analytics' ALL;
```

### GTID multi-source : Domain IDs

Chaque Primary doit utiliser un **GTID domain_id unique** pour √©viter les conflits :

```ini
# Sur Primary production
[mariadb]
gtid_domain_id = 1

# Sur Primary analytics
[mariadb]
gtid_domain_id = 2
```

Sur le Replica multi-source :

```sql
-- V√©rifier les positions GTID des deux sources
SELECT @@gtid_slave_pos;
-- R√©sultat : 1-100-5000,2-200-3000
--           ‚îî‚îÄ Domain 1  ‚îî‚îÄ Domain 2

-- Filtrer par domain (optionnel)
CHANGE REPLICATION SOURCE 'production' TO
  DO_DOMAIN_IDS = (1);  -- R√©pliquer uniquement domain 1

CHANGE REPLICATION SOURCE 'analytics' TO
  DO_DOMAIN_IDS = (2);  -- R√©pliquer uniquement domain 2
```

üí° **Cas d'usage multi-source** :
- Consolider plusieurs bases en un data warehouse
- Agr√©ger plusieurs applications en une base centralis√©e
- Environnement de reporting unifi√©

---

## Filtrage de R√©plication

Le filtrage permet de contr√¥ler quels √©v√©nements sont r√©pliqu√©s, par serveur, database ou table.

### Ignorer des serveurs (circular replication)

```sql
-- Ignorer les √©v√©nements provenant de certains server_id
CHANGE REPLICATION SOURCE TO
  IGNORE_SERVER_IDS = (3, 4, 5);

-- Utile pour √©viter les boucles en r√©plication circulaire :
-- A ‚Üí B ‚Üí C ‚Üí A (chaque serveur ignore les √©v√©nements des autres)
```

### Filtrage par domain GTID

```sql
-- R√©pliquer uniquement certains GTID domains
CHANGE REPLICATION SOURCE TO
  DO_DOMAIN_IDS = (1, 2);

-- Ignorer certains GTID domains
CHANGE REPLICATION SOURCE TO
  IGNORE_DOMAIN_IDS = (3, 4);
```

üí° **Diff√©rence avec replicate-do-db** :
- `DO_DOMAIN_IDS` : Filtre au niveau du binary log (I/O thread)
- `replicate-do-db` : Filtre au niveau SQL (SQL thread), d√©fini dans my.cnf

### Combinaison multi-source + filtrage

```sql
-- Replica multi-source avec filtrage granulaire
CHANGE REPLICATION SOURCE 'prod_db1' TO
  SOURCE_HOST = '192.168.1.100',
  SOURCE_USER = 'repl_user',
  SOURCE_PASSWORD = 'pass',
  DO_DOMAIN_IDS = (1);

CHANGE REPLICATION SOURCE 'prod_db2' TO
  SOURCE_HOST = '192.168.1.200',
  SOURCE_USER = 'repl_user',
  SOURCE_PASSWORD = 'pass',
  DO_DOMAIN_IDS = (2);
```

---

## Options de D√©lai (Delayed Replication)

La **delayed replication** permet de retarder intentionnellement l'application des √©v√©nements, utile pour la r√©cup√©ration apr√®s erreur.

### Configuration du d√©lai

```sql
CHANGE REPLICATION SOURCE TO
  -- Retarder l'ex√©cution de 3600 secondes (1 heure)
  SOURCE_DELAY = 3600;

START REPLICA;
```

**Fonctionnement** :
- Les √©v√©nements sont re√ßus normalement (I/O thread)
- L'ex√©cution est retard√©e de N secondes (SQL thread)
- En cas d'erreur sur le Primary, vous avez 1 heure pour r√©agir avant que l'erreur ne se propage

üí° **Cas d'usage** :
- Protection contre les `DROP TABLE` accidentels
- Fen√™tre de r√©cup√©ration pour erreurs humaines
- Environnement de test avec donn√©es quasi-temps-r√©el

### Monitoring du d√©lai

```sql
SHOW REPLICA STATUS\G

-- Champs importants :
-- SQL_Delay: 3600 (d√©lai configur√©)
-- SQL_Remaining_Delay: 2456 (temps restant avant ex√©cution)
-- Seconds_Behind_Master: 3620 (lag apparent = d√©lai + lag r√©el)
```

‚ö†Ô∏è **Attention** : `Seconds_Behind_Master` inclut le d√©lai configur√©. Pour obtenir le lag r√©el :

```
Lag r√©el = Seconds_Behind_Master - SQL_Delay
```

---

## Modification Dynamique de la Configuration

Une des forces de CHANGE REPLICATION SOURCE est de permettre des modifications **sans recr√©er** la r√©plication compl√®te.

### Modifier uniquement le mot de passe

```sql
-- Changer juste le mot de passe (ex: rotation de credentials)
STOP REPLICA;
CHANGE REPLICATION SOURCE TO SOURCE_PASSWORD = 'NewSecurePass456!';
START REPLICA;
```

üí° **Pas besoin** de r√©initialiser la position ou de resp√©cifier tous les param√®tres.

### Changer de Primary (failover)

```sql
-- Promouvoir un ancien Replica en nouveau Primary
STOP REPLICA;

CHANGE REPLICATION SOURCE TO
  SOURCE_HOST = '192.168.1.101',  -- Nouveau Primary (ancien Replica)
  SOURCE_USE_GTID = slave_pos;    -- GTID simplifie le failover

START REPLICA;

-- V√©rification
SHOW REPLICA STATUS\G
```

üÜï **MariaDB 11.8** : Avec GTID et Optimistic ALTER, le failover est quasi-instantan√© m√™me pendant des op√©rations DDL lourdes.

### Modifier la configuration SSL

```sql
-- Ajouter SSL √† une r√©plication existante
STOP REPLICA;

CHANGE REPLICATION SOURCE TO
  SOURCE_SSL = 1,
  SOURCE_SSL_CA = '/etc/mysql/ssl/ca-cert.pem',
  SOURCE_SSL_CERT = '/etc/mysql/ssl/client-cert.pem',
  SOURCE_SSL_KEY = '/etc/mysql/ssl/client-key.pem',
  SOURCE_SSL_VERIFY_SERVER_CERT = 1;

START REPLICA;
```

### Activer/d√©sactiver la compression

```sql
-- Activer la compression sans reconfigurer la r√©plication
STOP REPLICA IO_THREAD;
CHANGE REPLICATION SOURCE TO SOURCE_COMPRESSION = 1;
START REPLICA IO_THREAD;
-- Pas besoin de stopper le SQL thread
```

---

## Options Avanc√©es et Rarement Utilis√©es

### Binlog Checksum

```sql
CHANGE REPLICATION SOURCE TO
  -- V√©rification d'int√©grit√© des √©v√©nements binlog
  SOURCE_BINLOG_CHECKSUM = 'CRC32';  -- ou 'NONE'
```

V√©rifie l'int√©grit√© des √©v√©nements pour d√©tecter les corruptions r√©seau/disque.

### Auto-position avec GTID

```sql
-- Ancienne syntaxe MySQL 5.6+ (compatibilit√©)
CHANGE REPLICATION SOURCE TO
  SOURCE_AUTO_POSITION = 1;  -- √âquivalent √† SOURCE_USE_GTID = slave_pos
```

‚ö†Ô∏è **MariaDB** : Pr√©f√©rez `SOURCE_USE_GTID = slave_pos`, syntaxe native MariaDB plus flexible.

### Liaison √† une interface r√©seau sp√©cifique

```sql
CHANGE REPLICATION SOURCE TO
  -- Utiliser une interface r√©seau sp√©cifique (par son IP)
  SOURCE_BIND = '192.168.10.50';
```

üí° **Cas d'usage** : Serveur multi-homed avec plusieurs interfaces r√©seau, pour forcer l'utilisation d'une interface d√©di√©e √† la r√©plication.

### Public Key Authentication (MySQL 8.0 compat)

```sql
CHANGE REPLICATION SOURCE TO
  -- Pour compatibilit√© avec MySQL 8.0 caching_sha2_password
  SOURCE_PUBLIC_KEY_PATH = '/path/to/public_key.pem',
  GET_SOURCE_PUBLIC_KEY = 1;
```

‚ö†Ô∏è **MariaDB 11.8** : Utilisez plut√¥t `ed25519` ou `PARSEC` pour l'authentification moderne.

---

## R√©initialisation et Nettoyage

### RESET REPLICA (sans ALL)

```sql
-- R√©initialiser la position de r√©plication, garder la configuration
STOP REPLICA;
RESET REPLICA;
-- Efface : relay logs, position relay log
-- Garde : configuration SOURCE_HOST, SOURCE_USER, etc.

-- Red√©marrer depuis le d√©but du binlog actuel du Primary
START REPLICA;
```

### RESET REPLICA ALL

```sql
-- Supprimer compl√®tement la configuration de r√©plication
STOP REPLICA;
RESET REPLICA ALL;
-- Efface : TOUT (relay logs, configuration, positions)

-- N√©cessite de reconfigurer avec CHANGE REPLICATION SOURCE TO
```

üí° **Utilisation** :
- `RESET REPLICA` : Red√©marrer la r√©plication, garder config
- `RESET REPLICA ALL` : Nettoyer compl√®tement pour reconfiguration

### Multi-source : R√©initialisation s√©lective

```sql
-- R√©initialiser uniquement une connexion
STOP REPLICA 'analytics';
RESET REPLICA 'analytics' ALL;

-- Les autres connexions ('production') restent actives
```

---

## Exemples Complets de Configurations

### Configuration Production Standard (GTID + SSL)

```sql
-- Replica production avec toutes les bonnes pratiques
STOP REPLICA;

CHANGE REPLICATION SOURCE TO
  -- Connexion
  SOURCE_HOST = '192.168.1.100',
  SOURCE_PORT = 3306,
  SOURCE_USER = 'repl_user',
  SOURCE_PASSWORD = 'SecurePassword123!',
  SOURCE_CONNECT_RETRY = 10,
  SOURCE_RETRY_COUNT = 0,
  
  -- GTID
  SOURCE_USE_GTID = slave_pos,
  
  -- SSL/TLS
  SOURCE_SSL = 1,
  SOURCE_SSL_CA = '/etc/mysql/ssl/ca-cert.pem',
  SOURCE_SSL_CERT = '/etc/mysql/ssl/client-cert.pem',
  SOURCE_SSL_KEY = '/etc/mysql/ssl/client-key.pem',
  SOURCE_SSL_VERIFY_SERVER_CERT = 1,
  SOURCE_TLS_VERSION = 'TLSv1.2,TLSv1.3',
  
  -- Heartbeat
  SOURCE_HEARTBEAT_PERIOD = 30;

START REPLICA;

-- V√©rification
SHOW REPLICA STATUS\G
```

### Configuration Delayed Replica (Disaster Recovery)

```sql
-- Replica retard√© de 4 heures pour protection contre erreurs
CHANGE REPLICATION SOURCE TO
  SOURCE_HOST = '192.168.1.100',
  SOURCE_USER = 'repl_user',
  SOURCE_PASSWORD = 'SecurePassword123!',
  SOURCE_USE_GTID = slave_pos,
  SOURCE_SSL = 1,
  
  -- D√©lai de 4 heures = 14400 secondes
  SOURCE_DELAY = 14400;

START REPLICA;
```

### Configuration Multi-Source avec Filtrage

```sql
-- Base consolid√©e : R√©pliquer plusieurs sources
CHANGE REPLICATION SOURCE 'ecommerce' TO
  SOURCE_HOST = '192.168.1.100',
  SOURCE_USER = 'repl_user',
  SOURCE_PASSWORD = 'SecurePass1',
  SOURCE_USE_GTID = slave_pos,
  DO_DOMAIN_IDS = (1);

CHANGE REPLICATION SOURCE 'crm' TO
  SOURCE_HOST = '192.168.1.200',
  SOURCE_USER = 'repl_user',
  SOURCE_PASSWORD = 'SecurePass2',
  SOURCE_USE_GTID = slave_pos,
  DO_DOMAIN_IDS = (2);

CHANGE REPLICATION SOURCE 'analytics' TO
  SOURCE_HOST = '192.168.1.300',
  SOURCE_USER = 'repl_user',
  SOURCE_PASSWORD = 'SecurePass3',
  SOURCE_USE_GTID = slave_pos,
  DO_DOMAIN_IDS = (3);

-- D√©marrer toutes les r√©plications
START ALL REPLICAS;  -- MariaDB 10.7+

-- Alternative pour versions ant√©rieures
START REPLICA 'ecommerce';
START REPLICA 'crm';
START REPLICA 'analytics';
```

### Configuration WAN (compression + SSL)

```sql
-- R√©plication inter-datacenter avec compression
CHANGE REPLICATION SOURCE TO
  SOURCE_HOST = 'primary.datacenter2.example.com',
  SOURCE_PORT = 3306,
  SOURCE_USER = 'repl_user',
  SOURCE_PASSWORD = 'SecurePassword123!',
  SOURCE_USE_GTID = slave_pos,
  
  -- Compression pour r√©duire bande passante WAN
  SOURCE_COMPRESSION = 1,
  SOURCE_COMPRESSION_LEVEL = 6,
  
  -- SSL obligatoire sur WAN
  SOURCE_SSL = 1,
  SOURCE_SSL_CA = '/etc/mysql/ssl/ca-cert.pem',
  SOURCE_SSL_VERIFY_SERVER_CERT = 1,
  
  -- Heartbeat fr√©quent pour d√©tecter pannes r√©seau
  SOURCE_HEARTBEAT_PERIOD = 15;

START REPLICA;
```

---

## Troubleshooting

### Erreur : "Could not initialize master info structure"

**Sympt√¥me** :
```
ERROR 1201 (HY000): Could not initialize master info structure
```

**Cause** : Configuration corrompue dans `mysql.slave_master_info`.

**Solution** :

```sql
-- Nettoyer et reconfigurer
STOP REPLICA;
RESET REPLICA ALL;

-- Reconfigurer depuis le d√©but
CHANGE REPLICATION SOURCE TO ...;
START REPLICA;
```

### Erreur : SSL connection error

**Sympt√¥me** :
```
Last_IO_Error: error connecting to master 'repl_user@192.168.1.100:3306' - 
retry-time: 10  retries: 1  message: SSL connection error: error:14090086:
SSL routines:ssl3_get_server_certificate:certificate verify failed
```

**Solution** :

```sql
-- V√©rifier les chemins des certificats
SHOW REPLICA STATUS\G
-- V√©rifier : Master_SSL_CA_File, Master_SSL_Cert, Master_SSL_Key

-- Tester la connexion SSL manuellement
mariadb -h 192.168.1.100 -u repl_user -p \
  --ssl-ca=/etc/mysql/ssl/ca-cert.pem \
  --ssl-cert=/etc/mysql/ssl/client-cert.pem \
  --ssl-key=/etc/mysql/ssl/client-key.pem

-- Si √©chec : v√©rifier validit√© et permissions des certificats
openssl verify -CAfile /etc/mysql/ssl/ca-cert.pem \
  /etc/mysql/ssl/client-cert.pem
```

### Erreur : Position binlog invalide

**Sympt√¥me** :
```
Last_IO_Error: Got fatal error 1236 from master when reading data from binary log:
'Could not find first log file name in binary log index file'
```

**Cause** : Le binlog demand√© n'existe plus sur le Primary (purg√©).

**Solution** :

```sql
-- Option 1 : Resynchroniser avec GTID (si activ√©)
STOP REPLICA;
CHANGE REPLICATION SOURCE TO SOURCE_USE_GTID = current_pos;
START REPLICA;

-- Option 2 : Refaire un snapshot complet
-- 1. Sur Primary : faire un nouveau dump avec position
-- 2. Sur Replica : restaurer et reconfigurer
```

### Modification qui ne prend pas effet

**Sympt√¥me** : Apr√®s `CHANGE REPLICATION SOURCE`, les param√®tres ne changent pas.

**Solution** :

```sql
-- Certains param√®tres n√©cessitent un STOP/START
STOP REPLICA;
CHANGE REPLICATION SOURCE TO SOURCE_COMPRESSION = 1;
START REPLICA;

-- V√©rifier que le changement est effectif
SHOW REPLICA STATUS\G
-- V√©rifier le champ correspondant
```

---

## Bonnes Pratiques

### 1. Toujours utiliser GTID en production moderne

```sql
-- ‚úÖ BON : GTID + slave_pos
CHANGE REPLICATION SOURCE TO
  SOURCE_USE_GTID = slave_pos;

-- ‚ùå √âVITER : positions binlog manuelles (sauf legacy)
CHANGE REPLICATION SOURCE TO
  SOURCE_LOG_FILE = 'mariadb-bin.000003',
  SOURCE_LOG_POS = 12345;
```

### 2. Activer SSL/TLS syst√©matiquement

```sql
-- ‚úÖ BON : SSL activ√©
CHANGE REPLICATION SOURCE TO
  SOURCE_SSL = 1,
  SOURCE_SSL_VERIFY_SERVER_CERT = 1;

-- ‚ùå DANGEREUX : Pas de SSL (sauf r√©seau isol√© de confiance)
```

### 3. Configurer des reconnexions automatiques

```sql
-- ‚úÖ BON : Reconnexion automatique infinie
CHANGE REPLICATION SOURCE TO
  SOURCE_CONNECT_RETRY = 10,
  SOURCE_RETRY_COUNT = 0;

-- ‚ùå √âVITER : Limite de tentatives (arr√™t apr√®s √©puisement)
SOURCE_RETRY_COUNT = 10;
```

### 4. Utiliser des heartbeats pour d√©tection rapide

```sql
-- ‚úÖ BON : Heartbeat 30s
CHANGE REPLICATION SOURCE TO
  SOURCE_HEARTBEAT_PERIOD = 30;

-- ‚ùå √âVITER : Pas de heartbeat (d√©tection lente)
```

### 5. Nommer les connexions multi-source

```sql
-- ‚úÖ BON : Noms explicites
CHANGE REPLICATION SOURCE 'production_db' TO ...;
CHANGE REPLICATION SOURCE 'analytics_warehouse' TO ...;

-- ‚ùå √âVITER : Connexion par d√©faut sans nom (confusion)
```

### 6. Documenter les configurations

```sql
-- Cr√©er un fichier de documentation
-- /opt/mariadb/replication_config.sql

/*
Configuration de r√©plication
Primary: 192.168.1.100 (production)
Replica: 192.168.1.101 (replica-01)
GTID: Activ√© (domain_id = 0)
SSL: Activ√© (TLS 1.2+)
Compression: Activ√©e (niveau 6)
Derni√®re mise √† jour: 2025-12-13
*/

STOP REPLICA;
CHANGE REPLICATION SOURCE TO
  SOURCE_HOST = '192.168.1.100',
  SOURCE_USER = 'repl_user',
  SOURCE_PASSWORD = 'SecurePassword123!',
  SOURCE_USE_GTID = slave_pos,
  SOURCE_SSL = 1,
  SOURCE_COMPRESSION = 1;
START REPLICA;
```

---

## ‚úÖ Points cl√©s √† retenir

- **CHANGE REPLICATION SOURCE** (MariaDB 10.5+) remplace CHANGE MASTER TO avec une syntaxe plus claire
- **SOURCE_USE_GTID = slave_pos** est la m√©thode recommand√©e pour la production moderne
- **SSL/TLS** doit toujours √™tre activ√© sauf environnement isol√© de confiance
- **SOURCE_COMPRESSION** est utile pour WAN ou liaisons √† bande passante limit√©e
- **Multi-source** utilise des connexions nomm√©es pour g√©rer plusieurs Primary
- **SOURCE_DELAY** permet une fen√™tre de r√©cup√©ration contre les erreurs humaines
- Les modifications peuvent √™tre appliqu√©es **dynamiquement** sans reconfigurer enti√®rement
- **Heartbeat** (30s recommand√©) permet une d√©tection rapide des pannes
- **RESET REPLICA ALL** efface toute la configuration, contrairement √† RESET REPLICA seul
- La documentation de la configuration est essentielle pour le troubleshooting
- üÜï **MariaDB 11.8** : TLS par d√©faut, optimisations GTID, support PARSEC

---

## üîó Ressources et r√©f√©rences

- [üìñ CHANGE MASTER TO Documentation](https://mariadb.com/kb/en/change-master-to/)
- [üìñ Replication Options Reference](https://mariadb.com/kb/en/replication-options/)
- [üìñ Multi-Source Replication](https://mariadb.com/kb/en/multi-source-replication/)
- [üìñ GTID Documentation](https://mariadb.com/kb/en/gtid/)
- [üìñ Delayed Replication](https://mariadb.com/kb/en/delayed-replication/)
- [üìñ SSL/TLS for Replication](https://mariadb.com/kb/en/replication-with-secure-connections/)

---

## ‚û°Ô∏è Section suivante

**13.3 R√©plication bas√©e sur les positions (binlog coordinates)** : Nous allons approfondir la r√©plication traditionnelle bas√©e sur les positions binlog, ses cas d'usage et ses limitations, avant de passer au GTID.

---


‚è≠Ô∏è [R√©plication bas√©e sur les positions (binlog coordinates)](/13-replication/03-replication-positions.md)
