ğŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 13.2.2 Configuration du Replica

> **Niveau** : AvancÃ©  
> **DurÃ©e estimÃ©e** : 2-3 heures  
> **PrÃ©requis** : 
> - Section 13.2.1 (Configuration du Primary)
> - Section 13.1 (Concepts de rÃ©plication)
> - MaÃ®trise de l'administration MariaDB (Partie 5)

## ğŸ¯ Objectifs d'apprentissage

Ã€ l'issue de cette section, vous serez capable de :
- Configurer un serveur MariaDB comme Replica (Slave) et l'associer Ã  un Primary
- Restaurer le snapshot initial et positionner correctement le Replica
- DÃ©marrer la rÃ©plication en utilisant les positions binlog ou GTID
- Surveiller l'Ã©tat de la rÃ©plication avec SHOW REPLICA STATUS
- Diagnostiquer et rÃ©soudre le lag de rÃ©plication
- Configurer la rÃ©plication semi-synchrone pour une durabilitÃ© renforcÃ©e
- Optimiser les performances du Replica en production

---

## Introduction

Le **Replica** (anciennement appelÃ© Slave) est le serveur qui **consomme** les Ã©vÃ©nements du binary log du Primary pour reproduire les mÃªmes modifications de donnÃ©es. Une configuration correcte du Replica est essentielle pour garantir la cohÃ©rence, la performance et la disponibilitÃ© de votre infrastructure.

La configuration du Replica implique plusieurs Ã©tapes critiques :
1. **Restauration** du snapshot initial depuis le Primary
2. **Configuration** des paramÃ¨tres de connexion au Primary
3. **DÃ©marrage** de la rÃ©plication avec la bonne position
4. **Monitoring** continu de l'Ã©tat et des performances
5. **Maintenance** et optimisation

ğŸ’¡ **Architecture de rÃ©fÃ©rence** :
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         Binary Log Events        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>  â”‚                 â”‚
â”‚  PRIMARY        â”‚                                  â”‚  REPLICA        â”‚
â”‚  (Source)       â”‚  <â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  (Target)       â”‚
â”‚                 â”‚    Position/GTID Acknowledgment  â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      write                                                read-only
```

---

## Restauration du Snapshot Initial

Avant de configurer la rÃ©plication, vous devez **restaurer les donnÃ©es** du Primary sur le Replica. Le choix de la mÃ©thode dÃ©pend de la taille de votre base et de vos contraintes.

### MÃ©thode 1 : Restauration depuis mysqldump

Si vous avez utilisÃ© `mariadb-dump` sur le Primary :

```bash
# 1. Copier le fichier dump sur le Replica
scp user@primary:/backup/full_backup.sql /tmp/

# 2. Restaurer le dump
mariadb -u root -p < /tmp/full_backup.sql

# Le dump contient la position binlog en commentaire (--master-data=2)
# Exemple dans le fichier :
# -- CHANGE MASTER TO MASTER_LOG_FILE='mariadb-bin.000001', MASTER_LOG_POS=12345;
```

ğŸ’¡ **Astuce** : Extraire automatiquement la position du dump :

```bash
# Extraire la position binlog du dump
grep "CHANGE MASTER TO" /tmp/full_backup.sql
# RÃ©sultat : -- CHANGE MASTER TO MASTER_LOG_FILE='mariadb-bin.000001', MASTER_LOG_POS=12345;
```

### MÃ©thode 2 : Restauration depuis Mariabackup

Si vous avez utilisÃ© Mariabackup sur le Primary :

```bash
# 1. Copier le backup sur le Replica
rsync -avz user@primary:/backup/full/ /backup/full/

# 2. PrÃ©parer le backup (apply-log)
mariabackup --prepare --target-dir=/backup/full

# 3. Restaurer le backup
# ATTENTION : Le datadir doit Ãªtre vide
systemctl stop mariadb
rm -rf /var/lib/mysql/*
mariabackup --copy-back --target-dir=/backup/full
chown -R mysql:mysql /var/lib/mysql

# 4. RÃ©cupÃ©rer la position binlog
cat /backup/full/xtrabackup_binlog_info
# RÃ©sultat : mariadb-bin.000001  12345

# 5. DÃ©marrer MariaDB
systemctl start mariadb
```

ğŸ†• **MariaDB 11.8** : Mariabackup avec BACKUP STAGE offre une cohÃ©rence amÃ©liorÃ©e et des snapshots plus rapides.

### MÃ©thode 3 : Clonage depuis un Replica existant

Pour ajouter un nouveau Replica Ã  partir d'un Replica existant :

```bash
# Sur le Replica source : crÃ©er un backup
mariabackup --backup \
  --target-dir=/backup/replica \
  --slave-info  # Inclut la position du Primary (pas du Replica)

# La position est dans : xtrabackup_slave_info
cat /backup/replica/xtrabackup_slave_info
# RÃ©sultat : CHANGE MASTER TO MASTER_LOG_FILE='mariadb-bin.000003', MASTER_LOG_POS=67890
```

âš ï¸ **Important** : Avec `--slave-info`, la position enregistrÃ©e est celle du **Primary**, pas du Replica source.

---

## Configuration de Base du Replica

### ParamÃ¨tres essentiels dans `my.cnf`

```ini
[mariadb]
# Identifiant unique du serveur (DIFFÃ‰RENT du Primary)
server-id = 2

# Mode read-only pour Ã©viter les Ã©critures accidentelles
# (les connexions SUPER peuvent toujours Ã©crire)
read_only = ON

# Mode super read-only (mÃªme les SUPER ne peuvent pas Ã©crire)
# RecommandÃ© en production pour Ã©viter les divergences
super_read_only = ON

# Activer le binary log sur le Replica (optionnel, mais recommandÃ©)
# NÃ©cessaire pour : rÃ©plication en cascade, PITR, promote en Primary
log-bin = /var/log/mariadb/mariadb-bin
log-bin-index = /var/log/mariadb/mariadb-bin.index
binlog-format = ROW

# Configuration de rÃ©plication
# Relay log : log intermÃ©diaire des Ã©vÃ©nements du Primary
relay-log = /var/log/mariadb/relay-bin
relay-log-index = /var/log/mariadb/relay-bin.index

# Relay log info : position de lecture du relay log
relay-log-info-repository = TABLE  # Plus fiable que FILE
relay-log-recovery = ON  # Auto-rÃ©cupÃ©ration aprÃ¨s crash

# Master info : position de lecture du binlog Primary
master-info-repository = TABLE  # Plus fiable que FILE

# Skip des erreurs (Ã€ Ã‰VITER en production)
# slave-skip-errors = 1062,1032  # NE PAS UTILISER sauf debug
```

ğŸ’¡ **Bonne pratique** : Toujours activer `log-bin` sur le Replica pour permettre une promotion facile en Primary en cas de failover.

### Informations stockÃ©es dans des tables

Depuis MariaDB 10.0, les informations de rÃ©plication sont stockÃ©es dans des tables (plus fiable que des fichiers) :

```sql
-- Tables de mÃ©tadonnÃ©es de rÃ©plication
USE mysql;

-- Position du Primary (master info)
SELECT * FROM mysql.slave_master_info\G

-- Position du relay log
SELECT * FROM mysql.slave_relay_log_info\G

-- Connexions multi-source
SELECT * FROM mysql.slave_worker_info\G
```

---

## DÃ©marrage de la RÃ©plication : Positions Binlog

### MÃ©thode traditionnelle (sans GTID)

```sql
-- 1. Stopper la rÃ©plication si elle est active
STOP SLAVE;  -- ou STOP REPLICA (nouveau nom MariaDB 10.5+)

-- 2. Configurer la connexion au Primary
CHANGE MASTER TO
  MASTER_HOST = '192.168.1.100',        -- IP du Primary
  MASTER_PORT = 3306,                   -- Port du Primary
  MASTER_USER = 'repl_user',            -- Utilisateur de rÃ©plication
  MASTER_PASSWORD = 'SecurePassword123!',
  MASTER_LOG_FILE = 'mariadb-bin.000001',  -- Position du snapshot
  MASTER_LOG_POS = 12345,                  -- Position exacte
  MASTER_CONNECT_RETRY = 10,            -- Intervalle de retry (secondes)
  MASTER_USE_GTID = no;                 -- DÃ©sactiver GTID

-- 3. DÃ©marrer la rÃ©plication
START SLAVE;  -- ou START REPLICA

-- 4. VÃ©rifier le statut
SHOW SLAVE STATUS\G
```

ğŸ’¡ **Nouvelle syntaxe MariaDB 10.5+** :

```sql
-- Syntaxe moderne (REPLICA au lieu de SLAVE)
STOP REPLICA;

CHANGE MASTER TO
  MASTER_HOST = '192.168.1.100',
  MASTER_USER = 'repl_user',
  MASTER_PASSWORD = 'SecurePassword123!',
  MASTER_LOG_FILE = 'mariadb-bin.000001',
  MASTER_LOG_POS = 12345;

START REPLICA;
SHOW REPLICA STATUS\G
```

âš ï¸ **Attention** : Les deux syntaxes (SLAVE/REPLICA) fonctionnent, mais REPLICA est recommandÃ©e pour MariaDB 10.5+.

### Configuration SSL/TLS

Pour sÃ©curiser la connexion de rÃ©plication :

```sql
STOP REPLICA;

CHANGE MASTER TO
  MASTER_HOST = '192.168.1.100',
  MASTER_USER = 'repl_user',
  MASTER_PASSWORD = 'SecurePassword123!',
  MASTER_LOG_FILE = 'mariadb-bin.000001',
  MASTER_LOG_POS = 12345,
  MASTER_SSL = 1,                         -- Activer SSL
  MASTER_SSL_CA = '/etc/mysql/ssl/ca-cert.pem',
  MASTER_SSL_CERT = '/etc/mysql/ssl/client-cert.pem',
  MASTER_SSL_KEY = '/etc/mysql/ssl/client-key.pem',
  MASTER_SSL_VERIFY_SERVER_CERT = 1;      -- VÃ©rifier le certificat

START REPLICA;
```

ğŸ†• **MariaDB 11.8** : TLS est activÃ© par dÃ©faut, la configuration SSL est simplifiÃ©e et plus sÃ©curisÃ©e.

---

## DÃ©marrage de la RÃ©plication : GTID (RecommandÃ©)

Le **GTID (Global Transaction Identifier)** est la mÃ©thode moderne et recommandÃ©e pour la rÃ©plication. Elle simplifie drastiquement la configuration et le failover.

### Configuration avec GTID

```sql
-- 1. Stopper la rÃ©plication
STOP REPLICA;

-- 2. Configurer avec GTID
CHANGE MASTER TO
  MASTER_HOST = '192.168.1.100',
  MASTER_USER = 'repl_user',
  MASTER_PASSWORD = 'SecurePassword123!',
  MASTER_USE_GTID = slave_pos;  -- Utiliser la position GTID du Replica

-- Alternative : current_pos (utilise la position actuelle du Primary)
-- MASTER_USE_GTID = current_pos;

-- 3. DÃ©marrer la rÃ©plication
START REPLICA;

-- 4. VÃ©rifier
SHOW REPLICA STATUS\G
```

ğŸ’¡ **DiffÃ©rence slave_pos vs current_pos** :

| Option | Description | Usage |
|--------|-------------|-------|
| `slave_pos` | Utilise `@@gtid_slave_pos` (position du Replica) | **RecommandÃ©** : Pour reprendre la rÃ©plication aprÃ¨s arrÃªt/maintenance |
| `current_pos` | Utilise `@@gtid_current_pos` (position courante globale) | Initialisation : Pour dÃ©marrer rÃ©plication sur nouveau Replica |

### Initialisation GTID pour nouveau Replica

```sql
-- Sur le Replica : DÃ©finir la position GTID depuis le snapshot
SET GLOBAL gtid_slave_pos = '0-1-1000';  -- Format : domain-server_id-seq_no

-- Puis dÃ©marrer la rÃ©plication
CHANGE MASTER TO
  MASTER_HOST = '192.168.1.100',
  MASTER_USER = 'repl_user',
  MASTER_PASSWORD = 'SecurePassword123!',
  MASTER_USE_GTID = slave_pos;

START REPLICA;
```

ğŸ’¡ **Obtenir le GTID depuis le dump** :

```bash
# Dans le fichier mysqldump avec --master-data
grep "SET GLOBAL gtid_slave_pos" /tmp/full_backup.sql
# RÃ©sultat : SET GLOBAL gtid_slave_pos='0-1-1000';
```

### VÃ©rification GTID

```sql
-- Position GTID actuelle du Replica
SELECT @@gtid_slave_pos;

-- Position GTID du binlog local (si activÃ©)
SELECT @@gtid_binlog_pos;

-- Comparer avec le Primary
-- Sur le Primary :
SELECT @@gtid_binlog_pos;
-- RÃ©sultat : 0-1-2500

-- Sur le Replica :
SELECT @@gtid_slave_pos;
-- RÃ©sultat : 0-1-2450 (lag de 50 transactions)
```

---

## Monitoring de la RÃ©plication : SHOW REPLICA STATUS

La commande `SHOW REPLICA STATUS` (ou `SHOW SLAVE STATUS`) est **l'outil principal** pour surveiller la rÃ©plication.

### Commande de base

```sql
SHOW REPLICA STATUS\G
```

### Champs critiques Ã  surveiller

```sql
-- Exemple de sortie (principaux champs)
*************************** 1. row ***************************
                Slave_IO_State: Waiting for master to send event
                   Master_Host: 192.168.1.100
                   Master_User: repl_user
                   Master_Port: 3306
                 Connect_Retry: 10
               Master_Log_File: mariadb-bin.000003
           Read_Master_Log_Pos: 67890
                Relay_Log_File: relay-bin.000005
                 Relay_Log_Pos: 12345
         Relay_Master_Log_File: mariadb-bin.000003
              Slave_IO_Running: Yes      -- CRITIQUE : doit Ãªtre Yes
             Slave_SQL_Running: Yes      -- CRITIQUE : doit Ãªtre Yes
               Replicate_Do_DB: 
           Replicate_Ignore_DB: 
            Replicate_Do_Table: 
        Replicate_Ignore_Table: 
       Replicate_Wild_Do_Table: 
   Replicate_Wild_Ignore_Table: 
                    Last_Errno: 0
                    Last_Error: 
                  Skip_Counter: 0
           Exec_Master_Log_Pos: 67890
               Relay_Log_Space: 45678
               Until_Condition: None
                Until_Log_File: 
                 Until_Log_Pos: 0
            Master_SSL_Allowed: Yes
            Master_SSL_CA_File: /etc/mysql/ssl/ca-cert.pem
         Master_SSL_Verify_Server_Cert: Yes
                 Last_IO_Errno: 0
                 Last_IO_Error: 
                Last_SQL_Errno: 0
                Last_SQL_Error: 
                   Using_Gtid: Slave_Pos
                    Gtid_IO_Pos: 0-1-2500
        Replicate_Rewrite_DB: 
                Channel_Name: 
          Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates
                 Seconds_Behind_Master: 0      -- LAG EN SECONDES
```

### InterprÃ©tation des champs critiques

| Champ | Valeur OK | Signification |
|-------|-----------|---------------|
| **Slave_IO_Running** | Yes | Thread I/O connectÃ© au Primary et lit le binlog |
| **Slave_SQL_Running** | Yes | Thread SQL applique les Ã©vÃ©nements du relay log |
| **Last_Errno** | 0 | Pas d'erreur rÃ©cente |
| **Seconds_Behind_Master** | 0 ou petit | Lag de rÃ©plication en secondes |
| **Using_Gtid** | Slave_Pos | Utilise GTID (recommandÃ©) |
| **Gtid_IO_Pos** | Correspond au Primary | Position GTID synchronisÃ©e |

âš ï¸ **Alertes critiques** :

```sql
-- Si Slave_IO_Running = No
-- ProblÃ¨me de connexion au Primary ou d'I/O

-- Si Slave_SQL_Running = No
-- Erreur d'application des Ã©vÃ©nements (conflit, erreur SQL)

-- Si Last_Errno != 0
-- Erreur spÃ©cifique Ã  investiguer dans Last_Error
```

### RequÃªte de monitoring automatisÃ©e

```sql
-- VÃ©rification rapide du statut
SELECT 
  Slave_IO_Running,
  Slave_SQL_Running,
  Seconds_Behind_Master,
  Last_Errno,
  Last_Error,
  Using_Gtid,
  Gtid_IO_Pos
FROM information_schema.SLAVE_STATUS\G
```

ğŸ’¡ **Script de monitoring** (Ã  intÃ©grer dans Prometheus/Grafana) :

```sql
-- RequÃªte pour exporter vers monitoring
SELECT 
  IF(Slave_IO_Running = 'Yes', 1, 0) AS io_running,
  IF(Slave_SQL_Running = 'Yes', 1, 0) AS sql_running,
  COALESCE(Seconds_Behind_Master, -1) AS lag_seconds,
  Last_Errno AS error_code
FROM information_schema.SLAVE_STATUS;
```

---

## Gestion du Lag de RÃ©plication

Le **lag de rÃ©plication** (Seconds_Behind_Master) est le retard entre le Primary et le Replica. Un lag Ã©levÃ© indique que le Replica n'arrive pas Ã  suivre le rythme.

### Causes courantes du lag

1. **Charge Ã©levÃ©e sur le Replica** : CPU/RAM/IO saturÃ©s
2. **RequÃªtes lentes sur le Replica** : Index manquants, tables non optimisÃ©es
3. **RÃ©plication mono-thread** : Le SQL thread est mono-threaded par dÃ©faut
4. **ALTER TABLE lourd** : Bloque la rÃ©plication pendant des heures

### Diagnostic du lag

```sql
-- VÃ©rifier le lag actuel
SHOW REPLICA STATUS\G
-- Regarder : Seconds_Behind_Master

-- Identifier les transactions en attente
SELECT * FROM information_schema.PROCESSLIST 
WHERE User = 'system user'
  AND State LIKE '%Waiting%';

-- VÃ©rifier la taille du relay log
SHOW VARIABLES LIKE 'relay_log_space_limit';

SELECT 
  SUM(File_size) / 1024 / 1024 AS relay_log_mb
FROM information_schema.RELAY_LOG_INFO;
```

### Solution 1 : Parallel Replication (Multi-threaded SQL)

MariaDB supporte la rÃ©plication parallÃ¨le pour accÃ©lÃ©rer l'application des Ã©vÃ©nements :

```ini
[mariadb]
# Activer la rÃ©plication parallÃ¨le
slave_parallel_threads = 8  # Nombre de threads SQL

# Mode de parallÃ©lisation
# conservative : Plus sÃ»r, moins parallÃ¨le
# optimistic : Plus parallÃ¨le, risque de deadlock
# aggressive : Maximum parallÃ¨le (depuis 10.3)
slave_parallel_mode = optimistic

# Domain-based parallelism (pour GTID multi-source)
slave_parallel_max_queued = 131072
```

ğŸ’¡ **Recommandation** : Commencez avec 4-8 threads et ajustez selon le monitoring.

### Solution 2 : Optimistic ALTER TABLE ğŸ†•

**NouveautÃ© MariaDB 11.8** : RÃ©duit drastiquement le lag pendant les opÃ©rations DDL lourdes.

```ini
[mariadb]
# Activer l'optimistic ALTER pour rÃ©duire le lag
# Le replica continue Ã  appliquer les transactions non-liÃ©es pendant l'ALTER
replication_optimize_for_static_plugin_config = ON
```

**Fonctionnement** :
- Traditionnellement : `ALTER TABLE huge_table` bloque **toute** la rÃ©plication
- Avec Optimistic ALTER : Les transactions sur **autres tables** continuent Ã  Ãªtre appliquÃ©es

**Exemple concret** :

```sql
-- Sur le Primary : ALTER de 4 heures
ALTER TABLE orders ADD INDEX idx_created_at(created_at);
-- Table orders : 500 millions de lignes

-- Sans Optimistic ALTER (< 11.8) :
-- Seconds_Behind_Master atteint 14400 (4 heures)
-- Toutes les tables sont en attente

-- Avec Optimistic ALTER (11.8+) :
-- Seconds_Behind_Master reste < 60 secondes pour autres tables
-- Seule la table 'orders' est bloquÃ©e
```

âš ï¸ **Configuration automatique** : Avec GTID activÃ©, Optimistic ALTER est automatique en 11.8, aucune config manuelle nÃ©cessaire dans la plupart des cas.

### Solution 3 : Filtrage de rÃ©plication

RÃ©duire la charge en ne rÃ©pliquant que certaines bases/tables :

```ini
[mariadb]
# RÃ©pliquer uniquement certaines bases
replicate-do-db = production
replicate-do-db = analytics

# Ignorer certaines bases
replicate-ignore-db = test
replicate-ignore-db = staging

# Filtrage par table (plus flexible)
replicate-do-table = production.orders
replicate-do-table = production.users

# Wildcards
replicate-wild-do-table = production.%
replicate-wild-ignore-table = %.temp_%
```

ğŸ’¡ **PrÃ©fÃ©rez le filtrage cÃ´tÃ© Replica** plutÃ´t que cÃ´tÃ© Primary (`binlog-do-db`) pour plus de flexibilitÃ©.

### Solution 4 : Tuning InnoDB et I/O

```ini
[mariadb]
# Augmenter le buffer pool si possible
innodb_buffer_pool_size = 32G

# Optimiser les I/O pour SSD
innodb_flush_method = O_DIRECT
innodb_io_capacity = 4000
innodb_io_capacity_max = 8000

# Relay log : buffer en mÃ©moire
relay_log_space_limit = 4G  # Limiter l'espace relay log
sync_relay_log = 0          # Ne pas fsync (sÃ©curitÃ© moindre)
```

âš ï¸ **Trade-off sÃ©curitÃ©/performance** : `sync_relay_log = 0` amÃ©liore les performances mais rÃ©duit la durabilitÃ© en cas de crash.

---

## Troubleshooting : Erreurs Courantes

### Erreur 1. Slave_IO_Running = No

**SymptÃ´me** :
```
Slave_IO_Running: No
Last_IO_Errno: 2003
Last_IO_Error: Can't connect to MySQL server on '192.168.1.100' (111)
```

**Causes possibles** :
- Firewall bloque le port 3306
- Primary arrÃªtÃ© ou injoignable
- Credentials incorrects
- SSL mal configurÃ©

**Solutions** :

```bash
# Tester la connectivitÃ© rÃ©seau
telnet 192.168.1.100 3306
# ou
nc -zv 192.168.1.100 3306

# Tester la connexion MariaDB
mariadb -h 192.168.1.100 -u repl_user -p

# VÃ©rifier le firewall sur le Primary
sudo firewall-cmd --list-all  # (RHEL/CentOS)
sudo ufw status               # (Ubuntu/Debian)
```

### Erreur 2. Slave_SQL_Running = No

**SymptÃ´me** :
```
Slave_SQL_Running: No
Last_SQL_Errno: 1062
Last_SQL_Error: Error 'Duplicate entry '123' for key 'PRIMARY'' on query
```

**Causes** :
- Conflit de clÃ© primaire/unique (erreur 1062)
- Ligne manquante (erreur 1032)
- Ã‰criture accidentelle sur le Replica (super_read_only = OFF)

**Solutions** :

```sql
-- 1. Identifier la transaction problÃ©matique
SHOW REPLICA STATUS\G
-- Regarder : Last_SQL_Error, Exec_Master_Log_Pos

-- 2. Option A : Corriger manuellement le conflit
-- Par exemple, supprimer la ligne en conflit
DELETE FROM table_name WHERE id = 123;

-- Puis reprendre la rÃ©plication
START REPLICA;

-- 3. Option B : Sauter l'Ã©vÃ©nement problÃ©matique (DANGEREUX)
STOP REPLICA;
SET GLOBAL sql_slave_skip_counter = 1;  -- Sauter 1 Ã©vÃ©nement
START REPLICA;

-- 4. Option C : Avec GTID, rÃ©initialiser Ã  la position suivante
STOP REPLICA;
SET GLOBAL gtid_slave_pos = '0-1-1001';  -- Position suivante
START REPLICA;
```

âš ï¸ **Danger** : Sauter des Ã©vÃ©nements peut causer des **incohÃ©rences de donnÃ©es**. Ã€ n'utiliser qu'en dernier recours et aprÃ¨s analyse.

### Erreur 3. Lag Ã©levÃ© persistant

**SymptÃ´me** :
```
Seconds_Behind_Master: 3600  -- 1 heure de retard
```

**Diagnostic** :

```sql
-- VÃ©rifier les slow queries sur le Replica
SELECT * FROM mysql.slow_log 
ORDER BY query_time DESC 
LIMIT 10;

-- VÃ©rifier les processus en cours
SHOW PROCESSLIST;

-- Identifier les tables sans index
SELECT 
  t.TABLE_SCHEMA,
  t.TABLE_NAME,
  t.TABLE_ROWS,
  COUNT(s.INDEX_NAME) AS index_count
FROM information_schema.TABLES t
LEFT JOIN information_schema.STATISTICS s 
  ON t.TABLE_SCHEMA = s.TABLE_SCHEMA 
  AND t.TABLE_NAME = s.TABLE_NAME
WHERE t.TABLE_SCHEMA NOT IN ('mysql', 'information_schema', 'performance_schema')
GROUP BY t.TABLE_SCHEMA, t.TABLE_NAME
HAVING index_count <= 1  -- Seulement PRIMARY KEY
ORDER BY t.TABLE_ROWS DESC;
```

**Solutions** :
- Activer la rÃ©plication parallÃ¨le (slave_parallel_threads)
- Optimiser les index sur le Replica
- Augmenter les ressources (CPU/RAM/SSD)
- Filtrer les bases non critiques

### Erreur 4. GTID dÃ©synchronisÃ©

**SymptÃ´me** :
```
Last_SQL_Error: An attempt was made to binlog GTID 0-1-1500 which would create an out-of-order sequence number
```

**Cause** : Ã‰criture manuelle sur le Replica alors que GTID est activÃ©.

**Solution** :

```sql
-- 1. Identifier le problÃ¨me
SELECT @@gtid_slave_pos, @@gtid_binlog_pos;

-- 2. RÃ©initialiser la rÃ©plication (DESTRUCTIF)
STOP REPLICA;
RESET SLAVE ALL;

-- 3. Reconfigurer depuis le dÃ©but
CHANGE MASTER TO ...;
START REPLICA;
```

âš ï¸ **PrÃ©vention** : Toujours activer `super_read_only = ON` sur les Replicas pour empÃªcher les Ã©critures accidentelles.

---

## Configuration ComplÃ¨te RecommandÃ©e (Production)

Voici une configuration `my.cnf` complÃ¨te pour un Replica MariaDB 11.8 en production :

```ini
[mariadb]
# ============================================
# CONFIGURATION REPLICA - MariaDB 11.8 LTS
# ============================================

# --- Identification ---
server-id = 2  # UNIQUE et DIFFÃ‰RENT du Primary

# --- Read-Only Mode ---
read_only = ON
super_read_only = ON  # MÃªme SUPER ne peut pas Ã©crire

# --- Binary Log (recommandÃ© pour promotion) ---
log-bin = /var/log/mariadb/mariadb-bin
log-bin-index = /var/log/mariadb/mariadb-bin.index
binlog-format = ROW
max_binlog_size = 1G
binlog_expire_logs_seconds = 259200  # 3 jours

# --- Relay Log ---
relay-log = /var/log/mariadb/relay-bin
relay-log-index = /var/log/mariadb/relay-bin.index
relay-log-info-repository = TABLE
relay-log-recovery = ON
relay_log_space_limit = 4G

# --- Master Info ---
master-info-repository = TABLE

# --- GTID ---
gtid_strict_mode = ON
gtid_domain_id = 0

# --- RÃ©plication ParallÃ¨le ---
slave_parallel_threads = 8
slave_parallel_mode = optimistic
slave_parallel_max_queued = 131072

# --- Optimistic ALTER TABLE (11.8) ---
replication_optimize_for_static_plugin_config = ON

# --- Performance ---
innodb_buffer_pool_size = 32G  # 70-80% RAM
innodb_flush_method = O_DIRECT
innodb_io_capacity = 4000
innodb_io_capacity_max = 8000
innodb_read_io_threads = 8
innodb_write_io_threads = 8

# --- SÃ©curitÃ© SSL/TLS ---
ssl-ca = /etc/mysql/ssl/ca-cert.pem
ssl-cert = /etc/mysql/ssl/client-cert.pem
ssl-key = /etc/mysql/ssl/client-key.pem
require_secure_transport = ON

# --- Monitoring ---
slow_query_log = ON
slow_query_log_file = /var/log/mariadb/slow-query.log
long_query_time = 1
log_warnings = 2

# --- Charset (11.8 dÃ©faut) ---
character_set_server = utf8mb4
collation_server = utf8mb4_unicode_ci

# --- Filtrage (exemple - adapter selon besoin) ---
# replicate-do-db = production
# replicate-ignore-db = test
```

---

## Scripts de Monitoring et Maintenance

### Script de vÃ©rification automatique

```bash
#!/bin/bash
# check_replication.sh - Monitoring de la rÃ©plication

# VÃ©rifier le statut
STATUS=$(mariadb -e "SHOW REPLICA STATUS\G" | grep -E "Slave_IO_Running|Slave_SQL_Running|Seconds_Behind_Master")

echo "$STATUS"

# Extraire les valeurs
IO_RUNNING=$(echo "$STATUS" | grep "Slave_IO_Running" | awk '{print $2}')
SQL_RUNNING=$(echo "$STATUS" | grep "Slave_SQL_Running" | awk '{print $2}')
LAG=$(echo "$STATUS" | grep "Seconds_Behind_Master" | awk '{print $2}')

# Alerter si problÃ¨me
if [ "$IO_RUNNING" != "Yes" ] || [ "$SQL_RUNNING" != "Yes" ]; then
    echo "CRITICAL: Replication is broken!"
    exit 2
elif [ "$LAG" -gt 300 ]; then
    echo "WARNING: Lag is $LAG seconds (>5 minutes)"
    exit 1
else
    echo "OK: Replication is healthy (lag: $LAG seconds)"
    exit 0
fi
```

### Script de promotion Primary â†’ Replica

En cas de failover, promouvoir le Replica en Primary :

```sql
-- 1. Stopper la rÃ©plication
STOP REPLICA;

-- 2. DÃ©sactiver read-only
SET GLOBAL read_only = OFF;
SET GLOBAL super_read_only = OFF;

-- 3. RÃ©initialiser le statut de rÃ©plication
RESET SLAVE ALL;  -- Efface toute config de rÃ©plication

-- 4. VÃ©rifier la position GTID
SELECT @@gtid_binlog_pos;

-- Le Replica est maintenant un Primary
-- D'autres Replicas peuvent se connecter Ã  lui
```

---

## âœ… Points clÃ©s Ã  retenir

- **server-id** du Replica doit Ãªtre **unique** et diffÃ©rent du Primary
- **super_read_only = ON** empÃªche les Ã©critures accidentelles et les divergences
- **GTID** (MASTER_USE_GTID = slave_pos) simplifie considÃ©rablement la gestion et le failover
- **SHOW REPLICA STATUS** est la commande essentielle pour le monitoring quotidien
- **Slave_IO_Running** et **Slave_SQL_Running** doivent **toujours** Ãªtre "Yes"
- **Seconds_Behind_Master** est l'indicateur clÃ© du lag de rÃ©plication
- **RÃ©plication parallÃ¨le** (slave_parallel_threads) accÃ©lÃ¨re l'application des Ã©vÃ©nements
- ğŸ†• **Optimistic ALTER TABLE (11.8)** rÃ©duit drastiquement le lag lors des DDL lourds
- **Relay log** stockÃ© en TABLE est plus fiable que FILE
- **SSL/TLS** doit Ãªtre activÃ© pour sÃ©curiser les donnÃ©es en transit
- **Toujours** activer le binlog sur le Replica pour permettre une promotion facile
- En cas d'erreur, **identifier la cause** avant de sauter des Ã©vÃ©nements (risque d'incohÃ©rence)

---

## ğŸ”— Ressources et rÃ©fÃ©rences

- [ğŸ“– MariaDB Replication Documentation](https://mariadb.com/kb/en/replication/)
- [ğŸ“– Setting up Replication](https://mariadb.com/kb/en/setting-up-replication/)
- [ğŸ“– GTID Documentation](https://mariadb.com/kb/en/gtid/)
- [ğŸ“– Parallel Replication](https://mariadb.com/kb/en/parallel-replication/)
- [ğŸ“– SHOW REPLICA STATUS Reference](https://mariadb.com/kb/en/show-replica-status/)
- [ğŸ“– MariaDB 11.8 Optimistic ALTER](https://mariadb.org/optimistic-alter-table/)
- [ğŸ“„ Blog : Troubleshooting Replication Lag](https://mariadb.com/resources/blog/troubleshooting-replication-lag/)

---

## â¡ï¸ Section suivante

**13.2.3 CHANGE MASTER TO / CHANGE REPLICATION SOURCE** : Nous allons approfondir la commande CHANGE MASTER TO et ses nombreuses options pour gÃ©rer les configurations complexes de rÃ©plication.

---


â­ï¸ [CHANGE MASTER TO / CHANGE REPLICATION SOURCE](/13-replication/02.3-change-master-to.md)
