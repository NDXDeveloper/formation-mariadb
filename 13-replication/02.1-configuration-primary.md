üîù Retour au [Sommaire](/SOMMAIRE.md)

# 13.2.1 Configuration du Primary (binlog)

> **Niveau** : Avanc√©  
> **Dur√©e estim√©e** : 2-3 heures  
> **Pr√©requis** : 
> - Section 11.5 (Binary logs et logs de transactions)
> - Compr√©hension des concepts de r√©plication (13.1)
> - Administration syst√®me MariaDB (Partie 5)

## üéØ Objectifs d'apprentissage

√Ä l'issue de cette section, vous serez capable de :
- Configurer correctement un serveur MariaDB comme Primary (Master) pour la r√©plication
- Activer et param√©trer le binary log avec les options optimales
- Choisir le format de binlog appropri√© selon votre cas d'usage
- S√©curiser le Primary et cr√©er un utilisateur de r√©plication
- Diagnostiquer et r√©soudre les probl√®mes courants de configuration
- Optimiser les performances du binlog en production

---

## Introduction

Le **Primary** (anciennement appel√© Master) est le serveur source dans une architecture de r√©plication MariaDB. Sa configuration correcte est **cruciale** pour assurer la fiabilit√©, les performances et la coh√©rence de toute la cha√Æne de r√©plication.

Le **binary log** (binlog) est le m√©canisme central qui enregistre toutes les modifications de donn√©es. Sans une configuration appropri√©e du binlog, la r√©plication est impossible. Cette section d√©taille chaque aspect de cette configuration pour MariaDB 11.8 LTS.

üí° **Pourquoi cette configuration est critique** :
- Le binlog est la source de v√©rit√© pour tous les replicas
- Une mauvaise configuration peut causer des pertes de donn√©es
- Les performances du Primary impactent directement tous les replicas
- La s√©curit√© du Primary prot√®ge l'ensemble du cluster

---

## Activation du Binary Log

### Param√®tres essentiels dans `my.cnf`

Pour transformer un serveur MariaDB en Primary, vous devez activer le binary log et d√©finir un identifiant unique :

```ini
[mariadb]
# Identifiant unique du serveur (obligatoire)
# Doit √™tre diff√©rent pour chaque serveur du cluster de r√©plication
server-id = 1

# Activation du binary log
# Le chemin peut √™tre absolu ou relatif au datadir
log-bin = /var/log/mariadb/mariadb-bin

# Index des fichiers binlog
log-bin-index = /var/log/mariadb/mariadb-bin.index

# Format du binary log (ROW recommand√©)
binlog-format = ROW

# Durabilit√© : synchro disque du binlog
# 1 = maximum s√©curit√© (fsync √† chaque transaction)
# 0 = performances maximales (syst√®me g√®re le flush)
sync-binlog = 1
```

‚ö†Ô∏è **Attention** : Le `server-id` doit √™tre **unique** dans tout votre environnement de r√©plication. Une valeur dupliqu√©e causera des conflits graves.

### V√©rification de l'activation

Apr√®s red√©marrage du serveur, v√©rifiez que le binlog est actif :

```sql
-- V√©rifier que le binary log est activ√©
SHOW VARIABLES LIKE 'log_bin';
-- R√©sultat attendu : ON

-- Afficher les fichiers binlog existants
SHOW BINARY LOGS;

-- Voir le binlog actuel
SHOW MASTER STATUS;
```

R√©sultat attendu de `SHOW MASTER STATUS` :

```
+--------------------+----------+--------------+------------------+
| File               | Position | Binlog_Do_DB | Binlog_Ignore_DB |
+--------------------+----------+--------------+------------------+
| mariadb-bin.000001 |      342 |              |                  |
+--------------------+----------+--------------+------------------+
```

üí° **Conseil** : Stockez les binary logs sur un syst√®me de fichiers performant (SSD de pr√©f√©rence) et distinct du datadir si possible pour r√©partir les I/O.

---

## Formats de Binary Log

MariaDB supporte trois formats de binary log, chacun ayant des avantages et inconv√©nients sp√©cifiques.

### Format STATEMENT

Enregistre les requ√™tes SQL telles qu'elles ont √©t√© ex√©cut√©es.

```ini
binlog-format = STATEMENT
```

**Avantages** :
- Fichiers binlog plus compacts
- Facilite l'audit (requ√™tes SQL lisibles)
- Compatible avec d'anciennes versions

**Inconv√©nients** :
- Fonctions non-d√©terministes probl√©matiques (`NOW()`, `UUID()`, `RAND()`)
- Triggers complexes peuvent causer des divergences
- Risque d'incoh√©rence entre Primary et Replica

**Cas d'usage** : Legacy, environnements tr√®s contraints en espace disque.

### Format ROW (Recommand√©) üÜï

Enregistre les modifications de lignes effectives (avant/apr√®s).

```ini
binlog-format = ROW

# Niveau de verbosit√© des √©v√©nements ROW
# MINIMAL (d√©faut) : seulement les colonnes modifi√©es
# FULL : toutes les colonnes (utile pour CDC)
binlog-row-image = MINIMAL
```

**Avantages** :
- **Coh√©rence garantie** : les m√™mes donn√©es sont appliqu√©es
- S√©curit√© maximale pour les fonctions non-d√©terministes
- Id√©al pour les outils de Change Data Capture (CDC)
- **Recommand√© depuis MariaDB 10.2** et d√©faut dans 11.8

**Inconv√©nients** :
- Fichiers binlog plus volumineux
- Moins lisible pour l'audit manuel
- Consommation r√©seau accrue

**Cas d'usage** : Production moderne, haute disponibilit√©, CDC, int√©gration Kafka/Debezium.

üÜï **MariaDB 11.8** : Le format ROW est optimis√© avec une compression am√©lior√©e et `binlog-row-image=MINIMAL` par d√©faut pour r√©duire la taille.

### Format MIXED

Hybride intelligent : STATEMENT par d√©faut, ROW quand n√©cessaire.

```ini
binlog-format = MIXED
```

**Comportement** :
- Utilise STATEMENT pour les requ√™tes d√©terministes
- Bascule automatiquement en ROW pour les requ√™tes non-d√©terministes

**Cas d'usage** : Compromis entre taille et s√©curit√©, migrations progressives.

üí° **Recommandation 2025** : Privil√©giez **ROW** sauf contrainte sp√©cifique. Les avantages en coh√©rence et observabilit√© l'emportent largement.

---

## Configuration Avanc√©e du Binary Log

### Filtrage s√©lectif

Vous pouvez contr√¥ler quelles bases/tables sont r√©pliqu√©es :

```ini
# R√©pliquer uniquement certaines bases
binlog-do-db = production_db
binlog-do-db = analytics_db

# Exclure certaines bases de la r√©plication
binlog-ignore-db = test_db
binlog-ignore-db = temp_data
```

‚ö†Ô∏è **Pi√®ge courant** : `binlog-do-db` fonctionne sur la **base par d√©faut** (`USE database`), pas sur les bases r√©f√©renc√©es dans les requ√™tes. Pr√©f√©rez le filtrage c√¥t√© Replica quand possible.

### Rotation et r√©tention

```ini
# Taille maximale d'un fichier binlog avant rotation
max_binlog_size = 1G

# Dur√©e de conservation des binlogs (en secondes)
# 7 jours = 604800 secondes
binlog_expire_logs_seconds = 604800

# Alternative : nombre de jours (deprecated, utilisez binlog_expire_logs_seconds)
# expire_logs_days = 7
```

üí° **Bonne pratique** : Conservez les binlogs **au minimum le temps de vos sauvegardes** pour permettre le Point-in-Time Recovery (PITR).

### Compression du binlog üÜï

```ini
# Compression des √©v√©nements binlog (depuis MariaDB 10.2)
# R√©duit la taille et le trafic r√©seau
binlog_row_metadata = MINIMAL

# Compression effective pour format ROW
binlog_row_image = MINIMAL
```

üÜï **MariaDB 11.8** : La compression binlog est plus efficace gr√¢ce aux optimisations internes du moteur InnoDB.

### Durabilit√© et performances

```ini
# sync_binlog : Nombre de commits avant fsync du binlog sur disque
# 1 = Maximum s√©curit√© (ACID complet, recommand√© production)
# 0 = OS g√®re le flush (performances max, risque perte donn√©es)
# N > 1 = Compromis (fsync tous les N commits)
sync_binlog = 1

# Coordonner avec InnoDB pour coh√©rence totale
innodb_flush_log_at_trx_commit = 1

# Support des transactions distribu√©es (XA)
innodb_support_xa = ON
```

**Tableau de comparaison durabilit√©/performance** :

| Configuration | S√©curit√© | Performance | Usage |
|---------------|----------|-------------|-------|
| `sync_binlog=1` + `innodb_flush_log_at_trx_commit=1` | ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ | ‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ | Production critique |
| `sync_binlog=10` + `innodb_flush_log_at_trx_commit=2` | ‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ | ‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ | Production standard |
| `sync_binlog=0` + `innodb_flush_log_at_trx_commit=0` | ‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ | ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ | Dev/Test uniquement |

‚ö†Ô∏è **Production** : Ne jamais utiliser `sync_binlog=0` en production. Le gain de performance ne vaut pas le risque de perte de donn√©es en cas de crash.

---

## Cr√©ation de l'Utilisateur de R√©plication

Le Replica doit se connecter au Primary avec un utilisateur d√©di√© poss√©dant le privil√®ge `REPLICATION SLAVE`.

### Cr√©ation s√©curis√©e de l'utilisateur

```sql
-- Cr√©er l'utilisateur de r√©plication avec authentification forte
-- ed25519 est recommand√© pour MariaDB 11.8
CREATE USER 'repl_user'@'%' 
IDENTIFIED VIA ed25519 
USING PASSWORD('SecurePassword123!');

-- Accorder le privil√®ge de r√©plication
GRANT REPLICATION SLAVE ON *.* TO 'repl_user'@'%';

-- Pour monitoring avanc√©, ajouter aussi REPLICATION CLIENT
GRANT REPLICATION CLIENT ON *.* TO 'repl_user'@'%';

-- Appliquer imm√©diatement les changements
FLUSH PRIVILEGES;
```

üí° **S√©curit√© renforc√©e** : Limitez l'acc√®s r√©seau avec une IP sp√©cifique plut√¥t que `%` :

```sql
-- Utilisateur limit√© √† une IP ou un sous-r√©seau
CREATE USER 'repl_user'@'192.168.1.0/255.255.255.0' 
IDENTIFIED VIA ed25519 
USING PASSWORD('SecurePassword123!');
```

üÜï **MariaDB 11.8** : Le plugin **PARSEC** peut √™tre utilis√© pour une authentification bas√©e sur certificats :

```sql
-- Authentification par certificat (PARSEC plugin)
CREATE USER 'repl_user'@'%' 
IDENTIFIED VIA parsec;
```

### V√©rification des privil√®ges

```sql
-- V√©rifier les privil√®ges accord√©s
SHOW GRANTS FOR 'repl_user'@'%';

-- R√©sultat attendu :
-- GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO `repl_user`@`%`
```

---

## Configuration SSL/TLS pour la R√©plication

Pour s√©curiser les donn√©es en transit entre Primary et Replica, configurez SSL/TLS.

### G√©n√©ration des certificats

```bash
# Cr√©er une CA (Certificate Authority)
openssl genrsa 2048 > ca-key.pem
openssl req -new -x509 -nodes -days 3650 \
  -key ca-key.pem -out ca-cert.pem

# Certificat pour le serveur (Primary)
openssl req -newkey rsa:2048 -days 3650 -nodes \
  -keyout server-key.pem -out server-req.pem
openssl rsa -in server-key.pem -out server-key.pem
openssl x509 -req -in server-req.pem -days 3650 \
  -CA ca-cert.pem -CAkey ca-key.pem -set_serial 01 \
  -out server-cert.pem

# Certificat pour le client (Replica)
openssl req -newkey rsa:2048 -days 3650 -nodes \
  -keyout client-key.pem -out client-req.pem
openssl rsa -in client-key.pem -out client-key.pem
openssl x509 -req -in client-req.pem -days 3650 \
  -CA ca-cert.pem -CAkey ca-key.pem -set_serial 02 \
  -out client-cert.pem
```

### Configuration dans `my.cnf`

```ini
[mariadb]
# Chemins vers les certificats SSL
ssl-ca = /etc/mysql/ssl/ca-cert.pem
ssl-cert = /etc/mysql/ssl/server-cert.pem
ssl-key = /etc/mysql/ssl/server-key.pem

# Forcer SSL pour les connexions de r√©plication (optionnel)
require_secure_transport = ON
```

üÜï **MariaDB 11.8** : **TLS est activ√© par d√©faut** sur les nouvelles installations. La configuration SSL est simplifi√©e.

### Forcer SSL pour l'utilisateur de r√©plication

```sql
-- Modifier l'utilisateur pour exiger SSL
ALTER USER 'repl_user'@'%' REQUIRE SSL;

-- Ou plus sp√©cifique : exiger certificat client
ALTER USER 'repl_user'@'%' 
REQUIRE X509;

-- V√©rifier
SHOW CREATE USER 'repl_user'@'%';
```

---

## Snapshot Initial et Position de D√©part

Avant de configurer le Replica, vous devez obtenir un **snapshot coh√©rent** du Primary et conna√Ætre la **position binlog** correspondante.

### M√©thode 1 : Avec verrouillage (FLUSH TABLES WITH READ LOCK)

Pour une base de donn√©es **petite √† moyenne** ou en **maintenance** :

```sql
-- 1. Verrouiller toutes les tables en lecture seule
FLUSH TABLES WITH READ LOCK;

-- 2. Noter la position binlog actuelle
SHOW MASTER STATUS;
-- R√©sultat : File=mariadb-bin.000001, Position=12345

-- 3. Dans une autre session, faire le dump
-- (voir commande mysqldump ci-dessous)

-- 4. D√©verrouiller apr√®s le dump
UNLOCK TABLES;
```

**Dump avec mysqldump** (dans une session parall√®le) :

```bash
# Dump complet avec transactions
mariadb-dump \
  --single-transaction \
  --master-data=2 \
  --routines \
  --triggers \
  --events \
  --all-databases \
  > full_backup.sql
```

üí° **Option `--master-data=2`** : Inclut la position binlog en commentaire dans le dump, tr√®s pratique pour la configuration du Replica.

### M√©thode 2 : Sans verrouillage (InnoDB uniquement)

Pour une base de production **InnoDB** en **activit√©** :

```bash
# Dump coh√©rent sans bloquer les √©critures
mariadb-dump \
  --single-transaction \
  --master-data=2 \
  --routines \
  --triggers \
  --events \
  --all-databases \
  > full_backup.sql

# La position binlog est automatiquement incluse dans le dump
```

‚ö†Ô∏è **Limitation** : `--single-transaction` ne fonctionne **que pour InnoDB**. Pour MyISAM ou tables mixtes, utilisez `FLUSH TABLES WITH READ LOCK`.

### M√©thode 3 : Mariabackup (physique, production) üÜï

Pour une base volumineuse en production :

```bash
# Backup physique complet avec position binlog
mariabackup --backup \
  --target-dir=/backup/full \
  --user=root \
  --password=SecurePass

# La position binlog est dans : /backup/full/xtrabackup_binlog_info
cat /backup/full/xtrabackup_binlog_info
# R√©sultat : mariadb-bin.000001  12345
```

üÜï **MariaDB 11.8** : Mariabackup supporte maintenant **BACKUP STAGE** pour une coh√©rence am√©lior√©e et moins de verrouillage.

---

## Configuration de Haute Disponibilit√©

### GTID (Global Transaction Identifier)

Le **GTID** simplifie la configuration de r√©plication et le failover automatique. Activez-le d√®s le d√©part en production moderne.

```ini
[mariadb]
# Activer GTID
gtid_strict_mode = ON

# Domain ID pour multi-source (d√©faut = 0)
gtid_domain_id = 0

# Positionner automatiquement le replica
gtid_slave_pos = AUTO
```

**V√©rification** :

```sql
-- Afficher le GTID actuel
SELECT @@gtid_binlog_pos;
-- R√©sultat : 0-1-1000

-- Afficher l'√©tat complet
SHOW MASTER STATUS;
```

üí° **Avantage GTID** : Le Replica n'a plus besoin de conna√Ætre la position exacte (file+position), il se synchronise automatiquement sur le GTID.

### Optimistic ALTER TABLE üÜï

Nouveaut√© **MariaDB 11.8** : R√©duction du lag de r√©plication lors des ALTER TABLE.

```ini
[mariadb]
# Activer l'optimistic ALTER pour r√©duire le lag
# Le replica peut continuer √† appliquer des transactions pendant l'ALTER
replication_optimize_for_static_plugin_config = ON
```

**Fonctionnement** :
- Traditionnellement, un `ALTER TABLE` sur le Primary bloque la r√©plication jusqu'√† sa fin
- Avec Optimistic ALTER, les transactions **non li√©es** continuent √† √™tre appliqu√©es
- **R√©duit drastiquement** le `Seconds_Behind_Master` sur de grandes tables

```sql
-- Sur le Primary : ALTER de plusieurs heures
ALTER TABLE huge_table ADD INDEX idx_created_at(created_at);

-- Sur le Replica : sans Optimistic ALTER
-- Seconds_Behind_Master peut atteindre plusieurs heures

-- Avec Optimistic ALTER (11.8) :
-- Seconds_Behind_Master reste minimal pour les autres tables
```

‚ö†Ô∏è **Note** : Cette fonctionnalit√© est automatique en 11.8 avec GTID, aucune configuration manuelle requise dans la plupart des cas.

---

## Monitoring et Diagnostics

### Variables importantes √† surveiller

```sql
-- Nombre de binlogs actuels
SHOW BINARY LOGS;

-- Taille totale des binlogs
SELECT 
  SUM(File_size) / 1024 / 1024 / 1024 AS binlog_size_gb
FROM information_schema.BINARY_LOGS;

-- √âv√©nements r√©cents dans le binlog
SHOW BINLOG EVENTS IN 'mariadb-bin.000001' LIMIT 10;

-- Status global du Primary
SHOW MASTER STATUS;
```

### Logs et debugging

```sql
-- Activer le logging verbeux pour troubleshooting
SET GLOBAL log_warnings = 3;

-- Voir les variables de binlog actives
SHOW VARIABLES LIKE 'binlog%';
SHOW VARIABLES LIKE 'sync_binlog%';
```

### Probl√®mes courants et solutions

| Probl√®me | Sympt√¥me | Solution |
|----------|----------|----------|
| Binlog non activ√© | `log_bin = OFF` | Ajouter `log-bin` dans `my.cnf` et red√©marrer |
| Binlogs remplissent le disque | Espace disque faible | R√©duire `binlog_expire_logs_seconds` ou purger manuellement : `PURGE BINARY LOGS BEFORE NOW() - INTERVAL 3 DAY;` |
| Performance d√©grad√©e | Latence √©lev√©e sur `COMMIT` | Ajuster `sync_binlog` (ex: 10 au lieu de 1) mais **attention s√©curit√©** |
| Replica ne d√©marre pas | Erreur de connexion | V√©rifier firewall, SSL, credentials utilisateur |

üí° **Purge manuelle s√©curis√©e** :

```sql
-- Lister les binlogs
SHOW BINARY LOGS;

-- Purger avant une date sp√©cifique
PURGE BINARY LOGS BEFORE '2025-12-01 00:00:00';

-- Ou purger avant un fichier sp√©cifique
PURGE BINARY LOGS TO 'mariadb-bin.000010';
```

‚ö†Ô∏è **Danger** : Ne **jamais** purger les binlogs si des Replicas sont en retard ! V√©rifiez d'abord tous les Replicas.

---

## Configuration Compl√®te Recommand√©e (Production)

Voici une configuration `my.cnf` compl√®te pour un Primary MariaDB 11.8 en production :

```ini
[mariadb]
# ============================================
# CONFIGURATION PRIMARY - MariaDB 11.8 LTS
# ============================================

# --- Identification ---
server-id = 1  # UNIQUE dans tout le cluster

# --- Binary Log ---
log-bin = /var/log/mariadb/mariadb-bin
log-bin-index = /var/log/mariadb/mariadb-bin.index
binlog-format = ROW
binlog-row-image = MINIMAL
max_binlog_size = 1G
binlog_expire_logs_seconds = 604800  # 7 jours

# --- Durabilit√© ACID ---
sync-binlog = 1
innodb_flush_log_at_trx_commit = 1
innodb_support_xa = ON

# --- GTID (Recommand√©) ---
gtid_strict_mode = ON
gtid_domain_id = 0

# --- S√©curit√© ---
ssl-ca = /etc/mysql/ssl/ca-cert.pem
ssl-cert = /etc/mysql/ssl/server-cert.pem
ssl-key = /etc/mysql/ssl/server-key.pem
require_secure_transport = ON  # TLS obligatoire (11.8 d√©faut)

# --- Performance ---
innodb_buffer_pool_size = 16G  # 70-80% RAM disponible
innodb_log_file_size = 2G
innodb_flush_method = O_DIRECT
innodb_io_capacity = 2000  # SSD moderne
innodb_io_capacity_max = 4000

# --- R√©plication optimis√©e 11.8 ---
replication_optimize_for_static_plugin_config = ON

# --- Monitoring ---
log_warnings = 2
slow_query_log = ON
slow_query_log_file = /var/log/mariadb/slow-query.log
long_query_time = 1

# --- Charset (11.8 d√©faut) ---
character_set_server = utf8mb4
collation_server = utf8mb4_unicode_ci

# --- Timezone ---
log_bin_trust_function_creators = ON  # Si utilisation de fonctions
```

---

## ‚úÖ Points cl√©s √† retenir

- **server-id unique** est obligatoire et doit √™tre diff√©rent pour chaque n≈ìud du cluster
- **Format ROW** est le choix recommand√© pour la production moderne (coh√©rence garantie)
- **sync_binlog=1** + **innodb_flush_log_at_trx_commit=1** assurent une durabilit√© ACID compl√®te
- **GTID** simplifie drastiquement la gestion de la r√©plication et le failover
- **SSL/TLS** doit √™tre activ√© pour s√©curiser les donn√©es en transit (d√©faut en 11.8)
- L'utilisateur de r√©plication n√©cessite uniquement **REPLICATION SLAVE** (+ REPLICATION CLIENT pour monitoring)
- La position binlog ou GTID doit √™tre not√©e lors du snapshot initial
- üÜï **Optimistic ALTER TABLE (11.8)** r√©duit significativement le lag pendant les op√©rations DDL lourdes
- Surveillez l'espace disque des binlogs et configurez `binlog_expire_logs_seconds` appropri√©
- Testez toujours la configuration de r√©plication en **non-production** avant le d√©ploiement

---

## üîó Ressources et r√©f√©rences

- [üìñ MariaDB Binary Log Documentation](https://mariadb.com/kb/en/binary-log/)
- [üìñ Replication Configuration Reference](https://mariadb.com/kb/en/replication-configuration/)
- [üìñ GTID Overview](https://mariadb.com/kb/en/gtid/)
- [üìñ MariaDB 11.8 Release Notes](https://mariadb.com/kb/en/mariadb-1180-release-notes/)
- [üìñ Mariabackup Documentation](https://mariadb.com/kb/en/mariabackup/)
- [üìÑ Blog : Optimistic ALTER TABLE in MariaDB 11.8](https://mariadb.org/optimistic-alter-table/)

---

## ‚û°Ô∏è Section suivante

**13.2.2 Configuration du Replica** : Maintenant que le Primary est configur√©, nous allons configurer le Replica pour √©tablir la r√©plication, g√©rer le rattrapage initial et mettre en place le monitoring.

---


‚è≠Ô∏è [Configuration du Replica](/13-replication/02.2-configuration-replica.md)
