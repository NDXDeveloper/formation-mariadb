üîù Retour au [Sommaire](/SOMMAIRE.md)

# 12.3.1 Full backup avec Mariabackup

> **Niveau** : Avanc√©  
> **Dur√©e estim√©e** : 3 heures  
> **Pr√©requis** : Section 12.1 (Strat√©gies), 12.2 (Sauvegardes logiques), connaissance d'InnoDB

## üéØ Objectifs d'apprentissage

√Ä l'issue de cette section, vous serez capable de :
- Comprendre l'architecture et le fonctionnement de Mariabackup pour les backups physiques
- Effectuer des full backups coh√©rents en production sans interruption de service
- Exploiter le support BACKUP STAGE introduit dans MariaDB 11.8 pour une coh√©rence optimale
- Optimiser les performances de backup selon votre infrastructure (HDD, SSD, r√©seau)
- Valider l'int√©grit√© des backups et pr√©parer la restauration
- Automatiser les full backups avec monitoring et alerting
- Int√©grer Mariabackup dans des architectures cloud-native (S3, Kubernetes)
- Mettre en place une strat√©gie de r√©tention et archivage efficace

---

## Introduction

**Mariabackup** est l'outil de sauvegarde physique officiel de MariaDB, h√©ritier de Percona XtraBackup. Contrairement aux sauvegardes logiques (mysqldump, mydumper) qui exportent les donn√©es sous forme SQL, Mariabackup effectue une **copie directe des fichiers de donn√©es InnoDB** en garantissant la coh√©rence transactionnelle.

### Sauvegarde physique vs logique

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    SAUVEGARDE LOGIQUE                          ‚îÇ
‚îÇ  (mysqldump, mydumper)                                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  MariaDB ‚Üí SQL queries ‚Üí Fichiers .sql ‚Üí Parsing SQL ‚Üí Restore ‚îÇ
‚îÇ                                                                ‚îÇ
‚îÇ  ‚úÖ Portable (cross-version, cross-platform)                   ‚îÇ
‚îÇ  ‚úÖ Restauration s√©lective facile                              ‚îÇ
‚îÇ  ‚ùå Plus lent (parsing SQL)                                    ‚îÇ
‚îÇ  ‚ùå Charge CPU importante                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    SAUVEGARDE PHYSIQUE                         ‚îÇ
‚îÇ  (Mariabackup)                                                 ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Fichiers InnoDB ‚Üí Copie directe ‚Üí Fichiers .ibd ‚Üí Restore     ‚îÇ
‚îÇ                                                                ‚îÇ
‚îÇ  ‚úÖ Ultra-rapide (copie de fichiers)                           ‚îÇ
‚îÇ  ‚úÖ Faible charge CPU                                          ‚îÇ
‚îÇ  ‚úÖ Backup incr√©mental natif                                   ‚îÇ
‚îÇ  ‚ùå Moins portable (m√™me version/config)                       ‚îÇ
‚îÇ  ‚ùå Restauration = tout ou rien                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Quand utiliser Mariabackup ?

‚úÖ **Cas d'usage recommand√©s** :
- Bases de donn√©es > 100 GB (o√π la vitesse prime)
- Strat√©gie de backup incr√©mental (voir section 12.3.2)
- RTO (Recovery Time Objective) < 1 heure
- R√©plication : clonage rapide de replicas
- Architectures haute disponibilit√© avec full backup r√©guliers
- Cloud : snapshot de volumes avant migration

‚ùå **Limitations** :
- Restauration s√©lective difficile (table par table impossible)
- Portabilit√© limit√©e (compatibilit√© versions stricte)
- N√©cessite suffisamment d'espace disque (taille ‚âà base + logs)

---

## Architecture et fonctionnement technique

### Principe du backup √† chaud (hot backup)

```
Phase 1 : COPIE DES FICHIERS INNODB
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Mariabackup d√©marre                             ‚îÇ
‚îÇ  ‚îú‚îÄ Ouvre les fichiers .ibd en lecture           ‚îÇ
‚îÇ  ‚îú‚îÄ Copie page par page                          ‚îÇ
‚îÇ  ‚îî‚îÄ Les √©critures continuent normalement ‚úÖ      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
Phase 2 : COPIE DU REDO LOG
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Pendant la copie des .ibd                       ‚îÇ
‚îÇ  ‚îú‚îÄ Toutes les modifications ‚Üí redo log          ‚îÇ
‚îÇ  ‚îú‚îÄ Mariabackup copie le redo log en continu     ‚îÇ
‚îÇ  ‚îî‚îÄ = Journal de toutes les modifications        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
Phase 3 : FLUSH ET LOCK (TR√àS BREF)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  FLUSH TABLES WITH READ LOCK (< 1 seconde)       ‚îÇ
‚îÇ  ‚îú‚îÄ Copie fichiers non-InnoDB (.frm, .MYD, .MYI) ‚îÇ
‚îÇ  ‚îú‚îÄ Copie m√©tadonn√©es                            ‚îÇ
‚îÇ  ‚îî‚îÄ UNLOCK TABLES                                ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
         ‚ñº
Phase 4 : PR√âPARATION (HORS LIGNE)
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  mariabackup --prepare                           ‚îÇ
‚îÇ  ‚îú‚îÄ Applique le redo log sur les fichiers copi√©s ‚îÇ
‚îÇ  ‚îú‚îÄ Rollback des transactions non commit√©es      ‚îÇ
‚îÇ  ‚îî‚îÄ = Backup coh√©rent et pr√™t √† restaurer        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

üí° **Point cl√©** : Les √©critures ne sont bloqu√©es que quelques millisecondes, le temps de copier les m√©tadonn√©es non-InnoDB.

### üÜï MariaDB 11.8 : Support BACKUP STAGE

MariaDB 11.8 introduit **BACKUP STAGE**, un m√©canisme am√©lior√© pour coordonner les backups :

```sql
-- Nouvelle API BACKUP STAGE (11.8+)
BACKUP STAGE START;
-- Mariabackup peut copier les fichiers en toute s√©curit√©
BACKUP STAGE BLOCK_COMMIT;
-- Bloque les commits (tr√®s bref)
BACKUP STAGE END;
```

**Avantages** :
- ‚úÖ Coordination plus fine entre backup et serveur
- ‚úÖ Impact r√©duit sur les performances (moins de locks globaux)
- ‚úÖ Meilleure coh√©rence avec moteurs non-InnoDB
- ‚úÖ Support natif dans Mariabackup 11.8+

```bash
# Mariabackup 11.8 utilise automatiquement BACKUP STAGE
mariabackup --backup --target-dir=/backups/full
# Utilise en interne BACKUP STAGE au lieu de FTWRL
```

---

## Installation de Mariabackup

### Depuis les d√©p√¥ts MariaDB

```bash
# Ubuntu/Debian
sudo apt update
sudo apt install mariadb-backup

# CentOS/RHEL 8+
sudo dnf install MariaDB-backup

# V√©rification
mariabackup --version
# Output : mariabackup based on MariaDB server 11.8.x
```

### V√©rification de compatibilit√©

```bash
# Version de MariaDB serveur
mariadb --version
# Output : mariadb Ver 15.1 Distrib 11.8.x-MariaDB

# Version de Mariabackup
mariabackup --version
# Output : mariabackup based on MariaDB server 11.8.x

# ‚ö†Ô∏è IMPORTANT : Les versions doivent correspondre !
# Mariabackup 11.8 pour MariaDB 11.8
```

üí° **R√®gle d'or** : Utilisez toujours la version de Mariabackup correspondant exactement √† votre version de MariaDB.

---

## Privil√®ges requis

### Utilisateur d√©di√© pour les backups

```sql
-- Cr√©er un utilisateur backup avec privil√®ges minimaux
CREATE USER 'mariabackup'@'localhost' 
IDENTIFIED BY 'SecureBackupPassword123!';

-- Privil√®ges essentiels
GRANT RELOAD, LOCK TABLES, PROCESS, REPLICATION CLIENT 
ON *.* 
TO 'mariabackup'@'localhost';

-- Pour MariaDB 11.8 avec BACKUP STAGE
GRANT BACKUP_ADMIN 
ON *.* 
TO 'mariabackup'@'localhost';

FLUSH PRIVILEGES;
```

üí° **Nouveaut√© 11.8** : Le privil√®ge `BACKUP_ADMIN` est requis pour utiliser BACKUP STAGE.

### Fichier de configuration s√©curis√©

```bash
# /home/backup/.mybackup.cnf
[mariabackup]
user=mariabackup
password=SecureBackupPassword123!
```

```bash
# S√©curiser le fichier
chmod 600 /home/backup/.mybackup.cnf
chown backup:backup /home/backup/.mybackup.cnf

# Utilisation
mariabackup --defaults-file=/home/backup/.mybackup.cnf \
  --backup --target-dir=/backups/full
```

---

## Full backup : Commandes essentielles

### Syntaxe de base

```bash
mariabackup --backup \
  --target-dir=/path/to/backup \
  --user=mariabackup \
  --password=SecurePassword
```

### Options principales

```bash
mariabackup --backup \
  --target-dir=/backups/full_$(date +%Y%m%d_%H%M%S) \
  --user=mariabackup \
  --password=SecurePassword \
  --compress \                    # Compression qpress
  --compress-threads=4 \           # Parall√©lisme compression
  --parallel=4 \                   # Threads de copie
  --no-timestamp \                 # Pas de sous-dossier timestamp
  --stream=xbstream                # Output en stream (pour pipe)
```

#### D√©tail des options

| Option | Description | Recommandation |
|--------|-------------|----------------|
| `--target-dir` | R√©pertoire de destination | Toujours sp√©cifier |
| `--compress` | Compression qpress | ‚úÖ Production |
| `--compress-threads` | Threads compression | = nb cores / 2 |
| `--parallel` | Threads copie fichiers | = nb cores / 2 |
| `--no-timestamp` | Pas de sous-dossier auto | ‚úÖ Pour scripts |
| `--stream` | Format stream | Pour pipe vers S3/tape |

---

### Exemple 1 : Full backup simple (local)

```bash
#!/bin/bash
# Full backup vers disque local

BACKUP_DIR="/backups/mariadb/full_$(date +%Y%m%d_%H%M%S)"

mariabackup --backup \
  --target-dir="$BACKUP_DIR" \
  --user=mariabackup \
  --password=SecurePassword \
  --parallel=4

if [ $? -eq 0 ]; then
    echo "‚úÖ Backup completed: $BACKUP_DIR"
else
    echo "‚ùå Backup FAILED"
    exit 1
fi
```

**R√©sultat** :

```
/backups/mariadb/full_20251213_143000/
‚îú‚îÄ‚îÄ backup-my.cnf          # Configuration backup
‚îú‚îÄ‚îÄ ibdata1                # InnoDB system tablespace
‚îú‚îÄ‚îÄ ib_logfile0           # InnoDB redo log
‚îú‚îÄ‚îÄ mysql/                 # Base syst√®me
‚îÇ   ‚îú‚îÄ‚îÄ user.ibd
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ production_db/         # Votre base
‚îÇ   ‚îú‚îÄ‚îÄ users.ibd
‚îÇ   ‚îú‚îÄ‚îÄ orders.ibd
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ xtrabackup_checkpoints # M√©tadonn√©es backup
```

---

### Exemple 2 : Full backup avec compression

```bash
#!/bin/bash
# Full backup compress√© (qpress)

BACKUP_DIR="/backups/mariadb/full_compressed_$(date +%Y%m%d)"

mariabackup --backup \
  --target-dir="$BACKUP_DIR" \
  --user=mariabackup \
  --password=SecurePassword \
  --compress \
  --compress-threads=8 \
  --parallel=8

if [ $? -eq 0 ]; then
    echo "‚úÖ Compressed backup completed"
    
    # Statistiques
    ORIGINAL_SIZE=$(du -sh /var/lib/mysql | cut -f1)
    BACKUP_SIZE=$(du -sh "$BACKUP_DIR" | cut -f1)
    echo "üìä Original: $ORIGINAL_SIZE ‚Üí Compressed: $BACKUP_SIZE"
else
    echo "‚ùå Backup FAILED"
    exit 1
fi
```

**Fichiers compress√©s** :

```
/backups/mariadb/full_compressed_20251213/
‚îú‚îÄ‚îÄ production_db/
‚îÇ   ‚îú‚îÄ‚îÄ users.ibd.qp      # Fichier compress√©
‚îÇ   ‚îú‚îÄ‚îÄ orders.ibd.qp
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ xtrabackup_checkpoints
```

üí° **Ratio de compression** : G√©n√©ralement 5:1 √† 10:1 (100 GB ‚Üí 10-20 GB).

‚ö†Ô∏è **D√©compression requise** avant `--prepare` :

```bash
# D√©compresser tous les fichiers .qp
for file in $(find /backups/full_compressed_20251213 -name "*.qp"); do
    qpress -d "$file" $(dirname "$file")
    rm -f "$file"  # Supprimer le .qp apr√®s d√©compression
done
```

---

### Exemple 3 : Full backup en streaming vers S3

```bash
#!/bin/bash
# Full backup direct vers S3 (sans passer par disque local)

S3_BUCKET="s3://my-backups/mariadb"
DATE=$(date +%Y%m%d_%H%M%S)

mariabackup --backup \
  --stream=xbstream \
  --compress \
  --compress-threads=8 \
  --parallel=8 | \
  aws s3 cp - "$S3_BUCKET/full_$DATE.xbstream"

if [ ${PIPESTATUS[0]} -eq 0 ]; then
    echo "‚úÖ Backup streamed to S3: $S3_BUCKET/full_$DATE.xbstream"
else
    echo "‚ùå Backup FAILED"
    exit 1
fi
```

üí° **Avantage streaming** : Pas besoin d'espace disque local temporaire.

---

### Exemple 4 : Full backup avec encryption

```bash
#!/bin/bash
# Full backup chiffr√© (OpenSSL)

BACKUP_DIR="/backups/mariadb/full_$(date +%Y%m%d)"
ENCRYPTION_KEY="MySecretKey123!"

mariabackup --backup \
  --stream=xbstream \
  --compress | \
  openssl enc -aes-256-cbc -salt -k "$ENCRYPTION_KEY" \
  > "$BACKUP_DIR/backup_encrypted.xbstream.enc"

if [ ${PIPESTATUS[0]} -eq 0 ]; then
    echo "‚úÖ Encrypted backup created"
    echo "‚ö†Ô∏è  IMPORTANT: Store encryption key securely!"
else
    echo "‚ùå Backup FAILED"
    exit 1
fi
```

**Restauration** n√©cessitera :

```bash
# D√©chiffrement
openssl enc -d -aes-256-cbc -k "$ENCRYPTION_KEY" \
  -in backup_encrypted.xbstream.enc | \
  xbstream -x -C /restore/directory
```

---

## Fichier xtrabackup_checkpoints

Apr√®s chaque backup, Mariabackup g√©n√®re un fichier `xtrabackup_checkpoints` contenant les m√©tadonn√©es cruciales :

```ini
backup_type = full-backuped
from_lsn = 0
to_lsn = 123456789012
last_lsn = 123456789012
flushed_lsn = 123456789012
compact = 0
recover_binlog_info = 0
```

### Explication des LSN (Log Sequence Number)

- **from_lsn** : Point de d√©part (0 pour full backup)
- **to_lsn** : Point d'arriv√©e (dernier LSN copi√©)
- **last_lsn** : Dernier LSN du redo log
- **flushed_lsn** : LSN des donn√©es flush√©es sur disque

üí° **Crucial pour les backups incr√©mentaux** : Le `to_lsn` du full devient le `from_lsn` de l'incr√©mental.

---

## Pr√©paration du backup

‚ö†Ô∏è **√âTAPE CRITIQUE** : Un backup Mariabackup n'est **pas directement utilisable**. Il faut le **pr√©parer** avec `--prepare`.

### Pourquoi pr√©parer ?

```
√âtat apr√®s --backup :
‚îú‚îÄ‚îÄ Fichiers .ibd (donn√©es copi√©es)
‚îú‚îÄ‚îÄ ib_logfile (transactions en cours pendant backup)
‚îî‚îÄ‚îÄ √âtat INCOH√âRENT (transactions non termin√©es)

√âtat apr√®s --prepare :
‚îú‚îÄ‚îÄ Applique les transactions committ√©es (redo)
‚îú‚îÄ‚îÄ Rollback des transactions non committ√©es (undo)
‚îî‚îÄ‚îÄ √âtat COH√âRENT (pr√™t √† restaurer)
```

### Commande --prepare

```bash
# Pr√©parer un backup non compress√©
mariabackup --prepare \
  --target-dir=/backups/full_20251213_143000

# Pr√©parer un backup compress√© (apr√®s d√©compression)
# 1. D√©compresser
qpress -d /backups/full_compressed_20251213/*.qp

# 2. Pr√©parer
mariabackup --prepare \
  --target-dir=/backups/full_compressed_20251213
```

**Output typique** :

```
InnoDB: Starting shutdown...
InnoDB: Shutdown completed; log sequence number 123456789012
InnoDB: Number of pools: 1
completed OK!
```

üí° **"completed OK!"** = Backup coh√©rent et pr√™t √† restaurer.

---

## Validation et v√©rification du backup

### 1. V√©rifier la pr√©sence des fichiers critiques

```bash
#!/bin/bash
# Script de validation

BACKUP_DIR="/backups/full_20251213_143000"

# Fichiers essentiels
REQUIRED_FILES=(
    "xtrabackup_checkpoints"
    "backup-my.cnf"
    "ibdata1"
)

echo "üîç Validating backup: $BACKUP_DIR"

for file in "${REQUIRED_FILES[@]}"; do
    if [ ! -f "$BACKUP_DIR/$file" ]; then
        echo "‚ùå Missing critical file: $file"
        exit 1
    fi
done

echo "‚úÖ All critical files present"
```

---

### 2. V√©rifier les LSN

```bash
# Extraire et v√©rifier les LSN
cat "$BACKUP_DIR/xtrabackup_checkpoints"

# V√©rifier coh√©rence
FROM_LSN=$(grep "from_lsn" "$BACKUP_DIR/xtrabackup_checkpoints" | cut -d= -f2 | tr -d ' ')
TO_LSN=$(grep "to_lsn" "$BACKUP_DIR/xtrabackup_checkpoints" | cut -d= -f2 | tr -d ' ')

if [ "$TO_LSN" -gt "$FROM_LSN" ]; then
    echo "‚úÖ LSN sequence valid (from: $FROM_LSN, to: $TO_LSN)"
else
    echo "‚ùå Invalid LSN sequence"
    exit 1
fi
```

---

### 3. V√©rifier l'√©tat de pr√©paration

```bash
# V√©rifier si le backup a √©t√© pr√©par√©
if grep -q "backup_type = prepared" "$BACKUP_DIR/xtrabackup_checkpoints"; then
    echo "‚úÖ Backup is prepared and ready for restore"
else
    echo "‚ö†Ô∏è  Backup NOT prepared yet (run --prepare first)"
fi
```

---

### 4. Test de restauration sur environnement temporaire

```bash
#!/bin/bash
# Test de restauration (OPTIONNEL mais recommand√©)

TEST_DATADIR="/tmp/mariadb_restore_test_$(date +%s)"
BACKUP_DIR="/backups/full_20251213_143000"

echo "üß™ Testing restore to: $TEST_DATADIR"

# 1. Pr√©parer le r√©pertoire
mkdir -p "$TEST_DATADIR"
chown mysql:mysql "$TEST_DATADIR"

# 2. Copier le backup
mariabackup --copy-back \
  --target-dir="$BACKUP_DIR" \
  --datadir="$TEST_DATADIR"

if [ $? -eq 0 ]; then
    echo "‚úÖ Test restore successful"
    
    # 3. Tenter de d√©marrer MariaDB sur ce datadir (optionnel)
    # mysqld --datadir="$TEST_DATADIR" --skip-networking &
    # PID=$!
    # sleep 5
    # kill $PID
    
    # 4. Nettoyage
    rm -rf "$TEST_DATADIR"
else
    echo "‚ùå Test restore FAILED"
    exit 1
fi
```

---

## Script de production complet

```bash
#!/bin/bash
# /opt/scripts/mariabackup_full_backup.sh
# Production-ready full backup script

set -euo pipefail

#‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# Configuration
#‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

BACKUP_ROOT="/backups/mariadb"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="$BACKUP_ROOT/full_$DATE"
LOG_FILE="$BACKUP_ROOT/logs/full_backup_$DATE.log"
RETENTION_DAYS=7
PARALLEL_THREADS=8

# S3 (optionnel)
S3_ENABLED=true
S3_BUCKET="s3://my-backups/mariadb"

# Notifications (optionnel)
SLACK_WEBHOOK="https://hooks.slack.com/services/YOUR/WEBHOOK/URL"

#‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# Fonctions
#‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

log() {
    echo "[$(date -Iseconds)] $1" | tee -a "$LOG_FILE"
}

notify_slack() {
    local message=$1
    local color=$2
    
    curl -X POST -H 'Content-type: application/json' \
      --data "{\"text\":\"$message\",\"color\":\"$color\"}" \
      "$SLACK_WEBHOOK" 2>/dev/null || true
}

check_disk_space() {
    local required_gb=$1
    local available_gb=$(df -BG "$BACKUP_ROOT" | tail -1 | awk '{print $4}' | sed 's/G//')
    
    if [ "$available_gb" -lt "$required_gb" ]; then
        log "‚ùå Insufficient disk space: ${available_gb}GB < ${required_gb}GB"
        return 1
    fi
    
    log "‚úÖ Disk space check: ${available_gb}GB available"
    return 0
}

#‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# Main
#‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

log "========================================"
log "Starting MariaDB Full Backup"
log "========================================"

# 1. Cr√©er les r√©pertoires
mkdir -p "$BACKUP_ROOT/logs"
mkdir -p "$BACKUP_DIR"

# 2. V√©rifier l'espace disque (estimer 50% de la taille de la base)
DB_SIZE_GB=$(du -BG /var/lib/mysql | tail -1 | cut -f1 | sed 's/G//')
REQUIRED_SPACE=$((DB_SIZE_GB / 2 + 10))

if ! check_disk_space "$REQUIRED_SPACE"; then
    notify_slack "‚ùå MariaDB backup failed: insufficient disk space" "danger"
    exit 1
fi

# 3. Effectuer le backup
log "üì¶ Starting backup to: $BACKUP_DIR"
START_TIME=$(date +%s)

mariabackup --backup \
  --target-dir="$BACKUP_DIR" \
  --user=mariabackup \
  --password=SecurePassword \
  --compress \
  --compress-threads="$PARALLEL_THREADS" \
  --parallel="$PARALLEL_THREADS" \
  2>&1 | tee -a "$LOG_FILE"

BACKUP_STATUS=${PIPESTATUS[0]}
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

if [ $BACKUP_STATUS -ne 0 ]; then
    log "‚ùå Backup FAILED (exit code: $BACKUP_STATUS)"
    notify_slack "‚ùå MariaDB backup FAILED on $(hostname)" "danger"
    exit 1
fi

log "‚úÖ Backup completed in ${DURATION}s"

# 4. Statistiques
BACKUP_SIZE=$(du -sh "$BACKUP_DIR" | cut -f1)
FILE_COUNT=$(find "$BACKUP_DIR" -type f | wc -l)

log "üìä Backup statistics:"
log "  - Duration: ${DURATION}s"
log "  - Size: $BACKUP_SIZE"
log "  - Files: $FILE_COUNT"
log "  - Location: $BACKUP_DIR"

# 5. Validation
log "üîç Validating backup..."

# V√©rifier fichiers critiques
if [ ! -f "$BACKUP_DIR/xtrabackup_checkpoints" ]; then
    log "‚ùå Validation failed: missing xtrabackup_checkpoints"
    exit 1
fi

# V√©rifier LSN
FROM_LSN=$(grep "from_lsn" "$BACKUP_DIR/xtrabackup_checkpoints" | cut -d= -f2 | tr -d ' ')
TO_LSN=$(grep "to_lsn" "$BACKUP_DIR/xtrabackup_checkpoints" | cut -d= -f2 | tr -d ' ')

log "  - LSN range: $FROM_LSN ‚Üí $TO_LSN"

if [ "$TO_LSN" -le "$FROM_LSN" ]; then
    log "‚ùå Invalid LSN sequence"
    exit 1
fi

log "‚úÖ Backup validation passed"

# 6. Upload vers S3 (optionnel)
if [ "$S3_ENABLED" = true ]; then
    log "‚òÅÔ∏è  Uploading to S3..."
    
    aws s3 sync "$BACKUP_DIR" "$S3_BUCKET/full_$DATE/" \
      --storage-class STANDARD_IA 2>&1 | tee -a "$LOG_FILE"
    
    if [ ${PIPESTATUS[0]} -eq 0 ]; then
        log "‚úÖ S3 upload completed"
    else
        log "‚ö†Ô∏è  S3 upload failed (backup still available locally)"
    fi
fi

# 7. Cr√©er lien symbolique 'latest'
rm -f "$BACKUP_ROOT/latest"
ln -s "$BACKUP_DIR" "$BACKUP_ROOT/latest"

# 8. Nettoyage des anciens backups
log "üßπ Cleaning old backups (retention: $RETENTION_DAYS days)..."

find "$BACKUP_ROOT" -maxdepth 1 -type d -name "full_*" -mtime +$RETENTION_DAYS \
  -exec rm -rf {} \;

find "$BACKUP_ROOT/logs" -name "*.log" -mtime +$RETENTION_DAYS -delete

log "‚úÖ Cleanup completed"

# 9. Notification Slack
notify_slack "‚úÖ MariaDB full backup completed on $(hostname)
- Duration: ${DURATION}s
- Size: $BACKUP_SIZE
- LSN: $FROM_LSN ‚Üí $TO_LSN" "good"

log "========================================"
log "Backup process completed successfully"
log "========================================"

# 10. Envoyer m√©triques √† Prometheus (optionnel)
if [ -n "${PROMETHEUS_PUSHGATEWAY:-}" ]; then
    cat <<EOF | curl --data-binary @- "$PROMETHEUS_PUSHGATEWAY/metrics/job/mariabackup/instance/$(hostname)" 2>/dev/null || true
# HELP mariabackup_full_backup_duration_seconds Duration of full backup
# TYPE mariabackup_full_backup_duration_seconds gauge
mariabackup_full_backup_duration_seconds $DURATION

# HELP mariabackup_full_backup_size_bytes Size of full backup
# TYPE mariabackup_full_backup_size_bytes gauge
mariabackup_full_backup_size_bytes $(du -sb "$BACKUP_DIR" | cut -f1)

# HELP mariabackup_full_backup_success Success status (1=success, 0=failure)
# TYPE mariabackup_full_backup_success gauge
mariabackup_full_backup_success 1

# HELP mariabackup_full_backup_timestamp_seconds Timestamp of last full backup
# TYPE mariabackup_full_backup_timestamp_seconds gauge
mariabackup_full_backup_timestamp_seconds $END_TIME
EOF
fi

exit 0
```

---

## Performances et optimisation

### Facteurs influen√ßant la vitesse

| Facteur | Impact | Optimisation |
|---------|--------|--------------|
| **Type de disque** | +++++ | SSD > HDD |
| **Parall√©lisme** | ++++ | --parallel=8-16 |
| **Compression** | +++ | --compress-threads=8 |
| **R√©seau (NFS/SAN)** | ++++ | Backup local puis sync |
| **I/O disponible** | +++ | innodb_io_capacity |
| **Charge serveur** | ++ | Planifier off-peak |

### Benchmark : Full backup 500 GB

| Configuration | Disque | Threads | Compression | Dur√©e | Taille finale |
|---------------|--------|---------|-------------|-------|---------------|
| Basique | HDD 7200rpm | 1 | Non | 85 min | 500 GB |
| Optimis√© HDD | HDD 7200rpm | 4 | qpress | 45 min | 60 GB |
| SSD SATA | SSD SATA | 8 | qpress | 18 min | 60 GB |
| NVMe | NVMe | 16 | qpress | 8 min | 60 GB |
| Streaming S3 | NVMe | 16 | qpress | 12 min | 60 GB* |

*Temps incluant upload r√©seau (1 Gbps)

### Optimisation syst√®me

```bash
# /etc/my.cnf.d/backup_optimization.cnf

[mysqld]
# Augmenter I/O capacity pendant backup (si SSD)
innodb_io_capacity = 2000
innodb_io_capacity_max = 4000

# Flush method optimis√©
innodb_flush_method = O_DIRECT

# Buffer pool (plus = meilleur mais plus RAM)
innodb_buffer_pool_size = 16G
```

```bash
# Pendant le backup, monitorer l'I/O
iostat -x 5

# Disque surcharg√© ? R√©duire --parallel
# CPU surcharg√© ? R√©duire --compress-threads
```

---

## Automatisation avec systemd

### Service systemd

```ini
# /etc/systemd/system/mariabackup-full.service

[Unit]
Description=MariaDB Full Backup with Mariabackup
After=mariadb.service
Requires=mariadb.service

[Service]
Type=oneshot
User=backup
Group=backup
ExecStart=/opt/scripts/mariabackup_full_backup.sh
StandardOutput=journal
StandardError=journal
TimeoutStartSec=0

# Limiter l'impact I/O
IOSchedulingClass=idle
IOSchedulingPriority=7

[Install]
WantedBy=multi-user.target
```

### Timer systemd

```ini
# /etc/systemd/system/mariabackup-full.timer

[Unit]
Description=MariaDB Full Backup Timer (Weekly)
Requires=mariabackup-full.service

[Timer]
# Tous les dimanches √† 2h du matin
OnCalendar=Sun *-*-* 02:00:00
Persistent=true

[Install]
WantedBy=timers.target
```

### Activation

```bash
# Recharger systemd
sudo systemctl daemon-reload

# Activer le timer
sudo systemctl enable mariabackup-full.timer
sudo systemctl start mariabackup-full.timer

# V√©rifier
sudo systemctl list-timers mariabackup-full.timer
# Output :
# NEXT                         LEFT          LAST  PASSED
# Sun 2025-12-14 02:00:00 CET  11h left      n/a   n/a

# Tester manuellement
sudo systemctl start mariabackup-full.service

# V√©rifier les logs
sudo journalctl -u mariabackup-full.service -f
```

---

## Int√©gration cloud-native

### 1. Kubernetes : Backup vers PVC

```yaml
# mariadb-backup-cronjob.yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: mariadb-full-backup
  namespace: databases
spec:
  schedule: "0 2 * * 0"  # Dimanches √† 2h
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
          - name: mariabackup
            image: mariadb:11.8
            command:
            - /bin/bash
            - -c
            - |
              set -e
              BACKUP_DIR="/backups/full_$(date +%Y%m%d_%H%M%S)"
              mkdir -p "$BACKUP_DIR"
              
              mariabackup --backup \
                --target-dir="$BACKUP_DIR" \
                --host=mariadb-service \
                --user=mariabackup \
                --password=$MARIABACKUP_PASSWORD \
                --compress \
                --compress-threads=8 \
                --parallel=8
              
              if [ $? -eq 0 ]; then
                echo "‚úÖ Backup completed: $BACKUP_DIR"
              else
                echo "‚ùå Backup FAILED"
                exit 1
              fi
            env:
            - name: MARIABACKUP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mariadb-backup-secret
                  key: password
            volumeMounts:
            - name: backup-storage
              mountPath: /backups
          volumes:
          - name: backup-storage
            persistentVolumeClaim:
              claimName: mariadb-backup-pvc
```

```yaml
# mariadb-backup-pvc.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mariadb-backup-pvc
  namespace: databases
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 200Gi  # Ajuster selon taille base
  storageClassName: fast-ssd
```

```bash
# D√©ployer
kubectl apply -f mariadb-backup-pvc.yaml
kubectl apply -f mariadb-backup-cronjob.yaml

# V√©rifier
kubectl get cronjobs -n databases
kubectl get pvc -n databases

# Tester manuellement
kubectl create job --from=cronjob/mariadb-full-backup test-backup -n databases

# Suivre les logs
kubectl logs -f job/test-backup -n databases
```

---

### 2. Kubernetes : VolumeSnapshot (CSI)

```yaml
# volumesnapshot-class.yaml
apiVersion: snapshot.storage.k8s.io/v1
kind: VolumeSnapshotClass
metadata:
  name: mariadb-snapshot-class
driver: ebs.csi.aws.com  # ou autre CSI driver
deletionPolicy: Retain
```

```yaml
# mariadb-snapshot-cronjob.yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: mariadb-snapshot
  namespace: databases
spec:
  schedule: "0 2 * * 0"
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: snapshot-controller
          restartPolicy: OnFailure
          containers:
          - name: create-snapshot
            image: bitnami/kubectl:latest
            command:
            - /bin/bash
            - -c
            - |
              set -e
              
              # 1. Flush tables (optionnel mais recommand√©)
              kubectl exec -n databases mariadb-0 -- \
                mariadb -e "FLUSH TABLES WITH READ LOCK; SELECT SLEEP(2); UNLOCK TABLES;"
              
              # 2. Cr√©er snapshot
              cat <<EOF | kubectl apply -f -
              apiVersion: snapshot.storage.k8s.io/v1
              kind: VolumeSnapshot
              metadata:
                name: mariadb-snapshot-$(date +%Y%m%d-%H%M%S)
                namespace: databases
              spec:
                volumeSnapshotClassName: mariadb-snapshot-class
                source:
                  persistentVolumeClaimName: mariadb-data-pvc
              EOF
              
              echo "‚úÖ Snapshot created"
```

üí° **Avantage VolumeSnapshot** : Backup quasi-instantan√© au niveau stockage (secondes au lieu de minutes/heures).

---

### 3. AWS : Backup direct vers S3

```bash
#!/bin/bash
# Streaming backup vers S3 avec Mariabackup

S3_BUCKET="s3://my-mariadb-backups"
DATE=$(date +%Y%m%d_%H%M%S)
AWS_REGION="eu-west-1"

# Backup en streaming vers S3
mariabackup --backup \
  --stream=xbstream \
  --compress \
  --compress-threads=8 \
  --parallel=8 | \
  aws s3 cp - "$S3_BUCKET/full_$DATE.xbstream" \
    --storage-class STANDARD_IA \
    --region "$AWS_REGION"

if [ ${PIPESTATUS[0]} -eq 0 ]; then
    echo "‚úÖ Backup streamed to S3"
    
    # Stocker metadata s√©par√©ment
    mariabackup --backup \
      --target-dir=/tmp/metadata_only \
      --no-lock
    
    aws s3 cp /tmp/metadata_only/xtrabackup_checkpoints \
      "$S3_BUCKET/metadata_$DATE.txt"
    
    rm -rf /tmp/metadata_only
else
    echo "‚ùå Backup failed"
    exit 1
fi
```

---

### 4. Restauration depuis S3

```bash
#!/bin/bash
# Restauration d'un backup S3

S3_BACKUP="s3://my-mariadb-backups/full_20251213_020000.xbstream"
RESTORE_DIR="/var/lib/mysql_restore"

# 1. T√©l√©charger et extraire
aws s3 cp "$S3_BACKUP" - | \
  xbstream -x -C "$RESTORE_DIR"

# 2. D√©compresser
qpress -d "$RESTORE_DIR"/*.qp

# 3. Pr√©parer
mariabackup --prepare --target-dir="$RESTORE_DIR"

# 4. Restaurer (voir section 12.5)
systemctl stop mariadb
rm -rf /var/lib/mysql/*
mariabackup --copy-back --target-dir="$RESTORE_DIR"
chown -R mysql:mysql /var/lib/mysql
systemctl start mariadb
```

---

## Pi√®ges et limitations

### Pi√®ge 1 : Oublier de pr√©parer le backup

```bash
# ‚ùå Restaurer directement sans --prepare
mariabackup --copy-back --target-dir=/backups/full_20251213

# R√©sultat : MariaDB ne d√©marre pas (donn√©es incoh√©rentes)

# ‚úÖ Toujours pr√©parer d'abord
mariabackup --prepare --target-dir=/backups/full_20251213
mariabackup --copy-back --target-dir=/backups/full_20251213
```

---

### Pi√®ge 2 : Incompatibilit√© de versions

```bash
# ‚ùå Mariabackup 10.11 pour backup MariaDB 11.8
# R√©sultat : Erreur ou corruption

# ‚úÖ Versions identiques
mariabackup --version  # 11.8.x
mariadb --version      # 11.8.x
```

---

### Pi√®ge 3 : Espace disque insuffisant

```bash
# Estimer espace requis :
# - Backup non compress√© : 100% taille base
# - Backup compress√© (qpress) : 15-20% taille base
# - Redo logs : +10-20 GB

# V√©rifier avant backup
df -h /backups
du -sh /var/lib/mysql
```

---

### Pi√®ge 4 : InnoDB file-per-table d√©sactiv√©

```sql
-- V√©rifier
SHOW VARIABLES LIKE 'innodb_file_per_table';
-- Si OFF, backup fonctionne mais moins optimal

-- Activer (recommand√©)
SET GLOBAL innodb_file_per_table = ON;

-- Dans my.cnf
[mysqld]
innodb_file_per_table = 1
```

---

### Pi√®ge 5 : Backup pendant ALTER TABLE

```bash
# ‚ö†Ô∏è Un ALTER TABLE long pendant backup peut causer :
# - Lock prolong√©
# - Backup incomplet

# Solution : Planifier backups hors fen√™tres de maintenance
# Ou utiliser BACKUP STAGE (11.8) qui g√®re mieux ce cas
```

---

## ‚úÖ Points cl√©s √† retenir

- **Mariabackup** effectue des backups **physiques** (copie fichiers .ibd) ultra-rapides (1-3 GB/s)
- **Hot backup** : Aucune interruption de service, √©critures bloqu√©es < 1 seconde
- **üÜï BACKUP STAGE** (MariaDB 11.8) : Coordination optimis√©e, moins de locks globaux
- **Toujours pr√©parer** : `--prepare` est obligatoire avant restauration (applique redo, rollback undo)
- **Compression qpress** : Ratio 5:1 √† 10:1, option `--compress` + `--compress-threads`
- **Parall√©lisme** : `--parallel` selon disque (HDD: 2-4, SSD: 4-8, NVMe: 8-16)
- **Streaming** : `--stream=xbstream` pour backup direct vers S3/tape sans disque local
- **LSN critiques** : V√©rifier `xtrabackup_checkpoints` (from_lsn ‚Üí to_lsn)
- **Cas d'usage id√©al** : Bases > 100 GB, besoin de vitesse, strat√©gie incr√©mentale
- **Cloud-native** : Compatible S3, Kubernetes VolumeSnapshot, streaming direct

---

## üîó Ressources et r√©f√©rences

- üìñ [Mariabackup Documentation officielle](https://mariadb.com/kb/en/mariabackup/)
- üìñ [Mariabackup Overview](https://mariadb.com/kb/en/mariabackup-overview/)
- üìñ [Full Backup and Restore with Mariabackup](https://mariadb.com/kb/en/full-backup-and-restore-with-mariabackup/)
- üÜï [BACKUP STAGE (MariaDB 11.8)](https://mariadb.com/kb/en/backup-stage/)
- üìä [Mariabackup vs mysqldump Benchmark](https://mariadb.com/resources/blog/mariadb-backup-best-practices/)
- üõ†Ô∏è [Percona XtraBackup (anc√™tre)](https://docs.percona.com/percona-xtrabackup/)

---

## ‚û°Ô∏è Section suivante

**12.3.2 Incremental backup** : Sauvegardes incr√©mentales pour optimiser espace et temps, bas√©es sur les LSN, avec cha√Ænage et strat√©gies de consolidation.

‚è≠Ô∏è [Incremental backup](/12-sauvegarde-restauration/03.2-incremental-backup.md)
