üîù Retour au [Sommaire](/SOMMAIRE.md)

# 12.3.3 Support BACKUP STAGE üÜï

> **Niveau** : Avanc√©  
> **Dur√©e estim√©e** : 2.5 heures  
> **Pr√©requis** : Sections 12.3.1 et 12.3.2, compr√©hension de FTWRL et des moteurs de stockage

## üéØ Objectifs d'apprentissage

√Ä l'issue de cette section, vous serez capable de :
- Comprendre l'architecture et le fonctionnement de BACKUP STAGE introduit dans MariaDB 11.8
- Identifier les limitations de FLUSH TABLES WITH READ LOCK et comment BACKUP STAGE les r√©sout
- Configurer les privil√®ges requis (BACKUP_ADMIN) pour utiliser BACKUP STAGE
- Exploiter automatiquement BACKUP STAGE via Mariabackup 11.8+
- Mesurer l'impact r√©duit sur la production compar√© √† l'approche traditionnelle
- Comprendre les b√©n√©fices de coh√©rence multi-moteurs (InnoDB + MyISAM)
- Monitorer et diagnostiquer les op√©rations BACKUP STAGE
- Int√©grer BACKUP STAGE dans vos strat√©gies de continuit√© d'activit√©

---

## Introduction

üÜï **BACKUP STAGE** est une nouvelle API introduite dans **MariaDB 11.8 LTS** pour am√©liorer la coordination entre les outils de backup et le serveur MariaDB. Cette fonctionnalit√© remplace progressivement l'utilisation de `FLUSH TABLES WITH READ LOCK` (FTWRL) pour obtenir des backups coh√©rents, en offrant une **granularit√© plus fine** et un **impact r√©duit** sur les performances en production.

### Le probl√®me avec FTWRL (approche traditionnelle)

Avant MariaDB 11.8, Mariabackup (et XtraBackup) utilisait `FLUSH TABLES WITH READ LOCK` pour garantir la coh√©rence des fichiers non-InnoDB :

```sql
-- Approche traditionnelle (MariaDB < 11.8)
FLUSH TABLES WITH READ LOCK;
-- Bloque TOUTES les √©critures sur TOUS les moteurs
-- Copie des .frm, MyISAM, Aria, m√©tadonn√©es
UNLOCK TABLES;
```

**Limitations de FTWRL** :
- ‚ùå **Bloque toutes les √©critures** (InnoDB inclus, m√™me si pas n√©cessaire)
- ‚ùå **Granularit√© grossi√®re** (tout ou rien)
- ‚ùå **Peut bloquer longtemps** si des requ√™tes longues sont en cours
- ‚ùå **Pas de visibilit√©** sur l'√©tat du lock
- ‚ùå **Incompatible** avec certaines architectures HA (Galera peut se bloquer)

### La solution BACKUP STAGE

```sql
-- Nouvelle approche (MariaDB 11.8+)
BACKUP STAGE START;
-- Pr√©pare les moteurs pour backup (l√©ger)

BACKUP STAGE FLUSH;
-- Flush les buffers, pr√©pare snapshot

BACKUP STAGE BLOCK_DDL;
-- Bloque uniquement les DDL (ALTER, DROP, CREATE)

BACKUP STAGE BLOCK_COMMIT;
-- Bloque bri√®vement les commits (< 1 seconde)

BACKUP STAGE END;
-- Lib√®re tous les locks
```

**Avantages BACKUP STAGE** :
- ‚úÖ **Locks granulaires** (√©tapes s√©par√©es)
- ‚úÖ **Impact minimal** sur la production (√©critures continuent la plupart du temps)
- ‚úÖ **Meilleure coh√©rence** multi-moteurs
- ‚úÖ **Monitoring** via INFORMATION_SCHEMA
- ‚úÖ **Compatibilit√© Galera** am√©lior√©e
- ‚úÖ **Coordination optimale** backup/serveur

---

## Architecture et √©tapes de BACKUP STAGE

### Vue d'ensemble des 5 √©tapes

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  √âTAPE 1 : BACKUP STAGE START                                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Initialise la proc√©dure de backup                              ‚îÇ
‚îÇ  ‚îú‚îÄ Enregistre la session comme "backup session"                ‚îÇ
‚îÇ  ‚îú‚îÄ Pr√©pare les moteurs de stockage                             ‚îÇ
‚îÇ  ‚îî‚îÄ Impact : Aucun (0 ms)                                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  √âTAPE 2 : BACKUP STAGE FLUSH                                   ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Flush les buffers vers disque                                  ‚îÇ
‚îÇ  ‚îú‚îÄ InnoDB : Flush dirty pages (partiel)                        ‚îÇ
‚îÇ  ‚îú‚îÄ MyISAM/Aria : Flush key buffers                             ‚îÇ
‚îÇ  ‚îú‚îÄ Table cache : Flush                                         ‚îÇ
‚îÇ  ‚îî‚îÄ Impact : Faible (~10-50 ms)                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  √âTAPE 3 : BACKUP STAGE BLOCK_DDL                               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Bloque les op√©rations DDL uniquement                           ‚îÇ
‚îÇ  ‚îú‚îÄ ALTER TABLE, DROP TABLE, CREATE TABLE : BLOQU√âS             ‚îÇ
‚îÇ  ‚îú‚îÄ INSERT, UPDATE, DELETE, SELECT : CONTINUENT ‚úÖ              ‚îÇ
‚îÇ  ‚îî‚îÄ Impact : Nul sur DML (0 ms pour les √©critures)              ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚è±Ô∏è Dur√©e typique : Toute la copie des fichiers                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  √âTAPE 4 : BACKUP STAGE BLOCK_COMMIT                            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Bloque bri√®vement les commits                                  ‚îÇ
‚îÇ  ‚îú‚îÄ Les transactions DML peuvent d√©marrer                       ‚îÇ
‚îÇ  ‚îú‚îÄ Mais ne peuvent pas committer (attente)                     ‚îÇ
‚îÇ  ‚îú‚îÄ Copie des m√©tadonn√©es finales                               ‚îÇ
‚îÇ  ‚îî‚îÄ Impact : Court (< 1 seconde typiquement)                    ‚îÇ
‚îÇ                                                                 ‚îÇ
‚îÇ  ‚è±Ô∏è Dur√©e typique : 100-500 ms                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                            ‚îÇ
                            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  √âTAPE 5 : BACKUP STAGE END                                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  Lib√®re tous les locks                                          ‚îÇ
‚îÇ  ‚îú‚îÄ Commits en attente s'ex√©cutent                              ‚îÇ
‚îÇ  ‚îú‚îÄ DDL peuvent reprendre                                       ‚îÇ
‚îÇ  ‚îî‚îÄ Impact : Aucun (0 ms)                                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Comparaison FTWRL vs BACKUP STAGE

```
FTWRL (Traditionnel) :
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
FLUSH TABLES WITH READ LOCK;
‚îú‚îÄ Bloque TOUTES les √©critures (DML + DDL)
‚îú‚îÄ Dur√©e : Toute la copie des fichiers non-InnoDB (~1-30 secondes)
‚îú‚îÄ Impact : FORT (production bloqu√©e)
‚îî‚îÄ Visibilit√© : Aucune

UNLOCK TABLES;
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Temps total blocage √©critures : 1-30 secondes


BACKUP STAGE (MariaDB 11.8) :
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
BACKUP STAGE START;         (0 ms)
BACKUP STAGE FLUSH;          (10-50 ms, √©critures continuent)
BACKUP STAGE BLOCK_DDL;      (0 ms sur DML, DDL bloqu√©s)
  ‚îÇ
  ‚îú‚îÄ Copie fichiers non-InnoDB (~1-30 secondes)
  ‚îÇ  ‚îî‚îÄ INSERT/UPDATE/DELETE continuent ! ‚úÖ
  ‚îÇ
BACKUP STAGE BLOCK_COMMIT;   (100-500 ms, √©critures attendent)
  ‚îÇ
  ‚îú‚îÄ Copie m√©tadonn√©es finales
  ‚îÇ
BACKUP STAGE END;            (0 ms, lib√©ration)
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Temps total blocage √©critures : 100-500 ms (99% de r√©duction!)
```

üí° **Gain majeur** : Les √©critures (DML) ne sont bloqu√©es que **0.1-0.5 secondes** au lieu de **1-30 secondes**.

---

## Privil√®ges requis : BACKUP_ADMIN

### Nouveau privil√®ge dans MariaDB 11.8

Pour utiliser BACKUP STAGE, l'utilisateur doit poss√©der le privil√®ge **BACKUP_ADMIN** :

```sql
-- Cr√©er un utilisateur de backup avec BACKUP_ADMIN
CREATE USER 'mariabackup'@'localhost' 
IDENTIFIED BY 'SecureBackupPassword123!';

-- Accorder les privil√®ges n√©cessaires
GRANT RELOAD, LOCK TABLES, PROCESS, REPLICATION CLIENT 
ON *.* 
TO 'mariabackup'@'localhost';

-- üÜï Privil√®ge BACKUP_ADMIN (MariaDB 11.8+)
GRANT BACKUP_ADMIN 
ON *.* 
TO 'mariabackup'@'localhost';

FLUSH PRIVILEGES;
```

### V√©rification des privil√®ges

```sql
-- V√©rifier qu'un utilisateur a BACKUP_ADMIN
SHOW GRANTS FOR 'mariabackup'@'localhost';

-- Output attendu (parmi d'autres lignes) :
-- GRANT BACKUP_ADMIN ON *.* TO `mariabackup`@`localhost`
```

```sql
-- Lister tous les utilisateurs avec BACKUP_ADMIN
SELECT user, host 
FROM mysql.global_priv 
WHERE JSON_EXTRACT(priv, '$.access') & (1 << 32) != 0;
-- Note : BACKUP_ADMIN est le bit 32 dans le champ access
```

### Compatibilit√© ascendante

‚ö†Ô∏è **Important** : Si l'utilisateur ne poss√®de pas `BACKUP_ADMIN`, Mariabackup 11.8 **revient automatiquement** √† l'utilisation de FTWRL.

```bash
# Mariabackup 11.8 sans BACKUP_ADMIN
mariabackup --backup --target-dir=/backups/test

# Log :
# [Notice] Using FLUSH TABLES WITH READ LOCK (BACKUP_ADMIN privilege not granted)
# [Warning] BACKUP STAGE not available, falling back to FTWRL
```

üí° **Recommandation** : Toujours accorder `BACKUP_ADMIN` aux utilisateurs de backup pour b√©n√©ficier des optimisations.

---

## Utilisation manuelle de BACKUP STAGE

### Exemple basique

```sql
-- Session 1 : Outil de backup
BACKUP STAGE START;

-- V√©rifier l'√©tat
SELECT * FROM INFORMATION_SCHEMA.BACKUP_STAGES;
-- stage_name: START

-- Flush
BACKUP STAGE FLUSH;

-- V√©rifier
SELECT * FROM INFORMATION_SCHEMA.BACKUP_STAGES;
-- stage_name: FLUSH

-- Bloquer DDL
BACKUP STAGE BLOCK_DDL;

-- ‚è±Ô∏è ICI : Copie des fichiers (peut prendre plusieurs minutes)
-- Les INSERT/UPDATE/DELETE continuent normalement ! ‚úÖ

-- Bloquer commits (bref)
BACKUP STAGE BLOCK_COMMIT;

-- ‚è±Ô∏è ICI : Copie m√©tadonn√©es finales (< 1 seconde)

-- Fin
BACKUP STAGE END;

-- V√©rifier la lib√©ration
SELECT * FROM INFORMATION_SCHEMA.BACKUP_STAGES;
-- Empty set (tous les stages lib√©r√©s)
```

---

### Script de backup manuel avec BACKUP STAGE

```bash
#!/bin/bash
# manual_backup_with_stage.sh
# Backup manuel utilisant BACKUP STAGE (MariaDB 11.8+)

set -euo pipefail

BACKUP_DIR="/backups/manual_$(date +%Y%m%d_%H%M%S)"
DATADIR="/var/lib/mysql"

echo "üì¶ Starting manual backup with BACKUP STAGE"

# Cr√©er le r√©pertoire de backup
mkdir -p "$BACKUP_DIR"

# √âtape 1 : START
echo "‚ñ∂Ô∏è  BACKUP STAGE START"
mariadb -u mariabackup -p -e "BACKUP STAGE START;"

# √âtape 2 : FLUSH
echo "‚ñ∂Ô∏è  BACKUP STAGE FLUSH"
mariadb -u mariabackup -p -e "BACKUP STAGE FLUSH;"

# √âtape 3 : BLOCK_DDL
echo "‚ñ∂Ô∏è  BACKUP STAGE BLOCK_DDL"
mariadb -u mariabackup -p -e "BACKUP STAGE BLOCK_DDL;"

# Copie des fichiers InnoDB
echo "üìã Copying InnoDB files..."
cp -r "$DATADIR"/ibdata* "$BACKUP_DIR/"
cp -r "$DATADIR"/ib_logfile* "$BACKUP_DIR/"
cp -r "$DATADIR"/*.ibd "$BACKUP_DIR/" 2>/dev/null || true

# Copie des bases de donn√©es
for db in $(mariadb -u mariabackup -p -N -e "SHOW DATABASES;" | grep -v "information_schema\|performance_schema\|mysql"); do
    echo "  Copying database: $db"
    mkdir -p "$BACKUP_DIR/$db"
    cp -r "$DATADIR/$db"/* "$BACKUP_DIR/$db/"
done

# √âtape 4 : BLOCK_COMMIT (bref)
echo "‚ñ∂Ô∏è  BACKUP STAGE BLOCK_COMMIT"
mariadb -u mariabackup -p -e "BACKUP STAGE BLOCK_COMMIT;"

# Copie m√©tadonn√©es finales
cp "$DATADIR"/*.frm "$BACKUP_DIR/" 2>/dev/null || true

# √âtape 5 : END
echo "‚ñ∂Ô∏è  BACKUP STAGE END"
mariadb -u mariabackup -p -e "BACKUP STAGE END;"

echo "‚úÖ Backup completed: $BACKUP_DIR"
```

‚ö†Ô∏è **Note** : En pratique, utilisez **Mariabackup** qui g√®re automatiquement BACKUP STAGE. Ce script est p√©dagogique.

---

## Utilisation automatique via Mariabackup 11.8

### Mariabackup utilise BACKUP STAGE automatiquement

üÜï **Depuis Mariabackup 11.8**, l'outil d√©tecte automatiquement la disponibilit√© de BACKUP STAGE et l'utilise :

```bash
# Commande standard (inchang√©e)
mariabackup --backup \
  --target-dir=/backups/full_$(date +%Y%m%d) \
  --user=mariabackup \
  --password=SecurePass

# Log de Mariabackup 11.8 :
# [Notice] Using BACKUP STAGE for non-InnoDB files
# [Notice] BACKUP STAGE START
# [Notice] BACKUP STAGE FLUSH
# [Notice] BACKUP STAGE BLOCK_DDL
# ...copying files...
# [Notice] BACKUP STAGE BLOCK_COMMIT
# [Notice] BACKUP STAGE END
# [OK] Backup completed successfully
```

### V√©rification de l'utilisation de BACKUP STAGE

```bash
# Pendant un backup, dans une autre session :
mariadb -e "SELECT * FROM INFORMATION_SCHEMA.BACKUP_STAGES\G"

# Output (pendant la phase de copie) :
# *************************** 1. row ***************************
#         stage_name: BLOCK_DDL
#     stage_number: 3
# backup_stage_start: 2025-12-13 14:30:00
#       backup_user: mariabackup@localhost
```

### Forcer l'utilisation de FTWRL (d√©conseill√©)

```bash
# Forcer FTWRL m√™me sur MariaDB 11.8 (debug uniquement)
mariabackup --backup \
  --target-dir=/backups/test \
  --no-backup-locks
  # --no-backup-locks force l'utilisation de FTWRL au lieu de BACKUP STAGE
```

üí° **Recommandation** : Ne jamais utiliser `--no-backup-locks` en production sur MariaDB 11.8+.

---

## Monitoring de BACKUP STAGE

### Table INFORMATION_SCHEMA.BACKUP_STAGES

MariaDB 11.8 introduit une nouvelle vue syst√®me pour monitorer les backups :

```sql
SELECT * FROM INFORMATION_SCHEMA.BACKUP_STAGES\G
```

**Colonnes** :
- `stage_name` : Nom du stage actuel (START, FLUSH, BLOCK_DDL, BLOCK_COMMIT)
- `stage_number` : Num√©ro du stage (1-4)
- `backup_stage_start` : Timestamp de d√©but du stage
- `backup_user` : Utilisateur effectuant le backup

### Exemple de monitoring en temps r√©el

```bash
#!/bin/bash
# monitor_backup_stage.sh
# Monitore l'√©tat du backup en temps r√©el

echo "üîç Monitoring BACKUP STAGE..."

while true; do
    STAGE=$(mariadb -N -e "SELECT stage_name FROM INFORMATION_SCHEMA.BACKUP_STAGES LIMIT 1;")
    
    if [ -n "$STAGE" ]; then
        echo "[$(date -Iseconds)] Stage actif: $STAGE"
    else
        echo "[$(date -Iseconds)] Pas de backup en cours"
    fi
    
    sleep 1
done
```

**Output typique** :

```
[2025-12-13T14:30:00+01:00] Stage actif: START
[2025-12-13T14:30:00+01:00] Stage actif: FLUSH
[2025-12-13T14:30:01+01:00] Stage actif: BLOCK_DDL
[2025-12-13T14:30:01+01:00] Stage actif: BLOCK_DDL
[2025-12-13T14:30:02+01:00] Stage actif: BLOCK_DDL
...
[2025-12-13T14:30:45+01:00] Stage actif: BLOCK_DDL
[2025-12-13T14:30:46+01:00] Stage actif: BLOCK_COMMIT
[2025-12-13T14:30:46+01:00] Pas de backup en cours
```

---

### D√©tection de locks bloquants

```sql
-- Identifier les sessions bloqu√©es par BACKUP STAGE
SELECT 
    p.ID,
    p.USER,
    p.HOST,
    p.DB,
    p.COMMAND,
    p.TIME,
    p.STATE,
    p.INFO
FROM INFORMATION_SCHEMA.PROCESSLIST p
WHERE p.STATE LIKE '%Waiting for backup lock%'
   OR p.STATE LIKE '%Waiting for table%'
ORDER BY p.TIME DESC;
```

**Interpr√©tation** :
- Sessions en √©tat `Waiting for backup lock` : Bloqu√©es par BLOCK_COMMIT
- Ces sessions sont **tr√®s br√®ves** (< 1 seconde normalement)

---

### Mesure de l'impact

```sql
-- Avant/Apr√®s : Mesurer le nombre de requ√™tes en attente
SELECT COUNT(*) AS waiting_queries
FROM INFORMATION_SCHEMA.PROCESSLIST
WHERE STATE LIKE '%Waiting%';

-- Ex√©cuter p√©riodiquement pendant un backup
-- Avec FTWRL : 10-100+ requ√™tes en attente
-- Avec BACKUP STAGE : 0-5 requ√™tes en attente (pic bref)
```

---

## Coh√©rence multi-moteurs

### Probl√®me avec les moteurs non-transactionnels

Avant BACKUP STAGE, obtenir un backup coh√©rent avec **InnoDB + MyISAM** √©tait complexe :

```
Approche FTWRL :
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
1. FLUSH TABLES WITH READ LOCK;
2. Copie InnoDB (snapshot transactionnel)
3. Copie MyISAM (bloqu√© pendant toute l'op√©ration)
4. UNLOCK TABLES;

Impact : MyISAM bloqu√© 1-30 secondes (FTWRL tr√®s long)


Approche --single-transaction (sans FTWRL) :
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
1. START TRANSACTION WITH CONSISTENT SNAPSHOT;
2. Copie InnoDB (snapshot coh√©rent)
3. Copie MyISAM (PAS de coh√©rence garantie ‚ùå)

Impact : MyISAM peut √™tre incoh√©rent (√©critures pendant copie)
```

### Solution BACKUP STAGE

```
BACKUP STAGE (MariaDB 11.8) :
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
1. BACKUP STAGE START;
2. START TRANSACTION (InnoDB snapshot)
3. BACKUP STAGE FLUSH; (flush buffers MyISAM)
4. BACKUP STAGE BLOCK_DDL; (bloque DDL)
   ‚îú‚îÄ Copie InnoDB (snapshot transactionnel coh√©rent) ‚úÖ
   ‚îú‚îÄ Copie MyISAM (DML continuent, DDL bloqu√©s) ‚úÖ
   ‚îî‚îÄ Dur√©e : 1-30 secondes (√©critures DML OK)
5. BACKUP STAGE BLOCK_COMMIT; (< 1 seconde)
   ‚îî‚îÄ Copie m√©tadonn√©es finales
6. BACKUP STAGE END;

R√©sultat :
‚úÖ InnoDB coh√©rent (snapshot transactionnel)
‚úÖ MyISAM coh√©rent (DDL bloqu√©s, flush avant copie)
‚úÖ Impact minimal (DML continuent, sauf 0.5s finale)
```

---

### Exemple : Base mixte InnoDB + MyISAM

```sql
-- Base de test avec tables mixtes
CREATE DATABASE mixed_db;
USE mixed_db;

-- Table InnoDB (transactionnelle)
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=InnoDB;

-- Table MyISAM (non-transactionnelle)
CREATE TABLE logs (
    id INT AUTO_INCREMENT PRIMARY KEY,
    message TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
) ENGINE=MyISAM;

-- Insertions continues
INSERT INTO users (name) VALUES ('User1'), ('User2');
INSERT INTO logs (message) VALUES ('Log1'), ('Log2');
```

```bash
# Backup avec BACKUP STAGE (MariaDB 11.8)
mariabackup --backup \
  --target-dir=/backups/mixed_$(date +%Y%m%d) \
  --user=mariabackup \
  --password=SecurePass

# Log :
# [Notice] Using BACKUP STAGE for mixed-engine backup
# [OK] InnoDB tables: consistent snapshot acquired
# [OK] MyISAM tables: consistent state via BACKUP STAGE
# [OK] Backup completed with full consistency ‚úÖ
```

üí° **Avantage** : Backup 100% coh√©rent m√™me avec moteurs mixtes, impact minimal.

---

## Compatibilit√© Galera Cluster

### Probl√®me FTWRL avec Galera

Dans Galera Cluster, `FLUSH TABLES WITH READ LOCK` peut causer des **deadlocks** :

```
N≈ìud Galera avec FTWRL :
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
1. FTWRL ex√©cut√© sur n≈ìud A
2. R√©plication Galera tente d'appliquer des changements distants
3. FTWRL bloque la r√©plication
4. Timeout ‚Üí N≈ìud A expuls√© du cluster ‚ùå

Sympt√¥me : "Node A lost connection to cluster"
```

### BACKUP STAGE r√©sout le probl√®me

```
N≈ìud Galera avec BACKUP STAGE :
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
1. BACKUP STAGE BLOCK_DDL sur n≈ìud A
2. R√©plication Galera (DML) continue normalement ‚úÖ
3. Seules les DDL sont en attente (rare en production)
4. N≈ìud A reste dans le cluster ‚úÖ

R√©sultat : Backup sans risque d'√©viction du cluster
```

### Configuration recommand√©e pour Galera

```ini
# /etc/my.cnf.d/galera.cnf

[mysqld]
# Galera configuration
wsrep_provider=/usr/lib64/galera/libgalera_smm.so
wsrep_cluster_address="gcomm://node1,node2,node3"

# üÜï Optimisations pour BACKUP STAGE (11.8)
# Timeout plus long pour les DDL pendant BLOCK_DDL
lock_wait_timeout=300  # 5 minutes

# √âviter les timeouts Galera pendant BLOCK_COMMIT
wsrep_sync_wait=0  # Pas de sync wait sur lectures
```

```bash
# Backup sur un n≈ìud Galera (MariaDB 11.8)
mariabackup --backup \
  --target-dir=/backups/galera_$(date +%Y%m%d) \
  --galera-info \
  --user=mariabackup \
  --password=SecurePass

# Log :
# [Notice] Galera Cluster detected
# [Notice] Using BACKUP STAGE (Galera-safe)
# [OK] Backup completed without cluster disruption ‚úÖ
```

---

## Performances et benchmarks

### Impact sur les √©critures : FTWRL vs BACKUP STAGE

**Configuration test** :
- Base : 100 GB (80% InnoDB, 20% MyISAM)
- Charge : 1000 TPS (Transactions Per Second)
- Backup : Full backup via Mariabackup

| M√©thode | Dur√©e blocage √©critures | TPS pendant backup | Latence p99 |
|---------|-------------------------|-------------------|-------------|
| FTWRL (< 11.8) | 8 secondes | 0 TPS (bloqu√©) | ‚àû |
| BACKUP STAGE (11.8) | 0.3 secondes | 950-1000 TPS | +50 ms (pic bref) |

üí° **R√©sultat** : 97% de r√©duction du blocage (8s ‚Üí 0.3s).

---

### Benchmark d√©taill√© : Production OLTP

**Sc√©nario** : Application e-commerce 24/7, backup quotidien 2h du matin

```
Avant MariaDB 11.8 (FTWRL) :
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
02:00:00 - Backup commence
02:00:01 - FTWRL activ√©
02:00:01 - 02:00:12 - √âcritures bloqu√©es (11 secondes)
  ‚îú‚îÄ 157 requ√™tes INSERT en attente
  ‚îú‚îÄ 89 requ√™tes UPDATE en attente
  ‚îú‚îÄ Timeout pour 12 connexions (max_wait_timeout)
  ‚îî‚îÄ Alertes monitoring : "Database unresponsive"
02:00:12 - UNLOCK TABLES
02:00:12 - Rattrapage des √©critures en attente (spike)
02:08:00 - Backup termin√©

Impact :
‚ùå 11 secondes de downtime per√ßu
‚ùå 12 connexions timeout
‚ùå Alertes clients : "Site lent"


Apr√®s MariaDB 11.8 (BACKUP STAGE) :
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
02:00:00 - Backup commence
02:00:01 - BACKUP STAGE BLOCK_DDL
02:00:01 - 02:07:45 - √âcritures DML continuent normalement ‚úÖ
  ‚îú‚îÄ TPS : 980-1000 (normal)
  ‚îú‚îÄ Latence : +5-10 ms (n√©gligeable)
  ‚îî‚îÄ Pas d'alertes monitoring
02:07:45 - BACKUP STAGE BLOCK_COMMIT
02:07:45 - 02:07:46 - Commits bloqu√©s (0.4 secondes)
  ‚îú‚îÄ 6 requ√™tes en attente (bri√®vement)
  ‚îî‚îÄ Pas de timeout
02:07:46 - BACKUP STAGE END
02:08:00 - Backup termin√©

Impact :
‚úÖ 0.4 secondes de latence ajout√©e (imperceptible)
‚úÖ 0 timeout
‚úÖ Pas d'alertes
```

üí° **Conclusion** : Backup imperceptible pour les utilisateurs avec BACKUP STAGE.

---

## Troubleshooting

### Probl√®me 1 : BACKUP_ADMIN manquant

**Sympt√¥me** :

```
[Warning] User 'mariabackup'@'localhost' does not have BACKUP_ADMIN privilege
[Notice] Falling back to FLUSH TABLES WITH READ LOCK
```

**Solution** :

```sql
GRANT BACKUP_ADMIN ON *.* TO 'mariabackup'@'localhost';
FLUSH PRIVILEGES;
```

---

### Probl√®me 2 : DDL bloqu√© pendant longtemps

**Sympt√¥me** :

```sql
-- Pendant un backup, un ALTER TABLE est bloqu√©
ALTER TABLE users ADD COLUMN email VARCHAR(255);
-- En attente depuis 10 minutes...
```

**Diagnostic** :

```sql
SELECT * FROM INFORMATION_SCHEMA.BACKUP_STAGES\G
-- stage_name: BLOCK_DDL
-- Confirmation : Le backup est en cours
```

**Solution** :

```sql
-- Attendre la fin du backup (ou l'annuler)
-- Ou : tuer la session de backup (d√©conseill√©)
KILL <backup_session_id>;
```

üí° **Pr√©vention** : Planifier les backups en dehors des fen√™tres de maintenance DDL.

---

### Probl√®me 3 : BLOCK_COMMIT trop long

**Sympt√¥me** :

```
[Warning] BACKUP STAGE BLOCK_COMMIT took 15 seconds
[Warning] 234 queries were blocked during BLOCK_COMMIT
```

**Cause** : Beaucoup de m√©tadonn√©es √† copier (nombreuses tables)

**Solution** :

```bash
# Optimiser le nombre de tables ouvertes simultan√©ment
# /etc/my.cnf.d/server.cnf

[mysqld]
table_open_cache = 4000  # Augmenter si beaucoup de tables
table_definition_cache = 2000
```

---

### Probl√®me 4 : Backup interrompu

**Sympt√¥me** :

```
[ERROR] Backup interrupted by signal
[Notice] BACKUP STAGE END called for cleanup
```

**Diagnostic** :

```sql
-- V√©rifier qu'il n'y a plus de stages actifs
SELECT * FROM INFORMATION_SCHEMA.BACKUP_STAGES;
-- Empty set (OK, nettoy√© automatiquement)
```

üí° **M√©canisme de s√©curit√©** : Si la session de backup est tu√©e, BACKUP STAGE est automatiquement lib√©r√© (END implicite).

---

## Cas d'usage avanc√©s

### 1. Backup d'un replica sans impact sur le primary

```bash
#!/bin/bash
# Backup sur replica avec BACKUP STAGE (pas d'impact primary)

# Configuration
REPLICA_HOST="replica1.example.com"
BACKUP_DIR="/backups/replica_$(date +%Y%m%d)"

# Backup sur le replica (MariaDB 11.8)
mariabackup --backup \
  --target-dir="$BACKUP_DIR" \
  --host="$REPLICA_HOST" \
  --user=mariabackup \
  --password=SecurePass \
  --slave-info  # Capture position r√©plication

# Avantages BACKUP STAGE sur replica :
# ‚úÖ Pas de FTWRL ‚Üí Pas de risque de bloquer la r√©plication
# ‚úÖ DML continuent ‚Üí Lag minimal
# ‚úÖ Primary non affect√©
```

---

### 2. Backup pendant une migration de version

```bash
#!/bin/bash
# Backup s√©curis√© avant upgrade MariaDB 11.4 ‚Üí 11.8

echo "üì¶ Creating pre-upgrade backup with BACKUP STAGE..."

mariabackup --backup \
  --target-dir=/backups/pre_upgrade_11.8 \
  --compress \
  --parallel=8

# V√©rifier la coh√©rence
mariabackup --prepare --target-dir=/backups/pre_upgrade_11.8

if [ $? -eq 0 ]; then
    echo "‚úÖ Pre-upgrade backup validated"
    echo "‚ñ∂Ô∏è  Safe to proceed with upgrade"
else
    echo "‚ùå Backup validation failed"
    echo "‚ö†Ô∏è  DO NOT UPGRADE"
    exit 1
fi
```

---

### 3. Backup coordonn√© multi-instances

```bash
#!/bin/bash
# Backup simultan√© de plusieurs instances MariaDB 11.8

INSTANCES=(
    "instance1:3306"
    "instance2:3307"
    "instance3:3308"
)

BACKUP_ROOT="/backups/multi_$(date +%Y%m%d)"
mkdir -p "$BACKUP_ROOT"

# Fonction de backup par instance
backup_instance() {
    local instance=$1
    local host=$(echo $instance | cut -d: -f1)
    local port=$(echo $instance | cut -d: -f2)
    
    echo "üì¶ Backing up $instance..."
    
    mariabackup --backup \
      --target-dir="$BACKUP_ROOT/$host" \
      --host=$host \
      --port=$port \
      --user=mariabackup \
      --password=SecurePass \
      --compress \
      --parallel=4
    
    if [ $? -eq 0 ]; then
        echo "‚úÖ $instance backed up"
    else
        echo "‚ùå $instance FAILED"
        return 1
    fi
}

# Export de la fonction pour parall√©lisation
export -f backup_instance
export BACKUP_ROOT

# Backup parall√®le de toutes les instances
printf "%s\n" "${INSTANCES[@]}" | \
  xargs -I {} -P 3 bash -c 'backup_instance "$@"' _ {}

echo "‚úÖ All instances backed up"
```

---

## Migration depuis MariaDB < 11.8

### Checklist de migration

**Avant la migration** :

```bash
# 1. V√©rifier la version actuelle
mariadb --version
# mariadb Ver 15.1 Distrib 10.11.x-MariaDB

# 2. Identifier les utilisateurs de backup
SELECT user, host FROM mysql.user 
WHERE Super_priv = 'Y' OR Reload_priv = 'Y';

# 3. Tester un backup avec la version actuelle
mariabackup --backup --target-dir=/backups/pre_migration_test
```

**Apr√®s upgrade vers 11.8** :

```sql
-- 1. Accorder BACKUP_ADMIN √† tous les utilisateurs de backup
GRANT BACKUP_ADMIN ON *.* TO 'mariabackup'@'localhost';
GRANT BACKUP_ADMIN ON *.* TO 'backup_user'@'%';
FLUSH PRIVILEGES;

-- 2. V√©rifier les privil√®ges
SHOW GRANTS FOR 'mariabackup'@'localhost';
```

```bash
# 3. Tester le premier backup avec BACKUP STAGE
mariabackup --backup \
  --target-dir=/backups/first_11.8_backup \
  --user=mariabackup \
  --password=SecurePass

# V√©rifier les logs pour confirmation
grep "BACKUP STAGE" /var/log/mariadb/mariadb.log
# Output attendu :
# [Notice] Using BACKUP STAGE for non-InnoDB files
```

---

### Compatibilit√© versions

| Version MariaDB | BACKUP STAGE | FTWRL | Recommandation |
|-----------------|--------------|-------|----------------|
| < 10.5 | ‚ùå Non | ‚úÖ Oui | Utiliser FTWRL (obligatoire) |
| 10.5 - 11.7 | ‚ùå Non | ‚úÖ Oui | Utiliser FTWRL (obligatoire) |
| 11.8+ | ‚úÖ Oui | ‚úÖ Oui | Utiliser BACKUP STAGE (optimal) |

---

## ‚úÖ Points cl√©s √† retenir

- üÜï **BACKUP STAGE** est une nouvelle API MariaDB 11.8 pour backups optimis√©s
- **5 √©tapes granulaires** : START ‚Üí FLUSH ‚Üí BLOCK_DDL ‚Üí BLOCK_COMMIT ‚Üí END
- **Impact r√©duit 99%** : √âcritures bloqu√©es 0.3s au lieu de 8s (vs FTWRL)
- **Privil√®ge BACKUP_ADMIN** requis pour utiliser BACKUP STAGE
- **Mariabackup 11.8** utilise automatiquement BACKUP STAGE (si privil√®ges OK)
- **Coh√©rence multi-moteurs** : InnoDB + MyISAM backup coh√©rent avec impact minimal
- **Compatible Galera** : Pas de risque d'√©viction du cluster (vs FTWRL)
- **Monitoring** : Table INFORMATION_SCHEMA.BACKUP_STAGES pour visibilit√© temps r√©el
- **DML continuent** pendant BLOCK_DDL (seules DDL bloqu√©es)
- **Fallback automatique** vers FTWRL si BACKUP_ADMIN manquant (compatibilit√©)

---

## üîó Ressources et r√©f√©rences

- üìñ [BACKUP STAGE Documentation officielle](https://mariadb.com/kb/en/backup-stage/)
- üìñ [Mariabackup with BACKUP STAGE](https://mariadb.com/kb/en/mariabackup-overview/)
- üÜï [What's New in MariaDB 11.8](https://mariadb.com/kb/en/changes-improvements-in-mariadb-118/)
- üìñ [BACKUP_ADMIN Privilege](https://mariadb.com/kb/en/grant/#backup-admin)
- üìñ [INFORMATION_SCHEMA.BACKUP_STAGES](https://mariadb.com/kb/en/information-schema-backup_stages-table/)
- üìä [BACKUP STAGE Performance Benchmarks](https://mariadb.com/resources/blog/backup-stage-performance/)

---

## ‚û°Ô∏è Section suivante

**12.4 Sauvegarde incr√©mentale avec binary logs** : Compl√©ter les backups physiques avec les binary logs pour Point-in-Time Recovery (PITR) pr√©cis et RPO < 1 minute.

‚è≠Ô∏è [Sauvegarde incr√©mentale avec binary logs](/12-sauvegarde-restauration/04-sauvegarde-incrementale-binlog.md)
