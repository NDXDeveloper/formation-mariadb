ğŸ” Retour au [Sommaire](/SOMMAIRE.md)

# 12.3.2 Incremental backup avec Mariabackup

> **Niveau** : AvancÃ©  
> **DurÃ©e estimÃ©e** : 3.5 heures  
> **PrÃ©requis** : Section 12.3.1 (Full backup), comprÃ©hension des LSN et de l'architecture InnoDB

## ğŸ¯ Objectifs d'apprentissage

Ã€ l'issue de cette section, vous serez capable de :
- Comprendre les diffÃ©rences entre sauvegardes Full, IncrÃ©mentale et DiffÃ©rentielle
- MaÃ®triser le mÃ©canisme des LSN (Log Sequence Number) pour les backups incrÃ©mentaux
- Concevoir des stratÃ©gies de sauvegarde optimales (rotation full + incrÃ©mentaux)
- Effectuer des backups incrÃ©mentaux cohÃ©rents avec Mariabackup
- PrÃ©parer et restaurer une chaÃ®ne de backups incrÃ©mentaux
- Calculer le RPO (Recovery Point Objective) optimal selon vos contraintes
- Automatiser les backups incrÃ©mentaux avec rotation intelligente
- Optimiser l'espace disque et le temps de backup en production
- GÃ©rer les backups incrÃ©mentaux dans des architectures cloud-native

---

## Introduction

Les **backups incrÃ©mentaux** constituent une stratÃ©gie essentielle pour rÃ©duire le temps et l'espace requis pour les sauvegardes, tout en maintenant un RPO (Recovery Point Objective) court. Au lieu de copier l'intÃ©gralitÃ© de la base de donnÃ©es Ã  chaque backup, Mariabackup ne sauvegarde que les **pages InnoDB modifiÃ©es** depuis le dernier backup.

### Comparaison des stratÃ©gies de sauvegarde

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BACKUP COMPLET (FULL)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Copie 100% de la base de donnÃ©es                               â”‚
â”‚                                                                 â”‚
â”‚  âœ… Restauration simple (1 seul backup)                         â”‚
â”‚  âœ… IndÃ©pendant (pas de dÃ©pendances)                            â”‚
â”‚  âŒ Lent (ex: 500 GB â†’ 60 min)                                  â”‚
â”‚  âŒ Consomme beaucoup d'espace                                  â”‚
â”‚                                                                 â”‚
â”‚  FrÃ©quence typique : Hebdomadaire ou mensuel                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  BACKUP INCRÃ‰MENTAL (INCREMENTAL)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Copie uniquement les pages modifiÃ©es depuis dernier backup     â”‚
â”‚  (full OU incrÃ©mental)                                          â”‚
â”‚                                                                 â”‚
â”‚  âœ… TrÃ¨s rapide (ex: 500 GB â†’ 3-5 min)                          â”‚
â”‚  âœ… Ã‰conome en espace (2-10% du full)                           â”‚
â”‚  âŒ Restauration complexe (chaÃ®ne complÃ¨te)                     â”‚
â”‚  âŒ Risque si un maillon est corrompu                           â”‚
â”‚                                                                 â”‚
â”‚  FrÃ©quence typique : Quotidien ou toutes les 6h                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 BACKUP DIFFÃ‰RENTIEL (DIFFERENTIAL)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Copie uniquement les pages modifiÃ©es depuis dernier FULL       â”‚
â”‚  (toujours par rapport au full, pas au dernier backup)          â”‚
â”‚                                                                 â”‚
â”‚  âœ… Restauration plus simple (full + 1 diff)                    â”‚
â”‚  âœ… Moins de risque qu'incrÃ©mental                              â”‚
â”‚  âŒ Plus lent qu'incrÃ©mental (cumule les modifs)                â”‚
â”‚  âŒ Taille croÃ®t avec le temps depuis le full                   â”‚
â”‚                                                                 â”‚
â”‚  FrÃ©quence typique : Quotidien                                  â”‚
â”‚  Note : Non supportÃ© nativement par Mariabackup                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Illustration chronologique

```
Lundi    Mardi      Mercredi   Jeudi      Vendredi   Samedi    Dimanche
  â”‚        â”‚          â”‚          â”‚          â”‚          â”‚          â”‚
  â–¼        â–¼          â–¼          â–¼          â–¼          â–¼          â–¼

STRATÃ‰GIE 1 : Full hebdomadaire + IncrÃ©mentaux quotidiens
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[FULL]â”€â”€â†’[INC1]â”€â”€â†’[INC2]â”€â”€â†’[INC3]â”€â”€â†’[INC4]â”€â”€â†’[INC5]â”€â”€â†’[INC6]â”€â”€â†’[FULL]
100GB    5GB      4GB      6GB      5GB      7GB      6GB      100GB

Restauration jeudi : FULL + INC1 + INC2 + INC3 (4 Ã©tapes)
Espace total semaine : 100 + 5 + 4 + 6 + 5 + 7 + 6 = 133 GB


STRATÃ‰GIE 2 : Full quotidien (pas d'incrÃ©mental)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[FULL]â”€â”€â†’[FULL]â”€â”€â†’[FULL]â”€â”€â†’[FULL]â”€â”€â†’[FULL]â”€â”€â†’[FULL]â”€â”€â†’[FULL]â”€â”€â†’[FULL]
100GB    100GB    100GB    100GB    100GB    100GB    100GB    100GB

Restauration jeudi : FULL (1 Ã©tape)
Espace total semaine : 100 Ã— 7 = 700 GB


STRATÃ‰GIE 3 : Full hebdo + DiffÃ©rentiels quotidiens (hypothÃ©tique)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[FULL]â”€â”€â†’[DIFF1]â”€â”€â†’[DIFF2]â”€â”€â†’[DIFF3]â”€â”€â†’[DIFF4]â”€â”€â†’[DIFF5]â”€â”€â†’[DIFF6]
100GB    8GB      15GB     22GB     28GB     35GB     42GB

Restauration jeudi : FULL + DIFF3 (2 Ã©tapes)
Espace total semaine : 100 + 8 + 15 + 22 + 28 + 35 + 42 = 250 GB
```

ğŸ’¡ **Choix de stratÃ©gie** :
- **FULL hebdo + INCRÃ‰MENTAUX quotidiens** : Optimal pour grandes bases (> 500 GB)
- **FULL quotidien** : Bases petites/moyennes (< 100 GB) ou infrastructure cloud avec snapshots
- **DIFFÃ‰RENTIEL** : Compromis si restauration frÃ©quente (non supportÃ© par Mariabackup)

---

## Principe des LSN (Log Sequence Number)

### Qu'est-ce qu'un LSN ?

Le **LSN (Log Sequence Number)** est un compteur monotone croissant qui identifie de maniÃ¨re unique chaque modification dans InnoDB. Chaque page de donnÃ©es contient le LSN de sa derniÃ¨re modification.

```
LSN = Position dans le redo log

Temps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º
       â”‚       â”‚         â”‚        â”‚        â”‚         â”‚
LSN:   0    10000    25000    50000   75000    100000   125000
       â”‚       â”‚         â”‚        â”‚        â”‚         â”‚
       â””â”€Fullâ”€â”€â”´â”€INC1â”€â”€â”€â”€â”´â”€INC2â”€â”€â”€â”´â”€INC3â”€â”€â”€â”´â”€INC4â”€â”€â”€â”€â”´â”€INC5â”€â”€â–º

Full backup  : Copie toutes les pages (LSN 0 â†’ 10000)
INC1 backup  : Copie pages modifiÃ©es (LSN 10001 â†’ 25000)
INC2 backup  : Copie pages modifiÃ©es (LSN 25001 â†’ 50000)
...
```

### Comment Mariabackup utilise les LSN

```bash
# Full backup
mariabackup --backup --target-dir=/backups/full

# Contenu de xtrabackup_checkpoints :
# backup_type = full-backuped
# from_lsn = 0
# to_lsn = 10000000
# last_lsn = 10000000
```

```bash
# Incremental backup #1
mariabackup --backup \
  --target-dir=/backups/inc1 \
  --incremental-basedir=/backups/full

# Contenu de xtrabackup_checkpoints :
# backup_type = incremental
# from_lsn = 10000000  â† to_lsn du full
# to_lsn = 25000000
# last_lsn = 25000000
```

ğŸ’¡ **Principe** : Un backup incrÃ©mental copie uniquement les pages dont le LSN est **supÃ©rieur** au `to_lsn` du backup de base.

---

## CrÃ©ation d'un backup incrÃ©mental

### Syntaxe de base

```bash
mariabackup --backup \
  --target-dir=/path/to/incremental \
  --incremental-basedir=/path/to/base_backup
```

### Option `--incremental-basedir`

L'option `--incremental-basedir` indique le backup de rÃ©fÃ©rence :
- Pour le **1er incrÃ©mental** : pointe vers le **full backup**
- Pour les **incrÃ©mentaux suivants** : pointe vers le **dernier incrÃ©mental**

```bash
# Structure de rÃ©pertoires recommandÃ©e
/backups/
â”œâ”€â”€ full_20251213/          # Full backup du dimanche
â”œâ”€â”€ inc_20251214/           # IncrÃ©mental lundi
â”œâ”€â”€ inc_20251215/           # IncrÃ©mental mardi
â”œâ”€â”€ inc_20251216/           # IncrÃ©mental mercredi
â”œâ”€â”€ inc_20251217/           # IncrÃ©mental jeudi
â”œâ”€â”€ inc_20251218/           # IncrÃ©mental vendredi
â””â”€â”€ inc_20251219/           # IncrÃ©mental samedi
```

---

### Exemple 1 : ChaÃ®ne simple (Full + 3 incrÃ©mentaux)

```bash
#!/bin/bash
# Simulation d'une semaine de backups

BACKUP_ROOT="/backups/mariadb"

# Dimanche : Full backup
echo "ğŸ“¦ Sunday: Full backup"
mariabackup --backup \
  --target-dir="$BACKUP_ROOT/full_20251213" \
  --user=mariabackup \
  --password=SecurePass

# Lundi : 1er incrÃ©mental (base = full)
echo "ğŸ“¦ Monday: Incremental #1"
mariabackup --backup \
  --target-dir="$BACKUP_ROOT/inc_20251214" \
  --incremental-basedir="$BACKUP_ROOT/full_20251213"

# Mardi : 2e incrÃ©mental (base = inc1)
echo "ğŸ“¦ Tuesday: Incremental #2"
mariabackup --backup \
  --target-dir="$BACKUP_ROOT/inc_20251215" \
  --incremental-basedir="$BACKUP_ROOT/inc_20251214"

# Mercredi : 3e incrÃ©mental (base = inc2)
echo "ğŸ“¦ Wednesday: Incremental #3"
mariabackup --backup \
  --target-dir="$BACKUP_ROOT/inc_20251216" \
  --incremental-basedir="$BACKUP_ROOT/inc_20251215"

echo "âœ… Backup chain completed"
```

**VÃ©rification des LSN** :

```bash
# Full
grep "to_lsn" /backups/mariadb/full_20251213/xtrabackup_checkpoints
# to_lsn = 10000000

# Inc1
grep "from_lsn\|to_lsn" /backups/mariadb/inc_20251214/xtrabackup_checkpoints
# from_lsn = 10000000  â† Correspond au to_lsn du full âœ…
# to_lsn = 25000000

# Inc2
grep "from_lsn\|to_lsn" /backups/mariadb/inc_20251215/xtrabackup_checkpoints
# from_lsn = 25000000  â† Correspond au to_lsn de inc1 âœ…
# to_lsn = 50000000

# Inc3
grep "from_lsn\|to_lsn" /backups/mariadb/inc_20251216/xtrabackup_checkpoints
# from_lsn = 50000000  â† Correspond au to_lsn de inc2 âœ…
# to_lsn = 75000000
```

---

### Exemple 2 : Backup incrÃ©mental avec compression

```bash
#!/bin/bash
# IncrÃ©mental compressÃ© (recommandÃ© en production)

mariabackup --backup \
  --target-dir=/backups/inc_$(date +%Y%m%d) \
  --incremental-basedir=/backups/latest_full \
  --compress \
  --compress-threads=8 \
  --parallel=8

# Taille typique d'un incrÃ©mental compressÃ© :
# Base 500 GB â†’ IncrÃ©mental 2-5 GB (0.4-1% du full)
```

---

### Exemple 3 : Backup incrÃ©mental en streaming vers S3

```bash
#!/bin/bash
# Streaming incrÃ©mental vers S3

S3_BUCKET="s3://my-backups/mariadb"
DATE=$(date +%Y%m%d)

# 1. TÃ©lÃ©charger le dernier checkpoint (pour connaÃ®tre le to_lsn)
aws s3 cp "$S3_BUCKET/latest_checkpoint.txt" /tmp/

# 2. CrÃ©er backup incrÃ©mental local temporaire
mariabackup --backup \
  --target-dir=/tmp/inc_$DATE \
  --incremental-basedir=/tmp/last_base_extracted

# 3. Streamer vers S3
cd /tmp/inc_$DATE
tar czf - . | aws s3 cp - "$S3_BUCKET/inc_$DATE.tar.gz"

# 4. Sauvegarder le nouveau checkpoint
cp /tmp/inc_$DATE/xtrabackup_checkpoints "$S3_BUCKET/latest_checkpoint.txt"

# 5. Nettoyage local
rm -rf /tmp/inc_$DATE
```

âš ï¸ **ComplexitÃ© S3** : Le streaming incrÃ©mental vers S3 est plus complexe car il nÃ©cessite de connaÃ®tre le `to_lsn` du backup prÃ©cÃ©dent. Approche alternative : full streaming hebdo + incrÃ©mentaux locaux.

---

## PrÃ©paration des backups incrÃ©mentaux

âš ï¸ **CRITIQUE** : La prÃ©paration des backups incrÃ©mentaux est **diffÃ©rente** du full backup. Il faut appliquer les incrÃ©mentaux **sÃ©quentiellement** au full.

### Processus de prÃ©paration

```
Ã‰tape 1 : PrÃ©parer le FULL (sans commit final)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
mariabackup --prepare \
  --apply-log-only \
  --target-dir=/backups/full

âš ï¸ --apply-log-only est CRUCIAL !
   = Applique les redo, mais NE PAS rollback les transactions uncommitted
   (car elles peuvent Ãªtre committÃ©es dans les incrÃ©mentaux suivants)


Ã‰tape 2 : Appliquer INC1 au FULL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
mariabackup --prepare \
  --apply-log-only \
  --target-dir=/backups/full \
  --incremental-dir=/backups/inc1

Ã‰tat : FULL contient maintenant FULL + INC1


Ã‰tape 3 : Appliquer INC2
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
mariabackup --prepare \
  --apply-log-only \
  --target-dir=/backups/full \
  --incremental-dir=/backups/inc2

Ã‰tat : FULL contient maintenant FULL + INC1 + INC2


Ã‰tape 4 : Appliquer INC3 (dernier incrÃ©mental)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
mariabackup --prepare \
  --target-dir=/backups/full \
  --incremental-dir=/backups/inc3

âš ï¸ PAS de --apply-log-only sur le DERNIER incrÃ©mental !
   = Rollback des transactions uncommitted (finalisation)


Ã‰tape 5 : Backup prÃªt Ã  restaurer
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
mariabackup --copy-back --target-dir=/backups/full
```

---

### Script de prÃ©paration complet

```bash
#!/bin/bash
# prepare_incremental_chain.sh
# PrÃ©pare une chaÃ®ne full + 6 incrÃ©mentaux

set -euo pipefail

BACKUP_ROOT="/backups/mariadb"
FULL_BACKUP="$BACKUP_ROOT/full_20251213"
INCREMENTALS=(
    "$BACKUP_ROOT/inc_20251214"
    "$BACKUP_ROOT/inc_20251215"
    "$BACKUP_ROOT/inc_20251216"
    "$BACKUP_ROOT/inc_20251217"
    "$BACKUP_ROOT/inc_20251218"
    "$BACKUP_ROOT/inc_20251219"
)

echo "ğŸ”§ Preparing incremental backup chain"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Ã‰tape 1 : PrÃ©parer le FULL (avec --apply-log-only)
echo "ğŸ“¦ [1/7] Preparing FULL backup..."
mariabackup --prepare \
  --apply-log-only \
  --target-dir="$FULL_BACKUP"

if [ $? -ne 0 ]; then
    echo "âŒ Failed to prepare FULL backup"
    exit 1
fi

echo "âœ… FULL backup prepared"

# Ã‰tape 2-7 : Appliquer les incrÃ©mentaux
INC_COUNT=${#INCREMENTALS[@]}

for i in "${!INCREMENTALS[@]}"; do
    INC_DIR="${INCREMENTALS[$i]}"
    INC_NUM=$((i + 1))
    
    echo "ğŸ“¦ [$((INC_NUM + 1))/7] Applying incremental #$INC_NUM..."
    
    # Si c'est le DERNIER incrÃ©mental, pas de --apply-log-only
    if [ $INC_NUM -eq $INC_COUNT ]; then
        echo "   (Last incremental, finalizing...)"
        mariabackup --prepare \
          --target-dir="$FULL_BACKUP" \
          --incremental-dir="$INC_DIR"
    else
        mariabackup --prepare \
          --apply-log-only \
          --target-dir="$FULL_BACKUP" \
          --incremental-dir="$INC_DIR"
    fi
    
    if [ $? -ne 0 ]; then
        echo "âŒ Failed to apply incremental #$INC_NUM"
        exit 1
    fi
    
    echo "âœ… Incremental #$INC_NUM applied"
done

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ… Backup chain prepared successfully!"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "Ready to restore with:"
echo "  mariabackup --copy-back --target-dir=$FULL_BACKUP"
```

---

### DÃ©compression avant prÃ©paration (si compressÃ©)

```bash
#!/bin/bash
# Si vos backups sont compressÃ©s (.qp), il faut les dÃ©compresser d'abord

BACKUP_DIRS=(
    "/backups/full_20251213"
    "/backups/inc_20251214"
    "/backups/inc_20251215"
)

for dir in "${BACKUP_DIRS[@]}"; do
    echo "ğŸ—œï¸  Decompressing: $dir"
    
    # DÃ©compresser tous les .qp
    find "$dir" -name "*.qp" -exec qpress -d {} \;
    
    # Supprimer les .qp (optionnel)
    find "$dir" -name "*.qp" -delete
    
    echo "âœ… Decompressed: $dir"
done

echo "âœ… All backups decompressed, ready for --prepare"
```

---

## Restauration d'une chaÃ®ne incrÃ©mentale

### Processus complet

```bash
#!/bin/bash
# restore_from_incremental_chain.sh
# Restauration complÃ¨te depuis full + incrÃ©mentaux

set -euo pipefail

BACKUP_ROOT="/backups/mariadb"
FULL_BACKUP="$BACKUP_ROOT/full_20251213"
DATADIR="/var/lib/mysql"

echo "ğŸ”„ Starting restore from incremental chain"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Ã‰tape 1 : VÃ©rifier que le backup est prÃ©parÃ©
if ! grep -q "backup_type = full-prepared" "$FULL_BACKUP/xtrabackup_checkpoints"; then
    echo "âŒ Backup not prepared! Run prepare script first."
    exit 1
fi

echo "âœ… Backup is prepared"

# Ã‰tape 2 : ArrÃªter MariaDB
echo "â¸ï¸  Stopping MariaDB..."
systemctl stop mariadb

if systemctl is-active --quiet mariadb; then
    echo "âŒ Failed to stop MariaDB"
    exit 1
fi

echo "âœ… MariaDB stopped"

# Ã‰tape 3 : Sauvegarder l'ancien datadir (sÃ©curitÃ©)
BACKUP_OLD_DATADIR="/var/lib/mysql_old_$(date +%s)"
echo "ğŸ’¾ Backing up old datadir to: $BACKUP_OLD_DATADIR"
mv "$DATADIR" "$BACKUP_OLD_DATADIR"

# Ã‰tape 4 : CrÃ©er le nouveau datadir
mkdir -p "$DATADIR"
chown mysql:mysql "$DATADIR"

# Ã‰tape 5 : Copier le backup prÃ©parÃ©
echo "ğŸ“‹ Copying backup to $DATADIR..."
mariabackup --copy-back --target-dir="$FULL_BACKUP"

if [ $? -ne 0 ]; then
    echo "âŒ Copy-back failed!"
    echo "âš ï¸  Restoring old datadir..."
    rm -rf "$DATADIR"
    mv "$BACKUP_OLD_DATADIR" "$DATADIR"
    exit 1
fi

echo "âœ… Backup copied"

# Ã‰tape 6 : Corriger les permissions
echo "ğŸ”’ Fixing permissions..."
chown -R mysql:mysql "$DATADIR"

# Ã‰tape 7 : DÃ©marrer MariaDB
echo "â–¶ï¸  Starting MariaDB..."
systemctl start mariadb

# Attendre que MariaDB soit prÃªt
sleep 5

if ! systemctl is-active --quiet mariadb; then
    echo "âŒ MariaDB failed to start"
    echo "ğŸ“„ Check logs: journalctl -u mariadb -n 50"
    exit 1
fi

echo "âœ… MariaDB started successfully"

# Ã‰tape 8 : VÃ©rification
echo "ğŸ” Verifying database..."
mariadb -e "SELECT VERSION();"

if [ $? -eq 0 ]; then
    echo "âœ… Database is accessible"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âœ… Restore completed successfully!"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "âš ï¸  Old datadir saved at: $BACKUP_OLD_DATADIR"
    echo "   Remove it after validation: rm -rf $BACKUP_OLD_DATADIR"
else
    echo "âŒ Database verification failed"
    exit 1
fi
```

---

## StratÃ©gies de rotation optimales

### StratÃ©gie 1 : Full hebdomadaire + IncrÃ©mentaux quotidiens

```
Dimanche   : Full backup
Lun-Sam    : Incremental backup

Exemple sur 4 semaines :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Semaine 1 : FULL1 â†’ INC1 â†’ INC2 â†’ INC3 â†’ INC4 â†’ INC5 â†’ INC6
Semaine 2 : FULL2 â†’ INC1 â†’ INC2 â†’ INC3 â†’ INC4 â†’ INC5 â†’ INC6
Semaine 3 : FULL3 â†’ INC1 â†’ INC2 â†’ INC3 â†’ INC4 â†’ INC5 â†’ INC6
Semaine 4 : FULL4 â†’ INC1 â†’ INC2 â†’ INC3 â†’ INC4 â†’ INC5 â†’ INC6

RÃ©tention : 4 semaines

Espace requis :
- 4 full backups : 4 Ã— 100 GB = 400 GB
- 24 incrementals : 24 Ã— 5 GB = 120 GB
- Total : 520 GB

RPO : 24 heures max
RTO : 30-60 minutes (restore full + 6 incrÃ©mentaux max)
```

**Avantages** :
- âœ… Bon compromis espace/RPO
- âœ… SimplicitÃ© de gestion
- âœ… RPO raisonnable (24h)

**InconvÃ©nients** :
- âŒ RPO de 24h peut Ãªtre trop long pour certains cas
- âŒ ChaÃ®ne de 7 backups (risque si corruption)

---

### StratÃ©gie 2 : Full hebdomadaire + IncrÃ©mentaux toutes les 6h

```
Dimanche 02:00 : Full backup
Tous les jours : 08:00, 14:00, 20:00, 02:00 â†’ Incremental

Exemple sur 1 semaine :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Dim 02:00 : FULL
Dim 08:00 : INC1
Dim 14:00 : INC2
Dim 20:00 : INC3
Lun 02:00 : INC4
...
Sam 20:00 : INC27

RPO : 6 heures
RTO : 45-90 minutes (restore full + 27 incrÃ©mentaux max)

Espace requis (par semaine) :
- 1 full : 100 GB
- 28 incrementals : 28 Ã— 3 GB = 84 GB
- Total : 184 GB
```

**Avantages** :
- âœ… RPO court (6h)
- âœ… Espace raisonnable

**InconvÃ©nients** :
- âŒ ChaÃ®ne trÃ¨s longue (28 backups)
- âŒ RTO augmentÃ© (beaucoup d'incrÃ©mentaux Ã  appliquer)
- âŒ Risque de corruption amplÃ©

---

### StratÃ©gie 3 : Full quotidien + IncrÃ©mentaux horaires (haute disponibilitÃ©)

```
Tous les jours 02:00 : Full backup
Toutes les heures     : Incremental

Exemple sur 1 journÃ©e :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
02:00 : FULL
03:00 : INC1
04:00 : INC2
...
01:00 : INC23
02:00 : FULL (nouveau cycle)

RPO : 1 heure
RTO : 30-45 minutes

Espace requis (7 jours) :
- 7 full : 7 Ã— 100 GB = 700 GB
- 168 incrementals : 168 Ã— 1.5 GB = 252 GB
- Total : 952 GB
```

**Avantages** :
- âœ… RPO trÃ¨s court (1h)
- âœ… ChaÃ®ne courte (max 23 incrÃ©mentaux)
- âœ… RTO rapide

**InconvÃ©nients** :
- âŒ Consommation espace Ã©levÃ©e
- âŒ Charge serveur (backup toutes les heures)

---

### StratÃ©gie 4 : Hybride (full hebdo + mix incrÃ©mentaux)

```
Dimanche  : Full backup
Lun-Ven   : Incremental toutes les 6h (4/jour)
Sam       : Full backup lÃ©ger (consolidation)

Exemple :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Dim 02:00 : FULL
Lun 08:00, 14:00, 20:00, Lun 02:00 : 4 INC
Mar 08:00, 14:00, 20:00, Mar 02:00 : 4 INC
...
Ven 20:00 : INC20
Sam 02:00 : FULL (nouveau cycle)

RPO : 6 heures
RTO : 45-60 minutes
ChaÃ®ne max : 21 backups
```

ğŸ’¡ **Recommandation production** : StratÃ©gie 1 pour la plupart des cas, StratÃ©gie 3 pour environnements critiques.

---

## Calcul du RPO et optimisation

### Formule de calcul du RPO

```
RPO = FrÃ©quence des backups incrÃ©mentaux

Exemples :
- IncrÃ©mentaux quotidiens â†’ RPO = 24h
- IncrÃ©mentaux toutes les 6h â†’ RPO = 6h
- IncrÃ©mentaux horaires â†’ RPO = 1h
```

âš ï¸ **Attention** : Le RPO rÃ©el inclut aussi les **binary logs** :

```
RPO effectif = MIN(frÃ©quence incrÃ©mentaux, rÃ©tention binlogs)

Si :
- IncrÃ©mentaux quotidiens (RPO backup = 24h)
- Binary logs archivÃ©s toutes les heures (RPO binlog = 1h)

Alors :
- RPO effectif = 1h (grÃ¢ce aux binlogs)
```

ğŸ’¡ **StratÃ©gie optimale** : IncrÃ©mentaux quotidiens + Binary logs archivÃ©s pour PITR = Meilleur compromis.

---

### Calcul du RTO (Recovery Time Objective)

```
RTO = Temps prÃ©paration + Temps restauration

Temps prÃ©paration = f(nombre d'incrÃ©mentaux, taille base, CPU)
Temps restauration = f(taille base, I/O disque)

Exemple (base 500 GB) :
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
PrÃ©paration (full + 6 inc) : 20 min
Restauration (copy-back)    : 10 min
DÃ©marrage MariaDB           : 2 min
VÃ©rifications               : 3 min
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
RTO total                   : 35 min
```

**Optimisations RTO** :
- âœ… Moins d'incrÃ©mentaux dans la chaÃ®ne (full plus frÃ©quent)
- âœ… SSD/NVMe pour stockage backups
- âœ… PrÃ©paration anticipÃ©e (prepare en avance, hors incident)
- âœ… Automatisation du processus de restore

---

## Automatisation complÃ¨te

### Script de rotation full + incrÃ©mentaux

```bash
#!/bin/bash
# /opt/scripts/mariabackup_rotation.sh
# Gestion automatique full hebdomadaire + incrÃ©mentaux quotidiens

set -euo pipefail

#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Configuration
#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

BACKUP_ROOT="/backups/mariadb"
LOG_FILE="$BACKUP_ROOT/logs/rotation_$(date +%Y%m%d).log"
DAY_OF_WEEK=$(date +%u)  # 1=Lundi, 7=Dimanche
RETENTION_WEEKS=4
PARALLEL_THREADS=8

# Slack notification (optionnel)
SLACK_WEBHOOK="https://hooks.slack.com/services/YOUR/WEBHOOK/URL"

#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Fonctions
#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

log() {
    echo "[$(date -Iseconds)] $1" | tee -a "$LOG_FILE"
}

notify_slack() {
    local message=$1
    local color=$2
    curl -X POST -H 'Content-type: application/json' \
      --data "{\"text\":\"$message\",\"color\":\"$color\"}" \
      "$SLACK_WEBHOOK" 2>/dev/null || true
}

check_disk_space() {
    local required_gb=$1
    local available=$(df -BG "$BACKUP_ROOT" | tail -1 | awk '{print $4}' | sed 's/G//')
    
    if [ "$available" -lt "$required_gb" ]; then
        log "âŒ Insufficient disk space: ${available}GB < ${required_gb}GB"
        return 1
    fi
    
    log "âœ… Disk space: ${available}GB available"
    return 0
}

#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Main
#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

mkdir -p "$BACKUP_ROOT/logs"

log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
log "MariaDB Backup Rotation"
log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
log "Day of week: $DAY_OF_WEEK (1=Mon, 7=Sun)"

START_TIME=$(date +%s)

# DÃ©terminer le type de backup
if [ "$DAY_OF_WEEK" -eq 7 ]; then
    BACKUP_TYPE="full"
    BACKUP_DIR="$BACKUP_ROOT/full_$(date +%Y%m%d_%H%M%S)"
    log "ğŸ“¦ Backup type: FULL (Sunday)"
else
    BACKUP_TYPE="incremental"
    BACKUP_DIR="$BACKUP_ROOT/inc_$(date +%Y%m%d_%H%M%S)"
    log "ğŸ“¦ Backup type: INCREMENTAL"
fi

# VÃ©rifier l'espace disque
if [ "$BACKUP_TYPE" = "full" ]; then
    check_disk_space 150 || exit 1
else
    check_disk_space 10 || exit 1
fi

# Effectuer le backup
if [ "$BACKUP_TYPE" = "full" ]; then
    # Full backup
    log "â–¶ï¸  Starting FULL backup..."
    
    mariabackup --backup \
      --target-dir="$BACKUP_DIR" \
      --user=mariabackup \
      --password=SecurePass \
      --compress \
      --compress-threads="$PARALLEL_THREADS" \
      --parallel="$PARALLEL_THREADS" \
      2>&1 | tee -a "$LOG_FILE"
    
    BACKUP_STATUS=${PIPESTATUS[0]}
    
    if [ $BACKUP_STATUS -eq 0 ]; then
        # CrÃ©er lien symbolique 'latest_full'
        rm -f "$BACKUP_ROOT/latest_full"
        ln -s "$BACKUP_DIR" "$BACKUP_ROOT/latest_full"
        log "âœ… Full backup completed"
    fi
    
else
    # Incremental backup
    log "â–¶ï¸  Starting INCREMENTAL backup..."
    
    # Trouver le dernier backup (full ou incremental)
    LAST_BACKUP=$(find "$BACKUP_ROOT" -maxdepth 1 -type d \
      \( -name "full_*" -o -name "inc_*" \) \
      -printf "%T@ %p\n" | sort -n | tail -1 | cut -d' ' -f2)
    
    if [ -z "$LAST_BACKUP" ]; then
        log "âŒ No base backup found! Run full backup first."
        notify_slack "âŒ Incremental backup failed: no base backup" "danger"
        exit 1
    fi
    
    log "ğŸ“‚ Base backup: $LAST_BACKUP"
    
    mariabackup --backup \
      --target-dir="$BACKUP_DIR" \
      --incremental-basedir="$LAST_BACKUP" \
      --user=mariabackup \
      --password=SecurePass \
      --compress \
      --compress-threads="$PARALLEL_THREADS" \
      --parallel="$PARALLEL_THREADS" \
      2>&1 | tee -a "$LOG_FILE"
    
    BACKUP_STATUS=${PIPESTATUS[0]}
    
    if [ $BACKUP_STATUS -eq 0 ]; then
        log "âœ… Incremental backup completed"
    fi
fi

END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

if [ $BACKUP_STATUS -ne 0 ]; then
    log "âŒ Backup FAILED"
    notify_slack "âŒ MariaDB $BACKUP_TYPE backup FAILED on $(hostname)" "danger"
    exit 1
fi

# Statistiques
BACKUP_SIZE=$(du -sh "$BACKUP_DIR" | cut -f1)
log "ğŸ“Š Backup statistics:"
log "  - Duration: ${DURATION}s"
log "  - Size: $BACKUP_SIZE"
log "  - Location: $BACKUP_DIR"

# LSN info
FROM_LSN=$(grep "from_lsn" "$BACKUP_DIR/xtrabackup_checkpoints" | cut -d= -f2 | tr -d ' ')
TO_LSN=$(grep "to_lsn" "$BACKUP_DIR/xtrabackup_checkpoints" | cut -d= -f2 | tr -d ' ')
log "  - LSN: $FROM_LSN â†’ $TO_LSN"

# Nettoyage des anciens backups
if [ "$BACKUP_TYPE" = "full" ]; then
    log "ğŸ§¹ Cleaning old backups (retention: $RETENTION_WEEKS weeks)..."
    
    # Supprimer les full backups > RETENTION_WEEKS
    find "$BACKUP_ROOT" -maxdepth 1 -type d -name "full_*" \
      -mtime +$((RETENTION_WEEKS * 7)) -exec rm -rf {} \;
    
    # Supprimer les incrÃ©mentaux orphelins (dont le full parent n'existe plus)
    # TODO: ImplÃ©menter la dÃ©tection d'orphelins
fi

# Notification
notify_slack "âœ… MariaDB $BACKUP_TYPE backup completed on $(hostname)
- Duration: ${DURATION}s
- Size: $BACKUP_SIZE
- LSN: $FROM_LSN â†’ $TO_LSN" "good"

log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
log "âœ… Backup process completed"
log "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

exit 0
```

---

### Cron configuration

```bash
# /etc/cron.d/mariabackup-rotation

# Full backup tous les dimanches Ã  2h
0 2 * * 0 backup /opt/scripts/mariabackup_rotation.sh >> /var/log/mariabackup_cron.log 2>&1

# IncrÃ©mentaux du lundi au samedi Ã  2h
0 2 * * 1-6 backup /opt/scripts/mariabackup_rotation.sh >> /var/log/mariabackup_cron.log 2>&1
```

---

### Systemd timer (alternative moderne)

```ini
# /etc/systemd/system/mariabackup-rotation.service
[Unit]
Description=MariaDB Backup Rotation (Full/Incremental)
After=mariadb.service

[Service]
Type=oneshot
User=backup
ExecStart=/opt/scripts/mariabackup_rotation.sh
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

```ini
# /etc/systemd/system/mariabackup-rotation.timer
[Unit]
Description=MariaDB Backup Rotation Timer (Daily 2am)

[Timer]
OnCalendar=daily
OnCalendar=02:00
Persistent=true

[Install]
WantedBy=timers.target
```

```bash
sudo systemctl enable mariabackup-rotation.timer
sudo systemctl start mariabackup-rotation.timer
```

---

## Performances et optimisation

### Benchmark : IncrÃ©mental vs Full

**Configuration** : Base 500 GB, activitÃ© normale (10% modifiÃ©/jour)

| Backup | Taille | DurÃ©e | DÃ©bit | Compression |
|--------|--------|-------|-------|-------------|
| Full (initial) | 500 GB | 60 min | 8.3 GB/min | Non |
| Full (compressÃ©) | 60 GB | 45 min | 11.1 GB/min | qpress |
| IncrÃ©mental J+1 | 50 GB | 6 min | 8.3 GB/min | Non |
| IncrÃ©mental J+1 (compressÃ©) | 6 GB | 4 min | 12.5 GB/min | qpress |

ğŸ’¡ **Gain incrÃ©mental** : **90% temps** et **90% espace** vs full quotidien.

---

### Impact du taux de modification

| % modifiÃ©/jour | Taille incrÃ©mental | DurÃ©e | Ratio vs Full |
|----------------|-------------------|-------|---------------|
| 5% | 25 GB | 3 min | 5% |
| 10% | 50 GB | 6 min | 10% |
| 25% | 125 GB | 14 min | 25% |
| 50% | 250 GB | 28 min | 50% |
| 75% | 375 GB | 42 min | 75% |

ğŸ’¡ **Point de bascule** : Si > 50% modifiÃ©/jour, envisager full quotidien au lieu d'incrÃ©mentaux.

---

## IntÃ©gration cloud-native

### Kubernetes : CronJob incrÃ©mental

```yaml
# mariadb-incremental-cronjob.yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: mariadb-incremental-backup
  namespace: databases
spec:
  schedule: "0 2 * * 1-6"  # Lun-Sam Ã  2h
  successfulJobsHistoryLimit: 7
  failedJobsHistoryLimit: 2
  jobTemplate:
    spec:
      template:
        spec:
          restartPolicy: OnFailure
          containers:
          - name: mariabackup-incremental
            image: mariadb:11.8
            command:
            - /bin/bash
            - -c
            - |
              set -e
              
              BACKUP_ROOT="/backups"
              DATE=$(date +%Y%m%d_%H%M%S)
              
              # Trouver le dernier backup (full ou inc)
              LAST_BACKUP=$(find "$BACKUP_ROOT" -maxdepth 1 -type d \
                \( -name "full_*" -o -name "inc_*" \) \
                -printf "%T@ %p\n" | sort -n | tail -1 | cut -d' ' -f2)
              
              if [ -z "$LAST_BACKUP" ]; then
                echo "âŒ No base backup found!"
                exit 1
              fi
              
              echo "ğŸ“‚ Base: $LAST_BACKUP"
              echo "ğŸ“¦ Creating incremental backup..."
              
              mariabackup --backup \
                --target-dir="$BACKUP_ROOT/inc_$DATE" \
                --incremental-basedir="$LAST_BACKUP" \
                --host=mariadb-service \
                --user=mariabackup \
                --password=$MARIABACKUP_PASSWORD \
                --compress \
                --compress-threads=8 \
                --parallel=8
              
              echo "âœ… Incremental backup completed"
              
              # Nettoyage (rÃ©tention 30 jours)
              find "$BACKUP_ROOT" -maxdepth 1 -type d -mtime +30 -exec rm -rf {} \;
            env:
            - name: MARIABACKUP_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mariadb-backup-secret
                  key: password
            volumeMounts:
            - name: backup-storage
              mountPath: /backups
          volumes:
          - name: backup-storage
            persistentVolumeClaim:
              claimName: mariadb-backup-pvc
```

---

### AWS : Rotation full S3 + incrÃ©mentaux locaux

```bash
#!/bin/bash
# StratÃ©gie hybride : Full vers S3, incrÃ©mentaux locaux

BACKUP_LOCAL="/backups/mariadb"
S3_BUCKET="s3://my-backups/mariadb"
DAY=$(date +%u)

if [ "$DAY" -eq 7 ]; then
    # Dimanche : Full backup vers S3
    echo "ğŸ“¦ Sunday: Full backup to S3"
    
    mariabackup --backup \
      --stream=xbstream \
      --compress | \
      aws s3 cp - "$S3_BUCKET/full_$(date +%Y%m%d).xbstream"
    
    # TÃ©lÃ©charger aussi localement pour base des incrÃ©mentaux
    mariabackup --backup \
      --target-dir="$BACKUP_LOCAL/full_$(date +%Y%m%d)" \
      --compress
    
else
    # Lun-Sam : Incremental local
    echo "ğŸ“¦ Incremental backup (local)"
    
    LAST_BACKUP=$(find "$BACKUP_LOCAL" -maxdepth 1 -type d \
      \( -name "full_*" -o -name "inc_*" \) | sort | tail -1)
    
    mariabackup --backup \
      --target-dir="$BACKUP_LOCAL/inc_$(date +%Y%m%d)" \
      --incremental-basedir="$LAST_BACKUP" \
      --compress
fi
```

ğŸ’¡ **Avantage** : Full sÃ©curisÃ© dans S3 (offsite), incrÃ©mentaux rapides en local.

---

## PiÃ¨ges et limitations

### PiÃ¨ge 1 : Oublier `--apply-log-only`

```bash
# âŒ ERREUR FATALE : PrÃ©parer sans --apply-log-only
mariabackup --prepare --target-dir=/backups/full
# Puis
mariabackup --prepare --target-dir=/backups/full --incremental-dir=/backups/inc1
# RÃ‰SULTAT : Les transactions de inc1 ne s'appliquent pas correctement

# âœ… CORRECT
mariabackup --prepare --apply-log-only --target-dir=/backups/full
mariabackup --prepare --apply-log-only --target-dir=/backups/full --incremental-dir=/backups/inc1
# Dernier incrÃ©mental SANS --apply-log-only
mariabackup --prepare --target-dir=/backups/full --incremental-dir=/backups/inc6
```

---

### PiÃ¨ge 2 : ChaÃ®ne brisÃ©e (backup manquant)

```bash
# ChaÃ®ne :
# FULL â†’ INC1 â†’ INC2 â†’ [INC3 manquant!] â†’ INC4

# Si INC3 est corrompu/supprimÃ©, impossible de restaurer INC4
# Solution : DÃ©tecter et alerter sur chaÃ®nes brisÃ©es
```

**Script de validation de chaÃ®ne** :

```bash
#!/bin/bash
# validate_chain.sh

BACKUP_ROOT="/backups/mariadb"

BACKUPS=($(find "$BACKUP_ROOT" -maxdepth 1 -type d \
  \( -name "full_*" -o -name "inc_*" \) | sort))

LAST_LSN=0

for backup in "${BACKUPS[@]}"; do
    FROM_LSN=$(grep "from_lsn" "$backup/xtrabackup_checkpoints" | cut -d= -f2 | tr -d ' ')
    TO_LSN=$(grep "to_lsn" "$backup/xtrabackup_checkpoints" | cut -d= -f2 | tr -d ' ')
    
    if [ "$FROM_LSN" -ne "$LAST_LSN" ] && [ "$LAST_LSN" -ne 0 ]; then
        echo "âŒ BROKEN CHAIN at $backup"
        echo "   Expected from_lsn: $LAST_LSN"
        echo "   Actual from_lsn: $FROM_LSN"
        exit 1
    fi
    
    LAST_LSN=$TO_LSN
    echo "âœ… $backup (LSN: $FROM_LSN â†’ $TO_LSN)"
done

echo "âœ… Backup chain is valid"
```

---

### PiÃ¨ge 3 : Base backup incorrect

```bash
# âŒ Utiliser un full non prÃ©parÃ© comme base pour incrÃ©mental
# mariabackup --backup \
#   --incremental-basedir=/backups/full_NON_PREPARE

# Le full doit Ãªtre SOIT :
# - Un backup fraÃ®chement crÃ©Ã© (non prÃ©parÃ©)
# - Un backup prÃ©parÃ© avec --apply-log-only

# âœ… Toujours utiliser le backup brut ou prÃ©parÃ© avec --apply-log-only
```

---

### PiÃ¨ge 4 : Rotation mal configurÃ©e

```bash
# âŒ Supprimer le full alors que des incrÃ©mentaux dÃ©pendent de lui
rm -rf /backups/full_20251213
# Les inc_20251214, inc_20251215... deviennent inutilisables!

# âœ… Supprimer full + tous ses incrÃ©mentaux ensemble
```

---

### PiÃ¨ge 5 : Compression diffÃ©rente entre full et incrÃ©mentaux

```bash
# âŒ Full non compressÃ©, incrÃ©mentaux compressÃ©s
mariabackup --backup --target-dir=/backups/full
mariabackup --backup --target-dir=/backups/inc1 \
  --incremental-basedir=/backups/full --compress
# PROBLÃˆME lors du --prepare

# âœ… CohÃ©rence compression
# SOIT tout compressÃ©, SOIT rien
```

---

## âœ… Points clÃ©s Ã  retenir

- **Backups incrÃ©mentaux** copient uniquement les **pages InnoDB modifiÃ©es** depuis dernier backup (identifiÃ©es par LSN)
- **Gain typique** : 90% espace et temps vs full quotidien (si 10% modifiÃ©/jour)
- **LSN critique** : `to_lsn` du backup N = `from_lsn` du backup N+1 (chaÃ®nage obligatoire)
- **PrÃ©paration sÃ©quentielle** : `--apply-log-only` sur tous sauf le dernier incrÃ©mental
- **StratÃ©gie recommandÃ©e** : Full hebdomadaire + incrÃ©mentaux quotidiens (RPO 24h, RTO 30-60 min)
- **Validation chaÃ®ne** : VÃ©rifier continuitÃ© LSN avant incident (script automatisÃ©)
- **Point de bascule** : Si > 50% modifiÃ©/jour, full quotidien devient plus efficace
- **PiÃ¨ges majeurs** : Oublier `--apply-log-only`, chaÃ®ne brisÃ©e, rotation mal configurÃ©e
- **Cloud** : Full vers S3 (offsite) + incrÃ©mentaux locaux (vitesse) = optimal
- **Automatisation** : Script rotation intelligent dÃ©tectant dimanche (full) vs autres jours (incrÃ©mental)

---

## ğŸ”— Ressources et rÃ©fÃ©rences

- ğŸ“– [Mariabackup Incremental Documentation](https://mariadb.com/kb/en/incremental-backup-and-restore-with-mariabackup/)
- ğŸ“– [InnoDB LSN Explained](https://mariadb.com/kb/en/innodb-redo-log/)
- ğŸ“– [Backup Strategies](https://mariadb.com/kb/en/backup-and-restore-overview/)
- ğŸ“Š [Benchmark: Incremental vs Full](https://mariadb.com/resources/blog/mariadb-backup-strategies/)
- ğŸ› ï¸ [Mariabackup Options Reference](https://mariadb.com/kb/en/mariabackup-options/)

---

## â¡ï¸ Section suivante

**12.3.3 Support BACKUP STAGE** : NouveautÃ© MariaDB 11.8 pour coordination optimale des backups physiques avec rÃ©duction de l'impact sur la production et meilleure cohÃ©rence multi-moteurs.

â­ï¸ [Support BACKUP STAGE](/12-sauvegarde-restauration/03.3-backup-stage.md)
